<div id="ML_Utils">
<div class="head">
<h1>Theory ML_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ML_Utils
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../Dict_Construction/Dict_Construction.html">Dict_Construction.Dict_Construction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"utils.ML"</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">econtr_tac</span> <span class="entity">neg_thms</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">neg_thms</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> notE<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="entity">neg_thms</span>
  <span class="keyword2"><span class="keyword">in</span></span> SOLVED' <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="entity">neg_thms</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* from HOL.thy *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> <span class="entity">Code_Runtime.dynamic_holds_conv</span> <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    CONVERSION <span class="main">(</span>Conv.params_conv <span class="inner_numeral">~1</span> <span class="main">(</span>K <span class="main">(</span>Conv.concl_conv <span class="inner_numeral">~1</span> <span class="entity">conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
    resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">TrueI</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_all_conjunction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">PROP</span> <span class="bound">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="bound">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="bound">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="bound">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> Pure.conjunctionD1<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> Pure.conjunctionD2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="skolem">x</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> Pure.conjunctionD1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Pure.conjunctionD2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">Q</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> Pure.conjunctionD1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Pure.conjunctionD2<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">note</span></span> Pure.conjunctionD1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Pure.conjunctionD2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="skolem">P</span> <span class="main">&amp;&amp;&amp;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="skolem">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">norm_all_conjunction_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  CONVERSION <span class="main">(</span><span class="entity">repeat1_conv</span> <span class="main">(</span><span class="entity">Dict_Construction_Util.changed_conv</span> <span class="main">(</span>Conv.top_sweep_conv
    <span class="main">(</span>K <span class="main">(</span>Conv.rewrs_conv <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> norm_all_conjunction<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/utils.ML">
<div class="head">
<h1>File ‹utils.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">repeat1_conv</span> <span class="entity">cv</span> <span class="main">=</span> <span class="entity">cv</span> then_conv Conv.repeat_conv <span class="entity">cv</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> error <span class="inner_quoted">"empty list"</span>
  <span class="main">|</span> <span class="entity">init</span> <span class="main">[</span><span class="main">_</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">init</span> <span class="main">(</span><span class="entity">x</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">x</span> :: <span class="entity">init</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">last</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> error <span class="inner_quoted">"empty list"</span>
  <span class="main">|</span> <span class="entity">last</span> <span class="main">[</span><span class="entity">x</span><span class="main">]</span> <span class="main">=</span> <span class="entity">x</span>
  <span class="main">|</span> <span class="entity">last</span> <span class="main">(</span><span class="main">_</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">last</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unvarify_typ</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="main">(</span>TVar <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">idx</span><span class="main">)</span><span class="main">,</span> <span class="entity">sort</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> TFree <span class="main">(</span><span class="entity">name</span> ^ Value.print_int <span class="entity">idx</span><span class="main">,</span> <span class="entity">sort</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
  <span class="keyword2"><span class="keyword">in</span></span> map_atyps <span class="entity">aux</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">all_consts</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span><span class="main">]</span>
  <span class="main">|</span> <span class="entity">all_consts</span> <span class="main">(</span><span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> union <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">all_consts</span> <span class="entity">t</span><span class="main">)</span> <span class="main">(</span><span class="entity">all_consts</span> <span class="entity">u</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">all_consts</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">all_consts</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">all_consts</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">induct_of_bnf_const</span> <span class="entity">ctxt</span> <span class="entity">const</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> dest_Const <span class="entity">const</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cmp</span> <span class="main">{</span><span class="entity">T</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">name'</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="entity">name'</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">T</span> <span class="keyword2"><span class="keyword">else</span></span> NONE
      <span class="main">|</span> <span class="entity">cmp</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> NONE

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_disc_or_sel</span> <span class="main">(</span><span class="entity">sugar</span> <span class="keyword1"><span class="keyword">as</span></span> <span class="main">{</span><span class="entity">discs</span><span class="main">,</span> <span class="entity">selss</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      maps <span class="main">(</span>map <span class="main">(</span><span class="entity">cmp</span> <span class="entity">sugar</span><span class="main">)</span><span class="main">)</span> <span class="entity">selss</span> @ map <span class="main">(</span><span class="entity">cmp</span> <span class="entity">sugar</span><span class="main">)</span> <span class="entity">discs</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Ts</span> <span class="main">=</span>
      <span class="entity">Ctr_Sugar.ctr_sugars_of</span> <span class="entity">ctxt</span>
      |&gt; maps <span class="entity">is_disc_or_sel</span>
      |&gt; <span class="entity">cat_options</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">Ts</span> <span class="keyword2"><span class="keyword">of</span></span>
      <span class="main">(</span>Type <span class="main">(</span><span class="entity">typ_name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> :: <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
        <span class="entity">BNF_FP_Def_Sugar.fp_sugar_of</span> <span class="entity">ctxt</span> <span class="entity">typ_name</span>
        |&gt; Option.mapPartial <span class="main">#</span>fp_co_induct_sugar
        |&gt; Option.map <span class="main">#</span>co_inducts
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE
  <span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Compiler_Utils">
<div class="head">
<h1>Theory Compiler_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Compiler_Utils
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

<span class="keyword1"><span class="command">notation</span></span> undefined <span class="main">(</span><span class="quoted">"<span class="keyword1">❖</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_sorted_list_of_fset<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>sorted_list_of_fset <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> distinct_sorted_list_of_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_nat_le_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> sum <span class="free">f</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.insert_remove<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_nat_less_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> sum <span class="free">f</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> finite <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.insert_remove<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_BallI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> Ball <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_map_snd_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">cs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">cs</span> <span class="main">=</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">cs</span> <span class="main">=</span> id <span class="main">|`|</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">cs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> id <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> disj_cases <span class="main">=</span> disjE<span class="main">[</span><span class="operator">case_names</span> 1 2<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> case_prod_twice<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">(</span>case_prod <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">,</span> <span class="free">h</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> case_prod <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_map_keyed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> map_option <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">xs</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> rekey <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_rekey<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">,</span> <span class="free">g</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> map_option <span class="main">(</span><span class="free">g</span> <span class="main">(</span>inv <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">xs</span> <span class="main">(</span>inv <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bij
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_def surj_f_inv_f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_rekey'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> map_option <span class="free">g</span> <span class="main">(</span>map_of <span class="free">xs</span> <span class="main">(</span>inv <span class="free">f</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> map_prod_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_of_rekey<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">unfolding</span></span> bij_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv injD rev_image_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"rekey <span class="main">(</span>inv <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
<span class="keyword1"><span class="command">using</span></span> bij
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_imp_bij_inv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite sets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fset_eq_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∉|</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fbind_subset_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">|⊆|</span> <span class="free">T</span><span class="main">)</span> <span class="main">⟹</span> fbind <span class="free">S</span> <span class="free">f</span> <span class="main">|⊆|</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_fBallI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> prod_BallI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ffUnion_subset_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">|⊆|</span> ffUnion <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fbindE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> fbind <span class="free">S</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">f</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">|∈|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ffUnion_least_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"ffUnion <span class="free">A</span> <span class="main">|⊆|</span> <span class="free">C</span> <span class="main">⟹</span> fBall <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">|⊆|</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> inj_on_fimage_set_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>fset <span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|⊆|</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">|⊆|</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|`|</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">|`|</span> <span class="free">A</span> <span class="main">-</span> <span class="free">f</span> <span class="main">|`|</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">meson</span> Diff_subset inj_on_image_set_diff order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all_iff_fset<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">xs</span> <span class="main">⟷</span> fBall <span class="main">(</span>fset_of_list <span class="free">xs</span><span class="main">)</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fbind_fun_funion<span class="main">:</span> <span class="quoted"><span class="quoted">"fbind <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">|∪|</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> fbind <span class="free">M</span> <span class="free">f</span> <span class="main">|∪|</span> fbind <span class="free">M</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funion_strictE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">|∪|</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> <span class="free">A</span>"</span></span> <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∉|</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_decr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Max <span class="free">X</span> <span class="main">-</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mono_Max_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monoI<span class="main">)</span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_ex_gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟹</span> finite <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> Max <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_gr_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmax_decr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fBex <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fMax <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> fMax <span class="free">X</span> <span class="main">-</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> max_decr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmax_ex_gr<span class="main">:</span> <span class="quoted"><span class="quoted">"fBex <span class="free">X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> fMax <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> max_ex_gr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMax_le<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span> fMax <span class="free">M</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sets›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code setup trickery›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compress</span> <span class="main">=</span> id"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compress <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>remdups <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compress_def id_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_elem'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">the_elem'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> the_elem <span class="main">(</span>set <span class="main">(</span>sorted_list_of_set <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> the_elem_id<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> the_elem' <span class="free">S</span> <span class="main">=</span> the_elem <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> the_elem'_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fcompress <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span> fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">compress</span>
<span class="keyword1"><span class="command">unfolding</span></span> compress_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompress_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fcompress <span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compress_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> fthe_elem' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder fset <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">the_elem'</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fthe_elem'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fthe_elem' <span class="main">=</span> fthe_elem"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fthe_elem' <span class="skolem">S</span> <span class="main">=</span> fthe_elem <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_elem_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> set<span class="antiquote"><span class="antiquote">}</span></span></span></span>s as maps›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_map</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> Ball <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">.</span> Ball <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">a<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">a<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_mapI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_is_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_map <span class="main">(</span>set <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some_eq_map_of_iff is_mapI option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_map_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_mapD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_map_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">⊆</span> <span class="free">N</span> <span class="main">⟹</span> is_map <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_is_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">m</span> <span class="main">⟹</span> is_map <span class="main">(</span>set <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> map_of <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_mapD map_of_SomeD weak_map_of_SomeI<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">get_map</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> the_elem <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">k'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> get_map_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"get_map <span class="free">M</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> get_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> get_map_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"get_map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> get_map <span class="free">S</span> <span class="free">k</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"get_map <span class="free">S</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> get_map_elem<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">f</span> <span class="free">k</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"get_map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">f</span> <span class="free">k</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> get_map_elem is_map_image<span class="main">)</span> <span class="comment1">(* takes long *)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹get_map <span class="free">S</span> <span class="free">k</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹get_map <span class="main">(</span><span class="main">_</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_map_fst_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span> <span class="main">⟹</span> inj_on fst <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_mapD<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_map_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fun <span class="main">(</span>rel_set <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(=)</span> is_map is_map"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_map_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lift_definition</span></span> is_fmap <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">is_map</span> <span class="keyword2"><span class="keyword">parametric</span></span> is_map_transfer <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_fmapI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_fmap_image<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">M</span> <span class="main">⟹</span> is_fmap <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> is_map_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_fmapD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">b<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> is_mapD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_fmap_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">N</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">|⊆|</span> <span class="free">N</span> <span class="main">⟹</span> is_fmap <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> is_map_subset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion into sorted lists›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ordered_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ordered_map</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> map <span class="main">(</span>get_map <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_set_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> get_map <span class="free">S</span> <span class="main">`</span> set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> get_map <span class="free">S</span> <span class="main">`</span> <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_list_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>get_map <span class="free">S</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> id <span class="main">`</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_map_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> ordered_map <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def list.map_comp image_comp
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fst_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> comp_def case_prod_twice get_map_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>fst <span class="main">∘</span> get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_list_of_set assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y x' y'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y'</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> get_map_elem<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> get_map_elem<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_sorted_list_of_set <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_keys<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>get_map <span class="free">S</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_map_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_list_of_set<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> map_idI map_map o_apply<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ordered_map_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ordered_map_set_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"ordered_map <span class="free">S</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_remove<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ordered_map <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">x</span> <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_list_of_set<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_map_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_list_of_set<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordered_map <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>get_map <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>get_map <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span>fst <span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> inj_on_image_set_diff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on fst <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_map_fst_inj<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>get_map <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>remove1 <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sorted_list_of_set_remove<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>remove1 <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.map_cong0<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="main">(</span>remove1 <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> distinct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> fst <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"get_map <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> get_map <span class="free">S</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> get_map_def Set.filter_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodE fst_conv member_remove remove_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>removeAll <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_remove1_removeAll<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> removeAll <span class="main">(</span>get_map <span class="free">S</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> map_removeAll_inj_on<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_list_of_set<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> inj <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> removeAll <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_map_elem<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> remove1 <span class="free">x</span> <span class="main">(</span>map <span class="main">(</span>get_map <span class="free">S</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct inj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_remove1_removeAll distinct_map<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_list_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"is_map <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="main">(</span>ordered_map <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Ball <span class="free">S</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ordered_map_set_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_map_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordered_map <span class="main">{</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def get_map_def Set.filter_def the_elem_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ordered_fmap <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">ordered_map</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span> <span class="main">⟹</span> fset_of_list <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_set_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span> <span class="main">=</span> ordered_fmap <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_keys<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_fset <span class="main">(</span>fst <span class="main">|`|</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_keys<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"ordered_fmap <span class="free">S</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_remove<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ordered_fmap <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{|</span> <span class="free">x</span> <span class="main">|}</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">x</span> <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ordered_map_remove<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_list_all<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="main">(</span>ordered_fmap <span class="free">S</span><span class="main">)</span> <span class="main">=</span> fBall <span class="free">S</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ordered_map_set_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ordered_fmap_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ordered_fmap <span class="main">{|</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">|}</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Grouping into sets›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">group_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> set<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">group_by</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="main">{</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a'</span><span class="main">)</span><span class="main">|</span> <span class="bound">a'</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a'</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> group_by_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> group_by <span class="free">f</span> <span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> group_by_nonempty_inner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> group_by_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">as</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> group_byD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> group_byE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> group_by_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> group_byE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> group_byE group_by_nonempty_inner prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> group_by_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> group_by_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">group_by'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> set<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">group_by'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fa</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">fa</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">`</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">fa</span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> group_by'_eq<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"group_by <span class="main">=</span> group_by'"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def group_by'_def Set.filter_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_map_group_by<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_map <span class="main">(</span>group_by <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> group_by_keys<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> group_by <span class="free">f</span> <span class="free">M</span> <span class="main">=</span> fst <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fgroup_by <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> fset<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">group_by</span>
<span class="keyword1"><span class="command">unfolding</span></span> inf_apply inf_bool_def group_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span> fgroup_by <span class="free">f</span> <span class="free">M</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> group_by_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by_nonempty_inner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> group_by_nonempty_inner<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> <span class="free">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">as</span> <span class="main">⟹</span> fBex <span class="free">as</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> group_by_sound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_byD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">|∈|</span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">|∈|</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">metis</span> group_byD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_byE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">|∈|</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|∈|</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_byE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|∈|</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> group_byE2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">|∈|</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">,</span> <span class="free">cs</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">as</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">thesis</span>

  <span class="keyword3"><span class="command">assume</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">as</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">as</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="skolem">f</span> <span class="skolem">as</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> group_by_complete<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> group_by_def <span class="keyword1"><span class="command">using</span></span> as <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">assume</span></span> thesis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> finite <span class="bound">cs</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">∈</span> group_by <span class="skolem">f</span> <span class="skolem">as</span> <span class="main">⟹</span> snd <span class="main">(</span><span class="skolem">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">cs</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> thesis<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">|∈|</span> fgroup_by <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> group_by_single<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fgroup_by'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span> fset<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fgroup_by'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> fcompress <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">fa</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">fa</span><span class="main">,</span> <span class="main">(</span>snd <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">|`|</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">fa</span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a'</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by'_eq<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fgroup_by <span class="main">=</span> fgroup_by'"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fgroup_by'_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> fcompress_eq
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">metis</span> group_by'_def group_by'_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_fmap_group_by<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>fgroup_by <span class="free">f</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> is_map_group_by<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fgroup_by_keys<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fgroup_by <span class="free">f</span> <span class="free">M</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">f</span> <span class="main">|`|</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> group_by_keys<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Singletons›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_set_holds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> the_elem <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the_elem <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">n</span><span class="main">.</span> <span class="main">{</span><span class="free">f</span> <span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> the_elem_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_set_is<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">M</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_fset_holds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">m</span> <span class="main">=</span> fthe_elem <span class="main">(</span><span class="free">f</span> <span class="main">|`|</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> singleton_set_holds<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_fset_is<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{|</span> <span class="free">y</span> <span class="main">|}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> singleton_set_is<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pairwise relations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pairwise</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pairwise</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">m</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pairwiseI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">m</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pairwiseD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pairwise_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">N</span> <span class="main">⊆</span> <span class="free">M</span> <span class="main">⟹</span> pairwise <span class="free">P</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pairwise_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> pairwise_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> pairwise <span class="free">Q</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pairwise_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pairwise <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> pairwise <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fpairwise <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">pairwise</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fpairwise_alt_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fpairwise <span class="free">P</span> <span class="free">M</span> <span class="main">⟷</span> fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> fBall <span class="free">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fpairwiseI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">m</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fpairwise <span class="free">P</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fpairwise_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fpairwiseD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fpairwise <span class="free">P</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fpairwise_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fpairwise_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fpairwise <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">|`|</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> fpairwise <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fpairwise_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fpairwise <span class="free">P</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">N</span> <span class="main">|⊆|</span> <span class="free">M</span> <span class="main">⟹</span> fpairwise <span class="free">P</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fpairwise_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fpairwise_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"fpairwise <span class="free">P</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> fpairwise <span class="free">Q</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fpairwise_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relators›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_set_eq_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_set <span class="main">(=)</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_set_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">P</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_setI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_setD1 rel_setD2<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> rel_set_image_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">P</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">g</span> <span class="main">`</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="main">(=)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_set_image<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_set_eq_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_set_refl_strong<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">P</span> <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rel_setI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_fsetE1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">P</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">|∈|</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_setD1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_fsetE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">P</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">|∈|</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_setD2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_fsetI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">⟹</span> fBex <span class="free">B</span> <span class="main">(</span><span class="free">R</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">|∈|</span> <span class="free">B</span> <span class="main">⟹</span> fBex <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">R</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> rel_setI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_fset_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">P</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">|∈|</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="main">|`|</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">|`|</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> rel_set_image<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> rel_fset_image_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">P</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">|∈|</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">|`|</span> <span class="free">A</span> <span class="main">=</span> <span class="free">g</span> <span class="main">|`|</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> rel_set_image_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_fset_refl_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="free">P</span> <span class="free">S</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> rel_set_refl_strong<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Selecting values from keys›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">select</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">select</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">z</span><span class="main">|</span><span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">z</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> select_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>select <span class="free">f</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">`</span> <span class="main">(</span>select <span class="free">f</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> select_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Some <span class="main">`</span> select <span class="free">f</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> inj_on Some <span class="bound">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> select_memberI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> select <span class="free">f</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> select_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> select_memberE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> select <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> select_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fselect <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'b</span> fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">select</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> select_finite<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fselect_memberI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">|∈|</span> fselect <span class="free">f</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> select_memberI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fselect_memberE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">|∈|</span> fselect <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">rule</span> select_memberE<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_list_singletonE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> empty_iff insertI1 insert_ident list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> neq_Nil_conv set_empty2 singletonD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_of_list_singletonE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fset_of_list <span class="free">xs</span> <span class="main">=</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fset.lifting
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> set_of_list_singletonE<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite maps›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fmlookup_default</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fmlookup_default</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmpred_foldl<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="free">P</span> <span class="free">init</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> fmpred <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="free">P</span> <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="free">init</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">init</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="free">P</span> <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="main">(</span><span class="skolem">init</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="free">P</span> <span class="main">(</span><span class="skolem">init</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="free">P</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmdom_foldl_add<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="free">m</span> <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> fmdom <span class="free">m</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>fmdom <span class="main">|`|</span> fset_of_list <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmimage_fmmap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmimage <span class="main">(</span>fmmap <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> <span class="free">f</span> <span class="main">|`|</span> fmimage <span class="free">m</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fmap.lifting fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmmap_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> fmlookup <span class="free">m</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v'</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> fmmap <span class="free">f</span> <span class="free">m'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"fmmap <span class="main"><span class="main">(</span></span>inv <span class="free"><span class="free">f</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">m</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> fmap.map_comp
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmap.map_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap.map_cong<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmran'_def f_inv_into_f <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_map_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_map <span class="main">(</span>map_upd <span class="free">k</span> <span class="free">v</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> set_of_map <span class="main">(</span>map_drop <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> set_of_map_def map_upd_def map_drop_def map_filter_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_drop_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"map_drop <span class="free">k</span> <span class="main">(</span>map_of <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> map_of <span class="main">(</span>AList.delete <span class="free">k</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> AList.delete_eq map_drop_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_filter_map_of<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"map_of"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> filter_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_map_map_of<span class="main">:</span> <span class="quoted"><span class="quoted">"set_of_map <span class="main">(</span>map_of <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>AList.clearjunk <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> clearjunk.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>

  <span class="comment1">(* honourable mention: int-e on IRC, but it's way to short to understand what's going on *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> delete_conv<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_of_map_def<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of_map <span class="main">(</span>map_of <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set_of_map <span class="main">(</span>map_upd <span class="skolem">k</span> <span class="skolem">v</span> <span class="main">(</span>map_of <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">_</span>›</span></span> map_upd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of_map <span class="main">(</span>map_drop <span class="skolem">k</span> <span class="main">(</span>map_of <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_of_map_upd<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_of_map <span class="main">(</span>map_of <span class="main">(</span>AList.delete <span class="skolem">k</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> map_drop_delete<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  set <span class="main">(</span>AList.clearjunk <span class="main">(</span>AList.delete <span class="skolem">k</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>AList.clearjunk <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_of_fmap_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset_of_fmap <span class="main">(</span>fmap_of_list <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>AList.clearjunk <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fmap.lifting fset.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> set_of_map_map_of<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_sorted_list_of_fmap<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>sorted_list_of_fmap <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sorted_list_of_fmap_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> distinct_map<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_convol_ident<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> nil snoc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_allI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_map_snd_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="main">=</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="main">=</span> map id <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> id <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_leftE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_rightE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_all3</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">list_all3</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">∧</span> <span class="free">list_all3</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">list_all3</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">list_all3</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_empty<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_cons<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> list_all3 <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil Cons<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> list_all3<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span>
    <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">⟹</span> list_all3 <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> P
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="skolem">P</span><span class="main"><span class="main">≡</span></span><span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> cons<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_from_list_all2s<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">Q</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs0</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs0</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zs0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> those_someD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"those <span class="free">xs</span> <span class="main">=</span> Some <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map Some <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Code_Utils">
<div class="head">
<h1>Theory Code_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Code_Utils
<span class="keyword2"><span class="keyword">imports</span></span> <a href="ML_Utils.html">ML_Utils</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">setup_conditional_functrans</span> <span class="entity">binding</span> <span class="entity">functrans</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">enabled</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="entity">binding</span> <span class="main">(</span>K false<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_functrans</span> <span class="main">=</span> <span class="entity">Code_Preproc.simple_functrans</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">enabled</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">functrans</span> <span class="entity">ctxt</span>
        <span class="keyword2"><span class="keyword">else</span></span>
          K NONE<span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Theory.setup <span class="main">(</span><span class="entity">Code_Preproc.add_functrans</span> <span class="main">(</span>Binding.name_of <span class="entity">binding</span><span class="main">,</span> <span class="entity">code_functrans</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">enabled</span>
    <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"pattern_compatibility.ML"</span>
<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"dynamic_unfold.ML"</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> dynamic_unfold <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="free">x</span>"</span></span><span class="main">)</span> <span class="main">=</span> <span class="quoted">‹<span class="entity">Dynamic_Unfold.simproc</span>›</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dynamic_unfold<span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Code_Preproc.map_pre</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">ctxt</span> addsimprocs <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">simproc</span> dynamic_unfold<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/pattern_compatibility.ML">
<div class="head">
<h1>File ‹pattern_compatibility.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">PATTERN_COMPATIBILITY</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> enabled<span class="main">:</span> bool Config.T
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Pattern_Compatibility</span> <span class="main">:</span> <span class="entity">PATTERN_COMPATIBILITY</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">non_overlapping</span> <span class="main">(</span>Const <span class="entity">x</span><span class="main">)</span> <span class="main">(</span>Const <span class="entity">y</span><span class="main">)</span> <span class="main">=</span> not <span class="main">(</span><span class="entity">x</span> <span class="main">=</span> <span class="entity">y</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">non_overlapping</span> <span class="main">(</span>Const <span class="main">_</span><span class="main">)</span> <span class="main">(</span><span class="main">_</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">non_overlapping</span> <span class="main">(</span><span class="main">_</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">(</span>Const <span class="main">_</span><span class="main">)</span> <span class="main">=</span> true
  <span class="main">|</span> <span class="entity">non_overlapping</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">(</span><span class="entity">u1</span> $ <span class="entity">u2</span><span class="main">)</span> <span class="main">=</span> <span class="entity">non_overlapping</span> <span class="entity">t1</span> <span class="entity">u1</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">non_overlapping</span> <span class="entity">t2</span> <span class="entity">u2</span>
  <span class="main">|</span> <span class="entity">non_overlapping</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract</span> <span class="entity">thm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lhs</span> <span class="main">=</span> fst <span class="main">(</span>Logic.dest_equals <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> fst <span class="main">(</span>dest_Const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="entity">lhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">functrans</span> <span class="entity">ctxt</span> <span class="entity">thms</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">groups</span> <span class="main">=</span> AList.group <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span> <span class="main">(</span>map <span class="entity">extract</span> <span class="entity">thms</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">process_group</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">eqs</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">const</span> <span class="main">=</span> Pretty.string_of <span class="main">(</span><span class="entity">pretty_const</span> <span class="entity">ctxt</span> <span class="entity">name</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pattern_renames</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="entity">t2</span><span class="main">)</span> <span class="main">(</span><span class="entity">u1</span> $ <span class="entity">u2</span><span class="main">)</span> <span class="main">=</span>
              <span class="entity">pattern_renames</span> <span class="entity">t1</span> <span class="entity">u1</span> @ <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">t1</span> <span class="main">=</span> <span class="entity">u1</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">pattern_renames</span> <span class="entity">t2</span> <span class="entity">u2</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">pattern_renames</span> <span class="entity">t</span> <span class="entity">u</span> <span class="main">=</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">u</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">non_overlapping</span> <span class="entity">t</span> <span class="entity">u</span> <span class="keyword2"><span class="keyword">then</span></span>
                <span class="main">[</span><span class="main">]</span>
              <span class="keyword2"><span class="keyword">else</span></span>
                <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
                  Var <span class="main">(</span><span class="entity">iname</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="entity">iname</span><span class="main">,</span> <span class="entity">u</span><span class="main">)</span><span class="main">]</span>
                <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Unsupported pattern situation in "</span> ^ <span class="entity">const</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_bogus_eq</span> <span class="entity">term</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">term</span> <span class="keyword2"><span class="keyword">of</span></span>
            <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> equal_class.equal<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="entity">t</span> <span class="main">=</span> <span class="entity">u</span> <span class="keyword1"><span class="keyword">andalso</span></span> is_Var <span class="entity">t</span>
          <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert</span> <span class="main">(</span><span class="entity">lhs1</span><span class="main">,</span> <span class="entity">thm1</span><span class="main">)</span> <span class="main">(</span><span class="entity">changed</span><span class="main">,</span> <span class="main">(</span><span class="entity">lhss</span><span class="main">,</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_bogus_eq</span> <span class="entity">lhs1</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="main">(</span>true<span class="main">,</span> <span class="main">(</span><span class="entity">lhss</span><span class="main">,</span> <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="keyword2"><span class="keyword">let</span></span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">renamess</span> <span class="main">=</span>
                map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">lhs2</span> <span class="main">=&gt;</span>
                  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">pattern_renames</span> <span class="entity">lhs1</span> <span class="entity">lhs2</span> <span class="keyword2"><span class="keyword">of</span></span>
                    <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> NONE
                  <span class="main">|</span> <span class="entity">xs</span> <span class="main">=&gt;</span> SOME <span class="entity">xs</span><span class="main">)</span> <span class="entity">lhss</span>
                |&gt; <span class="entity">cat_options</span>

              <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rename</span> <span class="entity">renames</span> <span class="main">=</span>
                <span class="keyword2"><span class="keyword">let</span></span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inst</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">u</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">u</span><span class="main">)</span><span class="main">)</span> <span class="entity">renames</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msg</span> <span class="main">=</span> <span class="inner_quoted">"Renaming pattern variables in "</span> ^ <span class="entity">const</span>
                  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> warning <span class="entity">msg</span>
                <span class="keyword2"><span class="keyword">in</span></span>
                  Drule.infer_instantiate <span class="entity">ctxt</span> <span class="entity">inst</span> <span class="entity">thm1</span>
                <span class="keyword2"><span class="keyword">end</span></span>
            <span class="keyword2"><span class="keyword">in</span></span>
              <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">renamess</span> <span class="keyword2"><span class="keyword">of</span></span>
                <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">changed</span><span class="main">,</span> <span class="main">(</span><span class="entity">lhs1</span> :: <span class="entity">lhss</span><span class="main">,</span> <span class="entity">thm1</span> :: <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">[</span><span class="entity">renames</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span>true<span class="main">,</span> <span class="main">(</span><span class="entity">lhss</span><span class="main">,</span> <span class="entity">rename</span> <span class="entity">renames</span> :: <span class="entity">thms</span><span class="main">)</span><span class="main">)</span>
              <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> error <span class="main">(</span><span class="inner_quoted">"Too many incompatible equations in "</span> ^ <span class="entity">const</span> ^ <span class="inner_quoted">", this is unsupported"</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        fold <span class="entity">insert</span> <span class="entity">eqs</span> <span class="main">(</span>false<span class="main">,</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
        |&gt; apsnd snd
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">changed</span><span class="main">,</span> <span class="entity">thms</span><span class="main">)</span> <span class="main">=</span>
      map <span class="entity">process_group</span> <span class="entity">groups</span>
      |&gt; split_list
      |&gt; apsnd flat
      |&gt; apfst <span class="main">(</span>exists I<span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">changed</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">thms</span> <span class="keyword2"><span class="keyword">else</span></span> NONE
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">enabled</span> <span class="main">=</span> <span class="entity">setup_conditional_functrans</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> pattern_compatibility<span class="antiquote">}</span></span></span> <span class="entity">functrans</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/dynamic_unfold.ML">
<div class="head">
<h1>File ‹dynamic_unfold.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">DYNAMIC_UNFOLD</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> enabled<span class="main">:</span> bool Config.T
  <span class="keyword1"><span class="keyword">val</span></span> simproc<span class="main">:</span> morphism <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> thm option
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Dynamic_Unfold</span> <span class="main">:</span> <span class="entity">DYNAMIC_UNFOLD</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">enabled</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "dynamic_unfold"<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

<span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simproc</span> <span class="main">_</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">enabled</span> <span class="keyword2"><span class="keyword">then</span></span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Config.put <span class="entity">enabled</span> false <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thy</span> <span class="main">=</span> Proof_Context.theory_of <span class="entity">ctxt</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unfold_thms</span> <span class="main">=</span>
        <span class="entity">all_consts</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>
        |&gt; filter <span class="main">(</span>not o can dest_funT o snd<span class="main">)</span>
        |&gt; map <span class="main">(</span>snd o <span class="entity">Code.equations_of_cert</span> <span class="entity">thy</span> o <span class="entity">Code.get_cert</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> o fst<span class="main">)</span>
        |&gt; <span class="entity">cat_options</span>
        |&gt; flat
        |&gt; map <span class="main">(</span>fst o snd<span class="main">)</span>
        |&gt; <span class="entity">cat_options</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">unfold_thms</span> <span class="keyword2"><span class="keyword">then</span></span>
        NONE
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="comment1">(* in principle this should *always* change something, but we better wrap it in
           changed_conv to at least throw an error instead of loop *)</span>
        SOME <span class="main">(</span><span class="entity">changed_conv</span> <span class="main">(</span>Raw_Simplifier.rewrite <span class="entity">ctxt</span> false <span class="entity">unfold_thms</span><span class="main">)</span> <span class="entity">ct</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">else</span></span>
    NONE

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Utils">
<div class="head">
<h1>Theory CakeML_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> CakeML_Utils
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
  <span class="quoted">"<a href="../CakeML/Semantic_Extras.html">CakeML.Semantic_Extras</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> v_ns <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>modN<span class="main">,</span> varN<span class="main">,</span> v<span class="main">)</span> namespace"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> c_ns <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>modN<span class="main">,</span> conN<span class="main">,</span> <span class="main">(</span>nat <span class="main">*</span> tid_or_exn<span class="main">)</span><span class="main">)</span> namespace"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> all_env <span class="main">=</span> <span class="quoted"><span class="quoted">"v sem_env"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cake_linear_clauses</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ast.pat <span class="main">×</span> exp<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_linear_clauses</span> <span class="main">≡</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> allDistinct <span class="main">(</span>pat_bindings <span class="bound">pat</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> Lem_string.concat

<span class="comment1">(* needed for the function package *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">measure_function</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_measure <span class="main">(</span>size_sem_env size<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">declare</span></span> all_distinct_alt_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">if_rval</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">if_rval</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v0</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">if_rval</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> if_rvalI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Rval <span class="bound">v</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> if_rval <span class="free">P</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">if_match</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">if_match</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Match <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">if_match</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sequence_result</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sequence_result</span> <span class="main">[]</span> <span class="main">=</span> Rval <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sequence_result</span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sequence_result</span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> map_result <span class="main">(</span><span class="main">λ</span><span class="bound">vs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">#</span> <span class="bound">vs</span><span class="main">)</span> id <span class="main">(</span><span class="free">sequence_result</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sequence_result_rvalD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="free">rs</span> <span class="main">=</span> Rval <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> map Rval <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="skolem"><span class="skolem">vs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Rval <span class="skolem">v0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">v0</span> <span class="main">#</span> <span class="skolem">vs0</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rval <span class="skolem">vs0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sequence_result_Rval<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sequence_result <span class="main">(</span>map Rval <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> Rval <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="comment1">(* FIXME move to CakeML entry *)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">tapp_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tapp_0</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="main">=</span> Tapp <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">tapp_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tapp_1</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> Tapp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">tapp_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tapp_2</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> Tapp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> Ast.t
  constructors<span class="main">:</span>
    <span class="quoted">Ast.Tvar</span><span class="main">,</span>
    <span class="quoted">Ast.Tvar_db</span><span class="main">,</span>
    <span class="quoted">CakeML_Utils.tapp_0</span><span class="main">,</span>
    <span class="quoted">CakeML_Utils.tapp_1</span><span class="main">,</span>
    <span class="quoted">CakeML_Utils.tapp_2</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Test_Utils">
<div class="head">
<h1>Theory Test_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Utils
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Code_Utils.html">Code_Utils</a>
  <a href="../Huffman/Huffman.html">Huffman.Huffman</a>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Leftist_Heap.html">HOL-Data_Structures.Leftist_Heap</a>"</span>
  <span class="quoted">"<a href="../Pairing_Heap/Pairing_Heap_Tree.html">Pairing_Heap.Pairing_Heap_Tree</a>"</span>
  <span class="quoted">"<a href="../Root_Balanced_Tree/Root_Balanced_Tree.html">Root_Balanced_Tree.Root_Balanced_Tree</a>"</span>
  <span class="quoted">"<a href="../Dict_Construction/Dict_Construction.html">Dict_Construction.Dict_Construction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Dynamic unfolding›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">one</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">one</span> <span class="main">=</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">plus_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">plus_one</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> one <span class="main">+</span> <span class="free">plus_one</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_one</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> one"</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">has_one</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">const</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> plus_one<span class="antiquote">}</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">eqngr</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">Code_Preproc.obtain</span> true <span class="main">{</span>ctxt <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> consts <span class="main">=</span> <span class="main">[</span><span class="entity">const</span><span class="main">]</span><span class="main">,</span> terms <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">}</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_consts</span> <span class="main">=</span> Graph.all_succs <span class="entity">eqngr</span> <span class="main">[</span><span class="entity">const</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    member <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span> <span class="entity">all_consts</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> one<span class="antiquote">}</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹<span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">assert</span><span class="antiquote">}</span></span></span></span> <span class="main">(</span><span class="entity">has_one</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">dynamic_unfold</span><span class="main">]</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹<span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">assert</span><span class="antiquote">}</span></span></span></span> <span class="main">(</span>not <span class="main">(</span><span class="entity">has_one</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pattern compatibility›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cannot deal with diagonal function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">diagonal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">diagonal</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> True False <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">diagonal</span> False <span class="free"><span class="bound"><span class="entity">y</span></span></span> True <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">diagonal</span> True False <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">diagonal</span></span>

<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">Leftist_Heap.ltree</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">pattern_compatibility</span><span class="main">]</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
  <span class="main">{</span>ctxt <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">,</span> consts <span class="main">=</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> diagonal<span class="antiquote">}</span></span><span class="main">]</span><span class="main">,</span> terms <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">}</span>
  |&gt; can <span class="main">(</span><span class="entity">Code_Preproc.obtain</span> true<span class="main">)</span>
  |&gt; not
  |&gt; <span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">assert</span><span class="antiquote">}</span></span></span></span>
›</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">huffman</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML Scala

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">Leftist_Heap.ltree</span></span>
  <span class="quoted"><span class="quoted">Leftist_Heap.node</span></span>
  <span class="quoted"><span class="quoted">Leftist_Heap.merge</span></span>
  <span class="quoted"><span class="quoted">Leftist_Heap.insert</span></span>
  <span class="quoted"><span class="quoted">Leftist_Heap.del_min</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> SML Scala

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">Pairing_Heap_Tree.link</span></span>
  <span class="quoted"><span class="quoted">Pairing_Heap_Tree.pass<span class="hidden">⇩</span><sub>1</sub></span></span>
  <span class="quoted"><span class="quoted">Pairing_Heap_Tree.pass<span class="hidden">⇩</span><sub>2</sub></span></span>
  <span class="quoted"><span class="quoted">Pairing_Heap_Tree.is_root</span></span>
  <span class="quoted"><span class="quoted">Pairing_Heap_Tree.pheap</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> SML Scala

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">Root_Balanced_Tree.size_tree_tm</span></span>
  <span class="quoted"><span class="quoted">Root_Balanced_Tree.inorder2_tm</span></span>
  <span class="quoted"><span class="quoted">Root_Balanced_Tree.split_min_tm</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> SML Scala

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* FIXME RBT *)</span>

<span class="comment1">(* FIXME move to Dict_Construction *)</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹<span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util›</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹
  <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">CONTINUE_WITH</span>
    <span class="main">[</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">,</span> resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">,</span> resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>3<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span> <span class="inner_numeral">1</span>
›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">∧</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹
  <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">CONTINUE_WITH_FW</span>
    <span class="main">[</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">,</span> K all_tac<span class="main">,</span> resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>3<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span> <span class="inner_numeral">1</span>
›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹Goal.recover_conjunction_tac THEN
  <span class="main">(</span>Goal.conjunction_tac THEN_ALL_NEW
    <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="entity">CONTINUE_WITH</span>
    <span class="main">[</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">,</span> resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">1</span>
›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∧</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">tactic</span> <span class="quoted">‹
  <span class="main">(</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI conjI<span class="main">[</span><span class="operator">rotated</span><span class="main">]</span><span class="antiquote">}</span></span></span> <span class="entity">CONTINUE_WITH</span>
    <span class="main">[</span>resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>1<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">,</span> resolve_tac <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> assms<span class="main">(</span>2<span class="main">)</span><span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span> <span class="inner_numeral">1</span>
›</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Doc_Terms">
<div class="head">
<h1>Theory Doc_Terms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Doc_Terms
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Terms_Extras">
<div class="head">
<h1>Theory Terms_Extras</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional material over the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Higher_Order_Terms›</span></span></span></span> AFP entry›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Terms_Extras
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Compiler_Utils.html">../Utils/Compiler_Utils</a>"</span>
  <a href="../Higher_Order_Terms/Pats.html">Higher_Order_Terms.Pats</a>
  <span class="quoted">"<a href="../Dict_Construction/Dict_Construction.html">Dict_Construction.Dict_Construction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Mpat_Antiquot.mpaq_App <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$$</span>"</span> 900<span class="main">)</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"hol_term.ML"</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">basic_rule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">basic_rule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟷</span>
  linear <span class="free"><span class="bound"><span class="entity">lhs</span></span></span> <span class="main">∧</span>
  is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">¬</span> is_const <span class="free"><span class="bound"><span class="entity">lhs</span></span></span> <span class="main">∧</span>
  frees <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">|⊆|</span> frees <span class="free"><span class="bound"><span class="entity">lhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> basic_ruleI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">lhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_const <span class="free">lhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">rhs</span> <span class="main">|⊆|</span> frees <span class="free">lhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"basic_rule <span class="main">(</span><span class="free">lhs</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">split_rule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>name <span class="main">×</span> <span class="main">(</span>term list <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">split_rule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">args</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="free"><span class="bound"><span class="entity">lhs</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>const_name <span class="bound">name</span><span class="main">,</span> <span class="main">(</span><span class="bound">args</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">unsplit_rule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> <span class="main">(</span>term list <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unsplit_rule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_unsplit<span class="main">:</span> <span class="quoted"><span class="quoted">"split_rule <span class="main">(</span>unsplit_rule <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unsplit_rule.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb const_name_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unsplit_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"basic_rule <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unsplit_rule <span class="main">(</span>split_rule <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> pat <span class="main">=</span> Patvar <span class="quoted">name</span> <span class="main">|</span> Patconstr <span class="quoted">name</span> <span class="quoted"><span class="quoted">"pat list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mk_pat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> pat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mk_pat</span> <span class="free"><span class="bound"><span class="entity">pat</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> strip_comb <span class="free"><span class="bound"><span class="entity">pat</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Const <span class="bound">s</span><span class="main">,</span> <span class="bound">args</span><span class="main">)</span> <span class="main">⇒</span> Patconstr <span class="bound">s</span> <span class="main">(</span>map <span class="free">mk_pat</span> <span class="bound">args</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span>Free <span class="bound">s</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span> Patvar <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> mk_pat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_pat_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mk_pat <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">args</span><span class="main">)</span> <span class="main">=</span> Patconstr <span class="free">name</span> <span class="main">(</span>map mk_pat <span class="free">args</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"mk_pat <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> Patvar <span class="free">name</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_pat.simps strip_list_comb_const<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">patvars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">patvars</span> <span class="main">(</span>Patvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">patvars</span> <span class="main">(</span>Patconstr <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span>fset_of_list <span class="main">(</span>map <span class="free">patvars</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_pat_frees<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"patvars <span class="main">(</span>mk_pat <span class="free">p</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_pat_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">name</span> <span class="skolem">args</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>patvars <span class="main">∘</span> mk_pat<span class="main">)</span> <span class="skolem">args</span> <span class="main">=</span> map frees <span class="skolem">args</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fset_of_list <span class="main">(</span>map <span class="main">(</span>patvars <span class="main">∘</span> mk_pat<span class="main">)</span> <span class="skolem">args</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>map frees <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freess_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This definition might seem a little counter-intuitive. Assume we have two defining equations
  of a function, e.g.\ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">map</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"map <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"map <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> map <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  The pattern "matrix" is compiled right-to-left. Equal patterns are grouped together. This
  definition is needed to avoid the following situation:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"map <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">[]</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"map <span class="free"><span class="free">g</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> map <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  While this is logically the same as above, the problem is that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">f</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">g</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are
  overlapping but distinct patterns. Hence, instead of grouping them together, they stay separate.
  This leads to overlapping patterns in the target language which will produce wrong results.
  One way to deal with this is to rename problematic variables before invoking the compiler.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pattern_compatible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pattern_compatible</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">pattern_compatible</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟶</span> <span class="free">pattern_compatible</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pattern_compatible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∨</span> non_overlapping <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> pattern_compatible_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  pattern_compatible.simps<span class="main">[</span><span class="operator">folded</span> app_term_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> pattern_compatible_induct <span class="main">=</span> pattern_compatible.induct<span class="main">[</span><span class="operator">case_names</span> app_app<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> pattern_compatible_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> pattern_compatile_reflP<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reflp pattern_compatible"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pattern_compatible_refl reflpI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pattern_compatible_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>non_overlapping<span class="main">)</span> <span class="quoted"><span class="quoted">"non_overlapping <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pattern_compatible_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app_app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> app_app <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> app_app <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> pattern_compatible <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_overlapping <span class="main">(</span><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> app_app <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> non_overlapping_appI1 non_overlapping_appI2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> app_app.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rev_accum_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rev_accum_rel</span> <span class="free">R</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rev_accum_rel</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟹</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">rev_accum_rel</span> <span class="free">R</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_accum_rel_refl<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reflp <span class="free">R</span> <span class="main">⟹</span> rev_accum_rel <span class="free">R</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> reflp_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_accum_rel.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_accum_rel_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rev_accum_rel <span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive_cases</span></span> rev_accum_relE<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> nil snoc<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev_accum_rel <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_accum_rel_butlast<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rev_accum_rel <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev_accum_rel <span class="free">P</span> <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_accum_relE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_accum_rel.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_accum_rel_snoc_eqE<span class="main">:</span> <span class="quoted"><span class="quoted">"rev_accum_rel <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rev_accum_relE<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">patterns_compatible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term list <span class="main">⇒</span> term list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">patterns_compatible</span> <span class="main">≡</span> rev_accum_rel pattern_compatible"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">patterns_compatibles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term list <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">patterns_compatibles</span> <span class="main">≡</span> fpairwise <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">(</span><span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> patterns_compatible <span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pattern_compatible_combD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_accum_rel.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pattern_compatible_combI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_accum_rel.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="main">(</span>list_comb <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" pattern_compatible <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_comb <span class="free">f</span> <span class="skolem">xs</span> <span class="main">=</span> list_comb <span class="free">g</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> snoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list_comb_semi_inj<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rev_accum_rel_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_accum_rel.intros<span class="main">)</span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹The above example can be made concrete here. In general, the following identity does not hold:›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">t</span> <span class="free">u</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∨</span> non_overlapping <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> pattern_compatible_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> pattern_compatible_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="comment1">― ‹The counterexample:›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pats1</span> <span class="main">=</span> <span class="main">[</span>Free <span class="main">(</span>Name <span class="inner_quoted">''f''</span><span class="main">)</span><span class="main">,</span> Const <span class="main">(</span>Name <span class="inner_quoted">''nil''</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pats2</span> <span class="main">=</span> <span class="main">[</span>Free <span class="main">(</span>Name <span class="inner_quoted">''g''</span><span class="main">)</span><span class="main">,</span> Const <span class="main">(</span>Name <span class="inner_quoted">''cons''</span><span class="main">)</span> <span class="main">$</span> Free <span class="main">(</span>Name <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">$</span> Free <span class="main">(</span>Name <span class="inner_quoted">''xs''</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> <span class="quoted"><span class="quoted">"non_overlapping <span class="main">(</span>list_comb <span class="free">c</span> pats1<span class="main">)</span> <span class="main">(</span>list_comb <span class="free">c</span> pats2<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pats1_def pats2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> non_overlapping_appI2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> non_overlapping_const_appI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">proposition</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> patterns_compatible pats1 pats2"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pats1_def pats2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_accum_rel.cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_accum_rel.cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_accum_rel.cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> overlapping_var1I<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pattern_compatibles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pattern_compatibles</span> <span class="main">≡</span> fpairwise <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">(</span><span class="bound">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> pattern_compatible <span class="bound">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> match_compatible_pat_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pattern_compatible_cases match_overlapping<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> match_compatible_env_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> match_compatible_pat_eq option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> matchs_compatible_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">us</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">us</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matchs_some_eq_length<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> linear_list_comb'<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> calculation

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_compatible_pat_eq<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> list_comb_inj_second injD<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_compatible_env_eq<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compatible_find_match<span class="main">:</span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="main">(</span>fset_of_list <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>linear <span class="main">∘</span> fst<span class="main">)</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>fset_of_list <span class="free">cs</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_match <span class="free">cs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">pat</span></span> <span class="quoted"><span class="free">rhs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat'</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat'</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_match <span class="main">(</span><span class="main">(</span><span class="skolem">pat'</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat'</span> <span class="free">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fpairwise_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>linear <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fset_of_list_subset is_fmap_subset set_subset_Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> None<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons None <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">env'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set comp_apply fst_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="skolem">pat</span> <span class="skolem">pat'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> <span class="skolem">pat'</span>"</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pattern_compatible_refl<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> fpairwise_alt_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env'</span> <span class="main">=</span> <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat'</span> <span class="main">=</span> <span class="skolem">pat</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> match_compatible_env_eq match_compatible_pat_eq
        <span class="keyword1"><span class="command">using</span></span> Cons Some
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs'</span> <span class="main">=</span> <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_fmapD
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat'</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>›</span></span> fset_of_list_elem list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Some<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="quoted">"term"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity_compatible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity_compatible</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span>
    <span class="main">(</span><span class="bound">head<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">head<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>
  <span class="keyword1">in</span> <span class="bound">head<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">head<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> length <span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">arity_compatibles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity_compatibles</span> <span class="main">≡</span> fpairwise <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">(</span><span class="bound">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> arity_compatible <span class="bound">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">head</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">head</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> const_name <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">heads_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> fset <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">heads_of</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">(</span>head <span class="main">∘</span> fst<span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> fset <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> fthe_elem' <span class="main">(</span><span class="main">(</span>length <span class="main">∘</span> fst<span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arityI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> length <span class="bound">pats</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arity <span class="free">rs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">∘</span> fst<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span> <span class="main">=</span> <span class="main">{|</span> <span class="free">n</span> <span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> arity_def fthe_elem'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/hol_term.ML">
<div class="head">
<h1>File ‹hol_term.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_string</span> <span class="main">=</span> <span class="entity">HOLogic.mk_string</span> o <span class="entity">Class_Graph.mangle</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_name</span> <span class="entity">n</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Name<span class="antiquote">}</span></span> $ <span class="entity">mk_string</span> <span class="entity">n</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fsetT</span> <span class="entity">typ</span> <span class="main">=</span> Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> fset<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">[</span><span class="entity">typ</span><span class="main">]</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fmapT</span> <span class="entity">keyT</span> <span class="entity">valueT</span> <span class="main">=</span> Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> fmap<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">[</span><span class="entity">keyT</span><span class="main">,</span> <span class="entity">valueT</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fset</span> <span class="entity">typ</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">xs</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> finsert<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">typ</span> --&gt; <span class="entity">fsetT</span> <span class="entity">typ</span> --&gt; <span class="entity">fsetT</span> <span class="entity">typ</span><span class="main">)</span> $ <span class="entity">x</span> $ <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> bot<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">fsetT</span> <span class="entity">typ</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> fold <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">init</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_fmap</span> <span class="main">(</span><span class="entity">keyT</span><span class="main">,</span> <span class="entity">valueT</span><span class="main">)</span> <span class="entity">xs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fmapT</span> <span class="main">=</span> <span class="entity">fmapT</span> <span class="entity">keyT</span> <span class="entity">valueT</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">f</span> <span class="main">(</span><span class="entity">k</span><span class="main">,</span> <span class="entity">v</span><span class="main">)</span> <span class="entity">xs</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> fmupd<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">keyT</span> --&gt; <span class="entity">valueT</span> --&gt; <span class="entity">fmapT</span> --&gt; <span class="entity">fmapT</span><span class="main">)</span> $ <span class="entity">k</span> $ <span class="entity">v</span> $ <span class="entity">xs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">init</span> <span class="main">=</span> Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> fmempty<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">fmapT</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> fold <span class="entity">f</span> <span class="entity">xs</span> <span class="entity">init</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">HOL_TERM</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> mk_term<span class="main">:</span> bool <span class="main">-&gt;</span> term <span class="main">-&gt;</span> term
  <span class="keyword1"><span class="keyword">val</span></span> mk_eq<span class="main">:</span> term <span class="main">-&gt;</span> term

  <span class="keyword1"><span class="keyword">val</span></span> list_comb<span class="main">:</span> term * term list <span class="main">-&gt;</span> term
  <span class="keyword1"><span class="keyword">val</span></span> strip_comb<span class="main">:</span> term <span class="main">-&gt;</span> term * term list
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">HOL_Term</span> <span class="main">:</span> <span class="entity">HOL_TERM</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_comb</span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span> <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span>
  fold <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> App<span class="antiquote">}</span></span> $ <span class="entity">t</span> $ <span class="entity">x</span><span class="main">)</span> <span class="entity">xs</span> <span class="entity">f</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">strip_comb</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">go</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> App<span class="antiquote">}</span></span> $ <span class="entity">f</span> $ <span class="entity">x</span><span class="main">)</span> <span class="main">=</span> apsnd <span class="main">(</span>cons <span class="entity">f</span><span class="main">)</span> <span class="main">(</span><span class="entity">go</span> <span class="entity">x</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">go</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> apsnd rev <span class="main">(</span><span class="entity">go</span> <span class="entity">t</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_term</span> <span class="entity">schematic</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Const<span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="entity">n</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span>Free <span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">schematic</span> <span class="keyword2"><span class="keyword">then</span></span>
            error <span class="inner_quoted">"free variables are not supported"</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Free<span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="entity">n</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span>Bound <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Bound<span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span> <span class="entity">i</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span><span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> App<span class="antiquote">}</span></span> $ <span class="entity">aux</span> <span class="entity">t</span> $ <span class="entity">aux</span> <span class="entity">u</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Abs<span class="antiquote">}</span></span> $ <span class="entity">aux</span> <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="entity">n</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">schematic</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Free<span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="main">(</span><span class="entity">n</span> ^ <span class="inner_quoted">"."</span> ^ Value.print_int <span class="entity">i</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            error <span class="inner_quoted">"schematic variables are not supported"</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">aux</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mk_eq</span> <span class="main">=</span>
  <span class="entity">HOLogic.mk_prod</span> o <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">apply</span> 2<span class="antiquote">}</span></span></span> <span class="main">(</span><span class="entity">mk_term</span> true<span class="main">)</span> o Logic.dest_equals

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HOL_Datatype">
<div class="head">
<h1>Theory HOL_Datatype</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Reflecting HOL datatype definitions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HOL_Datatype
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Terms_Extras.html">Terms_Extras</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Datatype_Records.html">HOL-Library.Datatype_Records</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
  <span class="quoted">"<a href="../Higher_Order_Terms/Name.html">Higher_Order_Terms.Name</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"typ"</span> <span class="main">=</span>
  TVar <span class="quoted">name</span> <span class="main">|</span>
  TApp <span class="quoted">name</span> <span class="quoted"><span class="quoted">"typ list"</span></span>

<span class="keyword1"><span class="command">datatype_compat</span></span> <span class="quoted">"typ"</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">tapp_0</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tapp_0</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="main">=</span> TApp <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">tapp_1</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tapp_1</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> TApp <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">tapp_2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tapp_2</span> <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> TApp <span class="free"><span class="bound"><span class="entity">tc</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> <span class="quoted">"typ"</span>
  constructors<span class="main">:</span>
    <span class="quoted">TVar</span><span class="main">,</span>
    <span class="quoted">HOL_Datatype.tapp_0</span><span class="main">,</span>
    <span class="quoted">HOL_Datatype.tapp_1</span><span class="main">,</span>
    <span class="quoted">HOL_Datatype.tapp_2</span>

<span class="keyword1"><span class="command">datatype_record</span></span> dt_def <span class="main">=</span>
  <span class="free"><span class="entity">tparams</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name list"</span></span>
  <span class="free"><span class="entity">constructors</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> typ list<span class="main">)</span> fmap"</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"hol_datatype.ML"</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/hol_datatype.ML">
<div class="head">
<h1>File ‹hol_datatype.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">HOL_DATATYPE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> mk_typ<span class="main">:</span> bool <span class="main">-&gt;</span> typ <span class="main">-&gt;</span> term
  <span class="keyword1"><span class="keyword">val</span></span> mk_dt_def<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string <span class="main">-&gt;</span> term
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">HOL_Datatype</span> <span class="main">:</span> <span class="entity">HOL_DATATYPE</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">check_sort</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">class</span> type<span class="antiquote">}</span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">check_sort</span> <span class="main">_</span> <span class="main">=</span> error <span class="inner_quoted">"non-standard sorts are not supported"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_tvar</span> <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">idx</span><span class="main">)</span><span class="main">,</span> <span class="entity">sort</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">check_sort</span> <span class="entity">sort</span><span class="main">;</span> <span class="entity">mk_name</span> <span class="main">(</span><span class="entity">name</span> ^ <span class="inner_quoted">"."</span> ^ Value.print_int <span class="entity">idx</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_tfree</span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">sort</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">check_sort</span> <span class="entity">sort</span><span class="main">;</span> <span class="entity">mk_name</span> <span class="entity">name</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_typ</span> <span class="entity">schematic</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">typ</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> TApp<span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="entity">typ</span> $ <span class="entity">HOLogic.mk_list</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">typ</span><span class="antiquote">}</span></span> <span class="main">(</span>map <span class="entity">aux</span> <span class="entity">args</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span>TVar <span class="entity">tvar</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">schematic</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> TVar<span class="antiquote">}</span></span> $ <span class="entity">mk_tvar</span> <span class="entity">tvar</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            error <span class="inner_quoted">"schematic type variables are not supported"</span>
      <span class="main">|</span> <span class="entity">aux</span> <span class="main">(</span>TFree <span class="entity">tfree</span><span class="main">)</span> <span class="main">=</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">schematic</span> <span class="keyword2"><span class="keyword">then</span></span>
            error <span class="inner_quoted">"free type variables are not supported"</span>
          <span class="keyword2"><span class="keyword">else</span></span>
            <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> TVar<span class="antiquote">}</span></span> $ <span class="entity">mk_tfree</span> <span class="entity">tfree</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">aux</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_dt_def</span> <span class="entity">ctxt</span> <span class="entity">typ</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">ctrs</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> the <span class="main">(</span><span class="entity">Ctr_Sugar.ctr_sugar_of</span> <span class="entity">ctxt</span> <span class="entity">typ</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tparams</span> <span class="main">=</span>
      dest_Type <span class="entity">T</span> |&gt; snd
      |&gt; map <span class="main">(</span><span class="entity">mk_tvar</span> o dest_TVar<span class="main">)</span>
      |&gt; <span class="entity">HOLogic.mk_list</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">name</span><span class="antiquote">}</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ctr</span> <span class="entity">ctr</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span> <span class="main">=</span> dest_Const <span class="entity">ctr</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">params</span> <span class="main">=</span> strip_type <span class="entity">typ</span> |&gt; fst |&gt; map <span class="main">(</span><span class="entity">mk_typ</span> true<span class="main">)</span> |&gt; <span class="entity">HOLogic.mk_list</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">typ</span><span class="antiquote">}</span></span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">mk_name</span> <span class="entity">name</span><span class="main">,</span> <span class="entity">params</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctrs</span> <span class="main">=</span>
      map <span class="entity">mk_ctr</span> <span class="entity">ctrs</span>
      |&gt; <span class="entity">mk_fmap</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">name</span><span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"typ list"</span><span class="antiquote">}</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> make_dt_def<span class="antiquote">}</span></span> $ <span class="entity">tparams</span> $ <span class="entity">ctrs</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Constructors">
<div class="head">
<h1>Theory Constructors</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Constructor information›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Constructors
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Terms_Extras.html">Terms_Extras</a>
  <a href="HOL_Datatype.html">HOL_Datatype</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> C_info <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> dt_def<span class="main">)</span> fmap"</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructors <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C_info</span> <span class="main">::</span> <span class="quoted">C_info</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flat_C_info</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">×</span> nat <span class="main">×</span> string<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">flat_C_info</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">tname</span><span class="main">,</span> <span class="bound">Cs</span><span class="main">)</span> <span class="main">←</span> sorted_list_of_fmap <span class="free">C_info</span><span class="main">;</span>
  <span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">params</span><span class="main">)</span> <span class="main">←</span> sorted_list_of_fmap <span class="main">(</span>constructors <span class="bound">Cs</span><span class="main">)</span><span class="main">;</span>
  <span class="main">[</span><span class="main">(</span>as_string <span class="bound">C</span><span class="main">,</span> <span class="main">(</span>length <span class="bound">params</span><span class="main">,</span> as_string <span class="bound">tname</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_tdefs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_tdefs</span> <span class="main">=</span> fmdom <span class="free">C_info</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> ffUnion <span class="main">(</span>fmdom <span class="main">|`|</span> constructors <span class="main">|`|</span> fmran <span class="free">C_info</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_constructors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_constructors</span> <span class="main">=</span>
  concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">Cs</span><span class="main">)</span><span class="main">.</span> map fst <span class="main">(</span>sorted_list_of_fmap <span class="main">(</span>constructors <span class="bound">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fmap <span class="free">C_info</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* FIXME nice to have *)</span>
<span class="comment1">(*
lemma all_constructors_alt_def: "all_constructors = map (Name ∘ fst) flat_C_info"
unfolding all_constructors_def flat_C_info_def
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> constructors.C_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> constructors.flat_C_info_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> constructors.all_constructors_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">constructors.C</span></span> <span class="quoted"><span class="quoted">constructors.flat_C_info</span></span> <span class="quoted"><span class="quoted">constructors.all_constructors</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Consts">
<div class="head">
<h1>Theory Consts</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Special constants›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Consts
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Constructors.html">Constructors</a>
  <a href="../Higher_Order_Terms/Nterm.html">Higher_Order_Terms.Nterm</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> special_constants <span class="main">=</span> constructors

<span class="keyword1"><span class="command">locale</span></span> pre_constants <span class="main">=</span> special_constants <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">heads</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all_consts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_consts</span> <span class="main">=</span> <span class="free">heads</span> <span class="main">|∪|</span> C"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">welldefined</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">welldefined</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> consts <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|⊆|</span> all_consts"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> welldefined<span class="main">:</span> simple_syntactic_and <span class="quoted">welldefined</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> pre_constants.all_consts_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">locale</span></span> constants <span class="main">=</span> pre_constants <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> disjnt<span class="main">:</span> <span class="quoted"><span class="quoted">"fdisjnt <span class="free">heads</span> C"</span></span>
  <span class="comment1">― ‹Conceptually the following assumptions should belong into <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">locale</span> constructors<span class="antiquote">}</span></span>, but I prefer
      to keep that one assumption-free.›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct_ctr<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_ctr'<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map as_string all_constructors<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> distinct_map
<span class="keyword1"><span class="command">using</span></span> distinct_ctr
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> name.expand<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Strong_Term">
<div class="head">
<h1>Theory Strong_Term</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Term algebra extended with wellformedness›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Strong_Term
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Consts.html">Consts</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_strong_term <span class="main">=</span> <span class="quoted">"term"</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">wellformed</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">all_frees</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name fset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="main">(</span>free <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">wellformed</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">wellformed</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_frees_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">all_frees</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">=</span> fempty"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_frees_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">all_frees</span> <span class="main">(</span>free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free">name</span> <span class="main">|}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_frees_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">all_frees</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">all_frees</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> <span class="free">all_frees</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wellformed_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> wellformed<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> pre_constants <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shadows_consts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>pre_strong_term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">shadows_consts</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">¬</span> fdisjnt all_consts <span class="main">(</span>all_frees <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> shadows<span class="main">:</span> simple_syntactic_or <span class="quoted">shadows_consts</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows_consts_def fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">not_shadows_consts_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">::</span>pre_strong_term<span class="main">)</span> fmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">not_shadows_consts_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> pre_constants.shadows_consts_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">class</span></span> strong_term <span class="main">=</span> pre_strong_term <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> raw_frees_all_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> frees <span class="bound">t</span> <span class="main">|⊆|</span> all_frees <span class="bound">t</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> raw_subst_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> wellformed <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env</span><span class="main">.</span> wellformed_env <span class="bound">env</span> <span class="main">⟶</span> wellformed <span class="main">(</span>subst <span class="bound">t</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frees_all_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">|⊆|</span> all_frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_frees_all_frees<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> wellformed_env <span class="free">env</span> <span class="main">⟹</span> wellformed <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_subst_wellformed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> wellformed<span class="main">:</span> subst_syntactic_and <span class="quoted"><span class="quoted">"wellformed <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>strong_term <span class="main">⇒</span> bool"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_wellformed<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"term"</span> <span class="main">::</span> <span class="quoted">strong_term</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">all_frees_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_term</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">all_frees_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">all_frees_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_term</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">all_frees_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frees_all_frees_term<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"all_frees <span class="free">t</span> <span class="main">=</span> frees <span class="main">(</span><span class="free">t</span><span class="main">::</span>term<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">wellformed_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> Term.wellformed <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 8

  <span class="comment1">(* FIXME move upstream *)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="skolem">P</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_term_def <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> wellformed_term_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Term.subst_wellformed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def free_term_def app_term_def abs_pred_term_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nterm <span class="main">::</span> <span class="quoted">strong_term</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">wellformed_nterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">all_frees_nterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_nterm</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_nterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">all_frees_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">all_frees_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_nterm</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> finsert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">all_frees_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_nterm</span> <span class="main">(</span>Nconst <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_nterm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_nterm_def free_nterm_def app_nterm_def abs_pred_nterm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_constants<span class="main">)</span> shadows_consts_frees<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>strong_term"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span> <span class="main">⟹</span> fdisjnt all_consts <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def shadows_consts_def
<span class="keyword1"><span class="command">using</span></span> frees_all_frees
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wellformed_clauses</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_clauses</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span> <span class="main">∧</span> wellformed <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Sterm">
<div class="head">
<h1>Theory Sterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Terms with sequential pattern matching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sterm
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Strong_Term.html">Strong_Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> sterm <span class="main">=</span>
  Sconst <span class="quoted">name</span> <span class="main">|</span>
  Svar <span class="quoted">name</span> <span class="main">|</span>
  Sabs <span class="main">(</span><span class="free"><span class="entity">clauses</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> sterm<span class="main">)</span> list"</span></span><span class="main">)</span> <span class="main">|</span>
  Sapp <span class="quoted">sterm</span> <span class="quoted">sterm</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">datatype_compat</span></span> sterm

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">sterm</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sabs_single</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ<span class="hidden">⇩</span><sub>s</sub></span> _<span class="keyword1">.</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sabs_single</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">≡</span> Sabs <span class="main">[</span><span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> sclauses <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> sterm<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sterm_induct<span class="main">[</span><span class="operator">case_names</span> Sconst Svar Sabs Sapp<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Sconst <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Svar <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">cs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction_schema</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">pat_completeness</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">lexicographic_order</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sterm <span class="main">::</span> <span class="quoted">pre_term</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_sterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unapp_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_sterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">const_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_sterm</span> <span class="main">=</span> Sconst"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unconst_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_sterm</span> <span class="main">(</span>Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_sterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unfree_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_sterm</span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_sterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_sterm</span> <span class="main">=</span> Svar"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">frees_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">frees_sterm</span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_sterm</span> <span class="main">(</span>Sconst <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_sterm</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span>fset_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="free">frees_sterm</span> <span class="bound">rhs</span> <span class="main">-</span> frees <span class="bound">pat</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees_sterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|∪|</span> <span class="free">frees_sterm</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">subst_sterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_sterm</span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> Svar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free">subst_sterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">subst_sterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_sterm</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="free">subst_sterm</span> <span class="bound">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_sterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">consts_sterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consts_sterm</span> <span class="main">(</span>Svar <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_sterm</span> <span class="main">(</span>Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_sterm</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span>fset_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="free">consts_sterm</span> <span class="bound">rhs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_sterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|∪|</span> <span class="free">consts_sterm</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_sterm_def const_sterm_def free_sterm_def
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> unapp_sterm.elims unconst_sterm.elims unfree_sterm.elims
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sterm <span class="main">::</span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_pred_sterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Sabs <span class="bound">cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">cs</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_pred_stermI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">cs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs_pred <span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_sterm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def free_sterm_def app_sterm_def abs_pred_sterm_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.map_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.map_cong0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cs env pat rhs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"subst <span class="skolem"><span class="skolem">rhs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pat <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">pat</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> prems
          <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq fset_of_list.rep_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBallE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"subst <span class="skolem"><span class="skolem">rhs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> abs_pred_stermI allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">cs</span> <span class="skolem">env</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem case_prod_twice comp_def ffUnion_alt_def<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span> <span class="main">|-|</span> fmdom <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmpred_drop_fset<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span> <span class="main">|-|</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> prod.case
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span> <span class="main">|-|</span> frees <span class="skolem">pat</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span> <span class="main">|-|</span> fmdom <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env</span>"</span></span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem ffUnion_alt_def<span class="main">)</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span> <span class="main">|-|</span> fmdom <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|-|</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|-|</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmpred_drop_fset<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_twice comp_def<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="main">|-|</span> frees <span class="skolem">pat</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fimage_iff<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> abs_pred_stermI allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">cs</span> <span class="skolem">env</span><span class="main">)</span>

      <span class="comment1">― ‹some property on various operations that is only useful in here›</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fbind <span class="main">(</span>fmimage <span class="skolem">m</span> <span class="main">(</span>fbind <span class="skolem">A</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span> fbind <span class="skolem">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fbind <span class="main">(</span>fmimage <span class="skolem">m</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="skolem">A</span> <span class="skolem">f</span> <span class="skolem">g</span>
        <span class="keyword1"><span class="command">including</span></span> fset.lifting fmap.lifting
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">force</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> fbind <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">rhs</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>frees <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funion_image_bind_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fbind_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 1<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fset_of_list_elem<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funion_image_bind_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fbind <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>consts <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|∪|</span> fbind <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>frees <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fbind_fun_funion<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fbind_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∪|</span> fbind <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>frees <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cong<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl _ refl<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f1 <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"funion"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> funion_image_bind_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> consts_sterm.simps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset_of_list_map<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∪|</span> fbind <span class="main">(</span>fmimage <span class="skolem">env</span> <span class="main">(</span>fbind <span class="main">(</span>fset_of_list <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> frees <span class="bound">rhs</span> <span class="main">|-|</span> frees <span class="bound">pat</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> consts"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> funion_image_bind_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmimage_drop_fset<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cong<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl refl<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f1 <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"funion"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fbind_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="skolem">env</span> <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> frees_sterm.simps fset_of_list_map  fmimage_Union funion_image_bind_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_sterm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_abs_abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> no_abs <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> no_abs.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_cases_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_except_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Svar <span class="free">x</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> closed_except <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">S</span> <span class="main">∧</span> closed_except <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> closed_except <span class="bound">t</span> <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> frees <span class="bound">pat</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sconst <span class="free">name</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff ffUnion_alt_def fset_of_list_elem closed_except_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ffUnion_least_rev<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> case_prod_conv fbspec fimageI fminusI fset_of_list_elem fset_rev_mp<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff ffUnion_alt_def fset_of_list_elem closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_except_sabs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">rhs</span> <span class="main">(</span>frees <span class="free">pat</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot.extremum_uniqueI fempty_iff ffUnion_subset_elem fimageI fminusI fset_of_list_elem old.prod.case<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sterm <span class="main">::</span> <span class="quoted">strong_term</span>  <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">wellformed_sterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">wellformed_sterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">wellformed_sterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_sterm</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span> <span class="main">∧</span> <span class="free">wellformed_sterm</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_sterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">all_frees_sterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_sterm</span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">all_frees_sterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">all_frees_sterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_sterm</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span>fset_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">|∪|</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod frees <span class="free">all_frees_sterm</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_sterm</span> <span class="main">(</span>Sconst <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> abs_pred_stermI allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ffUnion_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ffUnion_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">a</span><span class="main">,</span> <span class="improper">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> fBexI<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> abs_pred_stermI allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_map comp_def case_prod_twice<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> prems<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def free_sterm_def app_sterm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_sabs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_free <span class="free">t</span> <span class="main">⟹</span> match <span class="free">t</span> <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> pre_constants <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> welldefined_sabs<span class="main">:</span> <span class="quoted"><span class="quoted">"welldefined <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">t</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff ffUnion_alt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ffUnion_least_rev<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list_all_iff_fset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff fset_of_list_elem<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> shadows_consts_sterm_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟷</span> shadows_consts <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> shadows_consts <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Svar <span class="free">name</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">name</span> <span class="main">|∈|</span> all_consts"</span></span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">⟷</span> list_ex <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> fdisjnt all_consts <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="main">∨</span> shadows_consts <span class="bound">t</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Sconst <span class="free">name</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def list_ex_iff
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def fset_of_list_elem fdisjnt_alt_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ballE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_eq_empty_iff ffUnion_alt_def fset_of_list_elem <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> allE fBallE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows_consts_def fdisjnt_alt_def<span class="main">)</span>

<span class="comment1">(* FIXME derive from axioms? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> subst_shadows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span><span class="free">t</span><span class="main">::</span>sterm<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_consts_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_ex_iff case_prod_twice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> c
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst_thin</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Sabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sabs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Sabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Sabs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Pterm">
<div class="head">
<h1>Theory Pterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Terms with explicit pattern matching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pterm
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Compiler_Utils.html">../Utils/Compiler_Utils</a>"</span>
  <a href="Consts.html">Consts</a>
  <a href="Sterm.html">Sterm</a> <span class="comment1">― ‹Inclusion of this theory might seem a bit strange. Indeed, it is only for technical
    reasons: to allow for a <span class="antiquoted"><span class="operator">⬚</span><span class="raw_text">‹<span class="keyword1"><span class="command">quickcheck</span></span>›</span></span> setup.›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pterm <span class="main">=</span>
  Pconst <span class="quoted">name</span> <span class="main">|</span>
  Pvar <span class="quoted">name</span> <span class="main">|</span>
  Pabs <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> pterm<span class="main">)</span> fset"</span></span> <span class="main">|</span>
  Papp <span class="quoted">pterm</span> <span class="quoted">pterm</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sterm_to_pterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> pterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sterm_to_pterm</span> <span class="main">(</span>Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Pconst <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sterm_to_pterm</span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Pvar <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sterm_to_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">sterm_to_pterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">sterm_to_pterm</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sterm_to_pterm</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> Pabs <span class="main">(</span>fset_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">sterm_to_pterm</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> pterm
  <span class="comment1">― ‹will print some fishy ``constructor'' names, but at least it works›</span>
  constructors<span class="main">:</span> <span class="quoted">sterm_to_pterm</span>

<span class="keyword1"><span class="command">lemma</span></span> sterm_to_pterm_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> sterm_to_pterm <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pconst <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sterm_to_pterm.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pvar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sterm_to_pterm.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Pabs.IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> fset_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id sterm_to_pterm<span class="main">)</span> <span class="skolem">cs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">c</span> <span class="skolem">cs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs'</span><span class="main">.</span> <span class="skolem">cs</span> <span class="main">=</span> fset_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id sterm_to_pterm<span class="main">)</span> <span class="bound">cs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> insert<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insert.prems <span class="keyword1"><span class="command">unfolding</span></span> finsert.rep_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> fset_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id sterm_to_pterm<span class="main">)</span> <span class="skolem">cs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> sterm_to_pterm <span class="skolem">rhs'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> insert.prems<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">rhs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs'</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">cs'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Pabs <span class="skolem">cs</span> <span class="main">=</span> sterm_to_pterm <span class="main">(</span>Sabs <span class="skolem">cs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Pabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Papp <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> sterm_to_pterm <span class="skolem">t1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> sterm_to_pterm <span class="skolem">t2'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">t2</span> <span class="main">=</span> sterm_to_pterm <span class="main">(</span><span class="skolem">t1'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Papp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pterm_induct<span class="main">[</span><span class="operator">case_names</span> Pconst Pvar Pabs Papp<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pconst <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Pvar <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">cs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Pabs <span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">u</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pterm.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 3
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmember.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> pterm <span class="main">::</span> <span class="quoted">pre_term</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_pterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unapp_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_pterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">const_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_pterm</span> <span class="main">=</span> Pconst"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unconst_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_pterm</span> <span class="main">(</span>Pconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_pterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_pterm</span> <span class="main">=</span> Pvar"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unfree_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_pterm</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_pterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity"><span class="class_parameter">subst_pterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_pterm</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> Pvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free">subst_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">subst_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_pterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> Pabs <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="free">subst_pterm</span> <span class="bound">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_pterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>size <span class="main">∘</span> fst<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_imp_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nat_le_single<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">a</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">,</span></span> size <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">consts_pterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consts_pterm</span> <span class="main">(</span>Pconst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">consts_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_pterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span>snd <span class="main">|`|</span> map_prod id <span class="free">consts_pterm</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_pterm</span> <span class="main">(</span>Pvar <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">frees_pterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">frees_pterm</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">frees_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_pterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pv</span><span class="main">,</span> <span class="bound">tv</span><span class="main">)</span><span class="main">.</span> <span class="bound">tv</span> <span class="main">-</span> frees <span class="bound">pv</span><span class="main">)</span> <span class="main">|`|</span> map_prod id <span class="free">frees_pterm</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_pterm</span> <span class="main">(</span>Pconst <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_pterm_def const_pterm_def free_pterm_def
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> unapp_pterm.elims unconst_pterm.elims unfree_pterm.elims
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_pabs_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pat</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">cs</span> <span class="main">⟹</span> subst <span class="bound">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> Pabs <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_pterm.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">Pabs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset_map_snd_id<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmember.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> frees_pabs_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"frees <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> frees <span class="bound">rhs</span> <span class="main">-</span> frees <span class="bound">pat</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sterm_to_pterm_frees<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>sterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fimage_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Sabs<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem snds.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sterm_to_pterm_consts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>sterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fimage_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Sabs<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem snds.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_sterm_to_pterm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst <span class="main">(</span>sterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fmmap sterm_to_pterm <span class="free">env</span><span class="main">)</span> <span class="main">=</span> sterm_to_pterm <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sabs<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> pterm <span class="main">::</span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_pred_pterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Pabs <span class="bound">cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">cs</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> abs_pred_trivI0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="main">⟹</span> abs_pred <span class="free">P</span> <span class="main">(</span><span class="free">t</span><span class="main">::</span>pterm<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> abs_pred_pterm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pterm_induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_pterm_def free_pterm_def app_pterm_def abs_pred_pterm_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">(* FIXME proving 2, 3 and 4 via sterm probably requires lifting setup *)</span>
  <span class="comment1">(* lifting setup requires a consistent ordering without assumptions! *)</span>
  <span class="comment1">(* but: other parts (in Eq_Logic_PM_Seq) require a key-ordering that only works with assumptions *)</span>
  <span class="comment1">(* solution: don't try to abstract over the ordering *)</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_pterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_pabs_id<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_pterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> c<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">hypsubst_thin</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cs env pat rhs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"subst <span class="skolem"><span class="skolem">rhs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pat <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">pat</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fmember.rep_eq<span class="main">)</span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq fset_of_list.rep_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBallE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"subst <span class="skolem"><span class="skolem">rhs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_pterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong0<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> cs env<span class="hidden">⇩</span><sub>1</sub> env<span class="hidden">⇩</span><sub>2</sub> a b
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fmember.rep_eq<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> abs_pred_trivI0<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">pterm</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> pterm<span class="main">)</span> fmap"</span></span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> sterm_to_pterm <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sterm_to_pterm_total<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> fmmap sterm_to_pterm <span class="skolem">env'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmmap_total sterm_to_pterm_total<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>subst <span class="skolem">t</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> frees <span class="skolem">t</span> <span class="main">-</span> fmdom <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> closed<span class="main">)</span> <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_sterm_to_pterm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_frees<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_mono_strong<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> abs_pred_trivI0<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">pterm</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> pterm<span class="main">)</span> fmap"</span></span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> sterm_to_pterm <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sterm_to_pterm_total<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> fmmap sterm_to_pterm <span class="skolem">env'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmmap_total sterm_to_pterm_total<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>subst <span class="skolem">t</span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> consts <span class="skolem">t</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="skolem">env</span> <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> comp_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_sterm_to_pterm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_consts'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> abs_pred_trivI0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_abs_abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> no_abs <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> no_abs.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_cases_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sterm_to_pterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sterm_to_pterm <span class="free">t</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_sterm_def free_pterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_sterm_def const_pterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_sterm_def app_pterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Pabs_single</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Λ<span class="hidden">⇩</span><sub>p</sub></span> _<span class="keyword1">.</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Pabs_single</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">≡</span> Pabs <span class="main">{|</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">|}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_except_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Pvar <span class="free">x</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> closed_except <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">S</span> <span class="main">∧</span> closed_except <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> fBall <span class="free">cs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> closed_except <span class="bound">t</span> <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> frees <span class="bound">pat</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Pconst <span class="free">name</span><span class="main">)</span> <span class="free">S</span> <span class="main">⟷</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def closed_except_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ffUnion_least_rev<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> case_prod_conv fBall_alt_def fminus_iff fset_rev_mp id_apply map_prod_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> pterm <span class="main">::</span> <span class="quoted">pre_strong_term</span>  <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity"><span class="class_parameter">wellformed_pterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">wellformed_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">wellformed_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_pterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">⟷</span> fBall <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span> <span class="main">∧</span> <span class="free">wellformed_pterm</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> is_fmap <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> pattern_compatibles <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed_pterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure size"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_imp_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum_nat_le_single<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">a</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">,</span></span> size <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">all_frees_pterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_pterm</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">all_frees_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">all_frees_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_pterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> ffUnion <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="main">|∪|</span> <span class="bound">T</span><span class="main">)</span> <span class="main">|`|</span> map_prod frees <span class="free">all_frees_pterm</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">all_frees_pterm</span> <span class="main">(</span>Pconst <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_pterm_def free_pterm_def app_pterm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sterm_to_pterm_all_frees<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"all_frees <span class="main">(</span>sterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> all_frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fimage_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Sabs<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem snds.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> pterm <span class="main">::</span> <span class="quoted">strong_term</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> sterm_to_pterm <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sterm_to_pterm_total<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> abs_pred_trivI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> sterm_to_pterm_all_frees sterm_to_pterm_frees
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> frees_all_frees<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_pterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_twice<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_fmap_image<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fpairwise_image fpairwise_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBallE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_PabsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">cs</span> <span class="main">⟹</span> linear <span class="bound">pat</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">cs</span> <span class="main">⟹</span> wellformed <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_closed_pabs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="free">pat</span><span class="main">)</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subst_closed_except_id<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def closed_except_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> shadows_consts_pterm_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟷</span> shadows_consts <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∨</span> shadows_consts <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Pvar <span class="free">name</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">name</span> <span class="main">|∈|</span> all_consts"</span></span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Pabs <span class="free">cs</span><span class="main">)</span> <span class="main">⟷</span> fBex <span class="free">cs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> shadows_consts <span class="bound">pat</span> <span class="main">∨</span> shadows_consts <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Pconst <span class="free">name</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">goal_cases</span>
  <span class="keyword3"><span class="command">case</span></span> 3

  <span class="comment1">(* FIXME duplicated from Sterm *)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def fset_of_list_elem fdisjnt_alt_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ballE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_eq_empty_iff ffUnion_alt_def fset_of_list_elem <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> allE fBallE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows_consts_def fdisjnt_alt_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Term_as_Value">
<div class="head">
<h1>Theory Term_as_Value</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Irreducible terms (values)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term_as_Value
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Sterm.html">Sterm</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Viewing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as values›</span></span>

<span class="comment1">(* FIXME why isn't this declared by BNF *)</span>
<span class="keyword1"><span class="command">declare</span></span> list.pred_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> constructors <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">is_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_value</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="free">is_value</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> C <span class="main">⟹</span> <span class="free">is_value</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Sabs <span class="free">cs</span> <span class="main">≠</span> <span class="free">name</span> <span class="main">$$</span> <span class="free">ts</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">$$</span> <span class="free">ts</span> <span class="main">≠</span> Sabs <span class="free">cs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_comb_cases'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"const <span class="free"><span class="free">name</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> xs <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ts</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def is_app_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> unapp_sterm.elims<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">value_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> sterm<span class="main">)</span> fmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">value_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> is_value<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> svar_value<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_value <span class="main">(</span>Svar <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_value <span class="main">(</span>Svar <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_value.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> free_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>comb<span class="main">)</span> <span class="free">name</span> <span class="free">vs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all is_value <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">|∈|</span> C"</span></span>
        <span class="main">|</span> <span class="main">(</span>abs<span class="main">)</span> <span class="free">cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Sabs <span class="free">cs</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>nonvalue<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_value <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Svar
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> nonvalue <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Sabs
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_value.abs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sconst <span class="skolem">name</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all is_value <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Sconst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_sterm_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb is_value.cases abs nonvalue <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Sapp

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_value <span class="free">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> nonvalue <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all is_value <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> C"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Sapp
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">smatch'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> sterm <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> sterm<span class="main">)</span> fmap option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">smatch'</span> <span class="main">(</span>Patvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">smatch'</span> <span class="main">(</span>Patconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> strip_comb <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Sconst <span class="bound">name'</span><span class="main">,</span> <span class="bound">vs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="bound">name'</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> length <span class="bound">vs</span> <span class="keyword1">then</span>
        map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 <span class="free">smatch'</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        None<span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> smatch'_induct <span class="main">=</span> smatch'.induct<span class="main">[</span><span class="operator">case_names</span> var constr<span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> constructors <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> smatch_list_comb_is_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_value <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> strip_comb <span class="free">t</span> <span class="keyword1">of</span>
    <span class="main">(</span>Sconst <span class="bound">name'</span><span class="main">,</span> <span class="bound">vs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">name</span> <span class="main">=</span> <span class="bound">name'</span> <span class="main">∧</span> length <span class="free">ps</span> <span class="main">=</span> length <span class="bound">vs</span> <span class="keyword1">then</span>
        map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 match <span class="free">ps</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        None<span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_list_comb <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> const_sterm_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchs_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> smatch_smatch'_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">pat</span>"</span></span> <span class="quoted"><span class="quoted">"is_value <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> smatch' <span class="main">(</span>mk_pat <span class="free">pat</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_pat_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">name</span> <span class="skolem">args</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_value <span class="skolem">t</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_value.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">cs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_list_comb_const<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">args'</span> <span class="skolem">name'</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map2 match <span class="skolem">args</span> <span class="skolem">args'</span> <span class="main">=</span> map2 smatch' <span class="main">(</span>map mk_pat <span class="skolem">args</span><span class="main">)</span> <span class="skolem">args'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">args</span> <span class="main">=</span> length <span class="skolem">args'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that constr<span class="main">(</span>2<span class="main">)</span> comb<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">args</span></span> <span class="quoted"><span class="skolem">args'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> constr
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smatch_list_comb_is_value strip_list_comb map_option_case strip_list_comb_const
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_value.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> const_sterm_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchs_alt_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Value">
<div class="head">
<h1>Theory Value</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A dedicated value type›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Value
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Term_as_Value.html">Term_as_Value</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"value"</span> <span class="main">=</span>
  <span class="entity">is_Vconstr</span><span class="main">:</span> Vconstr <span class="quoted">name</span> <span class="quoted"><span class="quoted">"value list"</span></span> <span class="main">|</span>
  Vabs <span class="quoted"><span class="quoted">"sclauses"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap"</span></span> <span class="main">|</span>
  Vrecabs <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> sclauses<span class="main">)</span> fmap"</span></span> <span class="quoted">name</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> vrule <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> value"</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.mandatory_path <span class="inner_quoted">"quickcheck"</span>›</span>

<span class="comment1">(* FIXME: make private, prevented by bug in datatype_compat; workaround: mandatory path *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"value"</span> <span class="main">=</span>
  Vconstr <span class="quoted">name</span> <span class="quoted"><span class="quoted">"value list"</span></span> <span class="main">|</span>
  Vabs <span class="quoted"><span class="quoted">"sclauses"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> value<span class="main">)</span> list"</span></span> <span class="main">|</span>
  Vrecabs <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> sclauses<span class="main">)</span> list"</span></span> <span class="quoted">name</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> value<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="quoted">"<span class="entity">Value</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"quickcheck.value <span class="main">⇒</span> value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Value</span> <span class="main">(</span>quickcheck.Vconstr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Vconstr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>map <span class="free">Value</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Value</span> <span class="main">(</span>quickcheck.Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">Value</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Value</span> <span class="main">(</span>quickcheck.Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> Vrecabs <span class="main">(</span>fmap_of_list <span class="free"><span class="bound"><span class="entity">css</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="free">Value</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Sign.parent_path›</span>

<span class="keyword1"><span class="command">quickcheck_generator</span></span> <span class="quoted">"value"</span>
  constructors<span class="main">:</span> <span class="quoted">quickcheck.Value</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vmatch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> value <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vmatch</span> <span class="main">(</span>Patvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vmatch</span> <span class="main">(</span>Patconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name'</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">name'</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">then</span>
    map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 <span class="free">vmatch</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span>
    None<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vmatch</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> vmatch_induct <span class="main">=</span> vmatch.induct<span class="main">[</span><span class="operator">case_names</span> var constr<span class="main">]</span>

<span class="keyword1"><span class="command">locale</span></span> value_pred <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap <span class="main">⇒</span> sclauses <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">∧</span> list_all id <span class="main">(</span>map <span class="free">pred</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">(</span>Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟷</span> pred_fmap id <span class="main">(</span>fmmap <span class="free">pred</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pred</span> <span class="main">(</span>Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟷</span>
    pred_fmap id <span class="main">(</span>fmmap <span class="free">pred</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">∧</span>
    pred_fmap <span class="main">(</span><span class="free">P</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> fmdom <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">∧</span>
    <span class="free">R</span> <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">css</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> pred.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_alt_def<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred <span class="main">(</span>Vconstr <span class="free">name</span> <span class="free">vs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="free">name</span> <span class="main">∧</span> list_all pred <span class="free">vs</span>"</span></span>
  <span class="quoted"><span class="quoted">"pred <span class="main">(</span>Vabs <span class="free">cs</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟷</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pred<span class="main">)</span> <span class="free">Γ</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">Γ</span> <span class="free">cs</span>"</span></span>
  <span class="quoted"><span class="quoted">"pred <span class="main">(</span>Vrecabs <span class="free">css</span> <span class="free">name</span> <span class="free">Γ</span><span class="main">)</span> <span class="main">⟷</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pred<span class="main">)</span> <span class="free">Γ</span> <span class="main">∧</span> pred_fmap <span class="main">(</span><span class="free">P</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">css</span> <span class="main">∧</span> <span class="free">name</span> <span class="main">|∈|</span> fmdom <span class="free">css</span> <span class="main">∧</span> <span class="free">R</span> <span class="main">(</span>fmdom <span class="free">css</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff pred.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For technical reasons, we don't introduce an abbreviation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹fmpred <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> pred<span class="main"><span class="main">)</span></span> <span class="free"><span class="free">env</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  here. This locale is supposed to be interpreted with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> global_interpretation<span class="antiquote"><span class="antiquote">}</span></span></span></span> (or
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> sublocale<span class="antiquote"><span class="antiquote">}</span></span></span></span> and a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory_text</span></span> <span class="raw_text"><span class="raw_text">‹<span class="keyword2"><span class="keyword"><span class="keyword2"><span class="keyword">defines</span></span></span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> clause. However, this does not affect
  abbreviations: the abbreviation would still refer to the locale constant, not the constant
  introduced by the interpretation.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vmatch_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="free">pat</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"pred <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pred<span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vmatch_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ps</span> <span class="skolem">name'</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">envs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty <span class="skolem">envs</span>"</span></span> <span class="quoted"><span class="quoted">"map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span> <span class="main">=</span> map Some <span class="skolem">envs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> those_someD<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pred<span class="main">)</span> <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">∈</span> set <span class="skolem">envs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">env</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">env</span> <span class="main">∈</span> set <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹map2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map2_elemE<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> constr<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">value_to_sterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> sterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">value_to_sterm</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> map <span class="free">value_to_sterm</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">value_to_sterm</span> <span class="main">(</span>Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="main">(</span>fmmap <span class="free">value_to_sterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">value_to_sterm</span> <span class="main">(</span>Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span>
  Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="main">(</span>fmmap <span class="free">value_to_sterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>fmlookup <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This locale establishes a connection between a predicate on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s with the corresponding
  predicate on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s, by means of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> value_to_sterm<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> pre_value_sterm_pred <span class="main">=</span> value_pred <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> value_to_sterm<span class="main">:</span> <span class="quoted"><span class="quoted">"pred <span class="free">v</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>value_to_sterm <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">corollary</span></span> value_to_sterm_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pred<span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="free">Γ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fmpred_map <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="free">Γ</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmpredD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>value_to_sterm <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> value_to_sterm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> value_sterm_pred <span class="main">=</span> value_pred <span class="main">+</span> S<span class="main">:</span> simple_syntactic_and <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">name</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>const <span class="bound">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">cs</span><span class="main">.</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">n</span> <span class="bound">v</span><span class="main">.</span> fmlookup <span class="bound">Γ</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> pred <span class="bound">v</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>value_to_sterm <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> pred<span class="main">)</span> <span class="bound">Γ</span> <span class="main">⟹</span>
    <span class="free">P</span> <span class="bound">Γ</span> <span class="bound">cs</span> <span class="main">⟹</span>
    <span class="free">S</span> <span class="main">(</span>Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmmap value_to_sterm <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="bound">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> pre_value_sterm_pred
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pred <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>value_to_sterm <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Vconstr <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> S.list_comb
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> const<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Vconstr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Vabs <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> abs<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Vabs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmran'I<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Vrecabs <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="skolem">x3</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> abs<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Vrecabs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmlookup_dom_iff fmpred_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmran'I<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> vwellformed<span class="main">:</span>
  value_sterm_pred
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> wellformed_clauses"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted">wellformed</span>
  <span class="keyword2"><span class="keyword">defines</span></span> vwellformed <span class="main">=</span> <span class="quoted">vwellformed.pred</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">pat</span> <span class="skolem">rhs</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_wellformed<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_drop_fset<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmmap value_to_sterm <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">fst</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">wellformed_venv</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwellformed<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> vclosed<span class="main">:</span>
  value_sterm_pred
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Γ</span> <span class="bound">cs</span><span class="main">.</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> closed_except <span class="bound">t</span> <span class="main">(</span>fmdom <span class="bound">Γ</span> <span class="main">|∪|</span> frees <span class="bound">pat</span><span class="main">)</span><span class="main">)</span> <span class="bound">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted">closed</span>
  <span class="keyword2"><span class="keyword">defines</span></span> vclosed <span class="main">=</span> <span class="quoted">vclosed.pred</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff case_prod_twice Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_frees<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_drop_fset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpredI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">closed_venv</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vclosed<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> pre_constants <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vwelldefined<span class="main">:</span>
  value_sterm_pred
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">cs</span><span class="main">.</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">t</span><span class="main">)</span> <span class="bound">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">name</span><span class="main">.</span> <span class="bound">name</span> <span class="main">|∈|</span> C"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">dom</span><span class="main">.</span> <span class="bound">dom</span> <span class="main">|⊆|</span> <span class="free">heads</span>"</span></span>
    <span class="quoted">welldefined</span>
  <span class="keyword2"><span class="keyword">defines</span></span> vwelldefined <span class="main">=</span> <span class="quoted">vwelldefined.pred</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fset_of_list_map<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ffUnion_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fset_of_list_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_twice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_consts<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_drop_fset<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> fmpred_map
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpredI<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> vwelldefined_alt_def <span class="main">=</span> vwelldefined.pred_alt_def

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> pre_constants.vwelldefined_alt_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> constructors <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vconstructor_value<span class="main">:</span>
  pre_value_sterm_pred
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">name</span><span class="main">.</span> <span class="bound">name</span> <span class="main">|∈|</span> C"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted">is_value</span>
  <span class="keyword2"><span class="keyword">defines</span></span> vconstructor_value <span class="main">=</span> <span class="quoted">vconstructor_value.pred</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"value_pred.pred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">name</span><span class="main">.</span> <span class="bound">name</span> <span class="main">|∈|</span> C<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_value <span class="main">(</span>value_to_sterm <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Vconstr <span class="skolem">name</span> <span class="skolem">vs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_value <span class="main">(</span>map value_to_sterm <span class="skolem">vs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff value_pred.pred_alt_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> value_to_sterm.simps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_value.constr<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> Vconstr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_pred.pred_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjnt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_value.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> vconstructor_value_alt_def <span class="main">=</span> vconstructor_value.pred_alt_def

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">vconstructor_value_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vconstructor_value<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vconstructor_value_rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vrule list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vconstructor_value_rs</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟷</span>
  list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> vconstructor_value <span class="bound">rhs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">∧</span>
  fdisjnt <span class="main">(</span>fset_of_list <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">)</span> C"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> constructors.vconstructor_value_alt_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> constructors.vconstructor_value_rs_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> pre_constants <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> not_shadows_vconsts<span class="main">:</span>
  value_sterm_pred
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">cs</span><span class="main">.</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> fdisjnt all_consts <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> shadows_consts <span class="bound">t</span><span class="main">)</span> <span class="bound">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> not_shadows_vconsts <span class="main">=</span> <span class="quoted">not_shadows_vconsts.pred</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff case_prod_twice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_shadows<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_drop_fset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpredI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def app_sterm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> not_shadows_vconsts_alt_def <span class="main">=</span> not_shadows_vconsts.pred_alt_def

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">not_shadows_vconsts_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">s</span><span class="main">.</span> not_shadows_vconsts <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> pre_constants.not_shadows_vconsts_alt_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">term_to_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_value</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> strip_comb <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Sconst <span class="bound">name</span><span class="main">,</span> <span class="bound">args</span><span class="main">)</span> <span class="main">⇒</span> Vconstr <span class="bound">name</span> <span class="main">(</span>map <span class="free">term_to_value</span> <span class="bound">args</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span> Vabs <span class="bound">cs</span> fmempty<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> term_to_value_to_sterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_value <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"value_to_sterm <span class="main">(</span>term_to_value <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">vs</span> <span class="skolem">name</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>value_to_sterm <span class="main">∘</span> term_to_value<span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> map id <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply id_apply<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"value_to_sterm <span class="main">(</span>term_to_value <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> const_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> vmatch_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="free">pat</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="free">env</span> <span class="main">=</span> patvars <span class="free">pat</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vmatch_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ps</span> <span class="skolem">name'</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">envs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty <span class="skolem">envs</span>"</span></span> <span class="quoted"><span class="quoted">"map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span> <span class="main">=</span> map Some <span class="skolem">envs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> those_someD<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fset_of_list <span class="main">(</span>map fmdom <span class="skolem">envs</span><span class="main">)</span> <span class="main">=</span> fset_of_list <span class="main">(</span>map patvars <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">names</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map fmdom <span class="skolem">envs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">∈</span> set <span class="main">(</span>map fmdom <span class="skolem">envs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">∈</span> set <span class="skolem">envs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">=</span> fmdom <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">env</span> <span class="main">∈</span> set <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹map2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map2_elemE<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> patvars <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">∈</span> set <span class="main">(</span>map patvars <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">names</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map patvars <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">names</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map patvars <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">∈</span> set <span class="main">(</span>map patvars <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">=</span> patvars <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">∈</span> set <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map2_elemE1<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">∈</span> set <span class="skolem">envs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> patvars <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">∈</span> set <span class="main">(</span>map fmdom <span class="skolem">envs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">names</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">names</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map fmdom <span class="skolem">envs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmdom_foldl_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vfind_match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sclauses <span class="main">⇒</span> value <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap <span class="main">×</span> term <span class="main">×</span> sterm<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vfind_match</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vfind_match</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> vmatch <span class="main">(</span>mk_pat <span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">env</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="free">vfind_match</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vfind_match_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="free">cs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="free">pat</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">veq_structure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
abs_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">veq_structure</span> <span class="main">(</span>Vabs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Vabs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
recabs_recabs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">veq_structure</span> <span class="main">(</span>Vrecabs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Vrecabs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
constr_constr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">veq_structure</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span> <span class="free">veq_structure</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veq_structure_simps<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"veq_structure <span class="main">(</span>Vabs <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>Vabs <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"veq_structure <span class="main">(</span>Vrecabs <span class="free">css<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>Vrecabs <span class="free">css<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"veq_structure <span class="main">(</span>Vconstr <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>Vconstr <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">us</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> list_all2 veq_structure <span class="free">ts</span> <span class="free">us</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veq_structure.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> veq_structure.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> veq_structure_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"veq_structure <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_refl_strong<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> vno_abs<span class="main">:</span> value_pred <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> vno_abs <span class="main">=</span> <span class="quoted">vno_abs.pred</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veq_structure_eq_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"veq_structure <span class="free">t</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"vno_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> veq_structure.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr_constr <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">us</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all vno_abs <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constr_constr.IH that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> constr_constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> veq_structure_eq_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"veq_structure <span class="free">t</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"vno_abs <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> veq_structure.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr_constr <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">us</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all vno_abs <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> constr_constr.IH that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> constr_constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vmatch'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> value <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vmatch'</span> <span class="main">(</span>Patvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Some <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vmatch'</span> <span class="main">(</span>Patconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">of</span>
    Vconstr <span class="bound">name'</span> <span class="bound">vs</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="bound">name'</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> length <span class="bound">vs</span> <span class="keyword1">then</span>
        map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 <span class="free">vmatch'</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
        None<span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vmatch_vmatch'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"vmatch <span class="free">p</span> <span class="free">v</span> <span class="main">=</span> vmatch' <span class="free">p</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vmatch.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">name</span> <span class="skolem">ps</span> <span class="skolem">name'</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_option_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">those</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map2_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> value_struct_rel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q_impl_struct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> veq_structure <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Q_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>Vconstr <span class="free">name</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>Vconstr <span class="free">name'</span> <span class="free">us</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">name</span> <span class="main">=</span> <span class="free">name'</span> <span class="main">∧</span> list_all2 <span class="free">Q</span> <span class="free">ts</span> <span class="free">us</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> vno_abs <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Q_impl_struct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> veq_structure_eq_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> vno_abs <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Q_impl_struct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> veq_structure_eq_right<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> vmatch'_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>vmatch' <span class="free">p</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>vmatch' <span class="free">p</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Patconstr <span class="skolem">name</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Q_impl_struct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"veq_structure <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> veq_structure.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr_constr <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">name'</span><span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">ts</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 veq_structure <span class="skolem">ts</span> <span class="skolem">us</span>›</span></span> Patconstr <span class="quoted"><span class="quoted">‹length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">ts</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span> <span class="skolem">u</span> <span class="skolem">us</span> <span class="skolem">ps0</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps0</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps0</span></span><span class="main">)</span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> length <span class="skolem">us</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>

            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Q</span> <span class="main">(</span>Vconstr <span class="skolem">name'</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Vconstr <span class="skolem">name'</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>vmatch' <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>vmatch' <span class="skolem">p</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Q</span> <span class="main">(</span>Vconstr <span class="skolem">name'</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Vconstr <span class="skolem">name'</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ts</span> <span class="main">=</span> length <span class="skolem">us</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ps0</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ps0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>list_all2 <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rel_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> those_transfer<span class="main"><span class="main">]</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span>
            <span class="main">(</span>map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch' <span class="skolem">ps</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> option.map_transfer<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer_prover</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ts</span> <span class="main">=</span> length <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr_constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vmatch_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>vmatch <span class="free">p</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>vmatch <span class="free">p</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> vmatch_vmatch'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vmatch'_rel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vfind_match_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">R</span><span class="main">)</span> <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="free">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="free">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>fmrel <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_rel<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> vfind_match_rel' <span class="main">=</span>
  vfind_match_rel<span class="main">[</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> cs<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> cs<span class="hidden">⇩</span><sub>2</sub> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">cs</span><span class="main">,</span>
    <span class="operator">unfolded</span> prod.rel_eq<span class="main">,</span>
    <span class="operator">OF</span> list.rel_refl<span class="main">,</span> <span class="operator">OF</span> refl<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_fact</span></span> vmatch_vmatch'_eq
<span class="keyword1"><span class="command">hide_const</span></span> vmatch'

<span class="keyword1"><span class="command">global_interpretation</span></span> veq_structure<span class="main">:</span> value_struct_rel <span class="quoted">veq_structure</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">env_eq</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">env_eq</span> <span class="main">≡</span> fmrel <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> value_to_sterm <span class="bound">v</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> env_eq_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"env_eq <span class="free">venv</span> <span class="free">senv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">senv</span> <span class="main">=</span> fmmap value_to_sterm <span class="free">venv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> fmlookup_map<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> value_to_sterm <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">venv</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">senv</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="free">senv</span> <span class="skolem">name</span> <span class="main">=</span> map_option value_to_sterm <span class="main">(</span>fmlookup <span class="free">venv</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> constructors <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> vmatch_eq0<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_option env_eq <span class="main">(</span>vmatch <span class="free">p</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>smatch' <span class="free">p</span> <span class="main">(</span>value_to_sterm <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vmatch_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ps</span> <span class="skolem">name'</span> <span class="skolem">vs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"rel_option env_eq
      <span class="main">(</span>map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 smatch' <span class="skolem">ps</span> <span class="main">(</span>map value_to_sterm <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_eq <span class="skolem">Γ</span> <span class="skolem">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">Γ</span> <span class="skolem">Γ'</span>
    <span class="keyword1"><span class="command">using</span></span> that constr
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">Γ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option env_eq <span class="main">(</span>vmatch <span class="skolem">p</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>smatch' <span class="skolem">p</span> <span class="main">(</span>value_to_sterm <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.map_comp comp_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_list_comb_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> const_sterm_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> vmatch_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option env_eq <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="free">p</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>match <span class="free">p</span> <span class="main">(</span>value_to_sterm <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> smatch_smatch'_eq vmatch_eq0 vconstructor_value.value_to_sterm<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">match_related</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">match_related</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">rhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="bound">pat<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> env_eq <span class="bound">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> find_match_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>linear <span class="main">∘</span> fst<span class="main">)</span> <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option match_related <span class="main">(</span>vfind_match <span class="free">cs</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>find_match <span class="free">cs</span> <span class="main">(</span>value_to_sterm <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option env_eq <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="skolem">p</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>match <span class="skolem">p</span> <span class="main">(</span>value_to_sterm <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vmatch_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">erelated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">erelated</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span> Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>e</sub></span></span> Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span> <span class="main">|</span>
abs<span class="main">:</span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free">erelated</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>e</sub></span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
rec_abs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> <span class="free">erelated</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">⟹</span>
     Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>e</sub></span></span> Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">erelated</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> erelated<span class="main">:</span> value_struct_rel <span class="quoted">erelated</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"veq_structure <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list.rel_mono_strong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">name'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ts</span> <span class="skolem">us</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Vconstr <span class="skolem">name</span> <span class="skolem">ts</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> Vconstr <span class="skolem">name'</span> <span class="skolem">us</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span> <span class="main">∧</span> list_all2 erelated <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> erelated.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> erelated.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> erelated_refl<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Vrecabs
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> erelated.intros fmpredI fmrel_on_fset_refl_strong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmran'I<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> erelated.intros list.rel_refl_strong fmrel_on_fset_refl_strong fmran'I<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">value_to_sterm</span></span> <span class="quoted"><span class="quoted">vmatch</span></span> <span class="quoted"><span class="quoted">vwellformed</span></span> <span class="quoted"><span class="quoted">vclosed</span></span> <span class="quoted"><span class="quoted">erelated_i_i</span></span> <span class="quoted"><span class="quoted">pre_constants.vwelldefined</span></span>
  <span class="quoted"><span class="quoted">constructors.vconstructor_value_rs</span></span> <span class="quoted"><span class="quoted">pre_constants.not_shadows_vconsts</span></span> <span class="quoted"><span class="quoted">term_to_value</span></span>
  <span class="quoted"><span class="quoted">vfind_match</span></span> <span class="quoted"><span class="quoted">veq_structure</span></span> <span class="quoted"><span class="quoted">vno_abs</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Doc_CupCake">
<div class="head">
<h1>Theory Doc_CupCake</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹A smaller version of CakeML: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CupCakeML›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Doc_CupCake
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CupCake_Env">
<div class="head">
<h1>Theory CupCake_Env</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹CupCake environments›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CupCake_Env
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="CakeML_Utils.html">../Utils/CakeML_Utils</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cake_no_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_no_abs</span> <span class="main">(</span>Conv <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">cake_no_abs</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cake_no_abs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_cupcake_pat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Ast.pat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_pat</span> <span class="main">(</span>Ast.Pvar <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_pat</span> <span class="main">(</span>Ast.Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">is_cupcake_pat</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_pat</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_cupcake_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_exp</span> <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_exp</span> <span class="main">(</span>Ast.App <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">oper</span></span></span> <span class="main">=</span> Ast.Opapp <span class="main">∧</span> list_all <span class="free">is_cupcake_exp</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_exp</span> <span class="main">(</span>Ast.Con <span class="main">(</span>Some <span class="main">(</span>Short <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">is_cupcake_exp</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_exp</span> <span class="main">(</span>Ast.Fun <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">is_cupcake_exp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_exp</span> <span class="main">(</span>Ast.Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">is_cupcake_exp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> is_cupcake_pat <span class="bound">p</span> <span class="main">∧</span> <span class="free">is_cupcake_exp</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> cake_linear_clauses <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_exp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cupcake_clauses</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Ast.pat <span class="main">×</span> exp<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_clauses</span> <span class="main">≡</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> is_cupcake_pat <span class="bound">p</span> <span class="main">∧</span> is_cupcake_exp <span class="bound">e</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cupcake_c_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"c_ns <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_c_ns</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">mods</span></span></span><span class="main">)</span> <span class="main">⟷</span>
  <span class="free"><span class="bound"><span class="entity">mods</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">tid</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">tid</span> <span class="keyword1">of</span> TypeId <span class="main">(</span>Short <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> cakeml_static_env <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">static_cenv</span> <span class="main">::</span> <span class="quoted">c_ns</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> static_cenv<span class="main">:</span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="free">static_cenv</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_sem_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_sem_env</span> <span class="main">=</span> <span class="main">⦇</span> sem_env.v <span class="main">=</span> nsEmpty<span class="main">,</span> sem_env.c <span class="main">=</span> <span class="free">static_cenv</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> v_of_empty_sem_env<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sem_env.v empty_sem_env <span class="main">=</span> nsEmpty"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> empty_sem_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> c_of_empty_sem_env<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c empty_sem_env <span class="main">=</span> <span class="free">static_cenv</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> empty_sem_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_cupcake_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"SemanticPrimitives.v <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="entity">is_cupcake_all_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"all_env <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_value</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> TypeId <span class="main">(</span>Short <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">is_cupcake_value</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_value</span> <span class="main">(</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟷</span> is_cupcake_exp <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="free">is_cupcake_all_env</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_value</span> <span class="main">(</span>Recclosure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> is_cupcake_exp <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">∧</span> <span class="free">is_cupcake_all_env</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_value</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_all_env</span> <span class="main">⦇</span> sem_env.v <span class="main">=</span> Bind <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[]</span><span class="main">,</span> sem_env.c <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">⦈</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">c0</span></span></span> <span class="main">=</span> <span class="free">static_cenv</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="free">is_cupcake_value</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_all_env</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_cupcake_all_envE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">=</span> <span class="main">⦇</span> sem_env.v <span class="main">=</span> Bind <span class="free">v</span> <span class="main">[]</span><span class="main">,</span> sem_env.c <span class="main">=</span> <span class="free">c</span> <span class="main">⦈</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">static_cenv</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_cupcake_all_env.elims<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_cupcake_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v_ns <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_ns</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_cupcake_ns</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_cupcake_nsE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> Bind <span class="free">v</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_ns.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_cupcake_all_envD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="main">(</span>c <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms static_cenv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_cupcake_all_envE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_cupcake_all_envI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sem_env.c <span class="free">env</span> <span class="main">=</span> <span class="free">static_cenv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms static_cenv
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">env</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> v c
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x1 x2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CupCake_Semantics">
<div class="head">
<h1>Theory CupCake_Semantics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹CupCake semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CupCake_Semantics
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CupCake_Env.html">CupCake_Env</a>
  <a href="../CakeML/Matching.html">CakeML.Matching</a>
  <a href="../CakeML/Big_Step_Unclocked_Single.html">CakeML.Big_Step_Unclocked_Single</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cupcake_nsLookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">,</span><span class="tfree">'v</span><span class="main">)</span>namespace <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'v</span> option "</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_nsLookup</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> map_of <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_nsLookup_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nsLookup <span class="free">ns</span> <span class="main">(</span>Short <span class="free">n</span><span class="main">)</span> <span class="main">=</span> cupcake_nsLookup <span class="free">ns</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cupcake_pmatch</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>string<span class="main">)</span><span class="main">,</span><span class="main">(</span>nat<span class="main">*</span>tid_or_exn<span class="main">)</span><span class="main">)</span>namespace <span class="main">⇒</span> pat <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list <span class="main">⇒</span><span class="main">(</span><span class="main">(</span>string<span class="main">*</span>v<span class="main">)</span>list<span class="main">)</span>match_result "</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_pmatch</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> Match <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span><span class="main">)</span><span class="main">#</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_pmatch</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="main">(</span>Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cupcake_nsLookup <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
      Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">=&gt;</span>
        <span class="keyword1">if</span> same_tid <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">∧</span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="bound">l</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="keyword1">if</span> same_ctor <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
            Matching.fold2 <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
               Match <span class="bound">env</span> <span class="main">⇒</span> <span class="free">cupcake_pmatch</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span>
            <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">(</span>Match <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span>
            No_match
        <span class="keyword1">else</span>
          Match_type_error
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">=&gt;</span> Match_type_error<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_pmatch</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Match_type_error"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cupcake_match_result</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> v <span class="main">⇒</span><span class="main">(</span>pat<span class="main">*</span>exp<span class="main">)</span>list <span class="main">⇒</span> v <span class="main">⇒</span> <span class="main">(</span>exp <span class="main">×</span> pat <span class="main">×</span> <span class="main">(</span>char list <span class="main">×</span> v<span class="main">)</span> list<span class="main">,</span> v<span class="main">)</span>result"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_match_result</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">=</span> Rerr <span class="main">(</span>Rraise <span class="free"><span class="bound"><span class="entity">err_v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">cupcake_match_result</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> distinct <span class="main">(</span>pat_bindings <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> cupcake_pmatch <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">[]</span> <span class="keyword1">of</span>
      Match <span class="bound">env'</span> <span class="main">⇒</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span> <span class="main">|</span>
      No_match <span class="main">⇒</span> <span class="free">cupcake_match_result</span> <span class="free"><span class="bound"><span class="entity">cenv</span></span></span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> <span class="free"><span class="bound"><span class="entity">err_v</span></span></span> <span class="main">|</span>
      Match_type_error <span class="main">⇒</span> Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span>
      Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_match_resultE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="free">cenv</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">env'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">init</span> <span class="free">rest</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pes</span> <span class="main">=</span> <span class="free">init</span> <span class="main">@</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>pat_bindings <span class="free">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="free">v0</span> <span class="main">[]</span> <span class="main">=</span> No_match <span class="main">∧</span> distinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free">init</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_pmatch <span class="free">cenv</span> <span class="free">p</span> <span class="free">v0</span> <span class="main">[]</span> <span class="main">=</span> Match <span class="free">env'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">pe</span> <span class="skolem">pes</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p0</span></span> <span class="skolem"><span class="skolem">e0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pe</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p0</span><span class="main">,</span> <span class="skolem">e0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>pat_bindings <span class="skolem">p0</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cupcake_pmatch <span class="free">cenv</span> <span class="skolem">p0</span> <span class="free">v0</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> No_match
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">init</span> <span class="skolem">rest</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pes</span> <span class="main">=</span> <span class="skolem">init</span> <span class="main">@</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rest</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="free">v0</span> <span class="main">[]</span> <span class="main">=</span> No_match <span class="main">∧</span> distinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">init</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>pat_bindings <span class="free">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cupcake_pmatch <span class="free">cenv</span> <span class="free">p</span> <span class="free">v0</span> <span class="main">[]</span> <span class="main">=</span> Match <span class="free">env'</span>"</span></span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pe</span> <span class="main">#</span> <span class="skolem">pes</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p0</span><span class="main">,</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">init</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rest</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pes</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="free">v0</span> <span class="main">[]</span> <span class="main">=</span> No_match <span class="main">∧</span> distinct <span class="main">(</span>pat_bindings <span class="bound">p</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p0</span><span class="main">,</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">init</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>pat_bindings <span class="free">p</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
                <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="free">cenv</span> <span class="free">v0</span> <span class="skolem">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">env'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Cons No_match True <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Match
          <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Match_type_error
          <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pe</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_pmatch_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_cupcake_pat <span class="free">pat</span> <span class="main">⟹</span> pmatch_single <span class="free">envC</span> <span class="free">s</span> <span class="free">pat</span> <span class="free">v0</span> <span class="free">env</span> <span class="main">=</span> cupcake_pmatch <span class="free">envC</span> <span class="free">pat</span> <span class="free">v0</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pmatch_single.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">from</span></span> is_cupcake_pat.elims<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 4<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits match_result.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Matching.fold2_cong<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> match_result.splits<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_decomp_last list.pred_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list_all_append<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_match_result_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cupcake_clauses <span class="free">pes</span> <span class="main">⟹</span>
    match_result <span class="free">env</span> <span class="free">s</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span>
      map_result <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>cupcake_match_result <span class="main">(</span>c <span class="free">env</span><span class="main">)</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> match_result.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cupcake_pmatch_eq pmatch_single_equiv<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> cakeml_static_env <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_nsBind_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="free">ns</span> <span class="main">⟹</span> is_cupcake_value <span class="free">v0</span> <span class="main">⟹</span> is_cupcake_ns <span class="main">(</span>nsBind <span class="free">k</span> <span class="free">v0</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_cupcake_ns.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_build_rec_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">cl_env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> is_cupcake_exp <span class="bound">e</span><span class="main">)</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>build_rec_env <span class="free">fs</span> <span class="free">cl_env</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="bound">env'</span><span class="main">.</span> nsBind <span class="bound">f</span> <span class="main">(</span>Recclosure <span class="free">cl_env</span> <span class="skolem">fs0</span> <span class="bound">f</span><span class="main">)</span> <span class="bound">env'</span><span class="main">)</span> <span class="free">fs</span> <span class="free">env</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> is_cupcake_exp <span class="bound">e</span><span class="main">)</span> <span class="skolem">fs0</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">fs0</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_ns <span class="free">env</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">fs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsBind_preserve<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> build_rec_env_def
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_case_prod_eta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_v_update_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span><span class="free">f</span> <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="main">(</span>sem_env.update_v <span class="free">f</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_cupcake_all_env.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> is_cupcake_all_envE is_cupcake_nsE sem_env.collapse sem_env.record_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sem_env.record_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sem_env.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_nsAppend_preserve<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="free">ns1</span> <span class="main">⟹</span> is_cupcake_ns <span class="free">ns2</span> <span class="main">⟹</span> is_cupcake_ns <span class="main">(</span>nsAppend <span class="free">ns1</span> <span class="free">ns2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_cupcake_ns.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_alist_to_ns_preserve<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env</span> <span class="main">⟹</span> is_cupcake_ns <span class="main">(</span>alist_to_ns <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> alist_to_ns_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_opapp_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"do_opapp <span class="free">vs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cl</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> do_opapp.cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">cl</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">v0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span> <span class="main">∧</span> is_cupcake_exp <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹do_opapp <span class="free">vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> do_opapp_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>closure <span class="skolem">env'</span> <span class="skolem">n</span> <span class="skolem">arg</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_value <span class="skolem">cl</span>›</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_value <span class="skolem">v0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">]</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cupcake_v_update_preserve cupcake_nsBind_preserve <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>is_cupcake_all_envD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>recclosure <span class="skolem">env'</span> <span class="skolem">funs</span> <span class="skolem">name</span> <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_value <span class="skolem">cl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">n</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">funs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> recclosure <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_value <span class="skolem">cl</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">]</span>›</span></span> recclosure
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_all_env <span class="skolem">env'</span>›</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_value <span class="skolem">cl</span>›</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_value <span class="skolem">v0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">cl</span><span class="main">,</span> <span class="skolem">v0</span><span class="main">]</span>›</span></span> recclosure
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> cupcake_build_rec_preserve cupcake_nsBind_preserve cupcake_v_update_preserve is_cupcake_all_envD<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cup_pmatch_list_length_neq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">≠</span> length <span class="free">ps</span> <span class="main">⟹</span> Matching.fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span>
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> <span class="free">m</span> <span class="main">=</span> Match_type_error"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>List.list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cup_pmatch_list_nomatch<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> length <span class="free">ps</span> <span class="main">⟹</span>  Matching.fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span>
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> No_match <span class="main">=</span> No_match"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>List.list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cup_pmatch_list_typerr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> length <span class="free">ps</span> <span class="main">⟹</span> Matching.fold2<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
       Match <span class="bound">env</span> <span class="main">⇒</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span>
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span> Match_type_error <span class="free">ps</span> <span class="free">vs</span> Match_type_error <span class="main">=</span> Match_type_error"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span>  <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>List.list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_pmatch_list_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">⟶</span> list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">env</span> <span class="main">⟶</span> if_match <span class="main">(</span>list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span><span class="main">)</span> <span class="main">(</span>cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"if_match <span class="main">(</span>list_all <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> is_cupcake_value <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Matching.fold2
            <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span>
               Match <span class="bound">env</span> <span class="main">⇒</span> cupcake_pmatch <span class="free">cenv</span> <span class="bound">p</span> <span class="bound">v</span> <span class="bound">env</span>
            <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span>
            Match_type_error <span class="free">ps</span> <span class="free">vs</span> <span class="main">(</span>Match <span class="free">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cupcake_pmatch <span class="free">cenv</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="skolem">env</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> No_match
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>cup_pmatch_list_nomatch cup_pmatch_list_length_neq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Match_type_error
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>cup_pmatch_list_typerr cup_pmatch_list_length_neq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Match <span class="skolem">env'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> env'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">env'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 4 Match <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_pmatch_preserve0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_cupcake_pat <span class="free">pat</span> <span class="main">⟹</span>
    is_cupcake_value <span class="free">v0</span> <span class="main">⟹</span>
     list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env</span> <span class="main">⟹</span>
      cupcake_c_ns <span class="free">envC</span> <span class="main">⟹</span>
       if_match <span class="main">(</span>list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span><span class="main">)</span> <span class="main">(</span>cupcake_pmatch <span class="free">envC</span> <span class="free">pat</span> <span class="free">v0</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cupcake_pmatch.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">cenv</span> <span class="skolem">n</span> <span class="skolem">ps</span> <span class="skolem">n'</span> <span class="skolem">t'</span> <span class="skolem">vs</span> <span class="skolem">env</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span> <span class="main">⟹</span> is_cupcake_pat <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set is_cupcake_pat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span> <span class="main">⟹</span> is_cupcake_value <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set is_cupcake_value.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> v.distinct<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> v.distinct<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> v.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cupcake_pmatch_list_preserve <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> 2 p v<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_cupcake_pat.elims is_cupcake_value.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_pmatch_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_cupcake_pat <span class="free">pat</span> <span class="main">⟹</span>
    is_cupcake_value <span class="free">v0</span> <span class="main">⟹</span>
     list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env</span> <span class="main">⟹</span>
      cupcake_c_ns <span class="free">envC</span> <span class="main">⟹</span>
       cupcake_pmatch <span class="free">envC</span> <span class="free">pat</span> <span class="free">v0</span> <span class="free">env</span> <span class="main">=</span> Match <span class="free">env'</span> <span class="main">⟹</span>
        list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> if_match.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cupcake_pmatch_preserve0<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_match_result_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="free">envC</span> <span class="main">⟹</span>
    cupcake_clauses <span class="free">pes</span> <span class="main">⟹</span>
      is_cupcake_value <span class="free">v</span> <span class="main">⟹</span>
        if_rval <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">env'</span><span class="main">)</span><span class="main">.</span> is_cupcake_pat <span class="bound">p</span> <span class="main">∧</span> is_cupcake_exp <span class="bound">e</span> <span class="main">∧</span> list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">env'</span><span class="main">)</span>
          <span class="main">(</span>cupcake_match_result <span class="free">envC</span> <span class="free">v</span> <span class="free">pes</span> <span class="free">err_v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pes</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> match_result.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_pmatch_preserve<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> static_cenv_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_nsLookup <span class="free">static_cenv</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">len</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">name</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> TypeId <span class="main">(</span>Short <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms static_cenv
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">static_cenv</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits tid_or_exn.splits id0.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ballE allE<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> static_cenv
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits tid_or_exn.splits id0.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ballE allE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_build_conv_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"build_conv <span class="free">static_cenv</span> <span class="main">(</span>Some <span class="main">(</span>Short <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">vs</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> build_conv.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> static_cenv_lookup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_nsLookup_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="free">ns</span>"</span></span> <span class="quoted"><span class="quoted">"nsLookup <span class="free">ns</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">v0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">v0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> Bind <span class="skolem">vs</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_cupcake_ns.elims<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Short <span class="skolem">id</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">id</span><span class="main">,</span> <span class="free">v0</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ns</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">vs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Long
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nsLookup <span class="free">ns</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ns</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> match_all_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="free">cenv</span> <span class="free">v0</span> <span class="free">pes</span> <span class="free">err_v</span> <span class="main">=</span> Rval <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">env'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="free">cenv</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">v0</span>"</span></span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="free">pes</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env'</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_pat <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">init</span></span> <span class="skolem"><span class="skolem">rest</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pes</span> <span class="main">=</span> <span class="skolem">init</span> <span class="main">@</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">rest</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_pmatch <span class="free">cenv</span> <span class="free">p</span> <span class="free">v0</span> <span class="main">[]</span> <span class="main">=</span> Match <span class="free">env'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> cupcake_match_resultE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">pes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_pat <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="free">env'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_pmatch_preserve<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_all2_shortcircuit</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">list_all2_shortcircuit</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Rval <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">list_all2_shortcircuit</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">|</span> Rerr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">list_all2_shortcircuit</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">list_all2_shortcircuit</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_shortcircuit_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> nil cons_val cons_err<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span>Rval <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> list_all2_shortcircuit <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>Rval <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span>Rerr <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span>Rerr <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_shortcircuit.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_shortcircuit_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="free">R</span> <span class="main">≤</span> list_all2_shortcircuit <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="free">R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="free">Q</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_shortcircuit_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_shortcircuit_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⟹</span> list_all2_shortcircuit <span class="free">Q</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_shortcircuit_mono predicate2I rev_predicate2D<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_shortcircuit_rval<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="free">P</span> <span class="free">xs</span> <span class="main">(</span>map Rval <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span>Rval <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"map Rval <span class="free">ys</span><span class="main">::</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> result list"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_shortcircuit_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">cupcake_evaluate_single</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"all_env <span class="main">⇒</span> exp <span class="main">⇒</span> <span class="main">(</span>v<span class="main">,</span> v<span class="main">)</span> result <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
con1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   list_all2_shortcircuit <span class="main">(</span><span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟹</span>
   sequence_result <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span>
   build_conv <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v0</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
con2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
con3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"do_con_check <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">(</span>List.length <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   list_all2_shortcircuit <span class="main">(</span><span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟹</span>
   sequence_result <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Con <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
var1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nsLookup <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="main">⟹</span> <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v0</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
var2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nsLookup <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
fn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>Rval <span class="main">(</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
app1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span><span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟹</span>
   sequence_result <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span>
   do_opapp <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>App Opapp <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span>"</span></span> <span class="main">|</span>
app3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span><span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟹</span>
   sequence_result <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Rval <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span>
   do_opapp <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>App Opapp <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="main">(</span>Rabort Rtype_error<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
app6<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span><span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟹</span>
   sequence_result <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">op0</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
mat1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v0</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   cupcake_match_result <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(|</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="free"><span class="bound"><span class="entity">env'</span></span></span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="main">|)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bv</span></span></span>"</span></span> <span class="main">|</span>
mat1error<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Rval <span class="free"><span class="bound"><span class="entity">v0</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   cupcake_match_result <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v0</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span> Bindv <span class="main">=</span> Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
mat2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">cupcake_evaluate_single</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">pes</span></span></span><span class="main">)</span> <span class="main">(</span>Rerr <span class="free"><span class="bound"><span class="entity">err</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> cakeml_static_env <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_list_preserve0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_shortcircuit
     <span class="main">(</span><span class="main">λ</span><span class="bound">e</span> <span class="bound">r</span><span class="main">.</span> cupcake_evaluate_single <span class="free">env</span> <span class="bound">e</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span>is_cupcake_all_env <span class="free">env</span> <span class="main">⟶</span> is_cupcake_exp <span class="bound">e</span> <span class="main">⟶</span> if_rval is_cupcake_value <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">es</span> <span class="free">rs</span> <span class="main">⟹</span>
  is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> list_all is_cupcake_exp <span class="free">es</span> <span class="main">⟹</span> sequence_result <span class="free">rs</span> <span class="main">=</span> Rval <span class="free">vs</span> <span class="main">⟹</span> list_all is_cupcake_value <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_all2_shortcircuit_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons_val _ _ _ <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_single_preserve0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="free">res</span> <span class="main">⟹</span> is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> is_cupcake_exp <span class="free">e</span> <span class="main">⟹</span> if_rval is_cupcake_value <span class="free">res</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cupcake_evaluate_single.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con1 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">vs</span> <span class="skolem">v0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tid</span></span> <span class="keyword2"><span class="keyword">where</span></span> cn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cn</span> <span class="main">=</span> Some <span class="main">(</span>Short <span class="skolem">tid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"c <span class="skolem">env</span> <span class="main">=</span> <span class="free">static_cenv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_preserve0 con1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>is_cupcake_all_envE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_build_conv_preserve con1 cn
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 cupcake_list_preserve0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 cupcake_opapp_preserve <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">v0</span> <span class="skolem">pes</span> <span class="skolem">e'</span> <span class="skolem">uu</span> <span class="skolem">env'</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">pes</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">v0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_preserve<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> envC <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"c <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pes <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">pes</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">,</span> <span class="operator">unfolded</span> mat1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="main">(</span>update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_v_update_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsAppend_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_alist_to_ns_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_all_envD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 e' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cupcake_nsLookup_preserve <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_single_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="main">(</span>Rval <span class="free">res</span><span class="main">)</span> <span class="main">⟹</span> is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> is_cupcake_exp <span class="free">e</span> <span class="main">⟹</span> is_cupcake_value <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_single_preserve0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_list_preserve<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="free">es</span> <span class="free">rs</span> <span class="main">⟹</span>
  is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> list_all is_cupcake_exp <span class="free">es</span> <span class="main">⟹</span> sequence_result <span class="free">rs</span> <span class="main">=</span> Rval <span class="free">vs</span> <span class="main">⟹</span> list_all is_cupcake_value <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_all2_shortcircuit_induct<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_single_preserve<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_list_correct_rval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit
     <span class="main">(</span><span class="main">λ</span><span class="bound">e</span> <span class="bound">r</span><span class="main">.</span>
         cupcake_evaluate_single <span class="free">env</span> <span class="bound">e</span> <span class="bound">r</span> <span class="main">∧</span>
         <span class="main">(</span>is_cupcake_all_env <span class="free">env</span> <span class="main">⟶</span> is_cupcake_exp <span class="bound">e</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate <span class="free">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="free">es</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="free">es</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="free">rs</span> <span class="main">=</span> Rval <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>Rval <span class="free">vs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_all2_shortcircuit_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons_val <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">ys</span> <span class="main">=</span> Rval <span class="skolem">vs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"Rval <span class="skolem">vs</span> <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">from</span></span> e <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rval <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> e ys <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">es</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> Rval <span class="skolem">vs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> evaluate_list.cons1<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_list.intros<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_list_correct_rerr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit
     <span class="main">(</span><span class="main">λ</span><span class="bound">e</span> <span class="bound">r</span><span class="main">.</span>
         cupcake_evaluate_single <span class="free">env</span> <span class="bound">e</span> <span class="bound">r</span> <span class="main">∧</span>
         <span class="main">(</span>is_cupcake_all_env <span class="free">env</span> <span class="main">⟶</span> is_cupcake_exp <span class="bound">e</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate <span class="free">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="free">es</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="free">es</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="free">rs</span> <span class="main">=</span> Rerr <span class="free">err</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>Rerr <span class="free">err</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">err</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_all2_shortcircuit_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons_val <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> err<span class="main">:</span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">ys</span> <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cons_val
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">ys</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_result.map_id<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cons3 cons_val
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate_list.intros<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_list_correct0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit
     <span class="main">(</span><span class="main">λ</span><span class="bound">e</span> <span class="bound">r</span><span class="main">.</span>
         cupcake_evaluate_single <span class="free">env</span> <span class="bound">e</span> <span class="bound">r</span> <span class="main">∧</span>
         <span class="main">(</span>is_cupcake_all_env <span class="free">env</span> <span class="main">⟶</span> is_cupcake_exp <span class="bound">e</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate <span class="free">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="free">es</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>sequence_result <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sequence_result <span class="free">rs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cupcake_list_correct_rval cupcake_list_correct_rerr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_single_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="free">res</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> Big_Step_Unclocked_Single.evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cupcake_evaluate_single.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con1 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">vs</span> <span class="skolem">v0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_correct_rval evaluate.con1 con1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con3 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">err</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_correct_rerr con3 evaluate.con3
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 cupcake_list_preserve list_all2_shortcircuit_weaken
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> list_all_rev<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 cupcake_opapp_preserve <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_correct_rval es app1 evaluate.app1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app3 <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_correct_rval evaluate.app3 app3
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app6 <span class="skolem">env</span> <span class="skolem">es</span> <span class="skolem">rs</span> <span class="skolem">err</span> <span class="skolem">op0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_correct_rerr app6 evaluate.app6
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">v0</span> <span class="skolem">pes</span> <span class="skolem">e'</span> <span class="skolem">uu</span> <span class="skolem">env'</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pes<span class="main">:</span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">pes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">v0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD cupcake_single_preserve<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">env'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_preserve<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> envC <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"c <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pes <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">pes</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">,</span> <span class="operator">unfolded</span> mat1<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">have</span></span> env'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="main">(</span>update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_v_update_preserve<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsAppend_preserve<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_alist_to_ns_preserve<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_all_envD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">from</span></span> e <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rval <span class="skolem">v0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match_result <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">v0</span> <span class="skolem">pes</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">e'</span><span class="main">,</span> <span class="skolem">env'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 cupcake_match_result_eq<span class="main">[</span><span class="operator">OF</span> pes<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> e' env' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="main">(</span>update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">e'</span> <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="skolem">bv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1error <span class="skolem">env</span> <span class="skolem">e</span> <span class="skolem">v0</span> <span class="skolem">pes</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pes<span class="main">:</span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">pes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Big_Step_Unclocked_Single.evaluate <span class="skolem">env</span> <span class="skolem">s</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> Rval <span class="skolem">v0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1error <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"match_result <span class="skolem">env</span> <span class="skolem">s'</span> <span class="skolem">v0</span> <span class="skolem">pes</span> Bindv <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_eq<span class="main">[</span><span class="operator">OF</span> pes<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mat1error
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> error_result.map_id<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> evaluate.mat1b<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat2 _ <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mat2 evaluate.mat2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>evaluate.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_list_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="free">es</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">::</span><span class="tfree">'a</span> state<span class="main">)</span> <span class="free">es</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span>sequence_result <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cupcake_list_correct0 list_all2_shortcircuit_weaken cupcake_single_correct<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_list_complete0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list
     <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">e</span> <span class="bound">r</span><span class="main">.</span> evaluate <span class="free">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span>is_cupcake_all_env <span class="free">env</span> <span class="main">⟶</span> is_cupcake_exp <span class="bound">e</span> <span class="main">⟶</span> cupcake_evaluate_single <span class="free">env</span> <span class="bound">e</span> <span class="main">(</span>snd <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s1</span> <span class="free">es</span> <span class="free">res</span> <span class="main">⟹</span>
    is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> list_all is_cupcake_exp <span class="free">es</span>  <span class="main">⟹</span>  <span class="main">∃</span><span class="bound">rs</span><span class="main">.</span> list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="free">es</span> <span class="bound">rs</span> <span class="main">∧</span> sequence_result <span class="bound">rs</span> <span class="main">=</span> <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons1 <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">s2</span> <span class="skolem">v</span> <span class="skolem">es</span> <span class="skolem">s3</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="skolem">es</span> <span class="skolem">rs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rval <span class="skolem">vs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span>Rval <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons2 <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">s2</span> <span class="skolem">err</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">[</span>Rerr <span class="skolem">err</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons3 <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">s2</span> <span class="skolem">v</span> <span class="skolem">es</span> <span class="skolem">s3</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="skolem">es</span> <span class="skolem">rs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> err<span class="main">:</span><span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">#</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span>Rval <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="main">(</span>Rval <span class="skolem">v</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> error_result.map_id err<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_single_complete0<span class="main">:</span>
<span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">res</span> <span class="main">⟹</span> is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> is_cupcake_exp <span class="free">e</span> <span class="main">⟹</span> cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con1 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">v</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="main">(</span>map Rval <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_complete0 con1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">|</span></span><span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con3 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_list_complete0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">rule</span> cupcake_evaluate_single.con3<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">es</span> <span class="skolem">s2</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rval <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_list_complete0<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_preserve app1 rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 cupcake_opapp_preserve <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env'</span> <span class="skolem">e</span> <span class="main">(</span>snd <span class="skolem">bv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app3 <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">es</span> <span class="skolem">s2</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">" list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rval <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app3 cupcake_list_complete0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">|</span></span><span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app6 <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">es</span> <span class="skolem">s2</span> <span class="skolem">err</span> <span class="skolem">op0</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">" list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_complete0 app6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span><span class="main"><span class="keyword3">|</span></span><span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">e'</span> <span class="skolem">env'</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pes<span class="main">:</span><span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">pes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD cupcake_single_preserve<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uu</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">pes</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">e'</span><span class="main">,</span> <span class="skolem">uu</span><span class="main">,</span> <span class="skolem">env'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_eq<span class="main">[</span><span class="operator">OF</span> pes<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">,</span> <span class="operator">unfolded</span> mat1<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">pes</span> Bindv"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_preserve<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> envC <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"c <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pes <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">pes</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="main">(</span>update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_v_update_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsAppend_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_alist_to_ns_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_all_envD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env</span> <span class="skolem">e</span> <span class="main">(</span>Rval <span class="skolem">v1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="main">(</span>update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">e'</span> <span class="main">(</span>snd <span class="skolem">bv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_evaluate_single.mat1<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1b <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pes<span class="main">:</span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">pes</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env</span> <span class="skolem">e</span> <span class="main">(</span>Rval <span class="skolem">v1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1b <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">pes</span> Bindv <span class="main">=</span> Rerr <span class="skolem">err</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_eq<span class="main">[</span><span class="operator">OF</span> pes<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mat1b
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cupcake_match_result <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">pes</span> Bindv<span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>error_result.map_id<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> cupcake_evaluate_single.mat1error<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cupcake_evaluate_single.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_single_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span> <span class="main">⟹</span> is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> is_cupcake_exp <span class="free">e</span> <span class="main">⟹</span> cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_single_complete0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_list_complete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span>evaluate <span class="free">env</span><span class="main">)</span> <span class="free">s1</span> <span class="free">es</span> <span class="free">res</span> <span class="main">⟹</span>
    is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> list_all is_cupcake_exp <span class="free">es</span>  <span class="main">⟹</span>  <span class="main">∃</span><span class="bound">rs</span><span class="main">.</span> list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="free">env</span><span class="main">)</span> <span class="free">es</span> <span class="bound">rs</span> <span class="main">∧</span> sequence_result <span class="bound">rs</span> <span class="main">=</span> <span class="main">(</span>snd <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cupcake_list_complete0 cupcake_single_complete evaluate_list_mono_strong<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cupcake_list_state_preserve0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate_list <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">e</span> <span class="bound">res</span><span class="main">.</span> Big_Step_Unclocked_Single.evaluate <span class="free">env</span> <span class="bound">s</span> <span class="bound">e</span> <span class="bound">res</span> <span class="main">∧</span> <span class="main">(</span>is_cupcake_all_env <span class="free">env</span> <span class="main">⟶</span> is_cupcake_exp <span class="bound">e</span> <span class="main">⟶</span> <span class="bound">s</span> <span class="main">=</span> fst <span class="bound">res</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">es</span> <span class="free">res</span>"</span></span>
          <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="free">es</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span>
        <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>evaluate_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_state_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Big_Step_Unclocked_Single.evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="free">res</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> evaluate.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con1 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">vs</span> <span class="skolem">v</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> con1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_list_state_preserve0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con3 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">err</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_cupcake_exp.cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Con <span class="skolem">cn</span> <span class="skolem">es</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> con3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_list_state_preserve0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">es</span> <span class="skolem">s2</span> <span class="skolem">vs</span> <span class="skolem">env'</span> <span class="skolem">e</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2_shortcircuit <span class="main">(</span>cupcake_evaluate_single <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">es</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"sequence_result <span class="skolem">rs</span> <span class="main">=</span> Rval <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>evaluate_list_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cupcake_list_complete<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_list_preserve app1 rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 cupcake_opapp_preserve <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_list_state_preserve0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">env</span> <span class="skolem">s1</span> <span class="skolem">e</span> <span class="skolem">s2</span> <span class="skolem">v1</span> <span class="skolem">pes</span> <span class="skolem">e'</span> <span class="skolem">env'</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pes<span class="main">:</span><span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">pes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envD cupcake_single_complete cupcake_single_preserve<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uu</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">pes</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">e'</span><span class="main">,</span> <span class="skolem">uu</span><span class="main">,</span> <span class="skolem">env'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_eq<span class="main">[</span><span class="operator">OF</span> pes<span class="main">,</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> env <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">,</span> <span class="operator">unfolded</span> mat1<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>c <span class="skolem">env</span><span class="main">)</span> <span class="skolem">v1</span> <span class="skolem">pes</span> Bindv"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cupcake_match_result_preserve<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> envC <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"c <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> v <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> pes <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">pes</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> err_v <span class="main"><span class="main">=</span></span> <span class="quoted">Bindv</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="main">(</span>update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_v_update_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsAppend_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_alist_to_ns_preserve<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_all_envD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>cupcake_list_state_preserve0<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> cupcake_single_correct_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="free">res</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Big_Step_Unclocked_Single.evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms cupcake_single_correct cupcake_state_preserve <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> cupcake_single_complete_weak<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">e</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span> <span class="main">⟹</span> is_cupcake_all_env <span class="free">env</span> <span class="main">⟹</span> is_cupcake_exp <span class="free">e</span> <span class="main">⟹</span> cupcake_evaluate_single <span class="free">env</span> <span class="free">e</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cupcake_single_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> c

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Doc_Rewriting">
<div class="head">
<h1>Theory Doc_Rewriting</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Term rewriting›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Doc_Rewriting
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="General_Rewriting">
<div class="head">
<h1>Theory General_Rewriting</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> General_Rewriting
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Terms_Extras.html">Terms_Extras</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> rewriting <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>app <span class="free">t'</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">u</span> <span class="free">u'</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rt_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>app <span class="free">t'</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl R_fun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rt_arg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">u</span> <span class="free">u'</span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtranclp.rtrancl_into_rtrancl R_arg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rt_comb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>app <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rt_fun rt_arg rtranclp_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rt_list_comb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">ts</span> <span class="free">us</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>list_comb <span class="free">t</span> <span class="free">ts</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">u</span> <span class="free">us</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rt_comb<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rewriting_Term">
<div class="head">
<h1>Theory Rewriting_Term</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Higher-order term rewriting using de-Bruijn indices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rewriting_Term
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="General_Rewriting.html">../Terms/General_Rewriting</a>"</span>
  <span class="quoted">"<a href="Strong_Term.html">../Terms/Strong_Term</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Matching and rewriting›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rule <span class="main">=</span> <span class="quoted"><span class="quoted">"term <span class="main">×</span> term"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rewrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule fset <span class="main">⇒</span> term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢</span><span class="keyword3">/ </span>_ <span class="keyword1">⟶</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rs</span> <span class="keyword2"><span class="keyword">where</span></span>
step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span>"</span></span> <span class="main">|</span>
<span class="quoted">"fun"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">⟹</span> <span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span><span class="main">⟹</span> <span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> rewrite<span class="main">:</span> rewriting <span class="quoted"><span class="quoted">"rewrite <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">rs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rewrite_rt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule fset <span class="main">⇒</span> term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢</span><span class="keyword3">/ </span>_ <span class="keyword1">⟶*</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rewrite_rt</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">(</span>rewrite <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_beta_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">[</span><span class="free">t'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> wellformed <span class="free">t'</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free">t</span> <span class="main">$</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rewrite.beta<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wellformedness›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rule</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟷</span> basic_rule <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">∧</span> Term.wellformed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ruleI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"basic_rule <span class="main">(</span><span class="free">lhs</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Term.wellformed <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rule <span class="main">(</span><span class="free">lhs</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> split_rule_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>split_rule <span class="free">r</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>fst <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> head_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> prod.case_eq_if prod.collapse prod.inject split_rule.simps<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> rules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"heads_of <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule fset"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> rule"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> arity<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> patterns<span class="main">:</span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_shadows<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">lhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rewrite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lhs</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules step <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wellformed.rewrite_step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">u</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wellformed_term_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> replace_bound_wellformed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_rt_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span> <span class="main">⟹</span> wellformed <span class="free">t</span> <span class="main">⟹</span> wellformed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rewrite_wellformed <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> wellformed_term_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span> <span class="main">⟹</span> closed <span class="free">t</span> <span class="main">⟹</span> closed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rewrite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lhs</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rewrite_step_closed<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">[</span><span class="skolem">t'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">|⊆|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> frees <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> replace_bound_frees<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> beta <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_rt_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span> <span class="main">⟹</span> closed <span class="free">t</span> <span class="main">⟹</span> closed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rewrite_closed<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rewriting_Nterm">
<div class="head">
<h1>Theory Rewriting_Nterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Higher-order term rewriting using explicit bound variable names›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rewriting_Nterm
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Rewriting_Term.html">Rewriting_Term</a>
  <a href="../Higher_Order_Terms/Term_to_Nterm.html">Higher_Order_Terms.Term_to_Nterm</a>
  <span class="quoted">"<a href="Strong_Term.html">../Terms/Strong_Term</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> nrule <span class="main">=</span> <span class="quoted"><span class="quoted">"term <span class="main">×</span> nterm"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nrule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nrule</span> <span class="main">≡</span> basic_rule"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> <span class="entity">not_shadowing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">not_shadowing</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> shadows_consts <span class="free"><span class="bound"><span class="entity">lhs</span></span></span> <span class="main">∧</span> <span class="main">¬</span> shadows_consts <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> nrules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"heads_of <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule fset"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> nrule"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> arity<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> patterns<span class="main">:</span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_shadows<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> not_shadowing"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Matching and rewriting›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">nrewrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule fset <span class="main">⇒</span> nterm <span class="main">⇒</span> nterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rs</span> <span class="keyword2"><span class="keyword">where</span></span>
step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="main">(</span><span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> subst <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted">"fun"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> nrewrite<span class="main">:</span> rewriting <span class="quoted"><span class="quoted">"nrewrite <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">rs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nrewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_nterm_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nrewrite_rt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule fset <span class="main">⇒</span> nterm <span class="main">⇒</span> nterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶*</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nrewrite_rt</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">(</span>nrewrite <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nrules<span class="main">)</span> nrewrite_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lhs</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nrule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rewrite_step_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> beta
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_frees<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nrules<span class="main">)</span> nrewrite_rt_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nrewrite_closed<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">term</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> term_to_nterm_all_vars0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="free">Γ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span><span class="main">.</span> all_frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fset_of_list <span class="free">Γ</span> <span class="main">|∪|</span> frees <span class="free">t</span> <span class="main">|∪|</span> <span class="bound">T</span> <span class="main">∧</span> fBall <span class="bound">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term_to_nterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bound <span class="skolem">Γ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">|∈|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bound <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> State_Monad.return_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">t</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"all_frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">(</span>next <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>next <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fset_of_list <span class="main">(</span>next <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">|∪|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fBall <span class="skolem">T</span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="main">(</span>next <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> abs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"finsert <span class="main"><span class="main">(</span></span>next <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">)</span></span> <span class="skolem"><span class="skolem">T</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹all_frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">_</span> <span class="main">(</span>next <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> next_ge<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fBall <span class="skolem">T</span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="main">(</span>next <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fBallE fBallI fresh_class.next_ge order.strict_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"all_frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fset_of_list <span class="skolem">Γ</span> <span class="main">|∪|</span> frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fBall <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">|⊆|</span> fset_of_list <span class="skolem">Γ</span> <span class="main">|∪|</span> frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"all_frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fset_of_list <span class="skolem">Γ</span> <span class="main">|∪|</span> frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|∪|</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fBall <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all_frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">|⊆|</span> fset_of_list <span class="skolem">Γ</span> <span class="main">|∪|</span> frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|∪|</span> <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> state_io_relD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> term_to_nterm_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">|∪|</span></span> <span class="skolem"><span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹all_frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹all_frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fBall <span class="skolem">T<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fBall <span class="skolem">T<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="main">(&lt;)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fBallE less_le_not_le order_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> term_to_nterm_all_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>all_frees <span class="main">(</span>fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fresh_fNext <span class="main">(</span><span class="free">T</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="var">?Γ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"all_frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="var">?Γ</span> <span class="free">t</span><span class="main">)</span> <span class="var">?x</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fset_of_list <span class="var">?Γ</span> <span class="main">|∪|</span> frees <span class="free">t</span> <span class="main">|∪|</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fBall <span class="skolem">F</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="var">?x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> term_to_nterm_all_vars0<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="skolem">F</span> <span class="main">(</span><span class="free">T</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_ge_max<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBall_pred_weaken<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹fBall <span class="skolem">F</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="var">?x</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less_trans<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fNext_ge_max<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_left<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fresh_frun_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fresh_fNext_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_union_left<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">⟹</span> fdisjnt <span class="skolem">F</span> <span class="main">(</span><span class="free">T</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">translate_rule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset <span class="main">⇒</span> rule <span class="main">⇒</span> nrule"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">translate_rule</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lhs</span></span></span><span class="main">,</span> fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">(</span>frees <span class="free"><span class="bound"><span class="entity">lhs</span></span></span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> translate_rule_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"translate_rule <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">(</span>frees <span class="bound">lhs</span> <span class="main">|∪|</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile'</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile'</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> translate_rule <span class="main">(</span>pre_constants.all_consts <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">(</span>heads_of <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> rules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="main">=</span> translate_rule all_consts <span class="main">|`|</span> <span class="free">rs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile'_compile_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compile' <span class="free">C_info</span> <span class="free">rs</span> <span class="main">=</span> compile"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile'_def compile_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"heads_of compile <span class="main">=</span> heads_of <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_def translate_rule_alt_def head_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> compile_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"nrules <span class="free">C_info</span> compile"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fBall compile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> nrule <span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lhs</span> <span class="skolem">rhs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> compile"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">lhs</span> <span class="main">|∪|</span> all_consts<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rule<span class="main">:</span> <span class="quoted"><span class="quoted">"rule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nrule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword1"><span class="command">from</span></span> rule <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">lhs</span>"</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_const <span class="skolem">lhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">rhs'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> rhs <span class="keyword1"><span class="command">using</span></span> rule
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rule.simps term_to_nterm_vars<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs'</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rule <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fBall compile nrule"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"arity_compatibles compile"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> compile"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> compile"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"arity_compatible <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arity <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_fmap compile"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def translate_rule_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> patterns <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles compile"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def translate_rule_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>heads_of compile<span class="main">)</span> C"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compile_heads<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fBall compile not_shadowing"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lhs</span> <span class="skolem">rhs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> compile"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">lhs</span> <span class="main">|∪|</span> all_consts<span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compile_def translate_rule_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">lhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> all_rules not_shadows <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs'</span>"</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs'</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt all_consts <span class="main">(</span>frees <span class="skolem">lhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> shadows_consts_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_swap<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> term_to_nterm_all_vars<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_left<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_swap<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadowing <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compile_heads <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fBall compile <span class="main">(</span>constants.not_shadowing <span class="free">C_info</span> <span class="main">(</span>heads_of compile<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_heads <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fBall compile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_heads
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def ball_simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBall_pred_weaken<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ welldefined_rs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fresh_frun_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> term_to_nterm_consts<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> pred_state_run_state<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fBall compile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">rhs</span> <span class="main">|⊆|</span> pre_constants.all_consts <span class="free">C_info</span> <span class="main">(</span>heads_of compile<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_heads <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compile <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rules_as_nrules<span class="main">:</span> nrules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted">compile</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> compile_rules<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of translation›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rules<span class="main">)</span> compile_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> nterm_to_term' <span class="free">u</span> <span class="main">⟶</span> nterm_to_term' <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">u'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nenv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">nenv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> subst <span class="skolem">rhs'</span> <span class="skolem">nenv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nrelated.P_env <span class="main">[]</span> <span class="skolem">env</span> <span class="skolem">nenv</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="main">(</span>nterm_to_term <span class="main">[]</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nrelated.match_rel option.exhaust option.rel_distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.rel_inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">nenv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">nenv</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> closed.match<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs'</span> <span class="main">=</span> fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span> <span class="main">|∪|</span> all_consts<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rule <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_term <span class="main">[]</span> <span class="skolem">rhs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> term_to_nterm_nterm_to_term fresh_frun_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">u</span> <span class="main">⟶</span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nrewrite.step<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.nrewrite_closed<span class="main">)</span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rewrite.step<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">⊢</span> nterm_to_term <span class="main">[]</span> <span class="skolem">u</span> <span class="main">→</span> nterm_to_term <span class="main">[]</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nterm_to_term_eq_closed<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">env</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nrelated_subst<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> subst <span class="skolem">rhs'</span> <span class="skolem">nenv</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> beta
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_single_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nterm_to_term_subst_replace_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> rewrite.beta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness of translation›</span></span>

<span class="keyword1"><span class="command">context</span></span> rules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> closed_except_def fdisjnt_alt_def
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> compile_complete0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free">t</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span> fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free">t'</span><span class="main">)</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_to_nterm_vars0<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nterm_to_term' <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> term_to_nterm_nterm_to_term0<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs'</span> <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>nrelated.P_env <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>match <span class="skolem">pat</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>match <span class="skolem">pat</span> <span class="main">(</span><span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nrelated.match_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> Some <span class="skolem">env'</span>›</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nrelated.P_env <span class="main">[]</span> <span class="skolem">env'</span> <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option_rel_Some1<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹closed <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closed.match<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span> <span class="main">|∪|</span> all_consts<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> compile"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> compile_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rule <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nterm_to_term' <span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">rhs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_frun_def term_to_nterm_nterm_to_term<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="skolem">env</span> <span class="main">=</span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> nterm_to_term' <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">rhs'</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nrelated_subst<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">u'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">⟶</span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.step<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹closed <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>rules_as_nrules.nrewrite_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> nterm_to_term' <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span> <span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nterm_to_term_term_to_nterm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?name</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"next <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[</span><span class="var">?name</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?name</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[</span><span class="var">?name</span><span class="main">]</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?name</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> beta <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">t</span> <span class="main">[</span><span class="skolem">t'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="keyword1">Λ</span> <span class="skolem">t</span> <span class="main">$</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed  <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> replace_bound_frees
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> beta <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> nterm_to_term <span class="main">[</span><span class="var">?name</span><span class="main">]</span> <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> nterm_to_term' <span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"frees <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="main">{|</span><span class="var">?name</span><span class="main">|}</span> <span class="main">∨</span> frees <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> fempty"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_to_nterm_vars0<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="var">?name</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> term_to_nterm_vars0<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_to_nterm_nterm_to_term0<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">[</span><span class="skolem">t'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">=</span> nterm_to_term' <span class="main">(</span>subst_single <span class="var">?t<span class="hidden">⇩</span><sub>n</sub></span> <span class="var">?name</span> <span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nterm_to_term_subst_replace_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹closed <span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="var">?name</span><span class="main">,</span> <span class="var">?t<span class="hidden">⇩</span><sub>n</sub>'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.beta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_single_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> **<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nterm_to_term_term_to_nterm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_single_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_frees<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹closed_env <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"fun"</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed  <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> wellform<span class="main">:</span><span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"fun"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">u'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span> fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.fun<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> term_to_nterm_alpha_equiv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed  <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">t</span> <span class="main">$</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> wellform<span class="main">:</span><span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> arg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">t'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span>  fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> term_to_nterm_alpha_equiv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> term_to_nterm' <span class="free">t</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span> term_to_nterm' <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> term_to_nterm'_def
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compile_complete0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Splitting into constants›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> crules <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term list <span class="main">×</span> nterm<span class="main">)</span> fset"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> crule_set <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> crules<span class="main">)</span> fset"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">arity_compatibles</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term list <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">arity_compatibles</span> <span class="main">≡</span> fpairwise <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">(</span><span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> length <span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_compatible_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">pats</span> <span class="main">=</span> arity <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> length <span class="bound">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="bound">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fpairwise_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span>length <span class="main">∘</span> fst<span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>length <span class="main">∘</span> fst<span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span><span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">=</span> arity <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> arity_def fthe_elem'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> singleton_fset_holds<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> pre_crules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"crule_set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> crules <span class="main">=</span> pre_crules <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inner<span class="main">:</span>
    <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span><span class="main">.</span>
      arity_compatibles <span class="bound">crs</span> <span class="main">∧</span>
      is_fmap <span class="bound">crs</span> <span class="main">∧</span>
      patterns_compatibles <span class="bound">crs</span> <span class="main">∧</span>
      <span class="bound">crs</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">∧</span>
      fBall <span class="bound">crs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span>
        linears <span class="bound">pats</span> <span class="main">∧</span>
        <span class="bound">pats</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
        fdisjnt <span class="main">(</span>freess <span class="bound">pats</span><span class="main">)</span> all_consts <span class="main">∧</span>
        <span class="main">¬</span> shadows_consts <span class="bound">rhs</span> <span class="main">∧</span>
        frees <span class="bound">rhs</span> <span class="main">|⊆|</span> freess <span class="bound">pats</span> <span class="main">∧</span>
        welldefined <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_crules<span class="main">)</span> crulesI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> arity_compatibles <span class="bound">crs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> is_fmap <span class="bound">crs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> patterns_compatibles <span class="bound">crs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="bound">crs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">crs</span> <span class="main">⟹</span> linears <span class="bound">pats</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">crs</span> <span class="main">⟹</span> <span class="bound">pats</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">crs</span> <span class="main">⟹</span> fdisjnt <span class="main">(</span>freess <span class="bound">pats</span><span class="main">)</span> all_consts"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">crs</span> <span class="main">⟹</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">crs</span> <span class="main">⟹</span> frees <span class="bound">rhs</span> <span class="main">|⊆|</span> freess <span class="bound">pats</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">crs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">crs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">crs</span> <span class="main">⟹</span> welldefined <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"crules <span class="free">C_info</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> crules_axioms_def crules_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_fBallI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pre_crules_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> crulesI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> pre_crules.crulesI<span class="main">[</span><span class="operator">unfolded</span> pre_crules_def<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">consts_of</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nrule fset <span class="main">⇒</span> crule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consts_of</span> <span class="main">=</span> fgroup_by split_rule"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> consts_of_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> consts_of <span class="free">rs</span> <span class="main">=</span> heads_of <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> consts_of_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_rule_fst comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nrules<span class="main">)</span> consts_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"crules <span class="free">C_info</span> <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts_of <span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fgroup_by_nonempty<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constants <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> consts_of <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> consts_of <span class="free">rs</span><span class="main">)</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> consts_of_heads<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">crs</span>
  <span class="keyword3"><span class="command">assume</span></span> crs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">crs</span><span class="main">)</span> <span class="main">|∈|</span> consts_of <span class="free">rs</span>"</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">crs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> femptyE fgroup_by_nonempty_inner<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">crs</span>"</span></span> <span class="quoted"><span class="quoted">"patterns_compatibles <span class="skolem">crs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> crs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span></span>
        <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_rule <span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                     <span class="quoted"><span class="quoted">"split_rule <span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> arity<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_compatible <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> arity <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> rs <span class="keyword1"><span class="command">have</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> const_name <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> const_name <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> const <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> Const <span class="skolem">name</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> Const <span class="skolem">name</span>"</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">with</span></span> arity <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> arity_compatible_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

      <span class="keyword1"><span class="command">with</span></span> split <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rs patterns <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>1<span class="main">)</span> const<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split<span class="main">(</span>2<span class="main">)</span> const<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pattern_compatible_combD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">crs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> crs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span></span>
        <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
              split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_rule <span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                     <span class="quoted"><span class="quoted">"split_rule <span class="main">(</span><span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>fst<span class="main">)</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
                      <span class="main">|</span> <span class="main">(</span>snd<span class="main">)</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> snd <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_strip_comb<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
              <span class="keyword3"><span class="command">case</span></span> fst
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> rs all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> split const_name_simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> snd
              <span class="keyword1"><span class="command">with</span></span> split <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">with</span></span> rs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_fmap <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_fmapD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> snd <span class="main">(</span>strip_comb <span class="skolem">lhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> crs <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nrule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">lhs</span>"</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> linears_strip_comb<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_const <span class="skolem">lhs</span>"</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹nrule <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">lhs</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">lhs</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_term_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹nrule <span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">lhs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="skolem">lhs</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_const_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">lhs</span> <span class="main">=</span> freess <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">lhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> frees_strip_comb<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> freess <span class="skolem">pats</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> not_shadows
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pre_constants.shadows_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> consts_of <span class="free">rs</span><span class="main">)</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consts_of_heads<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt all_consts <span class="main">(</span>frees <span class="skolem">lhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> not_shadows
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows_consts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"freess <span class="skolem">pats</span> <span class="main">|⊆|</span> frees <span class="skolem">lhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹frees <span class="skolem">lhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fdisjnt_subset_right fdisjnt_swap<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> <span class="main">(</span>pre_constants.all_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> consts_of <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consts_of_heads<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pre_constants.welldefined <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> consts_of <span class="free">rs</span><span class="main">)</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> welldefined_rs <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">lhs</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> consts_of_heads<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> nrules <span class="main">⊆</span> nrules_as_crules<span class="main">?</span><span class="main">:</span> crules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"consts_of <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> consts_rules<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computability›</span></span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">translate_rule</span></span> <span class="quoted"><span class="quoted">consts_of</span></span> <span class="quoted"><span class="quoted">arity</span></span> <span class="quoted"><span class="quoted">nterm_to_term</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rewriting_Pterm_Elim">
<div class="head">
<h1>Theory Rewriting_Pterm_Elim</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Higher-order term rewriting with explicit pattern matching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rewriting_Pterm_Elim
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Rewriting_Nterm.html">Rewriting_Nterm</a>
  <span class="quoted">"<a href="Pterm.html">../Terms/Pterm</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Intermediate rule sets›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> irules <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term list <span class="main">×</span> pterm<span class="main">)</span> fset"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> irule_set <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> irules<span class="main">)</span> fset"</span></span>

<span class="keyword1"><span class="command">locale</span></span> pre_irules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> irules <span class="main">=</span> pre_irules <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inner<span class="main">:</span>
    <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span><span class="main">.</span>
      arity_compatibles <span class="bound">irs</span> <span class="main">∧</span>
      is_fmap <span class="bound">irs</span> <span class="main">∧</span>
      patterns_compatibles <span class="bound">irs</span> <span class="main">∧</span>
      <span class="bound">irs</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">∧</span>
      fBall <span class="bound">irs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span>
        linears <span class="bound">pats</span> <span class="main">∧</span>
        abs_ish <span class="bound">pats</span> <span class="bound">rhs</span> <span class="main">∧</span>
        closed_except <span class="bound">rhs</span> <span class="main">(</span>freess <span class="bound">pats</span><span class="main">)</span> <span class="main">∧</span>
        fdisjnt <span class="main">(</span>freess <span class="bound">pats</span><span class="main">)</span> all_consts <span class="main">∧</span>
        wellformed <span class="bound">rhs</span> <span class="main">∧</span>
        <span class="main">¬</span> shadows_consts <span class="bound">rhs</span> <span class="main">∧</span>
        welldefined <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_irules<span class="main">)</span> irulesI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> arity_compatibles <span class="bound">irs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> is_fmap <span class="bound">irs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> patterns_compatibles <span class="bound">irs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="bound">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> linears <span class="bound">pats</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> abs_ish <span class="bound">pats</span> <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> fdisjnt <span class="main">(</span>freess <span class="bound">pats</span><span class="main">)</span> all_consts"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> closed_except <span class="bound">rhs</span> <span class="main">(</span>freess <span class="bound">pats</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> wellformed <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">irs</span> <span class="bound">pats</span> <span class="bound">rhs</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="bound">irs</span> <span class="main">⟹</span> welldefined <span class="bound">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irules <span class="free">C_info</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> irules_axioms_def irules_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_fBallI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pre_irules_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> irulesI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span> <span class="main">=</span> pre_irules.irulesI<span class="main">[</span><span class="operator">unfolded</span> pre_irules_def<span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Translation from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">pterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nterm_to_pterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> pterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_pterm</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Pvar <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_pterm</span> <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Pconst <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nterm_to_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">nterm_to_pterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_pterm</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free">nterm_to_pterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nterm_to_pterm_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"nterm_to_pterm <span class="free">x</span> <span class="main">=</span> nterm_to_pterm <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nterm_to_pterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_pterm <span class="free">t</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> free_nterm_def free_pterm_def const_nterm_def const_pterm_def app_nterm_def app_pterm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nterm_to_pterm_frees<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>nterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_nterm_to_pterm<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>nterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> shadows_nterm_to_pterm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>nterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> shadows_consts <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows_consts_def fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_nterm_to_pterm<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>nterm_to_pterm <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> consts_nterm_to_pterm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>nterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Translation from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">crule_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">irule_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">translate_crules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"crules <span class="main">⇒</span> irules"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">translate_crules</span> <span class="main">=</span> fimage <span class="main">(</span>map_prod id nterm_to_pterm<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"crule_set <span class="main">⇒</span> irule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="main">=</span> fimage <span class="main">(</span>map_prod id translate_crules<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> compile <span class="free">rs</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> crules<span class="main">)</span> compile_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"irules <span class="free">C_info</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def map_prod_def id_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constants <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">unfolding</span></span> compile_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">irs</span>
  <span class="keyword3"><span class="command">assume</span></span> irs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> compile <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">irs'</span>›</span></span> translate_crules_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"patterns_compatibles <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"patterns_compatibles <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> translate_crules_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">irs'</span>›</span></span> translate_crules_def map_prod_def id_apply
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs'</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">irs'</span>›</span></span> translate_crules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">rhs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">irs'</span>›</span></span> translate_crules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs'</span> <span class="main">|⊆|</span> freess <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fbspec<span class="main">[</span><span class="operator">OF</span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">rhs'</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹frees <span class="skolem">rhs'</span> <span class="main">|⊆|</span> freess <span class="skolem">pats</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans closed_nterm_to_pterm closed_except_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">rhs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> <span class="main">(</span>pre_constants.all_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pre_constants.shadows_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_heads <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs_ish <span class="skolem">pats</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> abs_ish_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fbspec<span class="main">[</span><span class="operator">OF</span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pre_constants.welldefined <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> crules <span class="main">⊆</span> crules_as_irules<span class="main">:</span> irules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> compile_rules<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transformation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">irule_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transform_irules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irules <span class="main">⇒</span> irules"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">transform_irules</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> arity <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>
  <span class="keyword1">else</span> map_prod id Pabs <span class="main">|`|</span> fgroup_by <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">,</span> <span class="main">(</span>last <span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_compatibles_transform_irules<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="main">(</span>transform_irules <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"transform_irules <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">,</span> <span class="main">(</span>last <span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?grp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fgroup_by <span class="var">?f</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rs'</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?rs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?rs'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rs' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="comment1">― ‹dummies›</span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fgroup_byE2<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> butlast <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> butlast <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> length <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_transform_irules<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>transform_irules <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> arity <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">,</span> <span class="main">(</span>last <span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?grp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fgroup_by <span class="var">?f</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity <span class="var">?rs'</span> <span class="main">=</span> arity <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arityI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBall <span class="var">?rs'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> length <span class="bound">pats</span> <span class="main">=</span> arity <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_fBallI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?rs'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="comment1">― ‹dummy›</span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fgroup_byE2<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats'</span> <span class="main">=</span> arity <span class="free">rs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_compatible_length<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats</span> <span class="main">=</span> arity <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats'</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rs'</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fgroup_by_nonempty<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transform_irule_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> irule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">transform_irule_set</span> <span class="main">=</span> fimage <span class="main">(</span>map_prod id transform_irules<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transform_irule_set_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> transform_irule_set <span class="free">rs</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> rules_transform<span class="main">:</span> <span class="quoted"><span class="quoted">"irules <span class="free">C_info</span> <span class="main">(</span>transform_irule_set <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>transform_irule_set <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def map_prod_def id_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"constants <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> transform_irule_set <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> transform_irule_set <span class="free">rs</span><span class="main">)</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">irs</span>
  <span class="keyword3"><span class="command">assume</span></span> irs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> transform_irule_set <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arity_compatibles_transform_irules<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs'</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fgroup_by_nonempty<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">,</span> <span class="main">(</span>last <span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?grp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fgroup_by <span class="var">?f</span> <span class="skolem">irs'</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"patterns_compatibles <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"patterns_compatibles <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹patterns_compatibles <span class="skolem">irs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> irs' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="comment1">― ‹dummies›</span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> butlast <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> butlast <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> irs'
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fgroup_byE2<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹patterns_compatibles <span class="skolem">irs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">irs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> irs' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Pabs <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Pabs <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="var">?grp</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_fmapD<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="comment1">― ‹dummy›</span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fgroup_byE2<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="comment1">― ‹dummy›</span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fgroup_byE2<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats'</span><span class="main">)</span> all_consts"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subsetI in_set_butlastD freess_subset fdisjnt_subset_left<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> <span class="main">(</span>pre_constants.all_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> transform_irule_set <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>›</span></span> closed_except_simps
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">t</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>freess <span class="skolem">pats'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> False
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> arity_compatible_length<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta snoc_eq_iff_butlast<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"freess <span class="skolem">pats</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span> <span class="main">=</span> freess <span class="skolem">pats'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> freess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>freess <span class="skolem">pats</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">t</span> <span class="main">(</span>freess <span class="skolem">pats'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wellformed_PabsI<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs'</span> <span class="main">≠</span> <span class="main">{||}</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> femptyE fgroup_by_nonempty_inner<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">cs</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs'</span>›</span></span> False
                <span class="keyword1"><span class="command">unfolding</span></span> prod.case
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> arity_compatible_length<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat</span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> split_beta fst_conv snd_conv
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject snoc_eq_iff_butlast<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">irs'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_fmapD<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="skolem">cs</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs'</span>›</span></span> False
                <span class="keyword1"><span class="command">unfolding</span></span> prod.case
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> arity_compatible_length<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> split_beta fst_conv snd_conv
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject snoc_eq_iff_butlast<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹patterns_compatibles <span class="skolem">irs'</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rev_accum_rel_snoc_eqE<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">t</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs'</span>›</span></span> False
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> arity_compatible_length<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">∈</span> set <span class="skolem">pats'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linears_linear<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"shadows_consts <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"shadows_consts <span class="skolem">t</span> <span class="main">∨</span> shadows_consts <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs'</span>›</span></span> False
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> arity_compatible_length<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">∈</span> set <span class="skolem">pats'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹shadows_consts <span class="skolem">t</span> <span class="main">∨</span> shadows_consts <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"shadows_consts <span class="skolem">t</span>"</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"shadows_consts <span class="skolem">pat</span>"</span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats'</span><span class="main">)</span> all_consts"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> all_consts"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_left<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> freess_single<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> freess_subset<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹shadows_consts <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pre_constants.shadows_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> transform_irule_set <span class="free">rs</span><span class="main">)</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transform_irule_set_heads<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs_ish <span class="skolem">pats</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> abs_ish_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_abs_def term_cases_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE split_conv<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def
        <span class="keyword1"><span class="command">using</span></span> fbspec<span class="main">[</span><span class="operator">OF</span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ffUnion_least<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ball_simps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst_thin</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> pat t
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">t</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> fbspec<span class="main">[</span><span class="operator">OF</span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pre_constants.welldefined <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> transform_irule_set <span class="free">rs</span><span class="main">)</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_heads <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Matching and rewriting›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irewrite_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> term list <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">irewrite_step</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> map_option <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">(</span>match <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">irewrite_step'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> term list <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span> _<span class="keyword1">,</span> _ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">→</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> irewrite_step <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irewrite_stepI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">pats</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs</span> <span class="free">env</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">→</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">irewrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">irs</span> <span class="keyword2"><span class="keyword">where</span></span>
step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">irs</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pats</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">irs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>
beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">irs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted">"fun"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">irs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">irs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">irs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span> <span class="free">irs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> irewrite<span class="main">:</span> rewriting <span class="quoted"><span class="quoted">"irewrite <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">rs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_pterm_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">irewrite_rt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶*</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">irewrite_rt</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">(</span>irewrite <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> irewrite_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rs</span> <span class="skolem">pats</span> <span class="skolem">rhs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closed.match<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_frees<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> match_dom<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> frees_list_comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> inner step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> beta <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closed.match<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_frees<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> match_dom<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> inner beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> irewrite_rt_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irewrite_closed<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of translation›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">irelated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> _"</span> <span class="main">[</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>i</sub></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> nterm_to_pterm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> irelated<span class="main">:</span> term_struct_rel_strong <span class="quoted">irelated</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_pterm_def app_nterm_def const_pterm_def const_nterm_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> irelated_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">⟹</span> frees <span class="free">t</span> <span class="main">=</span> frees <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> irelated_no_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span> <span class="main">⟷</span> no_abs <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_nterm_def const_pterm_def free_nterm_def free_pterm_def app_pterm_def app_nterm_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> irelated_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"irelated.P_env <span class="free">nenv</span> <span class="free">penv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="free">nenv</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> subst <span class="free">u</span> <span class="free">penv</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">nenv</span></span> <span class="quoted"><span class="free">penv</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmrel_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 4<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmrel_drop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> related_irewrite_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> nterm_to_pterm <span class="free">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">→</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"unsplit_rule <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">→</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rhs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nterm_to_pterm <span class="free">rhs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">$$</span> <span class="free">pats</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="var">?x</span> <span class="free">u</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">=</span> subst <span class="var">?rhs'</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nenv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="var">?x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">nenv</span>"</span></span> <span class="quoted"><span class="quoted">"irelated.P_env <span class="skolem">nenv</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Option.is_none_def not_None_eq option.rel_distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel rel_option_unfold irelated.match_rel<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unsplit_rule <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">→</span> subst <span class="free">rhs</span> <span class="skolem">nenv</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="var">?x</span> <span class="free">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs</span> <span class="skolem">nenv</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹irelated.P_env <span class="skolem">nenv</span> <span class="skolem">env</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irelated_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nrules<span class="main">)</span> compile_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> irewrite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">irs</span> <span class="skolem">pats</span> <span class="skolem">rhs</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">crs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">crs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">crs</span><span class="main">)</span> <span class="main">|∈|</span> consts_of <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">rhs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> translate_crules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rule</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"split_rule <span class="skolem">rule</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rule</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consts_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nrule <span class="skolem">rule</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"unsplit_rule <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span><span class="main">,</span> <span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u</span> <span class="main">→</span> <span class="skolem">u'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">rhs'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> related_irewrite_step<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rule</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹nrule <span class="skolem">rule</span>›</span></span> <span class="quoted"><span class="quoted">‹split_rule <span class="skolem">rule</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unsplit_split<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.step<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> Pabs <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> Pabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">nrhs</span></span> <span class="skolem"><span class="skolem">irhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span><span class="main">.</span> <span class="skolem">nrhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span>Free <span class="skolem">x</span><span class="main">,</span> <span class="skolem">irhs</span><span class="main">)</span> <span class="main">|}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nrhs</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">irhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> Pabs <span class="skolem">cs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span><span class="main">.</span> <span class="skolem">nrhs</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span><span class="main">.</span> <span class="skolem">nrhs</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">Λ<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span><span class="main">.</span> <span class="skolem">irhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> Pabs <span class="skolem">cs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> Free <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">irhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span>Free <span class="skolem">x</span><span class="main">,</span> <span class="skolem">irhs</span><span class="main">)</span> <span class="main">|}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Free <span class="skolem">x</span><span class="main">,</span> <span class="skolem">irhs</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">u</span> <span class="main">→</span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> subst <span class="skolem">irhs</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> beta.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶</span> subst <span class="skolem">nrhs</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span><span class="main">.</span> <span class="skolem">nrhs</span><span class="main">)</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">w</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.beta<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">nrhs</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> subst <span class="skolem">irhs</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irelated_subst<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"fun"</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"fun"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">w</span> <span class="main">⟶</span> <span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="skolem">w'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.fun<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ <span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nterm_to_pterm.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> arg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite.arg<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nrules<span class="main">)</span> compile_correct_rt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">⟶*</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="comment1">(* FIXME clone of transform_correct_rt, maybe locale? *)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">u'</span> <span class="skolem">u''</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t'</span> <span class="main">⟶*</span> <span class="skolem">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> compile_correct<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compile <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span> <span class="main">⟶</span> <span class="skolem">u''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">t</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nrewrite_rt_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">t'</span> <span class="main">⟶*</span> <span class="skolem">t''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness of translation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> nrules<span class="main">)</span> compile_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compile <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> nterm_to_pterm <span class="free">t</span> <span class="main">⟶</span> nterm_to_pterm <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">r</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nrule <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="skolem"><span class="skolem">pats</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> split_rule <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> split_rule_def <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">crs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">crs</span><span class="main">)</span> <span class="main">|∈|</span> consts_of <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">crs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> split_rule <span class="skolem">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> consts_of_def fgroup_by_complete fst_conv snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> translate_crules <span class="skolem">crs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> compile <span class="main">(</span>consts_of <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fimageI id_def map_prod_simp<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">rhs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">|∈|</span> <span class="skolem">crs</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> translate_crules_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fimageI id_def map_prod_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs'</span> <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> rewrite_step.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="main">(</span>nterm_to_pterm <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"irelated.P_env <span class="skolem">env'</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irelated.match_rel option_rel_Some1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="skolem">env</span> <span class="main">=</span> nterm_to_pterm <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irelated_subst<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span><span class="main">,</span> <span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> nterm_to_pterm <span class="skolem">t</span> <span class="main">→</span> nterm_to_pterm <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irewrite_stepI<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span>Free <span class="skolem">x</span><span class="main">,</span> nterm_to_pterm <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> beta <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>nterm_to_pterm <span class="skolem">t'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_nterm_to_pterm<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irelated_subst<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"fun"</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"fun"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"fun"</span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> arg
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of transformation›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">irules_deferred_matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm list <span class="main">⇒</span> irules <span class="main">⇒</span> <span class="main">(</span>term <span class="main">×</span> pterm<span class="main">)</span> fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">irules_deferred_matches</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">≡</span> fselect
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">env</span><span class="main">.</span> <span class="main">(</span>last <span class="bound">pats</span><span class="main">,</span> subst <span class="bound">rhs</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>matchs <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> irules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">prelated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> _"</span> <span class="main">[</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
const<span class="main">:</span> <span class="quoted"><span class="quoted">"Pconst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> Pconst <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
var<span class="main">:</span> <span class="quoted"><span class="quoted">"Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> Pvar <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
pat<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fset <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">prelated</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">cs<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> Pabs <span class="free"><span class="bound"><span class="entity">cs<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> Pabs <span class="free"><span class="bound"><span class="entity">cs<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted">"defer"</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rsi</span></span></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> arity <span class="free"><span class="bound"><span class="entity">rsi</span></span></span> <span class="main">⟹</span>
   rel_fset <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">prelated</span><span class="main">)</span> <span class="main">(</span>irules_deferred_matches <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">rsi</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span>
   list_all closed <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">⟹</span>
   <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1"><span class="free">≈<span class="hidden">⇩</span><sub>p</sub></span></span> Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> prelated_absE<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> pat <span class="quoted">"defer"</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> Pabs <span class="free">cs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prelated_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Pabs
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> snds.simps fmember.rep_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prelated.pat rel_fset_refl_strong rel_prod.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated.intros<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> prelated<span class="main">:</span> term_struct_rel <span class="quoted">prelated</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_pterm_def app_pterm_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prelated.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prelated_pvars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">=</span> frees <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prelated.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pat <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_fset_image_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"defer"</span> <span class="skolem">name</span> <span class="skolem">rsi</span> <span class="skolem">args</span> <span class="skolem">cs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"defer"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">|∈|</span> irules_deferred_matches <span class="skolem">args</span> <span class="skolem">rsi</span>"</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">=</span> frees <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_fsetE2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="skolem"><span class="skolem">env</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rsi</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span> <span class="skolem">args</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rsi</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rsi</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">rsi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"defer"</span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> arity_compatible_length<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">pats</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹frees <span class="skolem">t</span> <span class="main">=</span> frees <span class="skolem">t'</span>›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t'</span> <span class="main">=</span> frees <span class="skolem">rhs</span> <span class="main">-</span> fmdom <span class="skolem">env</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_frees<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closed.matchs<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> frees <span class="skolem">rhs</span> <span class="main">-</span> freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹matchs <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matchs_dom<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">|⊆|</span> freess <span class="skolem">pats</span> <span class="main">-</span> freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">_</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> frees <span class="main">(</span>last <span class="skolem">pats</span><span class="main">)</span> <span class="main">|-|</span> freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funion_fminus<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> frees <span class="main">(</span>last <span class="skolem">pats</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fminus_triv<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freess <span class="main">[</span>last <span class="skolem">pats</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linears <span class="skolem">pats</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linears_appendD<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>last <span class="skolem">pats</span><span class="main">)</span> <span class="main">|∩|</span> freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_list_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> prelated_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span> <span class="main">⟹</span> closed <span class="free">t</span> <span class="main">⟷</span> closed <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prelated_pvars<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prelated_no_abs_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prelated.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_pterm_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">corollary</span></span> env_prelated_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="free">env</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmap.rel_refl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following, more general statement does not hold:
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="keyword1"><span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="free">u</span></span> <span class="main"><span class="main">⟹</span></span> rel_option prelated.P_env <span class="main"><span class="main">(</span></span>match <span class="free"><span class="free">x</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>match <span class="free"><span class="free">x</span></span> <span class="free"><span class="free">u</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">t</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">u</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are related because of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source=true] prelated.defer<span class="antiquote"><span class="antiquote">}</span></span></span></span> rule,
  they have completely different shapes.
  Establishing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"is_abs <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">⟷</span></span> is_abs <span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as a precondition would rule out this case, but at
  the same time be too restrictive.

  Instead, we use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> prelated.related_match<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prelated_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> subst <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">env<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prelated.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmrel_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> none
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated.var<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>some <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pat <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?drop</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">::</span>term<span class="main">)</span><span class="main">.</span> fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="bound">env</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> pat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="main">(</span><span class="var">?drop</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span><span class="var">?drop</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">pat</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">pat</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> pat <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prelated.pat rel_fset_image<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"defer"</span> <span class="skolem">name</span> <span class="skolem">rsi</span> <span class="skolem">args</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> Pabs <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prelated.defer<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.rel_mono_strong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_list_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prelated_closed<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?drop</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span><span class="main">.</span> <span class="main">λ</span><span class="bound">pat</span><span class="main">.</span> fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="bound">env</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">rhs</span> <span class="main">(</span><span class="var">?drop</span> <span class="bound">env</span> <span class="bound">pat</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> Pabs <span class="main">(</span><span class="var">?f</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|`|</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prelated.defer<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rsi</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> arity <span class="skolem">rsi</span>"</span></span> <span class="quoted"><span class="quoted">"list_all closed <span class="skolem">args</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"defer"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> subst_closed_pabs<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="main">(</span>rel_prod <span class="main">(=)</span> prelated<span class="main">)</span> <span class="main">(</span>id <span class="main">|`|</span> irules_deferred_matches <span class="skolem">args</span> <span class="skolem">rsi</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|`|</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fset_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rel_fset <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_fset <span class="main">(</span>rel_prod <span class="main">(=)</span> prelated<span class="main">)</span> <span class="main">(</span>irules_deferred_matches <span class="skolem">args</span> <span class="skolem">rsi</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|`|</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> subst <span class="bound">t</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">args</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_idI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_closed_id<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"defer"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_list_comb<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prelated_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">→</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">→</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">$$</span> <span class="free">pats</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="var">?lhs</span> <span class="free">u</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u'</span> <span class="main">=</span> subst <span class="free">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="var">?lhs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="skolem">env'</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prelated.related_match<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs</span> <span class="skolem">env'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> subst <span class="free">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated_subst<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span><span class="main">,</span> <span class="free">pats</span><span class="main">,</span> <span class="free">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">→</span> subst <span class="free">rhs</span> <span class="skolem">env'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="var">?lhs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">env'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs</span> <span class="skolem">env'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u'</span> <span class="main">=</span> subst <span class="free">rhs</span> <span class="skolem">env</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* FIXME write using relators *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prelated_beta<span class="main">:</span> <span class="comment1">― ‹same problem as <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source=true] prelated.related_match<span class="antiquote">}</span></span>›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> subst <span class="free">rhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prelated.related_match<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> subst <span class="free">rhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated_subst<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> subst <span class="free">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="free">pat</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> transform_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="comment1">― ‹zero or one step›</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> irewrite.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">c</span> <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> Pabs <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> Pabs <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">with</span></span> beta <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> Pabs <span class="skolem">cs<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> prelated_absE<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pat <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_fsetE2<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> beta <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prelated_beta <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rewrite_step.simps<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> beta.prems<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> r_into_rtranclp irewrite.beta<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"defer"</span> <span class="skolem">name</span> <span class="skolem">rsi</span> <span class="skolem">args</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">|∈|</span> irules_deferred_matches <span class="skolem">args</span> <span class="skolem">rsi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_fsetE2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>a</sub></span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">pats</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span> <span class="skolem">args</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>a</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>a</sub></span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rsi</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rsi</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">unfolding</span></span> irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">rsi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"defer"</span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> arity_compatible_length<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">from</span></span> beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>b</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prelated.related_match<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env<span class="hidden">⇩</span><sub>a</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closed.matchs<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closed.matchs<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pats <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">]</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ts <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>a</sub></span> <span class="main">=</span> freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matchs_dom<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_dom<span class="main">)</span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="main">(</span>butlast <span class="skolem">pats</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹linears <span class="skolem">pats</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> freess_single linears_appendD<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>a</sub></span><span class="main">)</span> <span class="main">(</span>fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> beta.prems<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> irewrite.step<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rsi</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rsi</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span><span class="main">,</span> <span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irewrite_stepI<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_pterm_def<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> list_comb_snoc<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> matchs_match_list_comb<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> matchs_appI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_indep'<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> r_into_rtranclp<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>b</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prelated_subst<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">pats</span> <span class="skolem">rhs</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> transform_irules <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span><span class="main">,</span> <span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prelated_step<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.prems<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI r_into_rtranclp irewrite.step<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">,</span> last <span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?grp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fgroup_by <span class="var">?f</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>

      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> transform_irules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Pabs <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

      <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"matchs <span class="skolem">pats</span> <span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> match_list_combE<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 prelated <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prelated.list_combE<span class="main">)</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"matchs <span class="skolem">pats</span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"prelated.P_env <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹matchs <span class="skolem">pats</span> <span class="skolem">args<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prelated.related_matchs<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> freess <span class="skolem">pats</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchs_dom<span class="main">)</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> Pabs <span class="skolem">cs'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.prems<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp.rtrancl_refl<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u'</span> <span class="main">=</span> Pabs <span class="skolem">cs'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> prelated.defer rel_fsetI<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> arity <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all closed <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> closed_list_comb <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">rhs'</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> irules_deferred_matches <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="skolem"><span class="skolem">env</span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span>butlast <span class="skolem">pats'</span><span class="main">)</span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> arity_compatible_length<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">pats'</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">pats'</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">pats'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

              <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats<span class="hidden">⇩</span><sub>e</sub></span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>e</sub></span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>e</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats<span class="hidden">⇩</span><sub>e</sub></span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fgroup_byE2<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"patterns_compatible <span class="main">(</span>butlast <span class="skolem">pats'</span><span class="main">)</span> <span class="skolem">pats</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rev_accum_rel_butlast<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats<span class="hidden">⇩</span><sub>e</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>e</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

              <span class="keyword1"><span class="command">interpret</span></span> irules'<span class="main">:</span> irules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_transform<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="skolem">pats'</span> <span class="main">=</span> <span class="skolem">pats</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> matchs_compatible_eq<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linears_butlastI<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> transform_irule_set <span class="free">rs</span>›</span></span>
                  <span class="keyword1"><span class="command">using</span></span> irules'.inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> matchs_compatible_eq<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linears_butlastI<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> transform_irule_set <span class="free">rs</span>›</span></span>
                  <span class="keyword1"><span class="command">using</span></span> irules'.inner <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rhs_subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span><span class="main">.</span> subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="bound">env</span><span class="main">)</span>"</span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> freess <span class="skolem">pats</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="main">(</span><span class="main">_</span> <span class="main">$$</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_dom<span class="main">)</span>

              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBex <span class="skolem">cs'</span> <span class="main">(</span>rel_prod <span class="main">(=)</span> prelated <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rel_prod.intros<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="main">(</span>butlast <span class="skolem">pats'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="main">(</span>last <span class="skolem">pats'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> freess_single<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> linears_appendD<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹butlast <span class="skolem">pats'</span> <span class="main">@</span> <span class="main">[</span>last <span class="skolem">pats'</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">pats'</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="skolem">env</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="var">?rhs_subst</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prelated_subst<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prelated_refl<span class="main">)</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmfilter_true<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> x y
                      <span class="keyword1"><span class="command">using</span></span> fmdomI<span class="main">[</span><span class="operator">OF</span> prems<span class="main">]</span>
                      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="skolem">pats'</span> <span class="main">=</span> <span class="skolem">pats</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt <span class="main">(</span>freess <span class="main">(</span>butlast <span class="skolem">pats'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="main">(</span>last <span class="skolem">pats'</span><span class="main">)</span><span class="main">)</span>›</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fgroup_byD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">y</span></span><span class="main"><span class="main">)</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="var">?rhs_subst</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs'</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">rhs'</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs'</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pats'</span></span>
                <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats'</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_compatible_length<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat</span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">_</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> linears_appendD<span class="main">)</span>

              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rhs_subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">env</span><span class="main">.</span> subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="bound">env</span><span class="main">)</span>"</span></span>

              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBex <span class="main">(</span>irules_deferred_matches <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> rel_prod <span class="main">(=)</span> prelated <span class="bound">e</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rel_prod.intros<span class="main">)</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs_subst</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="var">?rhs_subst</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prelated.P_env <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> inner
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prelated_subst<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span>butlast <span class="skolem">pats'</span><span class="main">)</span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹matchs <span class="skolem">pats</span> <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="var">?rhs_subst</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"subst <span class="skolem"><span class="skolem">rhs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmfilter_true<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt <span class="main">(</span>fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">_</span>›</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="var">?rhs_subst</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> irules_deferred_matches <span class="skolem">args<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats'</span>›</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"fun"</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"fun"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">w</span> <span class="main">⟶*</span> <span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">w'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> irewrite.rt_comb<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app_pterm_def<span class="main"><span class="main">]</span></span> rtranclp.rtrancl_refl<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v'</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prelated.app<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u</span>›</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> arg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">x</span> <span class="main">⟶*</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> irewrite.rt_comb<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app_pterm_def<span class="main"><span class="main">]</span></span> rtranclp.rtrancl_refl<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">x'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">v</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prelated.app<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness of transformation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> transform_completeness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">irs'</span> <span class="skolem">pats'</span> <span class="skolem">rhs'</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> transform_irule_set <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fimageI id_apply map_prod_simp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> <span class="skolem">irs'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span><span class="main">,</span> <span class="skolem">pats'</span><span class="main">,</span> <span class="skolem">rhs'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> r_into_rtranclp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>butlast <span class="bound">pats</span><span class="main">,</span> last <span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?grp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fgroup_by <span class="var">?f</span> <span class="skolem">irs'</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> closed_except_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> transform_irules <span class="skolem">irs'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transform_irules_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">pats</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pat</span> <span class="main">=</span> last <span class="skolem">pats'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> butlast <span class="skolem">pats'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> step False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> arity_compatible_length inner
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fBallE prod.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats'</span> <span class="main">=</span> <span class="skolem">pats</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">pat</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">pats'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inner fBallE
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> old.prod.case<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">pats</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> linears_appendD<span class="main">(</span>3<span class="main">)</span> freess_single
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?grp</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fgroup_by_complete fst_conv prod.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fgroup_byD old.prod.case<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> Pabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> map_prod id Pabs <span class="main">|`|</span> <span class="var">?grp</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eq_snd_iff fst_conv fst_map_prod id_def rev_fimage_eqI snd_map_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats'</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs'</span> <span class="skolem">env'</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> irewrite_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">pat</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pats'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats</span><span class="main">)</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env'</span> <span class="main">=</span> <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match_appE_split<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats'</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats'</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> app_pterm_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match_vars<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹match <span class="main">_</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">]</span> match_vars<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹match <span class="main">_</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> Pabs <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|`|</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_pterm.simps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs'</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">rhs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">cs'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">|∈|</span> <span class="skolem">cs</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> old.prod.case rev_fimage_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmadd_drop_left_dom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> match_dom
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> match_dom
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">pats</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt <span class="main">_</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matchs_dom match_list_combE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">rhs</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">t'</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_indep'<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_env <span class="skolem">env<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt <span class="main">(</span>fmdom <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> r_into_rtranclp<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irewrite.intros<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irewrite_stepI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹subst <span class="skolem">rhs</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irewrite.rt_comb<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app_pterm_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> irewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Computability›</span></span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">compile</span></span> <span class="quoted"><span class="quoted">transform_irules</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala SML

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rewriting_Pterm">
<div class="head">
<h1>Theory Rewriting_Pterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pure pattern matching rule sets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rewriting_Pterm
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Rewriting_Pterm_Elim.html">Rewriting_Pterm_Elim</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> prule <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> pterm"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">prule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prule <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prule</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟷</span> wellformed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">∧</span> closed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">∧</span> is_abs <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pruleI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="free">rhs</span> <span class="main">⟹</span> closed <span class="free">rhs</span> <span class="main">⟹</span> is_abs <span class="free">rhs</span> <span class="main">⟹</span> prule <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">locale</span></span> prules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prule fset"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> prule"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fmap<span class="main">:</span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_shadows<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> welldefined_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rewriting›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">prewrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prule fset <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rs</span> <span class="keyword2"><span class="keyword">where</span></span>
step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>p</sub></span></span> Pconst <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span> <span class="main">|</span>
beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>p</sub></span></span> Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted">"fun"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> prewrite<span class="main">:</span> rewriting <span class="quoted"><span class="quoted">"prewrite <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">rs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_pterm_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prewrite_rt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prule fset <span class="main">⇒</span> pterm <span class="main">⇒</span> pterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶*</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">prewrite_rt</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">(</span>prewrite <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Translation from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">irule_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"prule fset"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">finished</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">finished</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> fBall <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">irs</span><span class="main">)</span><span class="main">.</span> arity <span class="bound">irs</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">translate_rhs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irules <span class="main">⇒</span> pterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">translate_rhs</span> <span class="main">=</span> snd <span class="main">∘</span> fthe_elem"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> prule fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="main">=</span> fimage <span class="main">(</span>map_prod id translate_rhs<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> compile <span class="free">rs</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of translation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_zero_shape<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">|}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ppats</span></span> <span class="skolem"><span class="skolem">prhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ppats</span><span class="main">,</span> <span class="skolem">prhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">pats</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_compatible_length<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> all <span class="main">=</span> this

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> proto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">prhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pats</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="bound">pats</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">rhs</span> <span class="main">=</span> <span class="skolem">prhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pats</span> <span class="skolem">rhs</span>
      <span class="keyword3"><span class="command">assume</span></span> cur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pats</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> all <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pats</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> cur <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">with</span></span> proto <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">prhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_fmapD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">prhs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">prhs</span><span class="main">)</span> <span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_fset_is<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> compile_rules<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prules <span class="free">C_info</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def map_prod_def id_apply
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span> C"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> prule"</span></span>
    <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fsubsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">rhs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> compile <span class="free">rs</span>"</span></span> <span class="comment1">(* FIXME clone of compile_correct *)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> translate_rhs <span class="skolem">irs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms inner <span class="keyword1"><span class="command">unfolding</span></span> finished_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">|}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_zero_shape<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> translate_rhs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs_ish <span class="main">[]</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_abs <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> abs_ish_def <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> inner <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">u</span> <span class="main">{||}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv fbspec freess_empty<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"shadows_consts <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fbspec<span class="main">[</span><span class="operator">OF</span> inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">irs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span> compile_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span>
    <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> prule"</span></span>
    <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> pre_constants.shadows_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span> <span class="bound">rhs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> pre_constants.welldefined <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> compile <span class="free">rs</span><span class="main">)</span> <span class="bound">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_heads <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> compile_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rhs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> translate_rhs <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms inner <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finished_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_zero_shape<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irewrite.step<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> translate_rhs_def irewrite_step_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irewrite.intros<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> compile_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">irs</span> <span class="skolem">params</span> <span class="skolem">rhs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span> <span class="quoted"><span class="quoted">"arity <span class="skolem">irs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms inner step <span class="keyword1"><span class="command">unfolding</span></span> finished_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> <span class="main">{|</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹arity_compatibles <span class="skolem">irs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity_zero_shape<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Pconst <span class="skolem">name</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">u</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">→</span> <span class="skolem">t'</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irewrite_step_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">|∈|</span> compile <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">=</span> map_prod id translate_rhs <span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">irs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="skolem">u</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta translate_rhs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prewrite.step<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prewrite.intros<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">compile</span></span> <span class="quoted"><span class="quoted">finished</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Rewriting_Sterm">
<div class="head">
<h1>Theory Rewriting_Sterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sequential pattern matching›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rewriting_Sterm
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Rewriting_Pterm.html">Rewriting_Pterm</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> srule <span class="main">=</span> <span class="quoted"><span class="quoted">"name <span class="main">×</span> sterm"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">closed_srules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closed_srules</span> <span class="main">≡</span> list_all <span class="main">(</span>closed <span class="main">∘</span> snd<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">srule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">srule</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟷</span> wellformed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">∧</span> closed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">∧</span> is_abs <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sruleI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="free">rhs</span> <span class="main">⟹</span> closed <span class="free">rhs</span> <span class="main">⟹</span> is_abs <span class="free">rhs</span> <span class="main">⟹</span> srule <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">locale</span></span> srules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all srule <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_shadows<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> swelldefined_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map <span class="main">(</span>set <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> distinct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_is_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> clausesE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">=</span> Sabs <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_abs <span class="free">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">rhs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_abs_def term_cases_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Rewriting›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">srewrite_step</span> <span class="keyword2"><span class="keyword">where</span></span>
cons_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">srewrite_step</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span> <span class="main">|</span>
cons_nomatch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">name'</span></span></span> <span class="main">⟹</span> <span class="free">srewrite_step</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">⟹</span> <span class="free">srewrite_step</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">name'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs'</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> srewrite_stepI0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_map <span class="main">(</span>set <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"srewrite_step <span class="free">rs</span> <span class="free">name</span> <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name'</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">name'</span><span class="main">,</span> <span class="skolem">rhs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> srewrite_step.cons_nomatch<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> False Cons<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> is_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">=</span> <span class="skolem">rhs'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_mapD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">name</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> srewrite_step.cons_match<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> srules<span class="main">)</span> srewrite_stepI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span> <span class="main">⟹</span> srewrite_step <span class="free">rs</span> <span class="free">name</span> <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> map
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> srewrite_stepI0<span class="main">)</span>

<span class="keyword1"><span class="command">hide_fact</span></span> srewrite_stepI0

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">srewrite</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list <span class="main">⇒</span> sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rs</span> <span class="keyword2"><span class="keyword">where</span></span>
step<span class="main">:</span> <span class="quoted"><span class="quoted">"srewrite_step <span class="free">rs</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span> <span class="main">|</span>
beta<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_first <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted">"fun"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">srewrite</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">srewrite_rt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list <span class="main">⇒</span> sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">⟶*</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">srewrite_rt</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> <span class="main">(</span>srewrite <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> srewrite<span class="main">:</span> rewriting <span class="quoted"><span class="quoted">"srewrite <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">rs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> srewrite.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_sterm_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">srewrite_step</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">srewrite</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Translation from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">pterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In principle, any function of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">×</span></span> <span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> fset <span class="main"><span class="main">⇒</span></span> <span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">×</span></span> <span class="tfree"><span class="tfree">'b</span></span><span class="main"><span class="main">)</span></span> list›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that orders
  by keys would do here. However, For simplicity's sake, we choose a fixed one
  (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ordered_fmap<span class="antiquote"><span class="antiquote">}</span></span></span></span>) here.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pterm_to_sterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> sterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pterm_to_sterm</span> <span class="main">(</span>Pconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pterm_to_sterm</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pterm_to_sterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pterm_to_sterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">pterm_to_sterm</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pterm_to_sterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> Sabs <span class="main">(</span>ordered_fmap <span class="main">(</span>map_prod id <span class="free">pterm_to_sterm</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pterm_to_sterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pterm_to_sterm <span class="free">t</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> free_sterm_def free_pterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_sterm_def const_pterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_sterm_def app_pterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sterm_to_pterm<span class="antiquote"><span class="antiquote">}</span></span></span></span> has to be defined, for technical reasons, in
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Pterm.html"></a><a href="Pterm.html">CakeML_Codegen.Pterm</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pterm_to_sterm_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> list_all_iff_fset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fimageE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> Pabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Pabs<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ordered_fmap_distinct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ordered_map_def
      <span class="keyword1"><span class="command">using</span></span> Pabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pterm_to_sterm_sterm_to_pterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sterm_to_pterm <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fset_of_list_map<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_image<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset.map_comp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> o_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prod.map_comp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> id_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset_map_snd_id<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Pabs<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq snds.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> pterm_to_sterm_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> frees <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pterm_to_sterm_sterm_to_pterm sterm_to_pterm_frees<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> pterm_to_sterm_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="free">S</span> <span class="main">⟹</span> wellformed <span class="free">t</span> <span class="main">⟹</span> closed_except <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pterm_to_sterm_frees<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> pterm_to_sterm_consts<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> consts <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pterm_to_sterm_sterm_to_pterm sterm_to_pterm_consts<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> pterm_to_sterm_shadows<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> shadows_consts <span class="free">t</span> <span class="main">⟷</span> shadows_consts <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pterm_to_sterm_sterm_to_pterm sterm_to_pterm_all_frees<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prule fset <span class="main">⇒</span> srule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> ordered_fmap <span class="main">(</span>map_prod id pterm_to_sterm <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of translation›</span></span>

<span class="keyword1"><span class="command">context</span></span> prules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compile_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> id_apply<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"srules <span class="free">C_info</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all srule <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmap all_rules
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def list_all_iff
    <span class="keyword1"><span class="command">including</span></span> fset.lifting
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_map_set_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> is_map_image<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pterm_to_sterm_wellformed<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pterm_to_sterm_closed<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ a b
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ballE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">a</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_abs_def term_cases_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ordered_fmap_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_list_all<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> id_apply<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fmap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBallI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pterm_to_sterm_consts<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">using</span></span> welldefined_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">rhs</span> <span class="main">|⊆|</span> pre_constants.all_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compile_heads<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> c<span class="main">:</span> constants _ <span class="quoted"><span class="quoted">"fset_of_list <span class="main">(</span>map fst <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> constants_axioms compile_heads<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> all_consts<span class="main">:</span> <span class="quoted"><span class="quoted">"c.all_consts <span class="main">=</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compile_heads<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> fset_of_list_map<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span><span class="main">)</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> list_all_iff_fset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> id_apply
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fact</span> fmap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBall_pred_weaken<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">rhs</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">¬</span></span> shadows_consts <span class="bound"><span class="bound">rhs</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> pterm_to_sterm_shadows<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> not_shadows <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> pre_constants.shadows_consts <span class="free">C_info</span> <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_heads all_consts <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span><span class="main">)</span> C"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset_of_list_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_keys<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> id_apply<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fmap disjnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> prules_as_srules<span class="main">:</span> srules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> compile_rules<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> srelated<span class="main">:</span> term_struct_rel_strong <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> sterm_to_pterm <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">name</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def const_pterm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_sterm_def app_pterm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def const_pterm_def app_sterm_def app_pterm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> srelated_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"srelated.P_env <span class="free">penv</span> <span class="free">senv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>sterm_to_pterm <span class="free">t</span><span class="main">)</span> <span class="free">penv</span> <span class="main">=</span> sterm_to_pterm <span class="main">(</span>subst <span class="free">t</span> <span class="free">senv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">penv</span></span> <span class="quoted"><span class="free">senv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Svar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmrel_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">name</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">including</span></span> fset.lifting
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="skolem">penv</span></span> <span class="quoted"><span class="skolem">senv</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_map image_comp
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sabs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> snds.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sabs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> srewrite_step_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"srewrite_step <span class="free">rs'</span> <span class="free">name</span> <span class="free">rhs</span> <span class="main">⟹</span> <span class="free">rs'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> srewrite_step.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> compile_consE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs'</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span> <span class="main">=</span> compile <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">rhs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs'</span> <span class="main">=</span> pterm_to_sterm <span class="free">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rest</span> <span class="main">=</span> compile <span class="main">(</span><span class="free">rs</span> <span class="main">-</span> <span class="main">{|</span> <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ordered_fmap <span class="main">(</span>map_prod id pterm_to_sterm <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs'</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>ordered_fmap <span class="main">(</span>map_prod id pterm_to_sterm <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">rhs'</span><span class="main">)</span> <span class="main">|∈|</span> map_prod id pterm_to_sterm <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ordered_fmap_sound<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_apply
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs'</span> <span class="main">=</span> pterm_to_sterm <span class="skolem">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rest</span> <span class="main">=</span> compile <span class="main">(</span><span class="free">rs</span> <span class="main">-</span> <span class="main">{|</span> <span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> inj_on_fimage_set_diff<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">rs</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmember.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_fmap <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_fmapD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_remove<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> id_apply
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="free">rhs'</span> <span class="main">=</span> pterm_to_sterm <span class="skolem">rhs</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹ordered_fmap <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> compile_correct_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"srewrite_step <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="free">name</span> <span class="free">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> prule"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> sterm_to_pterm <span class="free">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span>"</span></span> <span class="quoted"><span class="free">name</span></span> <span class="quoted"><span class="free">rhs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons_match <span class="skolem">name</span> <span class="skolem">rhs'</span> <span class="skolem">rest</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs'</span> <span class="main">=</span> pterm_to_sterm <span class="skolem">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> compile_consE<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pterm_to_sterm_sterm_to_pterm<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fbspec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹fBall <span class="skolem">rs</span> prule›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons_nomatch <span class="skolem">name</span> <span class="skolem">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">rest</span> <span class="skolem">rhs</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> pterm_to_sterm <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rest</span> <span class="main">=</span> compile <span class="main">(</span><span class="skolem">rs</span> <span class="main">-</span> <span class="main">{|</span> <span class="main">(</span><span class="skolem">name<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> compile_consE<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">-</span> <span class="main">{|</span> <span class="main">(</span><span class="skolem">name<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> sterm_to_pterm <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="var">?rs'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cons_nomatch<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rest</span> <span class="main">=</span> compile <span class="var">?rs'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="main">(</span><span class="skolem">rs</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">(</span><span class="skolem">name<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">rhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">|}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">rs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_subset<span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBall <span class="var">?rs'</span> prule"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cons_nomatch <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_correct0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"prules <span class="free">C</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> sterm_to_pterm <span class="free">u</span> <span class="main">⟶</span> sterm_to_pterm <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">cs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rewrite_firstE<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="main">(</span>sterm_to_pterm <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env'</span>"</span></span> <span class="quoted"><span class="quoted">"srelated.P_env <span class="skolem">env'</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject option.rel_cases srelated.match_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>sterm_to_pterm <span class="skolem">rhs</span><span class="main">)</span> <span class="skolem">env'</span> <span class="main">=</span> sterm_to_pterm <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> srelated_subst<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rhs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sterm_to_pterm <span class="skolem">rhs</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="var">?rhs'</span><span class="main">)</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id sterm_to_pterm<span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">including</span></span> fset.lifting
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">note</span></span> fset_of_list_map<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prewrite.intros<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rewrite_step.simps
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_option_eq_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rhs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> sterm_to_pterm <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prules_def prules_axioms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compile_correct_step<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prewrite.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prewrite.intros<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prules<span class="main">)</span> compile_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">u</span> <span class="main">⟶</span> <span class="free">u'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> sterm_to_pterm <span class="free">u</span> <span class="main">⟶</span> sterm_to_pterm <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compile_correct0<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">standard</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">hide_fact</span></span> compile_correct0

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Completeness of translation›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> srelated'<span class="main">:</span> term_struct_rel_strong <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> pterm_to_sterm <span class="bound">p</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def const_pterm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">t</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_sterm_def app_pterm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def const_pterm_def app_sterm_def app_pterm_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> srelated_env_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"srelated'.P_env <span class="free">penv</span> <span class="free">senv</span> <span class="main">⟹</span> srelated'.P_env <span class="free">penv</span> <span class="free">senv'</span> <span class="main">⟹</span> <span class="free">senv</span> <span class="main">=</span> <span class="free">senv'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmrel_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> option.rel_sel<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.exhaust_sel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> srelated_subst'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"srelated'.P_env <span class="free">penv</span> <span class="free">senv</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pterm_to_sterm <span class="main">(</span>subst <span class="free">t</span> <span class="free">penv</span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span> <span class="free">senv</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">penv</span></span> <span class="quoted"><span class="free">senv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmrel_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">name</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pabs <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset.map_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_fmap_image<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ordered_fmap_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">cs</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> pat rhs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Pabs<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmember.rep_eq<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">using</span></span> Pabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> srelated_find_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_match <span class="free">cs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">penv</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"srelated'.P_env <span class="free">penv</span> <span class="free">senv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_match <span class="main">(</span>map <span class="main">(</span>map_prod id pterm_to_sterm<span class="main">)</span> <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>pterm_to_sterm <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">senv</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> pterm_to_sterm <span class="free">rhs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>map_prod id pterm_to_sterm<span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pterm_to_sterm <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> pterm_to_sterm <span class="bound">p</span> <span class="main">=</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="var">?cs'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list.rel_map
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list.rel_refl<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">senv0</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_match <span class="var">?cs'</span> <span class="var">?t'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">senv0</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> pterm_to_sterm <span class="free">rhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"srelated'.P_env <span class="free">penv</span> <span class="skolem">senv0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> srelated'.find_match_rel<span class="main">[</span><span class="operator">OF</span> * refl<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">unfolded</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> option_rel_Some1 rel_prod_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">senv</span> <span class="main">=</span> <span class="skolem">senv0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> srelated_env_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">senv</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prules<span class="main">)</span> compile_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> pterm_to_sterm <span class="free">t</span> <span class="main">⟶</span> pterm_to_sterm <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rhs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prules_as_srules.srewrite_stepI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> compile_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset_of_list_elem<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> fmap<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_fmapI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_fmapD<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_fimage_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> beta <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="skolem"><span class="skolem">penv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">penv</span>"</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="skolem">penv</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> map_option_eq_Some rewrite_step.simps surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">senv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="main">(</span>pterm_to_sterm <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">senv</span>"</span></span> <span class="quoted"><span class="quoted">"srelated'.P_env <span class="skolem">penv</span> <span class="skolem">senv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option_rel_Some1 srelated'.match_rel<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> prules.all_rules prule.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>pterm_to_sterm <span class="skolem">rhs</span><span class="main">)</span> <span class="skolem">senv</span> <span class="main">=</span> pterm_to_sterm <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> srelated_subst' <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> <span class="skolem">t'</span>›</span></span> <span class="quoted"><span class="quoted">‹srelated'.P_env <span class="main">_</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> pterm_to_sterm <span class="skolem">rhs</span><span class="main">)</span> <span class="main">|∈|</span> map_prod id pterm_to_sterm <span class="main">|`|</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fimage_eqI id_def map_prod_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> beta
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_match <span class="main">(</span>ordered_fmap <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">penv</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compatible_find_match<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">cs</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ordered_fmap_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">cs</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_set_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> beta<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹is_fmap <span class="skolem">cs</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> fset_of_list_elem ordered_fmap_set_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="main">_</span> <span class="main">=</span> pterm_to_sterm <span class="skolem">t'</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_match_rewrite_first<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_prod_def id_apply
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ordered_fmap_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> srelated_find_match<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> srewrite.intros<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Computability›</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">compile</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Sterm">
<div class="head">
<h1>Theory Big_Step_Sterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Big-step semantics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Sterm
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Rewriting_Sterm.html">Rewriting_Sterm</a>
  <span class="quoted">"<a href="Term_as_Value.html">../Terms/Term_as_Value</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big-step semantics evaluating to irreducible <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> <span class="entity">seval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> sterm<span class="main">)</span> fmap <span class="main">⇒</span> sterm <span class="main">⇒</span> sterm <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span> _<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">↓</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rs</span> <span class="keyword2"><span class="keyword">where</span></span>
const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span> <span class="main">⟹</span> <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span> <span class="main">|</span>
var<span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span> <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main"><span class="free">↓</span></span> Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
comb<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">↓</span></span> Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span> <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span>
  find_match <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> C <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="free">seval</span> <span class="free">rs</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> seval_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed_srules <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> closed_except_sabs<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> closed.match<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_env <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">rhs</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> match_dom<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_sterm.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_frees<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fminus_fsubset_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closed_except_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> funion_fempty_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all closed <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span>list_comb <span class="main">_</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> srules<span class="main">)</span> seval_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_match_elem<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wellformed.match<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wellformed_env <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_sterm.simps subst_wellformed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all wellformed <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span>list_comb <span class="main">_</span> <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wellformed.list_comb app_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed.list_comb const_sterm_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> seval_shadows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"not_shadows_consts_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> srules_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> comb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_consts_env <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> shadows.match<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_sterm.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_shadows<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>Not <span class="main">∘</span> shadows_consts<span class="main">)</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows.list_comb const_sterm_def app_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows.list_comb list_ex_iff list_all_iff const_sterm_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> seval_list_comb_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">name</span> <span class="main">$$</span> <span class="free">args</span> <span class="main">↓</span> Sabs <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">∈</span> dom <span class="main">(</span>map_of <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">$$</span> <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"Sabs <span class="free">cs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name'</span> _ _ <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sabs <span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">name'</span> <span class="main">$$</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_comb_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def app_sterm_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span>Sconst <span class="free">name</span><span class="main">,</span> butlast <span class="skolem">args</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> last <span class="skolem">args</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb_const<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_sterm_def const_sterm_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb_const<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_sterm_def const_sterm_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> butlast <span class="skolem">args</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_strip_comb fst_conv snd_conv<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_comb_cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def app_sterm_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> weak_map_of_SomeI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> is_value_eval_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_value <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">cs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> Sabs <span class="skolem">cs</span> <span class="main">↓</span> Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seval.abs<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_closed_id<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">vs</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>seval <span class="free">rs</span> <span class="free">Γ</span><span class="main">)</span> <span class="skolem">vs</span> <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_refl_strong<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr
        <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">v</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">_</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> C›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seval.constr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> ssubst_eval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"value_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="free">t</span> <span class="free">Γ'</span> <span class="main">↓</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fmlookup <span class="free">Γ'</span> <span class="skolem">name</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> var <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">val'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> var <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="main">=</span> <span class="skolem">val</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fmsubset_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Some<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹<span class="skolem">val'</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_value_eval_id<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> var <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="free">Γ'</span><span class="main">)</span> <span class="skolem">Γ</span> <span class="main">=</span> subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_twice fmsubset_pred<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="free">Γ'</span> <span class="main">↓</span> subst <span class="main">(</span>subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="free">Γ'</span><span class="main">)</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seval.abs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="free">Γ'</span> <span class="main">↓</span> subst <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> seval <span class="free">rs</span> <span class="skolem">Γ</span> <span class="main">(</span>subst <span class="bound">t</span> <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list.rel_mono_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_list_comb list_all2_map1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.constr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructors<span class="main">)</span> seval_agree_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="free">S</span> <span class="free">Γ</span> <span class="main">=</span> fmrestrict_fset <span class="free">S</span> <span class="free">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">|⊆|</span> fmdom <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_srules <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">Γ'</span> <span class="skolem">name</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrestrict_fset <span class="skolem">S</span> <span class="skolem">Γ</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs
    <span class="keyword1"><span class="command">including</span></span> fmap.lifting
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_filter_def fun_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>

  <span class="comment1">― ‹Intentionally local: not really a useful lemma outside of its scope›</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">S</span> <span class="main">(</span>fmrestrict_fset <span class="skolem">T</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> fmrestrict_fset <span class="main">(</span><span class="skolem">T</span> <span class="main">|∪|</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span>fmdrop_fset <span class="skolem">S</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S</span> <span class="skolem">T</span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs fmfilter_comp
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmfilter_cong<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> abs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"subst <span class="skolem">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmrestrict_fset <span class="skolem">S</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> subst <span class="skolem">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_restrict_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"subst <span class="skolem">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmrestrict_fset <span class="skolem">S</span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> subst <span class="skolem">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_restrict_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> subst <span class="skolem">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span> <span class="main">=</span>
         map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seval.abs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> match_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seval.comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Sabs <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">val</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> fmdom <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> fmrestrict_fset <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> fmdom <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> comb<span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs
            <span class="keyword1"><span class="command">including</span></span> fmap.lifting fset.lifting
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_filter_def fun_eq_iff map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> fmrestrict_fset <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="skolem">S</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seval_closed<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">t</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹find_match <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_match_elem<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> closed_except_sabs<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> comb<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">u</span> <span class="skolem">S</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closed.match<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">u'</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> pat <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">pat</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_match_elem<span class="main">)</span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seval_closed<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">u</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seval.constr<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> constr
    <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb list_all_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.intros<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness wrt <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> srewrite<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> srules <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> seval_correct0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="free">t</span> <span class="free">Γ</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"srewrite_step <span class="free">rs</span> <span class="skolem">name</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> srewrite_stepI<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> srewrite.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">u</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_srules <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seval_closed<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">from</span></span> comb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> closed_except_sabs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> match_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">rhs</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_add_shadowed_env<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="skolem">t</span> <span class="skolem">Γ</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="skolem">u</span> <span class="skolem">Γ</span> <span class="main">⟶*</span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> srewrite.rt_comb<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app_sterm_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u'</span> <span class="main">⟶*</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="quoted"><span class="quoted">‹closed <span class="skolem">u'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> srewrite.beta find_match_rewrite_first<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="skolem">rhs</span> <span class="skolem">env</span> <span class="main">⟶*</span> subst <span class="skolem">rhs</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹subst <span class="skolem">rhs</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="skolem">rhs</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">⟶*</span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">u'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closed.match<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_list_comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> srewrite.rt_list_comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> constr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> impE<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> constr<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> closed.list_combE<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> constr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_sterm_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> seval_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom fmempty<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> subst <span class="free">t</span> fmempty <span class="main">⟶*</span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> seval_correct0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Value">
<div class="head">
<h1>Theory Big_Step_Value</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Big_Step_Value
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Big_Step_Sterm.html">Big_Step_Sterm</a>
  <span class="quoted">"<a href="Value.html">../Terms/Value</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big-step semantics evaluating to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">vrule</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vrule <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vrule</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟷</span> vwellformed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">∧</span> vclosed <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">∧</span> <span class="main">¬</span> is_Vconstr <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> vrules <span class="main">=</span> constants <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">C_info</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vrule list"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all_rules<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all vrule <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> not_shadows<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> not_shadows_vconsts <span class="bound">rhs</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vconstructor_value_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"vconstructor_value_rs <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vwelldefined_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> vwelldefined <span class="bound">rhs</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"is_map <span class="main">(</span>set <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> distinct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_is_map<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">value_to_sterm_rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vrule list <span class="main">⇒</span> srule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">value_to_sterm_rules</span> <span class="main">≡</span> map <span class="main">(</span>map_prod id value_to_sterm<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> special_constants<span class="main">)</span>
  <span class="entity">veval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> value<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap <span class="main">⇒</span> sterm <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span> _<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">↓</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">rs</span> <span class="keyword2"><span class="keyword">where</span></span>
const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span> <span class="main">⟹</span> <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span> <span class="main">|</span>
var<span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span> <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main"><span class="free">↓</span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
comb<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">↓</span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟹</span> <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span>
  vfind_match <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
rec_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">↓</span></span> Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟹</span>
  fmlookup <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span>
  vfind_match <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> C <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="free">veval</span> <span class="free">rs</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span>
  <span class="free">rs</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main"><span class="free">↓</span></span> Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vrules<span class="main">)</span> veval_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> const
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> comb
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.vmatch_env<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.vmatch_env<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all vwellformed <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span>list_comb <span class="main">_</span> <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> wellformed.list_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vrules<span class="main">)</span> veval_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> const all_rules
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> pat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_wellformed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb pat
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.vmatch_env veval_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> pat
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vmatch_dom mk_pat_frees list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> pat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_wellformed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pat rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb pat
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.vmatch_env veval_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_clauses <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb pat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed_clauses <span class="skolem">cs</span>›</span></span> pat
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff vmatch_dom mk_pat_frees<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all vclosed <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span><span class="main">_</span> <span class="main">$$</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb wellformed.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vrules<span class="main">)</span> veval_constructor_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vconstructor_value.vmatch_env<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all vconstructor_value <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_all2_rightE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> const
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> vconstructor_value_rs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff vconstructor_value_rs_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vconstructor_value.vmatch_env<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff vconstructor_value_rs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> vrules<span class="main">)</span> veval_welldefined<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> const
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> vwelldefined_rs assms
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwelldefined.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwelldefined.vmatch_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">Γ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">css</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all vwelldefined <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹welldefined <span class="main">(</span><span class="main">_</span> <span class="main">$$</span> <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> welldefined.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abs
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> welldefined_sabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness wrt <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> constructors.seval<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> vrules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rs'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rs'</span> <span class="main">=</span> value_to_sterm_rules <span class="free">rs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_to_sterm_srules<span class="main">:</span> <span class="quoted"><span class="quoted">"srules <span class="free">C_info</span> rs'"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst rs'<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rs'_def
    <span class="keyword1"><span class="command">using</span></span> distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all srule rs'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rs'_def list.pred_map
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.pred_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> all_rules<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.value_to_sterm vwellformed.value_to_sterm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.value_to_sterm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.value_to_sterm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_abs_def term_cases_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list rs'<span class="main">)</span> C"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vconstructor_value_rs <span class="keyword1"><span class="command">unfolding</span></span> rs'_def vconstructor_value_rs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> c<span class="main">:</span> constants _ <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list rs'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fact</span> distinct_ctr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> all_consts<span class="main">:</span> <span class="quoted"><span class="quoted">"c.all_consts <span class="main">=</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c.all_consts_def all_consts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rs'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> shadows_consts<span class="main">:</span> <span class="quoted"><span class="quoted">"c.shadows_consts <span class="skolem">rhs</span> <span class="main">=</span> shadows_consts <span class="skolem">rhs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">rhs</span> <span class="main">::</span> <span class="quoted">sterm</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">rhs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts list_ex_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">rhs</span><span class="main">)</span> rs'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rs'_def
    <span class="keyword1"><span class="command">unfolding</span></span> list.pred_map map_prod_def id_def case_prod_twice list_all_iff
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def all_consts_def
    <span class="keyword1"><span class="command">using</span></span> not_shadows
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> not_shadows_vconsts.value_to_sterm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> c.shadows_consts <span class="bound">rhs</span><span class="main">)</span> rs'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span> rs'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rs'_def list.pred_map
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.pred_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vwelldefined_rs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> z
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">hypsubst_thin</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> vwelldefined.value_to_sterm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map fst <span class="free">rs</span> <span class="main">=</span> map fst rs'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rs'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> welldefined <span class="bound">rhs</span><span class="main">)</span> rs'"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> c.welldefined <span class="bound">rhs</span><span class="main">)</span> rs'"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_consts <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> special_constants<span class="main">)</span> <span class="quoted"><span class="plain_text">‹
  When we evaluate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> veval<span class="antiquote"><span class="antiquote">}</span></span></span></span>, the result is a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which possibly
  contains a closure (constructor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Vabs<span class="antiquote"><span class="antiquote">}</span></span></span></span>). Such a closure is essentially a case-lambda (like
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Sabs<span class="antiquote"><span class="antiquote">}</span></span></span></span>), but with an additionally captured environment of type
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> [source] <span class="quoted"><span class="quoted">"string <span class="main"><span class="main">⇀</span></span> value"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (which is usually called <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ'›</span></span></span></span>). The contained case-lambda might
  not be closed.

  The proof idea is that we can always substitute with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ'›</span></span></span></span> and obtain a regular <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> value.
  The only interesting part of the proof is the case when a case-lambda gets applied to a value,
  because in that process, a hidden environment is <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹unveiled›</span></span>. That environment may not bear any
  relation to the active environment <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ›</span></span></span></span> at all. But pattern matching and substitution proceeds only
  with that hidden environment.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> vrules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> veval_correct0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> value_to_sterm <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>seval rs' <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">(</span>map value_to_sterm <span class="skolem">us</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_map2
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE impE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">u</span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>  <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>›</span></span> constr
        <span class="keyword1"><span class="command">unfolding</span></span> wellformed.list_comb closed.list_comb list_all_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> constr <span class="main"><span class="keyword3">|</span></span> <span class="operator">assumption</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> C›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.constr<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">venv</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>

  <span class="comment1">― ‹We first need to establish a ton of boring side-conditions.›</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_wellformed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>linear <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff split_beta<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option match_related <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">(</span>find_match <span class="skolem">cs</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_match_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval_constructor_value<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">senv</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_match <span class="skolem">cs</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">senv</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_eq <span class="skolem">venv</span> <span class="skolem">senv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vfind_match <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">senv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> find_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">senv</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">senv</span> <span class="main">=</span> fmmap value_to_sterm <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹env_eq <span class="skolem">venv</span> <span class="skolem">senv</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_eq_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_closed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_constructor_value<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vconstructor_value.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_wellformed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">u</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_closed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹
    <span class="antiquoted"><span class="antiquoted">▸</span></span> We know the following (induction hypothesis):
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main"><span class="main">,</span></span> fmmap value_to_sterm <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">Γ'</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="skolem"><span class="skolem">venv</span></span><span class="main"><span class="main">)</span></span> <span class="keyword1"><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="main"><span class="main">↓</span></span> value_to_sterm <span class="skolem"><span class="skolem">val</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

    <span class="antiquoted"><span class="antiquoted">▸</span></span> ... first, we can deduce using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] ssubst_eval<span class="antiquote"><span class="antiquote">}</span></span></span></span> that this is equivalent to
      substituting <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>rhs›</span></span></span></span> first:
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main"><span class="main">,</span></span> fmmap value_to_sterm <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">Γ'</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="skolem"><span class="skolem">venv</span></span><span class="main"><span class="main">)</span></span> <span class="keyword1"><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="var"><span class="var">?subst</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="main"><span class="main">↓</span></span> value_to_sterm <span class="skolem"><span class="skolem">val</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

    <span class="antiquoted"><span class="antiquoted">▸</span></span> ... second, we can replace the hidden environment <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ'›</span></span></span></span> by the active environment <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ›</span></span></span></span>
      using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] seval_agree_eq<span class="antiquote"><span class="antiquote">}</span></span></span></span> because it does not contain useful information at this
      point:
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main"><span class="main">,</span></span> fmmap value_to_sterm <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">Γ</span></span> <span class="keyword1"><span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span></span> <span class="skolem"><span class="skolem">venv</span></span><span class="main"><span class="main">)</span></span> <span class="keyword1"><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="var"><span class="var">?subst</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="main"><span class="main">↓</span></span> value_to_sterm <span class="skolem"><span class="skolem">val</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

    <span class="antiquoted"><span class="antiquoted">▸</span></span> ... finally we can apply a step in the original semantics and arrive at the conclusion:
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main"><span class="main">,</span></span> fmmap value_to_sterm <span class="skolem"><span class="skolem">Γ</span></span> <span class="keyword1"><span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword1"><span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="main"><span class="main">↓</span></span> value_to_sterm <span class="skolem"><span class="skolem">val</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  ›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ssubst_eval<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> fmdom <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_pat_frees vmatch_dom<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed_venv <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed_venv <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vconstructor_value_env <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹vconstructor_value_env <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="main">(</span>fmdom <span class="skolem">venv</span><span class="main">)</span> <span class="skolem">Γ'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span>"</span></span>
        <span class="keyword1"><span class="command">including</span></span> fmap.lifting fset.lifting
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_drop_set_def map_filter_def map_le_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmdrop_fset_fmmap fmmap_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span>fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.value_to_sterm_env<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"value_env <span class="main">(</span>fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vconstructor_value.value_to_sterm_env<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seval.comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t</span> <span class="main">↓</span> value_to_sterm <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="var">?subst</span> <span class="bound">pat</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span> <span class="main">↓</span> value_to_sterm <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">senv</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seval_agree_eq<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rs'<span class="main">,</span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span><span class="main">)</span> <span class="main">=</span>
                fmrestrict_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">senv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">senv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdom_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmadd_restrict_right_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdom_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmadd_restrict_right_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>value_to_sterm <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.value_to_sterm<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.value_to_sterm_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_srules rs'"</span></span>
            <span class="keyword1"><span class="command">using</span></span> all_rules
            <span class="keyword1"><span class="command">unfolding</span></span> rs'_def list_all_iff
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.value_to_sterm<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"find_match <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="var">?subst</span> <span class="bound">pat</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">senv</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹find_match <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_match_map<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹Basically a verbatim copy from the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>comb›</span></span> case›</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">venv</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> the <span class="main">(</span>fmlookup <span class="skolem">css</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_wellformed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹convenient hack: <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">cs</span></span><span class="antiquote">}</span></span> is not really part of a <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Vabs</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>linear <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff split_beta<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option match_related <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">u'</span><span class="main">)</span> <span class="main">(</span>find_match <span class="skolem">cs</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_match_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval_constructor_value<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">senv</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_match <span class="skolem">cs</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">senv</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"env_eq <span class="skolem">venv</span> <span class="skolem">senv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vfind_match <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">senv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> find_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">senv</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> match_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">senv</span> <span class="main">=</span> fmmap value_to_sterm <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹env_eq <span class="skolem">venv</span> <span class="skolem">senv</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_eq_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_closed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_constructor_value<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vconstructor_value <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_constructor_value<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vconstructor_value.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_wellformed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">u</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> veval_closed<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">venv</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">pat</span> <span class="bound">t</span><span class="main">.</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="bound">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ssubst_eval<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> fmdom <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mk_pat_frees vmatch_dom<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed_venv <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed_venv <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vconstructor_value_env <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹vconstructor_value_env <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="main">(</span>fmdom <span class="skolem">venv</span><span class="main">)</span> <span class="skolem">Γ'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span>"</span></span>
        <span class="keyword1"><span class="command">including</span></span> fmap.lifting fset.lifting
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_drop_set_def map_filter_def map_le_def map_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span><span class="main">)</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmdrop_fset_fmmap fmmap_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span>fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.value_to_sterm_env<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"value_env <span class="main">(</span>fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vconstructor_value.value_to_sterm_env<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seval.comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t</span> <span class="main">↓</span> value_to_sterm <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Sabs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="var">?subst</span> <span class="bound">pat</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span> <span class="main">↓</span> value_to_sterm <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">senv</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seval_agree_eq<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rs'<span class="main">,</span> fmmap value_to_sterm <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">venv</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="main">↓</span> value_to_sterm <span class="skolem">val</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span><span class="main">)</span> <span class="main">=</span>
                fmrestrict_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">senv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">senv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdom_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmadd_restrict_right_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdom_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmadd_restrict_right_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>value_to_sterm <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.value_to_sterm<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>subst <span class="skolem">rhs</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span> <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">Γ'</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">venv</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.value_to_sterm_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmmap value_to_sterm <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmmap value_to_sterm <span class="skolem">venv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">venv</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_srules rs'"</span></span>
            <span class="keyword1"><span class="command">using</span></span> all_rules
            <span class="keyword1"><span class="command">unfolding</span></span> rs'_def list_all_iff
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.value_to_sterm<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"find_match <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="var">?subst</span> <span class="bound">pat</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>value_to_sterm <span class="skolem">u'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">senv</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="var">?subst</span> <span class="skolem">pat</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹find_match <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_match_map<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> seval.const<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rs'_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abs
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fmdrop_fset_fmmap <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.abs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> seval.var seval.abs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> veval_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> value_to_sterm <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rs'<span class="main">,</span> fmmap value_to_sterm fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> value_to_sterm <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veval_correct0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fmmap_empty<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Big_Step_Value_ML">
<div class="head">
<h1>Theory Big_Step_Value_ML</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big-step semantics with conflation of constants and variables›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Big_Step_Value_ML
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Big_Step_Value.html">Big_Step_Value</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_rec_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> sclauses<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mk_rec_env</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">=</span> fmmap_keys <span class="main">(</span><span class="main">λ</span><span class="bound">name</span> <span class="bound">cs</span><span class="main">.</span> Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="bound">name</span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> special_constants <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">veval'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap <span class="main">⇒</span> sterm <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">↓</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∉|</span> C <span class="main">⟹</span> fmlookup <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
var<span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main"><span class="free">↓</span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
comb<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">↓</span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span>
  vfind_match <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
rec_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"
  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">↓</span></span> Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="main">⟹</span>
  fmlookup <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">⟹</span>
  vfind_match <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">u'</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ'</span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span> <span class="main">⟹</span>
  <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span> <span class="main">|</span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> C <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="free">veval'</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main"><span class="free">↓</span></span> Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veval'_sabs_svarE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Sabs <span class="free">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="free">n</span> <span class="main">↓</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u'</span> <span class="free">env</span> <span class="free">pat</span> <span class="free">rhs</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="free">Γ</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">u'</span>"</span></span>
          <span class="quoted"><span class="quoted">"vfind_match <span class="free">cs</span> <span class="free">u'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">rhs</span> <span class="main">↓</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="main">(</span>Sabs <span class="free">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="free">n</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb_const<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> rec_comb
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">cs'</span> <span class="skolem">Γ'</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="free">Γ</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Svar <span class="free">n</span> <span class="main">↓</span> <span class="skolem">u'</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ts</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> free_sterm_def<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">=</span> <span class="skolem">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Sabs <span class="free">cs</span> <span class="main">↓</span> Vabs <span class="skolem">cs'</span> <span class="skolem">Γ'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veval'_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> comb
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.vmatch_env<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmpred_add<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vwellformed.vmatch_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdom'I<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all vwellformed <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="main">_</span> <span class="main">$$</span> <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_sterm_def wellformed.list_comb<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> veval'_shadows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> comb
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmpred_add<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>not_shadows_vconsts<span class="main">)</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shadows.list_comb app_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> veval'_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vmatch_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">u'</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vmatch_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed_clauses <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmpred_add<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">Γ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vclosed.vmatch_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdom'I<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">css</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed_clauses <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmpred_add<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veval'_wellformed vwellformed.vmatch_env<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all vclosed <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span><span class="main">_</span> <span class="main">$$</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="main">_</span> <span class="main">$$</span> <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb wellformed.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">vwelldefined'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vwelldefined'</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">vwelldefined'</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vwelldefined'</span> <span class="main">(</span>Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟷</span>
  pred_fmap id <span class="main">(</span>fmmap <span class="free">vwelldefined'</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">∧</span>
  list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">t</span> <span class="main">|⊆|</span> <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">|∪|</span> C<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span>
  fdisjnt C <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vwelldefined'</span> <span class="main">(</span>Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟷</span>
  pred_fmap id <span class="main">(</span>fmmap <span class="free">vwelldefined'</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">∧</span>
  pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span>
    list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">t</span> <span class="main">|⊆|</span> fmdom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">|∪|</span> <span class="main">(</span>C <span class="main">|∪|</span> fmdom <span class="free"><span class="bound"><span class="entity">css</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">cs</span> <span class="main">∧</span>
    fdisjnt C <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> fmdom <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">∧</span>
  fdisjnt C <span class="main">(</span>fmdom <span class="free"><span class="bound"><span class="entity">css</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vmatch_welldefined'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="free">pat</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> vmatch_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ps</span> <span class="skolem">name'</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">envs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty <span class="skolem">envs</span>"</span></span> <span class="quoted"><span class="quoted">"map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span> <span class="main">=</span> map Some <span class="skolem">envs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> those_someD<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">∈</span> set <span class="skolem">envs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">env</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">env</span> <span class="main">∈</span> set <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹map2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="skolem">p</span> <span class="skolem">v</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map2_elemE<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> constr<span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="comment1">(* FIXME ad hoc rules after introduction of "constants" locale *)</span>
<span class="keyword1"><span class="command">lemma</span></span> sconsts_list_comb<span class="main">:</span>
   <span class="quoted"><span class="quoted">"consts <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟷</span> consts <span class="free">f</span> <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> consts <span class="bound">x</span> <span class="main">|⊆|</span> <span class="free">S</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sconsts_sabs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">t</span> <span class="main">|⊆|</span> <span class="free">S</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff ffUnion_alt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ffUnion_least_rev<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> list_all_iff_fset<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff fset_of_list_elem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> veval'_welldefined'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> fmdom <span class="free">Γ</span> <span class="main">|∪|</span> C"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sconsts_sabs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> C"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> C›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vmatch_welldefined' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ'</span> <span class="main">|∪|</span> <span class="main">(</span>C <span class="main">|∪|</span> fmdom <span class="skolem">css</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">css</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed_clauses <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vmatch_welldefined'<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">css</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed_clauses <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all vwelldefined' <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> constr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> wellformed.list_comb shadows.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> consts_list_comb<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> special_constants<span class="main">)</span> <span class="quoted"><span class="plain_text">‹Correctness wrt <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> veval<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> vrules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following relation can be characterized as follows:
  <span class="antiquoted"><span class="antiquoted">▪</span></span> Values have to have the same structure. (We prove an interpretation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> value_struct_rel<span class="antiquote"><span class="antiquote">}</span></span></span></span>.)
  <span class="antiquoted"><span class="antiquoted">▪</span></span> For closures, the captured environments must agree on constants and variables occurring in the
    body.
  The first <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">value</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> argument is from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> veval<span class="antiquote"><span class="antiquote">}</span></span></span></span> (i.e. from
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Big_Step_Value.html"></a><a href="Big_Step_Value.html">CakeML_Codegen.Big_Step_Value</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>), the second from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> veval'<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="comment1">(* FIXME move into locale *)</span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">vrelated</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> value <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">≈</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">vrelated</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="main">⟹</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main"><span class="free">≈</span></span> Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span>"</span></span> <span class="main">|</span>
abs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free">vrelated</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span>
   fmrel_on_fset <span class="main">(</span>consts <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free">vrelated</span> <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span>
     <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≈</span></span> Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
rec_abs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span>
    fmrel_on_fset <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> <span class="free">vrelated</span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span>
    fmrel_on_fset <span class="main">(</span>consts <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> <span class="free">vrelated</span> <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">⟹</span>
     <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> fmdom <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">⟹</span>
     <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≈</span></span> Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Perhaps unexpectedly, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">vrelated</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not reflexive. The reason is that it does not just check
  syntactic equality including captured environments, but also adherence to the external rules.
›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> vrelated<span class="main">:</span> value_struct_rel <span class="quoted">vrelated</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"veq_structure <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> vrelated.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> list.rel_mono_strong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> vrelated.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> vrelated.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">name'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ts</span> <span class="skolem">us</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Vconstr <span class="skolem">name</span> <span class="skolem">ts</span> <span class="main">≈</span> Vconstr <span class="skolem">name'</span> <span class="skolem">us</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span> <span class="main">∧</span> list_all2 vrelated <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Vconstr <span class="skolem">name</span> <span class="skolem">ts</span> <span class="main">≈</span> Vconstr <span class="skolem">name'</span> <span class="skolem">us</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 vrelated <span class="skolem">ts</span> <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> vrelated.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The technically involved relation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">vrelated</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implies a weaker, but more intuitive property:
  If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">≈</span></span> <span class="free"><span class="free">u</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> are equal after termification (i.e. conversion with
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">value_to_sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>). In fact, if both terms are ground terms, it collapses to equality. This
  follows directly from the interpretation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> value_struct_rel<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veval'_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> vrelated <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="free">t</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">{|</span><span class="skolem">name</span><span class="main">|}</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{|</span></span><span class="skolem"><span class="skolem">name</span></span><span class="main"><span class="main">|}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> const <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmap_of_list_SomeD<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval.const<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">{|</span><span class="skolem">name</span><span class="main">|}</span> vrelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{|</span></span><span class="skolem"><span class="skolem">name</span></span><span class="main"><span class="main">|}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> var <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval.var<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> abs
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> veval.abs vrelated.abs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="bound">v</span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span> <span class="main">≈</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">≈</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≈</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod <span class="main">(</span>fmrel vrelated<span class="main">)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vrelated.vfind_match_rel'<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fmrel vrelated <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval_welldefined<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> fset_of_list_map<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">val<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="bound">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="skolem">rhs</span><span class="main">)</span> vrelated <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">name</span>"</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel vrelated <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">name</span>"</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"frees <span class="skolem"><span class="skolem">rhs</span></span> <span class="main"><span class="main">|-|</span></span> frees <span class="skolem"><span class="skolem">pat</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmrel_on_fsetD<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="skolem">rhs</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> consts <span class="skolem">rhs</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBexI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem ffUnion_alt_def<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmrel_on_fsetD<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span> <span class="main">≠</span> None"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fmdom_notI<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span> <span class="main">|∪|</span> C"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> consts <span class="skolem">rhs</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">pat</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff shadows_consts_def all_consts_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def fdisjnt_alt_def all_consts_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwelldefined.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval_welldefined<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval.comb<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="comment1">― ‹Almost verbatim copy from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>comb›</span></span> case.›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="bound">v</span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v</span> <span class="main">≈</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span> <span class="main">≈</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≈</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod <span class="main">(</span>fmrel vrelated<span class="main">)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vrelated.vfind_match_rel'<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fmrel vrelated <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vfind_match <span class="skolem">cs</span> <span class="skolem">u'<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval_welldefined<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> fset_of_list_map<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">val<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="bound">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> rec_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fdisjnt all_consts <span class="main">(</span>frees <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> shadows_consts_frees<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>›</span></span> rec_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="skolem">rhs</span><span class="main">)</span> vrelated <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">css</span> <span class="main">|⊆|</span> all_consts"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vrecabs <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> all_consts_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">css</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt <span class="main">_</span> <span class="main">(</span>frees <span class="skolem">rhs</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> fempty_iff finterI fset_rev_mp<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span>
                <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">name</span>"</span></span>
                <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel vrelated <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span>
                <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">name</span>"</span></span>
                <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span> <span class="main">=</span> fmlookup <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">css</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"frees <span class="skolem"><span class="skolem">rhs</span></span> <span class="main"><span class="main">|-|</span></span> frees <span class="skolem"><span class="skolem">pat</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmrel_on_fsetD<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="skolem">rhs</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> consts <span class="skolem">rhs</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBexI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem ffUnion_alt_def<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmrel_on_fsetD<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span> <span class="main">≠</span> None"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fmdom_notI<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="main">_</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> rec_comb
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> rec_comb
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span> <span class="main">|∪|</span> C"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> consts <span class="skolem">rhs</span>›</span></span> all_consts_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">pat</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff shadows_consts_def all_consts_def<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def fdisjnt_alt_def all_consts_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwelldefined.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval_welldefined<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ'<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">val<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="skolem">val<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval.rec_comb<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ts</span> <span class="skolem">us<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">rs</span><span class="main">,</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">t</span> <span class="main">↓</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">ts</span> <span class="skolem">us<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> conjE impE allE exE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> set <span class="skolem">us<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> welldefined.list_comb wellformed.list_comb shadows.list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span>
        <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">t</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map consts <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">t</span> <span class="main">|⊆|</span> consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> consts_list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ffUnion_subset_elem le_supI2<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="skolem">t</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">|∈|</span> fset_of_list <span class="main">(</span>map frees <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">|⊆|</span> frees <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> frees_list_comb const_sterm_def freess_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ffUnion_subset_elem<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span> vrelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> constr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>veval <span class="free">rs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 vrelated <span class="skolem">us<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">us<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> constr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veval.constr vrelated.constr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veval'_correct'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="free">t</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list <span class="free">rs</span><span class="main">)</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> veval'_correct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="hidden">⇩</span><sub>1</sub> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">fmempty</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined<span class="main">)</span> fmempty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> vrelated fmempty <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Preservation of extensional equality›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constants<span class="main">)</span> veval'_agree_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="free">t</span><span class="main">)</span> erelated <span class="free">Γ'</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> fmdom <span class="free">Γ</span> <span class="main">|∪|</span> C"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sconst <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> const <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option erelated <span class="main">(</span>fmlookup <span class="skolem">Γ'</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmrel_on_fsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">Γ'</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">val'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">val</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> const <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veval'.const<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="skolem">val</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> ids <span class="main">(</span>Svar <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> var <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option erelated <span class="main">(</span>fmlookup <span class="skolem">Γ'</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmrel_on_fsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">Γ'</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">val'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">val</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> var <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veval'.var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Vabs <span class="skolem">cs</span> <span class="skolem">Γ'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> erelated.abs<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> veval'.abs<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="skolem">u</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> erelated <span class="skolem">Γ'</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> erelated.cases<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">u</span><span class="main">)</span> erelated <span class="skolem">Γ'</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> comb.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod <span class="main">(</span>fmrel erelated<span class="main">)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> erelated.vfind_match_rel'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env'</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">|∪|</span> C"</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">val'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> comb.IH<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmrel_fmdom_eq<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">id</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>"</span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_option erelated <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env'</span><span class="main">)</span> <span class="skolem">id</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">id</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ids_def
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> A
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> fmdom <span class="skolem">env</span> <span class="main">|∪|</span> fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> A
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> fmdom <span class="skolem">env'</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> B
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∉|</span> fmdom <span class="skolem">env'</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∉|</span> fmdom <span class="skolem">env</span>›</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> B
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrelD<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_welldefined'<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">val'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> veval'.comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_comb <span class="skolem">Γ</span> <span class="skolem">t</span> <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="skolem">cs</span> <span class="skolem">u</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env</span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">val</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> erelated <span class="skolem">Γ'</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="skolem">css</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> erelated.cases<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">u</span><span class="main">)</span> erelated <span class="skolem">Γ'</span> <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rec_comb.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod <span class="main">(</span>fmrel erelated<span class="main">)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">(</span>vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> erelated.vfind_match_rel'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env'</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec_comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">|∪|</span> <span class="main">(</span>C <span class="main">|∪|</span> fmdom <span class="skolem">css</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">css</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">val'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">val'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">val'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">val</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rec_comb.IH<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff closed_except_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmrel_fmdom_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span><span class="main">)</span> <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">unfolding</span></span> option.rel_map
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> erelated.intros<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="skolem">css</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="skolem">css</span>›</span></span> rec_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">=</span> fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">id</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>"</span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_option erelated <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env'</span><span class="main">)</span> <span class="skolem">id</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="skolem">id</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ids_def
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> A
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> fmdom <span class="skolem">env</span> <span class="main">|∪|</span> fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
                  <span class="keyword3"><span class="command">case</span></span> A
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> fmdom <span class="skolem">env'</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword3"><span class="command">case</span></span> B
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="skolem">rhs</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∉|</span> fmdom <span class="skolem">env'</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∉|</span> fmdom <span class="skolem">env</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">=</span> fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span><span class="main">)</span>›</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>›</span></span><span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span><span class="main">)</span> <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>›</span></span><span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> B
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">pat</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">rhs</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command">unfolding</span></span> fset_of_list_elem
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> fmdom <span class="skolem">env'</span>›</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">=</span> fmdom <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrelD<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>›</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span><span class="main">)</span> <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrelD<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel erelated <span class="skolem">env'</span> <span class="skolem">env</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetD<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fmpred_add<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_welldefined'<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">css</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def mk_rec_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="main">(</span>Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">val'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> veval'.rec_comb<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub>'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rec_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="skolem">ts</span> <span class="skolem">us</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="bound">t</span><span class="main">)</span> erelated <span class="skolem">Γ'</span> <span class="skolem">Γ</span> <span class="main">∧</span> closed_except <span class="bound">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span> <span class="main">∧</span> wellformed <span class="bound">t</span> <span class="main">∧</span> consts <span class="bound">t</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C <span class="main">∧</span> <span class="main">¬</span> shadows_consts <span class="bound">t</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_allI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> constr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ids_list_comb
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> closed.list_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> wellformed.list_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> consts_list_comb
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set constr.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> special_constants.sconsts_list_comb<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> shadows.list_comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">t</span> <span class="main">↓</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="bound">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">u</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">us'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">_</span> <span class="skolem">ts</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span> <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">.</span> <span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">t</span> <span class="main">↓</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="bound">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">u</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">us'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> erelated <span class="skolem">Γ'</span> <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">t</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_venv <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed_venv <span class="skolem">Γ</span>›</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">Γ</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts_env <span class="skolem">Γ</span>›</span></span> Cons.hyps
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all3_cons<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> constr.prems<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.constr<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> us <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">us'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all3 <span class="main">_</span> <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">us'</span>›</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> erelated.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all3 <span class="main">_</span> <span class="skolem">ts</span> <span class="skolem">us</span> <span class="skolem">us'</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Doc_Preproc">
<div class="head">
<h1>Theory Doc_Preproc</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Preprocessing of code equations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Doc_Preproc
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Eval_Class">
<div class="head">
<h1>Theory Eval_Class</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A type class for correspondence between HOL expressions and terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Eval_Class
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Rewriting_Term.html">../Rewriting/Rewriting_Term</a>"</span>
  <span class="quoted">"<a href="ML_Utils.html">../Utils/ML_Utils</a>"</span>
  <a href="../Deriving/Derive_Manager.html">Deriving.Derive_Manager</a>
  <span class="quoted">"<a href="../Dict_Construction/Dict_Construction.html">Dict_Construction.Dict_Construction</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> Mpat_Antiquot.mpaq_App <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$$</span>"</span> 900<span class="main">)</span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Strong_Term.wellformed
<span class="keyword1"><span class="command">declare</span></span> Strong_Term.wellformed_term_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">class</span></span> evaluate <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">eval</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule fset <span class="main">⇒</span> term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1">⊢</span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span>_ <span class="keyword1"><span class="keyword1"><span class="keyword1">≈</span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span>"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eval_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main"><span class="free">⊢</span></span> <span class="free">t</span> <span class="main"><span class="free">≈</span></span> <span class="free">a</span> <span class="main">⟹</span> wellformed <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule fset <span class="main">⇒</span> term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢</span><span class="keyword3">/ </span><span class="keyword3">(</span>_ <span class="keyword1">↓</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟷</span> wellformed <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶*</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⊢</span> <span class="bound">t'</span> <span class="main">≈</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval'I<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">≈</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eval'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval'E<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">≈</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eval'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_trivI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">≈</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eval_wellformed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">↓</span> <span class="free">a</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t'</span> <span class="main">⟶*</span> <span class="skolem">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">t''</span> <span class="main">≈</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="skolem">t''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">evaluate</span><span class="main">,</span> <span class="quoted">evaluate</span><span class="main">)</span> <span class="quoted">evaluate</span> <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">eval_fun</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_fun</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">⟷</span> wellformed <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">t<span class="hidden">⇩</span><sub>x</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⊢</span> <span class="bound">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="bound">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">corollary</span></span> eval_funD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">≈</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eval_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> eval'_funD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">≈</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">⟶*</span> <span class="skolem">t'</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rewrite.rt_fun<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> app_term_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">t'</span> <span class="main">≈</span> <span class="free">f</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_funD<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>x</sub></span> <span class="main">↓</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_compose<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">t</span><span class="main">.</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="bound">t</span> <span class="main">↓</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">t</span> <span class="main">↓</span> <span class="free">a</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">f</span> <span class="main">≈</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> eval_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> eval'_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">t</span><span class="main">.</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="bound">t</span> <span class="main">↓</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">t</span> <span class="main">↓</span> <span class="free">a</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">f</span> <span class="main">↓</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval'I<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wellformed <span class="free">f</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp.rtrancl_refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_ext<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval'_ext_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>evaluate <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>evaluate"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">1</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">x</span><span class="main">.</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="bound">u</span> <span class="main">↓</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">[</span><span class="bound">u</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">↓</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="keyword1">Λ</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval'_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span><span class="keyword1">Λ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="keyword1">Λ</span> <span class="free">t</span> <span class="main">$</span> <span class="skolem">u</span> <span class="main">↓</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval_compose<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span><span class="keyword1">Λ</span> <span class="free">t</span> <span class="main">$</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="keyword1">Λ</span> <span class="free">t</span> <span class="main">$</span> <span class="skolem">u</span> <span class="main">⟶*</span> <span class="free">t</span> <span class="main">[</span><span class="skolem">u</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rewrite.beta<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">[</span><span class="skolem">u</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span> <span class="main">↓</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="skolem">u</span> <span class="main">↓</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_impl_wellformed<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">≈</span> <span class="free">a</span> <span class="main">⟹</span> wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wellformed_inc eval_wellformed<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wellformed_term_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval'_impl_wellformed<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">↓</span> <span class="free">a</span> <span class="main">⟹</span> wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> eval'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wellformed_inc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_unpack<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟹</span> wellformed' <span class="free">n</span> <span class="free">u</span>"</span></span>
  <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> wellformed' <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_bound_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">&lt;</span> Suc <span class="free">m</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">=</span> Suc <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">m</span> <span class="main">=</span> Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> True <span class="keyword1">then</span> <span class="free">P</span> <span class="keyword1">else</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> False <span class="keyword1">then</span> <span class="free">P</span> <span class="keyword1">else</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">Q</span>"</span></span>
  <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">named_theorems</span></span> eval_data_intros
<span class="keyword1"><span class="command">named_theorems</span></span> eval_data_elims

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* for code generation, used in Tactics.code_tac *)</span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rewrite_step_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">×</span> term <span class="main">⇒</span> term <span class="main">⇒</span> term option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rewrite_step_term</span> <span class="main">=</span> rewrite_step"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> rewrite_rt_fun <span class="main">=</span> rewrite.rt_fun<span class="main">[</span><span class="operator">unfolded</span> app_term_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> rewrite_rt_arg <span class="main">=</span> rewrite.rt_arg<span class="main">[</span><span class="operator">unfolded</span> app_term_def<span class="main">]</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"tactics.ML"</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> wellformed <span class="main">=</span> <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">Tactics.wellformed_tac</span><span class="main">)</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/tactics.ML">
<div class="head">
<h1>File ‹tactics.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">TACTICS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rs</span> <span class="main">=</span> <span class="main">{</span>rs_def<span class="main">:</span> thm<span class="main">,</span> simps<span class="main">:</span> thm list<span class="main">,</span> restrict<span class="main">:</span> string list option<span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> wellformed_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> beta_reduce_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> rewrite_step_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rs</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> rewrite_beta_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> rewrite_single_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rs</span> option <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> rewrite_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rs</span> option <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> rewrite1_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="entity">rs</span> option <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> elims_wellformed<span class="main">:</span> thm <span class="main">-&gt;</span> thm list
  <span class="keyword1"><span class="keyword">val</span></span> elims_injects<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> thm <span class="main">-&gt;</span> thm list
  <span class="keyword1"><span class="keyword">val</span></span> eval_ext_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> eval_app_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> eval_assm_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> eval_data_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> eval_base_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> eval_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Tactics</span> <span class="main">:</span> <span class="entity">TACTICS</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">rs</span> <span class="main">=</span> <span class="main">{</span>rs_def<span class="main">:</span> thm<span class="main">,</span> simps<span class="main">:</span> thm list<span class="main">,</span> restrict<span class="main">:</span> string list option<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elims_wellformed</span> <span class="entity">thm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span> <span class="entity">cat_options</span> <span class="main">(</span>map <span class="main">(</span>try <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">t</span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> wellformed_unpack<span class="antiquote">}</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">thms</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      maps <span class="entity">elims_wellformed</span> <span class="entity">thms</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">gather_wellformed</span> <span class="entity">thms</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_wellformed</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> wellformed'<span class="antiquote">}</span></span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> true
      <span class="main">|</span> <span class="entity">is_wellformed</span> <span class="main">_</span> <span class="main">=</span> false
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dest_eval</span> <span class="entity">thm</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> Thm.prop_of <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval'<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
          try <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span> OF <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval'_impl_wellformed<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
      <span class="main">|</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
          try <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span> OF <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval_impl_wellformed<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span>
          NONE

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">derived_wellformed</span> <span class="main">=</span> <span class="entity">cat_options</span> <span class="main">(</span>map <span class="entity">dest_eval</span> <span class="entity">thms</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">existing_wellformed</span> <span class="main">=</span> filter <span class="main">(</span><span class="entity">is_wellformed</span> o Thm.prop_of<span class="main">)</span> <span class="entity">thms</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    maps <span class="entity">elims_wellformed</span> <span class="main">(</span><span class="entity">derived_wellformed</span> @ <span class="entity">existing_wellformed</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_tac</span> <span class="main">=</span> <span class="entity">Code_Simp.static_tac</span> <span class="main">{</span>consts <span class="main">=</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> wellformed'<span class="antiquote">}</span></span><span class="main">]</span><span class="main">,</span> ctxt <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">,</span> simpset <span class="main">=</span> NONE<span class="main">}</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">wellformed_tac</span> <span class="main">=</span> <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_wellformed</span> <span class="main">=</span> <span class="entity">gather_wellformed</span> <span class="entity">prems</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span>
      <span class="entity">code_tac</span> <span class="entity">ctxt</span> THEN_ALL_NEW
        REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI TrueI<span class="antiquote">}</span></span></span> @ <span class="entity">all_wellformed</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    HEADGOAL <span class="main">(</span>SOLVED' <span class="main">(</span>REPEAT_ALL_NEW <span class="entity">tac</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">replace_bound_simps</span> <span class="main">=</span>
  map <span class="entity">safe_mk_meta_eq</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> replace_bound_aux replace_bound.simps incr_bounds.simps incr_bounds_zero<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">beta_reduce_tac</span> <span class="main">=</span> <span class="entity">Subgoal.FOCUS_PREMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">replace_bound_eqs</span> <span class="main">=</span>
      <span class="entity">gather_wellformed</span> <span class="entity">prems</span>
      |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">safe_mk_meta_eq</span> <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> wellformed_replace_bound_eq<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> Raw_Simplifier.rewrite <span class="entity">ctxt</span> false <span class="main">(</span><span class="entity">replace_bound_eqs</span> @ <span class="entity">replace_bound_simps</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    HEADGOAL <span class="main">(</span>CHANGED o CONVERSION <span class="entity">conv</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_beta_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> r_into_rtranclp<span class="antiquote">}</span></span></span> THEN'
    <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rewrite_beta_alt<span class="antiquote">}</span></span></span> <span class="entity">CONTINUE_WITH</span>
      <span class="main">[</span><span class="entity">beta_reduce_tac</span> <span class="entity">ctxt</span> THEN' resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> refl<span class="antiquote">}</span></span></span><span class="main">,</span>
       <span class="entity">wellformed_tac</span> <span class="entity">ctxt</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">local</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_tac</span> <span class="main">=</span>
  <span class="entity">Code_Simp.static_tac</span> <span class="main">{</span>consts <span class="main">=</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> rewrite_step_term<span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> HOL.eq<span class="antiquote">}</span></span><span class="main">]</span><span class="main">,</span> ctxt <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">,</span> simpset <span class="main">=</span> NONE<span class="main">}</span>

<span class="keyword2"><span class="keyword">in</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_step_tac</span> <span class="entity">ctxt</span> <span class="main">{</span><span class="entity">rs_def</span><span class="main">,</span> <span class="entity">simps</span><span class="main">,</span> <span class="entity">restrict</span><span class="main">}</span> <span class="main">=</span> <span class="entity">Subgoal.FOCUS_PREMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">restrict</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">restrict</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> I
    <span class="main">|</span> SOME <span class="entity">names</span> <span class="main">=&gt;</span> filter <span class="main">(</span>member <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span> <span class="entity">names</span> o fst o dest_Const o fst o strip_comb o fst<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rules</span> <span class="main">=</span>
      map <span class="main">(</span>Logic.dest_equals o Thm.prop_of<span class="main">)</span> <span class="entity">simps</span>
      |&gt; <span class="entity">restrict</span>
      |&gt; map <span class="main">(</span><span class="entity">HOLogic.mk_prod</span> o <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">apply</span> 2<span class="antiquote">}</span></span></span> <span class="main">(</span><span class="entity">HOL_Term.mk_term</span> true<span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">elem</span> <span class="main">=</span> REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> finsertI1 finsertI2<span class="antiquote">}</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">try_rule</span> <span class="entity">r</span> <span class="main">=</span>
      resolve_tac <span class="entity">ctxt</span> <span class="main">[</span>Drule.infer_instantiate <span class="entity">ctxt</span> <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"r"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">r</span><span class="main">)</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rewrite.step<span class="antiquote">}</span></span></span><span class="main">]</span> <span class="entity">CONTINUE_WITH_FW</span>
        <span class="main">[</span>SELECT_GOAL <span class="main">(</span>Local_Defs.unfold_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rs_def</span><span class="main">]</span><span class="main">)</span> THEN' <span class="entity">elem</span><span class="main">,</span>
         <span class="entity">code_tac</span> <span class="entity">ctxt</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> r_into_rtranclp<span class="antiquote">}</span></span></span> THEN' FIRST' <span class="main">(</span>map <span class="main">(</span>SOLVED' o <span class="entity">try_rule</span><span class="main">)</span> <span class="entity">rules</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">ctxt</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_single_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">do_rec</span> <span class="entity">n</span> <span class="entity">st</span> <span class="main">=</span> <span class="entity">rewrite_single_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span> <span class="entity">n</span> <span class="entity">st</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems_tac</span> <span class="main">=</span> SOLVED' <span class="main">(</span><span class="entity">Method.assm_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">step_tac</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">opt_rs</span> <span class="keyword2"><span class="keyword">of</span></span>
      NONE <span class="main">=&gt;</span> K no_tac
    <span class="main">|</span> SOME <span class="entity">rs</span> <span class="main">=&gt;</span> <span class="entity">rewrite_step_tac</span> <span class="entity">ctxt</span> <span class="entity">rs</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">beta_tac</span> <span class="main">=</span> <span class="entity">rewrite_beta_tac</span> <span class="entity">ctxt</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fun_tac</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rewrite_rt_fun<span class="antiquote">}</span></span></span> THEN' SOLVED' <span class="entity">do_rec</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">arg_tac</span> <span class="main">=</span> resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rewrite_rt_arg<span class="antiquote">}</span></span></span> THEN' SOLVED' <span class="entity">do_rec</span>
  <span class="keyword2"><span class="keyword">in</span></span> FIRST' <span class="main">[</span><span class="entity">prems_tac</span><span class="main">,</span> <span class="entity">beta_tac</span><span class="main">,</span> <span class="entity">step_tac</span><span class="main">,</span> <span class="entity">fun_tac</span><span class="main">,</span> <span class="entity">arg_tac</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rtranclp_trans<span class="antiquote">}</span></span></span> <span class="entity">CONTINUE_WITH_FW</span>
    <span class="main">[</span>SOLVED' <span class="main">(</span><span class="entity">rewrite_single_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span><span class="main">)</span><span class="main">,</span>
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">rewrite_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span> <span class="entity">n</span><span class="main">)</span><span class="main">]</span> ORELSE'
    resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rtranclp.rtrancl_refl<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rewrite1_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rtranclp_trans<span class="antiquote">}</span></span></span> <span class="entity">CONTINUE_WITH_FW</span>
    <span class="main">[</span>SOLVED' <span class="main">(</span><span class="entity">rewrite_single_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span><span class="main">)</span><span class="main">,</span>
     <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span> <span class="entity">rewrite_tac</span> <span class="entity">ctxt</span> <span class="entity">opt_rs</span> <span class="entity">n</span><span class="main">)</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elims_injects</span> <span class="entity">ctxt</span> <span class="entity">injects</span> <span class="entity">thm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thms</span> <span class="main">=</span>
      map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> try <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span> OF <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> iffD1<span class="antiquote">}</span></span></span><span class="main">)</span> <span class="main">[</span><span class="entity">i</span><span class="main">,</span> <span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="entity">injects</span>
      |&gt; <span class="entity">cat_options</span>
      |&gt; maps <span class="main">(</span><span class="entity">HOLogic.conj_elims</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">thms</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      maps <span class="main">(</span><span class="entity">elims_injects</span> <span class="entity">ctxt</span> <span class="entity">injects</span><span class="main">)</span> <span class="entity">thms</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_ext_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eval'_ext_alt<span class="antiquote">}</span></span></span> <span class="entity">CONTINUE_WITH_FW</span>
    <span class="main">[</span><span class="entity">wellformed_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
     <span class="entity">beta_reduce_tac</span> <span class="entity">ctxt</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eval_app_tac</span> <span class="main">=</span>
  <span class="entity">fo_rtac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval'_funD<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eval_assm_tac</span> <span class="main">=</span> <span class="entity">Subgoal.FOCUS_PREMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
  HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="entity">prems</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_data_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intros</span> <span class="main">=</span> <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> eval_data_intros<span class="antiquote">}</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    resolve_tac <span class="entity">ctxt</span> <span class="entity">intros</span> THEN'
      SOLVED' <span class="main">(</span><span class="entity">wellformed_tac</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
      SOLVED' <span class="main">(</span><span class="entity">rewrite_tac</span> <span class="entity">ctxt</span> NONE<span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eval_base_tac</span> <span class="main">=</span> resolve_tac

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_tac</span> <span class="entity">ctxt</span> <span class="entity">base_thms</span> <span class="main">=</span>
  REPEAT_ALL_NEW <span class="main">(</span><span class="entity">ANY'</span>
    <span class="main">[</span><span class="entity">eval_data_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
     <span class="entity">eval_base_tac</span> <span class="entity">ctxt</span> <span class="entity">base_thms</span><span class="main">,</span>
     <span class="entity">eval_assm_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
     <span class="entity">eval_app_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
     <span class="entity">eval_ext_tac</span> <span class="entity">ctxt</span><span class="main">]</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Embed">
<div class="head">
<h1>Theory Embed</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deep embedding of Pure terms into term-rewriting logic›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Embed
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Constructor_Funs/Constructor_Funs.html">Constructor_Funs.Constructor_Funs</a>
  <span class="quoted">"<a href="Code_Utils.html">../Utils/Code_Utils</a>"</span>
  <a href="Eval_Class.html">Eval_Class</a>
<span class="keyword2"><span class="keyword">keywords</span></span> <span class="quoted">"embed"</span> <span class="main">::</span> thy_decl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">non_overlapping'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">non_overlapping'</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">non_overlapping'</span> <span class="main">(</span>Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">$</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">non_overlapping'</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">$</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">non_overlapping'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">non_overlapping'</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∨</span> <span class="free">non_overlapping'</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">non_overlapping'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> non_overlapping_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_overlapping' <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"non_overlapping <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> non_overlapping'.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pattern_compatible'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pattern_compatible'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">pattern_compatible'</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟶</span> <span class="free">pattern_compatible'</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pattern_compatible'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∨</span> non_overlapping' <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pattern_compatible_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pattern_compatible' <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pattern_compatible <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pattern_compatible.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_1"</span> <span class="comment1">(* FIXME intro rule setup for non_overlapping is broken *)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> non_overlapping_approx<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="quoted">"2_5"</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> non_overlapping_approx<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pattern_compatibles'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pattern_compatibles'</span> <span class="main">≡</span> fpairwise <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">(</span><span class="bound">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> pattern_compatible' <span class="bound">lhs<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">lhs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rules'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> rule fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rules'</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⟷</span>
  fBall <span class="free"><span class="bound"><span class="entity">rs</span></span></span> rule <span class="main">∧</span>
  arity_compatibles <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">∧</span>
  is_fmap <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">∧</span>
  pattern_compatibles' <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">∧</span>
  fBall <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> pre_constants.shadows_consts <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">(</span>heads_of <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="bound">lhs</span><span class="main">)</span> <span class="main">∧</span>
  fdisjnt <span class="main">(</span>heads_of <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span>constructors.C <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span> <span class="main">∧</span>
  fBall <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> pre_constants.welldefined <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">(</span>heads_of <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="bound">rhs</span><span class="main">)</span> <span class="main">∧</span>
  distinct <span class="main">(</span>constructors.all_constructors <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rules_approx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rules' <span class="free">C_info</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rules <span class="free">C_info</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> rule"</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"is_fmap <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">lhs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> pre_constants.shadows_consts <span class="free">C_info</span> <span class="main">(</span>heads_of <span class="free">rs</span><span class="main">)</span> <span class="bound">lhs</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fBall <span class="free">rs</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> pre_constants.welldefined <span class="free">C_info</span> <span class="main">(</span>heads_of <span class="free">rs</span><span class="main">)</span> <span class="bound">rhs</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>heads_of <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>constructors.C <span class="free">C_info</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>constructors.all_constructors <span class="free">C_info</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rules'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles' <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rules'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pattern_compatibles <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fpairwise_weaken<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pattern_compatible_approx<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> embed_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≡</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"embed.ML"</span>

<span class="keyword1"><span class="command">consts</span></span> <span class="quoted">"lift_term"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> term"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">setup</span></span><span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">embed</span> <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lift_term<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">HOL_Term.mk_term</span> false <span class="entity">t</span>
      <span class="main">|</span> <span class="entity">embed</span> <span class="main">(</span><span class="entity">t</span> $ <span class="entity">u</span><span class="main">)</span> <span class="main">=</span> <span class="entity">embed</span> <span class="entity">t</span> $ <span class="entity">embed</span> <span class="entity">u</span>
      <span class="main">|</span> <span class="entity">embed</span> <span class="entity">t</span> <span class="main">=</span> <span class="entity">t</span>
  <span class="keyword2"><span class="keyword">in</span></span> Context.theory_map <span class="main">(</span>Syntax_Phases.term_check <span class="inner_numeral">99</span> <span class="inner_quoted">"lift"</span> <span class="main">(</span>K <span class="main">(</span>map <span class="entity">embed</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="files/embed.ML">
<div class="head">
<h1>File ‹embed.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">EMBED</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> eval_typ<span class="main">:</span> typ <span class="main">-&gt;</span> typ

  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">embed_proof</span> <span class="main">=</span> <span class="entity">No_Auto</span> <span class="main">|</span> <span class="entity">Simp</span> <span class="main">|</span> <span class="entity">Eval</span>
  <span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">cert_proof</span> <span class="main">=</span> <span class="entity">Cert</span> <span class="main">|</span> <span class="entity">Skip</span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">embed_opts</span> <span class="main">=</span> <span class="main">{</span>proof<span class="main">:</span> <span class="entity">embed_proof</span><span class="main">,</span> cert<span class="main">:</span> <span class="entity">cert_proof</span><span class="main">}</span>
  <span class="keyword1"><span class="keyword">val</span></span> default_opts<span class="main">:</span> <span class="entity">embed_opts</span>

  <span class="keyword1"><span class="keyword">val</span></span> embed_def<span class="main">:</span> <span class="main">(</span>binding * <span class="entity">Attrib.binding</span><span class="main">)</span> <span class="main">-&gt;</span> term list <span class="main">-&gt;</span> <span class="entity">embed_opts</span> <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span>
    <span class="main">(</span><span class="main">(</span>term * thm * term * thm option<span class="main">)</span> * local_theory<span class="main">)</span>
  <span class="keyword1"><span class="keyword">val</span></span> embed_def_cmd<span class="main">:</span> <span class="entity">Attrib.binding</span> <span class="main">-&gt;</span> binding <span class="main">-&gt;</span> string list <span class="main">-&gt;</span> <span class="entity">embed_opts</span> <span class="main">-&gt;</span> local_theory <span class="main">-&gt;</span>
    <span class="entity">Proof.state</span>

  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">fun_info</span> <span class="main">=</span>
    <span class="main">{</span>rs<span class="main">:</span> term<span class="main">,</span>
     rs_def<span class="main">:</span> thm<span class="main">,</span>
     base_embeds<span class="main">:</span> thm list<span class="main">,</span>
     consts<span class="main">:</span> <span class="main">(</span>string * int<span class="main">)</span> list<span class="main">,</span>
     inducts<span class="main">:</span> thm list option<span class="main">,</span>
     simps<span class="main">:</span> thm list<span class="main">}</span>

  <span class="keyword1"><span class="keyword">val</span></span> embed_tac<span class="main">:</span> <span class="entity">fun_info</span> <span class="main">-&gt;</span> <span class="entity">cert_proof</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> embed_ext_tac<span class="main">:</span> <span class="entity">fun_info</span> <span class="main">-&gt;</span> <span class="entity">cert_proof</span> <span class="main">-&gt;</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic

  <span class="keyword1"><span class="keyword">val</span></span> debug<span class="main">:</span> bool Config.T
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Embed</span><span class="main">:</span> <span class="entity">EMBED</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="comment1">(* FIXME copied from skip_proof.ML *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">make_thm_cterm</span><span class="main">)</span> <span class="main">=</span>
  Context.&gt;&gt;&gt;
    <span class="main">(</span>Context.map_theory_result <span class="main">(</span>Thm.add_oracle <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> eval_oracle<span class="antiquote">}</span></span></span><span class="main">,</span> I<span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_thm</span> <span class="entity">ctxt</span> <span class="entity">prop</span> <span class="main">=</span> <span class="entity">make_thm_cterm</span> <span class="main">(</span>Thm.cterm_of <span class="entity">ctxt</span> <span class="entity">prop</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cheat_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span> <span class="entity">st</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">make_thm</span> <span class="entity">ctxt</span> <span class="main">(</span>Var <span class="main">(</span><span class="main">(</span><span class="inner_quoted">"A"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> propT<span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="entity">i</span> <span class="entity">st</span>

<span class="comment1">(** utilities **)</span>
<span class="comment1">(* FIXME copied from dict_construction.ML *)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">debug</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "embed_debug"<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">if_debug</span> <span class="entity">ctxt</span> <span class="entity">f</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">debug</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">f</span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ALLGOALS'</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">debug</span> <span class="keyword2"><span class="keyword">then</span></span> ALLGOALS <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">PARALLEL_ALLGOALS</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove'</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">debug</span> <span class="keyword2"><span class="keyword">then</span></span> Goal.prove <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">else</span></span> Goal.prove_future <span class="entity">ctxt</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_common'</span> <span class="entity">ctxt</span> <span class="main">=</span> Goal.prove_common <span class="entity">ctxt</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">debug</span> <span class="keyword2"><span class="keyword">then</span></span> NONE <span class="keyword2"><span class="keyword">else</span></span> SOME <span class="inner_numeral">~1</span><span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eval_typ</span> <span class="entity">typ</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"rule fset"</span><span class="antiquote">}</span></span> --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">term</span><span class="antiquote">}</span></span> --&gt; <span class="entity">typ</span> --&gt; <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">bool</span><span class="antiquote">}</span></span>

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">embed_proof</span> <span class="main">=</span> <span class="entity">No_Auto</span> <span class="main">|</span> <span class="entity">Simp</span> <span class="main">|</span> <span class="entity">Eval</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">cert_proof</span> <span class="main">=</span> <span class="entity">Cert</span> <span class="main">|</span> <span class="entity">Skip</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">embed_opts</span> <span class="main">=</span> <span class="main">{</span>proof<span class="main">:</span> <span class="entity">embed_proof</span><span class="main">,</span> cert<span class="main">:</span> <span class="entity">cert_proof</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">default_opts</span> <span class="main">=</span> <span class="main">{</span>proof <span class="main">=</span> <span class="entity">Simp</span><span class="main">,</span> cert <span class="main">=</span> <span class="entity">Cert</span><span class="main">}</span>

<span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">all_typs</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">typ</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">typ</span> :: maps <span class="entity">all_typs</span> <span class="entity">args</span>
  <span class="main">|</span> <span class="entity">all_typs</span> <span class="main">_</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_tac</span> <span class="main">=</span>
  <span class="entity">Code_Simp.static_tac</span>
    <span class="main">{</span>consts <span class="main">=</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> rules'<span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> fmdom<span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> fmempty<span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> fmupd<span class="antiquote">}</span></span><span class="main">]</span><span class="main">,</span>
     ctxt <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span><span class="main">,</span>
     simpset <span class="main">=</span> NONE<span class="main">}</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">fun_info</span> <span class="main">=</span>
  <span class="main">{</span>rs<span class="main">:</span> term<span class="main">,</span>
   rs_def<span class="main">:</span> thm<span class="main">,</span>
   base_embeds<span class="main">:</span> thm list<span class="main">,</span>
   consts<span class="main">:</span> <span class="main">(</span>string * int<span class="main">)</span> list<span class="main">,</span>
   inducts<span class="main">:</span> thm list option<span class="main">,</span>
   simps<span class="main">:</span> thm list<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">embed_ext_tac</span> <span class="main">{</span><span class="entity">inducts</span><span class="main">,</span> <span class="entity">simps</span><span class="main">,</span> <span class="entity">rs_def</span><span class="main">,</span> <span class="entity">base_embeds</span><span class="main">,</span> <span class="entity">consts</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="entity">cert</span> <span class="main">=</span>
  <span class="entity">Subgoal.FOCUS_PARAMS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">concl</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">if_debug</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span>
        tracing <span class="main">(</span><span class="inner_quoted">"Proving "</span> ^ Syntax.string_of_term <span class="entity">ctxt</span> <span class="main">(</span>Thm.term_of <span class="entity">concl</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">elims</span> <span class="main">=</span> <span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> eval_data_elims<span class="antiquote">}</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">names</span> <span class="main">=</span> map fst <span class="entity">consts</span>

      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get_vars</span> <span class="entity">t</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
          Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval'<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="main">_</span> $ <span class="entity">t</span> $ <span class="entity">x</span> <span class="main">=&gt;</span>
            <span class="main">(</span>map Free <span class="main">(</span>Term.add_frees <span class="entity">t</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> rev <span class="main">(</span>map Free <span class="main">(</span>Term.add_frees <span class="entity">x</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">tss</span><span class="main">,</span> <span class="entity">xss</span><span class="main">)</span> <span class="main">=</span>
        Logic.dest_conjunctions <span class="main">(</span>Thm.term_of <span class="entity">concl</span><span class="main">)</span>
        |&gt; map <span class="main">(</span><span class="entity">HOLogic.dest_Trueprop</span> o Logic.strip_imp_concl<span class="main">)</span>
        |&gt; map <span class="entity">get_vars</span>
        |&gt; split_list

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span>
        <span class="entity">Refine_Util.HOL_concl_conv</span> <span class="main">(</span>K <span class="main">(</span>Conv.arg_conv <span class="main">(</span>Conv.rewrs_conv <span class="main">(</span>map <span class="entity">safe_mk_meta_eq</span> <span class="entity">simps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span>

      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cert_tac</span> <span class="main">=</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">cert</span> <span class="keyword2"><span class="keyword">of</span></span>
          <span class="entity">Skip</span> <span class="main">=&gt;</span> <span class="entity">cheat_tac</span> <span class="entity">ctxt</span>
        <span class="main">|</span> <span class="entity">Cert</span> <span class="main">=&gt;</span> SOLVED' <span class="main">(</span><span class="entity">Tactics.eval_tac</span> <span class="entity">ctxt</span> <span class="entity">base_embeds</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">maybe_induct_tac</span> <span class="entity">inducts</span> <span class="entity">xss</span> <span class="entity">tss</span> <span class="entity">ctxt</span> THEN <span class="entity">ALLGOALS'</span> <span class="entity">ctxt</span>
        <span class="main">(</span>CONVERSION <span class="entity">conv</span> THEN'
          <span class="entity">TRY'</span> <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="entity">elims</span><span class="main">)</span><span class="main">)</span> THEN'
          resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eval_compose<span class="antiquote">}</span></span></span> <span class="entity">CONTINUE_WITH_FW</span>
            <span class="main">[</span><span class="entity">Tactics.wellformed_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
             <span class="comment1">(* requires full rewriting: rule from ruleset may apply only if arguments are
                rewritten first *)</span>
             <span class="entity">Tactics.rewrite1_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>SOME <span class="main">{</span>rs_def <span class="main">=</span> <span class="entity">rs_def</span><span class="main">,</span> simps <span class="main">=</span> <span class="entity">simps</span><span class="main">,</span> restrict <span class="main">=</span> SOME <span class="entity">names</span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
             <span class="entity">cert_tac</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">embed_tac</span> <span class="entity">info</span> <span class="entity">cert</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">consts</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> <span class="entity">info</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">loop</span> <span class="inner_numeral">0</span> <span class="main">=</span> K all_tac
      <span class="main">|</span> <span class="entity">loop</span> <span class="entity">n</span> <span class="main">=</span>
          <span class="entity">fo_rtac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval'_ext<span class="antiquote">}</span></span></span> <span class="entity">ctxt</span> <span class="entity">CONTINUE_WITH_FW</span>
            <span class="main">[</span><span class="entity">Tactics.wellformed_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
             <span class="entity">loop</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">loops</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">loop</span> o snd<span class="main">)</span> <span class="entity">consts</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    SELECT_GOAL
      <span class="main">(</span>HEADGOAL <span class="main">(</span>Goal.conjunction_tac <span class="entity">CONTINUE_WITH</span> <span class="entity">loops</span><span class="main">)</span> THEN
        Goal.recover_conjunction_tac<span class="main">)</span> <span class="entity">CONTINUE_WITH</span>
      <span class="main">[</span><span class="entity">TRY'</span> <span class="main">(</span><span class="entity">norm_all_conjunction_tac</span> <span class="entity">ctxt</span><span class="main">)</span> THEN' <span class="entity">embed_ext_tac</span> <span class="entity">info</span> <span class="entity">cert</span> <span class="entity">ctxt</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extend</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lhs</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Logic.dest_equals <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">head</span><span class="main">,</span> <span class="entity">args</span><span class="main">)</span> <span class="main">=</span> Term.strip_comb <span class="entity">lhs</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pretty</span> <span class="main">=</span> Syntax.string_of_term <span class="entity">ctxt</span> <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fun_type</span> <span class="main">=</span> can <span class="main">(</span>Term.dest_funT o fastype_of<span class="main">)</span> <span class="entity">head</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> not <span class="entity">fun_type</span> <span class="keyword2"><span class="keyword">then</span></span>
      error <span class="main">(</span><span class="inner_quoted">"Implementation restriction: can't deal with non-function constant: "</span> ^ <span class="entity">pretty</span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> null <span class="entity">args</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> embed_ext<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">embed_def</span> <span class="main">(</span><span class="entity">binding</span><span class="main">,</span> <span class="entity">def_binding</span><span class="main">)</span> <span class="entity">terms</span> <span class="main">{</span><span class="entity">proof</span><span class="main">,</span> <span class="entity">cert</span><span class="main">}</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">consts</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> Syntax.check_terms <span class="entity">lthy</span> <span class="entity">terms</span> |&gt; map dest_Const |&gt; split_list
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
      Pretty.block
        <span class="main">(</span>Pretty.str <span class="inner_quoted">"Defining the embedding(s) of "</span> ::
          Pretty.separate <span class="inner_quoted">""</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">pretty_const</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">consts</span><span class="main">)</span><span class="main">)</span>
      |&gt; Pretty.writeln

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">config_ctxt</span> <span class="main">=</span>
      <span class="entity">lthy</span>
      |&gt; Config.put <span class="entity">Constructor_Funs.enabled</span> true
      |&gt; Config.put <span class="entity">Pattern_Compatibility.enabled</span> true
      |&gt; Config.put <span class="entity">Dynamic_Unfold.enabled</span> true

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code_eqss</span> <span class="main">=</span> <span class="entity">Dict_Construction.group_code_eqs</span> <span class="entity">config_ctxt</span> <span class="entity">consts</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">raw_eqs</span> <span class="main">=</span>
      flat <span class="entity">code_eqss</span>
      |&gt; maps <span class="main">(</span>snd o snd<span class="main">)</span>
      |&gt; map snd
      |&gt; <span class="entity">cat_options</span>
      |&gt; map <span class="main">(</span>Thm.prop_of o <span class="entity">extend</span> <span class="entity">lthy</span> o Conv.fconv_rule <span class="main">(</span><span class="entity">Dict_Construction.normalizer_conv</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eqs</span> <span class="main">=</span> map <span class="entity">HOL_Term.mk_eq</span> <span class="entity">raw_eqs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rs</span> <span class="main">=</span> <span class="entity">mk_fset</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"term <span class="main">×</span> term"</span><span class="antiquote">}</span></span> <span class="entity">eqs</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">C_info</span> <span class="main">=</span>
      maps <span class="entity">all_consts</span> <span class="entity">raw_eqs</span>
      |&gt; map snd
      |&gt; maps <span class="entity">all_typs</span>
      |&gt; distinct <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span>
      |&gt; map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">typ</span> <span class="main">=&gt;</span> Option.map <span class="main">(</span>pair <span class="entity">typ</span><span class="main">)</span> <span class="main">(</span>try <span class="main">(</span><span class="entity">HOL_Datatype.mk_dt_def</span> <span class="entity">lthy</span><span class="main">)</span> <span class="entity">typ</span><span class="main">)</span><span class="main">)</span>
      |&gt; <span class="entity">cat_options</span>
      |&gt; map <span class="main">(</span>apfst <span class="entity">mk_name</span><span class="main">)</span>
      |&gt; <span class="entity">mk_fmap</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">name</span><span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">dt_def</span><span class="antiquote">}</span></span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">C_info_binding</span> <span class="main">=</span> Binding.qualify_name true <span class="entity">binding</span> <span class="inner_quoted">"C_info"</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">rs_term</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">rs_def</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy'</span><span class="main">)</span> <span class="main">=</span>
      Local_Theory.define <span class="main">(</span><span class="main">(</span><span class="entity">binding</span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">def_binding</span><span class="main">,</span> <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">C_info_term</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">C_info_def</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy'</span><span class="main">)</span> <span class="main">=</span>
      Local_Theory.define <span class="main">(</span><span class="main">(</span><span class="entity">C_info_binding</span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Thm.def_binding <span class="entity">C_info_binding</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="entity">C_info</span><span class="main">)</span><span class="main">)</span> <span class="entity">lthy'</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">rules</span><span class="antiquote">}</span></span> $ <span class="entity">C_info_term</span> $ <span class="entity">rs_term</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">eval</span> <span class="entity">ctxt</span> <span class="main">=</span>
      HEADGOAL <span class="main">(</span><span class="entity">fo_rtac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> rules_approx<span class="antiquote">}</span></span></span> <span class="entity">ctxt</span><span class="main">)</span> THEN
        Local_Defs.unfold_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">rs_def</span><span class="main">,</span> <span class="entity">C_info_def</span><span class="main">]</span> THEN
        <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">eval</span> <span class="keyword2"><span class="keyword">then</span></span>
           HEADGOAL <span class="main">(</span><span class="entity">eval_tac</span> <span class="entity">ctxt</span><span class="main">)</span>
         <span class="keyword2"><span class="keyword">else</span></span>
           Local_Defs.unfold_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> rules'_def<span class="antiquote">}</span></span></span> THEN
             HEADGOAL <span class="main">(</span>REPEAT_ALL_NEW <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> conjI<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span> THEN
             <span class="entity">ALLGOALS'</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">code_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">proof</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">No_Auto</span> <span class="main">=&gt;</span> NONE
      <span class="main">|</span> <span class="entity">Eval</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">prove'</span> <span class="entity">lthy'</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">prop</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="entity">tac</span> true <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">Simp</span> <span class="main">=&gt;</span> SOME <span class="main">(</span><span class="entity">prove'</span> <span class="entity">lthy'</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">prop</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="entity">tac</span> false <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Option.map <span class="main">(</span><span class="entity">on_thms_complete</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> writeln <span class="inner_quoted">"Proved wellformedness"</span><span class="main">)</span> o single<span class="main">)</span> <span class="entity">thm</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_embed</span> <span class="entity">code_eqs</span> <span class="main">(</span><span class="entity">base_simps</span><span class="main">,</span> <span class="entity">base_embeds</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> exists <span class="main">(</span>null o snd o snd<span class="main">)</span> <span class="entity">code_eqs</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="comment1">(* constructor *)</span>
        <span class="main">(</span><span class="entity">base_simps</span><span class="main">,</span> <span class="entity">base_embeds</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="comment1">(* proper definition *)</span>
        <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">consts</span><span class="main">,</span> <span class="entity">simps</span><span class="main">)</span> <span class="main">=</span>
            map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">eqs</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">count</span><span class="main">,</span> <span class="entity">eqs</span><span class="main">)</span> <span class="main">=</span>
                  split_list <span class="main">(</span>map <span class="main">(</span>apfst <span class="main">(</span>length o fst<span class="main">)</span><span class="main">)</span> <span class="entity">eqs</span><span class="main">)</span>
                  |&gt;&gt; distinct <span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span> |&gt;&gt; the_single
                  ||&gt; <span class="entity">cat_options</span>
              <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">count</span><span class="main">)</span><span class="main">,</span> <span class="entity">eqs</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">code_eqs</span>
            |&gt; split_list
            ||&gt; flat ||&gt; map <span class="main">(</span>Conv.fconv_rule <span class="main">(</span><span class="entity">Dict_Construction.normalizer_conv</span> <span class="entity">lthy'</span><span class="main">)</span><span class="main">)</span>

          <span class="comment1">(* FIXME the whole treatment of type variables here is probably wrong *)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">const_terms</span> <span class="main">=</span>
            map <span class="main">(</span>Const o rpair dummyT o fst<span class="main">)</span> <span class="entity">consts</span>
            |&gt; Syntax.check_terms <span class="entity">lthy'</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fun_induct</span> <span class="main">=</span> Option.mapPartial <span class="main">#</span>inducts <span class="main">(</span>try <span class="main">(</span><span class="entity">Function.get_info</span> <span class="entity">lthy'</span><span class="main">)</span> <span class="main">(</span>hd <span class="entity">const_terms</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bnf_induct</span> <span class="main">=</span> <span class="entity">induct_of_bnf_const</span> <span class="entity">lthy'</span> <span class="main">(</span>hd <span class="entity">const_terms</span><span class="main">)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">inducts</span> <span class="main">=</span> merge_options <span class="main">(</span><span class="entity">fun_induct</span><span class="main">,</span> <span class="entity">bnf_induct</span><span class="main">)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
            <span class="keyword2"><span class="keyword">if</span></span> is_none <span class="entity">inducts</span> <span class="keyword1"><span class="keyword">andalso</span></span> length <span class="entity">simps</span> &gt; <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">then</span></span>
              warning <span class="main">(</span><span class="inner_quoted">"No induction rule found (could be problematic). Did you run this through declassify?"</span><span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">info</span><span class="main">:</span> <span class="entity">fun_info</span> <span class="main">=</span>
            <span class="main">{</span>rs <span class="main">=</span> <span class="entity">rs_term</span><span class="main">,</span>
             rs_def <span class="main">=</span> <span class="entity">rs_def</span><span class="main">,</span>
             base_embeds <span class="main">=</span> <span class="entity">base_embeds</span><span class="main">,</span>
             consts <span class="main">=</span> <span class="entity">consts</span><span class="main">,</span>
             simps <span class="main">=</span> <span class="entity">simps</span> @ <span class="entity">base_simps</span><span class="main">,</span>
             inducts <span class="main">=</span> <span class="entity">inducts</span><span class="main">}</span>

          <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_goal</span> <span class="main">(</span><span class="entity">const</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span>
            Term.list_comb
              <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval'<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">eval_typ</span> dummyT<span class="main">)</span><span class="main">,</span>
               <span class="main">[</span><span class="entity">rs_term</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Const<span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="entity">const</span><span class="main">,</span> Const <span class="main">(</span><span class="entity">const</span><span class="main">,</span> dummyT<span class="main">)</span><span class="main">]</span><span class="main">)</span>
            |&gt; <span class="entity">HOLogic.mk_Trueprop</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goals</span> <span class="main">=</span> Syntax.check_terms <span class="entity">lthy'</span> <span class="main">(</span>map <span class="entity">mk_goal</span> <span class="entity">consts</span><span class="main">)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">embeds</span> <span class="main">=</span>
            <span class="entity">prove_common'</span> <span class="entity">lthy'</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goals</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
              HEADGOAL <span class="main">(</span><span class="entity">embed_tac</span> <span class="entity">info</span> <span class="entity">cert</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">msg</span> <span class="main">=</span>
            Pretty.block
              <span class="main">(</span>Pretty.str <span class="inner_quoted">"Proved the embedding(s) of "</span> ::
                Pretty.separate <span class="inner_quoted">""</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">pretty_const</span> <span class="entity">lthy'</span><span class="main">)</span> <span class="main">(</span>map fst <span class="entity">consts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            |&gt; Pretty.string_of

          <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">on_thms_complete</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> writeln <span class="entity">msg</span><span class="main">)</span> <span class="entity">embeds</span>
        <span class="keyword2"><span class="keyword">in</span></span>
          <span class="main">(</span><span class="entity">simps</span> @ <span class="entity">base_simps</span><span class="main">,</span> <span class="entity">embeds</span> @ <span class="entity">base_embeds</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">embeds</span><span class="main">)</span> <span class="main">=</span> fold <span class="entity">prove_embed</span> <span class="entity">code_eqss</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">lthy''</span><span class="main">)</span> <span class="main">=</span> <span class="entity">note_thms</span> <span class="entity">binding</span> <span class="entity">embeds</span> <span class="entity">lthy'</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">(</span><span class="entity">rs_term</span><span class="main">,</span> <span class="entity">rs_def</span><span class="main">,</span> <span class="entity">C_info_term</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy''</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">method_text_of_tac</span> <span class="entity">tac</span> <span class="main">=</span>
  <span class="entity">Method.Basic</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Context_Tactic.CONTEXT_TACTIC</span> <span class="main">(</span><span class="entity">tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">embed_def_cmd</span> <span class="entity">def_binding</span> <span class="entity">binding</span> <span class="entity">raw_consts</span> <span class="entity">opts</span> <span class="entity">lthy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="main">#</span>cert <span class="entity">opts</span> <span class="main">=</span> <span class="entity">Skip</span> <span class="keyword2"><span class="keyword">then</span></span>
        warning <span class="inner_quoted">"Skipping certificate proofs"</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy'</span> <span class="main">=</span> <span class="main">(</span>snd o Local_Theory.begin_nested<span class="main">)</span> <span class="entity">lthy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">def_binding</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> Binding.is_empty_atts <span class="entity">def_binding</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="main">(</span>Thm.def_binding <span class="entity">binding</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        apsnd <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">attribs</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="antiquote">}</span></span></span> @ <span class="entity">attribs</span><span class="main">)</span> <span class="entity">def_binding</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">terms</span> <span class="main">=</span> map <span class="main">(</span>Syntax.parse_term <span class="entity">lthy'</span><span class="main">)</span> <span class="entity">raw_consts</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">rs_term</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">C_term</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">,</span> <span class="entity">lthy''</span><span class="main">)</span> <span class="main">=</span> <span class="entity">embed_def</span> <span class="main">(</span><span class="entity">binding</span><span class="main">,</span> <span class="entity">def_binding</span><span class="main">)</span> <span class="entity">terms</span> <span class="entity">opts</span> <span class="entity">lthy'</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy'''</span> <span class="main">=</span> Local_Theory.end_nested <span class="entity">lthy''</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">phi</span> <span class="main">=</span> Proof_Context.export_morphism <span class="entity">lthy''</span> <span class="entity">lthy'''</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rs_term'</span> <span class="main">=</span> Morphism.term <span class="entity">phi</span> <span class="entity">rs_term</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">C_term'</span> <span class="main">=</span> Morphism.term <span class="entity">phi</span> <span class="entity">C_term</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">expr</span> <span class="main">=</span>
      <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> rules<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">(</span><span class="main">(</span>Binding.name_of <span class="entity">binding</span><span class="main">,</span> true<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="entity">Expression.Positional</span> <span class="main">[</span>SOME <span class="entity">C_term'</span><span class="main">,</span> SOME <span class="entity">rs_term'</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">goal</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> rules<span class="antiquote">}</span></span> $ <span class="entity">C_term'</span> $ <span class="entity">rs_term'</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">meth</span> <span class="main">=</span>
      <span class="entity">method_text_of_tac</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
        <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">thm</span> <span class="keyword2"><span class="keyword">of</span></span>
          SOME <span class="entity">thm</span> <span class="main">=&gt;</span> HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span>Morphism.thm <span class="entity">phi</span> <span class="entity">thm</span><span class="main">]</span><span class="main">)</span>
        <span class="main">|</span> NONE <span class="main">=&gt;</span> all_tac<span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">interp</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Named_Target.is_theory</span> <span class="entity">lthy</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">Interpretation.global_interpretation</span> <span class="main">(</span><span class="main">[</span><span class="entity">expr</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        <span class="entity">Interpretation.sublocale</span> <span class="main">(</span><span class="main">[</span><span class="entity">expr</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">]</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">after_qed</span> <span class="main">[</span><span class="main">[</span><span class="entity">proof</span><span class="main">]</span><span class="main">]</span> <span class="entity">lthy</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">lthy</span>
        |&gt; <span class="entity">interp</span>
        |&gt; <span class="entity">Proof.refine_singleton</span> <span class="main">(</span><span class="entity">method_text_of_tac</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">proof</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        |&gt; <span class="entity">Proof.global_immediate_proof</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">lthy'''</span>
    |&gt; <span class="entity">Proof.theorem</span> NONE <span class="entity">after_qed</span> <span class="main">[</span><span class="main">[</span><span class="main">(</span><span class="entity">goal</span><span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">]</span>
    |&gt; <span class="entity">Proof.refine_singleton</span> <span class="entity">meth</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(** setup **)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_flag</span> <span class="main">=</span>
  <span class="main">(</span>Parse.reserved <span class="inner_quoted">"skip"</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">proof</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="main">{</span>cert <span class="main">=</span> <span class="entity">Skip</span><span class="main">,</span> proof <span class="main">=</span> <span class="entity">proof</span><span class="main">}</span><span class="main">)</span> ||
   Parse.reserved <span class="inner_quoted">"eval"</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">cert</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="main">{</span>cert <span class="main">=</span> <span class="entity">cert</span><span class="main">,</span> proof <span class="main">=</span> <span class="entity">Eval</span><span class="main">}</span><span class="main">)</span> ||
   Parse.reserved <span class="inner_quoted">"no_auto"</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span><span class="entity">cert</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span> <span class="main">{</span>cert <span class="main">=</span> <span class="entity">cert</span><span class="main">,</span> proof <span class="main">=</span> <span class="entity">No_Auto</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parse_flags</span> <span class="main">=</span>
  Scan.optional <span class="main">(</span>Args.parens <span class="main">(</span>Parse.list <span class="entity">parse_flag</span> &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">fs</span> <span class="main">=&gt;</span> fold <span class="main">(</span>curry <span class="keyword1"><span class="keyword">op</span></span> o<span class="main">)</span> <span class="entity">fs</span> I<span class="main">)</span><span class="main">)</span><span class="main">)</span> I

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  <span class="entity">Outer_Syntax.local_theory_to_proof</span>
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">command_keyword</span> "<span class="keyword1">embed</span>"<span class="antiquote">}</span></span></span>
    <span class="inner_quoted">"redefines a constant using a deep embedding of term rewriting in HOL"</span>
    <span class="main">(</span><span class="main">(</span><span class="entity">parse_flags</span> -- <span class="entity">Parse_Spec.opt_thm_name</span> <span class="inner_quoted">":"</span> -- Parse.binding --| <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">keyword</span> "<span class="keyword2">is</span>"<span class="antiquote">}</span></span></span> -- Scan.repeat1 Parse.const<span class="main">)</span>
        &gt;&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="entity">opts</span><span class="main">,</span> <span class="entity">def_binding</span><span class="main">)</span><span class="main">,</span> <span class="entity">binding</span><span class="main">)</span><span class="main">,</span> <span class="entity">const</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">embed_def_cmd</span> <span class="entity">def_binding</span> <span class="entity">binding</span> <span class="entity">const</span> <span class="main">(</span><span class="entity">opts</span> <span class="entity">default_opts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Eval_Instances">
<div class="head">
<h1>Theory Eval_Instances</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Default instances›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Eval_Instances
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Embed.html">Embed</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">"eval_instances.ML"</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Eval_Instances.setup</span>›</span>

<span class="keyword1"><span class="command">derive</span></span> evaluate <span class="quoted">nat</span> <span class="quoted">bool</span> <span class="quoted">list</span> <span class="quoted">unit</span> <span class="quoted">prod</span> <span class="quoted">sum</span> <span class="quoted">option</span> <span class="quoted">char</span> <span class="quoted">num</span> <span class="quoted">name</span> <span class="quoted"><span class="quoted">"term"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/eval_instances.ML">
<div class="head">
<h1>File ‹eval_instances.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">EVAL_INSTANCES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> make<span class="main">:</span> string <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory
  <span class="keyword1"><span class="keyword">val</span></span> make_cmd<span class="main">:</span> string <span class="main">-&gt;</span> theory <span class="main">-&gt;</span> theory

  <span class="keyword1"><span class="keyword">val</span></span> setup<span class="main">:</span> theory <span class="main">-&gt;</span> theory

  <span class="keyword1"><span class="keyword">val</span></span> intro_tac<span class="main">:</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">{</span>intros<span class="main">:</span> thm list<span class="main">}</span> <span class="main">-&gt;</span> tactic
  <span class="keyword1"><span class="keyword">val</span></span> elim_tac<span class="main">:</span>
    <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">{</span>distincts<span class="main">:</span> thm list<span class="main">,</span> elims<span class="main">:</span> thm list<span class="main">,</span> injects<span class="main">:</span> thm list<span class="main">}</span> <span class="main">-&gt;</span> tactic
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Eval_Instances</span><span class="main">:</span> <span class="entity">EVAL_INSTANCES</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword3"><span class="keyword">open</span></span> Dict_Construction_Util

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">intro_tac</span> <span class="entity">ctxt</span> <span class="main">{</span><span class="entity">intros</span><span class="main">}</span> <span class="main">=</span>
  REPEAT <span class="main">(</span>HEADGOAL <span class="main">(</span>eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eval'E<span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">)</span> THEN
    HEADGOAL
      <span class="main">(</span><span class="entity">fo_rtac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval'I<span class="antiquote">}</span></span></span> <span class="entity">ctxt</span> <span class="entity">CONTINUE_WITH_FW</span>
        <span class="main">[</span><span class="entity">Method.assm_tac</span> <span class="entity">ctxt</span><span class="main">,</span>
         SOLVED' <span class="main">(</span><span class="entity">Tactics.rewrite_tac</span> <span class="entity">ctxt</span> NONE<span class="main">)</span><span class="main">,</span>
         SOLVED' <span class="main">(</span><span class="entity">fo_resolve_tac</span> <span class="entity">intros</span> <span class="entity">ctxt</span> THEN_ALL_NEW <span class="entity">Method.assm_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">elim_tac</span> <span class="entity">ctxt</span> <span class="main">{</span><span class="entity">elims</span><span class="main">,</span> <span class="entity">distincts</span><span class="main">,</span> <span class="entity">injects</span><span class="main">}</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_vareq</span> <span class="entity">prop</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">prop</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> HOL.eq<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ Free <span class="main">_</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span>
      eresolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> eval'E<span class="antiquote">}</span></span></span> THEN'
        eresolve_tac <span class="entity">ctxt</span> <span class="entity">elims</span> THEN_ALL_NEW
          <span class="main">(</span><span class="entity">econtr_tac</span> <span class="entity">distincts</span> <span class="entity">ctxt</span> ORELSE'
            <span class="entity">Subgoal.FOCUS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
              <span class="keyword2"><span class="keyword">let</span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">that</span> :: <span class="entity">wf</span> :: <span class="entity">rewr</span> :: <span class="entity">term_eq</span> :: <span class="entity">constr_eq</span> :: <span class="entity">eval</span> <span class="main">=</span> <span class="entity">prems</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eqs</span> <span class="main">=</span>
                  <span class="entity">Tactics.elims_injects</span> <span class="entity">ctxt</span> <span class="entity">injects</span> <span class="entity">constr_eq</span>
                  |&gt; filter <span class="main">(</span><span class="entity">is_vareq</span> o Thm.prop_of<span class="main">)</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subst_in_rewr</span> <span class="main">=</span>
                  Drule.infer_instantiate <span class="entity">ctxt</span>
                    <span class="main">[</span><span class="main">(</span><span class="main">(</span><span class="inner_quoted">"P"</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">cterm</span> <span class="quoted">"<span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> <span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> <span class="bound">t'</span>"</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">]</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> subst<span class="antiquote">}</span></span></span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rewr'</span> <span class="main">=</span> <span class="entity">subst_in_rewr</span> OF <span class="main">[</span><span class="entity">term_eq</span><span class="main">,</span> <span class="entity">rewr</span><span class="main">]</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tac</span> <span class="main">=</span>
                  <span class="entity">fo_rtac</span> <span class="main">(</span><span class="entity">that</span> OF <span class="main">[</span><span class="entity">wf</span><span class="main">]</span><span class="main">)</span> <span class="entity">ctxt</span> THEN_ALL_NEW
                    <span class="main">(</span>SOLVED' <span class="main">(</span><span class="entity">fo_rtac</span> <span class="entity">rewr'</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE'
                      <span class="main">(</span><span class="entity">fo_rtac</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> eval_trivI<span class="antiquote">}</span></span></span> <span class="entity">ctxt</span> THEN'
                        SELECT_GOAL <span class="main">(</span>Local_Defs.unfold_tac <span class="entity">ctxt</span> <span class="entity">eqs</span><span class="main">)</span> THEN'
                          resolve_tac <span class="entity">ctxt</span> <span class="entity">eval</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">in</span></span> HEADGOAL <span class="entity">tac</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> HEADGOAL <span class="entity">tac</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ind_flags</span> <span class="main">=</span>
  <span class="main">{</span>quiet_mode <span class="main">=</span> true<span class="main">,</span> verbose <span class="main">=</span> false<span class="main">,</span> alt_name <span class="main">=</span> Binding.empty<span class="main">,</span>
   coind <span class="main">=</span> false<span class="main">,</span> no_elim <span class="main">=</span> false<span class="main">,</span> no_ind <span class="main">=</span> false<span class="main">,</span> skip_mono <span class="main">=</span> false<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make</span> <span class="entity">typ_name</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">{</span><span class="entity">ctrs</span><span class="main">,</span> <span class="entity">T</span><span class="main">,</span> <span class="entity">distincts</span><span class="main">,</span> <span class="entity">injects</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=</span> the <span class="main">(</span><span class="entity">Ctr_Sugar.ctr_sugar_of</span> <span class="entity">ctxt</span> <span class="entity">typ_name</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">len</span> <span class="main">=</span> length <span class="main">(</span>snd <span class="main">(</span>dest_Type <span class="main">(</span><span class="entity">unvarify_typ</span> <span class="entity">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tparams</span> <span class="main">=</span> map <span class="main">(</span>rpair <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">sort</span> <span class="quoted">evaluate</span><span class="antiquote">}</span></span><span class="main">)</span> <span class="main">(</span>Name.invent Name.context Name.aT <span class="entity">len</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ</span> <span class="main">=</span> <span class="entity">Embed.eval_typ</span> <span class="main">(</span>Type <span class="main">(</span><span class="entity">typ_name</span><span class="main">,</span> map TFree <span class="entity">tparams</span><span class="main">)</span><span class="main">)</span>

    <span class="comment1">(* FIXME use name mangling *)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="inner_quoted">"eval_"</span> ^ Long_Name.base_name <span class="entity">typ_name</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ind_head</span> <span class="main">=</span> Free <span class="main">(</span><span class="entity">name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">rs</span> <span class="main">=</span> Free <span class="main">(</span><span class="inner_quoted">"rs"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"rule fset"</span><span class="antiquote">}</span></span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">t</span> <span class="main">=</span> Free <span class="main">(</span><span class="inner_quoted">"t"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">term</span><span class="antiquote">}</span></span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thesis</span> <span class="main">=</span> Free <span class="main">(</span><span class="inner_quoted">"thesis"</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">bool</span><span class="antiquote">}</span></span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_parts</span> <span class="entity">ctr</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span> <span class="main">=</span> dest_Const <span class="main">(</span><span class="entity">sortify</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">sort</span> <span class="quoted">evaluate</span><span class="antiquote">}</span></span> <span class="main">(</span>Logic.unvarify_global <span class="entity">ctr</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">arg_typs</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> strip_type <span class="entity">typ</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_params</span> <span class="main">=</span>
          length <span class="entity">arg_typs</span>
          |&gt; Name.invent Name.context <span class="inner_quoted">"t0"</span>
          |&gt; map <span class="main">(</span>Free o rpair <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">term</span><span class="antiquote">}</span></span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctr_params</span> <span class="main">=</span> map Free <span class="main">(</span>Name.invent_names Name.context <span class="inner_quoted">"a0"</span> <span class="entity">arg_typs</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">typ</span><span class="main">,</span> <span class="entity">term_params</span><span class="main">,</span> <span class="entity">ctr_params</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">parts</span> <span class="main">=</span> map <span class="entity">mk_parts</span> <span class="entity">ctrs</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_ind_rule</span> <span class="main">(</span><span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">ctr_typ</span><span class="main">,</span> <span class="entity">term_params</span><span class="main">,</span> <span class="entity">ctr_params</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_applied</span> <span class="main">=</span>
          <span class="entity">HOL_Term.list_comb</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">term.Const</span><span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">term_params</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctr_applied</span> <span class="main">=</span> list_comb <span class="main">(</span>Const <span class="main">(</span><span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">ctr_typ</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctr_params</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span><span class="entity">ind_head</span> $ <span class="entity">rs</span> $ <span class="entity">term_applied</span> $ <span class="entity">ctr_applied</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_prem</span> <span class="entity">term_param</span> <span class="entity">ctr_param</span> <span class="main">=</span>
          <span class="entity">HOLogic.mk_Trueprop</span>
            <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">Embed.eval_typ</span> <span class="main">(</span>fastype_of <span class="entity">ctr_param</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">rs</span> $ <span class="entity">term_param</span> $ <span class="entity">ctr_param</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> map2 <span class="entity">mk_prem</span> <span class="entity">term_params</span> <span class="entity">ctr_params</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        fold Logic.all <span class="main">(</span><span class="entity">term_params</span> @ <span class="entity">ctr_params</span><span class="main">)</span> <span class="main">(</span><span class="entity">prems</span> <span class="entity">===&gt;</span> <span class="entity">concl</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy</span> <span class="main">=</span> <span class="entity">Class.instantiation</span> <span class="main">(</span><span class="main">[</span><span class="entity">typ_name</span><span class="main">]</span><span class="main">,</span> <span class="entity">tparams</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">sort</span> <span class="quoted">evaluate</span><span class="antiquote">}</span></span><span class="main">)</span> <span class="entity">thy</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ind_rules</span> <span class="main">=</span> map <span class="main">(</span>pair <span class="main">(</span>Binding.empty<span class="main">,</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Syntax.check_terms <span class="entity">lthy</span> <span class="main">(</span>map <span class="entity">mk_ind_rule</span> <span class="entity">parts</span><span class="main">)</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">info</span><span class="main">,</span> <span class="main">(</span><span class="entity">lthy'</span><span class="main">,</span> <span class="entity">lthy</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>snd o Local_Theory.begin_nested<span class="main">)</span> <span class="entity">lthy</span>
      |&gt; <span class="entity">Inductive.add_ind_def</span> <span class="entity">ind_flags</span> <span class="main">[</span><span class="entity">ind_head</span><span class="main">]</span> <span class="entity">ind_rules</span> <span class="main">[</span><span class="main">]</span> <span class="main">[</span><span class="entity">rs</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span>Binding.name <span class="entity">name</span><span class="main">,</span> NoSyn<span class="main">)</span><span class="main">]</span>
      ||&gt; `Local_Theory.end_nested
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">phi</span> <span class="main">=</span> Proof_Context.export_morphism <span class="entity">lthy</span> <span class="entity">lthy'</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">info'</span> <span class="main">=</span> <span class="entity">Inductive.transform_result</span> <span class="entity">phi</span> <span class="entity">info</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inst_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="entity">Class.intro_classes_tac</span> <span class="entity">ctxt</span> <span class="main">[</span><span class="main">]</span> THEN
        HEADGOAL
          <span class="main">(</span><span class="entity">Subgoal.FOCUS</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="entity">prems</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
            DETERM <span class="main">(</span>HEADGOAL <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="main">#</span>induct <span class="entity">info'</span> OF <span class="entity">prems</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> THEN
            <span class="entity">PARALLEL_ALLGOALS</span> <span class="main">(</span><span class="entity">Tactics.wellformed_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lthy''</span> <span class="main">=</span> <span class="entity">Class.prove_instantiation_instance</span> <span class="entity">inst_tac</span> <span class="entity">lthy'</span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_intro_elim</span> <span class="main">(</span><span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">ctr_typ</span><span class="main">,</span> <span class="entity">term_params</span><span class="main">,</span> <span class="entity">ctr_params</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">term_applied</span> <span class="main">=</span>
          <span class="entity">HOL_Term.list_comb</span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">term.Const</span><span class="antiquote">}</span></span> $ <span class="entity">mk_name</span> <span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">term_params</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctr_applied</span> <span class="main">=</span> list_comb <span class="main">(</span>Const <span class="main">(</span><span class="entity">ctr_name</span><span class="main">,</span> <span class="entity">ctr_typ</span><span class="main">)</span><span class="main">,</span> <span class="entity">ctr_params</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_prem</span> <span class="entity">term_param</span> <span class="entity">ctr_param</span> <span class="main">=</span>
          <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval'<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">Embed.eval_typ</span> <span class="main">(</span>fastype_of <span class="entity">ctr_param</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">rs</span> $ <span class="entity">term_param</span> $ <span class="entity">ctr_param</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> map <span class="entity">HOLogic.mk_Trueprop</span>
          <span class="main">(</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">wellformed</span><span class="antiquote">}</span></span> $ <span class="entity">t</span><span class="main">)</span> ::
            <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">rewrite_rt</span><span class="antiquote">}</span></span> $ <span class="entity">rs</span> $ <span class="entity">t</span> $ <span class="entity">term_applied</span><span class="main">)</span> ::
            map2 <span class="entity">mk_prem</span> <span class="entity">term_params</span> <span class="entity">ctr_params</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span>
          <span class="entity">HOLogic.mk_Trueprop</span> <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> eval'<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">typ</span><span class="main">)</span> $ <span class="entity">rs</span> $ <span class="entity">t</span> $ <span class="entity">ctr_applied</span><span class="main">)</span>

        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">intro</span> <span class="main">=</span> fold Logic.all <span class="main">(</span><span class="entity">term_params</span> @ <span class="entity">ctr_params</span><span class="main">)</span> <span class="main">(</span><span class="entity">prems</span> <span class="entity">===&gt;</span> <span class="entity">concl</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thesis</span> <span class="main">=</span> <span class="entity">HOLogic.mk_Trueprop</span> <span class="entity">thesis</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">elim</span> <span class="main">=</span>
          fold Logic.all <span class="entity">ctr_params</span>
            <span class="main">(</span><span class="entity">concl</span> <span class="entity">==&gt;</span> <span class="main">(</span>fold Logic.all <span class="entity">term_params</span> <span class="main">(</span><span class="entity">prems</span> <span class="entity">===&gt;</span> <span class="entity">thesis</span><span class="main">)</span><span class="main">)</span> <span class="entity">==&gt;</span> <span class="entity">thesis</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">intro</span><span class="main">,</span> <span class="entity">elim</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_intro</span> <span class="entity">goal</span> <span class="main">=</span>
      Goal.prove_future <span class="entity">lthy''</span> <span class="main">[</span><span class="inner_quoted">"rs"</span><span class="main">,</span> <span class="inner_quoted">"t"</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
        <span class="entity">intro_tac</span> <span class="entity">ctxt</span> <span class="main">{</span>intros <span class="main">=</span> <span class="main">#</span>intrs <span class="entity">info'</span><span class="main">}</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">prove_elim</span> <span class="entity">goal</span> <span class="main">=</span>
      Goal.prove_future <span class="entity">lthy''</span> <span class="main">[</span><span class="inner_quoted">"rs"</span><span class="main">,</span> <span class="inner_quoted">"t"</span><span class="main">,</span> <span class="inner_quoted">"thesis"</span><span class="main">]</span> <span class="main">[</span><span class="main">]</span> <span class="entity">goal</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">,</span> <span class="main">...</span><span class="main">}</span> <span class="main">=&gt;</span>
        <span class="entity">elim_tac</span> <span class="entity">ctxt</span> <span class="main">{</span>elims <span class="main">=</span> <span class="main">#</span>elims <span class="entity">info'</span><span class="main">,</span> distincts <span class="main">=</span> <span class="entity">distincts</span><span class="main">,</span> injects <span class="main">=</span> <span class="entity">injects</span><span class="main">}</span><span class="main">)</span>

    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">intros</span><span class="main">,</span> <span class="entity">elims</span><span class="main">)</span> <span class="main">=</span>
      map <span class="entity">mk_intro_elim</span> <span class="entity">parts</span>
      |&gt; split_list
      |&gt;&gt; map <span class="entity">prove_intro</span>
      ||&gt; map <span class="entity">prove_elim</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">lthy''</span>
    |&gt; Local_Theory.note <span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">eval_data_intros</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span> <span class="entity">intros</span><span class="main">)</span> |&gt; snd
    |&gt; Local_Theory.note <span class="main">(</span><span class="main">(</span>Binding.empty<span class="main">,</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">attributes</span> <span class="main">[</span><span class="operator">eval_data_elims</span><span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span><span class="main">,</span> <span class="entity">elims</span><span class="main">)</span> |&gt; snd
    |&gt; Local_Theory.exit_global
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make_cmd</span> <span class="entity">s</span> <span class="entity">thy</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="entity">thy</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">typ_name</span> <span class="main">=</span>
      Proof_Context.read_type_name <span class="main">{</span>proper <span class="main">=</span> true<span class="main">,</span> strict <span class="main">=</span> false<span class="main">}</span> <span class="entity">ctxt</span> <span class="entity">s</span>
      |&gt; dest_Type |&gt; fst
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">make</span> <span class="entity">typ_name</span> <span class="entity">thy</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(** setup **)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">setup</span> <span class="main">=</span>
  <span class="entity">Derive_Manager.register_derive</span> <span class="inner_quoted">"evaluate"</span> <span class="inner_quoted">"derives an embedding relation for a datatype"</span>
    <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">typ_name</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">param</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">param</span> <span class="main">=</span> <span class="inner_quoted">""</span> <span class="keyword2"><span class="keyword">then</span></span>
        <span class="entity">make</span> <span class="entity">typ_name</span>
      <span class="keyword2"><span class="keyword">else</span></span>
        error <span class="inner_quoted">"unknown parameter, expected no parameter"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Doc_Backend">
<div class="head">
<h1>Theory Doc_Backend</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Final stage: Translation to CakeML›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Doc_Backend
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Setup">
<div class="head">
<h1>Theory CakeML_Setup</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic CakeML setup›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Setup
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="CupCake_Semantics.html">../CupCakeML/CupCake_Semantics</a>"</span>
  <a href="../CakeML/CakeML_Code.html">CakeML.CakeML_Code</a>
  <span class="quoted">"<a href="Consts.html">../Terms/Consts</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> name<span class="main">:</span> rekey <span class="quoted">Name</span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"inv Name <span class="main">=</span> as_string"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij Name"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bijI' name.exhaust name.inject<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rekey Name"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inv Name <span class="main">=</span> as_string"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_equality name.exhaust_sel name.sel<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> name_as_string<span class="main">:</span> rekey <span class="quoted">as_string</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> name.inv<span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Lem_string.concat
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> sem_env.c
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> sem_env.v

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_locn</span> <span class="main">::</span> <span class="quoted">locn</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_locn</span> <span class="main">=</span> <span class="main">⦇</span> row <span class="main">=</span> <span class="main">0</span><span class="main">,</span> col <span class="main">=</span> <span class="main">0</span><span class="main">,</span> offset <span class="main">=</span> <span class="main">0</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_locs</span> <span class="main">::</span> <span class="quoted">locs</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_locs</span> <span class="main">=</span> <span class="main">(</span>empty_locn<span class="main">,</span> empty_locn<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit SemanticPrimitives.state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_state</span> <span class="main">=</span> <span class="main">⦇</span> clock <span class="main">=</span> <span class="main">0</span><span class="main">,</span> refs <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> ffi <span class="main">=</span> empty_ffi_state<span class="main">,</span> defined_types <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> defined_mods <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fmap_of_ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> string<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> namespace <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fmap_of_ns</span> <span class="main">(</span>Bind <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name id<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmlookup_ns<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>fmap_of_ns <span class="free">ns</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> cupcake_nsLookup <span class="free">ns</span> <span class="main">(</span>as_string <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmlookup_of_list map_prod_def name.map_of_rekey option.map_ident<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_of_nsBind<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmap_of_ns <span class="main">(</span>nsBind <span class="main">(</span>as_string <span class="free">k</span><span class="main">)</span> <span class="free">v0</span> <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> fmupd <span class="free">k</span> <span class="free">v0</span> <span class="main">(</span>fmap_of_ns <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_of_nsAppend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmap_of_ns <span class="main">(</span>nsAppend <span class="free">ns1</span> <span class="free">ns2</span><span class="main">)</span> <span class="main">=</span> fmap_of_ns <span class="free">ns2</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmap_of_ns <span class="free">ns1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ns2</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_of_alist_to_ns<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmap_of_ns <span class="main">(</span>alist_to_ns <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name id<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> alist_to_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_of_nsEmpty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fmap_of_ns nsEmpty <span class="main">=</span> fmempty"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nsEmpty_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> build_rec_env_fmap0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fmap_of_ns <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> nsBind <span class="bound">f</span> <span class="main">(</span>Recclosure <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="free">funs'</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="free">funs</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span>
    fmap_of_ns <span class="free">env</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmap_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Name <span class="bound">f</span><span class="main">,</span> Recclosure <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="free">funs'</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="free">funs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">funs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fmap_of_nsBind name.sel<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_mk_rec_env</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_mk_rec_env</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> fmap_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Name <span class="bound">f</span><span class="main">,</span> Recclosure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">funs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_rec_env_fmap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fmap_of_ns <span class="main">(</span>build_rec_env <span class="free">funs</span> <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> fmap_of_ns <span class="free">env</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> cake_mk_rec_env <span class="free">funs</span> <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> build_rec_env_def cake_mk_rec_env_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> build_rec_env_fmap0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Constructors according to CakeML›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_tctor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> tctor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_tctor</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="inner_quoted">''fun''</span> <span class="keyword1">then</span> Ast.TC_fn <span class="keyword1">else</span> Ast.TC_name <span class="main">(</span>Short <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">typ_to_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"typ <span class="main">⇒</span> Ast.t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">typ_to_t</span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Ast.Tvar <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">typ_to_t</span> <span class="main">(</span>TApp <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">=</span> Ast.Tapp <span class="main">(</span>map <span class="free">typ_to_t</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>cake_tctor <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> constructors <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">as_static_cenv</span> <span class="main">::</span> <span class="quoted">c_ns</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">as_static_cenv</span> <span class="main">=</span> Bind <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span>map_prod id <span class="main">(</span>map_prod id <span class="main">(</span>TypeId <span class="main">∘</span> Short<span class="main">)</span><span class="main">)</span><span class="main">)</span> flat_C_info<span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> as_static_cenv_cakeml_static_env<span class="main">:</span> <span class="quoted"><span class="quoted">"cakeml_static_env as_static_cenv"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cakeml_static_env_def as_static_cenv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_map <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> cake_static_env<span class="main">?</span><span class="main">:</span> cakeml_static_env <span class="quoted">as_static_cenv</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> as_static_cenv_cakeml_static_env<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">as_cake_type_def</span> <span class="main">::</span> <span class="quoted">Ast.type_def</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">as_cake_type_def</span> <span class="main">=</span>
  map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">dt_def</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map as_string <span class="main">(</span>tparams <span class="bound">dt_def</span><span class="main">)</span><span class="main">,</span> as_string <span class="bound">name</span><span class="main">,</span>
      map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">C</span><span class="main">,</span> <span class="bound">params</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>as_string <span class="bound">C</span><span class="main">,</span> map typ_to_t <span class="bound">params</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>sorted_list_of_fmap <span class="main">(</span>constructors <span class="bound">dt_def</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>sorted_list_of_fmap <span class="free">C_info</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_dt_prelude</span> <span class="main">::</span> <span class="quoted">Ast.dec</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_dt_prelude</span> <span class="main">=</span> Ast.Dtype empty_locs as_cake_type_def"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_all_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tid_or_exn set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_all_types</span> <span class="main">=</span> <span class="main">(</span>TypeId <span class="main">∘</span> Short <span class="main">∘</span> as_string<span class="main">)</span> <span class="main">`</span> fset all_tdefs"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_state_with_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit SemanticPrimitives.state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_state_with_types</span> <span class="main">=</span>
  <span class="main">⦇</span> clock <span class="main">=</span> <span class="main">0</span><span class="main">,</span> refs <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> ffi <span class="main">=</span> empty_ffi_state<span class="main">,</span> defined_types <span class="main">=</span> cake_all_types<span class="main">,</span> defined_mods <span class="main">=</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_state_with_types_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"empty_state_with_types <span class="main">=</span> empty_state <span class="main">⦇</span> defined_types <span class="main">:=</span> cake_all_types <span class="main">⦈</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> empty_state_with_types_def empty_state_def
<span class="comment1">(* FIXME update_f (make_t ) lemma missing *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">datatype_record_update</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Running the generated type declarations through the semantics›</span></span>

<span class="keyword1"><span class="command">context</span></span> constants <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* FIXME slightly different shape than empty_state_with_types_alt_def *)</span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> state_types_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"update_defined_types <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> cake_all_types <span class="main">∪</span> defined_types empty_state<span class="main">)</span> empty_state <span class="main">=</span>
    empty_state_with_types"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> empty_state_with_types_def empty_state_def
<span class="comment1">(* FIXME update_f (make_t ) lemma missing *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">datatype_record_update</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> env_types_update<span class="main">:</span> <span class="quoted"><span class="quoted">"build_tdefs <span class="main">[]</span> as_cake_type_def <span class="main">=</span> as_static_cenv"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> as_cake_type_def_def as_static_cenv_def build_tdefs_def alist_to_ns_def flat_C_info_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> List.bind_def map_concat<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">concat</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_concat comp_def split_beta<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> evaluate_type <span class="main">=</span>
  evaluate_dec.dtype1<span class="main">[</span>
    <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> new_tdecs <span class="main"><span class="main">=</span></span> <span class="quoted">cake_all_types</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s <span class="main"><span class="main">=</span></span> <span class="quoted">empty_state</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> mn <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> tds <span class="main"><span class="main">=</span></span> <span class="quoted">as_cake_type_def</span><span class="main">,</span>
    <span class="operator">unfolded</span> state_types_update env_types_update<span class="main">,</span>
    <span class="operator">folded</span> empty_sem_env_def<span class="main">]</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> type_defs_to_new_tdecs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"type_defs_to_new_tdecs <span class="main">[]</span> as_cake_type_def <span class="main">=</span>
    set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">name</span><span class="main">.</span> TypeId <span class="main">(</span>Short <span class="main">(</span>as_string <span class="bound">name</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sorted_list_of_fset <span class="main">(</span>fmdom <span class="free">C_info</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cake_all_types_def type_defs_to_new_tdecs_def as_cake_type_def_def all_tdefs_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_twice sorted_list_of_fmap_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cakeml_convoluted1<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span><span class="main">.</span> <span class="main">(#)</span> <span class="bound">n</span><span class="main">)</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">=</span> map fst <span class="free">ys</span> <span class="main">@</span> <span class="free">xs</span>"</span></span> <span class="comment1">(* thanks Scott *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cakeml_convoluted2<span class="main">:</span> <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span>"</span></span> <span class="comment1">(* thanks again *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> check_dup_ctors_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"check_dup_ctors <span class="free">tds</span> <span class="main">⟷</span> distinct <span class="main">(</span><span class="free">tds</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">cons</span><span class="main">)</span><span class="main">.</span> map fst <span class="bound">cons</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> check_dup_ctors_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">distinct</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> foldr_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">a</span><span class="main">.</span> map fst <span class="main">(</span>snd <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="bound">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cakeml_convoluted1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cakeml_convoluted2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">unfolding</span></span> List.bind_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">concat</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> evaluate_dec_prelude<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">t</span> <span class="main">[]</span> <span class="free">env</span> empty_state cake_dt_prelude <span class="main">(</span>empty_state_with_types<span class="main">,</span> Rval empty_sem_env<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cake_dt_prelude_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_type<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check_dup_ctors as_cake_type_def"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_ctr'
    <span class="keyword1"><span class="command">unfolding</span></span> check_dup_ctors_alt_def List.bind_def as_cake_type_def_def all_constructors_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def split_beta map_concat<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"allDistinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">tvs</span><span class="main">,</span> <span class="bound">tn</span><span class="main">,</span> <span class="bound">ctors</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">tn</span><span class="main">)</span> as_cake_type_def<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> all_distinct_alt_def as_cake_type_def_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def case_prod_twice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> name_as_string.fst_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_list_of_fmap_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cake_all_types <span class="main">=</span> type_defs_to_new_tdecs <span class="main">[]</span> as_cake_type_def"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cake_all_types_def type_defs_to_new_tdecs all_tdefs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjnt cake_all_types <span class="main">(</span>defined_types empty_state<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> empty_state_def disjnt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computability›</span></span>

<span class="keyword1"><span class="command">declare</span></span> constructors.as_static_cenv_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> constructors.as_cake_type_def_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> constructors.cake_dt_prelude_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">constructors.as_static_cenv</span></span> <span class="quoted"><span class="quoted">constructors.cake_dt_prelude</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Backend">
<div class="head">
<h1>Theory CakeML_Backend</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹CakeML backend›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Backend
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CakeML_Setup.html">CakeML_Setup</a>
  <span class="quoted">"<a href="Value.html">../Terms/Value</a>"</span>
  <span class="quoted">"<a href="Rewriting_Sterm.html">../Rewriting/Rewriting_Sterm</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compilation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mk_ml_pat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pat <span class="main">⇒</span> Ast.pat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mk_ml_pat</span> <span class="main">(</span>Patvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Ast.Pvar <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mk_ml_pat</span> <span class="main">(</span>Patconstr <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">=</span> Ast.Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">mk_ml_pat</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_pat_cupcake<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_pat <span class="main">(</span>mk_ml_pat <span class="free">pat</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">pat</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">frees'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> name list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">frees'</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees'</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">@</span> <span class="free">frees'</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> "</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees'</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> frees'_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset_of_list <span class="main">(</span>frees' <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> frees'_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"frees' <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>rev <span class="main">(</span>map frees' <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> frees' <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> frees'_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">pat</span> <span class="main">⟹</span> distinct <span class="main">(</span>frees' <span class="free">pat</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>frees' <span class="skolem">u</span> <span class="main">@</span> frees' <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_append_fset fdisjnt_swap<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">pat_bindings'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Ast.pat <span class="main">⇒</span> name list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pat_bindings'</span> <span class="main">(</span>Ast.Pvar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>Name <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pat_bindings'</span> <span class="main">(</span>Ast.Pcon <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>rev <span class="main">(</span>map <span class="free">pat_bindings'</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pat_bindings'</span> <span class="main">(</span>Ast.Pref <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pat_bindings'</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pat_bindings'</span> <span class="main">(</span>Ast.Ptannot <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pat_bindings'</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pat_bindings'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> pat_bindings'_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map Name <span class="main">(</span>pats_bindings <span class="free">ps</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>rev <span class="main">(</span>map pat_bindings' <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> map Name <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"map Name <span class="main">(</span>pat_bindings <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> pat_bindings' <span class="free">p</span> <span class="main">@</span> map Name <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pats_bindings_pat_bindings.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> pat_bindings'_empty_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map Name <span class="main">(</span>pat_bindings <span class="free">p</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> pat_bindings' <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pat_bindings'_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> pat_bindings'_eq_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">p</span> <span class="main">⟹</span> pat_bindings' <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> frees' <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_pat.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_strip_comb_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">s</span> <span class="skolem">args</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>pat_bindings' <span class="main">∘</span> mk_ml_pat <span class="main">∘</span> mk_pat<span class="main">)</span> <span class="skolem">args</span> <span class="main">=</span> map frees' <span class="skolem">args</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> comp_apply<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">args</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 comb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linears_linear linears_strip_comb snd_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pat_bindings' <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> frees' <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 1 comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>rev <span class="main">(</span>map <span class="main">(</span>pat_bindings' <span class="main">∘</span> mk_ml_pat <span class="main">∘</span> mk_pat<span class="main">)</span> <span class="skolem">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>rev <span class="main">(</span>map frees' <span class="skolem">args</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">with</span></span> comb <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_list_comb_const frees'_list_comb comp_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> const_term_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_pat_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">pat</span> <span class="main">⟹</span> distinct <span class="main">(</span>pat_bindings <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="free">pat</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pat_bindings'_eq_frees pat_bindings'_empty_eq frees'_distinct distinct_map<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> cakeml <span class="main">=</span> pre_constants
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">mk_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset <span class="main">⇒</span> sterm <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">mk_clauses</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset <span class="main">⇒</span> <span class="main">(</span>term <span class="main">×</span> sterm<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>Ast.pat <span class="main">×</span> exp<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">mk_con</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset <span class="main">⇒</span> sterm <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mk_exp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mk_exp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Sconst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">|∈|</span> C <span class="keyword1">then</span> Ast.Con <span class="main">(</span>Some <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="keyword1">else</span> Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mk_exp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Ast.App Ast.Opapp <span class="main">[</span><span class="free">mk_con</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free">mk_con</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mk_exp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> fresh_fNext <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">in</span>
  Ast.Fun <span class="main">(</span>as_string <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">mk_clauses</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mk_con</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> strip_comb <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Sconst <span class="bound">c</span><span class="main">,</span> <span class="bound">args</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">|∈|</span> C <span class="keyword1">then</span> Ast.Con <span class="main">(</span>Some <span class="main">(</span>Short <span class="main">(</span>as_string <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="free">mk_con</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="bound">args</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">mk_exp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">mk_exp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mk_clauses</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="bound">pat</span><span class="main">)</span><span class="main">,</span> <span class="free">mk_con</span> <span class="main">(</span>frees <span class="bound">pat</span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> mk_exp_cupcake0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> is_cupcake_exp <span class="main">(</span>mk_exp <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"wellformed_clauses <span class="free">cs</span> <span class="main">⟹</span> cupcake_clauses <span class="main">(</span>mk_clauses <span class="free">S</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span> cake_linear_clauses <span class="main">(</span>mk_clauses <span class="free">S</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> is_cupcake_exp <span class="main">(</span>mk_con <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_exp_mk_clauses_mk_con.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">S</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.splits sterm.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> args c
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">$$</span> <span class="skolem">args</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_sterm_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv list_strip_comb snd_conv<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mk_con.simps<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 5<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wellformed.list_comb list_all_iff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sterm.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def list_all_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mk_pat_distinct<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> mk_con.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_exp_cupcake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> is_cupcake_exp <span class="main">(</span>mk_exp <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> is_cupcake_exp <span class="main">(</span>mk_con <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mk_exp_cupcake0<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_letrec_body</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mk_letrec_body</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span>
  map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span>as_string <span class="bound">name</span><span class="main">,</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> fresh_fNext <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">in</span>
        <span class="main">(</span>as_string <span class="bound">n</span><span class="main">,</span> Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_clauses <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span>sterm.clauses <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile_group</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name fset <span class="main">⇒</span> srule list <span class="main">⇒</span> Ast.dec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile_group</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Ast.Dletrec empty_locs <span class="main">(</span>mk_letrec_body <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"srule list <span class="main">⇒</span> Ast.prog"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">[</span>Ast.Tdec <span class="main">(</span>compile_group all_consts <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> cakeml.mk_con.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cakeml.mk_exp.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cakeml.mk_clauses.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cakeml.mk_letrec_body_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cakeml.compile_group_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> cakeml.compile_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">locale</span></span> cakeml' <span class="main">=</span> cakeml <span class="main">+</span> constants

<span class="keyword1"><span class="command">context</span></span> srules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> srules_as_cake<span class="main">?</span><span class="main">:</span> cakeml' <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

<span class="keyword1"><span class="command">lemma</span></span> mk_letrec_cupcake<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">exp</span><span class="main">)</span><span class="main">.</span> is_cupcake_exp <span class="bound">exp</span><span class="main">)</span> <span class="main">(</span>mk_letrec_body <span class="free">S</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> mk_letrec_body_def
<span class="keyword1"><span class="command">using</span></span> all_rules
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def list_all_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mk_pat_cupcake mk_exp_cupcake mk_pat_distinct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ballE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff is_abs_def term_cases_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ballE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff is_abs_def term_cases_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile'</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile'</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> cakeml.compile <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> srules<span class="main">)</span> compile'_compile_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"compile' <span class="free">C_info</span> <span class="free">rs</span> <span class="main">=</span> compile <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile'_def <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computability›</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">cakeml.compile</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of semantic functions›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">related_pat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> Ast.pat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">related_pat</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> cakeml' <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">related_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"sterm <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">related_exp</span> <span class="main">(</span>Svar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∉|</span> C <span class="main">⟹</span> <span class="free">related_exp</span> <span class="main">(</span>Sconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
constr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">|∈|</span> C <span class="main">⟹</span> list_all2 <span class="free">related_exp</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟹</span>
          <span class="free">related_exp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>Ast.Con <span class="main">(</span>Some <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">related_exp</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free">related_exp</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span> <span class="free">related_exp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Ast.App Ast.Opapp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted">"fun"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat <span class="free">related_exp</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">ml_cs</span></span></span> <span class="main">⟹</span>
        <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|∉|</span> all_consts <span class="main">⟹</span>
          <span class="free">related_exp</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">(</span>Ast.Fun <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ml_cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
mat<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat <span class="free">related_exp</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">ml_cs</span></span></span> <span class="main">⟹</span>
      <span class="free">related_exp</span> <span class="free"><span class="bound"><span class="entity">scr</span></span></span> <span class="free"><span class="bound"><span class="entity">ml_scr</span></span></span> <span class="main">⟹</span>
          <span class="free">related_exp</span> <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">scr</span></span></span><span class="main">)</span> <span class="main">(</span>Ast.Mat <span class="free"><span class="bound"><span class="entity">ml_scr</span></span></span> <span class="free"><span class="bound"><span class="entity">ml_cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> related_exp_is_cupcake<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="free">t</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"fun"</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span> <span class="main">∧</span> wellformed <span class="bound">t</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">ml_cs</span> <span class="main">∧</span> cake_linear_clauses <span class="skolem">ml_cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">_</span> <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">ml_c</span> <span class="skolem">ml_cs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ml_p</span></span> <span class="skolem"><span class="skolem">ml_e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ml_p</span><span class="main">,</span> <span class="skolem">ml_e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_p</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mk_pat_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat <span class="skolem">cs</span> <span class="skolem">ml_cs</span> <span class="skolem">scr</span> <span class="skolem">ml_scr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span> <span class="main">∧</span> wellformed <span class="bound">t</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">ml_cs</span> <span class="main">∧</span> cake_linear_clauses <span class="skolem">ml_cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">_</span> <span class="skolem">cs</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">ml_c</span> <span class="skolem">ml_cs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ml_p</span></span> <span class="skolem"><span class="skolem">ml_e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ml_p</span><span class="main">,</span> <span class="skolem">ml_e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_p</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mk_pat_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>constr <span class="skolem">name</span> <span class="skolem">ts</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all wellformed <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellformed.list_comb<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">ts</span> <span class="skolem">es</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_exp <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">related_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> sterm<span class="main">)</span> list <span class="main">⇒</span> name <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">related_fun</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟷</span>
  <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|∉|</span> all_consts <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="bound">n'</span><span class="main">)</span><span class="main">)</span> <span class="bound">ml_cs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Name <span class="bound">n'</span> <span class="main">∧</span> list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="bound">ml_cs</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> related_fun_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"related_fun <span class="free">cs</span> <span class="free">n</span> <span class="main">(</span>Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ml_cs</span><span class="main">)</span> <span class="main">⟷</span>
    list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="free">cs</span> <span class="free">ml_cs</span> <span class="main">∧</span>
    <span class="free">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">|∉|</span> all_consts"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> related_fun_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> related_funE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_fun <span class="free">cs</span> <span class="free">n</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ml_cs</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">ml_cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">|∉|</span> all_consts"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="free">cs</span> <span class="free">ml_cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> related_fun_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> exp0.splits id0.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> related_exp_fun<span class="main">:</span>
  <span class="quoted"><span class="quoted">"related_fun <span class="free">cs</span> <span class="free">n</span> <span class="free">e</span> <span class="main">⟷</span> related_exp <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>Ast.Fun <span class="main">(</span>as_string <span class="free">n</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">|∉|</span> all_consts"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>Ast.Fun <span class="main">(</span>as_string <span class="free">n</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> related_fun_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> name.expand<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> related_exp.fun <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> related_funE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">related_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"value <span class="main">⇒</span> v <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2 <span class="free">related_v</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">⟹</span>
    <span class="free">related_v</span> <span class="main">(</span>Vconstr <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
closure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"related_fun <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟹</span>
   fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free">related_v</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">related_v</span> <span class="main">(</span>Vabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span>Closure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
rec_closure<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>fbind <span class="main">(</span>fmran <span class="free"><span class="bound"><span class="entity">css</span></span></span><span class="main">)</span> <span class="main">(</span>ids <span class="main">∘</span> Sabs<span class="main">)</span><span class="main">)</span> <span class="free">related_v</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   fmrel <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> <span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> related_fun <span class="bound">cs</span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name <span class="main">(</span>map_prod Name id<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">exps</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">related_v</span> <span class="main">(</span>Vrecabs <span class="free"><span class="bound"><span class="entity">css</span></span></span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">(</span>Recclosure <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">exps</span></span></span> <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">var_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> v<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">var_env</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">≡</span> fmrel related_v <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name id<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> related_v_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v</span> <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v'</span> <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>conv <span class="skolem">us</span> <span class="skolem">ml_us</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> Vconstr <span class="skolem">name</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 erelated <span class="skolem">ts</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> Vconstr <span class="skolem">name</span> <span class="skolem">us</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 related_v <span class="skolem">ts</span> <span class="skolem">ml_us</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹list_all2 erelated <span class="skolem">ts</span> <span class="skolem">us</span>›</span></span> conv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> conv <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> related_v.conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>closure <span class="skolem">cs</span> <span class="skolem">n</span> <span class="skolem">e</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> prems<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_on_fsetD<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> closure<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> prems<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_on_fsetD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.rel_sel<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> related_v.closure<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rec_closure <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env</span> <span class="skolem">exps</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> Vrecabs <span class="skolem">css</span> <span class="skolem">name</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"pred_fmap <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="bound">cs</span><span class="main">)</span><span class="main">)</span> erelated <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">css</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>fbind <span class="main">(</span>fmran <span class="skolem">css</span><span class="main">)</span> <span class="main">(</span>ids <span class="main">∘</span> Sabs<span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsetI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> prems<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_on_fsetD<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rec_closure<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> prems<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fbindE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> pred_fmapD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹pred_fmap <span class="main">_</span> <span class="skolem">css</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> comp_apply
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_on_fsetD<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.rel_sel<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> related_v.rec_closure<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">match_result_related</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">×</span> v<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>string <span class="main">×</span> v<span class="main">)</span> list match_result <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> value<span class="main">)</span> fmap option <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">eenv</span> <span class="keyword2"><span class="keyword">where</span></span>
no_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match_result_related</span> <span class="free">eenv</span> No_match None"</span></span> <span class="main">|</span>
error<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">match_result_related</span> <span class="free">eenv</span> Match_type_error <span class="main"><span class="bound"><span class="entity">_</span></span></span>"</span></span> <span class="main">|</span>
match<span class="main">:</span> <span class="quoted"><span class="quoted">"var_env <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">eenv_m</span></span></span> <span class="main">⟹</span> <span class="free">match_result_related</span> <span class="free">eenv</span> <span class="main">(</span>Match <span class="main">(</span><span class="free"><span class="bound"><span class="entity">eenv_m</span></span></span> <span class="main">@</span> <span class="free">eenv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">corollary</span></span> match_result_related_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"match_result_related <span class="free">eenv</span> <span class="main">(</span>Match <span class="free">eenv</span><span class="main">)</span> <span class="main">(</span>Some fmempty<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="free">eenv</span> <span class="main">(</span>Match <span class="main">(</span><span class="main">[]</span> <span class="main">@</span> <span class="free">eenv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some fmempty<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_result_related.match<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_Match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> match_result <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_Match</span> <span class="main">(</span>Match <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_Match</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_pmatch_related<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v</span> <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="free">eenv</span> <span class="main">(</span>cupcake_pmatch as_static_cenv <span class="main">(</span>mk_ml_pat <span class="free">pat</span><span class="main">)</span> <span class="free">ml_v</span> <span class="free">eenv</span><span class="main">)</span> <span class="main">(</span>vmatch <span class="free">pat</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ml_v</span></span> <span class="quoted"><span class="free">eenv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Patvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"var_env <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span>as_string <span class="skolem">name</span><span class="main">,</span> <span class="skolem">ml_v</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Patvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="skolem">eenv</span> <span class="main">(</span>Match <span class="main">(</span><span class="main">[</span><span class="main">(</span>as_string <span class="skolem">name</span><span class="main">,</span> <span class="skolem">ml_v</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">eenv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_result_related.match<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Patconstr <span class="skolem">name</span> <span class="skolem">ps</span> <span class="skolem">v0</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Patconstr.prems
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> related_v.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>conv <span class="skolem">us</span> <span class="skolem">vs</span> <span class="skolem">name'</span> _<span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="skolem">m</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">m</span> <span class="keyword1">of</span>
          Match <span class="bound">env</span> <span class="main">⇒</span> cupcake_pmatch as_static_cenv <span class="skolem">p</span> <span class="skolem">v</span> <span class="bound">env</span>
        <span class="main">|</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">v</span> <span class="skolem">m</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>"</span></span>

        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">us</span> <span class="skolem">ps</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">p</span> <span class="bound">v</span><span class="main">.</span> related_v <span class="bound">t</span> <span class="bound">v</span><span class="main">)</span> <span class="skolem">us</span> <span class="skolem">ps</span> <span class="skolem">vs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 related_v <span class="skolem">us</span> <span class="skolem">vs</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all3_from_list_all2s<span class="main">)</span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"match_result_related <span class="skolem">eenv</span>
                    <span class="main">(</span>Matching.fold2 <span class="skolem">f</span> Match_type_error <span class="main">(</span>map mk_ml_pat <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">(</span>Match <span class="main">(</span><span class="skolem">eenv_m</span> <span class="main">@</span> <span class="skolem">eenv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rel</span>"</span></span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"var_env <span class="skolem">Γ</span> <span class="skolem">eenv_m</span>"</span></span>
          <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">eenv_m</span> <span class="skolem">Γ</span>
          <span class="keyword1"><span class="command">using</span></span> Patconstr.IH <span class="quoted"><span class="quoted">‹related_v <span class="skolem">v0</span> <span class="skolem">ml_v</span>›</span></span> that
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">us</span></span> <span class="quoted"><span class="skolem">ps</span></span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Γ</span></span> <span class="quoted"><span class="skolem">eenv_m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3_induct<span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">us</span> <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="main">(</span><span class="skolem">eenv_m</span> <span class="main">@</span> <span class="skolem">eenv</span><span class="main">)</span> <span class="main">(</span>cupcake_pmatch as_static_cenv <span class="main">(</span>mk_ml_pat <span class="skolem">p</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">(</span><span class="skolem">eenv_m</span> <span class="main">@</span> <span class="skolem">eenv</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vmatch <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
                <span class="keyword3"><span class="command">case</span></span> no_match
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> f_def
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map mk_ml_pat <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>cup_pmatch_list_nomatch cup_pmatch_list_length_neq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> error
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> f_def
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map mk_ml_pat <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>cup_pmatch_list_typerr cup_pmatch_list_length_neq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>match <span class="skolem">Γ'</span> <span class="skolem">eenv_m'</span><span class="main">)</span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="skolem">eenv</span>
                        <span class="main">(</span>Matching.fold2 <span class="skolem">f</span> Match_type_error <span class="main">(</span>map mk_ml_pat <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">(</span>Match <span class="main">(</span><span class="main">(</span><span class="skolem">eenv_m'</span> <span class="main">@</span> <span class="skolem">eenv_m</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">eenv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                        <span class="main">(</span>map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 vmatch <span class="skolem">ps</span> <span class="skolem">us</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Cons<span class="main">)</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"var_env <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">eenv_m'</span> <span class="main">@</span> <span class="skolem">eenv_m</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹var_env <span class="skolem">Γ</span> <span class="skolem">eenv_m</span>›</span></span> match
                      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> match
                  <span class="keyword1"><span class="command">unfolding</span></span> f_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_option.compositionality comp_def<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.match<span class="main">)</span>

        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"var_env fmempty <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rel</span> <span class="main">[]</span> fmempty"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> conv <span class="quoted"><span class="quoted">‹length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">us</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">=</span> <span class="skolem">name'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> static_cenv_lookup<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">≠</span> <span class="skolem">name'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> conv <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> same_ctor.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> name.expand<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fold</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Matching.fold2 <span class="skolem">f</span> Match_type_error <span class="main">(</span>map mk_ml_pat <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">(</span>Match <span class="skolem">eenv</span><span class="main">)</span>"</span></span>

        <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">≠</span> length <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 related_v <span class="skolem">us</span> <span class="skolem">vs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_lengthD<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">≠</span> length <span class="skolem">vs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_Match <span class="main">(</span>Matching.fold2 <span class="skolem">f</span> <span class="skolem">err</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">init</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_Match <span class="skolem">err</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≠</span> length <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">init</span> <span class="skolem">err</span> <span class="skolem">xs</span> <span class="skolem">ys</span>
          <span class="keyword1"><span class="command">using</span></span> that f_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">err</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">init</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fold2.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> match_result.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_Match <span class="var">?fold</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fold</span> <span class="main">=</span> Match_type_error <span class="main">∨</span> <span class="var">?fold</span> <span class="main">=</span> No_match"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?fold</span></span></span><span class="main">)</span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> f_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match_result_related.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_all_related<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="free">cs</span> <span class="free">ml_cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v</span> <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result as_static_cenv <span class="free">ml_v</span> <span class="free">ml_cs</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="free">ml_rhs</span><span class="main">,</span> <span class="free">ml_pat</span><span class="main">,</span> <span class="free">eenv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">rhs</span> <span class="free">pat</span> <span class="free">Γ</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ml_pat</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="free">pat</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"related_exp <span class="free">rhs</span> <span class="free">ml_rhs</span>"</span></span>
    <span class="quoted"><span class="quoted">"vfind_match <span class="free">cs</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"var_env <span class="free">Γ</span> <span class="free">eenv</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">ml_cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quoted"><span class="free">ml_pat</span></span> <span class="quoted"><span class="free">ml_rhs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">ml_c</span> <span class="skolem">ml_cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat0</span></span> <span class="skolem"><span class="skolem">rhs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat0</span><span class="main">,</span> <span class="skolem">rhs0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ml_pat0</span></span> <span class="skolem"><span class="skolem">ml_rhs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ml_pat0</span><span class="main">,</span> <span class="skolem">ml_rhs0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_pat0</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">rhs0</span> <span class="skolem">ml_rhs0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"match_result_related <span class="main">[]</span> <span class="main">(</span>cupcake_pmatch as_static_cenv <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span><span class="main">)</span> <span class="free">ml_v</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_pmatch_related<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cupcake_pmatch as_static_cenv <span class="skolem">ml_pat0</span> <span class="free">ml_v</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Match_type_error
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> No_match

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result as_static_cenv <span class="free">ml_v</span> <span class="skolem">ml_cs</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">ml_rhs</span><span class="main">,</span> <span class="skolem">ml_pat</span><span class="main">,</span> <span class="free">eenv</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>7<span class="main">)</span> No_match <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">rhs</span> <span class="skolem">Γ</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_pat</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">rhs</span> <span class="skolem">ml_rhs</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"var_env <span class="skolem">Γ</span> <span class="free">eenv</span>"</span></span>

          <span class="keyword1"><span class="command">from</span></span> rel <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="main">[]</span> No_match <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> No_match <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_pat0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> None"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_result_related.cases<span class="main">)</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vfind_match <span class="skolem">cs</span> <span class="free">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Match <span class="skolem">eenv'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_rhs</span> <span class="main">=</span> <span class="skolem">ml_rhs0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_pat</span> <span class="main">=</span> <span class="skolem">ml_pat0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eenv</span> <span class="main">=</span> <span class="skolem">eenv'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">from</span></span> rel <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match_result_related <span class="main">[]</span> <span class="main">(</span>Match <span class="skolem">eenv'</span><span class="main">)</span> <span class="main">(</span>vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command">using</span></span> Match <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_pat0</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> Some <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"var_env <span class="skolem">Γ</span> <span class="skolem">eenv'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_result_related.cases<span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_pat</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_pat</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">rhs0</span> <span class="skolem">ml_rhs</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"var_env <span class="skolem">Γ</span> <span class="free">eenv</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">eenv</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="main">(</span><span class="skolem">c</span> <span class="main">#</span> <span class="skolem">cs</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">pat0</span><span class="main">,</span> <span class="skolem">rhs0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat0</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> Some <span class="skolem">Γ</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Correctness">
<div class="head">
<h1>Theory CakeML_Correctness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of compilation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Correctness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="CakeML_Backend.html">CakeML_Backend</a>
  <span class="quoted">"<a href="Big_Step_Value_ML.html">../Rewriting/Big_Step_Value_ML</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> cakeml' <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_rec_env_related<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> related_fun <span class="bound">cs</span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="free">css</span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name <span class="main">(</span>map_prod Name id<span class="main">)</span><span class="main">)</span> <span class="free">funs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>fbind <span class="main">(</span>fmran <span class="free">css</span><span class="main">)</span> <span class="main">(</span>ids <span class="main">∘</span> Sabs<span class="main">)</span><span class="main">)</span> related_v <span class="free">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmrel related_v <span class="main">(</span>mk_rec_env <span class="free">css</span> <span class="free">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">(</span>cake_mk_rec_env <span class="free">funs</span> <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fmrelI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> related_fun <span class="bound">cs</span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">css</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span>map_prod Name <span class="main">(</span>map_prod Name id<span class="main">)</span><span class="main">)</span> <span class="free">funs</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_of_list.rep_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> related_fun <span class="bound">cs</span> <span class="main">(</span>Name <span class="bound">n</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">css</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>map_of <span class="free">funs</span> <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> name.map_of_rekey'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"related_v <span class="main">(</span>Vrecabs <span class="free">css</span> <span class="skolem">name</span> <span class="free">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">(</span>Recclosure <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="free">funs</span> <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> related_v.rec_closure<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option related_v <span class="main">(</span>fmlookup <span class="main">(</span>mk_rec_env <span class="free">css</span> <span class="free">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span>cake_mk_rec_env <span class="free">funs</span> <span class="free">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def cake_mk_rec_env_def fmap_of_list.rep_eq
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_keyed name.map_of_rekey option.rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_mono_strong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mk_exp_correctness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ids <span class="free">t</span> <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟹</span> all_consts <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> shadows_consts <span class="free">t</span> <span class="main">⟹</span> related_exp <span class="free">t</span> <span class="main">(</span>mk_exp <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ids <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟹</span> all_consts <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="free">cs</span><span class="main">)</span> <span class="main">⟹</span> list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="free">cs</span> <span class="main">(</span>mk_clauses <span class="free">S</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ids <span class="free">t</span> <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟹</span> all_consts <span class="main">|⊆|</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> shadows_consts <span class="free">t</span> <span class="main">⟹</span> related_exp <span class="free">t</span> <span class="main">(</span>mk_con <span class="free">S</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mk_exp_mk_clauses_mk_con.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">S</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> C"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>mk_exp <span class="skolem">S</span> <span class="main">(</span>Sconst <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> related_exp.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> list_comb.simps<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_sterm_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> related_exp.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">S</span> <span class="skolem">cs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fresh_fNext <span class="main">(</span><span class="skolem">S</span> <span class="main">|∪|</span> all_consts<span class="main">)</span> <span class="main">|∉|</span> <span class="skolem">S</span> <span class="main">|∪|</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fNext_not_member<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fresh_fNext <span class="skolem">S</span> <span class="main">|∉|</span> <span class="skolem">S</span> <span class="main">|∪|</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹all_consts <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fresh_fNext <span class="skolem">S</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∪|</span> all_consts"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_exp.fun<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"4.IH"</span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> mk_clauses.simps<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fresh_fNext <span class="skolem">S</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|∪|</span> all_consts›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">S</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_con.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.splits sterm.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> args c
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">$$</span> <span class="skolem">args</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_sterm_def<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv list_strip_comb snd_conv<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_exp.constr<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_refl_strong<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 5<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prems<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ids <span class="skolem">t</span> <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ids_list_comb<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ffUnion_subset_elem fimage_eqI fset_of_list_elem fset_rev_mp<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 5<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> shadows.list_comb
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sterm.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">S</span> <span class="skolem">cs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> rel_prod related_pat related_exp <span class="bound">x</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">y</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="bound">pat</span><span class="main">)</span><span class="main">,</span> mk_con <span class="main">(</span>frees <span class="bound">pat</span> <span class="main">|∪|</span> <span class="skolem">S</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_refl_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_prod.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pat</span> <span class="skolem">rhs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ids_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ffUnion_least_rev<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBallE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span> <span class="main">|∪|</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ids_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ffUnion_least_rev<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBallE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> 6
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">rhs</span> <span class="main">(</span>mk_con <span class="main">(</span>frees <span class="skolem">pat</span> <span class="main">|∪|</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 6<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ids_def
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> <span class="skolem">S</span>›</span></span> <span class="quoted"><span class="quoted">‹frees <span class="skolem">rhs</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span> <span class="main">|∪|</span> <span class="skolem">S</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> 6<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> related_exp.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ids_def fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> semantic_correctness0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">exp</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="free">env</span> <span class="free">exp</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="free">t</span><span class="main">)</span> related_v <span class="free">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="free">t</span> <span class="free">exp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> fmdom <span class="free">Γ</span> <span class="main">|∪|</span> C"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"if_rval <span class="main">(</span><span class="main">λ</span><span class="bound">ml_v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="bound">v</span> <span class="main">∧</span> related_v <span class="bound">v</span> <span class="bound">ml_v</span><span class="main">)</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>con1 <span class="skolem">env</span> <span class="skolem">cn</span> <span class="skolem">es</span> <span class="skolem">ress</span> <span class="skolem">ml_vs</span> <span class="skolem">ml_v'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cn</span> <span class="main">=</span> Some <span class="main">(</span>Short <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> C"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 related_exp <span class="skolem">ts</span> <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t</span> <span class="main">(</span>Con <span class="skolem">cn</span> <span class="skolem">es</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> con1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tid</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_v'</span> <span class="main">=</span> Conv <span class="main">(</span>Some <span class="main">(</span>id_to_n <span class="main">(</span>Short <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">tid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">ml_vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ress</span> <span class="main">=</span> map Rval <span class="skolem">ml_vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> con1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ml_vs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_vs'</span> <span class="main">=</span> rev <span class="skolem">ml_vs</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted"><span class="quoted">‹list_all2_shortcircuit <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span><span class="main">[</span>
              <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ress</span> <span class="main">=</span> <span class="main">_</span>›</span></span> list_all2_shortcircuit_rval list_all2_rev1<span class="main">,</span>
              <span class="operator">folded</span> ml_vs'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"list_all wellformed <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> shadows_consts <span class="bound">t</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> consts <span class="bound">t</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C<span class="main">)</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> closed_except <span class="bound">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> wellformed.list_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> shadows.list_comb
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="skolem">t</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ball_set <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="skolem">ts</span>›</span></span> con1.prems<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> special_constants.sconsts_list_comb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> closed.list_comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> fmrel_on_fset <span class="main">(</span>ids <span class="bound">t'</span><span class="main">)</span> related_v <span class="skolem">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ids <span class="skolem">t'</span> <span class="main">|⊆|</span> ids <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ids_list_comb<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ids_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsubset_finsertI2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ffUnion_subset_elem<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> related_v <span class="skolem">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>veval' <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 related_v <span class="skolem">us</span> <span class="skolem">ml_vs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 related_exp <span class="skolem">ts</span> <span class="skolem">es</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">es</span></span> <span class="quoted"><span class="skolem">ml_vs'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">es</span> <span class="skolem">ml_v</span> <span class="skolem">ml_vs</span> <span class="skolem">ts0</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ts0</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">t</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts0</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 related_exp <span class="skolem">ts</span> <span class="skolem">es</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>veval' <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 related_v <span class="skolem">us</span> <span class="skolem">ml_vs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ts0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">from</span></span> Cons.hyps<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="skolem">u</span> "</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">u</span> <span class="skolem">ml_v</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span>
            <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">t</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">Γ</span>"</span></span>
            <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span>
            <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"consts <span class="skolem">t</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C"</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> related_v <span class="skolem">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ts0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">#</span> <span class="skolem">us</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ts0</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.constr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_v'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ml_vs'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_v.conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var1 <span class="skolem">env</span> <span class="skolem">id</span> <span class="skolem">ml_v</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t</span> <span class="main">(</span>Var <span class="skolem">id</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">=</span> Short <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> var1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_nsLookup <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ml_v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t</span> <span class="main">(</span>Var <span class="skolem">id</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>var<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Svar <span class="skolem">name</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>const<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Sconst <span class="skolem">name</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> C"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> name.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> var
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> ids <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option related_v <span class="main">(</span>fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>cupcake_nsLookup <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_on_fsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> ids <span class="skolem">t</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">v</span> <span class="skolem">ml_v</span>"</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cupcake_nsLookup <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.var<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> const
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> ids <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option related_v <span class="main">(</span>fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>cupcake_nsLookup <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_on_fsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">name</span> <span class="main">|∈|</span> ids <span class="skolem">t</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">v</span> <span class="skolem">ml_v</span>"</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">Γ</span> <span class="skolem">name</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cupcake_nsLookup <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.const<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn <span class="skolem">env</span> <span class="skolem">n</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> as_string <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> name.sel<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="skolem"><span class="skolem">ml_cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="skolem">n'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">|∉|</span> all_consts"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t</span> <span class="main">(</span>Fun <span class="skolem">n</span> <span class="skolem">u</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> name.expand<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> fmap_of_list <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">env</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.abs<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_v.closure<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> related_fun_alt_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t</span><span class="main">)</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">env</span> <span class="skolem">exps</span> <span class="skolem">ress</span> <span class="skolem">ml_vs</span> <span class="skolem">env'</span> <span class="skolem">exp'</span> <span class="skolem">bv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t</span> <span class="main">_</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">exps</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">exps</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> app1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ress</span> <span class="main">=</span> map Rval <span class="skolem">ml_vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_vs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> list_all2_shortcircuit_rval list_all2_Cons1 list_all2_Nil<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">exps</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> related_exp_is_cupcake<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> related_v <span class="skolem">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> related_v <span class="skolem">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmrel_on_fsubset<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env</span> <span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Rval <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env</span> <span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>Rval <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↓</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∧</span> related_v <span class="bound">t<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↓</span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">∧</span> related_v <span class="bound">t<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">exp<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">exp<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ress</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">exps</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_single_preserve<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_single_preserve<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all is_cupcake_value <span class="main">(</span>rev <span class="skolem">ml_vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="skolem">exp'</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹do_opapp <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cupcake_opapp_preserve<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">_</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> app1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_rvalI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ml_v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bv</span> <span class="main">=</span> Rval <span class="skolem">ml_v</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="bound">v</span> <span class="main">∧</span> related_v <span class="bound">v</span> <span class="skolem">ml_v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹do_opapp <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> do_opapp_cases<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>closure <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="skolem">n</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> closure'<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Closure <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">exp'</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">env'</span> <span class="main">=</span> update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsBind <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>sem_env.v <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span></span> <span class="skolem"><span class="skolem">cs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Vabs <span class="skolem">cs</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span> <span class="quoted"><span class="quoted">"related_fun <span class="skolem">cs</span> <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">exp'</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹related_v <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ml_cs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">exp'</span> <span class="main">=</span> Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_cs</span>"</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> related_funE<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env'</span> <span class="main">(</span>Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_cs</span><span class="main">)</span> <span class="main">(</span>Rval <span class="skolem">ml_v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cupcake_evaluate_single <span class="skolem">env'</span> <span class="skolem">exp'</span> <span class="skolem">bv</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m_env</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">ml_rhs</span></span> <span class="skolem"><span class="skolem">ml_pat</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env'</span> <span class="main">(</span>Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Rval <span class="skolem">v'</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>sem_env.c <span class="skolem">env'</span><span class="main">)</span> <span class="skolem">v'</span> <span class="skolem">ml_cs</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">ml_rhs</span><span class="main">,</span> <span class="skolem">ml_pat</span><span class="main">,</span> <span class="skolem">m_env</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="main">(</span><span class="skolem">env'</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">m_env</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env'</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">ml_rhs</span> <span class="main">(</span>Rval <span class="skolem">ml_v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sconsts_sabs
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"if_rval <span class="main">(</span><span class="main">λ</span><span class="bound">ml_v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="main">↓</span> <span class="bound">v</span> <span class="main">∧</span> related_v <span class="bound">v</span> <span class="bound">ml_v</span><span class="main">)</span> <span class="skolem">bv</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> app1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> related_v <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> closure'
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> frees_sterm.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> consts_sterm.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> name.sel <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ids_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sem_env.splits<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fset_updateI<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> ids_def<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹related_v <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">exp'</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">exp'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>related_exp.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> name.sel<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">|∪|</span> C›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts›</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def all_consts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">v</span> <span class="skolem">ml_v</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> veval'_sabs_svarE<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> veval'_agree_eq<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="skolem">rhs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> fmdom <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>"</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ids_def
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> A
                      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
                      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ids_def
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> B
                      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∈|</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ids_def
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>

              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> erelated_refl<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> erelated_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">|∪|</span> C›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> sconsts_sabs
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff fdisjnt_alt_def all_consts_def<span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts›</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts_env <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_welldefined'<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.comb<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_v_ext<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>recclosure <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="skolem">funs</span> <span class="skolem">name</span> <span class="skolem">n</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> recclosure <span class="keyword1"><span class="command">have</span></span> recclosure'<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Recclosure <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="skolem">funs</span> <span class="skolem">name</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">env'</span> <span class="main">=</span> update_v <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> nsBind <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>build_rec_env <span class="skolem">funs</span> <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">(</span>sem_env.v <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span></span> <span class="skolem"><span class="skolem">css</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Vrecabs <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>fbind <span class="main">(</span>fmran <span class="skolem">css</span><span class="main">)</span> <span class="main">(</span>ids <span class="main">∘</span> Sabs<span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmrel <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> related_fun <span class="bound">cs</span> <span class="bound">n</span> <span class="bound">e</span><span class="main">)</span> <span class="skolem">css</span> <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name <span class="main">(</span>map_prod Name id<span class="main">)</span><span class="main">)</span> <span class="skolem">funs</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹related_v <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹fmrel <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">cs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">.</span> related_fun <span class="bound">cs</span> <span class="main">(</span>Name <span class="bound">n</span><span class="main">)</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_recfun <span class="skolem">name</span> <span class="skolem">funs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> option.rel_sel<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmrel_fmdom_eq<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> fmdom_notI<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Vrecabs <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command">using</span></span> recclosure<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fmrel_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">name</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmlookup_of_list<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> name.map_of_rekey'<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"related_fun <span class="skolem">cs</span> <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">exp'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹find_recfun <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ml_cs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">exp'</span> <span class="main">=</span> Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="main">(</span>as_string <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_cs</span>"</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> related_funE<span class="main">)</span>

          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env'</span> <span class="main">(</span>Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ml_cs</span><span class="main">)</span> <span class="main">(</span>Rval <span class="skolem">ml_v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cupcake_evaluate_single <span class="skolem">env'</span> <span class="skolem">exp'</span> <span class="skolem">bv</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m_env</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">ml_rhs</span></span> <span class="skolem"><span class="skolem">ml_pat</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="skolem">env'</span> <span class="main">(</span>Var <span class="main">(</span>Short <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Rval <span class="skolem">v'</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_match_result <span class="main">(</span>sem_env.c <span class="skolem">env'</span><span class="main">)</span> <span class="skolem">v'</span> <span class="skolem">ml_cs</span> Bindv <span class="main">=</span> Rval <span class="main">(</span><span class="skolem">ml_rhs</span><span class="main">,</span> <span class="skolem">ml_pat</span><span class="main">,</span> <span class="skolem">m_env</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="main">(</span><span class="skolem">env'</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">m_env</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env'</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="skolem">ml_rhs</span> <span class="main">(</span>Rval <span class="skolem">ml_v</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> mk_rec_env_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vclosed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">css</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">|∪|</span> <span class="main">(</span>C <span class="main">|∪|</span> fmdom <span class="skolem">css</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sconsts_sabs
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmpredD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">css</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"if_rval <span class="main">(</span><span class="main">λ</span><span class="bound">ml_v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="main">↓</span> <span class="bound">v</span> <span class="main">∧</span> related_v <span class="bound">v</span> <span class="bound">ml_v</span><span class="main">)</span> <span class="skolem">bv</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> app1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> funion_image_bind_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ffUnion_subset_elem<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fimage_iff<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmranI<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">(</span>cake_mk_rec_env <span class="skolem">funs</span> <span class="skolem">env<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mk_rec_env_related<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fmrelD<span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel <span class="main">_</span> <span class="skolem">css</span> <span class="main">_</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>fbind <span class="main">_</span> <span class="main">_</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">_</span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> related_v <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> recclosure'
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> frees_sterm.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> consts_sterm.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> name.sel <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ids_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sem_env.splits<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fset_updateI<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> build_rec_env_fmap
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fset_addI<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> ids_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmrel_on_fset <span class="main">(</span>ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span><span class="main">)</span> related_v <span class="main">(</span>mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹related_v <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ml_v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">exp'</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">exp'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_exp.intros<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_exp.intros<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff closed_except_def<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts›</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> mk_rec_env_def <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def all_consts_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> Svar <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">v</span> <span class="skolem">ml_v</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">bv</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span>
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> veval'_sabs_svarE<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vfind_match_elem<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwellformed <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmlookup <span class="skolem">css</span> <span class="main">(</span>Name <span class="skolem">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">pat</span> <span class="main">=</span> patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_dom<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> veval'_agree_eq<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="skolem">rhs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> fmdom <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>"</span></span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ids_def
                    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
                      <span class="keyword3"><span class="command">case</span></span> A
                      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
                        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
                      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∈|</span> frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ids_def
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">next</span></span>
                      <span class="keyword3"><span class="command">case</span></span> B
                      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Name <span class="skolem">n</span> <span class="main">|∈|</span> consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                        <span class="keyword1"><span class="command">unfolding</span></span> ffUnion_alt_def
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span><span class="main">)</span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ids_def
                        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                    <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">qed</span></span>

                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> erelated <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> erelated_refl<span class="main">)</span>
                  <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> erelated_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                  <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> erelated_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>›</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ballE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> sconsts_sabs mk_rec_env_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">env</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff all_consts_def fdisjnt_alt_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">css</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vwelldefined' <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Name <span class="skolem">n</span> <span class="main">|∉|</span> all_consts›</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def mk_rec_env_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹not_shadows_vconsts_env <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_welldefined'<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmupd <span class="main">(</span>Name <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> mk_rec_env <span class="skolem">css</span> <span class="skolem">Γ<span class="hidden">⇩</span><sub>Λ</sub></span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.rec_comb<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_v_ext<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mat1 <span class="skolem">env</span> <span class="skolem">ml_scr</span> <span class="skolem">ml_scr'</span> <span class="skolem">ml_cs</span> <span class="skolem">ml_rhs</span> <span class="skolem">ml_pat</span> <span class="skolem">env'</span> <span class="skolem">ml_res</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">scr</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Sabs <span class="skolem">cs</span> <span class="keyword1">$<span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">scr</span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">scr</span> <span class="skolem">ml_scr</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹related_exp <span class="skolem">t</span> <span class="main">(</span>Mat <span class="skolem">ml_scr</span> <span class="skolem">ml_cs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sem_env.c <span class="skolem">env</span> <span class="main">=</span> as_static_cenv"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_all_env <span class="skolem">env</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_cupcake_all_envE<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">scr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">scr</span> <span class="main">↓</span> <span class="skolem">scr'</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">scr'</span> <span class="skolem">ml_scr'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> if_rval.simps
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span>
        <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">scr</span> <span class="skolem">ml_scr</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="skolem">Γ</span>"</span></span>
        <span class="quoted"><span class="quoted">"closed_venv <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">scr</span><span class="main">)</span> related_v <span class="skolem">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> ids_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span>
        <span class="quoted"><span class="quoted">"wellformed <span class="skolem">scr</span>"</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">scr</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C"</span></span>
        <span class="quoted"><span class="quoted">"closed_except <span class="skolem">scr</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">scr</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> linear <span class="bound">pat</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">Γ'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_pat</span> <span class="main">=</span> mk_ml_pat <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">rhs</span> <span class="skolem">ml_rhs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vfind_match <span class="skolem">cs</span> <span class="skolem">scr'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"var_env <span class="skolem">Γ'</span> <span class="skolem">env'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">cs</span> <span class="skolem">ml_cs</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">_</span> <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹related_v <span class="skolem">scr'</span> <span class="skolem">ml_scr'</span>›</span></span> mat1<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹sem_env.c <span class="skolem">env</span> <span class="main">=</span> as_static_cenv›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> match_all_related<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vmatch <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="skolem">scr'</span> <span class="main">=</span> Some <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> vfind_match_elem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="main">=</span> fmdom <span class="skolem">Γ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vmatch_dom<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vfind_match_elem<span class="main">)</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="skolem">Γ'</span> <span class="main">=</span> frees <span class="skolem">pat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹patvars <span class="main">(</span>mk_pat <span class="skolem">pat</span><span class="main">)</span> <span class="main">=</span> fmdom <span class="skolem">Γ'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_pat_frees<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_rvalI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ml_rhs'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ml_res</span> <span class="main">=</span> Rval <span class="skolem">ml_rhs'</span>"</span></span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rhs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">rhs</span> <span class="main">↓</span> <span class="skolem">rhs'</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="skolem">rhs'</span> <span class="skolem">ml_rhs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mat1<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ml_res</span> <span class="main">=</span> <span class="main">_</span>›</span></span> if_rval.simps
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_v_update_preserve<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>is_cupcake_value <span class="main">∘</span> snd<span class="main">)</span> <span class="skolem">env'</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> match_all_preserve<span class="main">)</span>
                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cupcake_c_ns <span class="main">(</span>sem_env.c <span class="skolem">env</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹sem_env.c <span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> static_cenv<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="main">(</span>Mat <span class="skolem">ml_scr</span> <span class="skolem">ml_cs</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_exp_is_cupcake<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"cupcake_clauses <span class="skolem">ml_cs</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

                  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="skolem">ml_scr'</span>"</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_single_preserve<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat1<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mat1<span class="main">)</span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹is_cupcake_exp <span class="main">(</span>Mat <span class="skolem">ml_scr</span> <span class="skolem">ml_cs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_alist_to_ns_preserve<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_all_envD<span class="main">)</span> <span class="operator">fact</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_cupcake_ns <span class="main">(</span>nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsAppend_preserve<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="skolem">rhs</span> <span class="skolem">ml_rhs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom <span class="main">(</span>fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name id<span class="main">)</span> <span class="skolem">env'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fmdom <span class="skolem">Γ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹var_env <span class="skolem">Γ'</span> <span class="skolem">env'</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmrel_fmdom_eq<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∉|</span> fmdom <span class="skolem">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">id</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">id</span> <span class="main">|∈|</span> ids <span class="skolem">rhs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ids_def
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> funion_strictE<span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> A
              <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∉|</span> frees <span class="skolem">pat</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">Γ'</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="skolem">t</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ffUnion_alt_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> consts <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> B
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> consts <span class="skolem">t</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ffUnion_alt_def<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">id</span> <span class="main">|∈|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> consts <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> related_v <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod Name id<span class="main">)</span> <span class="skolem">env'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrelD<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹var_env <span class="skolem">Γ'</span> <span class="skolem">env'</span>›</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> *
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> comp_def fimageI fmdom_fmap_of_list fset_of_list_map fst_comp_map_prod<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> **
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmlookup_ns fmrel_on_fsetD mat1.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="skolem">rhs</span><span class="main">)</span> related_v <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="main">(</span><span class="skolem">env</span> <span class="main">⦇</span> sem_env.v <span class="main">:=</span> nsAppend <span class="main">(</span>alist_to_ns <span class="skolem">env'</span><span class="main">)</span> <span class="main">(</span>sem_env.v <span class="skolem">env</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sem_env.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vwellformed.vmatch_env<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_wellformed<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vclosed.vmatch_env<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_closed<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vmatch_welldefined'<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_welldefined'<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows_vconsts.vmatch_env<span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'_shadows<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
            <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹wellformed <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">Γ'</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">t</span> <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> fmdom <span class="skolem">Γ</span> <span class="main">|∪|</span> C"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mat1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">rhs</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">Γ'</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹consts <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> sconsts_sabs
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹fmdom <span class="skolem">Γ'</span> <span class="main">=</span> frees <span class="skolem">pat</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff fdisjnt_alt_def all_consts_def<span class="main">)</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span><span class="skolem">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fdisjnt C <span class="main">(</span>fmdom <span class="skolem">Γ</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">t</span> <span class="main">↓</span> <span class="bound">t'</span> <span class="main">∧</span> related_v <span class="bound">t'</span> <span class="skolem">ml_rhs'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI seval.intros<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.intros<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> veval'.intros<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> semantic_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">exp</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single <span class="free">env</span> <span class="free">exp</span> <span class="main">(</span>Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="free">t</span><span class="main">)</span> related_v <span class="free">Γ</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v <span class="free">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="free">t</span> <span class="free">exp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> fmdom <span class="free">Γ</span> <span class="main">|∪|</span> C"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v</span> <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> semantic_correctness0<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CakeML_Byte">
<div class="head">
<h1>Theory CakeML_Byte</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Converting bytes to integers›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CakeML_Byte
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CakeML/Evaluate_Single.html">CakeML.Evaluate_Single</a>
  <a href="../Show/Show_Instances.html">Show.Show_Instances</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pat</span> <span class="main">::</span> <span class="quoted">Ast.pat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pat</span> <span class="main">=</span> Ast.Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="inner_quoted">''String_char_Char''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Ast.Pvar <span class="main">(</span><span class="inner_quoted">''b''</span> <span class="main">@</span> show <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">8</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_plus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_plus</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Ast.App <span class="main">(</span>Ast.Opn Ast.Plus<span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cake_plus_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s'</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">s''</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="main">(</span>cake_plus <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s''</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cake_plus_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_times</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_times</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Ast.App <span class="main">(</span>Ast.Opn Ast.Times<span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cake_times_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s'</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">s''</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate <span class="free">env</span> <span class="free">s</span> <span class="main">(</span>cake_times <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s''</span><span class="main">,</span> Rval <span class="main">(</span>Litv <span class="main">(</span>IntLit <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cake_times_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_int_of_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_int_of_bool</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Ast.Mat <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="main">[</span><span class="main">(</span>Ast.Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="inner_quoted">''HOL_False''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">,</span> Lit <span class="main">(</span>IntLit <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
   <span class="main">(</span>Ast.Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="inner_quoted">''HOL_True''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">,</span> Lit <span class="main">(</span>IntLit <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">summands</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">summands</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> cake_times <span class="main">(</span>Lit <span class="main">(</span>IntLit <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>cake_int_of_bool <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="main">(</span><span class="inner_quoted">''b''</span> <span class="main">@</span> show <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">8</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cake_int_of_byte</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_int_of_byte</span> <span class="main">=</span>
  Ast.Fun <span class="inner_quoted">''x''</span> <span class="main">(</span>Ast.Mat <span class="main">(</span>Ast.Var <span class="main">(</span>Short <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span>pat<span class="main">,</span> foldl cake_plus <span class="main">(</span>Lit <span class="main">(</span>IntLit <span class="main">0</span><span class="main">)</span><span class="main">)</span> summands<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Doc_Compiler">
<div class="head">
<h1>Theory Doc_Compiler</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Composition of phases and full compilation pipeline›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Doc_Compiler
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Composition">
<div class="head">
<h1>Theory Composition</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Composition of correctness results›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Composition
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="CakeML_Correctness.html">../Backend/CakeML_Correctness</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> sem_env.v

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">term</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟶›</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟶›</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">pterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⟶›</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">sterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexive-transitive closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source=true] irules.compile_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prules<span class="main">)</span> prewrite_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rhs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> beta <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="skolem">rhs</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rewrite_step_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ beta<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_except <span class="skolem">rhs</span> <span class="main">(</span>frees <span class="skolem">pat</span><span class="main">)</span>›</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prules<span class="main">)</span> prewrite_rt_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prewrite_closed<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> compile_correct_rt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Rewriting_Pterm.compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> step
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> compile_correct rtranclp.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexive-transitive closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source=true] prules.compile_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prules<span class="main">)</span> compile_correct_rt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Rewriting_Sterm.compile <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">u</span> <span class="main">⟶*</span> <span class="free">u'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> sterm_to_pterm <span class="free">u</span> <span class="main">⟶*</span> sterm_to_pterm <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> step
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> compile_correct rtranclp.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> srewrite_stepD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"srewrite_step <span class="free">rs</span> <span class="free">name</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> srules<span class="main">)</span> srewrite_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">name</span> <span class="skolem">rhs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> srewrite_stepD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> all_rules <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">cs</span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> subst <span class="skolem">rhs</span> <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> rewrite_firstE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subst_wellformed<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">rhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">cs</span>›</span></span> beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_env <span class="skolem">env</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">pat</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span> beta
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wellformed.match<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> srules<span class="main">)</span> srewrite_wellformed_rt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> srewrite_wellformed<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vno_abs_value_to_sterm<span class="main">:</span> <span class="quoted"><span class="quoted">"no_abs <span class="main">(</span>value_to_sterm <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> vno_abs <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">v</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> no_abs.list_comb list_all_iff<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexive-transitive closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source=true] rules.compile_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rules<span class="main">)</span> compile_correct_rt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">u</span> <span class="main">⟶*</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> nterm_to_term' <span class="free">u</span> <span class="main">⟶*</span> nterm_to_term' <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">u'</span> <span class="skolem">u''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> nterm_to_term' <span class="free">u</span> <span class="main">⟶*</span> nterm_to_term' <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> nterm_to_term' <span class="skolem">u'</span> <span class="main">⟶</span> nterm_to_term' <span class="skolem">u''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rewrite_rt_closed <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compile_correct <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexive-transitive closure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source=true] irules.transform_correct<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> transform_correct_rt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">u</span> <span class="main">⟶*</span> <span class="free">u''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t''</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t''</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u''</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">u'</span> <span class="skolem">u''</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t'</span> <span class="main">⟶*</span> <span class="skolem">t''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t''</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u''</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transform_correct<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹transform_irule_set <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">u'</span> <span class="main">⟶</span> <span class="skolem">u''</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="skolem">u'</span>›</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> irewrite_rt_closed<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>›</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">t</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> step.prems<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rtranclp_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> transform_correct_rt_no_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transform_irule_set <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prelated_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transform_correct_rt<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">t</span>›</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prelated_no_abs_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> transform_correct_rt_n_no_abs0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irules <span class="free">C</span> <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> irules <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">rs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> transform_correct_rt_no_abs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rules_transform<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_swap1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> transform_correct_rt_n_no_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">t</span> <span class="main">⟶*</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transform_correct_rt_n_no_abs0<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> irules_axioms assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">hide_fact</span></span> transform_correct_rt_n_no_abs0


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Iterated application of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> transform_irule_set<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">max_arity</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> fMax <span class="main">(</span><span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rules_transform_iter0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irules <span class="free">C_info</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irules <span class="free">C_info</span> <span class="main">(</span><span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irules.rules_transform <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> irulesI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> rules_transform_iter<span class="main">:</span> <span class="quoted"><span class="quoted">"irules <span class="free">C_info</span> <span class="main">(</span><span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_transform_iter0<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> irules_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transform_irule_set_n_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> <span class="main">(</span><span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transform_irule_set_heads<span class="main">)</span>

<span class="keyword1"><span class="command">hide_fact</span></span> rules_transform_iter0

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transform_irule_set_iter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> irule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">transform_irule_set_iter</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span>transform_irule_set <span class="main">^^</span> max_arity <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transform_irule_set_iter_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> transform_irule_set_iter <span class="free">rs</span> <span class="main">=</span> fst <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_iter_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transform_irule_set_n_heads<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> finished_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span> <span class="main">⟷</span> max_arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"max_arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fBex <span class="main">(</span><span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty
    <span class="keyword1"><span class="command">unfolding</span></span> max_arity_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fBex_fempty fmax_ex_gr not_less0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finished_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fMax <span class="main">(</span><span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fMax_le<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span><span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finished <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finished_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max_arity <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_arity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> transform_finished_id<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span> <span class="main">⟹</span> transform_irule_set <span class="free">rs</span> <span class="main">=</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def finished_def transform_irules_def map_prod_def id_apply
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fset_map_snd_id<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember.rep_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBallE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> max_arity_decr<span class="main">:</span> <span class="quoted"><span class="quoted">"max_arity <span class="main">(</span>transform_irule_set <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> max_arity <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finished <span class="free">rs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transform_finished_id finished_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> transform_irule_set <span class="free">rs</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_def fset.map_comp
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong0<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> o_apply map_prod_simp id_apply snd_conv<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">irs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">rs</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">irs</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmember.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"arity_compatibles <span class="skolem">irs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonempty inner <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fpairwiseD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>transform_irules <span class="skolem">irs</span><span class="main">)</span> <span class="main">=</span> arity <span class="skolem">irs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arity_transform_irules<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"max_arity <span class="main">(</span>transform_irule_set <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> fMax <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_arity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fMax <span class="main">(</span><span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fmax_decr<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBex <span class="main">(</span><span class="main">(</span>arity <span class="main">∘</span> snd<span class="main">)</span> <span class="main">|`|</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="main">(≤)</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> finished_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_arity_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_arity_decr'0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irules <span class="free">C</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_arity <span class="main">(</span><span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> max_arity <span class="free">rs</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> irules.max_arity_decr<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> irules.rules_transform_iter <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> irulesI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> max_arity_decr'<span class="main">:</span> <span class="quoted"><span class="quoted">"max_arity <span class="main">(</span><span class="main">(</span>transform_irule_set <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> max_arity <span class="free">rs</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> max_arity_decr'0<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> irules_axioms<span class="main">)</span>

<span class="keyword1"><span class="command">hide_fact</span></span> max_arity_decr'0

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> irules<span class="main">)</span> transform_finished<span class="main">:</span> <span class="quoted"><span class="quoted">"finished <span class="main">(</span>transform_irule_set_iter <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_iter_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> irules.finished_alt_def<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_arity_decr' <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rules_transform_iter <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Rewriting_Pterm_Elim.irulesI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Trick as described in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>§7.1›</span></span></span></span> in the locale manual.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> irules' <span class="main">=</span> irules

<span class="keyword1"><span class="command">sublocale</span></span> irules' <span class="main">⊆</span> irules'_as_irules<span class="main">:</span> irules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"transform_irule_set_iter <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_iter_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_transform_iter<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> crules <span class="main">⊆</span> crules_as_irules'<span class="main">:</span> irules' <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"Rewriting_Pterm_Elim.compile <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> irules'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> compile_rules<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> irules' <span class="main">⊆</span> irules'_as_prules<span class="main">:</span> prules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted"><span class="quoted">"Rewriting_Pterm.compile <span class="main">(</span>transform_irule_set_iter <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> irules'_as_irules.compile_rules<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> transform_finished<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Big-step semantics›</span></span>

<span class="keyword1"><span class="command">context</span></span> srules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">global_css</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> sclauses<span class="main">)</span> fmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">global_css</span> <span class="main">=</span> fmap_of_list <span class="main">(</span>map <span class="main">(</span>map_prod id clauses<span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmdom_global_css<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom global_css <span class="main">=</span> fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> global_css_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">as_vrules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vrule list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">as_vrules</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">name</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">name</span><span class="main">,</span> Vrecabs global_css <span class="bound">name</span> fmempty<span class="main">)</span><span class="main">)</span> <span class="free">rs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> as_vrules_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list as_vrules <span class="main">=</span> fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fset.map_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> as_vrules_fst'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map fst as_vrules <span class="main">=</span> map fst <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all_as_vrulesI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> fmempty <span class="main">(</span>clauses <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> value_pred.pred <span class="free">P</span> <span class="free">Q</span> <span class="free">R</span> <span class="bound">t</span><span class="main">)</span> as_vrules"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="skolem">rhs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set as_vrules"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Vrecabs global_css <span class="skolem">name</span> fmempty"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">P</span> fmempty<span class="main">)</span> global_css"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> global_css_def list.pred_map
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmpred_of_list<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fmdom global_css"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> global_css_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set as_vrules›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def
    <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer'</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">(</span>fmdom global_css<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> global_css_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"value_pred.pred <span class="free">P</span> <span class="free">Q</span> <span class="free">R</span> <span class="skolem">rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> value_pred.pred_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> srules_as_vrules<span class="main">:</span> <span class="quoted"><span class="quoted">"vrules <span class="free">C_info</span> as_vrules"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> as_vrules_fst<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> vwellformed <span class="bound">t</span><span class="main">)</span> as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vwellformed_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all_as_vrulesI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.pred_mono_strong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> all_rules<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> clausesE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> vclosed <span class="bound">t</span><span class="main">)</span> as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vclosed_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all_as_vrulesI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.pred_mono_strong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> all_rules<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> clausesE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sterm.closed_except_simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> is_Vconstr <span class="bound">t</span><span class="main">)</span> as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all vrule as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list <span class="free">rs</span><span class="main">)</span> C"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> not_shadows_vconsts <span class="bound">rhs</span><span class="main">)</span> as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> not_shadows_vconsts_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all_as_vrulesI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.pred_mono_strong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> not_shadows<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff all_consts_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> clausesE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vconstructor_value_rs as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vconstructor_value_rs_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> vconstructor_value_def
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all_as_vrulesI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> vwelldefined <span class="bound">rhs</span><span class="main">)</span> as_vrules"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vwelldefined_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_all_as_vrulesI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.pred_mono_strong<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> swelldefined_rs<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> clausesE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> welldefined_sabs<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct all_constructors"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distinct_ctr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> srules_as_vrules<span class="main">:</span> vrules <span class="quoted"><span class="free">C_info</span></span> <span class="quoted">as_vrules</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> srules_as_vrules<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rs'_rs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"srules_as_vrules.rs' <span class="main">=</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> srules_as_vrules.rs'_def
<span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">unfolding</span></span> comp_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> case_prod_twice<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list_map_snd_id<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> global_css_def
<span class="keyword1"><span class="command">using</span></span> all_rules map
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff map_of_is_map map_of_map map_prod_def fmap_of_list.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a b
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> ballE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_abs_def term_cases_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> veval_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"as_vrules<span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> <span class="free">t</span> <span class="main">↓</span> value_to_sterm <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> srules_as_vrules.veval_correct<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rs'_rs_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ML-style semantics›</span></span>

<span class="keyword1"><span class="command">context</span></span> srules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> as_vrules_mk_rec_env<span class="main">:</span> <span class="quoted"><span class="quoted">"fmap_of_list as_vrules <span class="main">=</span> mk_rec_env global_css fmempty"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> global_css_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> as_vrules_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mk_rec_env_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmlookup_fmmap_keys<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmap_of_list.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmap_of_list.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_of_map_keyed<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> id_apply<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_of_map<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> option.map_comp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.map_cong<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> global_css_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">vrelated</span> <span class="main">≡</span> srules_as_vrules.vrelated"</span></span>
<span class="keyword1"><span class="command">notation</span></span> srules_as_vrules.vrelated <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">≈</span> _"</span> <span class="main">[</span>0<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vrecabs_global_css_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">|∈|</span> fmdom global_css"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> Vrecabs global_css <span class="free">name</span> fmempty <span class="main">≈</span> Vrecabs global_css <span class="free">name</span> fmempty"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">name</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> vrelated
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">name</span><span class="main">.</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Vrecabs global_css <span class="bound">name</span> fmempty <span class="main">∧</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Vrecabs global_css <span class="bound">name</span> fmempty <span class="main">∧</span> <span class="bound">name</span> <span class="main">|∈|</span> fmdom global_css<span class="main">)</span> <span class="main">∨</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span>mk_rec_env global_css fmempty<span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> as_vrules_mk_rec_env<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl_strong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_rec_env_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE exE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> vrelated <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> as_vrules_refl_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list as_vrules<span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> as_vrules_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> as_vrules_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_of_list.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_option_reflI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> map_of_SomeD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vrecabs_global_css_refl<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> global_css_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_fimage_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> as_vrules_refl_C<span class="main">:</span> <span class="quoted"><span class="quoted">"fmrel_on_fset C vrelated <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∈|</span> C"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∉|</span> fset_of_list <span class="main">(</span>map fst as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> srules_as_vrules.vconstructor_value_rs
    <span class="keyword1"><span class="command">unfolding</span></span> vconstructor_value_rs_def fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">|∉|</span> fmdom <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fmdom_notD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_option vrelated <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> veval'_correct''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">v</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmap_of_list as_vrules <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vno_abs <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"as_vrules<span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"as_vrules<span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≈</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fmap_of_list as_vrules <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> srules_as_vrules.veval'_correct'<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> as_vrules_fst<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> all_consts"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> srules_as_vrules.all_rules
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> "</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> srules_as_vrules.not_shadows
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>fst <span class="main">|`|</span> fset_of_list as_vrules <span class="main">|∪|</span> C<span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fset_unionI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> as_vrules_refl_rs<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> as_vrules_refl_C<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>consts <span class="free">t</span><span class="main">)</span> vrelated <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_on_fsubset<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> srules_as_vrules.vrelated.eq_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹CakeML›</span></span>

<span class="keyword1"><span class="command">context</span></span> srules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">as_sem_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env <span class="main">⇒</span> v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">as_sem_env</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">⦇</span> sem_env.v <span class="main">=</span> build_rec_env <span class="main">(</span>mk_letrec_body all_consts <span class="free">rs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> nsEmpty<span class="main">,</span> sem_env.c <span class="main">=</span> nsEmpty <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_sem_env<span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_dec <span class="free">ck</span> <span class="free">mn</span> <span class="free">env</span> <span class="free">state</span> <span class="main">(</span>compile_group all_consts <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="free">state</span><span class="main">,</span> Rval <span class="main">(</span>as_sem_env <span class="free">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_group_def as_sem_env_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_dec.dletrec1<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> mk_letrec_body_def Let_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>comp_def case_prod_twice<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> name_as_string.fst_distinct<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> compile_sem_env'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_evaluate_decs <span class="free">mn</span> <span class="free">state</span> <span class="free">env</span> <span class="main">[</span><span class="main">(</span>compile_group all_consts <span class="free">rs</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">state</span><span class="main">,</span> Rval <span class="main">(</span>as_sem_env <span class="free">env</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_group_def as_sem_env_def mk_letrec_body_def Let_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def case_prod_twice<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> name_as_string.fst_distinct<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> compile_prog<span class="main">[</span><span class="operator">unfolded</span> combine_dec_result.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"evaluate_prog <span class="free">ck</span> <span class="free">env</span> <span class="free">state</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="free">state</span><span class="main">,</span> combine_dec_result <span class="main">(</span>as_sem_env <span class="free">env</span><span class="main">)</span> <span class="main">(</span>Rval <span class="main">⦇</span> sem_env.v <span class="main">=</span> nsEmpty<span class="main">,</span> sem_env.c <span class="main">=</span> nsEmpty <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_prog.cons1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_top.tdec1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> compile_sem_env<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> evaluate_prog.empty<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> compile_prog'<span class="main">[</span><span class="operator">unfolded</span> combine_dec_result.simps<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_evaluate_prog <span class="free">state</span> <span class="free">env</span> <span class="main">(</span>compile <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">state</span><span class="main">,</span> combine_dec_result <span class="main">(</span>as_sem_env <span class="free">env</span><span class="main">)</span> <span class="main">(</span>Rval <span class="main">⦇</span> sem_env.v <span class="main">=</span> nsEmpty<span class="main">,</span> sem_env.c <span class="main">=</span> nsEmpty <span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compile_def fun_evaluate_prog_def no_dup_mods_def no_dup_top_types_def prog_to_mods_def prog_to_top_types_def decs_to_types_def
<span class="keyword1"><span class="command">using</span></span> compile_sem_env' compile_group_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sem_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sem_env</span> <span class="main">≡</span> extend_dec_env <span class="main">(</span>as_sem_env empty_sem_env<span class="main">)</span> empty_sem_env"</span></span>

<span class="comment1">(* FIXME introduce lemma: is_cupcake_all_env extend_dec_env *)</span>
<span class="comment1">(* FIXME introduce lemma: is_cupcake_all_env empty_sem_env *)</span>
<span class="keyword1"><span class="command">lemma</span></span> cupcake_sem_env<span class="main">:</span> <span class="quoted"><span class="quoted">"is_cupcake_all_env sem_env"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> as_sem_env_def sem_env_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> is_cupcake_all_envI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_dec_env_def empty_sem_env_def nsEmpty_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_nsAppend_preserve<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_build_rec_preserve<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_sem_env_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nsEmpty_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mk_letrec_cupcake<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_sem_env_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sem_env_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"fmrel related_v <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v sem_env<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_option related_v <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="skolem">name</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v sem_env<span class="main">)</span><span class="main">)</span> <span class="skolem">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            as_sem_env_def build_rec_env_fmap cake_mk_rec_env_def sem_env_def
            fmap_of_list.rep_eq map_of_map_keyed option.rel_map
            as_vrules_def mk_letrec_body_def comp_def case_prod_twice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.rel_refl_strong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_v.rec_closure<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            fmmap_of_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> apsnd_def map_prod_def id_def<span class="main"><span class="main">]</span></span> fmap.rel_map
            global_css_def Let_def map_prod_def comp_def case_prod_twice<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted">"map_of <span class="free">rs</span> <span class="skolem">name</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap.rel_refl_strong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> rhs
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prems
          <span class="keyword1"><span class="command">including</span></span> fmap.lifting
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_abs <span class="skolem">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">rhs</span>"</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> all_rules swelldefined_rs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"clauses <span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed_clauses <span class="skolem">cs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>›</span></span> all_rules
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rhs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff is_abs_def term_cases_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> related_fun_alt_def <span class="quoted"><span class="quoted">‹clauses <span class="skolem">rhs</span> <span class="main">=</span> <span class="skolem">cs</span>›</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod related_pat related_exp<span class="main">)</span> <span class="skolem">cs</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>mk_ml_pat <span class="main">(</span>mk_pat <span class="bound">pat</span><span class="main">)</span><span class="main">,</span> mk_con <span class="main">(</span>frees <span class="bound">pat</span> <span class="main">|∪|</span> all_consts<span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> list.rel_map
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_refl_strong<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> z<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst_thin</span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> pat t
                <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mk_exp_correctness<span class="main">)</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">rhs</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>›</span></span> not_shadows
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def<span class="main">)</span>
                  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="skolem">t</span>"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> prems
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff list_ex_iff<span class="main">)</span>
                <span class="keyword1"><span class="command">next</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">rhs</span>›</span></span> prems <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff Sterm.closed_except_simps<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ballE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pat</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
                  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consts <span class="skolem">t</span> <span class="main">|⊆|</span> all_consts"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹welldefined <span class="skolem">rhs</span>›</span></span> prems <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> welldefined_sabs
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff all_consts_def<span class="main">)</span>
                  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ids <span class="skolem">t</span> <span class="main">|⊆|</span> frees <span class="skolem">pat</span> <span class="main">|∪|</span> all_consts"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> ids_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">rhs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

            <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">rhs</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> swelldefined_rs <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">name</span><span class="main">,</span> <span class="skolem">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">rs</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fresh_fNext all_consts <span class="main">|∉|</span> ids <span class="main">(</span>Sabs <span class="skolem">cs</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fNext_not_member_subset<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> ids_def 1
              <span class="keyword1"><span class="command">using</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_consts_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> consts_sterm.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fresh_fNext all_consts <span class="main">|∉|</span> all_consts"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fNext_not_member<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semantic_correctness'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single sem_env <span class="main">(</span>mk_con all_consts <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fmap_of_list as_vrules <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v</span> <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> semantic_correctness<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env sem_env"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> cupcake_sem_env<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"related_exp <span class="free">t</span> <span class="main">(</span>mk_con all_consts <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mk_exp_correctness<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> ids_def closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>fmdom <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed_venv <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> srules_as_vrules.all_rules
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed_venv <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> srules_as_vrules.all_rules
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> list_all <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> consts <span class="bound">t</span> <span class="main">|⊆|</span> C <span class="main">|∪|</span> fmdom global_css<span class="main">)</span><span class="main">)</span> global_css"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> global_css_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_prod_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems <span class="keyword2"><span class="keyword">for</span></span> pat t
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Sabs <span class="skolem">cs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> clausesE<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> swelldefined_rs prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff fmdom_global_css<span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹welldefined <span class="skolem">t</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> welldefined_sabs
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def list_all_iff fmdom_global_css<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> vwelldefined'<span class="main">)</span> <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> as_vrules_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> imageE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fdisjnt_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> global_css_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x1 x2
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fimage_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def fmdom_global_css<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"not_shadows_vconsts_env <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmpred_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> srules_as_vrules.not_shadows
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt C <span class="main">(</span>fmdom <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> disjnt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fmrel_on_fset <span class="main">(</span>ids <span class="free">t</span><span class="main">)</span> related_v <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">(</span>fmap_of_ns <span class="main">(</span>sem_env.v sem_env<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmrel_on_fset_fmrel_restrict
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmrel_restrict_fset<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sem_env_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> fmdom <span class="main">(</span>fmap_of_list as_vrules<span class="main">)</span> <span class="main">|∪|</span> C"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdom_fmap_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> as_vrules_fst'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">cake_to_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"v <span class="main">⇒</span> value"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cake_to_value</span> <span class="main">(</span>Conv <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="main">=</span> Vconstr <span class="main">(</span>Name <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="free">cake_to_value</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> cakeml' <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cake_to_value_abs_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vno_abs <span class="main">(</span>cake_to_value <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_cupcake_value.elims <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cake_to_value_related<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"related_v <span class="main">(</span>cake_to_value <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">c</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">name</span></span> <span class="skolem"><span class="skolem">tid</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>as_string <span class="skolem">name</span><span class="main">)</span><span class="main">,</span> TypeId <span class="main">(</span>Short <span class="skolem">tid</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> is_cupcake_value.elims<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> name.sel v.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> related_v.conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_refl_strong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Conv<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Conv <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> related_v_abs_free_uniq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">ml_v</span>"</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">ml_v</span>"</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>conv <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">ml_vs</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Vconstr <span class="skolem">name</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 related_v <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ml_vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> related_v.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> name.expand<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all cake_no_abs <span class="skolem">ml_vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(=)</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">_</span>›</span></span>  <span class="quoted"><span class="quoted">‹list_all2 <span class="main">_</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all cake_no_abs <span class="skolem">ml_vs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> related_v_abs_free_cake_to_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"related_v <span class="free">v</span> <span class="free">ml_v</span>"</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">ml_v</span>"</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> cake_to_value <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cake_to_value_related related_v_abs_free_uniq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> srules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cupcake_sem_env_preserve<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single sem_env <span class="main">(</span>mk_con <span class="free">S</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_single_preserve<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_sem_env<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mk_exp_cupcake<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> semantic_correctness''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single sem_env <span class="main">(</span>mk_con all_consts <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmap_of_list as_vrules <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> cake_to_value <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cupcake_sem_env_preserve semantic_correctness' related_v_abs_free_cake_to_value<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition›</span></span>

<span class="keyword1"><span class="command">context</span></span> rules <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">term_to_nterm</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> fresh_frun <span class="main">(</span>Term_to_Nterm.term_to_nterm <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> all_consts"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sterm_to_cake</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sterm_to_cake</span> <span class="main">≡</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.mk_con all_consts"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">term_to_cake</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> sterm_to_cake <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cake_to_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span>convert_term <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> term<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cake_sem_env</span> <span class="main">≡</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.sem_env"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">compiled</span> <span class="main">≡</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.as_vrules"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmdom_compiled<span class="main">:</span> <span class="quoted"><span class="quoted">"fmdom <span class="main">(</span>fmap_of_list compiled<span class="main">)</span> <span class="main">=</span> heads_of <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compiled_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        rules_as_nrules.crules_as_irules'.irules'_as_prules.compile_heads
        Rewriting_Pterm.compile_heads transform_irule_set_iter_heads
        Rewriting_Pterm_Elim.compile_heads
        compile_heads consts_of_heads<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cake_semantic_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single cake_sem_env <span class="main">(</span>sterm_to_cake <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">ml_v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmap_of_list compiled <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">t</span> <span class="main">↓</span> cake_to_value <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compiled_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.semantic_correctness''<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
      rules_as_nrules.crules_as_irules'.irules'_as_prules.compile_heads
      Rewriting_Pterm.compile_heads transform_irule_set_iter_heads
      Rewriting_Pterm_Elim.compile_heads
      compile_heads consts_of_heads all_consts_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lo and behold, this is the final correctness theorem!›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> compiled_correct<span class="main">:</span>
  <span class="comment1">― ‹If CakeML evaluation of a term succeeds ...›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> Evaluate_Single.evaluate cake_sem_env <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="bound">k</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">(</span>term_to_cake <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹... producing a constructor term without closures ...›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cake_no_abs <span class="free">ml_v</span>"</span></span>
  <span class="comment1">― ‹... and some syntactic properties of the involved terms hold ...›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="comment1">― ‹... then this evaluation can be reproduced in the term-rewriting semantics›</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> cake_to_term <span class="free">ml_v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?heads</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">|`|</span> fset_of_list rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.as_vrules"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?heads</span> <span class="main">=</span> heads_of <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fmdom_compiled <span class="keyword1"><span class="command">unfolding</span></span> compiled_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pterm_to_sterm_wellformed<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_all_env cake_sem_env"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.nrules_as_crules.crules_as_irules'.irules'_as_prules.prules_as_srules.cupcake_sem_env<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp <span class="main">(</span>term_to_cake <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.nrules_as_crules.crules_as_irules'.irules'_as_prules.prules_as_srules.srules_as_cake.mk_exp_cupcake<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Evaluate_Single.evaluate cake_sem_env <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="skolem">k</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">(</span>term_to_cake <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Big_Step_Unclocked_Single.evaluate cake_sem_env <span class="main">(</span><span class="free">s</span> <span class="main">⦇</span> clock <span class="main">:=</span> <span class="main">(</span>clock <span class="free">s'</span><span class="main">)</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">(</span>term_to_cake <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unclocked_single_fun_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cupcake_evaluate_single cake_sem_env <span class="main">(</span>sterm_to_cake <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Rval <span class="free">ml_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> cupcake_single_complete<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_cupcake_value <span class="free">ml_v</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.cupcake_sem_env_preserve<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pterm_to_sterm_wellformed<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"vno_abs <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cake_no_abs <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rules_as_nrules.nrules_as_crules.crules_as_irules'.irules'_as_prules.prules_as_srules.srules_as_cake.cake_to_value_abs_free<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vno_abs_value_to_sterm<span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="main">(</span>sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sterm_to_pterm convert_term_no_abs<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> term_to_nterm'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fresh_frun_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pred_stateD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> term_to_nterm_consts<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> surjective_pairing<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"welldefined <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pterm_to_sterm_consts<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> consts_nterm_to_pterm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def shadows_consts_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">using</span></span> term_to_nterm_all_vars<span class="main">[</span><span class="operator">folded</span> wellformed_term_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> fdisjnt_swap sup_idem<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> shadows_consts <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pterm_to_sterm_shadows<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> shadows_nterm_to_pterm<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shadows_consts_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> term_to_nterm_all_vars<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"fempty"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> fdisjnt_swap<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> wellformed_term_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command">using</span></span> term_to_nterm_vars <span class="keyword1"><span class="command">unfolding</span></span> wellformed_term_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_nterm_to_pterm <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pterm_to_sterm_frees<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span>›</span></span> closed_nterm_to_pterm <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmap_of_list compiled <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> cake_to_value <span class="free">ml_v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cake_semantic_correctness<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fmap_of_list rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.as_vrules <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> cake_to_value <span class="free">ml_v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> compiled_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.as_vrules<span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>v</sub></span> pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> cake_to_value <span class="free">ml_v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.veval'_correct''<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.shadows_consts <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> shadows_consts <span class="main">(</span><span class="main">_</span><span class="main">::</span>sterm<span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?heads</span> <span class="main">=</span> heads_of <span class="free">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.all_consts"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹welldefined <span class="main">(</span>pterm_to_sterm <span class="main">_</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?heads</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rewriting_Sterm.compile <span class="main">(</span>Rewriting_Pterm.compile <span class="main">(</span>transform_irule_set_iter <span class="main">(</span>Rewriting_Pterm_Elim.compile <span class="main">(</span>consts_of compile<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> fmempty <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.veval_correct<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rewriting_Sterm.compile <span class="main">(</span>Rewriting_Pterm.compile <span class="main">(</span>transform_irule_set_iter <span class="main">(</span>Rewriting_Pterm_Elim.compile <span class="main">(</span>consts_of compile<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>s</sub></span> pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶*</span> value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.seval_correct<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rewriting_Pterm.compile <span class="main">(</span>transform_irule_set_iter <span class="main">(</span>Rewriting_Pterm_Elim.compile <span class="main">(</span>consts_of compile<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> sterm_to_pterm <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶*</span> sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_prules.compile_correct_rt<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rewriting_Pterm.compile <span class="main">(</span>transform_irule_set_iter <span class="main">(</span>Rewriting_Pterm_Elim.compile <span class="main">(</span>consts_of compile<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>p</sub></span> nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span> <span class="main">⟶*</span> sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> pterm_to_sterm_sterm_to_pterm<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"transform_irule_set_iter <span class="main">(</span>Rewriting_Pterm_Elim.compile <span class="main">(</span>consts_of compile<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span> <span class="main">⟶*</span> sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules'.irules'_as_irules.compile_correct_rt<span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules.transform_finished<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rewriting_Pterm_Elim.compile <span class="main">(</span>consts_of compile<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> nterm_to_pterm <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span> <span class="main">⟶*</span> sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rules_as_nrules.crules_as_irules.transform_correct_rt_n_no_abs<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹transform_irule_set_iter <span class="main">_</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">_</span> <span class="main">⟶*</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> transform_irule_set_iter_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"compile <span class="keyword1">⊢<span class="hidden">⇩</span><sub>n</sub></span> term_to_nterm <span class="free">t</span> <span class="main">⟶*</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rules_as_nrules.compile_correct_rt<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹no_abs <span class="main">(</span>sterm_to_pterm <span class="main">_</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irelated_no_abs<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> nterm_to_term' <span class="main">(</span>term_to_nterm <span class="free">t</span><span class="main">)</span> <span class="main">⟶*</span> nterm_to_term' <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compile_correct_rt<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> nterm_to_term' <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fresh_frun_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> term_to_nterm_nterm_to_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"fempty"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> wellformed_term_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nterm_to_pterm <span class="skolem">t'</span> <span class="main">=</span> sterm_to_pterm <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">_</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>convert_term <span class="skolem">t'</span> <span class="main">::</span> pterm<span class="main">)</span> <span class="main">=</span> convert_term <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nterm_to_pterm<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> sterm_to_pterm<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nterm_to_term' <span class="skolem">t'</span> <span class="main">=</span> convert_term <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nterm_to_term'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹no_abs <span class="skolem">t'</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> convert_term_inj<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> convert_term_no_abs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> convert_term_no_abs<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> convert_term_idem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹no_abs <span class="skolem">t'</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> convert_term_idem<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹no_abs <span class="main">(</span>value_to_sterm <span class="main">(</span>cake_to_value <span class="free">ml_v</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">rs</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">⟶*</span> nterm_to_term' <span class="skolem">t'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Compiler">
<div class="head">
<h1>Theory Compiler</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executable compilation chain›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Compiler
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Composition.html">Composition</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">term_to_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> rule fset <span class="main">⇒</span> term <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_exp</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  cakeml.mk_con <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">(</span>heads_of <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">|∪|</span> constructors.C <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span>
    <span class="main">(</span>pterm_to_sterm <span class="main">(</span>nterm_to_pterm <span class="main">(</span>fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>heads_of <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">|∪|</span> constructors.C <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rules<span class="main">)</span> <span class="quoted"><span class="quoted">"Compiler.term_to_exp <span class="free">C_info</span> <span class="free">rs</span> <span class="main">=</span> term_to_cake"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> term_to_exp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all_consts_def<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">compress_pterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pterm <span class="main">⇒</span> pterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compress_pterm</span> <span class="main">(</span>Pabs <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">=</span> Pabs <span class="main">(</span>fcompress <span class="main">(</span>map_prod id <span class="free">compress_pterm</span> <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">compress_pterm</span> <span class="main">(</span>Pconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Pconst <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">compress_pterm</span> <span class="main">(</span>Pvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Pvar <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">compress_pterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">compress_pterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>p</sub></span> <span class="free">compress_pterm</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compress_pterm_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compress_pterm <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_pabs_id fset_map_snd_id map_prod_def fmember.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compress_crule_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"crule_set <span class="main">⇒</span> crule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compress_crule_set</span> <span class="main">=</span> fcompress <span class="main">∘</span> fimage <span class="main">(</span>map_prod id fcompress<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compress_irule_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> irule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compress_irule_set</span> <span class="main">=</span> fcompress <span class="main">∘</span> fimage <span class="main">(</span>map_prod id <span class="main">(</span>fcompress <span class="main">∘</span> fimage <span class="main">(</span>map_prod id compress_pterm<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compress_prule_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"prule fset <span class="main">⇒</span> prule fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compress_prule_set</span> <span class="main">=</span> fcompress <span class="main">∘</span> fimage <span class="main">(</span>map_prod id compress_pterm<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compress_crule_set_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compress_crule_set <span class="free">rs</span> <span class="main">=</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compress_crule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> compress_irule_set_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compress_irule_set <span class="free">rs</span> <span class="main">=</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compress_irule_set_def map_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> compress_prule_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compress_prule_set <span class="free">rs</span> <span class="main">=</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> compress_prule_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">transform_irule_set_iter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"irule_set <span class="main">⇒</span> irule_set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">transform_irule_set_iter</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>transform_irule_set <span class="main">∘</span> compress_irule_set<span class="main">)</span> <span class="main">^^</span> max_arity <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">as_sem_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> srule list <span class="main">⇒</span> v sem_env <span class="main">⇒</span> v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">as_sem_env</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  <span class="main">⦇</span> sem_env.v <span class="main">=</span>
      build_rec_env <span class="main">(</span>cakeml.mk_letrec_body <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">(</span>fset_of_list <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">|∪|</span> constructors.C <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> nsEmpty<span class="main">,</span>
    sem_env.c <span class="main">=</span>
      nsEmpty <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty_sem_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_sem_env</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">=</span> <span class="main">⦇</span> sem_env.v <span class="main">=</span> nsEmpty<span class="main">,</span> sem_env.c <span class="main">=</span> constructors.as_static_cenv <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sem_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> srule list <span class="main">⇒</span> v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sem_env</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> extend_dec_env <span class="main">(</span>as_sem_env <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">(</span>empty_sem_env <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>empty_sem_env <span class="free"><span class="bound"><span class="entity">C_info</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> rule fset <span class="main">⇒</span> Ast.prog"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">=</span>
  CakeML_Backend.compile' <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">∘</span>
  Rewriting_Sterm.compile <span class="main">∘</span>
  compress_prule_set <span class="main">∘</span>
  Rewriting_Pterm.compile <span class="main">∘</span>
  transform_irule_set_iter <span class="main">∘</span>
  compress_irule_set <span class="main">∘</span>
  Rewriting_Pterm_Elim.compile <span class="main">∘</span>
  compress_crule_set <span class="main">∘</span>
  Rewriting_Nterm.consts_of <span class="main">∘</span>
  fcompress <span class="main">∘</span>
  Rewriting_Nterm.compile' <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">∘</span>
  fcompress"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">compile_to_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"C_info <span class="main">⇒</span> rule fset <span class="main">⇒</span> v sem_env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">compile_to_env</span> <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">=</span>
  sem_env <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">∘</span>
  Rewriting_Sterm.compile <span class="main">∘</span>
  compress_prule_set <span class="main">∘</span>
  Rewriting_Pterm.compile <span class="main">∘</span>
  transform_irule_set_iter <span class="main">∘</span>
  compress_irule_set <span class="main">∘</span>
  Rewriting_Pterm_Elim.compile <span class="main">∘</span>
  compress_crule_set <span class="main">∘</span>
  Rewriting_Nterm.consts_of <span class="main">∘</span>
  fcompress <span class="main">∘</span>
  Rewriting_Nterm.compile' <span class="free"><span class="bound"><span class="entity">C_info</span></span></span> <span class="main">∘</span>
  fcompress"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rules<span class="main">)</span> <span class="quoted"><span class="quoted">"Compiler.compile_to_env <span class="free">C_info</span> <span class="free">rs</span> <span class="main">=</span> rules.cake_sem_env <span class="free">C_info</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Compiler.compile_to_env_def Compiler.sem_env_def Compiler.as_sem_env_def Compiler.empty_sem_env_def
<span class="keyword1"><span class="command">unfolding</span></span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.sem_env_def
<span class="keyword1"><span class="command">unfolding</span></span> rules_as_nrules.crules_as_irules'.irules'_as_prules.prules_as_srules.as_sem_env_def
<span class="keyword1"><span class="command">unfolding</span></span> empty_sem_env_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>
        Compiler.compress_irule_set_eq<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
        Composition.transform_irule_set_iter_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
        Compiler.transform_irule_set_iter_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> comp_def pre_constants.all_consts_def<span class="main">)</span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">term_to_exp</span></span> <span class="quoted"><span class="quoted">compile</span></span> <span class="quoted"><span class="quoted">compile_to_env</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Test_Composition">
<div class="head">
<h1>Theory Test_Composition</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Composition
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Eval_Instances.html">../Preproc/Eval_Instances</a>"</span>
  <span class="quoted">"<a href="Compiler.html">../Compiler/Compiler</a>"</span>
  <span class="quoted">"<a href="Embed.html">../Preproc/Embed</a>"</span>
  <a href="../Lazy_Case/Lazy_Case.html">Lazy_Case.Lazy_Case</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">the_val</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">the_val</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> Rval <span class="free"><span class="bound"><span class="entity">val</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">val</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declassify</span></span> <span class="quoted">List.append</span> <span class="quoted">List.rev</span> <span class="quoted">HOL.Not</span>
<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">)</span> test_code <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">id</span> <span class="quoted">List_append</span> <span class="quoted">List_rev</span> <span class="quoted">HOL_Not</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">thm</span></span> test_code_def

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test_sem_env</span> <span class="main">≡</span> compile_to_env test_code.C_info test_code"</span></span>
<span class="keyword1"><span class="command">declare</span></span> test_code.C_info_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ml_app</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Ast.App Opapp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ml_true</span> <span class="main">=</span> term_to_exp test_code.C_info test_code <span class="main">⟨</span>True<span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ml_false</span> <span class="main">=</span> term_to_exp test_code.C_info test_code <span class="main">⟨</span>False<span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ml_nil</span> <span class="main">=</span> term_to_exp test_code.C_info test_code <span class="main">⟨</span><span class="main">[]</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ml_cons</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> ml_app <span class="main">(</span>ml_app <span class="main">(</span>Var <span class="main">(</span>Short <span class="inner_quoted">''List_List_list_constructor__fun_Cons''</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exp</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exp</span> <span class="main">=</span>
  ml_app <span class="main">(</span>Var <span class="main">(</span>Short <span class="inner_quoted">''Fun_id''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>ml_app <span class="main">(</span>Var <span class="main">(</span>Short <span class="inner_quoted">''Test__Composition_List__rev''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ml_cons ml_true <span class="main">(</span>ml_cons ml_false ml_nil<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exp_expected</span> <span class="main">::</span> <span class="quoted">exp</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">exp_expected</span> <span class="main">=</span> ml_cons ml_false <span class="main">(</span>ml_cons ml_true ml_nil<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_cupcake_exp exp"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="comment1">― ‹could also use <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> prim_sem_state<span class="antiquote">}</span></span> with updated clock›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit SemanticPrimitives.state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">test_state</span> <span class="main">=</span> empty_state <span class="main">⦇</span> clock <span class="main">:=</span> <span class="numeral">100</span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="main">=</span> the_val <span class="main">(</span>Evaluate_Single.evaluate test_sem_env test_state exp<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">value_expected</span> <span class="main">=</span> the_val <span class="main">(</span>Evaluate_Single.evaluate test_sem_env test_state exp_expected<span class="main">)</span>"</span></span>

<span class="comment1">(* takes 15 seconds *)</span>
<span class="keyword1"><span class="command">code_reflect</span></span> Test
  <span class="keyword2"><span class="keyword">functions</span></span> test_sem_env <span class="quoted">"value"</span> value_expected

<span class="keyword1"><span class="command">ML_val</span></span><span class="quoted">‹Test.test_sem_env›</span>
<span class="keyword1"><span class="command">ML_val</span></span><span class="quoted">‹Test.value›</span>
<span class="keyword1"><span class="command">ML_val</span></span><span class="quoted">‹<span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">assert</span><span class="antiquote">}</span></span></span></span> <span class="main">(</span>Test.value <span class="main">=</span> Test.value_expected<span class="main">)</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Test_Print">
<div class="head">
<h1>Theory Test_Print</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Print
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Embed.html">../Preproc/Embed</a>"</span>
  <a href="../Lazy_Case/Lazy_Case.html">Lazy_Case.Lazy_Case</a> <span class="comment1">(* FIXME why is this import necessary *)</span>
  <a href="../CakeML/CakeML_Compiler.html">CakeML.CakeML_Compiler</a>
  <span class="quoted">"<a href="CakeML_Byte.html">../Backend/CakeML_Byte</a>"</span>
  <span class="quoted">"<a href="Compiler.html">../Compiler/Compiler</a>"</span>
  <span class="quoted">"<a href="Eval_Instances.html">../Preproc/Eval_Instances</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">seq</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">seq_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">seq_list</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">seq_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> seq <span class="main">(</span><span class="free">seq_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>char <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> string"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> seq_list <span class="main">(</span>show True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declassify</span></span> valid<span class="main">:</span> <span class="quoted">f</span>
<span class="keyword1"><span class="command">thm</span></span> valid

<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">,</span> skip<span class="main">)</span> f' <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Test__Print_f</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">result</span> <span class="main">::</span> <span class="quoted">prog</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">result</span> <span class="main">=</span> compile f'.C_info f'"</span></span>

<span class="keyword1"><span class="command">declare</span></span> f'.C_info_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">ML</span></span><span class="quoted">‹
  <span class="entity">Code_Evaluation.dynamic_value</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">context</span><span class="antiquote">}</span></span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> result<span class="antiquote">}</span></span>
  |&gt; the
  |&gt; <span class="entity">CakeML_Sexp.print_prog</span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Test_Embed_Data">
<div class="head">
<h1>Theory Test_Embed_Data</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Embed_Data
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Lazy_Case/Lazy_Case.html">Lazy_Case.Lazy_Case</a>
  <span class="quoted">"<a href="Embed.html">../Preproc/Embed</a>"</span>
  <span class="quoted">"<a href="Eval_Instances.html">../Preproc/Eval_Instances</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Leftist_Heap.html">HOL-Data_Structures.Leftist_Heap</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sets are unsupported, so we have to rewrite <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> set<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> List.Ball_set<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> Let_def<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>

<span class="keyword1"><span class="command">declassify</span></span> valid<span class="main">:</span>
  <span class="quoted">Leftist_Heap.ltree</span>
  <span class="quoted">Leftist_Heap.node</span>
  <span class="quoted">Leftist_Heap.merge</span>
  <span class="quoted">Leftist_Heap.insert</span>
  <span class="quoted">Leftist_Heap.del_min</span>

<span class="keyword1"><span class="command">thm</span></span> valid

<span class="keyword1"><span class="command">derive</span></span> evaluate
  <span class="quoted">Tree.tree</span>
  <span class="quoted">Orderings_ord__dict</span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">)</span> test1 <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Leftist__Heap_ltree</span>
  <span class="quoted">Leftist__Heap_node</span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(* skipping proofs for performance *)</span>
<span class="comment1">(* Fails now, probably because of type ('a * 'b) tree
embed (eval, skip) test2 is
  Leftist__Heap_merge
  Leftist__Heap_insert
  Leftist__Heap_del__min
  .
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Test_Embed_Data2">
<div class="head">
<h1>Theory Test_Embed_Data2</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Embed_Data2
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Lazy_Case/Lazy_Case.html">Lazy_Case.Lazy_Case</a>
  <span class="quoted">"<a href="Embed.html">../Preproc/Embed</a>"</span>
  <span class="quoted">"<a href="Eval_Instances.html">../Preproc/Eval_Instances</a>"</span>
  <span class="quoted">"<a href="../Pairing_Heap/Pairing_Heap_Tree.html">Pairing_Heap.Pairing_Heap_Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> List.Ball_set<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_tree <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">P</span> <span class="main">(</span>inorder <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declassify</span></span> valid<span class="main">:</span>
  <span class="quoted">Pairing_Heap_Tree.link</span>
  <span class="quoted">Pairing_Heap_Tree.pass<span class="hidden">⇩</span><sub>1</sub></span>
  <span class="quoted">Pairing_Heap_Tree.pass<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="quoted">Pairing_Heap_Tree.is_root</span>
  <span class="quoted">Pairing_Heap_Tree.pheap</span>

<span class="keyword1"><span class="command">thm</span></span> valid

<span class="keyword1"><span class="command">derive</span></span> evaluate
  <span class="quoted">Tree.tree</span>
  <span class="quoted">Orderings_ord__dict</span>
  <span class="quoted">Orderings_preorder__dict</span>
  <span class="quoted">Orderings_order__dict</span>
  <span class="quoted">Orderings_linorder__dict</span>
  <span class="quoted">HOL_equal__dict</span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">)</span> test1 <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted">Pairing__Heap__Tree_link</span>
  <span class="quoted">Pairing__Heap__Tree_pass<span class="hidden">⇩</span><sub>1</sub></span>
  <span class="quoted">Pairing__Heap__Tree_pass<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="quoted">Pairing__Heap__Tree_pheap</span>
  <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Test_Embed_Tree">
<div class="head">
<h1>Theory Test_Embed_Tree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Embed_Tree
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Lazy_Case/Lazy_Case.html">Lazy_Case.Lazy_Case</a>
  <span class="quoted">"<a href="Embed.html">../Preproc/Embed</a>"</span>
  <span class="quoted">"<a href="Eval_Instances.html">../Preproc/Eval_Instances</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">derive</span></span> evaluate <span class="quoted">tree</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Integers are not supported out of the box, so we have to rewrite some code equations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nat_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nat_diff</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nat_diff_abs_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nat_diff <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> nat <span class="main">(</span>abs <span class="main">(</span>int <span class="free">x</span> <span class="main">-</span> int <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nat_diff_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wbalanced Leaf <span class="main">=</span> True"</span></span>
  <span class="quoted"><span class="quoted">"wbalanced <span class="main">(</span>Node <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nat_diff <span class="main">(</span>size <span class="free">l</span><span class="main">)</span> <span class="main">(</span>size <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> wbalanced <span class="free">l</span> <span class="main">∧</span> wbalanced <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sets are also unsupported, so we have to rewrite <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> set_tree<span class="antiquote"><span class="antiquote">}</span></span></span></span> to use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> inorder<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_tree <span class="free">l</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">P</span> <span class="main">(</span>inorder <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"heap Leaf <span class="main">=</span> True"</span></span>
  <span class="quoted"><span class="quoted">"heap <span class="main">(</span>Node <span class="free">l</span> <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>heap <span class="free">l</span> <span class="main">∧</span> heap <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_tree <span class="free">l</span><span class="main">.</span> <span class="free">m</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_tree <span class="free">r</span><span class="main">.</span> <span class="free">m</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(-)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not pattern compatible›</span></span>

<span class="keyword1"><span class="command">declassify</span></span> valid<span class="main">:</span> <span class="quoted">wbalanced</span> <span class="quoted">ipl</span> <span class="quoted">preorder</span> <span class="quoted">inorder</span> <span class="quoted">postorder</span> <span class="quoted">bst_wrt</span> <span class="quoted">heap</span>
<span class="keyword1"><span class="command">thm</span></span> valid

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">Tree_wbalanced</span></span> <span class="comment1">(* FIXME bogus error message when using the non-dict-eliminated constant *)</span>
<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">)</span> test1 <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Tree_wbalanced</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">Tree_ipl</span></span> <span class="quoted"><span class="quoted">Tree_preorder</span></span> <span class="quoted"><span class="quoted">Tree_inorder</span></span> <span class="quoted"><span class="quoted">Tree_postorder</span></span>
<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">)</span> test2 <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Tree_ipl</span> <span class="quoted">Tree_preorder</span> <span class="quoted">Tree_inorder</span> <span class="quoted">Tree_postorder</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* FIXME auto-derive these things? *)</span>
<span class="keyword1"><span class="command">derive</span></span> evaluate
  <span class="quoted">Orderings_ord__dict</span>
  <span class="quoted">Orderings_preorder__dict</span>
  <span class="quoted">Orderings_order__dict</span>
  <span class="quoted">Orderings_linorder__dict</span>

<span class="keyword1"><span class="command">experiment</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">Tree_bst__wrt</span></span> <span class="quoted"><span class="quoted">Tree_linorder__class_heap</span></span>
<span class="keyword1"><span class="command">embed</span></span> <span class="main">(</span>eval<span class="main">)</span> test3 <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Tree_bst__wrt</span> <span class="quoted">Tree_linorder__class_heap</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Test_Datatypes">
<div class="head">
<h1>Theory Test_Datatypes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Test_Datatypes
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Lazy_Case/Lazy_Case.html">Lazy_Case.Lazy_Case</a>
  <span class="quoted">"<a href="Embed.html">../Preproc/Embed</a>"</span>
  <span class="quoted">"<a href="Eval_Instances.html">../Preproc/Eval_Instances</a>"</span>
  <span class="quoted">"<a href="CakeML_Setup.html">../Backend/CakeML_Setup</a>"</span>
  <span class="quoted">"<a href="Compiler.html">../Compiler/Compiler</a>"</span>
  <a href="../CakeML/CakeML_Compiler.html">CakeML.CakeML_Compiler</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">app</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">app</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">embed</span></span> app' <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">app</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">print_theorems</span></span>

<span class="keyword1"><span class="command">declare</span></span> app'.C_info_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="comment1">(* FIXME code_simp doesn't work for the below cakeml invocation *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"app'.cake_dt_prelude <span class="main">=</span>
   <span class="main">(</span>Dtype <span class="main">(</span>make_locn <span class="main">0</span> <span class="main">0</span> <span class="main">0</span><span class="main">,</span> make_locn <span class="main">0</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">[</span><span class="main">(</span><span class="main">[</span><span class="main">[</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''_''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''0''</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> <span class="inner_quoted">''List_list''</span><span class="main">,</span>
       <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''List_list_Cons''</span><span class="main">,</span> <span class="main">[</span>Tvar <span class="main">[</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''_''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''0''</span><span class="main">]</span><span class="main">,</span> Tapp <span class="main">[</span>Tvar <span class="main">[</span><span class="keyword1">CHR</span> <span class="numeral">0x27</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''a''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''_''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''0''</span><span class="main">]</span><span class="main">]</span> <span class="main">(</span>TC_name <span class="main">(</span>Short <span class="inner_quoted">''List_list''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''List_list_Nil''</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Compiler.compile app'.C_info app' <span class="main">=</span> <span class="main">[</span>Tdec
   <span class="main">(</span>Dletrec <span class="main">(</span>make_locn <span class="main">0</span> <span class="main">0</span> <span class="main">0</span><span class="main">,</span> make_locn <span class="main">0</span> <span class="main">0</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''Test__Datatypes_app''</span><span class="main">,</span> <span class="inner_quoted">''Test__Datatypes_app_''</span><span class="main">,</span>
       Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="inner_quoted">''Test__Datatypes_app_''</span><span class="main">)</span><span class="main">)</span>
        <span class="main">[</span><span class="main">(</span>Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="inner_quoted">''List_list_Nil''</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">,</span> Fun <span class="inner_quoted">''Test__Datatypes_app_''</span> <span class="main">(</span>Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="inner_quoted">''Test__Datatypes_app_''</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span>pat.Pvar <span class="inner_quoted">''xs_0''</span><span class="main">,</span> Var <span class="main">(</span>Short <span class="inner_quoted">''xs_0''</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         <span class="main">(</span>Pcon <span class="main">(</span>Some <span class="main">(</span>Short <span class="inner_quoted">''List_list_Cons''</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>pat.Pvar <span class="inner_quoted">''y_0''</span><span class="main">,</span> pat.Pvar <span class="inner_quoted">''ys_0''</span><span class="main">]</span><span class="main">,</span>
          Fun <span class="inner_quoted">''ys_0_''</span>
           <span class="main">(</span>Mat <span class="main">(</span>Var <span class="main">(</span>Short <span class="inner_quoted">''ys_0_''</span><span class="main">)</span><span class="main">)</span>
             <span class="main">[</span><span class="main">(</span>pat.Pvar <span class="inner_quoted">''xs_0''</span><span class="main">,</span> Con <span class="main">(</span>Some <span class="main">(</span>Short <span class="inner_quoted">''List_list_Cons''</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Var <span class="main">(</span>Short <span class="inner_quoted">''y_0''</span><span class="main">)</span><span class="main">,</span> exp0.App Opapp <span class="main">[</span>exp0.App Opapp <span class="main">[</span>Var <span class="main">(</span>Short <span class="inner_quoted">''Test__Datatypes_app''</span><span class="main">)</span><span class="main">,</span> Var <span class="main">(</span>Short <span class="inner_quoted">''ys_0''</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> Var <span class="main">(</span>Short <span class="inner_quoted">''xs_0''</span><span class="main">)</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">cakeml</span></span> <span class="main">(</span>prog<span class="main">)</span> <span class="quoted"><span class="quoted">‹
  Ast.Tdec app'.cake_dt_prelude <span class="main">#</span> Compiler.compile app'.C_info app'
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>