<div id="Abstract_Completeness">
<div class="head">
<h1>Theory Abstract_Completeness</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="comment1">(* An abstract completeness theorem *)</span>
<span class="keyword1"><span class="command">theory</span></span> Abstract_Completeness
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Collections/Locale_Code.html">Collections.Locale_Code</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Countable_Set.html">HOL-Library.Countable_Set</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Linear_Temporal_Logic_on_Streams.html">HOL-Library.Linear_Temporal_Logic_on_Streams</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹General Tree Concepts›</span></span>

<span class="keyword1"><span class="command">codatatype</span></span> <span class="tfree">'a</span> tree <span class="main">=</span> Node <span class="main">(</span><span class="free"><span class="entity">root</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">cont</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree fset"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">tfinite</span> <span class="keyword2"><span class="keyword">where</span></span>
  tfinite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">tfinite</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">tfinite</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>


<span class="comment1">(*&lt;*)</span><span class="comment1">(* Infinite paths in trees. *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">ipath</span> <span class="keyword2"><span class="keyword">where</span></span>
  ipath<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> shd <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">|∈|</span> cont <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free">ipath</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ipath</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span>"</span></span>

<span class="comment1">(*&lt;*)</span><span class="comment1">(* Finite trees have no infinite paths. *)</span>
<span class="keyword1" id="Abstract_Completeness-ftree_no_ipath"><span class="command">lemma</span></span> ftree_no_ipath<span class="main">:</span> <span class="quoted"><span class="quoted">"tfinite <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> ipath <span class="free">t</span> <span class="free">steps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">steps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tfinite.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ipath.cases<span class="main">)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">konig</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"shd <span class="main">(</span><span class="free">konig</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> root <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"stl <span class="main">(</span><span class="free">konig</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">konig</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">¬</span> tfinite <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-Konig"><span class="command">lemma</span></span> Konig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tfinite <span class="free">t</span> <span class="main">⟹</span> ipath <span class="free">t</span> <span class="main">(</span>konig <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> tfinite.simps konig.simps someI_ex<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Rule Systems›</span></span>

<span class="comment1">(*&lt;*)</span><span class="comment1">(* A step consists of a pair (s,r) such that the rule r is taken in state s. *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> step <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'rule</span>"</span></span>
<span class="comment1">(*&lt;*)</span><span class="comment1">(* A derivation tree is a tree of steps: *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> dtree <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> step tree"</span></span>

<span class="keyword1"><span class="command">locale</span></span> RuleSystem_Defs <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> fset <span class="main">⇒</span> bool"</span></span>
<span class="comment1">(* The countable set of rules is initially provided as a stream: *)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> sset <span class="free">rules</span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-countable_R"><span class="command">lemma</span></span> countable_R<span class="main">:</span> <span class="quoted"><span class="quoted">"countable R"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> countableI_type countable_image sset_range<span class="main">)</span>
<span class="keyword1" id="Abstract_Completeness-NE_R"><span class="command">lemma</span></span> NE_R<span class="main">:</span> <span class="quoted"><span class="quoted">"R <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_witness all_not_in_conv empty_is_image sset_range<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">sl</span><span class="main">.</span> <span class="free">eff</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">sl</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pickEff</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> enabled <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">sl</span><span class="main">.</span> <span class="free">eff</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">sl</span><span class="main">)</span> <span class="keyword1">else</span> the None"</span></span>

<span class="keyword1" id="Abstract_Completeness-pickEff"><span class="command">lemma</span></span> pickEff<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">eff</span> <span class="free">r</span> <span class="free">s</span> <span class="main">(</span>pickEff <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> enabled_def pickEff_def tfl_some<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">effStep</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="main">≡</span> <span class="free">eff</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">step</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">step</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabledAtStep</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="main">≡</span> enabled <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">step</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">takenAtStep</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="main">≡</span> snd <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Saturation is a very strong notion of fairness:
  If a rule is enabled at some point, it will eventually be taken.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">saturated</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> alw <span class="main">(</span>holds <span class="main">(</span>enabledAtStep <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">impl</span> ev <span class="main">(</span>holds <span class="main">(</span>takenAtStep <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Saturated</span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> R<span class="main">.</span> saturated <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span>"</span></span>

<span class="comment1">(*&lt;*)</span><span class="comment1">(* Well-formed derivation trees *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">wf</span> <span class="keyword2"><span class="keyword">where</span></span>
  wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>snd <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∈</span> R<span class="main">;</span> effStep <span class="main">(</span>root <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>fimage <span class="main">(</span>fst <span class="keyword1">o</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">|∈|</span> cont <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">wf</span> <span class="bound">t'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>


<span class="comment1">(*&lt;*)</span><span class="comment1">(* Escape paths *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">epath</span> <span class="keyword2"><span class="keyword">where</span></span>
  epath<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>snd <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span> <span class="main">∈</span> R<span class="main">;</span> fst <span class="main">(</span>shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">;</span> effStep <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span><span class="main">;</span>
    <span class="free">epath</span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">steps</span></span></span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">epath</span> <span class="free"><span class="bound"><span class="entity">steps</span></span></span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-wf_ipath_epath"><span class="command">lemma</span></span> wf_ipath_epath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"ipath <span class="free">t</span> <span class="free">steps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"epath <span class="free">steps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">st</span><span class="main">.</span> ipath <span class="bound">t</span> <span class="bound">st</span> <span class="main">⟹</span> root <span class="bound">t</span> <span class="main">=</span> shd <span class="bound">st</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ipath.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">steps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> epath
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf.cases<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> ipath.cases<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> * o_apply fimageI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fair</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> sset <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">⊆</span> R <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">r</span> <span class="main">∈</span> R<span class="main">.</span> alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="main">(</span><span class="main">(=)</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-fair_stl"><span class="command">lemma</span></span> fair_stl<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span> <span class="main">⟹</span> fair <span class="main">(</span>stl <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fair_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw.simps subsetD stl_sset subsetI<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-sdrop_fair"><span class="command">lemma</span></span> sdrop_fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span> <span class="main">⟹</span> fair <span class="main">(</span>sdrop <span class="free">m</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alw_sdrop <span class="keyword1"><span class="command">unfolding</span></span> fair_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw.coinduct alw_nxt fair_def fair_stl<span class="main">)</span>


<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹A Fair Enumeration of the Rules›</span></span>

<span class="comment1">(*&lt;*)</span><span class="comment1">(* The fair enumeration of rules *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fenum</span> <span class="main">≡</span> flat <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> stake <span class="bound">n</span> <span class="free">rules</span><span class="main">)</span> <span class="main">(</span>fromN <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-sset_fenum"><span class="command">lemma</span></span> sset_fenum<span class="main">:</span> <span class="quoted"><span class="quoted">"sset fenum <span class="main">=</span> R"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fenum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sset_flat<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.set_map in_set_conv_nth sset_range<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">rules</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">metis</span> atLeast_Suc_greaterThan greaterThan_0 lessI range_eqI stake_nth<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-fair_fenum"><span class="command">lemma</span></span> fair_fenum<span class="main">:</span> <span class="quoted"><span class="quoted">"fair fenum"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> R"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">rules</span> <span class="main">!!</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sset_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">rs</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fenum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> flat <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> stake <span class="bound">n</span> <span class="free">rules</span><span class="main">)</span> <span class="main">(</span>fromN <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="main">(</span><span class="main">(=)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">@-</span> <span class="var">?fenum</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> alw
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">rs</span></span> <span class="main"><span class="main">@-</span></span> <span class="var"><span class="var">?fenum</span></span> <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n'</span> <span class="bound">rs'</span><span class="main">.</span> stl <span class="main">(</span><span class="skolem">rs</span> <span class="main">@-</span> <span class="var">?fenum</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="bound">rs'</span> <span class="main">@-</span> <span class="var">?fenum</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="bound">n'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> alw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="main">(</span><span class="main">(=)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">@-</span> flat <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> stake <span class="bound">n</span> <span class="free">rules</span><span class="main">)</span> <span class="main">(</span>fromN <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> alw r <span class="keyword1"><span class="command">unfolding</span></span> ev_holds_sset
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.set_map in_set_conv_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
     <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fair fenum"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fair_def sset_fenum
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fenum_def alw_shift le_less zero_less_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">trim</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> sdrop_while <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> Not <span class="main">(</span>enabled <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span>"</span></span>


<span class="comment1">(*&lt;*)</span><span class="comment1">(* The fair tree associated to a stream of rules and a state *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">mkTree</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"root <span class="main">(</span><span class="free">mkTree</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="main">(</span>shd <span class="main">(</span>trim <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"cont <span class="main">(</span><span class="free">mkTree</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> fimage <span class="main">(</span><span class="free">mkTree</span> <span class="main">(</span>stl <span class="main">(</span>trim <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pickEff <span class="main">(</span>shd <span class="main">(</span>trim <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*&lt;*)</span><span class="comment1">(* More efficient code equation for mkTree *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1" id="Abstract_Completeness-mkTree_unfold"><span class="command">lemma</span></span> mkTree_unfold<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mkTree <span class="free">rs</span> <span class="free">s</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> trim <span class="free">rs</span> <span class="free">s</span> <span class="keyword1">of</span> SCons <span class="bound">r</span> <span class="bound">s'</span> <span class="main">⇒</span> Node <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>fimage <span class="main">(</span>mkTree <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>pickEff <span class="bound">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mkTree.ctr<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> stream.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> RuleSystem <span class="main">=</span> RuleSystem_Defs <span class="quoted"><span class="free">eff</span></span> <span class="quoted"><span class="free">rules</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="free">eff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> eff_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span> <span class="bound">r</span> <span class="bound">sl</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="bound">r</span> <span class="main">∈</span> R<span class="main">;</span> <span class="free">eff</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span><span class="main">;</span> <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> enabled_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">r</span> <span class="main">∈</span> R<span class="main">.</span> <span class="main">∃</span> <span class="bound">sl</span><span class="main">.</span> <span class="free">eff</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">sl</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&lt;*)</span><span class="comment1">(* The minimum waiting time in a stream for the enabled rules in a given state: *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">minWait</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> enabled <span class="main">(</span>shd <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-trim_alt"><span class="command">lemma</span></span> trim_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trim <span class="free">rs</span> <span class="free">s</span> <span class="main">=</span> sdrop <span class="main">(</span>minWait <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> trim_def minWait_def sdrop_simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sdrop_while_sdrop_LEAST<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> enabled_R<span class="main">[</span><span class="operator">OF</span> s<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">sl</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> R"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eff</span> <span class="skolem">r</span> <span class="free">s</span> <span class="skolem">sl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> bspec<span class="main">[</span><span class="operator">OF</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rs<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fair_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> r<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">rs</span> <span class="main">!!</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">erule</span> alw.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ev_holds_sset sset_range<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> r sl <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> enabled <span class="main">(</span><span class="free">rs</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> enabled_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Completeness-minWait_ex"><span class="command">lemma</span></span> minWait_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> enabled <span class="main">(</span>shd <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> R"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="skolem">r</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enabled_R s <span class="keyword1"><span class="command">unfolding</span></span> enabled_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdrop_fair<span class="main">[</span><span class="operator">OF</span> rs<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> alw_nxt holds.simps sdrop.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fair_def sdrop_wait<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r e <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> trim_in_R<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> trim_enabled<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="main">(</span>shd <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> trim_fair<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trim_alt<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> minWait_def
  <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> minWait_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> sdrop_fair<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    conjunct1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fair_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span> <span class="main">(</span><span class="operator">metis</span> subsetD snth_sset<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-minWait_least"><span class="command">lemma</span></span> minWait_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>enabled <span class="main">(</span>shd <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> minWait <span class="free">rs</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minWait_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Least_le conjI<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-in_cont_mkTree"><span class="command">lemma</span></span> in_cont_mkTree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">|∈|</span> cont <span class="main">(</span>mkTree <span class="free">rs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sl'</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">eff</span> <span class="main">(</span>shd <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="bound">sl'</span> <span class="main">∧</span>
                 <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl'</span> <span class="main">∧</span> <span class="free">t'</span> <span class="main">=</span> mkTree <span class="main">(</span>stl <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sl'</span> <span class="main">=</span> pickEff <span class="main">(</span>shd <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">|∈|</span> <span class="skolem">sl'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> mkTree <span class="main">(</span>stl <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">unfolding</span></span> sl'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="main">(</span>shd <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trim_enabled<span class="main">[</span><span class="operator">OF</span> s rs<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> trim_in_R pickEff eff_S s rs s'<span class="main">[</span><span class="operator">unfolded</span> sl'_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sl'_def <span class="keyword1"><span class="command">using</span></span> pickEff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Completeness-ipath_mkTree_sdrop"><span class="command">lemma</span></span> ipath_mkTree_sdrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="free">steps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> ipath <span class="main">(</span>mkTree <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free">rs</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">m</span> <span class="free">steps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> s rs i <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">steps</span></span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="skolem">m</span> <span class="skolem">steps</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ipath <span class="var">?t</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ip <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="var">?t</span> <span class="main">=</span> shd <span class="main">(</span>sdrop <span class="skolem">m</span> <span class="skolem">steps</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">|∈|</span> cont <span class="var">?t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="skolem">t'</span> <span class="main">(</span>sdrop <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">steps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> in_cont_mkTree<span class="main">[</span><span class="operator">OF</span> s' sdrop_fair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> t'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl''</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eff</span> <span class="main">(</span>shd <span class="main">(</span>trim <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span> <span class="skolem">sl''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">|∈|</span> <span class="skolem">sl''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> mkTree <span class="main">(</span>stl <span class="main">(</span>trim <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>trim <span class="main">(</span>sdrop <span class="skolem">n</span> <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> R"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop_fair Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> trim_in_R s'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> i s'' e s' <span class="keyword1"><span class="command">unfolding</span></span> sdrop_stl t'_def sdrop_add add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    trim_alt<span class="main">[</span><span class="operator">OF</span> s' sdrop_fair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"minWait <span class="main"><span class="main"><span class="main">(</span></span></span>sdrop <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">rs</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">s'</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s''</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eff_S<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-wf_mkTree"><span class="command">lemma</span></span> wf_mkTree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>mkTree <span class="free">rs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mkTree <span class="skolem">rs</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>root <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> R"</span></span> <span class="keyword1"><span class="command">using</span></span> trim_in_R<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">∘</span> root <span class="main">∘</span> mkTree <span class="main">(</span>stl <span class="main">(</span>trim <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"effStep <span class="main">(</span>root <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>fimage <span class="main">(</span>fst <span class="main">∘</span> root<span class="main">)</span> <span class="main">(</span>cont <span class="var">?t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trim_enabled<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pickEff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fair_stl<span class="main">[</span><span class="operator">OF</span> trim_fair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">]</span> in_cont_mkTree<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"stl <span class="main">(</span>trim <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(*&lt;*)</span><span class="comment1">(* The position of a rule in a rule stream *)</span><span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> shd <span class="main">(</span>sdrop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-pos"><span class="command">lemma</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>fair <span class="free">rs</span><span class="main">;</span> <span class="free">r</span> <span class="main">∈</span> R<span class="main">⟧</span> <span class="main">⟹</span> shd <span class="main">(</span>sdrop <span class="main">(</span>pos <span class="free">rs</span> <span class="free">r</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pos_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI_ex<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> alw.cases fair_def holds.simps sdrop_wait<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-pos_least"><span class="command">lemma</span></span> pos_least<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="main">⟹</span> pos <span class="free">rs</span> <span class="free">r</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pos_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Least_le<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-minWait_le_pos"><span class="command">lemma</span></span> minWait_le_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>fair <span class="free">rs</span><span class="main">;</span> <span class="free">r</span> <span class="main">∈</span> R<span class="main">;</span> enabled <span class="free">r</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> minWait <span class="free">rs</span> <span class="free">s</span> <span class="main">≤</span> pos <span class="free">rs</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> minWait_least <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pos<span class="main">)</span>

<span class="keyword1" id="Abstract_Completeness-stake_pos_minWait"><span class="command">lemma</span></span> stake_pos_minWait<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"minWait <span class="free">rs</span> <span class="free">s</span> <span class="main">&lt;</span> pos <span class="free">rs</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> R"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pos <span class="main">(</span>stl <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> pos <span class="free">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">(</span>minWait <span class="free">rs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pos <span class="free">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">(</span>minWait <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span> minWait <span class="free">rs</span> <span class="free">s</span> <span class="main">=</span> pos <span class="free">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"shd <span class="main">(</span>stl <span class="main">(</span>sdrop <span class="main">(</span>pos <span class="free">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> shd <span class="main">(</span>sdrop <span class="main">(</span>pos <span class="free">rs</span> <span class="free">r</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_pred gr_implies_not0 m neq0_conv sdrop.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sdrop_stl<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pos <span class="main">(</span>stl <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">≤</span> pos <span class="free">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">(</span>minWait <span class="free">rs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos<span class="main">[</span><span class="operator">OF</span> rs r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add.commute trim_alt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s rs<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pos_least<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pos <span class="free">rs</span> <span class="free">r</span> <span class="main">≤</span> pos <span class="main">(</span>stl <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">+</span> Suc <span class="main">(</span>minWait <span class="free">rs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos<span class="main">[</span><span class="operator">OF</span> sdrop_fair<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fair_stl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rs<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> r<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"minWait <span class="free">rs</span> <span class="free">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trim_alt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s rs<span class="main"><span class="main">]</span></span> add.commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pos_least<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pos <span class="free">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">(</span>minWait <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> pos <span class="main">(</span>stl <span class="main">(</span>trim <span class="free">rs</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Abstract_Completeness-ipath_mkTree_ev"><span class="command">lemma</span></span> ipath_mkTree_ev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="free">steps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> alw<span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span>enabledAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">steps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="main">(</span>takenAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">steps</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> s rs i alw <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"pos <span class="free">rs</span> <span class="free">r</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">steps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">rs</span> <span class="skolem">s</span> <span class="skolem">steps</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> s <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> trim_def' <span class="main">=</span> trim_alt<span class="main">[</span><span class="operator">OF</span> s <span class="quoted"><span class="quoted">‹fair <span class="skolem">rs</span>›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mkTree <span class="skolem">rs</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>4<span class="main">,</span>3<span class="main">)</span> s in_cont_mkTree <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'rule</span><span class="main">)</span> step tree"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    rt<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="var">?t</span> <span class="main">=</span> shd <span class="skolem">steps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree <span class="main">(</span>stl <span class="main">(</span>trim <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">steps</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pos <span class="skolem">rs</span> <span class="free">r</span> <span class="main">=</span> minWait <span class="skolem">rs</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> pos<span class="main">[</span><span class="operator">OF</span> less.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> r<span class="main">]</span> rt<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trim_def' ev.base<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="free">r</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less.prems<span class="main">(</span>4<span class="main">)</span> rt  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> alw_nxt<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">steps</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False r less.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"minWait <span class="skolem">rs</span> <span class="skolem">s</span> <span class="main">&lt;</span> pos <span class="skolem">rs</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> minWait_le_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pos <span class="skolem">rs</span> <span class="free">r</span> <span class="main">-</span> Suc <span class="main">(</span>minWait <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?m1</span> <span class="main">≤</span> pos <span class="skolem">rs</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m1</span> <span class="main">=</span> pos <span class="main">(</span>stl <span class="main">(</span>trim <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e <span class="quoted"><span class="quoted">‹fair <span class="skolem">rs</span>›</span></span> 2 r s
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stake_pos_minWait<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fair <span class="main">(</span>stl <span class="main">(</span>trim <span class="skolem">rs</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span>enabledAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">steps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fair_stl trim_fair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> alw.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ev.step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less.hyps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ s' _ i<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Persistent rules›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">per</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span>
    <span class="main">∀</span><span class="bound">s</span> <span class="bound">r1</span> <span class="bound">sl'</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> enabled <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">r1</span> <span class="main">∈</span> R <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span> <span class="main">∧</span> <span class="free">eff</span> <span class="bound">r1</span> <span class="bound">s</span> <span class="bound">sl'</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">|∈|</span> <span class="bound">sl'</span> <span class="main">⟶</span> enabled <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">s'</span>"</span></span>

<span class="keyword1" id="Abstract_Completeness-per_alw"><span class="command">lemma</span></span> per_alw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"per <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"epath <span class="free">steps</span> <span class="main">∧</span> fst <span class="main">(</span>shd <span class="free">steps</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span>enabledAtStep <span class="free">r</span><span class="main">)</span> <span class="keyword1">impl</span>
    <span class="main">(</span>holds <span class="main">(</span>takenAtStep <span class="free">r</span><span class="main">)</span> <span class="keyword1">or</span> nxt <span class="main">(</span>holds <span class="main">(</span>enabledAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">steps</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> e <span class="keyword1"><span class="command">proof</span></span> <span class="operator">coinduct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alw <span class="skolem">steps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="skolem">steps</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>shd <span class="skolem">steps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="main">(</span>stl <span class="skolem">steps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"enabled <span class="free">r</span> <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">≠</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">∈</span> R"</span></span> <span class="keyword1"><span class="command">using</span></span> alw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> epath.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eff</span> <span class="var">?r1</span> <span class="var">?s</span> <span class="skolem">sl'</span> <span class="main">∧</span> <span class="var">?s'</span> <span class="main">|∈|</span> <span class="skolem">sl'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alw <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> epath.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enabled <span class="free">r</span> <span class="var">?s'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> per_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eff_S <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> epath.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹context RuleSystem›</span>


<span class="comment1">(*&lt;*)</span> <span class="comment1">(* Rule-persistent rule system *)</span> <span class="comment1">(*&gt;*)</span>
<span class="keyword1"><span class="command">locale</span></span> PersistentRuleSystem <span class="main">=</span> RuleSystem <span class="quoted"><span class="free">eff</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="quoted"><span class="free">S</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="free">eff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> per<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> R <span class="main">⟹</span> per <span class="bound">r</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Completeness-ipath_mkTree_saturated"><span class="command">lemma</span></span> ipath_mkTree_saturated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="free">steps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> R"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"saturated <span class="free">r</span> <span class="free">steps</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> saturated_def <span class="keyword1"><span class="command">using</span></span> s rs i <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">steps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>alw <span class="skolem">rs</span> <span class="skolem">s</span> <span class="skolem">steps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">steps</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"holds <span class="main">(</span>enabledAtStep <span class="free">r</span><span class="main">)</span> <span class="skolem">steps</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>holds <span class="main">(</span>enabledAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">steps</span> <span class="main">∨</span> ev <span class="main">(</span>holds <span class="main">(</span>takenAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">steps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> variance<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ per_alw<span class="main"><span class="main">[</span></span><span class="operator">OF</span> per<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> wf_ipath_epath wf_mkTree alw mkTree.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ipath.simps fst_conv<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>holds <span class="main">(</span>takenAtStep <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">steps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipath_mkTree_ev<span class="main"><span class="main">[</span></span><span class="operator">OF</span> alw r<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> alw <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rs'</span> <span class="bound">s'</span> <span class="bound">steps'</span><span class="main">.</span>
      stl <span class="skolem">steps</span> <span class="main">=</span> <span class="bound">steps'</span> <span class="main">∧</span> <span class="bound">s'</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> fair <span class="bound">rs'</span> <span class="main">∧</span> ipath <span class="main">(</span>mkTree <span class="bound">rs'</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">steps'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ipath_mkTree_sdrop<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> trim_in_R sdrop_fair <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ipath_mkTree_Saturated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fair <span class="free">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree <span class="free">rs</span> <span class="free">s</span><span class="main">)</span> <span class="free">steps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Saturated <span class="free">steps</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Saturated_def <span class="keyword1"><span class="command">using</span></span> ipath_mkTree_saturated<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> epath_completeness_Saturated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>root <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> wf <span class="bound">t</span> <span class="main">∧</span> tfinite <span class="bound">t</span><span class="main">)</span> <span class="main">∨</span>
   <span class="main">(</span><span class="main">∃</span> <span class="bound">steps</span><span class="main">.</span> fst <span class="main">(</span>shd <span class="bound">steps</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> epath <span class="bound">steps</span> <span class="main">∧</span> Saturated <span class="bound">steps</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∨</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> tfinite <span class="main">(</span>mkTree fenum <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_mkTree fair_fenum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">steps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>mkTree fenum <span class="free">s</span><span class="main">)</span> <span class="skolem">steps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Konig <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>shd <span class="skolem">steps</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> epath <span class="skolem">steps</span> <span class="main">∧</span> Saturated <span class="skolem">steps</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_ipath_epath ipath.simps ipath_mkTree_Saturated
        wf_mkTree fair_fenum mkTree.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">― ‹context PersistentRuleSystem›</span>



<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Code generation›</span></span>

<span class="comment1">(* Here we assume a deterministic effect eff': *)</span>

<span class="keyword1"><span class="command">locale</span></span> RuleSystem_Code <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">eff'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> fset option"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'rule</span> stream"</span></span> <span class="comment1">― ‹countably many rules›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eff</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="main">≡</span> <span class="free">eff'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">sl</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context RuleSystem_Code *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">effG</span> <span class="free"><span class="bound"><span class="entity">eff'</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span> <span class="main">≡</span> RuleSystem_Code.eff <span class="free"><span class="bound"><span class="entity">eff'</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">sl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> RuleSystem_Code <span class="main">&lt;</span> RuleSystem_Defs
  <span class="keyword2"><span class="keyword">where</span></span> eff <span class="main">=</span> <span class="quoted"><span class="quoted">"effG <span class="free">eff'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rules <span class="main">=</span> <span class="quoted"><span class="free">rules</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">context</span></span> RuleSystem_Code
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Completeness-enabled_eff'"><span class="command">lemma</span></span> enabled_eff'<span class="main">:</span> <span class="quoted"><span class="quoted">"enabled <span class="free">r</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">eff'</span> <span class="free">r</span> <span class="free">s</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> enabled_def effG_def eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Abstract_Completeness-pickEff_the"><span class="command">lemma</span></span> pickEff_the<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pickEff <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> the <span class="main">(</span><span class="free">eff'</span> <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pickEff_def enabled_def effG_def eff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span> trim_def enabled_eff' pickEff_the

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context RuleSystem_Code *)</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Locale_Code.open_block</span>
<span class="keyword1"><span class="command">interpretation</span></span> i<span class="main">:</span> RuleSystem_Code <span class="quoted"><span class="free">eff'</span></span> <span class="quoted"><span class="free">rules</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">eff'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rules</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">lc_delete</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"RuleSystem_Defs.mkTree <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>effG <span class="var"><span class="var"><span class="var"><span class="var">?eff'</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span>"</span></span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">lc_delete</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">RuleSystem_Defs.trim</span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">lc_delete</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">RuleSystem_Defs.enabled</span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">lc_delete</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">RuleSystem_Defs.pickEff</span></span></span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">lc_add</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"RuleSystem_Defs.mkTree <span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>effG <span class="var"><span class="var"><span class="var"><span class="var">?eff'</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span>"</span></span></span></span></span> i.mkTree_unfold<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">setup</span></span> <span class="entity">Locale_Code.close_block</span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">the</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"fromJust"</span>
<span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted">Option.is_none</span> <span class="main">⇀</span> <span class="main">(</span>Haskell<span class="main">)</span> <span class="quoted">"isNothing"</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">mkTree_effG_uu</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="keyword2"><span class="keyword">module_name</span></span> Tree <span class="comment1">(*file "."*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Propositional_Logic">
<div class="head">
<h1>Theory Propositional_Logic</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Propositional_Logic
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abstract_Completeness.html">Abstract_Completeness</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Toy instantiation: Propositional Logic›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> fmla <span class="main">=</span> Atom <span class="quoted">nat</span> <span class="main">|</span> Neg <span class="quoted">fmla</span> <span class="main">|</span> Conj <span class="quoted">fmla</span> <span class="quoted">fmla</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">max_depth</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_depth</span> <span class="main">(</span>Atom <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_depth</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">max_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_depth</span> <span class="main">(</span>Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>max <span class="main">(</span><span class="free">max_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">max_depth</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propositional_Logic-max_depth_0"><span class="command">lemma</span></span> max_depth_0<span class="main">:</span> <span class="quoted"><span class="quoted">"max_depth <span class="free">φ</span> <span class="main">=</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Atom <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Propositional_Logic-max_depth_Suc"><span class="command">lemma</span></span> max_depth_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"max_depth <span class="free">φ</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> max_depth <span class="bound">ψ</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">ψ1</span> <span class="bound">ψ2</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Conj <span class="bound">ψ1</span> <span class="bound">ψ2</span> <span class="main">∧</span> max <span class="main">(</span>max_depth <span class="bound">ψ1</span><span class="main">)</span> <span class="main">(</span>max_depth <span class="bound">ψ2</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">atoms</span> <span class="main">≡</span> smap Atom nats"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">depth1</span> <span class="main">≡</span>
  sinterleave <span class="main">(</span>smap Neg atoms<span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span>case_prod Conj<span class="main">)</span> <span class="main">(</span>sproduct atoms atoms<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sinterleaves</span> <span class="main">≡</span> fold sinterleave"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">extendLevel</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">extendLevel</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">belowN</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Next</span> <span class="main">=</span> sinterleaves
    <span class="main">(</span>map <span class="main">(</span>smap <span class="main">(</span>case_prod Conj<span class="main">)</span><span class="main">)</span> <span class="main">[</span>sproduct <span class="free"><span class="bound"><span class="entity">belowN</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> sproduct <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">belowN</span></span></span><span class="main">,</span> sproduct <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>smap Neg <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>
  <span class="keyword1">in</span> <span class="main">(</span>sinterleave <span class="free"><span class="bound"><span class="entity">belowN</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">,</span> <span class="bound">Next</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propositional_Logic-extendLevel_step"><span class="command">lemma</span></span> extendLevel_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sset <span class="free">belowN</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">;</span>
    sset <span class="free">N</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span><span class="main">;</span> <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="free">belowN</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">belowNext</span> <span class="bound">Next</span><span class="main">.</span> extendLevel <span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="bound">belowNext</span><span class="main">,</span> <span class="bound">Next</span><span class="main">)</span> <span class="main">∧</span>
     sset <span class="bound">belowNext</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> Suc <span class="free">n</span><span class="main">}</span> <span class="main">∧</span> sset <span class="bound">Next</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> Suc <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sset_sinterleave sset_sproduct stream.set_map
    image_iff max_depth_Suc<span class="main">)</span>

<span class="keyword1" id="Propositional_Logic-sset_atoms"><span class="command">lemma</span></span> sset_atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"sset atoms <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.set_map max_depth_0<span class="main">)</span>

<span class="keyword1" id="Propositional_Logic-sset_depth1"><span class="command">lemma</span></span> sset_depth1<span class="main">:</span> <span class="quoted"><span class="quoted">"sset depth1 <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sset_sinterleave sset_sproduct stream.set_map
    max_depth_Suc max_depth_0 max_def image_iff<span class="main">)</span>

<span class="keyword1" id="Propositional_Logic-extendLevel_Nsteps"><span class="command">lemma</span></span> extendLevel_Nsteps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sset <span class="free">belowN</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">;</span> sset <span class="free">N</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">belowNext</span> <span class="bound">Next</span><span class="main">.</span> <span class="main">(</span>extendLevel <span class="main">^^</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">belowN</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">belowNext</span><span class="main">,</span> <span class="bound">Next</span><span class="main">)</span> <span class="main">∧</span>
     sset <span class="bound">belowNext</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">}</span> <span class="main">∧</span> sset <span class="bound">Next</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">belowN</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">belowNext</span></span> <span class="skolem"><span class="skolem">Next</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>extendLevel <span class="main">^^</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span><span class="skolem">belowN</span><span class="main">,</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">belowNext</span><span class="main">,</span> <span class="skolem">Next</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sset <span class="skolem">belowNext</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"sset <span class="skolem">Next</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> funpow.simps o_apply add_Suc_right
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> extendLevel_step<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">belowNext</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Next</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> extendLevel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">belowNext</span> <span class="bound">Next</span><span class="main">.</span> <span class="main">(</span>extendLevel <span class="main">^^</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>atoms<span class="main">,</span> depth1<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">belowNext</span><span class="main">,</span> <span class="bound">Next</span><span class="main">)</span> <span class="main">∧</span>
     sset <span class="bound">belowNext</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="free">m</span><span class="main">}</span> <span class="main">∧</span> sset <span class="bound">Next</span> <span class="main">=</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> max_depth <span class="bound">φ</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> extendLevel_Nsteps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sset_atoms sset_depth1<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fmlas</span> <span class="main">=</span> sinterleave atoms <span class="main">(</span>smerge <span class="main">(</span>smap snd <span class="main">(</span>siterate extendLevel <span class="main">(</span>atoms<span class="main">,</span> depth1<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Propositional_Logic-fmlas_UNIV"><span class="command">lemma</span></span> fmlas_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"sset fmlas <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">::</span> fmla set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI UNIV_I<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> sset fmlas"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"max_depth <span class="skolem">φ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fmlas_def sset_sinterleave stream.set_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> UnI1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_depth_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> extendLevel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmlas_def sset_smerge sset_siterate sset_sinterleave stream.set_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> UnI2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">datatype</span></span> rule <span class="main">=</span> Idle <span class="main">|</span> Ax <span class="quoted">nat</span> <span class="main">|</span> NegL <span class="quoted">fmla</span> <span class="main">|</span> NegR <span class="quoted">fmla</span> <span class="main">|</span> ConjL <span class="quoted">fmla</span> <span class="quoted">fmla</span> <span class="main">|</span> ConjR <span class="quoted">fmla</span> <span class="quoted">fmla</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mkRules</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> smap <span class="free"><span class="bound"><span class="entity">f</span></span></span> fmlas"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mkRulePairs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> smap <span class="main">(</span>case_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>sproduct fmlas fmlas<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rules</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rules</span> <span class="main">=</span> Idle <span class="main">##</span> 
     sinterleaves <span class="main">[</span>mkRules NegL<span class="main">,</span> mkRules NegR<span class="main">,</span> mkRulePairs ConjL<span class="main">,</span> mkRulePairs ConjR<span class="main">]</span>
     <span class="main">(</span>smap Ax nats<span class="main">)</span>"</span></span>

<span class="keyword1" id="Propositional_Logic-rules_UNIV"><span class="command">lemma</span></span> rules_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"sset rules <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">::</span> rule set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rules_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sset_sinterleave sset_sproduct stream.set_map
    fmlas_UNIV image_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> rule.exhaust<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"fmla fset <span class="main">*</span> fmla fset"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eff'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rule <span class="main">⇒</span> state <span class="main">⇒</span> state fset option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eff'</span> Idle <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">{|</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span><span class="main">|}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eff'</span> <span class="main">(</span>Ax <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> Atom <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">∧</span> Atom <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1">then</span> Some <span class="main">{||}</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eff'</span> <span class="main">(</span>NegL <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">then</span> Some <span class="main">{|</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">|-|</span> <span class="main">{|</span> Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">|}</span><span class="main">,</span> finsert <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span><span class="main">|}</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eff'</span> <span class="main">(</span>NegR <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="keyword1">then</span> Some <span class="main">{|</span><span class="main">(</span>finsert <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">|-|</span> <span class="main">{|</span> Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">|}</span><span class="main">)</span><span class="main">|}</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eff'</span> <span class="main">(</span>ConjL <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>
    <span class="keyword1">then</span> Some <span class="main">{|</span><span class="main">(</span>finsert <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>finsert <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">|-|</span> <span class="main">{|</span> Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span><span class="main">|}</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eff'</span> <span class="main">(</span>ConjR <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span>
    <span class="keyword1">then</span> Some <span class="main">{|</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> finsert <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">|-|</span> <span class="main">{|</span> Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> finsert <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="main">|-|</span> <span class="main">{|</span> Conj <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">|}</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Disj</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Neg <span class="main">(</span>Conj <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Imp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Disj <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Iff</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Conj <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Imp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">thm1</span> <span class="main">≡</span> <span class="main">(</span><span class="main">{|</span>Conj <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Neg <span class="main">(</span>Atom <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">|}</span><span class="main">,</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> Stream.smember_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Stream.smember <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">##</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> Stream.smember <span class="free">x</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Stream.smember_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> RuleSystem <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">ss</span><span class="main">.</span> eff' <span class="bound">r</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">ss</span>"</span></span> <span class="quoted">rules</span> <span class="quoted">UNIV</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rules_UNIV <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">Idle</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> PersistentRuleSystem <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">ss</span><span class="main">.</span> eff' <span class="bound">r</span> <span class="bound">s</span> <span class="main">=</span> Some <span class="bound">ss</span>"</span></span> <span class="quoted">rules</span> <span class="quoted">UNIV</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> enabled_def per_def rules_UNIV<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">Γ</span> <span class="skolem">Δ</span> <span class="skolem">ss</span> <span class="skolem">r'</span> <span class="skolem">Γ'</span> <span class="skolem">Δ'</span> <span class="skolem">ss'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≠</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"eff' <span class="skolem">r</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="quoted">"eff' <span class="skolem">r'</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">Δ</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ss'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">|∈|</span> <span class="skolem">ss'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">sl</span><span class="main">.</span> eff' <span class="skolem">r</span> <span class="main">(</span><span class="skolem">Γ'</span><span class="main">,</span> <span class="skolem">Δ'</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">sl</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">r'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rule.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> rule.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rho</span> <span class="main">≡</span> i.fenum rules"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">propTree</span> <span class="main">≡</span> i.mkTree eff' rho"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">propTree</span></span> <span class="quoted"><span class="quoted">thm1</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell <span class="keyword2"><span class="keyword">module_name</span></span> PropInstance <span class="comment1">(* file "." *)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>