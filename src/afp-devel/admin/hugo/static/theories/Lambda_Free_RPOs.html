<div id="Lambda_Free_Util">
<div class="head">
<h1>Theory Lambda_Free_Util</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Utilities for Lambda-Free Orders
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Utilities for Lambda-Free Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_Util
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Extended_Nat.html">HOL-Library.Extended_Nat</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset_Order.html">HOL-Library.Multiset_Order</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory gathers various lemmas that likely belong elsewhere in Isabelle or
the \emph{Archive of Formal Proofs}. Most (but certainly not all) of them are
used to formalize orders on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms.
›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Complex.arg


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Sets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_set_fold_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Finite_Set.fold <span class="free">f</span> <span class="free">z</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold_graph <span class="free">f</span> <span class="free">z</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fold_graph.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold_graph <span class="free">f</span> <span class="free">z</span> <span class="skolem">X</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟶</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fold_graph.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> fold_graph <span class="free">f</span> <span class="free">z</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Finite_Set.fold_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Function Power›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funpow_lesseq_iter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m_le_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono order_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funpow_less_iter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m_lt_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m_lt_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono less_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_antisym<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Least Operator›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Least_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_equality<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Least_in_nonempty_set_imp_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>wellorder<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    P_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P_least<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Least_eq_0_enat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span> <span class="main">::</span> enat<span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Least_equality<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Antisymmetric Relations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irrefl_trans_imp_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span> <span class="main">⟹</span> trans <span class="free">r</span> <span class="main">⟹</span> antisym <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> irrefl_def trans_def antisym_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> irreflp_transp_imp_antisymP<span class="main">:</span> <span class="quoted"><span class="quoted">"irreflp <span class="free">p</span> <span class="main">⟹</span> transp <span class="free">p</span> <span class="main">⟹</span> antisymp <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> irrefl_trans_imp_antisym <span class="main"><span class="main">[</span></span><span class="operator">to_pred</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Acyclic Relations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_nonempty_ex_succ_imp_cyclic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> acyclic <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> R_sub_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fin_R<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fin <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> infinite_super<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> acyclic <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> finite_acyclic_wf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin_R<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wf_eq_minimal<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">use</span> ex_y nemp <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> R_sub_r acyclic_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reflexive, Transitive Closure›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> relcomp_subset_left_imp_relcomp_trancl_subset_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">O</span> <span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">O</span> <span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">^^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rtrancl_imp_relpow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> O_assoc inf_sup_ord<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> le_iff_sup relcomp_distrib2 relpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        relpow_commute sub subsetCE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_chain_in_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">m</span><span class="main">,</span> <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> relpow_imp_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> relpow_fun_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="free">m</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="var">?k</span> <span class="main">=</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m_le_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?k</span><span class="main">.</span> <span class="main">(</span><span class="var">?g</span> <span class="bound">i</span><span class="main">,</span> <span class="var">?g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_chain<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> f_rev_chain_in_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">n</span><span class="main">,</span> <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f_chain_in_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> m_le_n<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="free"><span class="free"><span class="free">m</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> f_chain le_add_diff Suc_diff_Suc Suc_leI atLeastLessThan_iff diff_Suc_diff_eq1 diff_less
      le_add1 less_le_trans zero_less_Suc<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-Founded Relations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_app<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span> <span class="main">⟹</span> wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_eq_minimal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">`</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> wfP_app<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="free">p</span> <span class="main">⟹</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wfP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_app<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_exists_minimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> Q<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> wfP_exists_minimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_exists_minimal<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> wf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wfP_def<span class="main"><span class="main">]</span></span> Q<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_irrefl_trans_imp_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">r</span> <span class="main">⟹</span> irrefl <span class="free">r</span> <span class="main">⟹</span> trans <span class="free">r</span> <span class="main">⟹</span> wf <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> finite_acyclic_wf<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> acyclic_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_irreflp_transp_imp_wfp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span> <span class="main">⟹</span> irreflp <span class="free">p</span> <span class="main">⟹</span> transp <span class="free">p</span> <span class="main">⟹</span> wfP <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_irrefl_trans_imp_wf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> wfP_def transp_def irreflp_def trans_def irrefl_def mem_Collect_eq prod.case
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_infinite_down_chain_compatible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wf_R<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    inf_chain_RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∪</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    O_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="keyword1">O</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_Suc less_add_Suc1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf_chain_RS <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&gt;</span> <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="skolem">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">≥</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> wf_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_less<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span>
      <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j_of</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    j_of_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">j_of</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    j_of_in_R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">j_of</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">j_of</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    j_of_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">j_of</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>

  <span class="keyword1"><span class="command">have</span></span> j_of_min_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">j_of</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_of_min inf_chain_RS <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> between_g<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> f_rev_chain_in_rtrancl<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_of_gt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ia</span>
    <span class="keyword3"><span class="command">assume</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">..&lt;</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> ia_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ia <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ia_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">&lt;</span> <span class="skolem">j_of</span> <span class="main">(</span><span class="main">(</span><span class="skolem">j_of</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ia <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">ia</span><span class="main">)</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">ia</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> j_of_min_s<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ia_gt ia_lt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def funpow.simps comp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> relcomp_subset_left_imp_relcomp_trancl_subset_left<span class="main"><span class="main">[</span></span><span class="operator">OF</span> O_subset<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> relcompI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> j_of_in_R between_g<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∉</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_R<span class="main">[</span><span class="operator">unfolded</span> wf_iff_no_infinite_down_chain<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wellorders›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wellorder<span class="main">)</span> exists_minimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≥</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI Least_le<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_induct2<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Nil snoc<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> hd <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_lists_iff_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> butlast_append_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> butlast <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> butlast_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_in_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_le_sum_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ordered_ab_semigroup_monoid_add_imp_le list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">≤</span> sum_list <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> add_cancel_right_left add_increasing2 hd_append2 lessI less_SucI list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth_append
      nth_append_length order_refl self_append_conv2 sum_list.Nil<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_ge_length_times<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>ordered_ab_semigroup_add<span class="main">,</span>semiring_1<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">xs</span> <span class="main">≥</span> of_nat <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> xxs_i_ge_a <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> xs_i_ge_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">.</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xxs_i_ge_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xxs_i_ge_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> xs_i_ge_a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs ordered_ab_semigroup_add_class.add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_list_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ordered_semiring_0<span class="main">,</span>linordered_nonzero_semiring<span class="main">}</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">xs</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_append_0_upt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"zip <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span><span class="main">]</span> <span class="main">=</span>
   zip <span class="free">xs</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span> <span class="main">@</span> zip <span class="free">ys</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">..&lt;</span>length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_rec<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_eq_butlast_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len_gt0<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"zip <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> zip <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>butlast <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>last <span class="free">xs</span><span class="main">,</span> last <span class="free">ys</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> len_eq len_gt0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extended Natural Numbers›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> the_enat_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the_enat <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> the_enat_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the_enat <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_le_minus_1_imp_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">enat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def one_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_diff_diff_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">enat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_sub_add_same<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">enat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_the_enat_iden<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> enat <span class="main">(</span>the_enat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> the_enat_minus_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> the_enat <span class="main">(</span><span class="free">m</span> <span class="main">-</span> enat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> the_enat <span class="free">m</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_the_enat_le<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>the_enat <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_the_enat_minus_le<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span>the_enat <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_le_imp_minus_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">-</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">k</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">enat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> enat_diff_diff_eq enat_ord_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> enat_sub_add_same
    enat_the_enat_iden enat_the_enat_minus_le idiff_0_right idiff_infinity idiff_infinity_right
    order_trans_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span> plus_enat_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_diff_assoc2_enat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="free">p</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="free">p</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">enat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> enat_mult_minus_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"enat <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> enat <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">-</span> enat <span class="free">x</span> <span class="main">*</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> enat_0 right_diff_distrib'<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_lt_left_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">&lt;</span> add_mset <span class="free">b</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_le_left_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">≤</span> add_mset <span class="free">b</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_lt_right_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">&lt;</span> add_mset <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_le_right_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">≤</span> add_mset <span class="free">a</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_lt_lt_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_lt_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A_le_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">&lt;</span> add_mset <span class="free">b</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_mset_lt_left_lt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a_lt_b<span class="main"><span class="main">]</span></span> add_mset_lt_right_lt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A_le_B<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_lt_lt_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">&lt;</span> add_mset <span class="free">b</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_mset_lt_lt_lt le_neq_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_lt_le_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">&lt;</span> <span class="free">B</span> <span class="main">⟹</span> add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">&lt;</span> add_mset <span class="free">b</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_mset_lt_lt_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_right_lt le_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> add_mset_le_le_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a_le_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A_le_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">A</span> <span class="main">≤</span> add_mset <span class="free">b</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_mset_le_left_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a_le_b<span class="main"><span class="main">]</span></span> add_mset_le_right_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A_le_B<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> filter_eq_replicate_mset <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> image_mset_subseteq_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_subseteq_mset_eq_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset_mset.diff_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_subseteq_mset_iff_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset_mset.diff_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_gt_imp_in_mset<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> count_greater_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> size_lt_imp_ex_count_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">M</span> <span class="main">&lt;</span> size <span class="free">N</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_eq_zero_iff leD not_le_imp_less not_less_zero size_mset_mono subseteq_mset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_filter_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">#}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_filter_unsat_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">x</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">#}</span> <span class="main">&lt;</span> size <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>filter_mset <span class="free">P</span> <span class="free">M</span><span class="main">)</span> <span class="main">≠</span> size <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_diff_cancel_left' count_filter_mset mem_Collect_eq
      multiset_partition nonempty_has_size set_mset_def size_union<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> leD nat_neq_iff size_filter_mset_lesseq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_filter_ne_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="free">M</span> <span class="main">⟹</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">#}</span> <span class="main">&lt;</span> size <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_filter_unsat_elem<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_eq_ex_count_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    sz_m_eq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">M</span> <span class="main">=</span> size <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    m_eq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="skolem">x</span> <span class="main">≠</span> count <span class="free">N</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m_eq_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> multiset_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="skolem">x</span> <span class="main">&gt;</span> count <span class="free">N</span> <span class="skolem">x</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#}</span> <span class="main">+</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span> <span class="main">=</span>
      size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#}</span> <span class="main">+</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sz_m_eq_n multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_union<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sz_m_minus_x<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span> <span class="main">&lt;</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"count <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span> <span class="skolem">y</span> <span class="main">&lt;</span> count <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="free">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_lt_imp_ex_count_lt<span class="main">[</span><span class="operator">OF</span> sz_m_minus_x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="skolem">y</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_filter_mset less_asym<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_lt_imp_lt_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> set_mset <span class="free">M</span> <span class="main">∪</span> set_mset <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">b</span> <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> x_ni_f <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> x_f_eq_m_n <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    cnt_b <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Mb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Na</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Nb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> m_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="var">?Mb</span> <span class="main">+</span> <span class="var">?Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="var">?Nb</span> <span class="main">+</span> <span class="var">?Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> f_eq_ma_na<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> set_mset <span class="var">?Ma</span> <span class="main">∪</span> set_mset <span class="var">?Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_f_eq_m_n x_ni_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Ma</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Na</span><span class="main">)</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> cnt_ba<span class="main">:</span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xa</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ma</span> <span class="skolem">xa</span> <span class="main">&lt;</span> count <span class="var">?Na</span> <span class="skolem">xa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> f_eq_ma_na cnt_ba<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_filter_mset not_less0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> cnt_ba<span class="main">:</span> False
    <span class="keyword1"><span class="command">have</span></span> fx_eq_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_b cnt_ba <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> m_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> n_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">presburger</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">M</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="skolem">N</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_b cnt_ba <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> m_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> n_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fx_eq_b<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_lt_imp_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cnt_b<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="free">b</span> <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">N</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> count_image_mset_lt_imp_lt_raw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set_mset <span class="free"><span class="free"><span class="free">M</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set_mset <span class="free"><span class="free"><span class="free">N</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl cnt_b<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_le_imp_lt_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> set_mset <span class="free">M</span> <span class="main">∪</span> set_mset <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="free">N</span> <span class="free">a</span> <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="free">M</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">∧</span> count <span class="free">M</span> <span class="bound">b</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> x_ni_f <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> x_f_eq_m_n <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    cnt_lt <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Mb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">M</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Na</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Nb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">N</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> m_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="var">?Mb</span> <span class="main">+</span> <span class="var">?Ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n_part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="var">?Nb</span> <span class="main">+</span> <span class="var">?Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> multiset_partition <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> f_eq_ma_na<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> set_mset <span class="var">?Ma</span> <span class="main">∪</span> set_mset <span class="var">?Na</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_f_eq_m_n x_ni_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> fx_ne_fa<span class="main">:</span> False

    <span class="keyword1"><span class="command">have</span></span> cnt_fma_fa<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Ma</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fx_ne_fa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> m_part<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cnt_fna_fa<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Na</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fx_ne_fa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n_part<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cnt_ma_a<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Ma</span> <span class="free">a</span> <span class="main">=</span> count <span class="skolem">M</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fx_ne_fa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> m_part<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cnt_na_a<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Na</span> <span class="free">a</span> <span class="main">=</span> count <span class="skolem">N</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fx_ne_fa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n_part<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> fb_eq_fa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_b<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Ma</span> <span class="skolem">b</span> <span class="main">&lt;</span> count <span class="var">?Na</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> f_eq_ma_na<span class="main">]</span> cnt_lt <span class="keyword1"><span class="command">unfolding</span></span> cnt_fma_fa cnt_fna_fa cnt_ma_a cnt_na_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> fx_ne_fb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fb_eq_fa fx_ne_fa <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> cnt_ma_b<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Ma</span> <span class="skolem">b</span> <span class="main">=</span> count <span class="skolem">M</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fx_ne_fb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> m_part<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cnt_na_b<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Na</span> <span class="skolem">b</span> <span class="main">=</span> count <span class="skolem">N</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fx_ne_fb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n_part<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fb_eq_fa cnt_b <span class="keyword1"><span class="command">unfolding</span></span> cnt_ma_b cnt_na_b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> fx_eq_fa<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> x_eq_a<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Ma</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="var">?Na</span> <span class="free">a</span>
        <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Na</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="var">?Ma</span> <span class="free">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_lt x_eq_a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> m_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> n_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> f_eq_ma_na<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_filter_mset nat_neq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> x_ne_a<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="skolem">M</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="skolem">N</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> fx_eq_fa <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">M</span> <span class="skolem">x</span> <span class="main">≥</span> count <span class="skolem">N</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">M</span> <span class="skolem">x</span> <span class="main">+</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Ma</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="var">?Na</span> <span class="free">a</span>
          <span class="main">&lt;</span> count <span class="skolem">N</span> <span class="skolem">x</span> <span class="main">+</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Na</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="var">?Ma</span> <span class="free">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_lt x_ne_a fx_eq_fa <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> m_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> n_part<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Ma</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="var">?Na</span> <span class="free">a</span>
          <span class="main">&lt;</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="var">?Na</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> count <span class="var">?Ma</span> <span class="free">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> f_eq_ma_na<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_filter_mset nat_neq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_image_mset_le_imp_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">≤</span> count <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count <span class="free">M</span> <span class="free">a</span> <span class="main">&gt;</span> count <span class="free">N</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">∧</span> count <span class="free">M</span> <span class="bound">b</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> count_image_mset_le_imp_lt_raw<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">∪</span> set_mset <span class="free">N</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_in_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">⟹</span> Max_mset <span class="free">M</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_lt_imp_lt_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> max<span class="main">:</span> <span class="quoted"><span class="quoted">"Max_mset <span class="free">M</span> <span class="main">&lt;</span> Max_mset <span class="free">N</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?max_M</span> <span class="main">&lt;</span> <span class="var">?max_N</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> m_nemp<span class="main">:</span> False

  <span class="keyword1"><span class="command">have</span></span> max_n_in_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?max_N</span> <span class="main">∈#</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_nemp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> max_n_nin_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?max_N</span> <span class="main">∉#</span> <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max Max_ge leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="free">N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="free">N</span> <span class="skolem">y</span> <span class="main">&lt;</span> count <span class="free">M</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?max_M</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?max_N</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> max <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span> <span class="main">&gt;</span> <span class="skolem">y</span><span class="main">.</span> count <span class="free">M</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="free">N</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> max_n_nin_m max_n_in_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_nemp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_mset_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fold_mset <span class="free">f</span> <span class="free">z</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_mset_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_Term">
<div class="head">
<h1>Theory Lambda_Free_Term</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_Term
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_Util.html">Lambda_Free_Util</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"&gt;s"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>s</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"&gt;h"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≤≥h"</span> <span class="main">=</span> <span class="quoted">"≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms and related locales.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Precedence on Symbols›</span></span>

<span class="keyword1"><span class="command">locale</span></span> gt_sym <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gt_sym_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_sym_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">h</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_sym_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">g</span> <span class="main">∨</span> <span class="free">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">f</span> <span class="main">∨</span> <span class="free">g</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_sym_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="bound">f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sym_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">g</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gt_sym_irrefl gt_sym_trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Heads›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="quasi_keyword">plugins</span> <span class="quasi_keyword">del</span><span class="main">:</span> size<span class="main">)</span> <span class="main">(</span>syms_hd<span class="main">:</span> <span class="tfree">'s</span><span class="main">,</span> vars_hd<span class="main">:</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">=</span>
  <span class="entity">is_Var</span><span class="main">:</span> Var <span class="main">(</span><span class="free"><span class="entity">var</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span><span class="main">)</span>
<span class="main">|</span> Sym <span class="main">(</span><span class="free"><span class="entity">sym</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_Sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_Sym</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">≡</span> <span class="main">¬</span> is_Var <span class="free"><span class="bound"><span class="entity">ζ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_vars_hd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars_hd <span class="free">ζ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_syms_hd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>syms_hd <span class="free">ζ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Terms›</span></span>

<span class="keyword1"><span class="command">consts</span></span> head0 <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>syms<span class="main">:</span> <span class="tfree">'s</span><span class="main">,</span> vars<span class="main">:</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">=</span>
  <span class="entity">is_Hd</span><span class="main">:</span> Hd <span class="main">(</span><span class="free"><span class="free"><span class="entity">head</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd"</span></span><span class="main">)</span>
<span class="main">|</span> App <span class="main">(</span><span class="quoted">"<span class="free"><span class="free"><span class="entity">fun</span></span></span>"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">arg</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">head</span> <span class="main">(</span>App <span class="free">s</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> head0 <span class="free">s</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fun</span> <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">=</span> Hd <span class="free">ζ</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arg</span> <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">=</span> Hd <span class="free">ζ</span>"</span></span>

<span class="keyword1"><span class="command">overloading</span></span> head0 <span class="main">≡</span> <span class="quoted"><span class="quoted">"head0 <span class="main">::</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">head0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">head0</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">head0</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">head0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> head_App<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> head <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> tm.sel<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> head_fun<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">=</span> head <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ground</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ground</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> vars <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">is_App</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_App</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">¬</span> is_Hd <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  size_fun_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> size <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  size_arg_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> size <span class="main">(</span>arg <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  finite_vars<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>vars <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  finite_syms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>syms <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  vars_head_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> vars <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  syms_head_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"syms_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> syms <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">args</span> <span class="main">(</span>Hd <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">args</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_args_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> arg_in_args<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> arg <span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm.exhaust<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span>
  vars_args_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> vars <span class="free">si</span> <span class="main">⊆</span> vars <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  syms_args_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">si</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> syms <span class="free">si</span> <span class="main">⊆</span> syms <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> args_Nil_iff_is_Hd<span class="main">:</span> <span class="quoted"><span class="quoted">"args <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> is_Hd <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">num_args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">num_args</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> length <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_ge_num_args<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">s</span> <span class="main">≥</span> num_args <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Hd_head_id<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="free">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args.cases args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_0_conv snoc_eq_iff_butlast tm.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> one_arg_imp_Hd<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="free">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> App <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> Hd <span class="main">(</span>head <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Hd_head_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_in_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">s</span> <span class="main">&lt;</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">apps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apps</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">apps</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">apps</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  vars_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">s</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">.</span> vars <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  syms_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"syms <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> syms <span class="free">s</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free">ss</span><span class="main">.</span> syms <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  head_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> head <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  args_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"args <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> args <span class="free">s</span> <span class="main">@</span> <span class="free">ss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  is_App_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="main">⟷</span> args <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  fun_apps_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fun <span class="main">(</span>apps <span class="free">s</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> fun <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  fun_apps_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fun <span class="main">(</span>apps <span class="main">(</span>App <span class="free">s</span> <span class="free">sa</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> apps <span class="free">s</span> <span class="main">(</span>butlast <span class="main">(</span><span class="free">sa</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  arg_apps_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="main">(</span>apps <span class="free">s</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> arg <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  arg_apps_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="main">(</span>apps <span class="main">(</span>App <span class="free">s</span> <span class="free">sa</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span><span class="free">sa</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">sa</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_Nil_iff_is_Hd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apps_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">ss</span> <span class="main">@</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> apps <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> App_apps<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>apps <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> apps <span class="free">s</span> <span class="main">(</span><span class="free">ts</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> tm_inject_apps<span class="main">[</span><span class="operator">iff</span><span class="main">,</span> <span class="operator">induct_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apps <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="free">ξ</span><span class="main">)</span> <span class="free">ts</span> <span class="main">⟷</span> <span class="free">ζ</span> <span class="main">=</span> <span class="free">ξ</span> <span class="main">∧</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_apps head_apps same_append_eq tm.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tm_collapse_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tm_expand_apps<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">s</span> <span class="main">=</span> head <span class="free">t</span> <span class="main">⟹</span> args <span class="free">s</span> <span class="main">=</span> args <span class="free">t</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm_collapse_apps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tm_exhaust_apps_sel<span class="main">[</span><span class="operator">case_names</span> apps<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tm_exhaust_apps<span class="main">[</span><span class="operator">case_names</span> apps<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">ζ</span> <span class="bound">ss</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="bound">ζ</span><span class="main">)</span> <span class="bound">ss</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm_collapse_apps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tm_induct_apps<span class="main">[</span><span class="operator">case_names</span> apps<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ζ</span> <span class="bound">ss</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="bound">ss</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>apps <span class="main">(</span>Hd <span class="bound">ζ</span><span class="main">)</span> <span class="bound">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted">size</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> size_in_args tm_collapse_apps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  ground_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> ground <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  ground_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> ground <span class="main">(</span>arg <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_head<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> is_Sym <span class="main">(</span>head <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_Var_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> ground <span class="free">s</span> <span class="main">⟹</span> ground <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">vars_mset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="tfree">'v</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vars_mset</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> mset_set <span class="main">(</span>vars_hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">vars_mset</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">vars_mset</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="free">vars_mset</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_vars_mset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>vars_mset <span class="free">t</span><span class="main">)</span> <span class="main">=</span> vars <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mset_empty_iff<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="free">s</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> ground <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_set_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mset_fun<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_mset <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mset_arg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>arg <span class="free">t</span><span class="main">)</span> <span class="main">⊆#</span> vars_mset <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹hsize›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The hsize of a term is the number of heads (Syms or Vars) in the term.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">hsize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hsize</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">hsize</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">hsize</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> <span class="free">hsize</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_size<span class="main">:</span> <span class="quoted"><span class="quoted">"hsize <span class="free">t</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">=</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_pos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hsize <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_fun_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> hsize <span class="main">(</span>fun <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> hsize <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_arg_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> hsize <span class="main">(</span>arg <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> hsize <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> hsize_ge_num_args<span class="main">:</span> <span class="quoted"><span class="quoted">"hsize <span class="free">s</span> <span class="main">≥</span> hsize <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_in_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> hsize <span class="free">s</span> <span class="main">&lt;</span> hsize <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_apps<span class="main">:</span> <span class="quoted"><span class="quoted">"hsize <span class="main">(</span>apps <span class="free">t</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> hsize <span class="free">t</span> <span class="main">+</span> sum_list <span class="main">(</span>map hsize <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hsize_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> sum_list <span class="main">(</span>map hsize <span class="main">(</span>args <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hsize <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hsize.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hsize_apps tm_collapse_apps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitutions›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="keyword1">of</span> Var <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">|</span> Sym <span class="bound">f</span> <span class="main">⇒</span> Hd <span class="main">(</span>Sym <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> App <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="main">(</span>apps <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> apps <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> head_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="main">(</span>Hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> args_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"args <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> head <span class="free">s</span> <span class="keyword1">of</span> Var <span class="bound">x</span> <span class="main">⇒</span> args <span class="main">(</span><span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> Sym <span class="bound">f</span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_imp_subst_iden<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mset_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑<span class="hidden">⇩</span><sub>#</sub></span> <span class="main">{#</span>vars_mset <span class="main">(</span><span class="free">ρ</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> vars_mset <span class="free">s</span><span class="main">#}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mset_subst_subseteq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="free">t</span> <span class="main">⊇#</span> vars_mset <span class="free">s</span> <span class="main">⟹</span> vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊇#</span> vars_mset <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vars_mset_subst
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_diff_cancel_right' diff_subset_eq_self image_mset_union sum_mset.union
    subset_mset.add_diff_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vars_subst_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span> <span class="main">⟹</span> vars <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊇</span> vars <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_vars_mset<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> vars_mset_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterms›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  sub_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> sub_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> sub_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">sub</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> sub_HdE<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="main">(</span>Hd <span class="free">ξ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> sub_AppE<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="main">(</span>App <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> sub_Hd_HdE<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">(</span>Hd <span class="free">ξ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> sub_Hd_AppE<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">(</span>App <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_vars_imp_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> vars <span class="free">s</span> <span class="main">⟷</span> sub <span class="main">(</span>Hd <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> hd.set_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> sub <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_size<span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> size <span class="free">s</span> <span class="main">≤</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> sub <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub.intros <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sub_AppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sub_AppE<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">proper_sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proper_sub</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> sub <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proper_sub_Hd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> proper_sub <span class="free">s</span> <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sub.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> proper_sub_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> psub<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_sub <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proper_sub <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Hd
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> psub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="skolem">t1</span> <span class="main">∨</span> sub <span class="free">s</span> <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t psub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sub <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">∨</span> sub <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sub_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sub.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sub_size<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Maximum Arities›</span></span>

<span class="keyword1"><span class="command">locale</span></span> arity <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">arity_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_hd</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">arity_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arity_hd</span> <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">arity_sym</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> arity_hd <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">-</span> num_args <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"arity <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span> <span class="main">=</span> arity_hd <span class="free">ζ</span>"</span></span>
  <span class="quoted"><span class="quoted">"arity <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> arity <span class="free">s</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arity_def enat_diff_diff_eq add.commute eSuc_enat plus_1_eSuc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arity_apps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>apps <span class="free">s</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> arity <span class="free">s</span> <span class="main">-</span> length <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  wary_Hd<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wary</span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> wary_App<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wary</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">wary</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> num_args <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">wary</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> wary_HdE<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>Hd <span class="free">ζ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> wary_AppE<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> wary_binaryE<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wary_fun<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="main">(</span>fun <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wary.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_arg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="main">(</span>arg <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wary.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="main">(</span><span class="operator">metis</span> Un_iff args.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wary.cases insert_iff length_pos_if_in_set
      less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> set_append tm.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tm.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">t</span> <span class="main">⟹</span> wary <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sub.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wary.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_inf_ary<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">ζ</span><span class="main">.</span> arity_hd <span class="bound">ζ</span> <span class="main">=</span> <span class="main">∞</span><span class="main">)</span> <span class="main">⟹</span> wary <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_num_args_le_arity_head<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> num_args <span class="free">s</span> <span class="main">≤</span> arity_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wary.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Suc_ile_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_apps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∈</span> set <span class="free">ss</span> <span class="main">⟹</span> wary <span class="bound">sa</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">ss</span> <span class="main">≤</span> arity <span class="free">s</span> <span class="main">⟹</span> wary <span class="main">(</span>apps <span class="free">s</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">sa</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> wary_ss <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> nargs_s_sa_ss <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> apps.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wary <span class="skolem">sa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" enat <span class="main">(</span>num_args <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> One_nat_def add.comm_neutral arity_def diff_add_zero enat_ord_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        idiff_enat_enat less_one list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nargs_s_sa_ss not_add_less2
        order.not_eq_order_implies_strict wary_num_args_le_arity_head wary_s<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">sa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_App<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∈</span> set <span class="skolem">ss</span> <span class="main">⟹</span> wary <span class="bound">sa</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">≤</span> arity <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">sa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> enat
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> nargs_s_sa_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_enat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_cases_apps<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> apps<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    apps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ζ</span> <span class="bound">ss</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="bound">ζ</span><span class="main">)</span> <span class="bound">ss</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∈</span> set <span class="bound">ss</span> <span class="main">⟹</span> wary <span class="bound">sa</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">ss</span> <span class="main">≤</span> arity_hd <span class="bound">ζ</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> apps
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ζ</span> <span class="bound">ss</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="bound">ζ</span><span class="main">)</span> <span class="bound">ss</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">sa</span><span class="main">.</span> <span class="bound">sa</span> <span class="main">∈</span> set <span class="bound">ss</span> <span class="main">⟶</span> wary <span class="bound">sa</span><span class="main">)</span> <span class="main">∧</span> enat <span class="main">(</span>length <span class="bound">ss</span><span class="main">)</span> <span class="main">≤</span> arity_hd <span class="bound">ζ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ζ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ss</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t wary_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wary_t<span class="main"><span class="main">]</span></span> wary_num_args_le_arity_head<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_t<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> t<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arity_hd_head<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span> <span class="main">⟹</span> arity_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">=</span> arity <span class="free">s</span> <span class="main">+</span> num_args <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> arity_def enat_sub_add_same wary_num_args_le_arity_head<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arity_head_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">≥</span> arity <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> enat_le_imp_minus_le<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wary_fo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  wary_foI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_Hd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> is_Sym <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> length <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> arity_hd <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">wary_fo</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">wary_fo</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wary_fo_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> wary_fo <span class="free">t</span> <span class="main">⟹</span> wary_fo <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> args.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> args_apps self_append_conv2 wary_fo.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_fo_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_fo <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> wary_fo <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> wary_fo.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Potential Heads of Ground Instances of Variables›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ground_heads <span class="main">=</span> gt_sym <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span> <span class="main">+</span> arity <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span>
    <span class="keyword2"><span class="keyword">for</span></span>
      <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">ground_heads_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ground_heads_var_arity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">ground_heads_var</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">arity_sym</span> <span class="free">f</span> <span class="main">≥</span> <span class="free">arity_var</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ground_heads_var_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ground_heads_var</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ground_heads</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ground_heads</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ground_heads_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ground_heads</span> <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_heads_arity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span> <span class="main">⟹</span> <span class="free">arity_sym</span> <span class="free">f</span> <span class="main">≥</span> arity_hd <span class="free">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ground_heads_var_arity<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_heads_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ground_heads <span class="free">ζ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ground_heads_var_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sym_in_ground_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"is_Sym <span class="free">ζ</span> <span class="main">⟹</span> sym <span class="free">ζ</span> <span class="main">∈</span> ground_heads <span class="free">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_heads.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd.simps<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ground_hd_in_ground_heads<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="free">s</span> <span class="main">⟹</span> sym <span class="main">(</span>head <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_head sym_in_ground_heads<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> some_ground_head_arity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="free">arity_var</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_heads_var_arity ground_heads_var_nonempty some_in_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wary_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wary_subst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> wary <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> arity <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">≥</span> <span class="free">arity_var</span> <span class="bound">x</span> <span class="main">∧</span> ground_heads <span class="main">(</span>head <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">ground_heads_var</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strict_wary_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strict_wary_subst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> wary <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> arity <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">arity_var</span> <span class="bound">x</span><span class="main">,</span> <span class="main">∞</span><span class="main">}</span>
    <span class="main">∧</span> ground_heads <span class="main">(</span>head <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">ground_heads_var</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_imp_wary_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_wary_subst <span class="free">ρ</span> <span class="main">⟹</span> wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strict_wary_subst_def wary_subst_def <span class="keyword1"><span class="command">using</span></span> eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_subst_wary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wary_s
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> wary_st <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wary_st <span class="keyword1"><span class="command">have</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_AppE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wary_st <span class="keyword1"><span class="command">have</span></span> wary_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_AppE<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wary_st <span class="keyword1"><span class="command">have</span></span> nargs_s_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">s</span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_AppE<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> wary_ρs <span class="main">=</span> App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wary_s<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> wary_ρt <span class="main">=</span> App<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wary_t<span class="main">]</span>

  <span class="keyword1"><span class="command">note</span></span> wary_ρx <span class="main">=</span> wary_ρ<span class="main">[</span><span class="operator">unfolded</span> wary_subst_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ary_ρx <span class="main">=</span> wary_ρ<span class="main">[</span><span class="operator">unfolded</span> wary_subst_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> num_args <span class="skolem">s</span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> hd_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> ary_hd_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arity_hd <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">arity_var</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_s arity_hd.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">s</span> <span class="main">≤</span> arity <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> wary_num_args_le_arity_head ary_ρx dual_order.trans wary_s<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"num_args <span class="skolem">s</span> <span class="main">+</span> num_args <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> arity_hd <span class="main">(</span>head <span class="main">(</span><span class="free">ρ</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> arity_hd_head<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_ρx<span class="main"><span class="main">]</span></span> add_right_mono plus_enat_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ary_hd_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute add_diff_cancel_left' ary_ρx arity_def
        idiff_enat_enat leD nargs_s_lt order.not_eq_order_implies_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> nargs_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"num_args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span> arity_hd <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nargs_s_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> wary_App<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_ρs wary_ρt nargs_ρs<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wary_ρ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wary_subst_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> strict_wary_subst_wary <span class="main">=</span> wary_subst_wary<span class="main">[</span><span class="operator">OF</span> strict_imp_wary_subst<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> wary_subst_ground_heads<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ground_heads <span class="main">(</span>head <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_induct_apps<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> x<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> wary_ρ wary_subst_def x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> strict_wary_subst_ground_heads <span class="main">=</span> wary_subst_ground_heads<span class="main">[</span><span class="operator">OF</span> strict_imp_wary_subst<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">grounding_ρ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">grounding_ρ</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> Hd <span class="main">(</span>Sym <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ground_heads_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
     apps <span class="bound">s</span> <span class="main">(</span>replicate <span class="main">(</span>the_enat <span class="main">(</span>arity <span class="bound">s</span> <span class="main">-</span> <span class="free">arity_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ground_grounding_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="main">(</span>subst grounding_ρ <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def grounding_ρ_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> hd.set_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_wary_grounding_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_wary_subst grounding_ρ"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> strict_wary_subst_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ground_heads_var</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Hd <span class="main">(</span>Sym <span class="skolem">f</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> wary_s<span class="main">:</span> <span class="quoted"><span class="quoted">"wary <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wary_Hd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ary_s_ge_x<span class="main">:</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">s</span> <span class="main">≥</span> <span class="free">arity_var</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> s_def f_def <span class="keyword1"><span class="command">using</span></span> some_ground_head_arity <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> grρ_x<span class="main">:</span> <span class="quoted"><span class="quoted">"grounding_ρ <span class="skolem">x</span> <span class="main">=</span> apps <span class="skolem">s</span> <span class="main">(</span>replicate <span class="main">(</span>the_enat <span class="main">(</span>arity <span class="skolem">s</span> <span class="main">-</span> <span class="free">arity_var</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grounding_ρ_def Let_def f_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> s_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wary <span class="main">(</span>grounding_ρ <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grρ_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wary_s wary_apps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_s<span class="main"><span class="main">]</span></span> enat_the_enat_minus_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>grounding_ρ <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="free">arity_var</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">∞</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grρ_x <span class="keyword1"><span class="command">using</span></span> ary_s_ge_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"arity <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">arity_var</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ground_heads <span class="main">(</span>head <span class="main">(</span>grounding_ρ <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">ground_heads_var</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> grρ_x s_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> some_in_eq ground_heads_var_nonempty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> wary_grounding_ρ <span class="main">=</span> strict_wary_grounding_ρ<span class="main">[</span><span class="operator">THEN</span> strict_imp_wary_subst<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gt_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> ground_heads <span class="free"><span class="bound"><span class="entity">ξ</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">.</span> <span class="bound">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comp_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> hd <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1"><span class="free">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span></span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free"><span class="bound"><span class="entity">ξ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_hd_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ζ</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gt_hd_def <span class="keyword1"><span class="command">using</span></span> gt_sym_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ex_in_conv ground_heads_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_hd_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free">ξ</span> <span class="main">⟹</span> <span class="free">ξ</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free">ζ</span> <span class="main">⟹</span> <span class="free">χ</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free">ζ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gt_hd_def <span class="keyword1"><span class="command">using</span></span> gt_sym_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ex_in_conv ground_heads_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sym_imp_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free">f</span> <span class="main">⟹</span> Sym <span class="free">g</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> Sym <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gt_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_comp_hd_imp_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ξ</span> <span class="keyword1">≤≥<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> <span class="free">ζ</span> <span class="main">⟹</span> is_Var <span class="free">ζ</span> <span class="main">∨</span> is_Var <span class="free">ξ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_sym_total <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ζ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ξ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_hd_def gt_hd_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Infinite_Chain">
<div class="head">
<h1>Theory Infinite_Chain</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Infinite (Non-Well-Founded) Chains
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infinite (Non-Well-Founded) Chains›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Infinite_Chain
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_Util.html">Lambda_Free_Util</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the concept of a minimal bad (or non-well-founded)
infinite chain, as found in the term rewriting literature to prove the
well-foundedness of syntactic term orders.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inf_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inf_chain</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wfP_iff_no_inf_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">p</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wfP_def wf_iff_no_infinite_down_chain inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_chain_offset<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="free">f</span> <span class="main">⟹</span> inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">j</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bad</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bad</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="bound">f</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_chain_bad<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bad_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bad_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">j</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">f</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">j</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_chain_offset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bad_f<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">worst_chain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">worst_chain</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> bad <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> bad <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">worst_chain</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> bad <span class="bound">x</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span><span class="free">worst_chain</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> bad <span class="bound">y</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span><span class="free">worst_chain</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> worst_chain.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  bad_worst_chain_0<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>worst_chain <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  min_worst_chain_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span>worst_chain <span class="main">0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"bad <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> bad <span class="bound">z</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">gt</span> <span class="skolem">y</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_exists_minimal<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">bad</span><span class="main">,</span> <span class="operator">OF</span> x_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>worst_chain <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> bad <span class="bound">z</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span>worst_chain <span class="main">0</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> worst_chain.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>worst_chain <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span>worst_chain <span class="main">0</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_bad <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  bad_worst_chain_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>worst_chain <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  worst_chain_pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>worst_chain <span class="free">i</span><span class="main">)</span> <span class="main">(</span>worst_chain <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  min_worst_chain_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>worst_chain <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span>worst_chain <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">i</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> bad_worst_chain_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fa</span></span> <span class="keyword2"><span class="keyword">where</span></span> fa_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="skolem">fa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fa_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fa</span> <span class="main">0</span> <span class="main">=</span> worst_chain <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s0</span><span class="main">.</span> bad <span class="bound">s0</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="bound">s0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">fa</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bad <span class="var">?y0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> bad_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">fa</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> inf_chain_offset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fa_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="var">?y0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fa_bad<span class="main">[</span><span class="operator">unfolded</span> inf_chain_def<span class="main">]</span> fa_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y0</span></span> <span class="keyword2"><span class="keyword">where</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="skolem">y0</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="skolem">y0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    y1<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="skolem">y1</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="skolem">y1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> bad <span class="bound">z</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">gt</span> <span class="skolem">y1</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_exists_minimal<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> bad <span class="bound">y</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="bound">y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> y0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> conj<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?y</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="var">?y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> bad <span class="bound">z</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">gt</span> <span class="var">?y</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> worst_chain.simps <span class="keyword1"><span class="command">using</span></span> y1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bad <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conj<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conj<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>worst_chain <span class="skolem">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">gt</span> <span class="var">?y</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_bad conj<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bad_worst_chain<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>worst_chain <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bad_worst_chain_0 bad_worst_chain_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> worst_chain_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain worst_chain"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">using</span></span> worst_chain_pred <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    x_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    p_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">p</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">p</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> worst_chain_not_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span>worst_chain <span class="free">i</span><span class="main">)</span> <span class="main">(</span>worst_chain <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_worst_chain_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inf_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> worst_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_bad<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Suc
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Suc
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_worst_chain_Suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inf_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> worst_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_bad<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> p_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> worst_chain_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_bad<span class="main"><span class="main">]</span></span> worst_chain_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x_bad<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inf_chain_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="free">p</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">q</span> <span class="main">⟹</span> inf_chain <span class="free">q</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> bad_worst_chain_0 bad_worst_chain_Suc

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Extension_Orders">
<div class="head">
<h1>Theory Extension_Orders</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Extension Orders
    Author:      Heiko Becker &lt;heikobecker92@gmail.com&gt;, 2016
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Dmitriy Traytel &lt;traytel@inf.ethz.ch&gt;, 2014
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extension Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Extension_Orders
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_Util.html">Lambda_Free_Util</a> <a href="Infinite_Chain.html">Infinite_Chain</a> <span class="quoted">"<a href="../../HOL/HOL-Cardinals/Wellorder_Extension.html">HOL-Cardinals.Wellorder_Extension</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines locales for categorizing extension orders used for orders on
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms and defines variants of the lexicographic and
multiset orders.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locales›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    map<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">≤</span> <span class="free">ext</span> <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mono_strong <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_irrefl <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_trans <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
    <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_irrefl_before_trans <span class="main">=</span> ext_irrefl <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans_from_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">zs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span>
    <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_trans_before_irrefl <span class="main">=</span> ext_trans <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irrefl_from_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_irrefl_trans_strong <span class="main">=</span> ext_irrefl <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ext_irrefl_trans_strong <span class="main">&lt;</span> ext_irrefl_before_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">erule</span> irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> ext_irrefl_trans_strong <span class="main">&lt;</span> ext_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> in_listsD trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> ext_irrefl_trans_strong <span class="main">&lt;</span> ext_trans_before_irrefl
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> ext_snoc <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_compat_cons <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compat_append_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> compat_cons<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_compat_snoc <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compat_append_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> compat_snoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> append_assoc <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_compat_list <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_singleton <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_compat_list_strong <span class="main">=</span> ext_compat_cons <span class="main">+</span> ext_compat_snoc <span class="main">+</span> ext_singleton
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> compat_append_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">gt</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
    compat_append_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">gt</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">xs'</span></span><span class="main">]</span> singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">gt</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ext_compat_list_strong <span class="main">&lt;</span> ext_compat_list
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> ext_total <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span>
    <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_wf <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_hd_or_tl <span class="main">=</span> ext <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
    length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ext_wf_bounded <span class="main">=</span> ext_irrefl_before_trans <span class="main">+</span> ext_hd_or_tl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irrefl_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irrefl gt_irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trans_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans_from_irrefl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free"><span class="free">zs</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set <span class="free"><span class="free"><span class="free">ys</span></span></span> <span class="main"><span class="main"><span class="main">∪</span></span></span> set <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">zs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ys</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">gt</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_or_tl_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> hd_or_tl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_total<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_same_length_if_total<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_def wf_def <span class="keyword1"><span class="command">using</span></span> irrefl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gt_hd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> <span class="skolem">gt_hd</span> <span class="bound">ys</span> <span class="bound">xs</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="main">(</span>hd <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>hd <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gt_tl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> <span class="skolem">gt_tl</span> <span class="bound">ys</span> <span class="bound">xs</span> <span class="main">⟷</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span>tl <span class="bound">ys</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">xs</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> hd_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gt_hd</span> <span class="skolem">ys</span> <span class="skolem">xs</span> <span class="main">∨</span> <span class="skolem">gt_tl</span> <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> len_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">ys</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> len_ys len_xs ys_gt_xs <span class="keyword1"><span class="command">unfolding</span></span> gt_hd_def gt_tl_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_or_tl_gt<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtsn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtsSn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gttlSn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">gt_tl</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="var">?gtsSn</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?gtsSn</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="var">?gtsSn</span> <span class="skolem">gt_hd</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> wf_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="skolem">gt_hd</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_wf<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">hd</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> wfP_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtsSn</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_hd xs_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">gt_hd</span> <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_not_gt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_hd xs_bad<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans_gt<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> tl_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gttlSn</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">using</span></span> hd_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> inf_chain <span class="var">?gtsn</span> <span class="main">(</span>tl <span class="main">∘</span> <span class="var">?ff</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wfP_iff_no_inf_chain<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> ih<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> tl_good<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> inf_chain <span class="var">?gttlSn</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_tl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> tl_bad tl_good <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_bounded_if_total<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ex_bad <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtsle</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?gtsle</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_bad <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="var">?gtsle</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">&gt;</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> wf_len <span class="main">=</span> wf_app<span class="main">[</span><span class="operator">OF</span> wellorder_class.wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> ff_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtsle</span> <span class="var">?ff</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_len xs_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ffi_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bad <span class="var">?gtsle</span> <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_chain_bad<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ff_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> len_le_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> length <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_len xs_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len_le_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> length <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> worst_chain_not_gt<span class="main">[</span><span class="operator">OF</span> wf_len xs_bad<span class="main">]</span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans_gt<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> length <span class="main">(</span><span class="var">?ff</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> len_lt_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> length <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len_le_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_neq_implies_less<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> nm1_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtslt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtslt</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ff_bad len_lt_n <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_diff_1 le_antisym nat_neq_iff not_less0 not_less_eq_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> nm1_le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> len_eq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtssl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ys</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> len_eq_n<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_eq_n<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> len_le_n len_le_Suc add_Suc dual_order.antisym<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtsle</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_chain_offset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ff_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtssl</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">using</span></span> len_eq_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="var">?gtssl</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wfP_iff_no_inf_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> wf_same_length_if_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gt_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ge'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    gt_sub_Ge'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">Ge'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Ge'_wo<span class="main">:</span> <span class="quoted"><span class="quoted">"Well_order <span class="skolem">Ge'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    Ge'_fld<span class="main">:</span> <span class="quoted"><span class="quoted">"Field <span class="skolem">Ge'</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> total_well_order_extension<span class="main">[</span><span class="operator">OF</span> gt_wf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wfP_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gt'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">gt'</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ge'</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> gt_imp_gt'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="skolem">gt'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt'_def gt_irrefl <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub_Ge'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> gt'_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">gt'</span> <span class="bound">z</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gt'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> gt'_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">gt'</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="skolem">gt'</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">gt'</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ge'_wo
    <span class="keyword1"><span class="command">unfolding</span></span> gt'_def well_order_on_def linear_order_on_def partial_order_on_def preorder_on_def
      trans_def antisym_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ge'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Ge'_wo<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> well_order_on_def set_diff_eq
      case_prod_eta<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">xy</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">xy</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Ge'</span></span></span> <span class="main"><span class="main"><span class="main">∧</span></span></span> <span class="bound"><span class="bound"><span class="bound">xy</span></span></span> <span class="main"><span class="main"><span class="main">∉</span></span></span> Id"</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> pair_in_Id_conv<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ge'</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">≠</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Ge'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> gt'_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="skolem">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_def gt'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> gt'_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="skolem">gt'</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="skolem">gt'</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ge'_wo <span class="keyword1"><span class="command">unfolding</span></span> gt'_def well_order_on_def linear_order_on_def total_on_def Ge'_fld
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">ext</span> <span class="skolem">gt'</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_bounded_if_total gt'_total gt'_irrefl gt'_trans gt'_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_imp_gt'<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic Extension›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lexext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">gt</span> <span class="keyword2"><span class="keyword">where</span></span>
  lexext_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lexext</span> <span class="free">gt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> lexext_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟹</span> <span class="free">lexext</span> <span class="free">gt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> lexext_Cons_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lexext</span> <span class="free">gt</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">lexext</span> <span class="free">gt</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> lexext <span class="free">gt</span> <span class="main">[]</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lexext.cases list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lexext_Nil list.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lexext <span class="free">gt</span> <span class="main">[]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lexext.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> fwdd<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lexext.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> backd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟶</span> lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexext_Cons lexext_Cons_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fwdd backd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_mono_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_map_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
   lexext <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_irrefl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lexext <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_trans_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> zs_trans <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2-4<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> ys_trans <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> gt_trans <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> zzs_gt_yys <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> yys_gt_xs <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> xs<span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> xs<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> yys_gt_xxs <span class="main">=</span> yys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> xs<span class="main">]</span>
        <span class="keyword1"><span class="command">note</span></span> gt_trans <span class="main">=</span> gt_trans<span class="main">[</span><span class="operator">unfolded</span> xs<span class="main">]</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span>
            y_eq_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            zs_gt_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="skolem">zs</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            x_eq_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="skolem">zs</span> <span class="skolem">xs</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zs_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ zs_gt_ys ys_gt_xs<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> gt_trans<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_eq_y y_eq_z<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> zzs_gt_yys yys_gt_xxs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> lexext_compat_cons <span class="main">=</span> lexext_Cons_eq

<span class="keyword1"><span class="command">lemma</span></span> lexext_compat_snoc_if_same_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lexext.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> lexext <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span>
  lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> lexext <span class="free">gt</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lexext_map_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_irrefl_trans_strong <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> lexext_trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_snoc <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_compat_cons <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_compat_list <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> lexext_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_singleton <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> lexext_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_total <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_total<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_hd_or_tl <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> lexext_hd_or_tl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext<span class="main">:</span> ext_wf_bounded <span class="quoted">lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse (Right-to-Left) Lexicographic Extension›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lexext_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lexext_rev</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> lexext <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> lexext_rev <span class="free">gt</span> <span class="main">[]</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_cons_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">∧</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y'</span> <span class="skolem">ys</span> <span class="skolem">x'</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_mono_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexext_mono_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_map_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
   lexext_rev <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexext_map_strong rev_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_irrefl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lexext_rev <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexext_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_trans_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> lexext_trans_strong<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> set_rev<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_compat_cons_if_same_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexext_compat_snoc_if_same_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lexext_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_total<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span>
   lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> lexext_rev <span class="free">gt</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lexext_total<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"rev <span class="free"><span class="free"><span class="free">ys</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"rev <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexext_rev_hd_or_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lexext_rev_cons_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_rev_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lexext_rev_map_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_irrefl_trans_strong <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_rev_irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> lexext_rev_trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_compat_snoc <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_rev_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_compat_list <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_singleton <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_total <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> lexext_rev_total<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_hd_or_tl <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_hd_or_tl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> lexext_rev<span class="main">:</span> ext_wf_bounded <span class="quoted">lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generic Length Extension›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lenext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lenext</span> <span class="free"><span class="bound"><span class="entity">gts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">&gt;</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∨</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">gts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  lenext_mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts'</span> <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> lenext <span class="free">gts'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_map_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> lenext <span class="free">gts</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gts</span> <span class="free">xs</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">¬</span> lenext <span class="free">gts</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gts</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="free">zs</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> lenext <span class="free">gts</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span> lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"lenext <span class="free">gts</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> lenext <span class="free">gts</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> lenext <span class="free">gts</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gts</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"lenext <span class="free">gts</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gts</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> <span class="free">gts</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> lenext <span class="free">gts</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  lenext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">gts</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
    lenext <span class="free">gts</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> lenext <span class="free">gts</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lenext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Length-Lexicographic Extension›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">len_lexext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">len_lexext</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="main">≡</span> lenext <span class="main">(</span>lexext <span class="free"><span class="bound"><span class="entity">gt</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_mono_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lexext_mono_strong<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_map_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
   len_lexext <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_map_strong<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> lexext_map_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> len_lexext <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_irrefl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lexext_irrefl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_trans_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span>
   len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lexext_trans_strong<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lenext_compat_cons lexext_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lenext_compat_snoc lexext_compat_snoc_if_same_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> len_lexext <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lenext_compat_list lexext_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lenext_singleton lexext_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span>
  len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> len_lexext <span class="free">gt</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_total<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lexext_total<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_iff_lenlex<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> lenlex <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> lex <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lenext_def lenlex_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> len_lexext <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wfP_def len_lexext_iff_lenlex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_lenlex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lenext_hd_or_tl lexext_hd_or_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> len_lexext_map_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_irrefl_trans_strong <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> len_lexext_trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_snoc <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_compat_cons <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_compat_snoc <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_compat_list <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_singleton <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_total <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_total<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_wf <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_wf<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_hd_or_tl <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_hd_or_tl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext<span class="main">:</span> ext_wf_bounded <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reverse (Right-to-Left) Length-Lexicographic Extension›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">len_lexext_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">len_lexext_rev</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="main">≡</span> lenext <span class="main">(</span>lexext_rev <span class="free"><span class="bound"><span class="entity">gt</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_mono_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_mono_strong<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_mono_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_map_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
   len_lexext_rev <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_map_strong<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_map_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> len_lexext_rev <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_irrefl<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_trans_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span>
   len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_trans<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> lexext_rev_trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lenext_compat_cons lexext_rev_compat_cons_if_same_length<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lenext_compat_snoc lexext_rev_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lenext_compat_list lexext_rev_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext_rev <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lenext_singleton lexext_rev_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">⟹</span>
  <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">∨</span> len_lexext_rev <span class="free">gt</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lenext_total<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lexext_rev_total<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_iff_len_lexext<span class="main">:</span> <span class="quoted"><span class="quoted">"len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟷</span> len_lexext <span class="free">gt</span> <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lenext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> len_lexext_rev <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> len_lexext_rev_iff_len_lexext
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">xs</span></span></span> <span class="bound"><span class="bound"><span class="bound">ys</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> len_lexext <span class="free"><span class="free"><span class="free">gt</span></span></span> <span class="bound"><span class="bound"><span class="bound">ys</span></span></span> <span class="bound"><span class="bound"><span class="bound">xs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">rev</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_wf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_lexext_rev_hd_or_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"len_lexext_rev <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> len_lexext_rev <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lenext_hd_or_tl lexext_rev_hd_or_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> len_lexext_rev_map_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_irrefl_trans_strong <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> len_lexext_rev_trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_snoc <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_compat_cons <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_compat_snoc <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_compat_list <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_rev_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_singleton <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_rev_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_total <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_total<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_wf <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> len_lexext_rev_wf<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_hd_or_tl <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> len_lexext_rev_hd_or_tl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> len_lexext_rev<span class="main">:</span> ext_wf_bounded <span class="quoted">len_lexext_rev</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dershowitz--Manna Multiset Extension›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msetext_dersh</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msetext_dersh</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">;</span> <span class="bound">M</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="main">∃</span><span class="bound">Y</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="bound">Y</span> <span class="main">⊆#</span> <span class="bound">N</span> <span class="main">∧</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">+</span> <span class="bound">X</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="bound">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following proof is based on that of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] less_multiset<span class="hidden">⇩</span><sub>D</sub><span class="hidden">⇩</span><sub>M</sub>_imp_mult<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_imp_mult_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ys_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_sub_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> mset <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_dersh_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ex_y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_y y_sub_ys xs_eq ys_a xs_a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_listsD mset_subset_eqD set_mset_mset union_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">ys</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span><span class="main">,</span> mset <span class="free">ys</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_nemp y_sub_ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> one_step_implies_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bex_def trans_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_eq y_sub_ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.diff_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_imp_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> msetext_dersh_imp_mult_rel<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_imp_msetext_dersh_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ys_a<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_mult ys_a xs_a <span class="keyword1"><span class="command">unfolding</span></span> mult_def msetext_dersh_def Let_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">Ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ys</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="skolem">y</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">y</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">Ys</span> <span class="skolem">Zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ys_zs_in_mult1 <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> zs_a <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> xs_a <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> Ys_a<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Ys</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_zs_in_mult1 zs_a <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_sub_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> <span class="skolem">Ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> <span class="skolem">Ys</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">OF</span> Ys_a xs_a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">Ya</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Zs</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ys_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ys</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">Ya</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    z_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Ya</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="skolem">z</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_zs_in_mult1<span class="main">[</span><span class="operator">unfolded</span> mult1_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Za</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Xa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> xa_sub_x_ya<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="var">?Xa</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_subset_eq_self in_diffD subsetI subset_mset.diff_diff_right<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> x_a<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_a xs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ya_a<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">Ya</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetI z_gt<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ex_y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Ya</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> y_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trans y_gt_x x_a ya_a x_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> subsetCE union_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">Ya</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Za</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?Xa</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="skolem">Zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mset_subset_eq_mono_add subset_eq_diff_conv y_sub_ys ys_eq zs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> <span class="skolem">Zs</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> xs_eq ys_eq zs_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="skolem">Ya</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">z</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_y' xa_sub_x_ya <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_mono_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
  msetext_dersh <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_subset_eqD mset_subset_eq_add_right set_mset_mset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_map_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    compat_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_sub_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> mset <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_dersh_def Let_def mset_map<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> x_sub_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆#</span> mset <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fY</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fX</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="skolem">X</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def mset_map
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="var">?fY</span> <span class="main">+</span> <span class="var">?fX</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs_eq<span class="main">[</span><span class="operator">THEN</span> arg_cong<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"image_mset <span class="free">f</span>"</span></span><span class="main">]</span> y_sub_ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_Diff image_mset_union<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="skolem">y</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">y</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">fx</span><span class="main">.</span> <span class="bound">fx</span> <span class="main">∈#</span> <span class="var">?fX</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">fy</span><span class="main">.</span> <span class="bound">fy</span> <span class="main">∈#</span> <span class="var">?fY</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">fy</span> <span class="bound">fx</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fx</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fx</span> <span class="main">∈#</span> <span class="var">?fX</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> fx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fx</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> y_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> x_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈#</span> <span class="var">?fY</span> <span class="main">∧</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compat_f y_sub_ys x_sub_xs x_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI in_image_mset mset_subset_eqD set_mset_mset<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">fy</span><span class="main">.</span> <span class="bound">fy</span> <span class="main">∈#</span> <span class="var">?fY</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">fy</span> <span class="skolem">fx</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y_nemp y_sub_ys image_mset_subseteq_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    zs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    xs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    zs_gt_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mult_imp_msetext_dersh_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zs_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Gt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> mult <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> msetext_dersh_imp_mult_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ys_a xs_a ys_gt_xs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">ys</span><span class="main">,</span> mset <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> mult <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> msetext_dersh_imp_mult_rel<span class="main"><span class="main">[</span></span><span class="operator">OF</span> zs_a ys_a zs_gt_ys<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">zs</span><span class="main">)</span> <span class="main">∈</span> mult <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_irrefl_from_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> msetext_dersh <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_sub_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> mset <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">xs</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> x_eq_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_sub_xs xs_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_union_cancelL subset_mset.diff_add<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Gt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Gt</span> <span class="main">⊆</span> set_mset <span class="skolem">Y</span> <span class="main">×</span> set_mset <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> infinite_super<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> irrefl_def <span class="keyword1"><span class="command">using</span></span> irrefl y_sub_xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trans <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">using</span></span> trans y_sub_xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> acyc<span class="main">:</span> <span class="quoted"><span class="quoted">"acyclic <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_irrefl_trans_imp_wf<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> wf_acyclic<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> fin_y<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set_mset <span class="skolem">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_sub_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> cyc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> acyclic <span class="var">?Gt</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_nonempty_ex_succ_imp_cyclic<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?Gt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_y<span class="main">[</span><span class="operator">unfolded</span> x_eq_y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y_nemp<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> acyc cyc <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_compat_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    y_nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_sub_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> mset <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_dersh_def Let_def mset_map<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">⊆#</span> mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> y_sub_ys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_subset_eq_add_left
        subset_mset.add_increasing2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="main">(</span>mset <span class="free">ys</span> <span class="main">-</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute xs_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">+</span> <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_add_single mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_subset_eq_multiset_union_diff_commute
          union_mset_add_mset_right y_sub_ys<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y_nemp ex_y<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> msetext_dersh <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> msetext_dersh_compat_cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">gt</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_compat_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">=</span> mset <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">-</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> y_gt_x<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_dersh_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nonempty_subseteq_mset_eq_singleton <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonempty_subseteq_mset_iff_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_dersh_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> msetext_dersh <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">xs</span></span> <span class="bound"><span class="bound">ys</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">ys</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> mult <span class="main"><span class="main">{</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">gt</span></span> <span class="bound"><span class="bound">y</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="quoted"><span class="quoted">mset</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_gt <span class="keyword1"><span class="command">unfolding</span></span> wfP_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mult<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> msetext_dersh <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span>mset <span class="bound">x</span><span class="main">,</span> mset <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> msetext_dersh_imp_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_dersh_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> msetext_dersh_map_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_trans_before_irrefl <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_dersh_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> msetext_dersh_irrefl_from_trans<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_snoc <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_dersh_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_compat_cons <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_dersh_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_compat_snoc <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_dersh_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_compat_list <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> msetext_dersh_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_singleton <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> msetext_dersh_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_dersh<span class="main">:</span> ext_wf <span class="quoted">msetext_dersh</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_dersh_wf<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Huet--Oppen Multiset Extension›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">msetext_huet</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msetext_huet</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">;</span> <span class="bound">M</span> <span class="main">=</span> mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
     <span class="bound">M</span> <span class="main">≠</span> <span class="bound">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="bound">M</span> <span class="bound">x</span> <span class="main">&gt;</span> count <span class="bound">N</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∧</span> count <span class="bound">N</span> <span class="bound">y</span> <span class="main">&gt;</span> count <span class="bound">M</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_imp_count_gt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> multiset_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_imp_dersh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> huet<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_dersh <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> msetext_dersh_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">-</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="free">ys</span> <span class="main">-</span> mset <span class="free">xs</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> msetext_huet_imp_count_gt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> huet<span class="main"><span class="main">]</span></span> empty_iff in_diff_count set_mset_empty<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">⊆#</span> mset <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span> <span class="main">-</span> <span class="var">?Y</span> <span class="main">+</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute diff_intersect_right_idem multiset_inter_def subset_mset.inf.cobounded2
      subset_mset.le_imp_diff_is_add<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="var">?X</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?Y</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> huet<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_diff_count<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The following proof is based on that of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mult_imp_less_multiset<span class="hidden">⇩</span><sub>H</sub><span class="hidden">⇩</span><sub>O</sub><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_imp_msetext_huet<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"irreflp <span class="free">gt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"transp <span class="free">gt</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    in_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mset <span class="free">xs</span><span class="main">,</span> mset <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> mult <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_mult <span class="keyword1"><span class="command">unfolding</span></span> mult_def msetext_huet_def Let_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">Ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> irrefl <span class="keyword1"><span class="command">unfolding</span></span> irreflp_def msetext_huet_def Let_def mult1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">Ys</span> <span class="skolem">Zs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> asym<span class="main">[</span><span class="operator">unfolded</span> antisym_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"antisymp <span class="free">gt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> irreflp_transp_imp_antisymP<span class="main"><span class="main">[</span></span><span class="operator">OF</span> irrefl trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">≠</span> <span class="skolem">Ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> count <span class="skolem">Ys</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="skolem">Ys</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Zs</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ys</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉#</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="skolem">a</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> irrefl <span class="keyword1"><span class="command">unfolding</span></span> mult1_def irreflp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">≠</span> <span class="skolem">Zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mset <span class="free">xs</span> <span class="main">≠</span> <span class="skolem">Ys</span>›</span></span> ** *<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> irrefl<span class="main">[</span><span class="operator">unfolded</span> irreflp_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def add.comm_neutral count_single diff_union_cancelL lessI
        minus_multiset.rep_eq not_add_less2 plus_multiset.rep_eq union_commute zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">¬</span> count <span class="skolem">Ys</span> <span class="bound">a</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∨</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span>
          count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="skolem">Ys</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"**"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">+</span> <span class="skolem">M0</span> <span class="main">=</span> <span class="skolem">Ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span><span class="main">(</span>2<span class="main">)</span> union_ac<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">aa</span><span class="main">.</span> count <span class="skolem">Zs</span> <span class="bound">aa</span> <span class="main">=</span> count <span class="skolem">M0</span> <span class="bound">aa</span> <span class="main">+</span> count <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="bound">aa</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> count <span class="skolem">Ys</span> <span class="bound">a</span> <span class="main">=</span> count <span class="skolem">K</span> <span class="bound">a</span> <span class="main">+</span> count <span class="skolem">M0</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">K</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"*"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> count_inI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Zs</span> <span class="main">-</span> <span class="skolem">M0</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span><span class="main">(</span>1<span class="main">)</span> add_diff_cancel_left' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">M0</span> <span class="skolem">a</span> <span class="main">&lt;</span> count <span class="skolem">Zs</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_diff_count union_single_eq_member<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> count <span class="bound">m</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> count <span class="bound">m</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> <span class="skolem">Zs</span> <span class="main">∧</span> count <span class="skolem">Zs</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="skolem">K</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> count <span class="skolem">M0</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⟶</span>
          count <span class="skolem">K</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> count <span class="skolem">M0</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="skolem">Zs</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f5 f3 f2 f1 <span class="quoted">"*"</span><span class="main">(</span>4<span class="main">)</span> asym <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisympD<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f6 f5 f4 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">Zs</span> <span class="skolem">a</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉#</span> <span class="skolem">K</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">Ys</span> <span class="skolem">a</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&lt;</span> count <span class="skolem">Ys</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">Ys</span> <span class="skolem">z</span> <span class="main">≤</span> count <span class="skolem">Zs</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> asym
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> count_inI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> antisympD<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="skolem">a</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">z</span> <span class="main">&lt;</span> count <span class="skolem">Zs</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> count_a <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> count_y<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="skolem">Zs</span> <span class="skolem">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">x</span> <span class="skolem">y</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="skolem">Zs</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> count_y count_a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">a</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="skolem">Zs</span> <span class="skolem">a</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> count_a trans<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> transp_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> count_a<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">Zs</span> <span class="skolem">y</span> <span class="main">=</span> count <span class="skolem">Ys</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> count_y ** <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&lt;</span> count <span class="skolem">Ys</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">a</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="skolem">Zs</span> <span class="skolem">a</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> count_a not_le_imp_less trans<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> transp_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉#</span> <span class="skolem">K</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="skolem">Ys</span> <span class="skolem">z</span> <span class="main">≤</span> count <span class="skolem">Zs</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_in_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> msetext_huet_eq_dersh<span class="main">:</span> <span class="quoted"><span class="quoted">"irreflp <span class="free">gt</span> <span class="main">⟹</span> transp <span class="free">gt</span> <span class="main">⟹</span> msetext_dersh <span class="free">gt</span> <span class="main">=</span> msetext_huet <span class="free">gt</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> msetext_huet_imp_dersh msetext_dersh_imp_mult mult_imp_msetext_huet <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_mono_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> msetext_huet <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_le_trans mem_Collect_eq not_le not_less0 set_mset_mset<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> set_mset_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    irrefl_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    compat_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"msetext_huet <span class="main">_</span> <span class="var">?fys</span> <span class="var">?fxs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> irrefl_f compat_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span>
    ms_xs_ne_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">≠</span> mset <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> ex_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="var">?fxs</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> x_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_x xs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_x ex_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> y_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_y ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> wf_gt_f<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_irreflp_transp_imp_wfp<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trans_f<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fin irrefl_f Collect_case_prod_Sigma irreflp_def
           transp_def<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      fyy_gt_fx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">yy</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cnt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      max_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="skolem">yy</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">yy</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⟶</span>
        count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wfP_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_gt_f<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span>
          <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        y_gt_x cnt_y
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compat_f not_less x_in_a y_in_a<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> yy_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_yy ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?fxs</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">yy</span><span class="main">)</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="var">?fys</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">yy</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> fu_eq_fyy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_u<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> count_image_mset_le_imp_lt cnt_yy mset_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> u_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_u xs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v_gt_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">v</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_v<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_u ex_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> v_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_v ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> fv_gt_fu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> v_gt_u compat_f v_in_a u_in_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> fv_gt_fyy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">yy</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fu_eq_fyy<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fv_gt_fyy fyy_gt_fx v_in_a yy_in_a x_in_a trans_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> max_yy<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> fv_gt_fyy v_in_a yy_in_a cnt_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fyy_gt_fx leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len_eq ms_xs_ne_ys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_eq_ex_count_lt size_mset<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mset <span class="var">?fxs</span> <span class="main">≠</span> mset <span class="var">?fys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"mset <span class="var">?fxs</span> <span class="main">≠</span> mset <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map size_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fx</span>
    <span class="keyword3"><span class="command">assume</span></span> cnt_fx<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?fxs</span><span class="main">)</span> <span class="skolem">fx</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="var">?fys</span><span class="main">)</span> <span class="skolem">fx</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> fx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fx</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> count_image_mset_lt_imp_lt mset_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">fy</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">fy</span> <span class="skolem">fx</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="var">?fxs</span><span class="main">)</span> <span class="bound">fy</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="bound">fy</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_y<span class="main">[</span><span class="operator">OF</span> cnt_x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> msetext_huet <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_trans_from_irrefl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    zs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ys_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xs_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    zs_gt_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ys_gt_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> wf_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_irreflp_transp_imp_wfp<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fin irrefl Collect_case_prod_Sigma irreflp_def
         transp_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> msetext_huet_imp_count_gt<span class="main">[</span><span class="operator">OF</span> zs_gt_ys<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> x_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_x zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      cnt_xx<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">xx</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">xx</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      max_xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="skolem">xx</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">xx</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wfP_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_gt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span>
          <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
        cnt_x
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> xx_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_xx zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">≠</span> mset <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">xx</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">xx</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_xx <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">xx</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">xx</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_gt_xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">xx</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_z<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> z_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_z ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> max_xx<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> z_in_a xx_in_a z_gt_xx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u_gt_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_u<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> zs_gt_ys<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> u_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_u zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> u_gt_xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">xx</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> trans u_in_a z_in_a xx_in_a u_gt_z z_gt_xx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> max_xx<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> u_in_a xx_in_a u_gt_xx cnt_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> cnt_x_xz<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> x_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cnt_x_xz xs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span>"</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> cnt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> zs_gt_ys<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> y_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_y zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        yy_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">yy</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        cnt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        max_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="skolem">yy</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">yy</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wfP_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_gt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span>
            <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          y_gt_x cnt_y
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> yy_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_yy zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> yy_gt_x cnt_yy <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_gt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_z<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> z_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_z ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> z_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> trans z_in_a yy_in_a x_in_a z_gt_yy yy_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max_yy<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> z_in_a yy_in_a z_gt_yy z_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u_gt_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_u<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> zs_gt_ys<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> u_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cnt_u zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">have</span></span> u_gt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">yy</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans u_in_a z_in_a yy_in_a u_gt_z z_gt_yy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> u_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans u_in_a z_in_a x_in_a u_gt_z z_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> max_yy<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> u_in_a yy_in_a u_gt_yy u_gt_x cnt_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> z_gt_x cnt_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_x_xz <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> y_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_y ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        yy_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">yy</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        cnt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        max_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="skolem">yy</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">yy</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wfP_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_gt<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span>
            <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          y_gt_x cnt_y
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> yy_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_yy ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">≥</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> yy_gt_x cnt_yy <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">yy</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">yy</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_gt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_z<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&gt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> zs_gt_ys<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> z_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_z zs_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> z_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">z</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> trans z_in_a yy_in_a x_in_a z_gt_yy yy_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max_yy<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> z_in_a yy_in_a z_gt_yy z_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u_gt_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cnt_u<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ys_gt_xs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> u_in_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cnt_u ys_a dual_order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">have</span></span> u_gt_yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">yy</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans u_in_a z_in_a yy_in_a u_gt_z z_gt_yy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> u_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">u</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans u_in_a z_in_a x_in_a u_gt_z z_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> max_yy<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span> u_in_a yy_in_a u_gt_yy u_gt_x cnt_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> z_gt_x cnt_z <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">y</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">zs</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> msetext_huet <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> msetext_huet <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> msetext_huet <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> msetext_huet <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> msetext_huet <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> wfP_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> msetext_dersh_wf<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> msetext_huet_imp_dersh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msetext_huet_hd_or_tl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="bound">x</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    yys_gt_xxs<span class="main">:</span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Ya</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Xa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> Y_ne_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">≠</span> <span class="var">?X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_gt_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> count <span class="var">?X</span> <span class="bound">xa</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ya</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">ya</span> <span class="bound">xa</span> <span class="main">∧</span> count <span class="var">?Y</span> <span class="bound">ya</span> <span class="main">&gt;</span> count <span class="var">?X</span> <span class="bound">ya</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> yys_gt_xxs<span class="main">[</span><span class="operator">unfolded</span> msetext_huet_def Let_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> count <span class="var">?X</span> <span class="bound">xa</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">yy</span> <span class="bound">xa</span><span class="main">)</span> <span class="bound">xa</span> <span class="main">∧</span> count <span class="var">?Y</span> <span class="main">(</span><span class="skolem">yy</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?X</span> <span class="main">(</span><span class="skolem">yy</span> <span class="bound">xa</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_gt_Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> cnt_Y_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="skolem">xa</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Y</span> <span class="skolem">xa</span> <span class="main">&gt;</span> count <span class="var">?X</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xa</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cnt_X_pres<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Xa</span> <span class="skolem">xa</span> <span class="main">&gt;</span> count <span class="var">?Ya</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?X</span> <span class="skolem">xa</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xa</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> y_eq_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Xa</span> <span class="main">≠</span> <span class="var">?Ya</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> y_eq_x Y_ne_X <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xa</span><span class="main">.</span> count <span class="var">?Xa</span> <span class="bound">xa</span> <span class="main">&gt;</span> count <span class="var">?Ya</span> <span class="bound">xa</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ya</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">ya</span> <span class="bound">xa</span> <span class="main">∧</span> count <span class="var">?Ya</span> <span class="bound">ya</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="bound">ya</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> ex_gt_Y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">¬</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∨</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">a</span> <span class="main">∧</span>
          count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">¬</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y_eq_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">as</span> <span class="bound">aa</span><span class="main">.</span> count <span class="main">(</span>mset <span class="main">(</span><span class="main">(</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">#</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="bound">aa</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="bound">as</span><span class="main">)</span> <span class="bound">aa</span> <span class="main">∨</span> <span class="bound">aa</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f4 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">a</span> <span class="skolem">xa</span> <span class="main">∧</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="bound">a</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f3 y_eq_x a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_less_eq count_add_mset mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x_gt_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y_ngt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> y_ne_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?X</span> <span class="skolem">z</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> size_eq_ex_count_lt<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">]</span> size_mset size_mset len_eq Y_ne_X <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> Xa_ne_Ya<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Xa</span> <span class="main">≠</span> <span class="var">?Ya</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y_ngt_x yy z_cnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cnt_Y_pres yy z_cnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Xa</span> <span class="skolem">z</span> <span class="main">&gt;</span> count <span class="var">?Ya</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_cnt cnt_X_pres <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ya</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">ya</span> <span class="skolem">xa</span> <span class="main">∧</span> count <span class="var">?Ya</span> <span class="bound">ya</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="bound">ya</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> xa_cnta<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Xa</span> <span class="skolem">xa</span> <span class="main">&gt;</span> count <span class="var">?Ya</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xa</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> xa_eq_y<span class="main">:</span> True

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="free">x</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">x</span> <span class="skolem">xa</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> xa_eq_y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> x_gt_y<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Xa</span> <span class="free">x</span> <span class="main">≥</span> count <span class="var">?Ya</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> x_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?X</span> <span class="free">x</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_ne_x<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> yyx_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yyx_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Y</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?X</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> yy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">have</span></span> yyx_ne_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> y_ngt_x yyx_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> xa_eq_y <span class="keyword1"><span class="command">using</span></span> trans yyx_gt_x x_gt_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_Y_pres yyx_cnt yyx_ne_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> xa_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?X</span> <span class="skolem">xa</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="skolem">xa</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> xa_cnta <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> count <span class="var">?Ya</span> <span class="free">y</span> <span class="main">≤</span> count <span class="var">?Xa</span> <span class="free">y</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> yyxa_ne_y_or<span class="main">:</span> False

        <span class="keyword1"><span class="command">have</span></span> yyxa_gt_xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">xa</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yyxa_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Y</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?X</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> yy<span class="main">[</span><span class="operator">OF</span> xa_cnt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">xa</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="main">(</span><span class="skolem">yy</span> <span class="skolem">xa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> cnt_Y_pres yyxa_cnt yyxa_ne_y_or <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> yyxa_gt_xa <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">note</span></span> yyxa_eq_y <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> y_cnt <span class="main">=</span> this<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="free">x</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">x</span> <span class="skolem">xa</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans x_gt_y xa_cnt yy yyxa_eq_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Xa</span> <span class="free">x</span> <span class="main">≥</span> count <span class="var">?Ya</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> x_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?X</span> <span class="free">x</span> <span class="main">&gt;</span> count <span class="var">?Y</span> <span class="free">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_ne_x<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> yyx_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yyx_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="var">?Y</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?X</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> yy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

          <span class="keyword1"><span class="command">have</span></span> yyx_ne_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> y_ngt_x yyx_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trans x_gt_y xa_cnt yy yyx_gt_x yyxa_eq_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="var">?Ya</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> count <span class="var">?Xa</span> <span class="main">(</span><span class="skolem">yy</span> <span class="free">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cnt_Y_pres yyx_cnt yyx_ne_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"msetext_huet <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> msetext_huet_def Let_def <span class="keyword1"><span class="command">using</span></span> Xa_ne_Ya <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> msetext_huet_map<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_irrefl_before_trans <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> msetext_huet_trans_from_irrefl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_snoc <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_compat_cons <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_compat_snoc <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_compat_list <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_singleton <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_wf <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> msetext_huet_wf<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_hd_or_tl <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> msetext_huet_hd_or_tl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> msetext_huet<span class="main">:</span> ext_wf_bounded <span class="quoted">msetext_huet</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Componentwise Extension›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cwiseext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cwiseext</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_imp_len_lexext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cw<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"len_lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cw<span class="main">[</span><span class="operator">unfolded</span> cwiseext_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      j_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      j_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cw<span class="main">[</span><span class="operator">unfolded</span> cwiseext_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j0</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      j0_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j0</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      j0_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="skolem">j0</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="skolem">j0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      j0_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j0</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_eq_minimal<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> wf_less<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">,</span>
        <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> j_gt<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_trans nat_neq_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> j0_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j0</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cw<span class="main">[</span><span class="operator">unfolded</span> cwiseext_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> j0_len j0_min less_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span>drop <span class="skolem">j0</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j0</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lexext_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">gt</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">j0</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="skolem">j0</span><span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> j0_gt<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc j0_len len_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> cw len_eq j0_len j0_min
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j0</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> ih0 <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> gts_dropSk <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> cw <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> len_eq <span class="main">=</span> this<span class="main">(</span>4<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
        Sk_len <span class="main">=</span> this<span class="main">(</span>5<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> Sk_min <span class="main">=</span> this<span class="main">(</span>6<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> Sk_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cw<span class="main">[</span><span class="operator">unfolded</span> cwiseext_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sk_len Sk_min less_trans<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> k_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Sk_len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> k_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Sk_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> k_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Sk_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> ih0<span class="main">[</span><span class="operator">OF</span> _ cw len_eq k_len k_min<span class="main">]</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">ys</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> k_lt_ys<span class="main">:</span> True
        <span class="keyword1"><span class="command">note</span></span> k_lt_xs <span class="main">=</span> k_lt_ys<span class="main">[</span><span class="operator">unfolded</span> len_eq<span class="main">]</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Sk_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">have</span></span> dropk_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">k</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_lt_xs x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> dropk_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">k</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_lt_ys y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc<span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> dropk_xs dropk_ys<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lexext_Cons_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gts_dropSk<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">k</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">k</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gts_dropSk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lexext <span class="free">gt</span> <span class="main">(</span>drop <span class="skolem">k</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lenext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_mono_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt'</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> cwiseext <span class="free">gt'</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_map_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span>
   cwiseext <span class="free">gt</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">gt</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> cwiseext <span class="free">gt</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_mem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_trans_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">gt</span> <span class="bound">z</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> nth_mem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> cwiseext <span class="free">gt</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> cwiseext <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span>
    <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_append_singleton less_Suc_eq nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_compat_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> y_gt_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">∨</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons' nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_gt_x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' append_is_Nil_conv diff_less length_append
      length_greater_0_conv list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_append_length<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">⟷</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">gt</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> cwiseext <span class="free">gt</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cwiseext_imp_len_lexext wfP_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> len_lexext_wf<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cwiseext_hd_or_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span> <span class="main">∨</span> cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> disj_imp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gt</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def diff_le_self diff_less dual_order.strict_trans2
      length_Cons less_Suc_eq linorder_neqE_nat not_less0 nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> ext_cwiseext <span class="main">=</span> ext_compat_list <span class="main">+</span> ext_compat_cons
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">gt</span> <span class="free">x</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    trans_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="free">zs</span> <span class="free">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ys_gtcw_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="free">ys</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ys_gtcw_xs<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cwiseext_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ys_gtcw_xs
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> len_ys_eq_xs <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ih <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> yys_gtcw_xxs <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> xys_gts_xxs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> ys_ne_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> ys_gtcw_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"cwiseext <span class="free">gt</span> <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> yys_gtcw_xxs <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ys</span><span class="main">.</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ys_ne_xs len_ys_eq_xs nth_equalityI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compat_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> yys_gtcw_xxs <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> y_eq_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> y_eq_x gt_irrefl yys_gtcw_xxs <span class="keyword1"><span class="command">unfolding</span></span> cwiseext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> y_eq_x xys_gts_xxs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> yys_gts_xys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="free">gt</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> compat_list<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">gt</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> ys_eq_xs<span class="main">:</span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> yys_gts_xys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> yys_gts_xys xys_gts_xxs trans_gt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> cwiseext_mono_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cwiseext_map_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> in_listsD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_irrefl_trans_strong <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> cwiseext_irrefl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> cwiseext_trans_strong<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_compat_cons <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> cwiseext_compat_cons<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_compat_snoc <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">fact</span> cwiseext_compat_snoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_compat_list <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> cwiseext_compat_list<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_singleton <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> cwiseext_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_wf <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> cwiseext_wf<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_hd_or_tl <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> cwiseext_hd_or_tl<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> cwiseext<span class="main">:</span> ext_wf_bounded <span class="quoted">cwiseext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_RPO_App">
<div class="head">
<h1>Theory Lambda_Free_RPO_App</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Applicative Recursive Path Order for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Applicative Recursive Path Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_RPO_App
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_Term.html">Lambda_Free_Term</a> <a href="Extension_Orders.html">Extension_Orders</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"&gt;t"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥t"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>t</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the applicative recursive path order (RPO), a variant of RPO
for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms. It corresponds to the order obtained by
applying the standard first-order RPO on the applicative encoding of higher-order
terms and assigning the lowest precedence to the application symbol.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> rpo_app <span class="main">=</span> gt_sym <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    ext_ext_trans_before_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_trans_before_irrefl <span class="free">ext</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ext_ext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list <span class="free">ext</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ext_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> <span class="free">ext</span> <span class="free">gt</span> <span class="main">≤</span> <span class="free">ext</span> <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ext.mono ext_ext_compat_list<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ext_compat_list_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="main">(</span>fun <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> fun <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_sym_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> gt_sym_app<span class="main">:</span> <span class="quoted"><span class="quoted">"Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⟹</span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span> Hd <span class="main">(</span>Sym <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> App <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span>"</span></span>
<span class="main">|</span> gt_app_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ext</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">]</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">]</span> <span class="main">⟹</span> App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">⟹</span> App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">⟹</span>
    App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> App <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_RPO_Std">
<div class="head">
<h1>Theory Lambda_Free_RPO_Std</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Graceful Recursive Path Order for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Uwe Waldmann &lt;waldmann at mpi-inf.mpg.de&gt;, 2016
    Author:      Daniel Wand &lt;dwand at mpi-inf.mpg.de&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Graceful Recursive Path Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_RPO_Std
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_Term.html">Lambda_Free_Term</a> <a href="Extension_Orders.html">Extension_Orders</a> <a href="../Nested_Multisets_Ordinals/Multiset_More.html">Nested_Multisets_Ordinals.Multiset_More</a>
<span class="keyword2"><span class="keyword">abbrevs</span></span> <span class="quoted">"&gt;t"</span> <span class="main">=</span> <span class="quoted">"&gt;<span class="hidden">⇩</span><sub>t</sub>"</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"≥t"</span> <span class="main">=</span> <span class="quoted">"≥<span class="hidden">⇩</span><sub>t</sub>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the graceful recursive path order (RPO) for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free
higher-order terms.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>

<span class="keyword1"><span class="command">locale</span></span> rpo_basis <span class="main">=</span> ground_heads <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span>"</span></span> <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span>
    <span class="keyword2"><span class="keyword">for</span></span>
      <span class="free">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>s</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">extf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    extf_ext_trans_before_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_trans_before_irrefl <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_compat_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_cons <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    extf_ext_compat_list<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_compat_list <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_trans <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_trans_before_irrefl.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_trans_before_irrefl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> extf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"ext <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_trans.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_ext_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_mono_strong <span class="main">=</span> ext.mono_strong<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_mono <span class="main">=</span> ext.mono<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">,</span> <span class="operator">mono</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_map <span class="main">=</span> ext.map<span class="main">[</span><span class="operator">OF</span> extf_ext<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_trans <span class="main">=</span> ext_trans.trans<span class="main">[</span><span class="operator">OF</span> extf_ext_trans<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_irrefl_from_trans <span class="main">=</span>
  ext_trans_before_irrefl.irrefl_from_trans<span class="main">[</span><span class="operator">OF</span> extf_ext_trans_before_irrefl<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_append_left <span class="main">=</span> ext_compat_cons.compat_append_left<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_cons<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> extf_compat_list <span class="main">=</span> ext_compat_list.compat_list<span class="main">[</span><span class="operator">OF</span> extf_ext_compat_list<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chkvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chkvar</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> vars_hd <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⊆</span> vars <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rpo <span class="main">=</span> rpo_basis _ _ <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>
    <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inductive Definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">chksubs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chksubs</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> App <span class="bound">s1</span> <span class="bound">s2</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">s1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">s2</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chksubs_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> chksubs <span class="free">gt</span> <span class="main">≤</span> chksubs <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tm.case_eq_if<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="main">(</span>fun <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> fun <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkvar <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chksubs <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_same<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chksubs <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_subI<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> fun <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> arg <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_sub</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_diffI<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkvar <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">gt_diff</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_sameI<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">gt_same</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_iff_sub_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟷</span> gt_sub <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_diff <span class="free">t</span> <span class="free">s</span> <span class="main">∨</span> gt_same <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> gt.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_sub.simps gt_diff.simps gt_same.simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_fun_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"fun <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_arg_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">+</span></span> size <span class="bound"><span class="bound">s</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> vars <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⊇</span></span> vars <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> size <span class="bound">ta</span> <span class="main">+</span> size <span class="bound">sa</span> <span class="main">&lt;</span> size <span class="skolem">t</span> <span class="main">+</span> size <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> vars <span class="bound">ta</span> <span class="main">⊇</span> vars <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">t</span> <span class="main">⊇</span> vars <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_sub
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_less_cancel_right subsetD size_arg_lt size_fun_lt subsetI tm.set_sel<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Hd
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> hd.set_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff<span class="main">(</span>3<span class="main">)</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s1</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Hd
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same<span class="main">(</span>1<span class="main">)</span> vars_head_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same<span class="main">(</span>2<span class="main">)</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s1</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ua</span><span class="main">,</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span>
      <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> chkvar<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="skolem">u</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">meson</span> u_gt_t t_gt_s gt_imp_vars hd.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vars_head_subseteq subsetCE<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> chk_u_s_if<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> chk_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chk_t_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s1</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ u_gt_t<span class="main"><span class="main">]</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s2</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ u_gt_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span>
    fun_u_lt_etc<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span> <span class="main">⟹</span> <span class="main">{#</span>size <span class="main">(</span>fun <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    arg_u_lt_etc<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span> <span class="main">⟹</span> <span class="main">{#</span>size <span class="main">(</span>arg <span class="skolem">u</span><span class="main">)</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_fun_lt size_arg_lt<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> u_gt_s_if_ui<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="skolem">u</span> <span class="main">⟹</span> fun <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∨</span> arg <span class="skolem">u</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">OF</span> fun_u_lt_etc<span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">OF</span> arg_u_lt_etc<span class="main">]</span> gt_arg_imp
      gt_fun_imp t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_sub_t_s<span class="main">:</span> gt_sub

    <span class="keyword1"><span class="command">have</span></span> u_gt_s_if_chk_u_t<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> chk_u_t<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sub_t_s<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> <span class="main">(</span>App <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">t2</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_sub_t_s<span class="main">(</span>2<span class="main">)</span> chk_u_t <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_gt_s_if_ui u_gt_s_if_chk_u_t<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>1<span class="main">)</span> gt_diff_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_hd_trans<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>1<span class="main">)</span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_gt_s_if_ui<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_same_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> hd_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gt_trans_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ua</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟶</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟶</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">ta</span> <span class="skolem">ua</span>
        <span class="keyword3"><span class="command">assume</span></span>
          ua_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ua_gt_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gt_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_lt_imp_lt_mset ua_gt_ta ta_gt_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">meson</span> ua_in ta_in sa_in Un_iff max.strict_coboundedI1 max.strict_coboundedI2
               size_in_args<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ gt_trans_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_grounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_grounds gt_same_u_t<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_grounds gt_same_t_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_u_s chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_same_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_gt_s_if_ui<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Irreflexivity›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_irrefl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">size</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> s_gt_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> s_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> gt_sub
    <span class="keyword1"><span class="command">note</span></span> is_app <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> si_ge_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s_gt_fun_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> fun <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_gt_arg_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_app <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_sub<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span> <span class="main">∨</span> arg <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> si_ge_s is_app s_gt_arg_s s_gt_fun_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> fun_s_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> fun <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fun_s_gt_s s_gt_fun_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">s</span>"</span></span><span class="main">]</span> is_app size_fun_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> arg_s_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_s_gt_s s_gt_arg_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">s</span>"</span></span><span class="main">]</span> is_app size_arg_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_hd_irrefl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword1"><span class="command">note</span></span> in_grounds <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> si_in_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> si_gt_si<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">si</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_grounds
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> all_not_in_conv extf_irrefl_from_trans ground_heads_nonempty gt_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">si</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> size_in_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> si_in_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ si_gt_si<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gt_irrefl gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subterm Property›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  gt_sub_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  gt_sub_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> gt_proper_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_sub <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub_fun gt_sub_arg gt_trans<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Functions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_compat_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t'_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> t'_ne_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≠</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_antisym t'_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> extf_args_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free">s</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extf_compat_list t'_gt_t t'_ne_t<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_sub gt_sub_fun t'_gt_t <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extf_args_single<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_compat_fun_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t'_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t'</span> <span class="main">#</span> <span class="free">us</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> apps <span class="free">s</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">us</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">us</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> t'_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gt_compat_fun<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ih <span class="main">=</span> snoc

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t'</span> <span class="main">#</span> <span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"apps <span class="free">s</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?v'</span> <span class="var">?v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_sub gt_sub_arg<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="var">?v'</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="var">?v'</span><span class="main">)</span> <span class="main">(</span>args <span class="var">?v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> args_apps extf_compat_list gt_irrefl t'_gt_t<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compatibility with Arguments›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_diff_same_compat_arg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    extf_compat_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_compat_snoc <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_diff <span class="free">s'</span> <span class="free">s</span> <span class="main">∨</span> gt_same <span class="free">s'</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s'</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> App <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s'</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sub_fun gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s'</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gt_sub_arg<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> chk_s't_st <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> diff_same
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gt_diff <span class="free">s'</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      s'_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      hd_s'_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      chkvar_s'_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="free">s'</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      chk_s'_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free">s'</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_diff.cases <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_iff_sub_diff_same<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> chkvar_s't_st<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chkvar_s'_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar_s't_st chk_s't_st<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s'_gt_s<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s'_gt_s<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gt_same <span class="free">s'</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
      s'_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      hd_s'_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free">s'</span> <span class="main">=</span> head <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      chk_s'_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free">s'</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      gts_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free">s'</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="free">s'</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_same.cases <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_iff_sub_diff_same<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> gts_args_t<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s'</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>App <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gts_args ext_compat_snoc.compat_append_right<span class="main">[</span><span class="operator">OF</span> extf_compat_snoc<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chk_s't_st<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s'_gt_s<span class="main"><span class="main">]</span></span> gts_args_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_s'_eq_s<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stability under Substitution›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_chksubs_gt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_App <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> fun <span class="free">s</span> <span class="main">∧</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> arg <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> gt_sub gt_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tm.case_eq_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wary_ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"wary_subst <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> subst <span class="free">ρ</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> subst <span class="free"><span class="free">ρ</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span>
      subst <span class="free">ρ</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> chk_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ζ</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> ζ<span class="main">:</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> psub_x_t<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_sub <span class="main">(</span>Hd <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ζ s t_gt_s gt_imp_vars gt_irrefl in_vars_imp_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ζ s
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_imp_chksubs_gt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_proper_sub<span class="main"><span class="main">[</span></span><span class="operator">OF</span> proper_sub_subst<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> psub_x_t<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> s chk_t_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s1</span></span><span class="main"><span class="main">]</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> chk_ρt_ρs_if <span class="main">=</span> this

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">ρ</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_sub_t_s<span class="main">:</span> gt_sub
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sub_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sub ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t2</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_sub_t_s<span class="main">(</span>2<span class="main">)</span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> wary_subst_ground_heads gt_diff_t_s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gt_hd_def subsetCE wary_ρ<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chkvar <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> chkvar_def <span class="keyword1"><span class="command">using</span></span> vars_subst_subseteq<span class="main">[</span><span class="operator">OF</span> gt_imp_vars<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t_gt_s<span class="main"><span class="main">]</span></span><span class="main">]</span> vars_head_subseteq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ chk_ρt_ρs_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same

    <span class="keyword1"><span class="command">have</span></span> hd_ρt_eq_ρs<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> f_in_grounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> extf_args_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same_t_s<span class="main">(</span>3<span class="main">)</span> f_in_grounds wary_ρ wary_subst_ground_heads <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subst <span class="free">ρ</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> extf_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?S</span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ _ _ _ extf_args_s_t<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> sz_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_lt_imp_lt_mset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> size_in_args<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟶</span> subst <span class="free">ρ</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> subst <span class="free">ρ</span> <span class="bound">sa</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih sz_a size_in_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gt_irrefl <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gt_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_same_t_s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extf_compat_append_left<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span>subst <span class="free">ρ</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_ρt_eq_ρs chk_ρt_ρs_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_same_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Totality on Ground Terms›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_total_ground<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_total <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ground <span class="free">t</span> <span class="main">⟹</span> ground <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">∨</span> <span class="free">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∨</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">#}</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> ground <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> ground <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">s</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∨</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span> <span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span> <span class="main">#}</span> <span class="main">⟹</span> ground <span class="bound">ta</span> <span class="main">⟹</span> ground <span class="bound">sa</span> <span class="main">⟹</span>
      <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">∨</span> <span class="bound">sa</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">∨</span> <span class="bound">ta</span> <span class="main">=</span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">∨</span> <span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> chksubs_def tm.case_eq_if <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"fun <span class="skolem">s</span>"</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"arg <span class="skolem">s</span>"</span></span><span class="main">]</span> mset_lt_single_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_right_lt gr_s gr_t ground_arg ground_fun gt_sub size_arg_lt size_fun_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> chksubs_def tm.case_eq_if <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"arg <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_mset_lt_left_lt gr_s gr_t ground_arg ground_fun gt_sub size_arg_lt size_fun_lt<span class="main">)</span>  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      chksubs_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      chksubs_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> Sym <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gr_t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gr_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ground_head hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> chkvar_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> chkvar_s_t<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_gt_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar_t_s chksubs_t_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g f gt_sym_imp_hd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g_gt_f<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> f_gt_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar_s_t chksubs_s_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g f gt_sym_imp_hd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f_gt_g<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> g_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> hd_t<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> g f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"args <span class="skolem">s</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gr_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> set <span class="var">?ts</span><span class="main">.</span> ground <span class="bound">ta</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ground_args<span class="main">[</span><span class="operator">OF</span> _ gr_t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> gr_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> set <span class="var">?ss</span><span class="main">.</span> ground <span class="bound">sa</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ground_args<span class="main">[</span><span class="operator">OF</span> _ gr_s<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ts_eq_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ts</span> <span class="main">=</span> <span class="var">?ss</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hd_t ts_eq_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tm_expand_apps<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ts_gt_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ts</span> <span class="var">?ss</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_t chksubs_t_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g ts_gt_ss<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ss_gt_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">g</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="var">?ss</span> <span class="var">?ts</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_t<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> chksubs_s_t<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f<span class="main"><span class="main">[</span></span><span class="operator">folded</span> g_eq_f<span class="main"><span class="main">]</span></span> ss_gt_ts<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ih gr_ss gr_ts
          ext_total.total<span class="main">[</span><span class="operator">OF</span> extf_total<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="var">?ts</span> <span class="main">∪</span> set <span class="var">?ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="var"><span class="quoted"><span class="var">?ss</span></span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff in_listsI less_multiset_doubletons size_in_args<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-foundedness›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gtg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_wf <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ground_wfP<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"worst_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> size <span class="bound">t</span> <span class="main">&gt;</span> size <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U_of</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> is_App <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span>fun <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>

    <span class="keyword1"><span class="command">note</span></span> wf_sz <span class="main">=</span> wf_app<span class="main">[</span><span class="operator">OF</span> wellorder_class.wf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">size</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?U_of</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> ground <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> worst_chain_bad<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">,</span> <span class="operator">unfolded</span> inf_chain_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> gr_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> ground <span class="main">(</span>fun <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ground_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gr<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gr_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> ground <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ground_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ gr<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> gr_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> ground <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gr_args<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> empty_iff gr_fun<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> u_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ti</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span>"</span></span>

      <span class="keyword3"><span class="command">assume</span></span> u_bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> sz_u<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">u</span> <span class="main">&lt;</span> size <span class="var">?ti</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Hd
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> u_in size_in_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> App
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> u_in size_in_args insert_iff size_fun_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> sz_u min_worst_chain_0<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Suc
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> u_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> u_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> ffi_ne_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> sz_u <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> sub <span class="skolem">u</span> <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="var">?ff</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> u_in gt_sub sub_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">u</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ffi_ne_u u_in gt_proper_sub sub_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_trans<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> Suc sz_u min_worst_chain_Suc<span class="main">[</span><span class="operator">OF</span> wf_sz u_bad<span class="main">]</span> gr <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> u_good<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> <span class="main">¬</span> bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="bound">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> bad_diff_same<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="var">?ff</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ground <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gr<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span> <span class="skolem">i</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> worst_chain_pred<span class="main">[</span><span class="operator">OF</span> wf_sz t_bad<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> gt_sub <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_sub <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> fi_app<span class="main">:</span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          fun_or_arg_fi_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"fun <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> arg <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> gt_sub.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">using</span></span> fi_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"arg <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">using</span></span> fi_app arg_in_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">uij</span></span> <span class="keyword2"><span class="keyword">where</span></span> uij_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">uij</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uij_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">uij</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">using</span></span> fun_or_arg_fi_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">n</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> worst_chain_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_sz t_bad<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> uij_gt_i_plus_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">uij</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_trans uij_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">uij</span> <span class="keyword1">else</span> <span class="var">?ff</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gr gr_u<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uij_in<span class="main"><span class="main">]</span></span> uij_gt_i_plus_3 worst_chain_pred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_sz t_bad<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bad <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span> <span class="skolem">uij</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> bad_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> u_good<span class="main">[</span><span class="operator">OF</span> uij_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"gt_diff <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> gt_same <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt <span class="keyword1"><span class="command">unfolding</span></span> gt_iff_sub_diff_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gt_sym_wf <span class="keyword1"><span class="command">unfolding</span></span> wfP_def wf_iff_no_infinite_down_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">s</span> <span class="main">∧</span> ground <span class="bound">t</span> <span class="main">∧</span> sym <span class="main">(</span>head <span class="bound">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span>
      <span class="keyword3"><span class="command">assume</span></span> gr_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt_diff_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"gt_diff <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> gr_s<span class="main">:</span> <span class="quoted"><span class="quoted">"ground <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_iff_sub_diff_same gt_imp_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>s</sub></span></span> sym <span class="main">(</span>head <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s ground_head<span class="main">[</span><span class="operator">OF</span> gr_s<span class="main">]</span> ground_head<span class="main">[</span><span class="operator">OF</span> gr_t<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_hd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wf_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_O_same<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="keyword1">O</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>
      <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gt_diff.simps gt_same.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> chksubs_def empty_subsetI gt_diff<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> chkvar_def<span class="main"><span class="main">]</span></span> gt_imp_chksubs_gt
        gt_same gt_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> diff_same_as_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span>gt_diff <span class="bound">t</span> <span class="bound">s</span> <span class="main">∨</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_diff <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> bad_same<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> ground <span class="bound">t</span> <span class="main">∧</span> gt_same <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_infinite_down_chain_compatible<span class="main">[</span><span class="operator">OF</span> wf_diff _ diff_O_same<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span><span class="main">]</span> bad_diff_same
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def diff_same_as_union<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> hd_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> is_Sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_head<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sym <span class="main">(</span>head <span class="main">(</span><span class="var">?ff</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> hd_eq_f<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sym <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def hd.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_sym<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ia</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_same <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gtu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">∈</span> <span class="var">?U_of</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">unfolding</span></span> U_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_App <span class="main">(</span><span class="var">?ff</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> neq_iff size_in_args sub.cases sub_args tm.discI<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bad_same hd_eq_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def gt_same.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> extf_mono_strong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"inf_chain <span class="main">(</span><span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> args <span class="main">(</span><span class="var">?ff</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> nwf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> gtu_le_gtg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gtu</span> <span class="main">≤</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub>)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gr_u<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?gtu</span> <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wfP_iff_no_inf_chain
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> bad_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inf_chain <span class="var">?gtu</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> bad_f0<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?gtu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inf_chain_bad<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bad_f <span class="keyword1"><span class="command">unfolding</span></span> inf_chain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> good_f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bad <span class="var">?gtu</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u_good bad_f inf_chain_bad inf_chain_subset<span class="main">[</span><span class="operator">OF</span> _ gtu_le_gtg<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> bad_f0 good_f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">sat</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> wf_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">extf</span> <span class="skolem">f</span> <span class="var">?gtu</span> <span class="bound">ys</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext_wf.wf<span class="main"><span class="main">[</span></span><span class="operator">OF</span> extf_wf<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> nwf_ext wf_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subst grounding_ρ"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>g</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfP_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ground_wfP<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wfP <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?subst</span> <span class="bound">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?subst</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ground_grounding_ρ<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wfP_subset gt_subst<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wary_grounding_ρ<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_RPO_Optim">
<div class="head">
<h1>Theory Lambda_Free_RPO_Optim</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Optimized Graceful Recursive Path Order for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Optimized Graceful Recursive Path Order for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_RPO_Optim
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_RPO_Std.html">Lambda_Free_RPO_Std</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines the optimized variant of the graceful recursive path order
(RPO) for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup›</span></span>

<span class="keyword1"><span class="command">locale</span></span> rpo_optim <span class="main">=</span> rpo_basis _ _ <span class="quoted"><span class="free">arity_sym</span></span> <span class="quoted"><span class="free">arity_var</span></span>
    <span class="keyword2"><span class="keyword">for</span></span>
      <span class="free">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="free">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> enat"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_ext_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"ext_snoc <span class="main">(</span><span class="free">extf</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> extf_snoc <span class="main">=</span> ext_snoc.snoc<span class="main">[</span><span class="operator">OF</span> extf_ext_snoc<span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the Order›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">chkargs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chkargs</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s'</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">gt</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chkargs_mono<span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gt</span> <span class="main">≤</span> <span class="free">gt'</span> <span class="main">⟹</span> chkargs <span class="free">gt</span> <span class="main">≤</span> chkargs <span class="free">gt'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">gt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  gt_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkvar <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkargs <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> gt_same<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> chkargs <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>args <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1"><span class="free">≥<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transitivity›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_in_args_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ti</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ti</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_arg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gt_imp_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> vars <span class="free">t</span> <span class="main">⊇</span> vars <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">+</span></span> size <span class="bound"><span class="bound">s</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> vars <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⊇</span></span> vars <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> size <span class="bound">ta</span> <span class="main">+</span> size <span class="bound">sa</span> <span class="main">&lt;</span> size <span class="skolem">t</span> <span class="main">+</span> size <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> vars <span class="bound">ta</span> <span class="main">⊇</span> vars <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">t</span> <span class="main">⊇</span> vars <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gt_arg <span class="skolem">ti</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ti</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> size_in_args vars_args_subseteq add_mono_thms_linordered_field<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Hd
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> hd.set_cases<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff ih
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.assoc gt.simps<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> chkargs_def chkvar_def<span class="main"><span class="main">]</span></span> less_add_Suc1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tm_exhaust_apps<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> s<span class="main">:</span> <span class="main">(</span>apps <span class="skolem">ζ</span> <span class="skolem">ss</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same <span class="keyword1"><span class="command">unfolding</span></span> chkargs_def s
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> vars_head_subseteq<span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> insert_absorb insert_subset nat_add_left_cancel_less s size_in_args
            tm_collapse_apps tm_inject_apps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atomize_imp<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">{#</span></span>size <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> size <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">#}</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="bound"><span class="bound">u</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">u</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case atomize_imp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">t</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span>
    ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ua</span> <span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> <span class="main">{#</span>size <span class="bound">ua</span><span class="main">,</span> size <span class="bound">ta</span><span class="main">,</span> size <span class="bound">sa</span><span class="main">#}</span> <span class="main">&lt;</span> <span class="main">{#</span>size <span class="skolem">u</span><span class="main">,</span> size <span class="skolem">t</span><span class="main">,</span> size <span class="skolem">s</span><span class="main">#}</span> <span class="main">⟹</span>
      <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟹</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    u_gt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> chkvar<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="skolem">u</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">meson</span> u_gt_t t_gt_s gt_imp_vars hd.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vars_head_subseteq subsetCE<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> chk_u_s_if<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> chk_t_s<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> chkargs_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chk_t_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ u_gt_t<span class="main"><span class="main">]</span></span> size_in_args<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> u_gt_s_if_ui<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ui</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> ui_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ui</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ui</span>
    <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ui</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> size_in_args<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ui_in<span class="main"><span class="main">]</span></span> _ t_gt_s<span class="main">]</span>
      gt_in_args_imp<span class="main">[</span><span class="operator">OF</span> ui_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> t_gt_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gt_s
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> gt_arg_t_s<span class="main">:</span> <span class="main">(</span>gt_arg <span class="skolem">ti</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> u_gt_s_if_chk_u_t<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> chk_u_t<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">u</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">ti</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> gt_arg_t_s chk_u_t size_in_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_gt_s_if_ui u_gt_s_if_chk_u_t<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_diff_t_s<span class="main">:</span> gt_diff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>1<span class="main">)</span> gt_diff_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gt_hd_trans<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_t_s<span class="main">(</span>1<span class="main">)</span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_diff_t_s<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_gt_s_if_ui<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gt_same_t_s<span class="main">:</span> gt_same
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> u_gt_t
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff_u_t<span class="main">:</span> gt_diff
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_diff_u_t<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ chkvar chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_same_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same_u_t<span class="main">:</span> gt_same
      <span class="keyword1"><span class="command">have</span></span> hd_u_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">u</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> gt_same_t_s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> gt_trans_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ua</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ta</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">sa</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">ta</span> <span class="main">⟶</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟶</span> <span class="bound">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sa</span> <span class="skolem">ta</span> <span class="skolem">ua</span>
        <span class="keyword3"><span class="command">assume</span></span>
          ua_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          ua_gt_ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ta</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gt_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ua</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ih<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_lt_imp_lt_mset ua_gt_ta ta_gt_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">meson</span> ua_in ta_in sa_in Un_iff max.strict_coboundedI1 max.strict_coboundedI2
               size_in_args<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ gt_trans_args<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_grounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_grounds gt_same_u_t<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_grounds gt_same_t_s<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> gt_same_u_t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_u_s chk_u_s_if<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gt_same_t_s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> u_gt_s_if_ui<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gt_sub_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extf_snoc gt_arg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"App <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conditional Equivalence with Unoptimized Version›</span></span>

<span class="keyword1"><span class="command">context</span></span> rpo
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> extf_ext_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> ext_snoc <span class="main">(</span><span class="free">extf</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rpo_optim<span class="main">:</span> <span class="quoted"><span class="quoted">"rpo_optim <span class="free">ground_heads_var</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span> <span class="free">extf</span> <span class="free">arity_sym</span> <span class="free">arity_var</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rpo_optim_def rpo_optim_axioms_def <span class="keyword1"><span class="command">using</span></span> rpo_basis_axioms extf_ext_snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">chkargs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chkargs</span> <span class="main">≡</span> rpo_optim.chkargs"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gt_optim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span></span> <span class="main">≡</span> rpo_optim.gt <span class="free">ground_heads_var</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span> <span class="free">extf</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ge_optim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">(≥<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span></span> <span class="main">≡</span> rpo_optim.ge <span class="free">ground_heads_var</span> <span class="keyword1"><span class="free">(&gt;<span class="hidden">⇩</span><sub>s</sub>)</span></span> <span class="free">extf</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gt_iff_optim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> size <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">+</span></span> size <span class="bound"><span class="bound">s</span></span>"</span></span></span>
      <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">⟷</span></span> <span class="bound"><span class="bound">t</span></span> <span class="keyword1"><span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> prod.case<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_paired_all prod.case<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ta</span> <span class="bound">sa</span><span class="main">.</span> size <span class="bound">ta</span> <span class="main">+</span> size <span class="bound">sa</span> <span class="main">&lt;</span> size <span class="skolem">t</span> <span class="main">+</span> size <span class="skolem">s</span> <span class="main">⟹</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="bound">sa</span> <span class="main">⟷</span> <span class="bound">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="bound">sa</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span> <span class="main">⟷</span> <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> chkargs_if_chksubs<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> chksubs<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rpo_optim.chkargs_def<span class="main">[</span><span class="operator">OF</span> rpo_optim<span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
      <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> App <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> t_gt_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chksubs s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ t_gt_s2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1i</span>
        <span class="keyword3"><span class="command">assume</span></span> s1i_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s1i</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s1</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chksubs s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s1i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> s1i_in gt_proper_sub size_in_args sub_args <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> t_gt_s1i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s1i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_trans<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> sz_s1i<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">s1i</span> <span class="main">&lt;</span> size <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> size_in_args<span class="main">[</span><span class="operator">OF</span> s1i_in<span class="main">]</span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s1i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ t_gt_s1i<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sz_s1i<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_gt_s
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> gt_sub
      <span class="keyword1"><span class="command">note</span></span> t_app <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> ti_geo_s <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> App <span class="skolem">t1</span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t_app <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tm.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> t_gto_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_sub_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> t_gto_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_arg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> t1_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ t1_gt_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim t_gto_t1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> t2_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ t2_gt_s<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim t_gto_t2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> t ti_geo_s t_gto_t1 t_gto_t2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_diff
      <span class="keyword1"><span class="command">note</span></span> hd_t_gt_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> chkvar <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> chksubs <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim hd_t_gt_s chkvar chkargs_if_chksubs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chksubs<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gt_same
      <span class="keyword1"><span class="command">note</span></span> hd_t_eq_s <span class="main">=</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> chksubs <span class="main">=</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> extf <span class="main">=</span> this<span class="main">(</span>3<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> extf_gto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ta</span> <span class="skolem">sa</span>
          <span class="keyword3"><span class="command">assume</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gt_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">sa</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ta_gt_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ta_in sa_in add_less_mono size_in_args<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_ground extf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim hd_t_eq_s chkargs_if_chksubs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chksubs<span class="main"><span class="main">]</span></span> extf_gto<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> t_gto_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> chksubs_if_chkargs<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> chkargs<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> chksubs_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s1</span> <span class="skolem">s2</span>
      <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> App <span class="skolem">s1</span> <span class="skolem">s2</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_sub_fun<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> t_gto_s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rpo_optim.gt_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim t_gto_s<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ t_gto_s1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> t_gto_s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chkargs <span class="keyword1"><span class="command">unfolding</span></span> rpo_optim.chkargs_def<span class="main">[</span><span class="operator">OF</span> rpo_optim<span class="main">]</span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ t_gto_s2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rpo_optim.gt.cases<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rpo_optim t_gto_s<span class="main"><span class="main">,</span></span>
        <span class="operator">case_names</span> gto_arg gto_diff gto_same<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>gto_arg <span class="skolem">ti</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> ti_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ti_geo_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="keyword1">≥<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ζ</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> apps <span class="main">(</span>Hd <span class="skolem">ζ</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> tm_exhaust_apps<span class="main">)</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> ti_gto_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> ti_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ih<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ti</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> size_in_args ti_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">ti</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sub_args<span class="main">[</span><span class="operator">OF</span> ti_in<span class="main">]</span> gt_proper_sub size_in_args<span class="main">[</span><span class="operator">OF</span> ti_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> gt_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> sub_args<span class="main">[</span><span class="operator">OF</span> ti_in<span class="main">]</span> gt_proper_sub size_in_args<span class="main">[</span><span class="operator">OF</span> ti_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ti_geo_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gto_diff
      <span class="keyword1"><span class="command">hence</span></span> hd_t_gt_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>d</sub></span> head <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> chkvar<span class="main">:</span> <span class="quoted"><span class="quoted">"chkvar <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        chkargs<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chksubs_if_chkargs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chkargs<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_diff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_t_gt_s chkvar<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gto_same
      <span class="keyword1"><span class="command">hence</span></span> hd_t_eq_s<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="skolem">t</span> <span class="main">=</span> head <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> chkargs<span class="main">:</span> <span class="quoted"><span class="quoted">"chkargs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        extf_gto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> chksubs<span class="main">:</span> <span class="quoted"><span class="quoted">"chksubs <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="skolem">t</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> chksubs_if_chkargs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> chkargs<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> extf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="free">extf</span> <span class="bound">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> extf_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
        <span class="keyword3"><span class="command">assume</span></span> f_in_ground<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> ground_heads <span class="main">(</span>head <span class="skolem">t</span><span class="main">)</span>"</span></span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ta</span> <span class="skolem">sa</span>
          <span class="keyword3"><span class="command">assume</span></span> ta_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sa_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sa</span> <span class="main">∈</span> set <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ta_gto_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub></span> <span class="skolem">sa</span>"</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ta</span> <span class="keyword1">&gt;<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">sa</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ih<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ta_gto_sa<span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ta_in sa_in add_less_mono size_in_args<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>

        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">extf</span> <span class="skolem">f</span> <span class="keyword1">(&gt;<span class="hidden">⇩</span><sub>t</sub><span class="hidden">⇩</span><sub>o</sub>)</span> <span class="main">(</span>args <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>args <span class="skolem">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_in_ground extf_gto <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gt_same<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hd_t_eq_s chksubs extf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Encoding">
<div class="head">
<h1>Theory Lambda_Encoding</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Encoding of Lambdas in Lambda-Free Higher-Order Logic
    Author:      Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;, 2019
    Maintainer:  Jasmin Blanchette &lt;j.c.blanchette at vu.nl&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹An Encoding of Lambdas in Lambda-Free Higher-Order Logic›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Encoding
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_Term.html">Lambda_Free_Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This theory defines an encoding of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-expressions as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free higher-order terms.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> lambda_encoding <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">lam</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">db</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_db</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_db</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free">db</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_db</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_db</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Hd <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span> <span class="main">=</span> Hd <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span> <span class="main">=</span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Sym <span class="main">(</span><span class="free">db</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">ζ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_db</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
   App <span class="main">(</span><span class="free">subst_db</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_db</span> <span class="main">(</span><span class="keyword1">if</span> head <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Sym <span class="free">lam</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">raw_db_subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">raw_db_subst</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> Hd <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Sym <span class="main">(</span><span class="free">db</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Var <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vars_mset_subst_db<span class="main">:</span> <span class="quoted"><span class="quoted">"vars_mset <span class="main">(</span>subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> vars_mset <span class="free">s</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> hd.set_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> head_subst_db<span class="main">:</span> <span class="quoted"><span class="quoted">"head <span class="main">(</span>subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> head <span class="main">(</span>subst <span class="main">(</span>raw_db_subst <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> raw_db_subst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> args_subst_db<span class="main">:</span>
  <span class="quoted"><span class="quoted">"args <span class="main">(</span>subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>subst_db <span class="main">(</span><span class="keyword1">if</span> head <span class="free">s</span> <span class="main">=</span> Sym <span class="free">lam</span> <span class="keyword1">then</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>args <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> var_mset_subst_db_subseteq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars_mset <span class="free">s</span> <span class="main">⊆#</span> vars_mset <span class="free">t</span> <span class="main">⟹</span> vars_mset <span class="main">(</span>subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆#</span> vars_mset <span class="main">(</span>subst_db <span class="free">i</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_mset_subst_db multiset_filter_mono<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_RPOs">
<div class="head">
<h1>Theory Lambda_Free_RPOs</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Recursive Path Orders for Lambda-Free Higher-Order Terms
    Author:      Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;, 2016
    Author:      Uwe Waldmann &lt;waldmann at mpi-inf.mpg.de&gt;, 2016
    Author:      Daniel Wand &lt;dwand at mpi-inf.mpg.de&gt;, 2016
    Maintainer:  Jasmin Blanchette &lt;jasmin.blanchette at inria.fr&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Recursive Path Orders for Lambda-Free Higher-Order Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_RPOs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda_Free_RPO_App.html">Lambda_Free_RPO_App</a> <a href="Lambda_Free_RPO_Optim.html">Lambda_Free_RPO_Optim</a> <a href="Lambda_Encoding.html">Lambda_Encoding</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> simple_rpo_instances
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_sym</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">∞</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">arity_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity_var</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">∞</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ground_head_var</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ground_head_var</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gt_sym</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gt_sym</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> app<span class="main">:</span> rpo_app <span class="quoted">gt_sym</span> <span class="quoted">len_lexext</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gt_sym_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_less<span class="main"><span class="main">[</span></span><span class="operator">folded</span> wfP_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> std<span class="main">:</span> rpo <span class="quoted">ground_head_var</span> <span class="quoted">gt_sym</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> len_lexext"</span></span> <span class="quoted">arity_sym</span> <span class="quoted">arity_var</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> arity_var_def arity_sym_def ground_head_var_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> optim<span class="main">:</span> rpo_optim <span class="quoted">ground_head_var</span> <span class="quoted">gt_sym</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> len_lexext"</span></span> <span class="quoted">arity_sym</span> <span class="quoted">arity_var</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>