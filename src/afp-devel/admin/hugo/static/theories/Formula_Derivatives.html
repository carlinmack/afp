<div id="While_Default">
<div class="head">
<h1>Theory While_Default</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> While_Default
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">while_default</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">while_default</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">^^</span><span class="bound">k</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">d</span> <span class="keyword1">else</span> the <span class="main">(</span>while_option <span class="free">b</span> <span class="free">c</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_default_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"while_default <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="free">s</span> <span class="keyword1">then</span> while_default <span class="main">(</span><span class="free">c</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">^^</span><span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> spec<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> spec<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">m</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">^^</span><span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_Suc_right <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> while_default_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">^^</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">^^</span> <span class="bound">l</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> LeastI_ex<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> Least_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">with</span></span> k<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while_default_def while_option_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="main">^^</span> <span class="main">0</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> k<span class="main">(</span>1<span class="main">)</span> Suc False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> while_default_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> while_option_unfold<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_Suc_right <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_default_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">c</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">b</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>while_default <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">^^</span><span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"while_option <span class="free">b</span> <span class="free">c</span> <span class="free">s</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> while_option_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> while_option_stop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> s c t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while_default_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> while_default_def d t<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FSet_More">
<div class="head">
<h1>Theory FSet_More</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> FSet_More
<span class="keyword2"><span class="keyword">imports</span></span>  <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_pred_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Suc <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred neq0_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> Suc_pred_fimage<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> Suc_pred_image<span class="main">[</span><span class="operator">Transfer.transferred</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ffilter_eq_fempty_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ffilter <span class="free">P</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">X</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">{||}</span> <span class="main">=</span> ffilter <span class="free">P</span> <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">X</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_ffilter_below<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">|∈|</span> <span class="free">P</span><span class="main">;</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  max <span class="free">n</span> <span class="main">(</span>Suc <span class="main">(</span>fMax <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max.absorb1 Suc_leI fMax_in fempty_iff ffmember_filter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMax_boundedD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>fMax <span class="free">P</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>fMax <span class="free">P</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">n</span> <span class="main">|∉|</span> <span class="free">P</span><span class="main">;</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">P</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fMax_ge le_less_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> fMax_ge leD neqE order.strict_trans2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMax_ffilter_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> fMax <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fMax_in ffilter_eq_fempty_iff<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ffmember_filter<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Automaton">
<div class="head">
<h1>Theory Automaton</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Equivalence Framework"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Automaton
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
  <a href="../Coinductive_Languages/Coinductive_Language.html">Coinductive_Languages.Coinductive_Language</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">rel_language</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>𝔬 <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> 𝔬 <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">rel_language</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>𝔡 <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">rel_language</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> rel_language.coinduct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Lang<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">pred</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_language_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_language <span class="free">R</span> <span class="free">L</span> <span class="free">K</span> <span class="main">=</span> rel_fun <span class="main">(</span>list_all2 <span class="free">R</span><span class="main">)</span> <span class="main">(=)</span> <span class="main">(</span>in_language <span class="free">L</span><span class="main">)</span> <span class="main">(</span>in_language <span class="free">K</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">R</span> <span class="free">L</span> <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"in_language <span class="free">L</span> <span class="skolem">xs</span> <span class="main">=</span> in_language <span class="free">K</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_language.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> list_all2 <span class="free">R</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟶</span> in_language <span class="free">L</span> <span class="bound">xs</span> <span class="main">=</span> in_language <span class="free">K</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">R</span> <span class="free">L</span> <span class="free">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_language_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_language <span class="main">(=)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_language_alt<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> list.rel_eq fun.rel_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fun_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ to_language_in_language to_language_in_language<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔡s</span> <span class="main">≡</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">L</span><span class="main">.</span> 𝔡 <span class="bound">L</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_language_𝔡s<span class="main">:</span> <span class="quoted"><span class="quoted">"in_language <span class="main">(</span>𝔡s <span class="free">w</span> <span class="free">L</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟷</span> in_language <span class="free">L</span> <span class="main">(</span><span class="free">w</span> <span class="main">@</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔬_𝔡s<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>𝔡s <span class="free">w</span> <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> in_language <span class="free">L</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_language_to_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"in_language <span class="main">(</span>to_language <span class="free">L</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_language_to_language mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_fold_product<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">g</span> <span class="bound">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span><span class="main">^*</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>fold <span class="free">f</span> <span class="bound">w1</span> <span class="bound">r</span><span class="main">,</span> fold <span class="free">g</span> <span class="bound">w2</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">w1</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">∧</span> <span class="bound">w2</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">∧</span> list_all2 <span class="free">R</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">w2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">w1</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w1</span> <span class="skolem">r</span><span class="main">,</span> fold <span class="free">g</span> <span class="skolem">w2</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">w2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> converse_rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_fold_product1<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span><span class="main">^*</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> fold <span class="free">f</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 10 0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lang_eq_ext_Nil_fold_Deriv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">K</span> <span class="free">L</span> <span class="free">A</span> <span class="free">R</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> in_language <span class="free">K</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> in_language <span class="free">L</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔅</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>𝔡s <span class="bound">w1</span> <span class="free">K</span><span class="main">,</span> 𝔡s <span class="bound">w2</span> <span class="free">L</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="bound">w1</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">∧</span> <span class="bound">w2</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">∧</span> list_all2 <span class="free">R</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">R</span> <span class="free">K</span> <span class="free">L</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">L</span><span class="main">)</span> <span class="main">∈</span> <span class="free">𝔅</span><span class="main">.</span> 𝔬 <span class="bound">K</span> <span class="main">⟷</span> 𝔬 <span class="bound">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free">𝔅</span><span class="main">.</span> 𝔬 <span class="bound">K</span> <span class="main">=</span> 𝔬 <span class="bound">L</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">R</span> <span class="free">K</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝔅_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">K</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lang <span class="skolem">K</span> <span class="skolem">L</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> CIH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K'</span> <span class="bound">L'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span>
      <span class="bound">K'</span> <span class="main">=</span> 𝔡s <span class="bound">w1</span> <span class="skolem">K</span> <span class="main">∧</span> <span class="bound">L'</span> <span class="main">=</span> 𝔡s <span class="bound">w2</span> <span class="skolem">L</span> <span class="main">∧</span> <span class="bound">w1</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">∧</span> <span class="bound">w2</span> <span class="main">∈</span> lists <span class="free">B</span> <span class="main">∧</span> list_all2 <span class="free">R</span> <span class="bound">w1</span> <span class="bound">w2</span> <span class="main">⟹</span> 𝔬 <span class="bound">K'</span> <span class="main">=</span> 𝔬 <span class="bound">L'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> in_language <span class="skolem">K</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> in_language <span class="skolem">L</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="free">B</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ex_simps simp_thms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝔬 <span class="skolem">K</span> <span class="main">=</span> 𝔬 <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> CIH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> exI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">w1</span> <span class="skolem">w2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">w1</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">w2</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">w1</span> <span class="skolem">w2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝔬 <span class="main">(</span>𝔡s <span class="skolem">w1</span> <span class="main">(</span>𝔡 <span class="skolem">K</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 𝔬 <span class="main">(</span>𝔡s <span class="skolem">w2</span> <span class="main">(</span>𝔡 <span class="skolem">L</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="skolem">x</span> <span class="skolem">y</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_language_𝔡s in_language.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> in_language.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> CIH exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">x</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">w1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">y</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">w2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_language.simps<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> in_language.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 𝔅_def rel_language_alt rel_fun_def 𝔬_𝔡s<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Deterministic Automaton›</span></span>

<span class="keyword1"><span class="command">locale</span></span> DA <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">alphabet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Lang</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'a</span> language"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> distinct_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">alphabet</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> Language_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">Language</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">Lang</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> wellformed_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">wellformed</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> Language_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wellformed</span> <span class="free">s</span><span class="main">;</span> in_language <span class="main">(</span><span class="free">Language</span> <span class="free">s</span><span class="main">)</span> <span class="free">w</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> wellformed_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wellformed</span> <span class="free">s</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">alphabet</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wellformed</span> <span class="main">(</span><span class="free">delta</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> Language_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wellformed</span> <span class="free">s</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">alphabet</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Language</span> <span class="main">(</span><span class="free">delta</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝔡 <span class="main">(</span><span class="free">Language</span> <span class="free">s</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> accept_Language<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">accept</span> <span class="free">s</span> <span class="main">⟷</span> 𝔬 <span class="main">(</span><span class="free">Language</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> this<span class="main">:</span> <span class="quoted"><span class="quoted">"DA <span class="free">alphabet</span> <span class="free">init</span> <span class="free">delta</span> <span class="free">accept</span> <span class="free">wellformed</span> <span class="free">Language</span> <span class="free">wf</span> <span class="free">Lang</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">lemma</span></span> wellformed_deltas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wellformed</span> <span class="free">s</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wellformed</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free">w</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Language_delta wellformed_delta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Language_deltas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wellformed</span> <span class="free">s</span><span class="main">;</span> <span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Language</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free">w</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> 𝔡s <span class="free">w</span> <span class="main">(</span><span class="free">Language</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Language_delta wellformed_delta<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Auxiliary functions:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> snd <span class="main">(</span>the <span class="main">(</span>rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">automaton</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
    snd <span class="main">(</span>the
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">start</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
         <span class="bound">test</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">ws</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span>
         <span class="bound">step</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span>
           <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> hd <span class="bound">ws</span><span class="main">;</span>
                <span class="bound">new_edges</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
                <span class="bound">new</span> <span class="main">=</span> remdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span> <span class="main">∉</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">(</span>map snd <span class="bound">new_edges</span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">new</span> <span class="main">@</span> tl <span class="bound">ws</span><span class="main">,</span> set <span class="bound">new</span> <span class="main">∪</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> set <span class="bound">new_edges</span> <span class="main">∪</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> while_option <span class="bound">test</span> <span class="bound">step</span> <span class="bound">start</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">accept</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="free">s</span> <span class="free">w</span> <span class="main">⟷</span> in_language <span class="main">(</span><span class="free">Language</span> <span class="free">s</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> match_def accept_Language<span class="main">[</span><span class="operator">OF</span> wellformed_deltas<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> Language_deltas<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> 𝔬_𝔡s <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> DAs <span class="main">=</span>
  M<span class="main">:</span> DA <span class="quoted"><span class="free">alphabet1</span></span> <span class="quoted"><span class="free">init1</span></span> <span class="quoted"><span class="free">delta1</span></span> <span class="quoted"><span class="free">accept1</span></span> <span class="quoted"><span class="free">wellformed1</span></span> <span class="quoted"><span class="free">Language1</span></span> <span class="quoted"><span class="free">wf1</span></span> <span class="quoted"><span class="free">Lang1</span></span> <span class="main">+</span>
  N<span class="main">:</span> DA <span class="quoted"><span class="free">alphabet2</span></span> <span class="quoted"><span class="free">init2</span></span> <span class="quoted"><span class="free">delta2</span></span> <span class="quoted"><span class="free">accept2</span></span> <span class="quoted"><span class="free">wellformed2</span></span> <span class="quoted"><span class="free">Language2</span></span> <span class="quoted"><span class="free">wf2</span></span> <span class="quoted"><span class="free">Lang2</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">alphabet1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t1</span> <span class="main">⇒</span> <span class="tfree">'s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta1</span> <span class="free">accept1</span> <span class="free">wellformed1</span> <span class="free">Language1</span> <span class="free">wf1</span> <span class="free">Lang1</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a2</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t2</span> <span class="main">⇒</span> <span class="tfree">'s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta2</span> <span class="free">accept2</span> <span class="free">wellformed2</span> <span class="free">Language2</span> <span class="free">wf2</span> <span class="free">Lang2</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">letter_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> <span class="main">⇒</span> <span class="tfree">'a2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> letter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">letter_eq</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">alphabet1</span> <span class="main">⟷</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">alphabet2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">delta1</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> <span class="free">delta2</span> <span class="bound">b</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>filter <span class="main">(</span>case_prod <span class="free">letter_eq</span><span class="main">)</span> <span class="main">(</span>List.product <span class="free">alphabet1</span> <span class="free">alphabet2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">closure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s1</span> <span class="main">*</span> <span class="tfree">'s2</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s1</span> <span class="main">*</span> <span class="tfree">'s2</span><span class="main">)</span> list <span class="main">*</span> <span class="main">(</span><span class="tfree">'s1</span> <span class="main">*</span> <span class="tfree">'s2</span><span class="main">)</span> set<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closure</span> <span class="main">≡</span> rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="free">accept1</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">accept2</span> <span class="bound">q</span><span class="main">)</span> step"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> closure_sound_complete<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf1</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf2</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="free">init1</span> <span class="free">r</span><span class="main">,</span> <span class="free">init2</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ws</span><span class="main">,</span> <span class="free">R</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="var">?r</span><span class="main">,</span> <span class="var">?s</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Lang1</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Lang2</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wf <span class="keyword1"><span class="command">have</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed1</span> <span class="var">?r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wellformed2</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M.wellformed_init N.wellformed_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> Language_alphabets<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
    M.Language_alphabet<span class="main">[</span><span class="operator">OF</span> wellformed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> N.Language_alphabet<span class="main">[</span><span class="operator">OF</span> wellformed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> Language_deltass <span class="main">=</span> M.Language_deltas<span class="main">[</span><span class="operator">OF</span> wellformed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> N.Language_deltas<span class="main">[</span><span class="operator">OF</span> wellformed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">have</span></span> bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Language1</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">Language2</span> <span class="var">?s</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w1</span> <span class="bound">w2</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> 𝔡s <span class="bound">w1</span> <span class="main">(</span><span class="free">Language1</span> <span class="var">?r</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">=</span> 𝔡s <span class="bound">w2</span> <span class="main">(</span><span class="free">Language2</span> <span class="var">?s</span><span class="main">)</span> <span class="main">∧</span>
      <span class="bound">w1</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">w2</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet2</span><span class="main">)</span> <span class="main">∧</span> list_all2 <span class="free">letter_eq</span> <span class="bound">w1</span> <span class="bound">w2</span><span class="main">)</span> <span class="main">⟶</span>
    𝔬 <span class="bound">a</span> <span class="main">=</span> 𝔬 <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lang_eq_ext_Nil_fold_Deriv<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> letter_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Language1</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">Language2</span> <span class="var">?s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">delta1</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">delta2</span> <span class="bound">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">.</span>
    <span class="bound">a</span> <span class="main">∈</span> set <span class="free">alphabet1</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">alphabet2</span> <span class="main">∧</span> <span class="free">letter_eq</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span><span class="var">?r</span><span class="main">,</span> <span class="var">?s</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
    <span class="free">accept1</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">accept2</span> <span class="bound">s'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Language_deltass
      M.accept_Language<span class="main">[</span><span class="operator">OF</span> M.wellformed_deltas<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wellformed<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      N.accept_Language<span class="main">[</span><span class="operator">OF</span> N.wellformed_deltas<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wellformed<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> rtrancl_fold_product in_lists_conv_set bisim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 10 0<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>step <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">delta1</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">delta2</span> <span class="bound">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">alphabet1</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">alphabet2</span> <span class="main">∧</span> <span class="free">letter_eq</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> rtrancl_while_Some<span class="main">[</span><span class="operator">OF</span> result<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ws</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Language1</span> <span class="var">?r</span><span class="main">)</span> <span class="main">(</span><span class="free">Language2</span> <span class="var">?s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leq Ball_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> M.Language_init<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> N.Language_init<span class="main">[</span><span class="operator">OF</span> wf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The overall procedure›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t1</span> <span class="main">⇒</span> <span class="tfree">'t2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">wf1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">wf2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> closure <span class="main">(</span><span class="free">init1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free">init2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> soundness<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Lang1</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Lang2</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf1</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf2</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="free">init1</span> <span class="free">r</span><span class="main">,</span> <span class="free">init2</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> closure_sound_complete<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Lang1</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Lang2</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* completeness needs termination of closure, otherwise result could be None *)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Deterministic Finite Automaton›</span></span>

<span class="keyword1"><span class="command">locale</span></span> DFA <span class="main">=</span> DA <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="free">s</span> <span class="main">⟹</span> finite <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="free">s</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">alphabet</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_rtrancl_delta_Image1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="free">r</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">alphabet</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rtrancl_fold_product1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">⊆</span> set <span class="free">alphabet</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">as</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="free">r</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reachable <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wsZ</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> Some <span class="skolem">wsZ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> rtrancl_while_finite_Some Image_mono rtrancl_mono
      finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_rtrancl_delta_Image1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">as</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="free">r</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wsZ</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_while_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtrancl_fold_product1 image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reachable <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> DFAs <span class="main">=</span>
  M<span class="main">:</span> DFA <span class="quoted"><span class="free">alphabet1</span></span> <span class="quoted"><span class="free">init1</span></span> <span class="quoted"><span class="free">delta1</span></span> <span class="quoted"><span class="free">accept1</span></span> <span class="quoted"><span class="free">wellformed1</span></span> <span class="quoted"><span class="free">Language1</span></span> <span class="quoted"><span class="free">wf1</span></span> <span class="quoted"><span class="free">Lang1</span></span> <span class="main">+</span>
  N<span class="main">:</span> DFA <span class="quoted"><span class="free">alphabet2</span></span> <span class="quoted"><span class="free">init2</span></span> <span class="quoted"><span class="free">delta2</span></span> <span class="quoted"><span class="free">accept2</span></span> <span class="quoted"><span class="free">wellformed2</span></span> <span class="quoted"><span class="free">Language2</span></span> <span class="quoted"><span class="free">wf2</span></span> <span class="quoted"><span class="free">Lang2</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">alphabet1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t1</span> <span class="main">⇒</span> <span class="tfree">'s1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta1</span> <span class="free">accept1</span> <span class="free">wellformed1</span> <span class="free">Language1</span> <span class="free">wf1</span> <span class="free">Lang1</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a2</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t2</span> <span class="main">⇒</span> <span class="tfree">'s2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">delta2</span> <span class="free">accept2</span> <span class="free">wellformed2</span> <span class="free">Language2</span> <span class="free">wf2</span> <span class="free">Lang2</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">letter_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> <span class="main">⇒</span> <span class="tfree">'a2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> letter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">letter_eq</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">alphabet1</span> <span class="main">⟷</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">alphabet2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> DAs <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> letter_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_rtrancl_delta_Image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wellformed1</span> <span class="free">r</span><span class="main">;</span> <span class="free">wellformed2</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  finite <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">delta1</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">delta2</span> <span class="bound">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">r</span> <span class="bound">s</span><span class="main">.</span>
    <span class="bound">a</span> <span class="main">∈</span> set <span class="free">alphabet1</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">alphabet2</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rtrancl_fold_product Image_singleton
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> M.fin N.fin<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted">"termination"</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">wellformed1</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wellformed2</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">st</span><span class="main">.</span> closure <span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">st</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> closure  <span class="var">?i</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_while_finite_Some<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="bound">st</span> <span class="main">∈</span> set <span class="main">(</span>step <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Image_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> rtrancl_mono<span class="main"><span class="main"><span class="main">]</span></span></span>
      finite_rtrancl_delta_Image<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">letter_eq</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> completeness<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf1</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">wf2</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"rel_language <span class="free">letter_eq</span> <span class="main">(</span><span class="free">Lang1</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">Lang2</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span><span class="free">init1</span> <span class="free">r</span><span class="main">,</span> <span class="free">init2</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ws</span><span class="main">,</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"termination"</span>
    M.wellformed_init N.wellformed_init assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> closure_sound_complete<span class="main">[</span><span class="operator">OF</span> _ _ this<span class="main">]</span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_eqv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> DA <span class="main">&lt;</span> DAs
  <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">wellformed</span></span> <span class="quoted"><span class="free">Language</span></span> <span class="quoted"><span class="free">wf</span></span> <span class="quoted"><span class="free">Lang</span></span>
  <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">wellformed</span></span> <span class="quoted"><span class="free">Language</span></span> <span class="quoted"><span class="free">wf</span></span> <span class="quoted"><span class="free">Lang</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">sublocale</span></span> DFA <span class="main">&lt;</span> DFAs
  <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">wellformed</span></span> <span class="quoted"><span class="free">Language</span></span> <span class="quoted"><span class="free">wf</span></span> <span class="quoted"><span class="free">Lang</span></span>
  <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">delta</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">wellformed</span></span> <span class="quoted"><span class="free">Language</span></span> <span class="quoted"><span class="free">wf</span></span> <span class="quoted"><span class="free">Lang</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> DA<span class="main">)</span> step_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free">alphabet</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_alphabet
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">alphabet</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">←</span>List.product <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">←</span>List.product <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">←</span>map <span class="main">(</span>Pair <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Abstract_Formula">
<div class="head">
<h1>Theory Abstract_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Derivatives of Abstract Formulas›</span></span>
<span class="comment1">(* Author: Dmitriy Traytel *)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Abstract_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Automaton.html">Automaton</a>
  <a href="../Deriving/Compare_Instances.html">Deriving.Compare_Instances</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
  <a href="While_Default.html">While_Default</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pred_Diff_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟷</span> Suc <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff le_Suc_eq  <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> funpow_cycle_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funpow_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> funpow_cycle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">l</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span><span class="free">l</span> <span class="keyword1">mod</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> div_mult_mod_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">l</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add.commute funpow_add funpow_cycle_mult o_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> funpow_cycle_offset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">k</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">l</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">l</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> funpow_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> funpow_cycle<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">i</span>"</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_tlD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">-</span> Suc <span class="main">0</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract formulas›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>discs_sels<span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">=</span>
  FBool <span class="quoted">bool</span>
<span class="main">|</span> FBase <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="main">|</span> FNot <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="main">|</span> FOr <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="main">|</span> FAnd <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="main">|</span> FEx <span class="tfree"><span class="quoted"><span class="tfree">'k</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="main">|</span> FAll <span class="tfree"><span class="quoted"><span class="tfree">'k</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">aformula</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFOR</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFOR</span> <span class="main">[]</span> <span class="main">=</span> FBool False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOR</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOR</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">nFOR</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFAND</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFAND</span> <span class="main">[]</span> <span class="main">=</span> FBool True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAND</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAND</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">nFAND</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">NFOR</span> <span class="main">=</span> nFOR <span class="keyword1">o</span> sorted_list_of_set"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">NFAND</span> <span class="main">=</span> nFAND <span class="keyword1">o</span> sorted_list_of_set"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">disjuncts</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">disjuncts</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">disjuncts</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">disjuncts</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">disjuncts</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">conjuncts</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">conjuncts</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">conjuncts</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">conjuncts</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">conjuncts</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">disjuncts_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">disjuncts_list</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">disjuncts_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">@</span> <span class="free">disjuncts_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">disjuncts_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">conjuncts_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">conjuncts_list</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">conjuncts_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">@</span> <span class="free">conjuncts_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">conjuncts_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_juncts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>disjuncts <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>conjuncts <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nonempty_juncts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"disjuncts <span class="free">φ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"conjuncts <span class="free">φ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> juncts_eq_set_juncts_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"disjuncts <span class="free">φ</span> <span class="main">=</span> set <span class="main">(</span>disjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"conjuncts <span class="free">φ</span> <span class="main">=</span> set <span class="main">(</span>conjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> notin_juncts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ψ</span> <span class="main">∈</span> disjuncts <span class="free">φ</span><span class="main">;</span> is_FOr <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ψ</span> <span class="main">∈</span> conjuncts <span class="free">φ</span><span class="main">;</span> is_FAnd <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> juncts_list_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_FOr <span class="free">φ</span> <span class="main">⟹</span> disjuncts_list <span class="free">φ</span> <span class="main">=</span> <span class="main">[</span><span class="free">φ</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_FAnd <span class="free">φ</span> <span class="main">⟹</span> conjuncts_list <span class="free">φ</span> <span class="main">=</span> <span class="main">[</span><span class="free">φ</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> juncts_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_FOr <span class="free">φ</span> <span class="main">⟹</span> disjuncts <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_FAnd <span class="free">φ</span> <span class="main">⟹</span> conjuncts <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_juncts_list<span class="main">:</span> <span class="quoted"><span class="quoted">"conjuncts_list <span class="free">φ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"disjuncts_list <span class="free">φ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nonempty_juncts<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq juncts_eq_set_juncts_list<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">norm_ACI</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> FNot <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> NFOR <span class="main">(</span>disjuncts <span class="main">(</span>FOr <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">⟩</span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> NFAND <span class="main">(</span>conjuncts <span class="main">(</span>FAnd <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main"><span class="free">⟩</span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⟨</span></span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="main">=</span> FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main"><span class="free">⟩</span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nf_ACI</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nf_ACI</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> is_FOr <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">φs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">#</span> disjuncts_list <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span> <span class="keyword1">in</span>
    sorted <span class="bound">φs</span> <span class="main">∧</span> distinct <span class="bound">φs</span> <span class="main">∧</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">∧</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nf_ACI</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> is_FAnd <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">φs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">#</span> conjuncts_list <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span> <span class="keyword1">in</span>
    sorted <span class="bound">φs</span> <span class="main">∧</span> distinct <span class="bound">φs</span> <span class="main">∧</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">∧</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nf_ACI</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nf_ACI</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nf_ACI</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nf_ACI</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nf_ACI_D<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> sorted <span class="main">(</span>disjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> sorted <span class="main">(</span>conjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> distinct <span class="main">(</span>disjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> distinct <span class="main">(</span>conjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> list_all nf_ACI <span class="main">(</span>disjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> list_all nf_ACI <span class="main">(</span>conjuncts_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disjuncts_list_nFOR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> is_FOr <span class="bound">x</span><span class="main">)</span> <span class="free">φs</span><span class="main">;</span> <span class="free">φs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> disjuncts_list <span class="main">(</span>nFOR <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> <span class="free">φs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOR.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conjuncts_list_nFAND<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> is_FAnd <span class="bound">x</span><span class="main">)</span> <span class="free">φs</span><span class="main">;</span> <span class="free">φs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> conjuncts_list <span class="main">(</span>nFAND <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> <span class="free">φs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAND.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disjuncts_NFOR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">X</span><span class="main">;</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">¬</span> is_FOr <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> disjuncts <span class="main">(</span>NFOR <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFOR_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_eq_set_juncts_list list_all_iff disjuncts_list_nFOR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conjuncts_NFAND<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">X</span><span class="main">;</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">¬</span> is_FAnd <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span> conjuncts <span class="main">(</span>NFAND <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFAND_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_eq_set_juncts_list list_all_iff conjuncts_list_nFAND<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nf_ACI_nFOR<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">φs</span><span class="main">;</span> distinct <span class="free">φs</span><span class="main">;</span> list_all nf_ACI <span class="free">φs</span><span class="main">;</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> is_FOr <span class="bound">x</span><span class="main">)</span> <span class="free">φs</span><span class="main">⟧</span> <span class="main">⟹</span> nf_ACI <span class="main">(</span>nFOR <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOR.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton disjuncts_list_nFOR nf_ACI_D<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nf_ACI_nFAND<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sorted <span class="free">φs</span><span class="main">;</span> distinct <span class="free">φs</span><span class="main">;</span> list_all nf_ACI <span class="free">φs</span><span class="main">;</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> is_FAnd <span class="bound">x</span><span class="main">)</span> <span class="free">φs</span><span class="main">⟧</span> <span class="main">⟹</span> nf_ACI <span class="main">(</span>nFAND <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAND.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton conjuncts_list_nFAND nf_ACI_D<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nf_ACI_juncts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ψ</span> <span class="main">∈</span> disjuncts <span class="free">φ</span><span class="main">;</span> nf_ACI <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> nf_ACI <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ψ</span> <span class="main">∈</span> conjuncts <span class="free">φ</span><span class="main">;</span> nf_ACI <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> nf_ACI <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nf_ACI_norm_ACI<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> NFOR_def NFAND_def list_all_iff
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nf_ACI_nFOR nf_ACI_nFAND <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nf_ACI_juncts notin_juncts<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nFOR_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"nFOR <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> FOr <span class="free">x</span> <span class="main">(</span>nFOR <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> nFAND_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"nFAND <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> FAnd <span class="free">x</span> <span class="main">(</span>nFAND <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> nFOR_disjuncts<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">ψ</span> <span class="main">⟹</span> nFOR <span class="main">(</span>disjuncts_list <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton nFOR_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nFAND_conjuncts<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">ψ</span> <span class="main">⟹</span> nFAND <span class="main">(</span>conjuncts_list <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton nFAND_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> NFOR_disjuncts<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">ψ</span> <span class="main">⟹</span> NFOR <span class="main">(</span>disjuncts <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nFOR_disjuncts<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> NFOR_def o_apply juncts_eq_set_juncts_list
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set finite_sorted_distinct_unique nf_ACI_D<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> sorted_list_of_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> NFAND_conjuncts<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">ψ</span> <span class="main">⟹</span> NFAND <span class="main">(</span>conjuncts <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nFAND_conjuncts<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> NFAND_def o_apply juncts_eq_set_juncts_list
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_set finite_sorted_distinct_unique nf_ACI_D<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> sorted_list_of_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_ACI_if_nf_ACI<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> juncts_list_singleton juncts_eq_set_juncts_list nonempty_juncts_list
      NFOR_def NFAND_def nFOR_Cons nFAND_Cons nFOR_disjuncts nFAND_conjuncts
      sorted_list_of_set_sort_remdups distinct_remdups_id sorted_sort_id insort_is_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_ACI_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nf_ACI_norm_ACI norm_ACI_if_nf_ACI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_ACI_juncts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> norm_ACI <span class="main">`</span> disjuncts <span class="free">φ</span> <span class="main">=</span> disjuncts <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> norm_ACI <span class="main">`</span> conjuncts <span class="free">φ</span> <span class="main">=</span> conjuncts <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> nf_ACI_D<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff juncts_eq_set_juncts_list norm_ACI_if_nf_ACI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  norm_ACI_NFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">=</span> NFOR <span class="main">(</span>norm_ACI <span class="main">`</span> disjuncts <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  norm_ACI_NFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"nf_ACI <span class="free">φ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">=</span> NFAND <span class="main">(</span>norm_ACI <span class="main">`</span> conjuncts <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_ACI_juncts NFOR_disjuncts NFAND_conjuncts<span class="main">)</span>

<span class="comment1">(*
'a - atomic formula
'i - interpretation
'k - kind of quantifier
'n - De Brujin index
'x - alphabet element
'v - valuation
*)</span>
<span class="keyword1"><span class="command">locale</span></span> Formula_Operations <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">TYPEVARS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">×</span> <span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'k</span> <span class="main">::</span> <span class="main">{</span>linorder<span class="main">,</span> enum<span class="main">}</span> <span class="main">×</span> <span class="tfree">'n</span> <span class="main">×</span> <span class="tfree">'x</span> <span class="main">×</span> <span class="tfree">'v</span>"</span></span>

  <span class="comment1">(* De Bruijn indices abstractly *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">SUC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">LESS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool"</span></span>

  <span class="comment1">(* Interpratations *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">assigns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1">⇗</span></span>_<span class="keyword1"><span class="keyword1">⇖</span></span>_"</span> <span class="main">[</span>900<span class="main">,</span> 999<span class="main">,</span> 999<span class="main">]</span> 999<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nvars</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span></span> _"</span> <span class="main">[</span>1000<span class="main">]</span> 900<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Extend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">CONS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">SNOC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> nat"</span></span>

  <span class="comment1">(* Alphabet elements *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">extend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'x</span> list"</span></span>

  <span class="comment1">(* Valuations *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">downshift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">upshift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> <span class="main">⇒</span> nat"</span></span>

  <span class="comment1">(* Restrictions *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>

  <span class="comment1">(* Function extensions for the base cases *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lformula0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">FV0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">find0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">wf0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">decr0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">satisfies0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1">⊨<span class="hidden">⇩</span><sub>0</sub></span></span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">nullable0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lderiv0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">rderiv0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">LEQ</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free">LESS</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free">SUC</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">FV</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FBool <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">FV0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">find</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FBool <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">find0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="keyword1">then</span> Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="keyword1">then</span> Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FBool <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf</span> <span class="main">(</span><span class="free">SUC</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">wf</span> <span class="main">(</span><span class="free">SUC</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lformula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FBool <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lformula0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lformula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span><span class="free">decr0</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FNot <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEx <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="keyword1">then</span> Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FAll <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="main">(</span><span class="free">decr</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k'</span></span></span> <span class="keyword1">then</span> Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies_gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∨</span> <span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">P</span> <span class="main">(</span><span class="free">Length</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">Extend</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="bound">P</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">P</span> <span class="main">(</span><span class="free">Length</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span><span class="main">)</span> <span class="main">⟶</span> <span class="free">satisfies_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">Extend</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="bound">P</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">satisfies</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> satisfies_gen <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">satisfies_bounded</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>b</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> satisfies_gen <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">P</span> <span class="bound">n</span><span class="main">.</span> <span class="free">len</span> <span class="bound">P</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sat_vars_gen</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat_vars_gen</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span>
    satisfies_gen <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">P</span> <span class="bound">n</span><span class="main">.</span> <span class="free">restrict</span> <span class="bound">k</span> <span class="bound">P</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">k</span> <span class="bound">P</span> <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> FV <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">k</span><span class="main">.</span> <span class="free">restrict</span> <span class="bound">k</span> <span class="main">(</span><span class="bound">x</span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> sat_vars_gen <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> UNIV <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sat<span class="hidden">⇩</span><sub>b</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> sat_vars_gen <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">P</span> <span class="bound">n</span><span class="main">.</span> <span class="free">len</span> <span class="bound">P</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">)</span> UNIV <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">RESTR</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RESTR</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RESTR</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RESTR</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FNot <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RESTR</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>FAnd <span class="main">(</span><span class="free">Restrict</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RESTR</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>FOr <span class="main">(</span>FNot <span class="main">(</span><span class="free">Restrict</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RESTR</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RESTRICT_VARS</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RESTRICT_VARS</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span>
     foldr <span class="main">(</span><span class="main">%</span><span class="bound">k</span> <span class="bound">φ</span><span class="main">.</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> FAnd <span class="main">(</span><span class="free">Restrict</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">k</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span> <span class="main">(</span>RESTR <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RESTRICT</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RESTRICT</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> RESTRICT_VARS Enum.enum <span class="main">(</span>sorted_list_of_set <span class="keyword1">o</span> FV <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nullable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nullable0</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nullable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFOr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFOr</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b1</span></span></span><span class="main">)</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> FBool <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOr</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> FBool True <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOr</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> FBool True <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOr</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="free">nFOr</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="main">(</span><span class="free">nFOr</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOr</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="keyword1">then</span> FOr <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="keyword1">then</span> FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> FOr <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">(</span><span class="free">nFOr</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFOr</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span> FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
  <span class="keyword1">else</span> FOr <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFAnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFAnd</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b1</span></span></span><span class="main">)</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="main">=</span> FBool <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAnd</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAnd</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAnd</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="free">nFAnd</span> <span class="free"><span class="bound"><span class="entity">φ1</span></span></span> <span class="main">(</span><span class="free">nFAnd</span> <span class="free"><span class="bound"><span class="entity">φ2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAnd</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="keyword1">then</span> FAnd <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="keyword1">then</span> FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> FAnd <span class="free"><span class="bound"><span class="entity">ψ1</span></span></span> <span class="main">(</span><span class="free">nFAnd</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAnd</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span> FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
  <span class="keyword1">else</span> FAnd <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFEx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFEx</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> nFOr <span class="main">(</span><span class="free">nFEx</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nFEx</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFEx</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> find <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> decr <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFAll</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFAll</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> nFAnd <span class="main">(</span><span class="free">nFAll</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nFAll</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFAll</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> find <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> decr <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nFNot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> nFAnd <span class="main">(</span><span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> nFOr <span class="main">(</span><span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nFAll <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nFEx <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> FBool <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nFNot</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> nFOr <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> nFAnd <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nFNot <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nFEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> nFAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">norm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">deriv0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">deriv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> FBool <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FBase <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">deriv0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FNot <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>FOr <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span><span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> True <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span><span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> False <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">deriv</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>FAnd <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span><span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> True <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span><span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> False <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lderiv</span> <span class="main">≡</span> deriv <span class="free">lderiv0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rderiv</span> <span class="main">≡</span> deriv <span class="free">rderiv0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_deriv_FBool<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>FBool <span class="free">b</span><span class="main">)</span> <span class="main">=</span> FBool <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_deriv_FNot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> FNot <span class="main">(</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_deriv_FOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_deriv_FAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_deriv_FEx<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">(</span>FEx <span class="free">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span>
    <span class="main">{</span>FEx <span class="free">k</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> nf_ACI <span class="bound">ψ</span> <span class="main">∧</span> disjuncts <span class="bound">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="free">φ</span><span class="main">⟩</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>FEx <span class="free">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> FEx <span class="free">k</span> <span class="bound">ψ</span> <span class="main">∧</span>
      nf_ACI <span class="bound">ψ</span> <span class="main">∧</span> disjuncts <span class="bound">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="free">φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FOr <span class="main">(</span>deriv <span class="free">d0</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> True <span class="skolem">x</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>deriv <span class="free">d0</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> False <span class="skolem">x</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>FEx <span class="free">k</span> <span class="var">?φ</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> FEx <span class="free">k</span> <span class="skolem">ψ</span>"</span></span>
        <span class="quoted"><span class="quoted">"nf_ACI <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"disjuncts <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="var">?φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="var">?φ</span><span class="main">⟩</span><span class="main">)</span> <span class="main">⊆</span>
          <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>Formula_Operations.deriv <span class="free">extend</span> <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_deriv_FOr nf_ACI_juncts nf_ACI_norm_ACI
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> notin_juncts subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> disjuncts_NFOR<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free">k</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">b</span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"disjuncts <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nf_ACI_norm_ACI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_deriv_FAll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="main">(</span>FAll <span class="free">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span>
    <span class="main">{</span>FAll <span class="free">k</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> nf_ACI <span class="bound">ψ</span> <span class="main">∧</span> conjuncts <span class="bound">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="free">φ</span><span class="main">⟩</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>FAll <span class="free">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> FAll <span class="free">k</span> <span class="bound">ψ</span> <span class="main">∧</span>
      nf_ACI <span class="bound">ψ</span> <span class="main">∧</span> conjuncts <span class="bound">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="free">φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"FAnd <span class="main">(</span>deriv <span class="free">d0</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> True <span class="skolem">x</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>deriv <span class="free">d0</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> False <span class="skolem">x</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>FAll <span class="free">k</span> <span class="var">?φ</span><span class="main">)</span><span class="main">⟩</span> <span class="main">=</span> FAll <span class="free">k</span> <span class="skolem">ψ</span>"</span></span>
        <span class="quoted"><span class="quoted">"nf_ACI <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"conjuncts <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="var">?φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="var">?φ</span><span class="main">⟩</span><span class="main">)</span> <span class="main">⊆</span>
          <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>Formula_Operations.deriv <span class="free">extend</span> <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_deriv_FAnd nf_ACI_juncts nf_ACI_norm_ACI
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> notin_juncts subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equalityD1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> conjuncts_NFAND<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free">k</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">b</span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"conjuncts <span class="skolem">ψ</span> <span class="main">⊆</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nf_ACI_norm_ACI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_norm_ACI_juncts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="free">f</span> <span class="bound">φ</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nf_ACI <span class="bound">φ</span> <span class="main">∧</span> disjuncts <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="free">f</span> <span class="bound">φ</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nf_ACI <span class="bound">φ</span> <span class="main">∧</span> conjuncts <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Pow_iff<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">o</span></span></span> NFOR <span class="keyword1"><span class="keyword1"><span class="keyword1">o</span></span></span> image norm_ACI"</span></span></span></span><span class="main"><span class="main">]</span></span>
    finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Pow_iff<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">f</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">o</span></span></span> NFAND <span class="keyword1"><span class="keyword1"><span class="keyword1">o</span></span></span> image norm_ACI"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Pow_def image_Collect <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_ACI_NFOR<span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_ACI_NFAND<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> Formula <span class="main">=</span> Formula_Operations
  <span class="keyword2"><span class="keyword">where</span></span> TYPEVARS <span class="main">=</span> <span class="quoted"><span class="free">TYPEVARS</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">TYPEVARS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">×</span> <span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'k</span> <span class="main">::</span> <span class="main">{</span>linorder<span class="main">,</span> enum<span class="main">}</span> <span class="main">×</span> <span class="tfree">'n</span> <span class="main">×</span> <span class="tfree">'x</span> <span class="main">×</span> <span class="tfree">'v</span>"</span></span> <span class="main">+</span>
  <span class="comment1">(* De Bruijn indices abstractly *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SUC_SUC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">SUC</span> <span class="free">k</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k'</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> <span class="free">SUC</span> <span class="free">k'</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k</span> <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> LEQ_0<span class="main">:</span> <span class="quoted"><span class="quoted">"LEQ <span class="free">k</span> <span class="main">0</span> <span class="free">idx</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> LESS_SUC<span class="main">:</span> <span class="quoted"><span class="quoted">"LEQ <span class="free">k</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">idx</span> <span class="main">=</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">l</span> <span class="free">idx</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">k'</span> <span class="main">⟹</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">l</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k'</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">l</span> <span class="free">idx</span>"</span></span>

  <span class="comment1">(* Interpretations *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> nvars_Extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">SUC</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Length_Extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">Length</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span><span class="free">len</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Length_0_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free">Length</span> <span class="free">𝔅</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔅</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ex_Length_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">𝔄</span><span class="main">.</span> <span class="free">Length</span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Extend_commute_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">;</span> LEQ <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="free">Extend</span> <span class="free">k</span> <span class="free">j</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">Extend</span> <span class="free">k</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="free">j</span> <span class="free">𝔄</span> <span class="free">Q</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Extend_commute_unsafe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">k'</span> <span class="main">⟹</span>
      <span class="free">Extend</span> <span class="free">k</span> <span class="free">j</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k'</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> <span class="free">Extend</span> <span class="free">k'</span> <span class="free">i</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="free">j</span> <span class="free">𝔄</span> <span class="free">Q</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> assigns_Extend<span class="main">:</span>  <span class="quoted"><span class="quoted">"LEQ <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span></sup><span class="hidden">⇖</span><span class="free">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="keyword1">else</span> dec <span class="free">i</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> assigns_SNOC_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">LESS</span> <span class="free">k</span> <span class="free">m</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">)</span> <span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">=</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Length_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="main">(</span><span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="free">Length</span> <span class="free">𝔄</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Length_SNOC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">Length</span> <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nvars_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="main">(</span><span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nvars_SNOC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Extend_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="main">(</span><span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
      <span class="free">CONS</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">eval</span> <span class="free">P</span> <span class="main">0</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> False<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="main">(</span><span class="free">downshift</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Extend_SNOC_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">len</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">Length</span> <span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
    <span class="free">SNOC</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">eval</span> <span class="free">P</span> <span class="main">(</span><span class="free">Length</span> <span class="free">𝔄</span><span class="main">)</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> False<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="main">(</span><span class="free">cut</span> <span class="main">(</span><span class="free">Length</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> CONS_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="free">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">⟹</span> <span class="free">size</span> <span class="free">y</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔅</span> <span class="main">⟹</span>
    <span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">CONS</span> <span class="free">y</span> <span class="free">𝔅</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> CONS_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="free">𝔄</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">x</span> <span class="bound">𝔅</span><span class="main">.</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">CONS</span> <span class="bound">x</span> <span class="bound">𝔅</span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="free">idx</span> <span class="main">∧</span> <span class="free">size</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>

  <span class="comment1">(* Alphabet elements *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> size_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> size_extend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="main">(</span><span class="free">extend</span> <span class="free">k</span> <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">SUC</span> <span class="free">k</span> <span class="main">(</span><span class="free">size</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> distinct_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">alphabet</span> <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> alphabet_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">alphabet</span> <span class="free">idx</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">size</span> <span class="free">x</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>

  <span class="comment1">(* Valuations *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> downshift_upshift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">downshift</span> <span class="main">(</span><span class="free">upshift</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> downshift_add_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">downshift</span> <span class="main">(</span><span class="free">add</span> <span class="main">0</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">downshift</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="main">(</span><span class="free">add</span> <span class="free">n</span> <span class="free">P</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval_upshift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">eval</span> <span class="main">(</span><span class="free">upshift</span> <span class="free">P</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval_ge_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≥</span> <span class="free">len</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">eval</span> <span class="free">P</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len_cut_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span><span class="free">cut</span> <span class="free">n</span> <span class="free">P</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len_cut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">cut</span> <span class="free">n</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cut_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="free">n</span> <span class="main">(</span><span class="free">add</span> <span class="free">m</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">≥</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="free">cut</span> <span class="free">n</span> <span class="free">P</span> <span class="keyword1">else</span> <span class="free">add</span> <span class="free">m</span> <span class="main">(</span><span class="free">cut</span> <span class="free">n</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span><span class="free">add</span> <span class="free">m</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">len</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len_upshift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span><span class="free">upshift</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">len</span> <span class="free">P</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="bound">n</span> <span class="main">⇒</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> len_downshift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span><span class="free">downshift</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">len</span> <span class="free">P</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

  <span class="comment1">(* Function extensions for the base cases *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> wf0_decr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k</span> <span class="free">idx</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">l</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k</span> <span class="free">idx</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> <span class="free">find0</span> <span class="free">k</span> <span class="free">l</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">wf0</span> <span class="free">idx</span> <span class="main">(</span><span class="free">decr0</span> <span class="free">k</span> <span class="free">l</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lformula0_decr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">lformula0</span> <span class="main">(</span><span class="free">decr0</span> <span class="free">k</span> <span class="free">l</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Extend_satisfies0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> <span class="free">find0</span> <span class="free">k</span> <span class="free">i</span> <span class="free">a</span><span class="main">;</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free">lformula0</span> <span class="free">a</span> <span class="main">∨</span> <span class="free">len</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">Length</span> <span class="free">𝔄</span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">decr0</span> <span class="free">k</span> <span class="free">i</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nullable0_satisfies0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">nullable0</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> satisfies0_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔅</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔅</span> <span class="main">⟹</span> <span class="free">lformula0</span> <span class="free">a</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> <span class="free">LESS</span> <span class="bound">k</span> <span class="bound">m</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔅</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="bound">k</span> <span class="main">=</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔅</span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">𝔅</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wf_lderiv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="free">idx</span> <span class="free">a</span><span class="main">;</span> <span class="free">lformula0</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span><span class="free">lderiv0</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lformula_lderiv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="free">a</span> <span class="main">⟹</span> lformula <span class="main">(</span><span class="free">lderiv0</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wf_rderiv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free">idx</span> <span class="free">a</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span><span class="free">rderiv0</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> satisfies_lderiv0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span><span class="main">;</span> <span class="free">lformula0</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> <span class="free">lderiv0</span> <span class="free">x</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> satisfies_bounded_lderiv0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span><span class="main">;</span> <span class="free">lformula0</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">lderiv0</span> <span class="free">x</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> satisfies_bounded_rderiv0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">rderiv0</span> <span class="free">x</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">SNOC</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> find0_FV0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="free">idx</span> <span class="free">a</span><span class="main">;</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">l</span> <span class="free">idx</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">find0</span> <span class="free">k</span> <span class="free">l</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">∈</span> <span class="free">FV0</span> <span class="free">k</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_FV0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">FV0</span> <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wf0_FV0_LESS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">wf0</span> <span class="free">idx</span> <span class="free">a</span><span class="main">;</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">FV0</span> <span class="free">k</span> <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">v</span> <span class="free">idx</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> restrict_Restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">=</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">restrict</span> <span class="free">k</span> <span class="free">P</span> <span class="main">⟷</span> satisfies_gen <span class="free">r</span> <span class="free">𝔄</span> <span class="main">(</span><span class="free">Restrict</span> <span class="free">k</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wf_Restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">LESS</span> <span class="free">k</span> <span class="free">i</span> <span class="free">idx</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span><span class="free">Restrict</span> <span class="free">k</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lformula_Restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="main">(</span><span class="free">Restrict</span> <span class="free">k</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_lderiv0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="free">a</span> <span class="main">⟹</span> finite <span class="main">{</span>fold lderiv <span class="bound">xs</span> <span class="main">(</span>FBase <span class="free">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_rderiv0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold rderiv <span class="bound">xs</span> <span class="main">(</span>FBase <span class="free">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Formula
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔅</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> <span class="free">LESS</span> <span class="bound">k</span> <span class="bound">m</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="bound">k</span> <span class="main">=</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔅</span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">𝔄</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔅</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">𝔅</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEx <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FEx.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔅</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FEx.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend assigns_Extend dec_def gr0_conv_Suc LEQ_0 LESS_SUC<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAll <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FAll.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔅</span> <span class="bound">P</span> <span class="main">⊨</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FAll.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend assigns_Extend dec_def gr0_conv_Suc LEQ_0 LESS_SUC<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FNot.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">𝔄</span> <span class="main">⊨</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">𝔅</span> <span class="main">⊨</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> FNot.hyps<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> satisfies0_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_decr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="main">(</span><span class="free">SUC</span> <span class="free">k</span> <span class="free">idx</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> LEQ <span class="free">k</span> <span class="free">l</span> <span class="free">idx</span><span class="main">;</span> <span class="main">¬</span> find <span class="free">k</span> <span class="free">l</span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>decr <span class="free">k</span> <span class="free">l</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf0_decr0 LESS_SUC SUC_SUC<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_decr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>decr <span class="free">k</span> <span class="free">l</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula0_decr0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_satisfies_decr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> find <span class="free">k</span> <span class="free">i</span> <span class="free">φ</span><span class="main">;</span> LEQ <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> decr <span class="free">k</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_unsafe<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="main">0</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">P</span></span><span class="main"><span class="main">]</span></span> Extend_commute_safe
      Extend_satisfies0 nvars_Extend LESS_SUC SUC_SUC <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LEQ_SUC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">k'</span> <span class="main">⟹</span> LEQ <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="free">SUC</span> <span class="free">k'</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> LEQ <span class="free">k</span> <span class="free">i</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LESS_SUC<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> SUC_SUC<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_satisfies_bounded_decr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> find <span class="free">k</span> <span class="free">i</span> <span class="free">φ</span><span class="main">;</span> LEQ <span class="free">k</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">;</span> <span class="free">len</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">Length</span> <span class="free">𝔄</span><span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> decr <span class="free">k</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEx <span class="skolem">k'</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> FEx<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> FEx<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k'</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">Q</span> <span class="skolem">j</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_safe LESS_SUC Length_Extend nvars_Extend max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> FEx<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> FEx<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k'</span> <span class="skolem">j</span> <span class="skolem">𝔄</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">Q</span> <span class="skolem">j</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_unsafe LEQ_SUC Length_Extend nvars_Extend max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAll <span class="skolem">k'</span> <span class="skolem">φ</span><span class="main">)</span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> FAll<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> FAll<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k'</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">Q</span> <span class="skolem">j</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_safe LESS_SUC Length_Extend nvars_Extend max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> FAll<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> FAll<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k'</span> <span class="skolem">j</span> <span class="skolem">𝔄</span> <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">Q</span> <span class="skolem">j</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_unsafe LEQ_SUC Length_Extend nvars_Extend max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_satisfies0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Normalization›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>nFOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOr.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>nFAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAnd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFEx<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>FEx <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>nFEx <span class="free">b</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFEx.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SUC_SUC LEQ_0 LESS_SUC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gr0_conv_Suc wf_nFOr <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf0_decr0 wf_decr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFAll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>FAll <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>nFAll <span class="free">b</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAll.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SUC_SUC LEQ_0 LESS_SUC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gr0_conv_Suc wf_nFAnd <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf0_decr0 wf_decr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFNot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>nFNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFNot.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_nFOr wf_nFAnd wf_nFEx wf_nFAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nFOr wf_nFAnd wf_nFNot wf_nFEx wf_nFAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>FOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> lformula <span class="main">(</span>nFOr <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOr.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>FAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> lformula <span class="main">(</span>nFAnd <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAnd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFEx<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>FEx <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lformula <span class="main">(</span>nFEx <span class="free">b</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFEx.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_nFOr lformula0_decr0 lformula_decr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFAll<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>FAll <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lformula <span class="main">(</span>nFAll <span class="free">b</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAll.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_nFAnd lformula0_decr0 lformula_decr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFNot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>FNot <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> lformula <span class="main">(</span>nFNot <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFNot.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_nFOr lformula_nFAnd lformula_nFEx lformula_nFAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lformula_nFOr lformula_nFAnd lformula_nFNot
    lformula_nFEx lformula_nFAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_nFOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="main">⊨</span> nFOr <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> FOr <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_nFAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="main">⊨</span> nFAnd <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> FAnd <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAnd.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_nFEx<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> nFEx <span class="free">b</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> FEx <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFEx.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_nFOr Extend_satisfies_decr
      LEQ_0 LESS_SUC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nvars_Extend Extend_satisfies0 Extend_commute_safe Extend_commute_unsafe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_nFAll<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> nFAll <span class="free">b</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> FAll <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAll.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_nFAnd Extend_satisfies_decr
      Extend_satisfies0 LEQ_0 LESS_SUC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nvars_Extend Extend_commute_safe Extend_commute_unsafe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_nFNot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> nFNot <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> FNot <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_nFOr satisfies_nFAnd satisfies_nFEx satisfies_nFAll
    lformula_nFNot<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> norm <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> satisfies_nFOr satisfies_nFAnd satisfies_nFNot satisfies_nFEx satisfies_nFAll
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lformula_norm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFOr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFOr <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> FOr <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOr.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFAnd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFAnd <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> FAnd <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAnd.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_cut_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span><span class="free">cut</span> <span class="main">0</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_0_eq len_cut_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFEx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFEx <span class="free">b</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> FEx <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFEx.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFOr Extend_satisfies_bounded_decr
      LEQ_0 LESS_SUC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nvars_Extend Length_Extend len_cut_0
      Extend_satisfies0 Extend_commute_safe Extend_commute_unsafe <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> ex_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">rotated</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="main">0</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFAll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFAll <span class="free">b</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> FAll <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAll.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFAnd Extend_satisfies_bounded_decr
      LEQ_0 LESS_SUC<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nvars_Extend Length_Extend len_cut_0
      Extend_satisfies0 Extend_commute_safe Extend_commute_unsafe <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> conjI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">rotated</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="main">0</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFNot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFNot <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> FNot <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFOr satisfies_bounded_nFAnd satisfies_bounded_nFEx satisfies_bounded_nFAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> norm <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFOr satisfies_bounded_nFAnd
      satisfies_bounded_nFNot satisfies_bounded_nFEx satisfies_bounded_nFAll<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derivatives of Formulas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">idx</span> <span class="free">φ</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>lderiv <span class="free">x</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_lderiv0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>lderiv <span class="free">x</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_lderiv0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_rderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>rderiv <span class="free">x</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rderiv0<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> satisfies_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> lderiv <span class="free">x</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEx <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FEx.prems FEx.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="skolem">k</span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend size_extend Extend_CONS
      downshift_upshift eval_add eval_upshift downshift_add_zero
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">0</span> <span class="main">(</span><span class="free">upshift</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">upshift</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAll <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FAll.prems FAll.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="skolem">k</span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend size_extend Extend_CONS
      downshift_upshift eval_add eval_upshift downshift_add_zero
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">0</span> <span class="main">(</span><span class="free">upshift</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">upshift</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_lderiv0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> satisfies_bounded_lderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> lderiv <span class="free">x</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">CONS</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEx <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> nvars_Extend size_extend Extend_CONS Length_CONS
    downshift_upshift eval_add eval_upshift downshift_add_zero len_add len_upshift len_downshift
  <span class="keyword1"><span class="command">from</span></span> FEx.prems FEx.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="skolem">k</span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">0</span> <span class="main">(</span><span class="free">upshift</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">upshift</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAll <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> nvars_Extend size_extend Extend_CONS Length_CONS
    downshift_upshift eval_add eval_upshift downshift_add_zero len_add len_upshift len_downshift
  <span class="keyword1"><span class="command">from</span></span> FAll.prems FAll.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="skolem">k</span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">0</span> <span class="main">(</span><span class="free">upshift</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">upshift</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounded_lderiv0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> satisfies_bounded_rderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">size</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> rderiv <span class="free">x</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">SNOC</span> <span class="free">x</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEx <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FEx.prems FEx.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="skolem">k</span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend size_extend Extend_SNOC_cut len_cut_le eval_ge_len 
      eval_add cut_add Length_SNOC len_add len_cut le_Suc_eq max_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="main">(</span><span class="free">Length</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">(</span><span class="free">Length</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAll <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> FAll.prems FAll.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Extend</span> <span class="skolem">k</span> <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="skolem">k</span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">P</span> <span class="skolem">b</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend size_extend Extend_SNOC_cut len_cut_le eval_ge_len 
      eval_add cut_add Length_SNOC len_add len_cut le_Suc_eq max_def
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="main">(</span><span class="free">Length</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">(</span><span class="free">Length</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounded_rderiv0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_norm_rderivs<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>norm <span class="main">∘</span> rderiv <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="free">k</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_norm wf_rderiv<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finiteness of Derivatives Modulo ACI›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fold_deriv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">d0</span> <span class="main">=</span> <span class="free">lderiv0</span> <span class="main">∧</span> lformula <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> <span class="free">d0</span> <span class="main">=</span> <span class="free">rderiv0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="free">φ</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>
      finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_imageI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_lderiv0<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
      finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_imageI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> finite_rderiv0<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FNot <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_deriv_FNot <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FNot<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_deriv_FOr <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> FOr<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_deriv_FAnd <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> FAnd<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FEx <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>disjuncts <span class="main">`</span> <span class="main">{</span><span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>FEx <span class="skolem">k</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> nf_ACI <span class="bound">ψ</span> <span class="main">∧</span> disjuncts <span class="bound">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> disjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_norm_ACI_juncts<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fold_deriv_FEx<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>FAll <span class="skolem">k</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>conjuncts <span class="main">`</span> <span class="main">{</span><span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>FAll <span class="skolem">k</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> nf_ACI <span class="bound">ψ</span> <span class="main">∧</span> conjuncts <span class="bound">ψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">xs</span><span class="main">.</span> conjuncts <span class="main">⟨</span>fold <span class="main">(</span>deriv <span class="free">d0</span><span class="main">)</span> <span class="bound">xs</span> <span class="skolem">φ</span><span class="main">⟩</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_norm_ACI_juncts<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fold_deriv_FAll<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_deriv_FBool<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>nFOR <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_nFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>nFAND <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAND.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_NFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>NFOR <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFOR_def o_apply lformula_nFOR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_NFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>NFAND <span class="free">Φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFAND_def o_apply lformula_nFAND <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_disjuncts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> disjuncts <span class="free">φ</span><span class="main">.</span> lformula <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> lformula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> disjuncts.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_conjuncts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> conjuncts <span class="free">φ</span><span class="main">.</span> lformula <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> lformula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> conjuncts.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_norm_ACI<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span> <span class="main">=</span> lformula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un
    lformula_NFOR lformula_disjuncts lformula_NFAND lformula_conjuncts<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span>
  finite_fold_lderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> finite <span class="main">{</span><span class="main">⟨</span>fold lderiv <span class="bound">xs</span> <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  finite_fold_rderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">⟨</span>fold rderiv <span class="bound">xs</span> <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> lformula_norm_ACI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nf_ACI_norm_ACI finite_fold_deriv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>nFOR <span class="free">φs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_nFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>nFAND <span class="free">φs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAND.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_NFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>NFOR <span class="free">Φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFOR_def o_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_nFOR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_NFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>NFAND <span class="free">Φ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFAND_def o_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_nFAND<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFOR <span class="free">φs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFOR.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFOr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_nFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> nFAND <span class="free">φs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nFAND.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFAnd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_NFOR<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> NFOR <span class="free">Φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFOR_def o_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFOR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_NFAND<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Φ</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> NFAND <span class="free">Φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="free">Φ</span><span class="main">.</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFAND_def o_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFAND<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_juncts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> disjuncts <span class="free">φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> conjuncts <span class="free">φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_norm_ACI<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span> <span class="main">=</span> wf <span class="free">idx</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_NFOR wf_NFAND ball_Un wf_juncts<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_disjuncts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span> <span class="main">∈</span> disjuncts <span class="free">φ</span><span class="main">.</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_conjuncts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> conjuncts <span class="free">φ</span><span class="main">.</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_norm_ACI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="main">⟨</span><span class="free">φ</span><span class="main">⟩</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_NFOR satisfies_bounded_NFAND
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> satisfies_bounded_disjuncts<span class="main"><span class="main">]</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> satisfies_bounded_conjuncts<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> satisfies_bounded_disjuncts<span class="main"><span class="main">]</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> satisfies_bounded_conjuncts<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_SNOCs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="main">(</span><span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span><span class="main">^^</span><span class="free">k</span><span class="main">)</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_SNOC<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_fold_rderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>fold rderiv <span class="main">(</span>replicate <span class="free">k</span> <span class="free">x</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_rderiv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_fold_rderiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">idx</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> <span class="free">size</span> <span class="free">x</span> <span class="main">=</span> <span class="free">idx</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> fold rderiv <span class="main">(</span>replicate <span class="free">k</span> <span class="free">x</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span><span class="main">^^</span><span class="free">k</span><span class="main">)</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_rderiv wf_rderiv nvars_SNOCs<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Emptiness Check›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">bool</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">idx</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fut_test</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">Φ</span><span class="main">)</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∉</span> set <span class="bound">Φ</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fut_step</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">Φ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>norm <span class="main">(</span>rderiv <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">,</span> <span class="bound">φ</span> <span class="main">#</span> <span class="bound">Φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fut_derivs</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>norm <span class="keyword1">o</span> rderiv <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span><span class="main">)</span><span class="main">^^</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fut_derivs_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>rderiv <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">(</span>fut_derivs <span class="free">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fut_derivs <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fut_derivs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fut_invariant</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">Φ</span><span class="main">)</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="bound">Φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">=</span> fut_derivs <span class="bound">k</span> <span class="free">ψ</span> <span class="main">∧</span> <span class="bound">Φ</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fut_derivs <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="bound">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fut_spec</span> <span class="free"><span class="bound"><span class="entity">φΦ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">φΦ</span></span></span><span class="main">)</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">𝔄</span><span class="main">.</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free">idx</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">φΦ</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">φ</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">φΦ</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fut_default</span> <span class="main">=</span>
  <span class="main">(</span><span class="free">ψ</span><span class="main">,</span> sorted_list_of_set <span class="main">{</span><span class="main">⟨</span>fold rderiv <span class="main">(</span>replicate <span class="bound">k</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">⟨</span><span class="free">ψ</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">k</span><span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fold_rderiv_zeros<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">⟨</span>fold rderiv <span class="main">(</span>replicate <span class="bound">k</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">⟨</span><span class="free">ψ</span><span class="main">⟩</span><span class="main">⟩</span> <span class="main">|</span> <span class="bound">k</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_fold_rderiv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fut</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> nFOR <span class="keyword1">else</span> nFAND<span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>while_default fut_default fut_test fut_step <span class="main">(</span><span class="free">ψ</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">ψ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> wf_fut_derivs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>fut_derivs <span class="free">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_norm wf_rderiv wf fut_derivs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_fut_derivs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> fut_derivs <span class="free">k</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span><span class="main">^^</span><span class="free">k</span><span class="main">)</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fut_derivs_def satisfies_bounded_rderiv satisfies_bounded_norm
    wf_norm_rderivs size_zero nvars_SNOC funpow_swap1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">SNOC</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span> wf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fut_init<span class="main">:</span> <span class="quoted"><span class="quoted">"fut_invariant <span class="main">(</span><span class="free">ψ</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fut_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fut_derivs_def wf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fut_spec_default<span class="main">:</span> <span class="quoted"><span class="quoted">"fut_spec fut_default"</span></span>
  <span class="keyword1"><span class="command">using</span></span> satisfies_bounded_fold_rderiv<span class="main">[</span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_norm_ACI wf<span class="main"><span class="main">]</span></span> sym size_zero<span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> fut_spec_def fut_default_def snd_conv
    set_sorted_list_of_set<span class="main">[</span><span class="operator">OF</span> finite_fold_rderiv_zeros<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_norm_ACI wf_fold_rderiv wf wf_norm_ACI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fold_replicate<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fut_invariant<span class="main">:</span> <span class="quoted"><span class="quoted">"fut_invariant <span class="free">φΦ</span> <span class="main">⟹</span> fut_test <span class="free">φΦ</span> <span class="main">⟹</span> fut_invariant <span class="main">(</span>fut_step <span class="free">φΦ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φΦ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fut_invariant_def wf_norm wf_rderiv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fut_terminate<span class="main">:</span> <span class="quoted"><span class="quoted">"fut_invariant <span class="free">φΦ</span> <span class="main">⟹</span> <span class="main">¬</span> fut_test <span class="free">φΦ</span> <span class="main">⟹</span> fut_spec <span class="free">φΦ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φΦ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> prod.case not_not<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">Φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fut_invariant <span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">Φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> φ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> fut_derivs <span class="skolem">i</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Φ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fut_derivs <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fut_derivs <span class="skolem">k</span> <span class="free">ψ</span> <span class="main">=</span> fut_derivs <span class="skolem">i</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fut_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">Φ</span> <span class="main">=</span> <span class="main">{</span>fut_derivs <span class="bound">k</span> <span class="free">ψ</span> <span class="main">|</span> <span class="bound">k</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Φ_def set_map set_rev set_upt <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fut_derivs <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> fut_derivs <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fut_derivs <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">=</span> fut_derivs <span class="main">(</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fut_derivs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> funpow_cycle_offset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI atLeastLessThan_iff le0 less_diff_conv mod_less_divisor zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fut_spec <span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">Φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fut_spec_def <span class="keyword1"><span class="command">using</span></span> satisfies_bounded_fut_derivs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_fut_derivs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fut_spec_while_default<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fut_spec <span class="main">(</span>while_default fut_default fut_test fut_step <span class="main">(</span><span class="free">ψ</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fut_invariant fut_terminate fut_init fut_spec_default <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> while_default_rule<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_fut<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> fut"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fut_spec_while_default <span class="keyword1"><span class="command">unfolding</span></span> fut_def fut_spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_nFOR wf_nFAND<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_fut<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> fut <span class="main">⟷</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fut_spec_while_default assms <span class="keyword1"><span class="command">unfolding</span></span> fut_def fut_spec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_bounded_nFOR satisfies_bounded_nFAND<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">finalize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>FEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> fut True <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>nFEx <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">finalize</span> <span class="main">(</span><span class="free">SUC</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>FAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> fut False <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>nFAll <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span><span class="free">finalize</span> <span class="main">(</span><span class="free">SUC</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>FOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>FAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>FNot <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FNot <span class="main">(</span><span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">finalize</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> aformula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">=</span> nullable <span class="keyword1">o</span> finalize <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_finalize<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>finalize <span class="free">idx</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_fut wf_nFEx wf_nFAll<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_SNOCs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="main">(</span><span class="main">(</span><span class="free">SNOC</span> <span class="free">x</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="free">Length</span> <span class="free">𝔄</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Length_SNOC<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_SNOCs_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">LESS</span> <span class="free">k</span> <span class="free">m</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="free">idx</span><span class="main">)</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">=</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assigns_SNOC_zero nvars_SNOC funpow_swap1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_SNOCs_zero_satisfies<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="main">(</span><span class="free">SUC</span> <span class="free">k</span> <span class="free">idx</span><span class="main">)</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="main">(</span><span class="main">(</span><span class="free">SNOC</span> <span class="main">(</span><span class="free">zero</span> <span class="main">(</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="free">i</span><span class="main">)</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> satisfies_eqI<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend nvars_SNOCs assigns_Extend assigns_SNOCs_zero LEQ_0 LESS_SUC
     dec_def gr0_conv_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finalize_satisfies<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">idx</span> <span class="free">φ</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> lformula <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> finalize <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_nFEx wf_nFAll wf_finalize Length_SNOCs nvars_Extend nvars_SNOCs
      satisfies_bounded_fut satisfies_bounded_nFEx satisfies_bounded_nFAll Extend_SNOCs_zero_satisfies
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_add2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_empty_satisfies0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free">len</span> <span class="free">P</span> <span class="main">=</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Extend</span> <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main"><span class="free">⊨<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ nullable0_satisfies0 nullable0_satisfies0<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nvars_Extend Length_Extend<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_empty_satisfies_bounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free">len</span> <span class="free">P</span> <span class="main">=</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Extend</span> <span class="free">k</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_empty_satisfies0 Length_Extend <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nullable_satisfies_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> nullable <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable0_satisfies0 Extend_empty_satisfies_bounded len_cut_0
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="main">0</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">P</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> final_satisfies<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">∧</span> lformula <span class="free">φ</span><span class="main">;</span> <span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">⟧</span> <span class="main">⟹</span> final <span class="free">idx</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="free">𝔄</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> final_def o_apply nullable_satisfies_bounded finalize_satisfies<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Restrictions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_gen_restrict_RESTR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"satisfies_gen <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="bound">P</span> <span class="bound">n</span><span class="main">.</span> <span class="free">restrict</span> <span class="bound">k</span> <span class="bound">P</span> <span class="main">∧</span> <span class="free">r</span> <span class="bound">k</span> <span class="bound">P</span> <span class="bound">n</span><span class="main">)</span> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> satisfies_gen <span class="free">r</span> <span class="free">𝔄</span> <span class="main">(</span>RESTR <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_Restrict<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assigns_Extend LEQ_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_FV<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV <span class="free">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_FV0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_gen_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"satisfies_gen <span class="free">r</span> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">V</span><span class="main">.</span> <span class="free">restrict</span> <span class="free">k</span> <span class="main">(</span><span class="bound">x</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
   satisfies_gen <span class="free">r</span> <span class="free">𝔄</span> <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> FAnd <span class="main">(</span><span class="free">Restrict</span> <span class="free">k</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">V</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_Restrict<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_vars_RESTRICT_VARS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">≡</span> sorted_list_of_set <span class="keyword1">o</span> FV <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set <span class="free">ks</span><span class="main">.</span> finite <span class="main">(</span>FV <span class="free">φ</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sat_vars_gen <span class="free">r</span> <span class="main">(</span>set <span class="free">ks</span><span class="main">)</span> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> satisfies_gen <span class="free">r</span> <span class="free">𝔄</span> <span class="main">(</span>RESTRICT_VARS <span class="free">ks</span> <span class="free">vs</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">ks</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> satisfies_gen_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RESTRICT_VARS <span class="skolem">ks</span> <span class="free">vs</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="skolem">k</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_gen_restrict_RESTR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_RESTRICT<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="main">⊨</span> RESTRICT <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sat_def RESTRICT_def <span class="keyword1"><span class="command">using</span></span> sat_vars_RESTRICT_VARS<span class="main">[</span><span class="operator">of</span> <span class="quoted">Enum.enum</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_FV enum_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat<span class="hidden">⇩</span><sub>b</sub>_RESTRICT<span class="main">:</span> <span class="quoted"><span class="quoted">"sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> RESTRICT <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sat<span class="hidden">⇩</span><sub>b</sub>_def RESTRICT_def <span class="keyword1"><span class="command">using</span></span> sat_vars_RESTRICT_VARS<span class="main">[</span><span class="operator">of</span> <span class="quoted">Enum.enum</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_FV enum_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_RESTR<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>RESTR <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_Restrict LESS_SUC LEQ_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_RESTRICT_VARS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">idx</span> <span class="free">φ</span><span class="main">;</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set <span class="free">ks</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">vs</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="free">LESS</span> <span class="bound">k</span> <span class="bound">v</span> <span class="free">idx</span><span class="main">⟧</span> <span class="main">⟹</span>
  wf <span class="free">idx</span> <span class="main">(</span>RESTRICT_VARS <span class="free">ks</span> <span class="free">vs</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">ks</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="skolem">vs</span><span class="main">.</span> <span class="free">LESS</span> <span class="skolem">k</span> <span class="bound">v</span> <span class="free">idx</span>"</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> FAnd <span class="main">(</span><span class="free">Restrict</span> <span class="skolem">k</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_Restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_RESTR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_FV_LESS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf <span class="free">idx</span> <span class="free">φ</span><span class="main">;</span> <span class="free">v</span> <span class="main">∈</span> FV <span class="free">φ</span> <span class="free">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">LESS</span> <span class="free">k</span> <span class="free">v</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf0_FV0_LESS LESS_SUC <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_RESTRICT<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="free">idx</span> <span class="free">φ</span> <span class="main">⟹</span> wf <span class="free">idx</span> <span class="main">(</span>RESTRICT <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RESTRICT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_RESTRICT_VARS<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff wf_FV_LESS finite_FV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_RESTR<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>RESTR <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_Restrict<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_RESTRICT_VARS<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>RESTRICT_VARS <span class="free">ks</span> <span class="free">vs</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ks</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">ks</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">vs</span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lformula <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> FAnd <span class="main">(</span><span class="free">Restrict</span> <span class="skolem">k</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_Restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lformula_RESTR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_RESTRICT<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lformula <span class="main">(</span>RESTRICT <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RESTRICT_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lformula_RESTRICT_VARS<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_fold_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">𝔅</span><span class="main">.</span> <span class="free">𝔄</span> <span class="main">=</span> fold <span class="free">CONS</span> <span class="bound">xs</span> <span class="bound">𝔅</span> <span class="main">∧</span> <span class="free">Length</span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">Length</span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="bound">xs</span> <span class="main">∧</span>
   <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> <span class="free">size</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="free">𝔄</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> CONS_surj <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">𝔅</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝔄</span> <span class="main">=</span> <span class="free">CONS</span> <span class="skolem">a</span> <span class="skolem">𝔅</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="skolem">𝔅</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="skolem">𝔄</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">size</span> <span class="skolem">a</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="skolem">𝔄</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="skolem">𝔅</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Length_CONS<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">𝔅</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ℭ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝔅</span> <span class="main">=</span> fold <span class="free">CONS</span> <span class="skolem">xs</span> <span class="skolem">ℭ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="skolem">ℭ</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Length</span> <span class="skolem">𝔅</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="skolem">ℭ</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="skolem">𝔅</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">size</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="skolem">𝔅</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ℭ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Length_CONS<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">L</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> Lang <span class="main">(</span><span class="main">∃</span><span class="bound">𝔄</span><span class="main">.</span> <span class="free">Length</span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> <span class="bound">𝔄</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">size</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="keyword1">then</span> <span class="free">L</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">{</span><span class="bound">𝔅</span><span class="main">.</span> <span class="free">CONS</span> <span class="bound">a</span> <span class="bound">𝔅</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span> <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"L <span class="free">idx</span> <span class="main">{}</span> <span class="main">=</span> Zero"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> L_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"L <span class="free">idx</span> <span class="free">I</span> <span class="main">=</span>
    to_language <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">𝔄</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">𝔅</span><span class="main">.</span> <span class="bound">𝔄</span> <span class="main">=</span> fold <span class="free">CONS</span> <span class="main">(</span>rev <span class="bound">xs</span><span class="main">)</span> <span class="bound">𝔅</span> <span class="main">∧</span> <span class="free">Length</span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
      <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="free">idx</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> <span class="free">size</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">idx</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L_empty <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">to_language</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> L <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">{</span><span class="bound">𝔄</span><span class="main">.</span> <span class="bound">𝔄</span> <span class="main">⊨</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lang<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> L <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">{</span><span class="bound">𝔄</span><span class="main">.</span> <span class="bound">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> L <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">{</span><span class="bound">𝔄</span><span class="main">.</span> sat <span class="bound">𝔄</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">language<span class="hidden">⇩</span><sub>b</sub></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> L <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">{</span><span class="bound">𝔄</span><span class="main">.</span> sat<span class="hidden">⇩</span><sub>b</sub> <span class="bound">𝔄</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"lformula <span class="free">φ</span> <span class="main">⟹</span> lang <span class="free">n</span> <span class="main">(</span>norm <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">n</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang_def <span class="keyword1"><span class="command">using</span></span> satisfies_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_language_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> in_language Zero <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_language_L_size<span class="main">:</span> <span class="quoted"><span class="quoted">"in_language <span class="main">(</span>L <span class="free">idx</span> <span class="free">I</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">w</span> <span class="main">⟹</span> <span class="free">size</span> <span class="free">x</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Formula <span class="main">&lt;</span>
  bounded<span class="main">:</span> DA <span class="quoted"><span class="quoted">"<span class="free">alphabet</span> <span class="free">idx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>RESTRICT <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>lderiv <span class="bound">a</span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"nullable"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> lformula <span class="bound">φ</span>"</span></span> <span class="quoted"><span class="quoted">"lang<span class="hidden">⇩</span><sub>b</sub> <span class="free">idx</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> lformula <span class="bound">φ</span>"</span></span> <span class="quoted"><span class="quoted">"language<span class="hidden">⇩</span><sub>b</sub> <span class="free">idx</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">idx</span>
  <span class="keyword1"><span class="command">using</span></span> ex_Length_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">idx</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_norm lformula_lderiv distinct_alphabet alphabet_size wf_norm wf_lderiv
    lang<span class="hidden">⇩</span><sub>b</sub>_def language<span class="hidden">⇩</span><sub>b</sub>_def nullable_satisfies_bounded wf_RESTRICT lformula_RESTRICT sat<span class="hidden">⇩</span><sub>b</sub>_RESTRICT
    satisfies_bounded_norm in_language_L_size satisfies_bounded_lderiv nvars_CONS
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Length_0_inj <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"L <span class="main">(</span><span class="free">size</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> Formula <span class="main">&lt;</span>
  unbounded<span class="main">?</span><span class="main">:</span> DA <span class="quoted"><span class="quoted">"<span class="free">alphabet</span> <span class="free">idx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>RESTRICT <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>lderiv <span class="bound">a</span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"final <span class="free">idx</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> lformula <span class="bound">φ</span>"</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">idx</span>"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> lformula <span class="bound">φ</span>"</span></span> <span class="quoted"><span class="quoted">"language <span class="free">idx</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">idx</span>
  <span class="keyword1"><span class="command">using</span></span> ex_Length_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">idx</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lformula_norm lformula_lderiv distinct_alphabet alphabet_size wf_norm wf_lderiv
    lang_def language_def final_satisfies wf_RESTRICT lformula_RESTRICT sat_RESTRICT
    satisfies_norm in_language_L_size satisfies_lderiv nvars_CONS
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Length_0_inj <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"L <span class="main">(</span><span class="free">size</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Formula<span class="main">)</span> check_eqv_soundness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> sat <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> sat <span class="free">𝔄</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_fold_CONS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> language_def L_alt set_eq_iff
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> soundness<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rel_language_eq<span class="main"><span class="main">]</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij_is_inj<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> to_language_bij<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> Length_0_inj rev_rev_ident set_rev<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Formula<span class="main">)</span> bounded_check_eqv_soundness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1"><span class="free">#<span class="hidden">⇩</span><sub>V</sub></span></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> bounded.check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_fold_CONS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝔄</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> language<span class="hidden">⇩</span><sub>b</sub>_def L_alt set_eq_iff
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bounded.soundness<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rel_language_eq<span class="main"><span class="main">]</span></span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bij_is_inj<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> to_language_bij<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> Length_0_inj rev_rev_ident set_rev<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WS1S_Prelim">
<div class="head">
<h1>Theory WS1S_Prelim</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹WS1S Interpretations›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Prelim
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="FSet_More.html">FSet_More</a>
  <a href="../Deriving/Compare_Instances.html">Deriving.Compare_Instances</a>
  <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> cut
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">downshift</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">upshift</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Suc <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> finsert <span class="main">0</span> <span class="main">(</span>upshift <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1">else</span> upshift <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">snoc</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> finsert <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> ffilter <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> order <span class="main">=</span> FO <span class="main">|</span> SO
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">order</span>
<span class="keyword1"><span class="command">instantiation</span></span> order <span class="main">::</span> <span class="quoted">enum</span> <span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_order</span></span> <span class="main">=</span> <span class="main">[</span>FO<span class="main">,</span> SO<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_all_order</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> FO <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> SO<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_ex_order</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> FO <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> SO<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> enum_defs <span class="main">=</span> enum_order_def enum_all_order_def enum_ex_order_def
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> enum_defs<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> order.exhaust<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">typedef</span></span> idx <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UNIV_witness<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_idx

<span class="keyword1"><span class="command">lift_definition</span></span> SUC <span class="main">::</span> <span class="quoted"><span class="quoted">"order <span class="main">⇒</span> idx <span class="main">⇒</span> idx"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ord</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ord</span> <span class="keyword1">of</span> FO <span class="main">⇒</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">|</span> SO <span class="main">⇒</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> LESS <span class="main">::</span> <span class="quoted"><span class="quoted">"order <span class="main">⇒</span> nat <span class="main">⇒</span> idx <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ord</span> <span class="bound">l</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ord</span> <span class="keyword1">of</span> FO <span class="main">⇒</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">|</span> SO <span class="main">⇒</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">LEQ</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">≡</span> LESS <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>SUC <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">MSB</span> <span class="free"><span class="bound"><span class="entity">Is</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> <span class="main">∀</span><span class="bound">P</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Is</span></span></span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>Max <span class="main">(</span><span class="main">⋃</span><span class="bound">P</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">Is</span></span></span><span class="main">.</span> fset <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MSB <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MSB <span class="main">(</span><span class="free">I</span> <span class="main">#</span> <span class="free">Is</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="keyword1">if</span> <span class="free">I</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>MSB <span class="free">Is</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def <span class="keyword1"><span class="command">including</span></span> fset.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_Un list_all_iff Sup_bot_conv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Sup_bot_conv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MSB <span class="main">(</span><span class="free">I1</span> <span class="main">@</span> <span class="free">I2</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>MSB <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>MSB <span class="free">I2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I1</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_insert_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"MSB <span class="main">(</span>insert_nth <span class="free">n</span> <span class="free">P</span> <span class="free">Is</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>MSB <span class="free">Is</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_take_drop_id<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Is</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_nth_take_drop MSB_append MSB_Cons MSB_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_greater<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">&lt;</span> length <span class="free">Is</span><span class="main">;</span> <span class="free">p</span> <span class="main">|∈|</span> <span class="free">Is</span> <span class="main">!</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">&lt;</span> MSB <span class="free">Is</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bex_def in_set_conv_nth less_Suc_eq_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_ge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">I1</span> <span class="main">⊆</span> set <span class="free">I2</span> <span class="main">⟹</span> MSB <span class="free">I1</span> <span class="main">≤</span> MSB <span class="free">I2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def <span class="keyword1"><span class="command">including</span></span> fset.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_ge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_map_index'_CONS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"MSB <span class="main">(</span>map_index' <span class="free">i</span> <span class="main">(</span>lift <span class="free">bs</span><span class="main">)</span> <span class="free">Is</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> MSB <span class="free">Is</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">Is</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>MSB <span class="free">Is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Is</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_fMax_commute<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Suc</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mono_def
    lift_def upshift_def<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> atLeastLessThan_iff le_antisym not_less_eq_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_map_index'_SNOC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"MSB <span class="free">Is</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> MSB <span class="main">(</span>map_index' <span class="free">i</span> <span class="main">(</span>snoc <span class="free">n</span> <span class="free">bs</span><span class="main">)</span> <span class="free">Is</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">Is</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> MSB <span class="free">Is</span> <span class="keyword1">else</span> Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Is</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_fMax_commute<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Suc</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mono_def
    snoc_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff le_antisym not_less_eq_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_replicate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"MSB <span class="main">(</span>replicate <span class="free">n</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">typedef</span></span> interp <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">,</span> <span class="bound">I1</span> <span class="main">::</span> nat fset list<span class="main">,</span> <span class="bound">I2</span>  <span class="main">::</span> nat fset list<span class="main">)</span> <span class="main">|</span> <span class="bound">n</span> <span class="bound">I1</span> <span class="bound">I2</span><span class="main">.</span> MSB <span class="main">(</span><span class="bound">I1</span> <span class="main">@</span> <span class="bound">I2</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_interp

<span class="keyword1"><span class="command">lift_definition</span></span> assigns <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> interp <span class="main">⇒</span> order <span class="main">⇒</span> nat fset"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">⇗</span>_<span class="keyword1">⇖</span>_"</span> <span class="main">[</span>900<span class="main">,</span> 999<span class="main">,</span> 999<span class="main">]</span> 999<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">I1</span><span class="main">,</span> <span class="bound">I2</span><span class="main">)</span> <span class="bound">ord</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ord</span> <span class="keyword1">of</span> FO <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">I1</span> <span class="keyword1">then</span> <span class="bound">I1</span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">{||}</span>
    <span class="main">|</span> SO <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">I2</span> <span class="keyword1">then</span> <span class="bound">I2</span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">{||}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> nvars <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> idx"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> _"</span> <span class="main">[</span>1000<span class="main">]</span> 900<span class="main">)</span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">I1</span><span class="main">,</span> <span class="bound">I2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>length <span class="bound">I1</span><span class="main">,</span> length <span class="bound">I2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Length <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Extend <span class="main">::</span> <span class="quoted"><span class="quoted">"order <span class="main">⇒</span> nat <span class="main">⇒</span> interp <span class="main">⇒</span> nat fset <span class="main">⇒</span> interp"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ord</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">I1</span><span class="main">,</span> <span class="bound">I2</span><span class="main">)</span> <span class="bound">P</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ord</span> <span class="keyword1">of</span>
      FO <span class="main">⇒</span> <span class="main">(</span>max <span class="bound">n</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> insert_nth <span class="bound">i</span> <span class="bound">P</span> <span class="bound">I1</span><span class="main">,</span> <span class="bound">I2</span><span class="main">)</span>
    <span class="main">|</span> SO <span class="main">⇒</span> <span class="main">(</span>max <span class="bound">n</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">I1</span><span class="main">,</span> insert_nth <span class="bound">i</span> <span class="bound">P</span> <span class="bound">I2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> MSB_mono <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert_nth_take_drop <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> CONS <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> <span class="main">⇒</span> interp <span class="main">⇒</span> interp"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">bs1</span><span class="main">,</span> <span class="bound">bs2</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">I1</span><span class="main">,</span> <span class="bound">I2</span><span class="main">)</span><span class="main">.</span>
   <span class="main">(</span>Suc <span class="bound">n</span><span class="main">,</span> map_index <span class="main">(</span>lift <span class="bound">bs1</span><span class="main">)</span> <span class="bound">I1</span><span class="main">,</span> map_index <span class="main">(</span>lift <span class="bound">bs2</span><span class="main">)</span> <span class="bound">I2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> SNOC <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> <span class="main">⇒</span> interp <span class="main">⇒</span> interp"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">bs1</span><span class="main">,</span> <span class="bound">bs2</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">I1</span><span class="main">,</span> <span class="bound">I2</span><span class="main">)</span><span class="main">.</span>
   <span class="main">(</span>Suc <span class="bound">n</span><span class="main">,</span> map_index <span class="main">(</span>snoc <span class="bound">n</span> <span class="bound">bs1</span><span class="main">)</span> <span class="bound">I1</span><span class="main">,</span> map_index <span class="main">(</span>snoc <span class="bound">n</span> <span class="bound">bs2</span><span class="main">)</span> <span class="bound">I2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> atom <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list <span class="main">×</span> bool list"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zero <span class="main">::</span> <span class="quoted"><span class="quoted">"idx <span class="main">⇒</span> atom"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>replicate <span class="bound">m</span> False<span class="main">,</span> replicate <span class="bound">n</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span>
  <span class="main">λ</span><span class="main">(</span><span class="bound">bs1</span><span class="main">,</span> <span class="bound">bs2</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="keyword1">of</span> FO <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="bound">bs1</span><span class="main">,</span> <span class="bound">bs2</span><span class="main">)</span> <span class="main">|</span> SO <span class="main">⇒</span> <span class="main">(</span><span class="bound">bs1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="bound">bs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> size_atom <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">×</span> bool list <span class="main">⇒</span> idx"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">bs1</span><span class="main">,</span> <span class="bound">bs2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>length <span class="bound">bs1</span><span class="main">,</span> length <span class="bound">bs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> σ <span class="main">::</span> <span class="quoted"><span class="quoted">"idx <span class="main">⇒</span> atom list"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">bs</span><span class="main">.</span> <span class="main">(</span>take <span class="bound">n</span> <span class="bound">bs</span><span class="main">,</span> drop <span class="bound">n</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>List.n_lists <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">N</span><span class="main">)</span> <span class="main">[</span>True<span class="main">,</span> False<span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fMin_fimage_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">⟹</span> fMin <span class="main">(</span>Suc <span class="main">|`|</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>fMin <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fMin_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fMin_in<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMin_eq_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">⟹</span> fMin <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fMin_eqI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_nth_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"insert_nth <span class="free">i</span> <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">i</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">|</span> Suc <span class="bound">i</span> <span class="main">⇒</span> <span class="free">y</span> <span class="main">#</span> insert_nth <span class="bound">i</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_nth_commute<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_nth <span class="free">j</span> <span class="free">y</span> <span class="main">(</span>insert_nth <span class="free">i</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insert_nth <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">(</span>insert_nth <span class="free">j</span> <span class="free">y</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert_nth_take_drop <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> SUC_SUC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"SUC <span class="free">ord</span> <span class="main">(</span>SUC <span class="free">ord'</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> SUC <span class="free">ord'</span> <span class="main">(</span>SUC <span class="free">ord</span> <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LESS_SUC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"LESS <span class="free">ord</span> <span class="main">0</span> <span class="main">(</span>SUC <span class="free">ord</span> <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"LESS <span class="free">ord</span> <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>SUC <span class="free">ord</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> LESS <span class="free">ord</span> <span class="free">l</span> <span class="free">idx</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ord</span> <span class="main">≠</span> <span class="free">ord'</span> <span class="main">⟹</span> LESS <span class="free">ord</span> <span class="free">l</span> <span class="main">(</span>SUC <span class="free">ord'</span> <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> LESS <span class="free">ord</span> <span class="free">l</span> <span class="free">idx</span>"</span></span>
  <span class="quoted"><span class="quoted">"LESS <span class="free">ord</span> <span class="free">l</span> <span class="free">idx</span> <span class="main">⟹</span> LESS <span class="free">ord</span> <span class="free">l</span> <span class="main">(</span>SUC <span class="free">ord'</span> <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_Extend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>Extend <span class="free">ord</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> SUC <span class="free">ord</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_Extend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Length <span class="main">(</span>Extend <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>fMax <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">split</span> if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_Extend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"LEQ <span class="free">ord</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span><span class="free">m</span><span class="hidden">⇗</span><sup>Extend <span class="free">ord</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span></sup><span class="hidden">⇖</span><span class="free">ord</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">&gt;</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="keyword1">else</span> <span class="free">m</span><span class="main">)</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ord</span> <span class="main">≠</span> <span class="free">ord'</span> <span class="main">⟹</span> <span class="free">m</span><span class="hidden">⇗</span><sup>Extend <span class="free">ord</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span></sup><span class="hidden">⇖</span><span class="free">ord'</span> <span class="main">=</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_commute_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">;</span> LEQ <span class="free">ord</span> <span class="free">i</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    Extend <span class="free">ord</span> <span class="free">j</span> <span class="main">(</span>Extend <span class="free">ord</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P1</span><span class="main">)</span> <span class="free">P2</span> <span class="main">=</span> Extend <span class="free">ord</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Extend <span class="free">ord</span> <span class="free">j</span> <span class="free">𝔄</span> <span class="free">P2</span><span class="main">)</span> <span class="free">P1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert_nth_take_drop <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_commute_unsafe<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ord</span> <span class="main">≠</span> <span class="free">ord'</span> <span class="main">⟹</span> Extend <span class="free">ord</span> <span class="free">j</span> <span class="main">(</span>Extend <span class="free">ord'</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P1</span><span class="main">)</span> <span class="free">P2</span> <span class="main">=</span> Extend <span class="free">ord'</span> <span class="free">i</span> <span class="main">(</span>Extend <span class="free">ord</span> <span class="free">j</span> <span class="free">𝔄</span> <span class="free">P2</span><span class="main">)</span> <span class="free">P1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> replicate_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_CONS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Length <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_SNOC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Length <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_CONS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_SNOC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_CONS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> size_atom <span class="free">bs1_bs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LESS <span class="free">ord</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="hidden">⇗</span><sup>CONS <span class="free">bs1_bs2</span> <span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> case_prod case_order <span class="free">bs1_bs2</span> <span class="free">ord</span> <span class="main">!</span> <span class="free">x</span> <span class="keyword1">then</span> finsert <span class="main">0</span> <span class="main">(</span>upshift <span class="main">(</span><span class="free">x</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> upshift <span class="main">(</span><span class="free">x</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lift_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_SNOC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> size_atom <span class="free">bs1_bs2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LESS <span class="free">ord</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="hidden">⇗</span><sup>SNOC <span class="free">bs1_bs2</span> <span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> case_prod case_order <span class="free">bs1_bs2</span> <span class="free">ord</span> <span class="main">!</span> <span class="free">x</span> <span class="keyword1">then</span> finsert <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">x</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">ord</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> snoc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_index'_eq_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_index' <span class="free">i</span> <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map_index' <span class="free">j</span> <span class="free">g</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fMax_Diff_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">m</span> <span class="main">|∈|</span> <span class="free">P</span> <span class="main">⟹</span> fMax <span class="main">(</span><span class="free">P</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span> <span class="main">=</span> fMax <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fMax_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fMax_in <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fMax_ge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_fMax_pred_fimage<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">p</span> <span class="main">|∈|</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">|∉|</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>fMax <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">|`|</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fMax <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mono_fMax_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> mono_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_CONS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> size_atom <span class="free">x</span> <span class="main">⟹</span> Extend <span class="free">ord</span> <span class="main">0</span> <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
  CONS <span class="main">(</span>extend <span class="free">ord</span> <span class="main">(</span>eval <span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Extend <span class="free">ord</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="main">(</span>downshift <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend_def o_def gr0_conv_Suc
    mono_fMax_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">Suc</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> mono_def<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
    lift_def upshift_def downshift_def eval_def
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fsubset_fsingletonD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_atom_extend<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_atom <span class="main">(</span>extend <span class="free">ord</span> <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> SUC <span class="free">ord</span> <span class="main">(</span>size_atom <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_atom_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_atom <span class="main">(</span>zero <span class="free">idx</span><span class="main">)</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interp_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Length <span class="free">𝔄</span> <span class="main">=</span> Length <span class="free">𝔅</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> LESS <span class="bound">k</span> <span class="bound">m</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="bound">k</span> <span class="main">=</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔅</span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_SNOC_cut<span class="main">[</span><span class="operator">unfolded</span> eval_def cut_def Length_SNOC<span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>len <span class="free">P</span> <span class="main">≤</span> Length <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> size_atom <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span>
  Extend <span class="free">ord</span> <span class="main">0</span> <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
    SNOC <span class="main">(</span>extend <span class="free">ord</span> <span class="main">(</span><span class="keyword1">if</span> eval <span class="free">P</span> <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="keyword1">then</span> True <span class="keyword1">else</span> False<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Extend <span class="free">ord</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="main">(</span>cut <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend_def len_def cut_def ffilter_eq_fempty_iff snoc_def eval_def
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits order.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fMax_ge fMax_boundedD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fMax_in<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_replicate_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="free">m</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">[]</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_eq_SucD<span class="main">:</span> <span class="quoted"><span class="quoted">"MSB <span class="free">Is</span> <span class="main">=</span> Suc <span class="free">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">P</span><span class="main">∈</span>set <span class="free">Is</span><span class="main">.</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="bound">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">Is</span><span class="main">.</span> fset <span class="bound">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmember_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_replicate_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> last <span class="free">xs</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> last <span class="free">ys</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> replicate <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> replicate <span class="free">n</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> assms'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> rev <span class="free">xs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> rev <span class="free">ys</span> <span class="main">!</span> <span class="main">0</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_rev hd_conv_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> replicate <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> replicate <span class="free">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> replicate <span class="free">m</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> rev <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">m</span> <span class="free">x</span> <span class="main">@</span> rev <span class="free">xs</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="free">x</span> <span class="main">@</span> rev <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>max <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">m</span> <span class="free">x</span> <span class="main">@</span> rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>max <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span> <span class="main">@</span> rev <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">m</span> <span class="free">x</span> <span class="main">@</span> take <span class="main">(</span>max <span class="free">m</span> <span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    replicate <span class="free">n</span> <span class="free">x</span> <span class="main">@</span> take <span class="main">(</span>max <span class="free">m</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>replicate <span class="free">m</span> <span class="free">x</span> <span class="main">@</span> take <span class="main">(</span>max <span class="free">m</span> <span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> min <span class="free">m</span> <span class="free">n</span> <span class="main">=</span>
    <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span> <span class="main">@</span> take <span class="main">(</span>max <span class="free">m</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> min <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted">length</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> assms' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bool.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> bool.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fin_lift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">|∈|</span> lift <span class="free">bs</span> <span class="free">i</span> <span class="main">(</span><span class="free">I</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">m</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="free">bs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="bound">m</span> <span class="main">|∈|</span> <span class="free">I</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lift_def upshift_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_Length_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">𝔄</span><span class="main">.</span> Length <span class="bound">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"replicate <span class="skolem">m</span> <span class="main">{||}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">m</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_empty_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Length <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> Length <span class="free">𝔅</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">metis</span> MSB_greater fMax_in less_nat_zero_code<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_σ_length_atom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>σ <span class="free">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">idx</span> <span class="main">=</span> size_atom <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_n_lists enum_UNIV image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">@</span> <span class="skolem">I2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">I1</span> <span class="skolem">I2</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_σ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>σ <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map distinct_n_lists set_n_lists inj_on_def
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> append_eq_append_conv<span class="main"><span class="main">]</span></span>
      box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ append_take_drop_id append_take_drop_id<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">n</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMin_less_Length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> fMin <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MSB_greater<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fMin_in <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMax_less_Length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> fMax <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span> <span class="main">&lt;</span> Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MSB_greater<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fMax_in <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_Length_fMin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> min <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span>fMin <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fMin <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fMin_less_Length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">m1</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fMin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_Length_fMin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> max <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span>fMin <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fMin_less_Length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">m1</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fMin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> min_Length_fMax<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> min <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span>fMax <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fMax <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fMax_less_Length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">m1</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fMax_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_Length_fMax<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> max <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span>fMax <span class="main">(</span><span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fMax_less_Length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">m1</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fMax_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_less_Length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">m1</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MSB_greater <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_notin_assigns<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span> <span class="main">|∉|</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length less_not_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"LESS <span class="free">ord</span> <span class="free">m</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> case_prod case_order <span class="main">(</span>zero <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">)</span> <span class="free">ord</span> <span class="main">!</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_fimage_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> Suc <span class="main">|`|</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> Suc <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fimage_Suc_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">|`|</span> <span class="free">A</span> <span class="main">=</span> Suc <span class="main">|`|</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_eq0_D<span class="main">:</span> <span class="quoted"><span class="quoted">"MSB <span class="free">I</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">I</span> <span class="main">⟹</span> <span class="free">I</span> <span class="main">!</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_in_fimage_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span> <span class="main">|∈|</span> Suc <span class="main">|`|</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_in_fimage_Suc_o_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span> <span class="main">|∈|</span> <span class="main">(</span>Suc <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">|`|</span> <span class="free">X</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">|∈|</span> Suc <span class="main">|`|</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finsert_same_eq_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finsert <span class="free">k</span> <span class="free">X</span> <span class="main">=</span> finsert <span class="free">k</span> <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">k</span><span class="main">|}</span> <span class="main">=</span> <span class="free">Y</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">k</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> fimage_Suc_o_Suc_eq_fimage_Suc_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Suc <span class="main">∘</span> Suc<span class="main">)</span> <span class="main">|`|</span> <span class="free">X</span> <span class="main">=</span> Suc <span class="main">|`|</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>Suc <span class="main">|`|</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fimage_Suc_inj fset.map_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fMax_image_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">P</span> <span class="main">⟹</span> fMax <span class="main">(</span>Suc <span class="main">|`|</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>fMax <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fMax_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Suc_le_mono fMax_ge fimageE<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> fimageI fempty_iff fMax_in<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fimage_Suc_eq_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fimage Suc <span class="free">Z</span> <span class="main">=</span> <span class="main">{|</span><span class="free">y</span><span class="main">|}</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">Z</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span> <span class="main">∧</span> Suc <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_downshift_helper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> <span class="free">P</span> <span class="main">⟹</span> Suc <span class="main">(</span>fMax <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="free">P</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fMax <span class="free">P</span> <span class="main">⟹</span> <span class="free">xa</span> <span class="main">|∈|</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">|∈|</span> <span class="free">P</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>fMax <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="free">P</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> fMax <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">|∈|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span> <span class="main">⟶</span> <span class="free">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">|∉|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">|∉|</span> <span class="free">P</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span> <span class="main">∧</span> <span class="free">xa</span> <span class="main">|∉|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">esk1<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a1 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_fMax_pred_fimage fMax_Diff_0 fminus_iff not0_implies_Suc<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xa</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_atom <span class="free">x</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">⟹</span> size_atom <span class="free">y</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">⟹</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span> <span class="main">⟹</span>
  CONS <span class="free">x</span> <span class="free">𝔄</span> <span class="main">=</span> CONS <span class="free">y</span> <span class="free">𝔅</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq lift_def upshift_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_minus1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">0</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_eq_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fset <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_fset.rep_eq fset_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_le_singleton_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fset <span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finsert.rep_eq fset_eq_empty_iff fset_inject order_refl singleton_insert_inj_eq subset_singletonD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> MSB_decreases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"MSB <span class="free">I</span> <span class="main">≤</span> Suc <span class="free">m</span> <span class="main">⟹</span> MSB <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">I1</span><span class="main">.</span> <span class="bound">I1</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="bound">X</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MSB_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le less_Suc_eq_le fset_eq_empty_iff fset_le_singleton_iff
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_le_iff<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_ge_iff<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_surj<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">x</span> <span class="bound">𝔅</span><span class="main">.</span> <span class="free">𝔄</span> <span class="main">=</span> CONS <span class="bound">x</span> <span class="bound">𝔅</span> <span class="main">∧</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">∧</span> size_atom <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc list_eq_iff_nth_eq lift_def upshift_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">0</span> <span class="main">|∈|</span> <span class="bound">X</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="bound">X</span> <span class="main">|-|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span><span class="main">)</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MSB_decreases upshift_def Suc_minus1 fimage_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_fBexI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
 
<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="WS1S_Formula">
<div class="head">
<h1>Theory WS1S_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete Atomic WS1S Formulas (Minimum Semantics for FO Variables)›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
  <a href="WS1S_Prelim.html">WS1S_Prelim</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>FOV0<span class="main">:</span> <span class="tfree">'fo</span><span class="main">,</span> SOV0<span class="main">:</span> <span class="tfree">'so</span><span class="main">)</span> atomic <span class="main">=</span>
  Fo <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="main">|</span>
  Eq_Const <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="quoted">nat</span> <span class="main">|</span>
  Less <span class="quoted"><span class="quoted">"bool option"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="main">|</span>
  Plus_FO <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="quoted">nat</span> <span class="main">|</span>
  Eq_FO <span class="quoted">bool</span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="main">|</span>
  Eq_SO <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Suc_SO <span class="quoted">bool</span> <span class="quoted">bool</span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Empty <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Singleton <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Subset <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  In <span class="quoted">bool</span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Eq_Max <span class="quoted">bool</span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Eq_Min <span class="quoted">bool</span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Eq_Union <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Eq_Inter <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Eq_Diff <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Disjoint <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="main">|</span>
  Eq_Presb <span class="quoted"><span class="quoted">"nat option"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">option</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">atomic</span> <span class="comment1">― ‹very slow›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> fo <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> so <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> ws1s <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fo<span class="main">,</span> so<span class="main">)</span> atomic"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> formula <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Less <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS FO <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Plus_FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS FO <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_FO <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS FO <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Suc_SO <span class="free"><span class="bound"><span class="entity">br</span></span></span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Max <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Min <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M3</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M3</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M3</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq_Presb <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lformula0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Const None <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Less None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_FO False <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Suc_SO False <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>In False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Max False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Min False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq_Presb None <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">lformula0</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declare</span></span> lformula0.intros<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> lformula0E<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lformula0 <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FV0</span> <span class="main">≡</span> case_order FOV0 SOV0"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Const <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Less <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Plus_FO <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_FO <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc_SO <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Max <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Max <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Min <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Min <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq_Presb <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">decr0</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> map_atomic <span class="main">(</span>case_order <span class="main">(</span>dec <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> id <span class="free"><span class="bound"><span class="entity">ord</span></span></span><span class="main">)</span> <span class="main">(</span>case_order id <span class="main">(</span>dec <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pow2_image_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> sum <span class="main">(</span><span class="main">(^)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> sum <span class="main">(</span><span class="main">(^)</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum.insert<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pow2_insert0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">X</span><span class="main">;</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span> sum <span class="main">(</span><span class="main">(^)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">0</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>sum <span class="main">(</span><span class="main">(^)</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum.insert<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pow2_upto<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">(^)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_pow2_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">X</span><span class="main">;</span> finite <span class="free">Y</span><span class="main">;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">Y</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="var">?f</span> <span class="free">X</span> <span class="main">=</span> <span class="var">?f</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_linorder_max_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">X</span> <span class="main">≤</span> <span class="var">?f</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">X</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">X</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trans<span class="main">[</span><span class="operator">OF</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> sum.insert<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">Y</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">Y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">x</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">y</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">Y</span>›</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order.refl sum.remove trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="skolem">Y</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">Y</span> <span class="main">≤</span> <span class="var">?f</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">Y</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">X</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">X</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> insert<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">Y</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_pow2_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(^)</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">(^)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageD<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_pow2_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq finite_pow2_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_pow2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_eq order.strict_iff_order<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ld_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> Suc <span class="free">n</span><span class="main">}</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_pow2<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> Suc <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="var">?m</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="main">≠</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{||}</span>
   <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> Length <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">=</span> <span class="bound">i</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>
   <span class="keyword1">else</span> fMin <span class="bound">P</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">;</span> <span class="bound">P2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{||}</span>
   <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some True <span class="main">⇒</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">|</span> Some False <span class="main">⇒</span> <span class="bound">P1</span> <span class="main">≠</span> <span class="main">{||}</span><span class="main">)</span>
   <span class="keyword1">else</span> fMin <span class="bound">P1</span> <span class="main">&lt;</span> fMin <span class="bound">P2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Plus_FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">;</span> <span class="bound">P2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{||}</span>
   <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Some <span class="main">0</span> <span class="main">⇒</span> <span class="bound">P1</span> <span class="main">=</span> <span class="bound">P2</span> <span class="main">|</span> Some <span class="bound">i</span> <span class="main">⇒</span> <span class="bound">P2</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">∧</span> fMin <span class="bound">P2</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">=</span> Length <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>
   <span class="keyword1">else</span> fMin <span class="bound">P1</span> <span class="main">=</span> fMin <span class="bound">P2</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">;</span> <span class="bound">P2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{||}</span>
   <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="bound">P1</span> <span class="main">=</span> <span class="bound">P2</span>
   <span class="keyword1">else</span> fMin <span class="bound">P1</span> <span class="main">=</span> fMin <span class="bound">P2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Suc_SO <span class="free"><span class="bound"><span class="entity">br</span></span></span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">br</span></span></span> <span class="keyword1">then</span> finsert <span class="main">(</span>Length <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span><span class="main">)</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="keyword1">then</span> finsert <span class="main">0</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="main">(</span>Suc <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">|⊆|</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> fMin <span class="bound">P</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">;</span> <span class="bound">P2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{||}</span>
   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> fMin <span class="bound">P1</span> <span class="main">=</span> fMax <span class="bound">P2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">;</span> <span class="bound">P2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{||}</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="bound">P1</span> <span class="main">=</span> <span class="bound">P2</span> <span class="keyword1">else</span> fMin <span class="bound">P1</span> <span class="main">=</span> fMin <span class="bound">P2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">|∩|</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">|-|</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">|∩|</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>fset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">l</span> <span class="main">⇒</span> Length <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">=</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lderiv0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FBool True <span class="keyword1">else</span> FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Const None <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FBool True
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Eq_Const None <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Less None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Less None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span><span class="main">|</span>
 <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_FO False <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_FO False <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBool True
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBool True
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>
  <span class="keyword1">else</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Const None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Suc_SO False <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span>
    <span class="keyword1">then</span> FBase <span class="main">(</span>Suc_SO False <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span>
    True <span class="main">⇒</span> FBool False
  <span class="main">|</span> False <span class="main">⇒</span> FBase <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span>
    True <span class="main">⇒</span> FBase <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> False <span class="main">⇒</span> FBase <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBool False
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>In False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>In False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBool True
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Max False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Max False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Min False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Min False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBool True
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>
   <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>
   <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>
   <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Presb None <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>
   <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Eq_Presb None <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ld</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ld</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ld</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ld</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">ld</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ld_alt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> ld <span class="free">n</span> <span class="main">=</span> Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_eqI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> ld <span class="free">n</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ld.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> ld <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ld.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> ld <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rderiv0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FBool True <span class="keyword1">else</span> FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span>
    False <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Const <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> Some <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">i</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
  <span class="main">|</span> True <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Const <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">of</span>
    False <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span>
      Some False <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="keyword1">of</span>
        True <span class="main">⇒</span> FBase <span class="main">(</span>Less <span class="main">(</span>Some True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
      <span class="main">|</span> False <span class="main">⇒</span> FBase <span class="main">(</span>Less <span class="main">(</span>Some False<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> True <span class="main">⇒</span> FBase <span class="main">(</span>Less <span class="main">(</span>Some False<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Plus_FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO <span class="main">(</span>Some <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="keyword1">of</span>
      True <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="main">|</span> False <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="keyword1">of</span>
        False <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO <span class="main">(</span>Some <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
        <span class="main">|</span> Some <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> True <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO <span class="main">(</span>Some <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Plus_FO None <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_FO True <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_FO False <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Suc_SO <span class="free"><span class="bound"><span class="entity">br</span></span></span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">br</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span>
    <span class="keyword1">then</span> FBase <span class="main">(</span>Suc_SO  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span>
    True <span class="main">⇒</span> FBool False
  <span class="main">|</span> False <span class="main">⇒</span> FBase <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span>
    True <span class="main">⇒</span> FBase <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> False <span class="main">⇒</span> FBase <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBool False
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>In True <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>In False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Eq_Max True <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Eq_Max False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>False<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Max True <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False
  <span class="main">|</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Min True <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBase <span class="main">(</span>Eq_Min False <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>
   <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>
   <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span>
   <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">then</span>
         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> FBool False
         <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> ld <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">in</span> FBase <span class="main">(</span>Eq_Presb <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> FBase <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main">0</span> <span class="main">⇒</span> FBool False
  <span class="main">|</span> Some <span class="main">(</span>Suc <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Presb <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq_Presb <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nullable0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Plus_FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Suc_SO <span class="free"><span class="bound"><span class="entity">br</span></span></span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">br</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span> <span class="free"><span class="bound"><span class="entity">M3</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">M1</span></span></span> <span class="free"><span class="bound"><span class="entity">M2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Some <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="keyword1">of</span> FO <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">|</span> SO <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Restrict</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="keyword1">of</span> FO <span class="main">⇒</span> FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">|</span> SO <span class="main">⇒</span> FBool True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span> <span class="main"><span class="main">=</span></span> 50<span class="main">]</span><span class="main">]</span>


<span class="keyword1"><span class="command">global_interpretation</span></span> WS1S<span class="main">:</span> Formula <span class="quoted">SUC</span> <span class="quoted">LESS</span> <span class="quoted">assigns</span> <span class="quoted">nvars</span> <span class="quoted">Extend</span> <span class="quoted">CONS</span> <span class="quoted">SNOC</span> <span class="quoted">Length</span>
  <span class="quoted">extend</span> <span class="quoted">size_atom</span> <span class="quoted">zero</span> <span class="quoted">σ</span> <span class="quoted">eval</span> <span class="quoted">downshift</span> <span class="quoted">upshift</span> <span class="quoted">finsert</span> <span class="quoted">cut</span> <span class="quoted">len</span> <span class="quoted">restrict</span> <span class="quoted">Restrict</span>
  <span class="quoted">lformula0</span> <span class="quoted">FV0</span> <span class="quoted">find0</span> <span class="quoted">wf0</span> <span class="quoted">decr0</span> <span class="quoted">satisfies0</span> <span class="quoted">nullable0</span> <span class="quoted">lderiv0</span> <span class="quoted">rderiv0</span> <span class="quoted">undefined</span>
  <span class="keyword2"><span class="keyword">defines</span></span> norm <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.norm find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFOr <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFOr <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFAnd <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFAnd <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFNot <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFNot find0 decr0 <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFEx <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFEx find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFAll <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFAll find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> decr <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.decr decr0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> find <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.find find0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> FV <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.FV FV0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> RESTR <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.RESTR Restrict <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> formula"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> RESTRICT <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.RESTRICT Restrict FV0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">d0</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="main">(</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">)</span><span class="main">.</span> Formula_Operations.deriv extend <span class="bound">d0</span> <span class="bound">a</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nullable <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> Formula_Operations.nullable nullable0 <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fut_default <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.fut_default extend zero rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fut <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.fut extend zero find0 decr0 rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finalize <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.finalize SUC extend zero find0 decr0 rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> final <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.final SUC extend zero find0 decr0
     nullable0 rderiv0 <span class="main">::</span> idx <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ws1s_wf <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC <span class="main">(</span>wf0 <span class="main">::</span> idx <span class="main">⇒</span> ws1s <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ws1s_lformula <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula lformula0 <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">final</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">final</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bounded_check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="free">nullable</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="free">nullable</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"DA.automaton
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> lderiv0 <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span> <span class="main">::</span> formula<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span>SUC <span class="skolem">k</span> <span class="skolem">idx</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">l</span> <span class="main">(</span>SUC <span class="skolem">k</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> find0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="main">(</span>decr0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> wf0.simps atomic.map find0.simps<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits order.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="main">(</span>decr0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> find0 <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">i</span> <span class="main">(</span>SUC <span class="skolem">k</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span> <span class="main">∨</span> len <span class="skolem">P</span> <span class="main">≤</span> Length <span class="skolem">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> disj <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies0 <span class="main">(</span>Extend <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>decr0 <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lformula0.induct<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits order.split option.splits bool.splits<span class="main">)</span> <span class="comment1">― ‹slow›</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">note</span></span> dec_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"len <span class="skolem">P</span> <span class="main">≤</span> Length <span class="skolem">𝔄</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Fo <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Eq_Const <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def len_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Less <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Plus_FO <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def len_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Eq_FO <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Eq_SO <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc_SO <span class="skolem">br</span> <span class="skolem">bl</span> <span class="skolem">M1</span> <span class="skolem">M2</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def len_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Singleton <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Subset <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> In <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_def max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.splits order.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC wf0 <span class="skolem">idx</span> <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lderiv0.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits order.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula lformula0 <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lderiv0.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.lformula.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC wf0 <span class="skolem">idx</span> <span class="main">(</span>rderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lderiv0.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps Let_def sorted_append
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits order.splits nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
  <span class="keyword1"><span class="command">note</span></span> fmember.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Length <span class="skolem">𝔄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nullable0 <span class="skolem">a</span> <span class="main">=</span> satisfies0 <span class="skolem">𝔄</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wf0.simps nullable0.simps satisfies0.simps Let_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MSB_greater <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits option.splits bool.splits nat.splits<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>  <span class="comment1">― ‹slow›</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword1"><span class="command">note</span></span> Formula_Operations.satisfies_gen.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> upshift_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> size_atom <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.satisfies Extend Length satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
     satisfies0 <span class="main">(</span>CONS <span class="skolem">x</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 18
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_pow2_image_Suc sum_pow2_insert0 image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword1"><span class="command">note</span></span> Formula_Operations.satisfies_gen.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> upshift_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> size_atom <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.satisfies_bounded Extend Length len satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
     satisfies0 <span class="main">(</span>CONS <span class="skolem">x</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> 18
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_pow2_image_Suc sum_pow2_insert0 image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword1"><span class="command">note</span></span> Formula_Operations.satisfies_gen.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> size_atom <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.satisfies_bounded Extend Length len satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>rderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
     satisfies0 <span class="main">(</span>SNOC <span class="skolem">x</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> Eq_Const <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits nat.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Less <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits bool.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fMin_less_Length less_not_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus_FO <span class="skolem">i</span> <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min.commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fMin_less_Length
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits nat.splits bool.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Eq_FO <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits bool.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fMin_less_Length less_not_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Eq_SO <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits bool.splits<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> assigns_less_Length finsertI1 less_not_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Suc_SO <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 2 1 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finsert_iff gr0_implies_Suc in_fimage_Suc nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finsert_iff in_fimage_Suc less_not_refl<span class="main">)</span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> fimage_finsert finsertE finsertI1 finsert_commute in_fimage_Suc n_not_Suc_n<span class="main">)</span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> assigns_less_Length order.strict_iff_order finsert_iff in_fimage_Suc not_less_eq_eq order_refl<span class="main">)</span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimageI finsert_iff less_irrefl_nat nat.inject<span class="main">)</span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> finsertE finsertI1 finsert_commute finsert_fminus_single in_fimage_Suc n_not_Suc_n<span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> assigns_less_Length finsertE fminus_finsert2 fminus_iff in_fimage_Suc lessI not_less_iff_gr_or_eq<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length finsert_iff lessI not_less_iff_gr_or_eq<span class="main">)</span>
               <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimage_finsert finsert_iff not_less_eq not_less_iff_gr_or_eq<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length order.strict_iff_order finsert_iff in_fimage_Suc not_less_eq_eq order_refl<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI assigns_less_Length fimageI finsert_iff le_eq_less_or_eq lessI less_imp_not_less<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimageE finsertI1 finsert_fminus_if fminus_finsert_absorb lessI less_not_sym<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length order.strict_iff_order finsert_iff not_less_eq_eq order_refl<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length order.strict_iff_order finsert_iff not_less_eq_eq order_refl<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimage_Suc_inj fimage_finsert finsert_absorb finsert_iff less_not_refl nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimage_Suc_inj fimage_finsert finsertI1 finsert_absorb less_not_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimage_Suc_inj fimage_finsert finsert_absorb finsert_iff less_not_refl nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length fimage_Suc_inj fimage_finsert finsertI1 finsert_absorb2 less_not_refl<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> In <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fMin_less_Length less_not_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_Max <span class="skolem">b</span> <span class="skolem">m</span> <span class="skolem">M</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> fMax_less_Length less_not_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> fMin_less_Length less_not_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Eq_Min <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> fMin_less_Length less_not_sym<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Eq_Union <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length less_not_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Eq_Inter <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length less_not_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> Eq_Diff <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length less_not_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">(^)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">note</span></span> fmember.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
     <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_Presb <span class="skolem">l</span> <span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fset <span class="main">(</span><span class="skolem">M</span><span class="hidden">⇗</span><sup><span class="skolem">𝔄</span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Length <span class="skolem">𝔄</span>"</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>insert <span class="var">?L</span> <span class="var">?M</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?f</span> <span class="var">?M</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">^</span> Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span>
     <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="var">?M</span> <span class="main">≤</span> <span class="var">?f</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="var">?L</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main">)</span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_pow2_upto<span class="main">)</span>
       <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="var">?M</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
     <span class="keyword1"><span class="command">}</span></span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?f</span> <span class="var">?M</span><span class="main">}</span> <span class="main">=</span> <span class="var">?L</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> Max_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
       <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?f</span> <span class="var">?M</span>"</span></span>
       <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
         <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">y</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le numeral_eq_Suc add_le_mono<span class="main">)</span>
         <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">+</span> <span class="var">?f</span> <span class="var">?M</span>›</span></span>
         <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span> <span class="main">≤</span> <span class="var">?f</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="var">?M</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> leI<span class="main">)</span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits nat.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="skolem">𝔅</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔅</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔅</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> LESS <span class="bound">k</span> <span class="bound">m</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔅</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="skolem">𝔄</span></sup><span class="hidden">⇖</span><span class="bound">k</span> <span class="main">=</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="skolem">𝔅</span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies0 <span class="skolem">𝔄</span> <span class="skolem">a</span> <span class="main">⟷</span> satisfies0 <span class="skolem">𝔅</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Formula_Operations.deriv extend lderiv0"</span></span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula set"</span></span>
     <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span>
         Fo <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Fo <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">}</span>
       <span class="main">|</span> Eq_Const None <span class="bound">m</span> <span class="bound">n</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Const None <span class="bound">m</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>FBool True<span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Less None <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Less None <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Fo <span class="bound">m2</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Plus_FO None <span class="bound">m1</span> <span class="bound">m2</span> <span class="bound">n</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Const None <span class="bound">m1</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span> <span class="main">∪</span>
          <span class="main">{</span>FBase <span class="main">(</span>Plus_FO None <span class="bound">m1</span> <span class="bound">m2</span> <span class="bound">n</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_FO False <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_FO False <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_SO <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_SO <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Suc_SO False <span class="bound">bl</span> <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Suc_SO False True <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Suc_SO False False <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span>
           FBool False<span class="main">}</span>
       <span class="main">|</span> Empty <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Empty <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Singleton <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Singleton <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Empty <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Subset <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Subset <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> In False <span class="bound">i</span> <span class="bound">I</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>In False <span class="bound">i</span> <span class="bound">I</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Max False <span class="bound">m</span> <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Max False <span class="bound">m</span> <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Empty <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Min False <span class="bound">m</span> <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Min False <span class="bound">m</span> <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Union <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Union <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Inter <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Inter <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Diff <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Diff <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Disjoint <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Disjoint <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Presb None <span class="bound">M</span> <span class="bound">n</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Presb None <span class="bound">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>FBool False<span class="main">}</span>
       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
     <span class="keyword1"><span class="command">note</span></span> Formula_Operations.fold_deriv_FBool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Formula_Operations.deriv.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Φ_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
     <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹lformula0 <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FBase <span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits list.splits bool.splits if_splits option.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">Φ</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lformula0 <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="skolem">d</span> <span class="bound">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Formula_Operations.deriv extend rderiv0"</span></span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula set"</span></span>
     <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span>
         Fo <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Fo <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBool True<span class="main">}</span>
       <span class="main">|</span> Eq_Const <span class="bound">i</span> <span class="bound">m</span> <span class="bound">n</span> <span class="main">⇒</span>
          <span class="main">{</span>FBase <span class="main">(</span>Eq_Const <span class="main">(</span>Some <span class="bound">j</span><span class="main">)</span> <span class="bound">m</span> <span class="bound">n</span><span class="main">)</span> <span class="main">|</span> <span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> max <span class="bound">i</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
          <span class="main">{</span>FBase <span class="main">(</span>Eq_Const None <span class="bound">m</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span>
       <span class="main">|</span> Less <span class="bound">b</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Less None <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Less <span class="main">(</span>Some True<span class="main">)</span> <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span>
          FBase <span class="main">(</span>Less <span class="main">(</span>Some False<span class="main">)</span> <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">}</span>
       <span class="main">|</span> Plus_FO <span class="bound">i</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="bound">n</span> <span class="main">⇒</span> 
          <span class="main">{</span>FBase <span class="main">(</span>Plus_FO <span class="main">(</span>Some <span class="bound">j</span><span class="main">)</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="bound">n</span><span class="main">)</span> <span class="main">|</span> <span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> max <span class="bound">i</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
          <span class="main">{</span>FBase <span class="main">(</span>Plus_FO None <span class="bound">m1</span> <span class="bound">m2</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span>
       <span class="main">|</span> Eq_FO <span class="bound">b</span> <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_FO True <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Eq_FO False <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">}</span>
       <span class="main">|</span> Eq_SO <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_SO <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Suc_SO <span class="bound">br</span> <span class="bound">bl</span> <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Suc_SO False True <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Suc_SO False False <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span>
           FBase <span class="main">(</span>Suc_SO True True <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Suc_SO True False <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Empty <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Empty <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Singleton <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Singleton <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Empty <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Subset <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Subset <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> In <span class="bound">b</span> <span class="bound">i</span> <span class="bound">I</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>In True <span class="bound">i</span> <span class="bound">I</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>In False <span class="bound">i</span> <span class="bound">I</span><span class="main">)</span><span class="main">}</span>
       <span class="main">|</span> Eq_Max <span class="bound">b</span> <span class="bound">m</span> <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Max False <span class="bound">m</span> <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Eq_Max True <span class="bound">m</span> <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Min <span class="bound">b</span> <span class="bound">m</span> <span class="bound">M</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Min False <span class="bound">m</span> <span class="bound">M</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Eq_Min True <span class="bound">m</span> <span class="bound">M</span><span class="main">)</span><span class="main">}</span>
       <span class="main">|</span> Eq_Union <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Union <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Inter <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Inter <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Diff <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Diff <span class="bound">M1</span> <span class="bound">M2</span> <span class="bound">M3</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Disjoint <span class="bound">M1</span> <span class="bound">M2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Disjoint <span class="bound">M1</span> <span class="bound">M2</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Eq_Presb <span class="bound">i</span> <span class="bound">M</span> <span class="bound">n</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq_Presb <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> <span class="bound">M</span> <span class="bound">j</span><span class="main">)</span> <span class="main">|</span> <span class="bound">j</span> <span class="bound">l</span> <span class="main">.</span>
           <span class="bound">j</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> max <span class="bound">i</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">i</span> <span class="keyword1">of</span> Some <span class="bound">i</span> <span class="main">⇒</span> max <span class="bound">i</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
           <span class="main">{</span>FBase <span class="main">(</span>Eq_Presb None <span class="bound">M</span> <span class="bound">n</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
     <span class="keyword1"><span class="command">note</span></span> Formula_Operations.fold_deriv_FBool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Formula_Operations.deriv.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Φ_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FBase <span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits option.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def Let_def not_le gr0_conv_Suc leD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ld_bounded<span class="main"><span class="main">]</span></span>
         <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits list.splits bool.splits if_splits option.splits nat.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">Φ</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="skolem">d</span> <span class="bound">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"find0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="main">⟷</span> <span class="skolem">l</span> <span class="main">∈</span> FV0 <span class="skolem">k</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find0.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">order</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV0 <span class="skolem">k</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="skolem">a</span> <span class="skolem">k</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> FV0 <span class="skolem">k</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">idx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="skolem">k</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">idx</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC wf0 <span class="skolem">idx</span> <span class="main">(</span>Restrict <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> Restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula lformula0 <span class="main">(</span>Restrict <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.lformula.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">𝔄</span> <span class="skolem">k</span> <span class="skolem">P</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="hidden">⇗</span><sup><span class="skolem">𝔄</span></sup><span class="hidden">⇖</span><span class="skolem">k</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">k</span> <span class="skolem">P</span> <span class="main">⟷</span>
    Formula_Operations.satisfies_gen Extend Length satisfies0 <span class="skolem">r</span> <span class="skolem">𝔄</span> <span class="main">(</span>Restrict <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> restrict_def Restrict_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.satisfies_gen.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_unsafe downshift_def upshift_def fimage_iff Suc_le_eq len_def
  dec_def eval_def cut_def len_downshift_helper <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> CONS_surj
  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fMax_ge fMax_ffilter_less fMax_boundedD fsubset_fsingletonD
  <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.splits if_splits<span class="main">)</span>

<span class="comment1">(*Workaround for code generation*)</span>
<span class="keyword1"><span class="command">lemma</span></span> check_eqv_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">idx</span> <span class="free">r</span> <span class="free">s</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>ws1s_wf <span class="free">idx</span> <span class="free">r</span> <span class="main">∧</span> ws1s_lformula <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>ws1s_wf <span class="free">idx</span> <span class="free">s</span> <span class="main">∧</span> ws1s_lformula <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> final <span class="free">idx</span> <span class="bound">p</span> <span class="main">=</span> final <span class="free">idx</span> <span class="bound">q</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span> norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>σ <span class="free">idx</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>norm <span class="main">(</span>RESTRICT <span class="free">r</span><span class="main">)</span><span class="main">,</span> norm <span class="main">(</span>RESTRICT <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> True
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def WS1S.check_eqv_def WS1S.step_alt <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">while</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">,</span> <span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">while</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> while_default <span class="main">(</span>fut_default <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> while_default_code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fut_default <span class="free">idx</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">idx</span> <span class="free">φ</span><span class="main">,</span> <span class="operator">folded</span> while_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> check_eqv_sound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>WS1S.sat <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> WS1S.sat <span class="free">𝔄</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WS1S.check_eqv_soundness<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_check_eqv_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> bounded_check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>WS1S.sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> WS1S.sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounded_check_eqv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WS1S.bounded_check_eqv_soundness<span class="main">)</span>

<span class="keyword1"><span class="command">method_setup</span></span> check_equiv <span class="main">=</span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">computation_check</span> <span class="quasi_keyword">terms</span><span class="main">:</span> <span class="quoted">Trueprop</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> nat"</span> <span class="quoted">Suc</span>
          <span class="quoted">"plus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"minus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"times <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"divide <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"modulo <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">::</span> int"</span>
          <span class="quoted">check_eqv</span> <span class="quasi_keyword">datatypes</span><span class="main">:</span> <span class="quoted">formula</span> <span class="quoted">"int list"</span> <span class="quoted">integer</span> <span class="quoted">idx</span>
         <span class="quoted">"nat <span class="main">×</span> nat"</span> <span class="quoted">"nat option"</span> <span class="quoted">"bool option"</span><span class="antiquote">}</span></span></span></span></span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        CONVERSION <span class="main">(</span>Conv.params_conv <span class="inner_numeral">~1</span> <span class="main">(</span>K <span class="main">(</span>Conv.concl_conv <span class="inner_numeral">~1</span> <span class="entity">conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">TrueI</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">tac</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WS1S_Alt_Formula">
<div class="head">
<h1>Theory WS1S_Alt_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete Atomic WS1S Formulas (Singleton Semantics for FO Variables)›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Alt_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
  <a href="WS1S_Prelim.html">WS1S_Prelim</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>FOV0<span class="main">:</span> <span class="tfree">'fo</span><span class="main">,</span> SOV0<span class="main">:</span> <span class="tfree">'so</span><span class="main">)</span> atomic <span class="main">=</span>
  Fo <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="main">|</span>
  Z <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="main">|</span>
  Less <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="main">|</span>
  In <span class="tfree"><span class="quoted"><span class="tfree">'fo</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'so</span></span></span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">atomic</span>

<span class="keyword1"><span class="command">type_synonym</span></span> fo <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> so <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> ws1s <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fo<span class="main">,</span> so<span class="main">)</span> atomic"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> formula <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS FO <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LESS FO <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">∧</span> LESS SO <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lformula0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">lformula0</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">declare</span></span> lformula0.intros<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> lformula0E<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lformula0 <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">FV0</span> <span class="main">≡</span> case_order FOV0 SOV0"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> FO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> SO <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>In <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">decr0</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> map_atomic <span class="main">(</span>case_order <span class="main">(</span>dec <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> id <span class="free"><span class="bound"><span class="entity">ord</span></span></span><span class="main">)</span> <span class="main">(</span>case_order id <span class="main">(</span>dec <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P1</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">;</span> <span class="bound">P2</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P1</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P2</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span>
   <span class="keyword1">then</span> False
   <span class="keyword1">else</span> fthe_elem <span class="bound">P1</span> <span class="main">&lt;</span> fthe_elem <span class="bound">P2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">P</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> fMin <span class="bound">P</span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lderiv0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FBase <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="keyword1">else</span> FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> FBool False <span class="keyword1">else</span> FBase <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>False<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>True<span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> FBase <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> FBool False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rev</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rev</span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> Z <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rev</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> Less <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rev</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> map_aformula rev id <span class="keyword1">o</span> lderiv0 <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">o</span> rev"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nullable0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Z <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fimage_Suc_fsubset0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">|`|</span> <span class="free">A</span> <span class="main">|⊆|</span> <span class="main">{|</span><span class="main">0</span><span class="main">|}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fsubset_singleton_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|⊆|</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{||}</span> <span class="main">∨</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="keyword1">of</span> FO <span class="main">⇒</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span> <span class="main">|</span> SO <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Restrict</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ord</span></span></span> <span class="keyword1">of</span> FO <span class="main">⇒</span> FBase <span class="main">(</span>Fo <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">|</span> SO <span class="main">⇒</span> FBool True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span> <span class="main"><span class="main">=</span></span> 50<span class="main">]</span><span class="main">]</span>


<span class="keyword1"><span class="command">global_interpretation</span></span> WS1S_Alt<span class="main">:</span> Formula <span class="quoted">SUC</span> <span class="quoted">LESS</span> <span class="quoted">assigns</span> <span class="quoted">nvars</span> <span class="quoted">Extend</span> <span class="quoted">CONS</span> <span class="quoted">SNOC</span> <span class="quoted">Length</span>
  <span class="quoted">extend</span> <span class="quoted">size_atom</span> <span class="quoted">zero</span> <span class="quoted">σ</span> <span class="quoted">eval</span> <span class="quoted">downshift</span> <span class="quoted">upshift</span> <span class="quoted">finsert</span> <span class="quoted">cut</span> <span class="quoted">len</span> <span class="quoted">restrict</span> <span class="quoted">Restrict</span>
  <span class="quoted">lformula0</span> <span class="quoted">FV0</span> <span class="quoted">find0</span> <span class="quoted">wf0</span> <span class="quoted">decr0</span> <span class="quoted">satisfies0</span> <span class="quoted">nullable0</span> <span class="quoted">lderiv0</span> <span class="quoted">rderiv0</span> <span class="quoted">undefined</span>
  <span class="keyword2"><span class="keyword">defines</span></span> norm <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.norm find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFOr <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFOr <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFAnd <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFAnd <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFNot <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFNot find0 decr0 <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFEx <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFEx find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFAll <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFAll find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> decr <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.decr decr0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> find <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.find find0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> FV <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.FV FV0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> RESTR <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.RESTR Restrict <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> formula"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> RESTRICT <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.RESTRICT Restrict FV0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">d0</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="main">(</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">)</span><span class="main">.</span> Formula_Operations.deriv extend <span class="bound">d0</span> <span class="bound">a</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nullable <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> Formula_Operations.nullable nullable0 <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fut_default <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.fut_default extend zero rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fut <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.fut extend zero find0 decr0 rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finalize <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.finalize SUC extend zero find0 decr0 rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> final <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.final SUC extend zero find0 decr0
     nullable0 rderiv0 <span class="main">::</span> idx <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ws1s_wf <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC <span class="main">(</span>wf0 <span class="main">::</span> idx <span class="main">⇒</span> ws1s <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ws1s_lformula <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula lformula0 <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">final</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">final</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bounded_check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="free">nullable</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="free">nullable</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">ws1s_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">ws1s_lformula</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"DA.automaton
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> lderiv0 <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span> <span class="main">::</span> formula<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span>SUC <span class="skolem">k</span> <span class="skolem">idx</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">l</span> <span class="main">(</span>SUC <span class="skolem">k</span> <span class="skolem">idx</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> find0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="main">(</span>decr0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> wf0.simps atomic.map find0.simps<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits order.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="comment1">― ‹slow›</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="main">(</span>decr0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span> <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> find0 <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">i</span> <span class="main">(</span>SUC <span class="skolem">k</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span> <span class="main">∨</span> len <span class="skolem">P</span> <span class="main">≤</span> Length <span class="skolem">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> disj <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies0 <span class="main">(</span>Extend <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>decr0 <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits order.split option.splits bool.splits<span class="main">)</span> <span class="comment1">― ‹slow›</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"len <span class="skolem">P</span> <span class="main">≤</span> Length <span class="skolem">𝔄</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Fo <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Z <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Less <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> In <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC wf0 <span class="skolem">idx</span> <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lderiv0.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits order.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula lformula0 <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lderiv0.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.lformula.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC wf0 <span class="skolem">idx</span> <span class="main">(</span>rderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lderiv0.induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps Let_def sorted_append
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bool.splits order.splits nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
  <span class="keyword1"><span class="command">note</span></span> fmember.rep_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Length <span class="skolem">𝔄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nullable0 <span class="skolem">a</span> <span class="main">=</span> satisfies0 <span class="skolem">𝔄</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wf0.simps nullable0.simps satisfies0.simps Let_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> MSB_greater <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits option.splits bool.splits nat.splits<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>  <span class="comment1">― ‹slow›</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword1"><span class="command">note</span></span> Formula_Operations.satisfies_gen.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> upshift_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> size_atom <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.satisfies Extend Length satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
     satisfies0 <span class="main">(</span>CONS <span class="skolem">x</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword1"><span class="command">note</span></span> Formula_Operations.satisfies_gen.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> upshift_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> size_atom <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.satisfies_bounded Extend Length len satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>lderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
     satisfies0 <span class="main">(</span>CONS <span class="skolem">x</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits bool.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword1"><span class="command">note</span></span> Formula_Operations.satisfies_gen.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> size_atom <span class="skolem">x</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.satisfies_bounded Extend Length len satisfies0 <span class="skolem">𝔄</span> <span class="main">(</span>rderiv0 <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
     satisfies0 <span class="main">(</span>SNOC <span class="skolem">x</span> <span class="skolem">𝔄</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> Less <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 2 0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits bool.splits<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fsubset_singleton_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length finsertCI less_not_sym<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assigns_less_Length finsertCI less_not_sym<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> In <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">𝔄</span> <span class="skolem">𝔅</span> <span class="main">::</span> <span class="quoted">interp</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔅</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔅</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> LESS <span class="bound">k</span> <span class="bound">m</span> <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="skolem">𝔅</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="skolem">𝔄</span></sup><span class="hidden">⇖</span><span class="bound">k</span> <span class="main">=</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="skolem">𝔅</span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies0 <span class="skolem">𝔄</span> <span class="skolem">a</span> <span class="main">⟷</span> satisfies0 <span class="skolem">𝔅</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
   <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="skolem">a</span>"</span></span>
   <span class="keyword1"><span class="command">moreover</span></span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Formula_Operations.deriv extend lderiv0"</span></span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula set"</span></span>
     <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span>
         Fo <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Fo <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Z <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Z <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Z <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Less <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Less <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Fo <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBool False<span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBool False<span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Fo <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBool False<span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBool False<span class="main">)</span> <span class="main">(</span>FBool False<span class="main">)</span><span class="main">,</span>
         FBool False<span class="main">}</span>
       <span class="main">|</span> In <span class="bound">i</span> <span class="bound">I</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>In <span class="bound">i</span> <span class="bound">I</span><span class="main">)</span><span class="main">,</span>  FBase <span class="main">(</span>Z <span class="bound">i</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
     <span class="keyword1"><span class="command">note</span></span> Formula_Operations.fold_deriv_FBool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Formula_Operations.deriv.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Φ_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
     <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹lformula0 <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FBase <span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits list.splits bool.splits if_splits option.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">Φ</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lformula0 <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="skolem">d</span> <span class="bound">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Formula_Operations.deriv extend rderiv0"</span></span>
   <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula set"</span></span>
     <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span>
         Fo <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Fo <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBase <span class="main">(</span>Z <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Z <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Z <span class="bound">m</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span>
       <span class="main">|</span> Less <span class="bound">m1</span> <span class="bound">m2</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Less <span class="bound">m1</span> <span class="bound">m2</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Fo <span class="bound">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">,</span>
          FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>FBool False<span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBool False<span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Fo <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBool False<span class="main">)</span> <span class="main">(</span>FBase <span class="main">(</span>Z <span class="bound">m1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
          FAnd <span class="main">(</span>FBool False<span class="main">)</span> <span class="main">(</span>FBool False<span class="main">)</span><span class="main">,</span>
         FBool False<span class="main">}</span>
       <span class="main">|</span> In <span class="bound">i</span> <span class="bound">I</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>In <span class="bound">i</span> <span class="bound">I</span><span class="main">)</span><span class="main">,</span>  FBase <span class="main">(</span>Z <span class="bound">i</span><span class="main">)</span><span class="main">,</span> FBool False<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
     <span class="keyword1"><span class="command">note</span></span> Formula_Operations.fold_deriv_FBool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Formula_Operations.deriv.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Φ_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FBase <span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits option.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def Let_def not_le gr0_conv_Suc
         <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits list.splits bool.splits if_splits option.splits nat.splits<span class="main">)</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">⟹</span> fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">Φ</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atomic.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="skolem">d</span> <span class="bound">xs</span> <span class="main">(</span>FBase <span class="skolem">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">l</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"find0 <span class="skolem">k</span> <span class="skolem">l</span> <span class="skolem">a</span> <span class="main">⟷</span> <span class="skolem">l</span> <span class="main">∈</span> FV0 <span class="skolem">k</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find0.induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">ws1s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">order</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV0 <span class="skolem">k</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="skolem">a</span> <span class="skolem">k</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf0 <span class="skolem">idx</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> FV0 <span class="skolem">k</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">v</span> <span class="skolem">idx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span> <span class="skolem">k</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LESS <span class="skolem">k</span> <span class="skolem">i</span> <span class="skolem">idx</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC wf0 <span class="skolem">idx</span> <span class="main">(</span>Restrict <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> Restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula lformula0 <span class="main">(</span>Restrict <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.lformula.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">𝔄</span> <span class="skolem">k</span> <span class="skolem">P</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="hidden">⇗</span><sup><span class="skolem">𝔄</span></sup><span class="hidden">⇖</span><span class="skolem">k</span> <span class="main">=</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">k</span> <span class="skolem">P</span> <span class="main">⟷</span>
    Formula_Operations.satisfies_gen Extend Length satisfies0 <span class="skolem">r</span> <span class="skolem">𝔄</span> <span class="main">(</span>Restrict <span class="skolem">k</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> restrict_def Restrict_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.satisfies_gen.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Extend_commute_unsafe downshift_def upshift_def fimage_iff Suc_le_eq len_def
  dec_def eval_def cut_def len_downshift_helper CONS_inj <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> CONS_surj
  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fMax_ge fMax_ffilter_less fMax_boundedD fsubset_fsingletonD
  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits if_splits<span class="main">)</span>

<span class="comment1">(*Workaround for code generation*)</span>
<span class="keyword1"><span class="command">lemma</span></span> check_eqv_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">idx</span> <span class="free">r</span> <span class="free">s</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>ws1s_wf <span class="free">idx</span> <span class="free">r</span> <span class="main">∧</span> ws1s_lformula <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>ws1s_wf <span class="free">idx</span> <span class="free">s</span> <span class="main">∧</span> ws1s_lformula <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> final <span class="free">idx</span> <span class="bound">p</span> <span class="main">=</span> final <span class="free">idx</span> <span class="bound">q</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span> norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>σ <span class="free">idx</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>norm <span class="main">(</span>RESTRICT <span class="free">r</span><span class="main">)</span><span class="main">,</span> norm <span class="main">(</span>RESTRICT <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> True
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def WS1S_Alt.check_eqv_def WS1S_Alt.step_alt <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">while</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">,</span> <span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">while</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> while_default <span class="main">(</span>fut_default <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> while_default_code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fut_default <span class="free">idx</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">idx</span> <span class="free">φ</span><span class="main">,</span> <span class="operator">folded</span> while_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> check_eqv_sound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>WS1S_Alt.sat <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> WS1S_Alt.sat <span class="free">𝔄</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WS1S_Alt.check_eqv_soundness<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_check_eqv_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> bounded_check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>WS1S_Alt.sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> WS1S_Alt.sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounded_check_eqv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WS1S_Alt.bounded_check_eqv_soundness<span class="main">)</span>

<span class="keyword1"><span class="command">method_setup</span></span> check_equiv <span class="main">=</span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">computation_check</span> <span class="quasi_keyword">terms</span><span class="main">:</span> <span class="quoted">Trueprop</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> nat"</span> <span class="quoted">Suc</span>
          <span class="quoted">"plus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"minus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"times <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"divide <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"modulo <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">::</span> int"</span>
          <span class="quoted">check_eqv</span> <span class="quasi_keyword">datatypes</span><span class="main">:</span> <span class="quoted">formula</span> <span class="quoted">"int list"</span> <span class="quoted">integer</span> <span class="quoted">idx</span>
          <span class="quoted">"nat <span class="main">×</span> nat"</span> <span class="quoted">"nat option"</span> <span class="quoted">"bool option"</span><span class="antiquote">}</span></span></span></span></span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        CONVERSION <span class="main">(</span>Conv.params_conv <span class="inner_numeral">~1</span> <span class="main">(</span>K <span class="main">(</span>Conv.concl_conv <span class="inner_numeral">~1</span> <span class="entity">conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">TrueI</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">tac</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Presburger_Formula">
<div class="head">
<h1>Theory Presburger_Formula</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete Atomic Presburger Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Presburger_Formula
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Abstract_Formula.html">Abstract_Formula</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Int.html">HOL-Library.Code_Target_Int</a>"</span>
  <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted"><span class="quoted">"of_bool <span class="main">::</span> bool <span class="main">⇒</span> nat"</span></span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted">int</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion_map</span> <span class="quoted">map</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion_enabled</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">― ‹FIXME yet another logarithm›</span>
  <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">len</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_eq0_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_mult2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>len <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> Suc <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>len <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_mult2'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>len <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> len_mult2 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_Suc_mult2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>len <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>len <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_less One_nat_def div2_Suc_Suc len.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lessI mult.right_neutral numeral_2_eq_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">x</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>len <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> le_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span>len <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>len <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">v</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> len_pow2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_div2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="free">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> len <span class="free">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> less_pow2_len<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> len <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> len.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> len_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"len <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> less_pow2_len<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Least_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> len <span class="free">x</span> <span class="main">≤</span> len <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> len_le_iff <span class="keyword1"><span class="command">using</span></span> less_pow2_len<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1"><span class="command">lemma</span></span> len_div_pow2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="free">x</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> len <span class="free">x</span> <span class="main">-</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> len_mult_pow2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> len <span class="free">x</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mult.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_index'_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_index' <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map_index' <span class="free">i</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">zero</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> False"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">SUC</span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>unit<span class="main">.</span> Suc"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test_bit</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">downshift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">upshift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">set_bit</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> test_bit <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">cut_bits</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> interp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">,</span> <span class="bound">xs</span> <span class="main">::</span> nat list<span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> len <span class="bound">x</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_interp
<span class="keyword1"><span class="command">type_synonym</span></span> atom <span class="main">=</span> <span class="quoted"><span class="quoted">"bool list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="quoted">"value"</span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword1"><span class="command">datatype</span></span> presb <span class="main">=</span> Eq <span class="main">(</span><span class="free"><span class="entity">tm</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"int list"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">const</span></span><span class="main">:</span> <span class="quoted">int</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">offset</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"int"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">list</span>
<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">presb</span>
<span class="keyword1"><span class="command">type_synonym</span></span> formula <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>presb<span class="main">,</span> unit<span class="main">)</span> aformula"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> assigns <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> interp <span class="main">⇒</span> unit <span class="main">⇒</span> value"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">⇗</span>_<span class="keyword1">⇖</span>_"</span> <span class="main">[</span>900<span class="main">,</span> 999<span class="main">,</span> 999<span class="main">]</span> 999<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">I</span> <span class="keyword1">then</span> <span class="bound">I</span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> nvars <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> _"</span> <span class="main">[</span>1000<span class="main">]</span> 900<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">.</span> length <span class="bound">I</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Length <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Extend <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> nat <span class="main">⇒</span> interp <span class="main">⇒</span> value <span class="main">⇒</span> interp"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">i</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> <span class="main">(</span>max <span class="bound">n</span> <span class="main">(</span>len <span class="bound">m</span><span class="main">)</span><span class="main">,</span> insert_nth <span class="bound">i</span> <span class="bound">m</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_takeD in_set_dropD<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> CONS <span class="main">::</span> <span class="quoted"><span class="quoted">"atom <span class="main">⇒</span> interp <span class="main">⇒</span> interp"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">bs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">,</span> map_index <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">bs</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_zip<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> SNOC <span class="main">::</span> <span class="quoted"><span class="quoted">"atom <span class="main">⇒</span> interp <span class="main">⇒</span> interp"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">bs</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">,</span> map_index <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">bs</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth len_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> bool <span class="main">⇒</span> atom <span class="main">⇒</span> atom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">extend</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">size_atom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"atom <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size_atom</span> <span class="main">≡</span> length"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FV0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit <span class="main">⇒</span> presb <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FV0</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">fm</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">fm</span></span></span> <span class="keyword1">of</span> Eq <span class="bound">is</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">is</span> <span class="main">∧</span> <span class="bound">is</span><span class="main">!</span><span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FV0_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"FV0 <span class="free">x</span> <span class="main">(</span>Eq <span class="free">is</span> <span class="free">i</span> <span class="free">off</span><span class="main">)</span> <span class="main">=</span> Option.these <span class="main">(</span>set <span class="main">(</span>map_index <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="bound">i</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> FV0_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">wf0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> presb <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf0</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find0</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">::</span>unit<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">decr0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decr0</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">::</span>unit<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> Eq <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scalar_product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> int list <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scalar_product</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span>
     sum_list <span class="main">(</span>map_index <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="bound">b</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> eval_tm <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> int list <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">.</span> scalar_product <span class="bound">I</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfies0</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eval_tm <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Length <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">lformula0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lformula0</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">lformula0</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lderiv0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> presb <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lderiv0</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> scalar_product <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span>
   <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">(</span><span class="bound">v</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rderiv0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> presb <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rderiv0</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">l</span> <span class="main">=</span> <span class="main">-</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span><span class="main">;</span>
     <span class="bound">h</span> <span class="main">=</span> <span class="main">-</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span><span class="main">;</span>
     <span class="bound">d'</span> <span class="main">=</span> scalar_product <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span>
   <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">d'</span> <span class="main">∈</span> <span class="main">{</span>min <span class="bound">h</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">..</span> max <span class="bound">l</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span> <span class="keyword1">then</span> FBase <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">d'</span><span class="main">)</span> <span class="keyword1">else</span> FBool False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">nullable0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nullable0</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">off</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">off</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> atom list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> List.n_lists <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[</span>True<span class="main">,</span> False<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> Presb_simps

<span class="keyword1"><span class="command">lemma</span></span> nvars_Extend<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>Extend <span class="main">()</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_Extend<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="main">(</span>Extend <span class="main">()</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="main">(</span>len <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length0_inj<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> Length <span class="free">𝔅</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_set_conv_all_nth len_eq0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_Length0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">𝔄</span><span class="main">.</span> Length <span class="bound">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">𝔄</span> <span class="main">=</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">idx</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">idx</span> <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_commute_safe<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  Extend <span class="free">k</span> <span class="free">j</span> <span class="main">(</span>Extend <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> Extend <span class="free">k</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>Extend <span class="free">k</span> <span class="free">j</span> <span class="free">𝔄</span> <span class="free">Q</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def take_Cons take_drop le_imp_diff_is_add <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_commute_unsafe<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">k'</span> <span class="main">⟹</span> Extend <span class="free">k</span> <span class="free">j</span> <span class="main">(</span>Extend <span class="free">k'</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">=</span> Extend <span class="free">k'</span> <span class="free">i</span> <span class="main">(</span>Extend <span class="free">k</span> <span class="free">j</span> <span class="free">𝔄</span> <span class="free">Q</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_Extend<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">m</span><span class="hidden">⇗</span><sup>Extend <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span></sup><span class="hidden">⇖</span><span class="free">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free">m</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="keyword1">else</span> dec <span class="free">i</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="keyword1">else</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append dec_def min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_SNOC_zero<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">⟹</span> <span class="free">m</span><span class="hidden">⇗</span><sup>SNOC <span class="main">(</span>zero <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span><span class="main">)</span> <span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span> <span class="main">=</span> <span class="free">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_CONS<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_SNOC<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_CONS<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_SNOC<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_CONS<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span> <span class="main">⟹</span>
  Extend <span class="free">k</span> <span class="main">0</span> <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> CONS <span class="main">(</span>extend <span class="free">k</span> <span class="main">(</span>test_bit <span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Extend <span class="free">k</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="main">(</span>downshift <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend_def downshift_def test_bit_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_SNOC<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span><span class="main">;</span> len <span class="free">P</span> <span class="main">≤</span> Length <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  Extend <span class="free">k</span> <span class="main">0</span> <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
    SNOC <span class="main">(</span>extend <span class="free">k</span> <span class="main">(</span>test_bit <span class="free">P</span> <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Extend <span class="free">k</span> <span class="main">0</span> <span class="free">𝔄</span> <span class="main">(</span>cut_bits <span class="main">(</span>Length <span class="free">𝔄</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cut_bits_def extend_def test_bit_def nth_Cons' max_absorb1 len_le_iff
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_weak_cong<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.commute mod_less mod_mult2_eq mult_numeral_1_right numeral_1_eq_Suc_0 power_commuting_commutes<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Euclidean_Division.div_eq_0_iff div_0 less_mult_imp_div_less mod_less nat_dvd_not_less semiring_normalization_rules<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> odd_neq_even<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">y</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_inj<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">x</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">⟹</span> size <span class="free">y</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">⟹</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span> <span class="main">⟹</span>
  CONS <span class="free">x</span> <span class="free">𝔄</span> <span class="main">=</span> CONS <span class="free">y</span> <span class="free">𝔅</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">𝔅</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq odd_neq_even <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mod_2_Suc_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_surj<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">x</span> <span class="bound">𝔅</span><span class="main">.</span> <span class="free">𝔄</span> <span class="main">=</span> CONS <span class="bound">x</span> <span class="bound">𝔅</span> <span class="main">∧</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="bound">𝔅</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">∧</span> size <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc list_eq_iff_nth_eq len_le_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_2_Suc_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>extend <span class="free">k</span> <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"downshift <span class="main">(</span>upshift <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"downshift <span class="main">(</span>set_bit <span class="main">0</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> downshift <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"test_bit <span class="main">(</span>set_bit <span class="free">n</span> <span class="free">P</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> test_bit <span class="main">(</span>upshift <span class="free">P</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"len <span class="free">P</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">⟹</span> <span class="main">¬</span> test_bit <span class="free">P</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"len <span class="main">(</span>cut_bits <span class="free">n</span> <span class="free">P</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"len <span class="free">P</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> cut_bits <span class="free">n</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="quoted"><span class="quoted">"len <span class="main">(</span>upshift <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> len <span class="free">P</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"len <span class="main">(</span>downshift <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> len <span class="free">P</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> extend_def set_bit_def cut_bits_def upshift_def downshift_def test_bit_def
    len_le_iff len_eq0_iff div_add_self2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc0_div_pow2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_unset_bit_preserves_len<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> len <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> len <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq len_Suc_mult2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> len_Suc_mult2 power_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"len <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> len_set_bit<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>set_bit <span class="free">m</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>len <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span>set_bit <span class="free">m</span> <span class="free">P</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>len <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_bit_def test_bit_def max_def Suc_le_eq not_less len_le_iff
      set_unset_bit_preserves_len <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> len <span class="main">(</span><span class="free">P</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_pow2_len<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> len <span class="main">(</span><span class="free">P</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ len_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span> <span class="main"><span class="main"><span class="main">^</span></span></span> <span class="free"><span class="free"><span class="free">m</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>len <span class="free">P</span><span class="main">)</span> <span class="main">≤</span> len <span class="main">(</span>set_bit <span class="free">m</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_bit_def test_bit_def max_def Suc_le_eq not_less len_le_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mod_pow2_div_pow2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq mod_mult2_eq Suc_less_eq2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> irrelevant_set_bit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse mult.commute power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mod_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">c</span><span class="main">;</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">*</span> <span class="main">(</span><span class="free">q</span> <span class="keyword1">mod</span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_gr_0 div_le_mono div_mult_self1_is_m less_imp_add_positive mod_less_divisor not_less split_div<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> relevant_set_bit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">m</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc<span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 lessI mod_lemma numeral_2_eq_2 zero_less_numeral zero_less_power<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_mult2_eq mod_mult2_eq Suc_less_eq2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mod_add_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cut_bits_set_bit<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cut_bits <span class="free">n</span> <span class="main">(</span>set_bit <span class="free">m</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="keyword1">then</span> cut_bits <span class="free">n</span> <span class="free">p</span> <span class="keyword1">else</span> set_bit <span class="free">m</span> <span class="main">(</span>cut_bits <span class="free">n</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cut_bits_def set_bit_def test_bit_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le mod_pow2_div_pow2 mod_mod_cancel <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf0_decr0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span>Suc <span class="free">idx</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">&lt;</span> Suc <span class="free">idx</span> <span class="main">⟹</span> <span class="main">¬</span> find0 <span class="free">k</span> <span class="free">l</span> <span class="free">a</span> <span class="main">⟹</span> wf0 <span class="free">idx</span> <span class="main">(</span>decr0 <span class="free">k</span> <span class="free">l</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula0_decr0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lformula0 <span class="free">a</span> <span class="main">⟹</span> lformula0 <span class="main">(</span>decr0 <span class="free">k</span> <span class="free">l</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lformula0.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lformula0.intros<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sat0_syn</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨0</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sat0_syn</span> <span class="main">≡</span> satisfies0"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sat_syn</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sat_syn</span> <span class="main">≡</span> Formula_Operations.satisfies Extend Length satisfies0"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sat_bounded_syn</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span>"</span> 65<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">sat_bounded_syn</span> <span class="main">≡</span> Formula_Operations.satisfies_bounded Extend Length len satisfies0"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scalar_product <span class="main">[]</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_Nil2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scalar_product <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"scalar_product <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">xs</span> <span class="keyword1">of</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">+</span> scalar_product <span class="bound">xs</span> <span class="free">ys</span> <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_weak_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scalar_product <span class="free">ns</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
  scalar_product <span class="main">(</span>take <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="main">+</span> scalar_product <span class="main">(</span>drop <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_trim<span class="main">:</span> <span class="quoted"><span class="quoted">"scalar_product <span class="free">ns</span> <span class="free">xs</span> <span class="main">=</span> scalar_product <span class="main">(</span>take <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Extend_satisfies0_decr0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> find0 <span class="free">k</span> <span class="free">i</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="free">a</span> <span class="main">∨</span> len <span class="free">P</span> <span class="main">≤</span> Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Extend <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span> <span class="main">⊨0</span> <span class="free">a</span> <span class="main">=</span> <span class="free">𝔄</span> <span class="main">⊨0</span> decr0 <span class="free">k</span> <span class="free">i</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
     <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
     <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_tm <span class="main">(</span>Extend <span class="free">k</span> <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> eval_tm <span class="free">𝔄</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">is</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span>
         <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> scalar_product_trim<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def
         arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl id_take_nth_drop<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">scalar_product</span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">xs</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Length_Extend max_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lformula0.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_eq0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span>set <span class="free">ns</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> scalar_product <span class="free">ns</span> <span class="free">is</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_weak_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scalar_product_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nullable0_satisfies0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> nullable0 <span class="free">a</span> <span class="main">=</span> <span class="free">𝔄</span> <span class="main">⊨0</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Eq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nullable0.simps satisfies0.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_eq0_iff scalar_product_eq0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies0_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span><span class="main">)</span> <span class="free">a</span> <span class="main">⟹</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span> <span class="main">⟹</span> lformula0 <span class="free">a</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">m</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔅</span> <span class="main">⟹</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔄</span></sup><span class="hidden">⇖</span><span class="bound">k</span> <span class="main">=</span> <span class="bound">m</span><span class="hidden">⇗</span><sup><span class="free">𝔅</span></sup><span class="hidden">⇖</span><span class="bound">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨0</span> <span class="free">a</span> <span class="main">=</span> <span class="free">𝔅</span> <span class="main">⊨0</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Eq <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies0.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span> map_index_cong <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lformula0.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_lderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf0 <span class="free">idx</span> <span class="free">a</span> <span class="main">⟹</span> lformula0 <span class="free">a</span> <span class="main">⟹</span> Formula_Operations.wf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc<span class="main">)</span> wf0 <span class="free">idx</span> <span class="main">(</span>lderiv0 <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lformula0.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lformula_lderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lformula0 <span class="free">a</span> <span class="main">⟹</span> Formula_Operations.lformula lformula0 <span class="main">(</span>lderiv0 <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lformula0.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lformula0.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Formula_Operations.lformula.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_rderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf0 <span class="free">idx</span> <span class="free">a</span> <span class="main">⟹</span> Formula_Operations.wf <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Suc<span class="main">)</span> wf0 <span class="free">idx</span> <span class="main">(</span>rderiv0 <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lformula0.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula_Operations.wf.simps Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find0_FV0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf0 <span class="free">idx</span> <span class="free">a</span><span class="main">;</span> <span class="free">l</span> <span class="main">&lt;</span> <span class="free">idx</span><span class="main">⟧</span> <span class="main">⟹</span> find0 <span class="free">k</span> <span class="free">l</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">∈</span> FV0 <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FV0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FV0_less<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf0 <span class="free">idx</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> FV0 <span class="free">k</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">&lt;</span> <span class="free">idx</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FV0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_FV0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>FV0 <span class="free">k</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FV0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_lderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lformula0 <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">=</span> fold <span class="main">(</span>Formula_Operations.deriv extend lderiv0<span class="main">)</span> <span class="bound">xs</span> <span class="main">(</span>FBase <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Formula_Operations.deriv extend lderiv0"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="skolem">is</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">is</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span>
    Eq <span class="bound">is</span> <span class="bound">n</span> <span class="bound">z</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq <span class="bound">is</span> <span class="bound">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span> <span class="bound">is</span><span class="main">)</span> <span class="bound">n</span> <span class="main">..</span> max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span> <span class="bound">is</span><span class="main">)</span> <span class="bound">n</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span>
      <span class="main">{</span>FBool False <span class="main">::</span> formula<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">note</span></span> Formula_Operations.fold_deriv_FBool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Formula_Operations.deriv.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Φ_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹lformula0 <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FBase <span class="free">a</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lformula0.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Φ_def presb.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> UnE CollectE insertE emptyE exE conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">bs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">φ</span> <span class="main">::</span> <span class="quoted">formula</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">n</span><span class="main">..</span>max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> FBase <span class="main">(</span>presb.Eq <span class="skolem">is</span> <span class="skolem">i</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scalar_product <span class="skolem">bs</span> <span class="skolem">is</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="skolem">is</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">bs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def scalar_product_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="skolem">is</span> <span class="main">≤</span> scalar_product <span class="skolem">bs</span> <span class="skolem">is</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">bs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_def scalar_product_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">bs</span> <span class="skolem">φ</span> <span class="main">∈</span>
        <span class="main">{</span>FBase <span class="main">(</span>presb.Eq <span class="skolem">is</span> <span class="bound">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">n</span><span class="main">..</span>max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span> <span class="skolem">is</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>FBool False<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span> <span class="main">⟹</span> fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">(</span>FBase <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">Φ</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> presb.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_rderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">=</span> fold <span class="main">(</span>Formula_Operations.deriv extend rderiv0<span class="main">)</span> <span class="bound">xs</span> <span class="main">(</span>FBase <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Formula_Operations.deriv extend rderiv0"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="skolem">is</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span>"</span></span><span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">is</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span>"</span></span><span class="keyword2"><span class="keyword">for</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Φ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span>
    Eq <span class="bound">is</span> <span class="bound">n</span> <span class="bound">z</span> <span class="main">⇒</span> <span class="main">{</span>FBase <span class="main">(</span>Eq <span class="bound">is</span> <span class="bound">n</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span> <span class="bound">is</span><span class="main">)</span> <span class="main">(</span>min <span class="bound">n</span> <span class="bound">z</span><span class="main">)</span> <span class="main">..</span> max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span> <span class="bound">is</span><span class="main">)</span> <span class="main">(</span>max <span class="bound">n</span> <span class="bound">z</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span>
      <span class="main">{</span>FBool False <span class="main">::</span> formula<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">note</span></span> Formula_Operations.fold_deriv_FBool<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Formula_Operations.deriv.simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> Φ_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FBase <span class="free">a</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> presb.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> Φ_def presb.case<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> UnE CollectE insertE emptyE exE conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">bs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="skolem">n</span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">φ</span> <span class="main">::</span> <span class="quoted">formula</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>min <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span><span class="main">..</span>max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> FBase <span class="main">(</span>presb.Eq <span class="skolem">is</span> <span class="skolem">n</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scalar_product <span class="skolem">bs</span> <span class="skolem">is</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="skolem">is</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">bs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def scalar_product_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="skolem">is</span> <span class="main">≤</span> scalar_product <span class="skolem">bs</span> <span class="skolem">is</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">bs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_def scalar_product_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">bs</span> <span class="skolem">φ</span> <span class="main">∈</span>
        <span class="main">{</span>FBase <span class="main">(</span>presb.Eq <span class="skolem">is</span> <span class="skolem">n</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>min <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span><span class="main">..</span>max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">n</span> <span class="skolem">m</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>FBool False<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def Let_def h_def l_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span> <span class="main">⟹</span> fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">(</span>FBase <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Φ</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">Φ</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> presb.splits<span class="main">)</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">::</span> bool list<span class="main">)</span> <span class="main">⟹</span>
  scalar_product <span class="main">(</span>map_index <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">n</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span>
  scalar_product <span class="free">bs</span> <span class="free">is</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> scalar_product <span class="free">xs</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_tm_CONS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">is</span> <span class="main">≤</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span>
   eval_tm <span class="main">(</span>CONS <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> scalar_product <span class="free">x</span> <span class="free">is</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> eval_tm <span class="free">𝔄</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_CONS<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">scalar_product</span><span class="main"><span class="main">]</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_lderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span><span class="main">;</span> lformula0 <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="main">⊨</span> lderiv0 <span class="free">x</span> <span class="free">a</span> <span class="main">⟷</span> CONS <span class="free">x</span> <span class="free">𝔄</span> <span class="main">⊨0</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Formula_Operations.satisfies_gen.simps
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lformula0.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_lderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span><span class="main">;</span> lformula0 <span class="free">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> lderiv0 <span class="free">x</span> <span class="free">a</span> <span class="main">⟷</span> CONS <span class="free">x</span> <span class="free">𝔄</span> <span class="main">⊨0</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Formula_Operations.satisfies_gen.simps
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lformula0.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_SNOC<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">::</span> bool list<span class="main">)</span>  <span class="main">⟹</span>
  scalar_product <span class="main">(</span>map_index <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">*</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span>
  scalar_product <span class="free">xs</span> <span class="free">is</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">*</span> scalar_product <span class="free">bs</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_tm_SNOC<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>length <span class="free">is</span> <span class="main">≤</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span>
   eval_tm <span class="main">(</span>SNOC <span class="free">x</span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> eval_tm <span class="free">𝔄</span> <span class="free">is</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> Length <span class="free">𝔄</span> <span class="main">*</span> scalar_product <span class="free">x</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_SNOC<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">scalar_product</span><span class="main"><span class="main">]</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Length_eq0_eval_tm_eq0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> eval_tm <span class="free">𝔄</span> <span class="free">is</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_eq0_iff scalar_product_eq0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_pow2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">⟹</span> int <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_less_iff of_nat_numeral of_nat_power <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">b</span><span class="main">.</span> len <span class="bound">x</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span>
  scalar_product <span class="free">b</span> <span class="free">is</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="free">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scalar_product <span class="main">(</span>tl <span class="skolem">b</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_tlD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_le_iff mult_le_0_iff
      distrib_left add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span> less_pow2
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">b</span><span class="main">.</span> len <span class="bound">x</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span>
  scalar_product <span class="free">b</span> <span class="free">is</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="free">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scalar_product <span class="main">(</span>tl <span class="skolem">b</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_tlD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len_le_iff mult_le_0_iff
      distrib_left add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span> less_pow2
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_tm_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_tm <span class="free">𝔄</span> <span class="free">is</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Length <span class="free">𝔄</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="free">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_upper_bound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_tm_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_tm <span class="free">𝔄</span> <span class="free">is</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> Length <span class="free">𝔄</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> sum_list <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="free">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_product_lower_bound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_bounded_rderiv0<span class="main">[</span><span class="operator">Presb_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>wf0 <span class="main">(</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span><span class="main">)</span> <span class="free">a</span><span class="main">;</span> <span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> length <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">𝔄</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>b</sub></span> rderiv0 <span class="free">x</span> <span class="free">a</span> <span class="main">⟷</span> SNOC <span class="free">x</span> <span class="free">𝔄</span> <span class="main">⊨0</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">n</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Length <span class="free">𝔄</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> scalar_product <span class="free">x</span> <span class="skolem">is</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> sum_list  <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> sum_list  <span class="main">[</span><span class="bound">i</span><span class="main">.</span> i <span class="main">←</span> <span class="skolem">is</span><span class="main">,</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf0.simps satisfies0.simps rderiv0.simps Let_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Formula_Operations.satisfies_gen.simps satisfies0.simps
    Length_SNOC eval_tm_SNOC simp_thms<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> de_Morgan_conj not_le
    min_less_iff_conj max_less_iff_conj d'_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> h_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> l_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval_tm <span class="free">𝔄</span> <span class="skolem">is</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?l</span> <span class="main">*</span> scalar_product <span class="free">x</span> <span class="skolem">is</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">^</span> Suc <span class="var">?l</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> eval_tm_upper_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">]</span> eval_tm_lower_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">h</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="var">?l</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">+</span> <span class="skolem">d'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="var">?l</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="skolem">d'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> h_def l_def d'_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">∉</span> <span class="main">{</span>min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span><span class="main">)</span> <span class="skolem">n</span><span class="main">..</span>max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> order_trans<span class="main">[</span><span class="operator">OF</span> this *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">d'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> zero_le_mult_iff <span class="keyword1"><span class="command">using</span></span> zero_less_power<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">h</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mult_right_mono_neg<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> le_less_trans<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="skolem">d'</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_less_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">+</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** calculation<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_right_mono<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="main">-</span> <span class="skolem">h</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">d'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">≤</span> max <span class="main">(</span><span class="main">-</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def max_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> d'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">goals_limit</span> <span class="main"><span class="main">=</span></span> 100<span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Presb<span class="main">:</span> Formula
  <span class="keyword2"><span class="keyword">where</span></span> SUC <span class="main">=</span> <span class="quoted">SUC</span> <span class="keyword2"><span class="keyword">and</span></span> LESS <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(&lt;)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Length <span class="main">=</span> <span class="quoted">Length</span>
  <span class="keyword2"><span class="keyword">and</span></span> assigns <span class="main">=</span> <span class="quoted">assigns</span> <span class="keyword2"><span class="keyword">and</span></span> nvars <span class="main">=</span> <span class="quoted">nvars</span> <span class="keyword2"><span class="keyword">and</span></span> Extend <span class="main">=</span> <span class="quoted">Extend</span> <span class="keyword2"><span class="keyword">and</span></span> CONS <span class="main">=</span> <span class="quoted">CONS</span> <span class="keyword2"><span class="keyword">and</span></span> SNOC <span class="main">=</span> <span class="quoted">SNOC</span>
  <span class="keyword2"><span class="keyword">and</span></span> extend <span class="main">=</span> <span class="quoted">extend</span> <span class="keyword2"><span class="keyword">and</span></span> size <span class="main">=</span> <span class="quoted">size_atom</span> <span class="keyword2"><span class="keyword">and</span></span> zero <span class="main">=</span> <span class="quoted">zero</span> <span class="keyword2"><span class="keyword">and</span></span> alphabet <span class="main">=</span> <span class="quoted">σ</span> <span class="keyword2"><span class="keyword">and</span></span> eval <span class="main">=</span> <span class="quoted">test_bit</span>
  <span class="keyword2"><span class="keyword">and</span></span> downshift <span class="main">=</span> <span class="quoted">downshift</span> <span class="keyword2"><span class="keyword">and</span></span> upshift <span class="main">=</span> <span class="quoted">upshift</span> <span class="keyword2"><span class="keyword">and</span></span> add <span class="main">=</span> <span class="quoted">set_bit</span> <span class="keyword2"><span class="keyword">and</span></span> cut <span class="main">=</span> <span class="quoted">cut_bits</span> <span class="keyword2"><span class="keyword">and</span></span> len <span class="main">=</span> <span class="quoted">len</span>
  <span class="keyword2"><span class="keyword">and</span></span> restrict <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Restrict <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> FBool True"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lformula0 <span class="main">=</span> <span class="quoted">lformula0</span>
  <span class="keyword2"><span class="keyword">and</span></span> FV0 <span class="main">=</span> <span class="quoted">FV0</span> <span class="keyword2"><span class="keyword">and</span></span> find0 <span class="main">=</span> <span class="quoted">find0</span> <span class="keyword2"><span class="keyword">and</span></span> wf0 <span class="main">=</span> <span class="quoted">wf0</span> <span class="keyword2"><span class="keyword">and</span></span> decr0 <span class="main">=</span> <span class="quoted">decr0</span> <span class="keyword2"><span class="keyword">and</span></span> satisfies0 <span class="main">=</span> <span class="quoted">satisfies0</span>
  <span class="keyword2"><span class="keyword">and</span></span> nullable0 <span class="main">=</span> <span class="quoted">nullable0</span> <span class="keyword2"><span class="keyword">and</span></span> lderiv0 <span class="main">=</span> <span class="quoted">lderiv0</span> <span class="keyword2"><span class="keyword">and</span></span> rderiv0 <span class="main">=</span> <span class="quoted">rderiv0</span>
  <span class="keyword2"><span class="keyword">and</span></span> TYPEVARS <span class="main">=</span> <span class="quoted">undefined</span>
  <span class="keyword2"><span class="keyword">defines</span></span> norm <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.norm find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFOr <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFOr <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFAnd <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFAnd <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFNot <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFNot find0 decr0 <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFEx <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFEx find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nFAll <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.nFAll find0 decr0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> decr <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.decr decr0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> find <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.find find0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> FV <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.FV FV0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> RESTR <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.RESTR <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> FBool True<span class="main">)</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> formula"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> RESTRICT <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.RESTRICT <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> FBool True<span class="main">)</span> FV0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> deriv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">d0</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="main">(</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">)</span><span class="main">.</span> Formula_Operations.deriv extend <span class="bound">d0</span> <span class="bound">a</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nullable <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> Formula_Operations.nullable nullable0 <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fut_default <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.fut_default extend zero rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fut <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.fut extend zero find0 decr0 rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finalize <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.finalize SUC extend zero find0 decr0 rderiv0"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> final <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula.final SUC extend zero find0 decr0
     nullable0 rderiv0 <span class="main">::</span> nat <span class="main">⇒</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> presb_wf <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.wf SUC <span class="main">(</span>wf0 <span class="main">::</span> nat <span class="main">⇒</span> presb <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> presb_lformula <span class="main">=</span> <span class="quoted"><span class="quoted">"Formula_Operations.lformula <span class="main">(</span>lformula0 <span class="main">::</span> presb <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">::</span> formula <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> formula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">final</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">presb_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">presb_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> formula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">final</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">presb_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">presb_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bounded_check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> formula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="free">nullable</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">presb_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">presb_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">RESTRICT</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> formula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="free">nullable</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> <span class="free">presb_wf</span> <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> <span class="free">presb_lformula</span> <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(=)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"DA.automaton
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">norm</span> <span class="main">(</span><span class="free">deriv</span> lderiv0 <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span> <span class="main">::</span> formula<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">Presb_simps</span></span> σ_def set_n_lists distinct_n_lists
    Formula_Operations.lformula.simps Formula_Operations.satisfies_gen.simps Formula_Operations.wf.simps
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> satisfies0_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> presb.splits if_splits<span class="main">)</span>

<span class="comment1">(*Workaround for code generation*)</span>
<span class="keyword1"><span class="command">lemma</span></span> check_eqv_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">idx</span> <span class="free">r</span> <span class="free">s</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>presb_wf <span class="free">idx</span> <span class="free">r</span> <span class="main">∧</span> presb_lformula <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>presb_wf <span class="free">idx</span> <span class="free">s</span> <span class="main">∧</span> presb_lformula <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> final <span class="free">idx</span> <span class="bound">p</span> <span class="main">=</span> final <span class="free">idx</span> <span class="bound">q</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span> norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>σ <span class="free">idx</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>norm <span class="main">(</span>RESTRICT <span class="free">r</span><span class="main">)</span><span class="main">,</span> norm <span class="main">(</span>RESTRICT <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> True
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def Presb.check_eqv_def Presb.step_alt <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">while</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">,</span> <span class="operator">code_abbrev</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">while</span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> while_default <span class="main">(</span>fut_default <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> while_default_code<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fut_default <span class="free">idx</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">idx</span> <span class="free">φ</span><span class="main">,</span> <span class="operator">folded</span> while_def<span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> check_eqv_sound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Presb.sat <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> Presb.sat <span class="free">𝔄</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Presb.check_eqv_soundness<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_check_eqv_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="free">𝔄</span> <span class="main">=</span> <span class="free">idx</span><span class="main">;</span> bounded_check_eqv <span class="free">idx</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Presb.sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">φ</span> <span class="main">⟷</span> Presb.sat<span class="hidden">⇩</span><sub>b</sub> <span class="free">𝔄</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounded_check_eqv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Presb.bounded_check_eqv_soundness<span class="main">)</span>

<span class="keyword1"><span class="command">method_setup</span></span> check_equiv <span class="main">=</span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">computation_check</span> <span class="quasi_keyword">terms</span><span class="main">:</span> <span class="quoted">Trueprop</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> nat"</span> <span class="quoted">Suc</span>
          <span class="quoted">"plus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"minus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"times <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"divide <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"modulo <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">::</span> int"</span>
          <span class="quoted">check_eqv</span> <span class="quasi_keyword">datatypes</span><span class="main">:</span> <span class="quoted">formula</span> <span class="quoted">"int list"</span> <span class="quoted">integer</span> <span class="quoted">bool</span><span class="antiquote">}</span></span></span></span></span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        CONVERSION <span class="main">(</span>Conv.params_conv <span class="inner_numeral">~1</span> <span class="main">(</span>K <span class="main">(</span>Conv.concl_conv <span class="inner_numeral">~1</span> <span class="entity">conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">TrueI</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">tac</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WS1S_Presburger_Equivalence">
<div class="head">
<h1>Theory WS1S_Presburger_Equivalence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Comparing WS1S Formulas with Presburger Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Presburger_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Presburger_Formula.html">Presburger_Formula</a> <a href="WS1S_Formula.html">WS1S_Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> letter_eq <span class="main">::</span> <span class="quoted"><span class="quoted">"idx <span class="main">⇒</span> nat <span class="main">⇒</span> bool list <span class="main">×</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">m1</span><span class="main">,</span><span class="bound">m2</span><span class="main">)</span> <span class="bound">n</span> <span class="main">(</span><span class="bound">bs1</span><span class="main">,</span> <span class="bound">bs2</span><span class="main">)</span> <span class="bound">bs</span><span class="main">.</span> <span class="bound">m1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">m2</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">bs1</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">bs2</span> <span class="main">=</span> <span class="bound">bs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> letter_eq<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"letter_eq <span class="free">idx</span> <span class="free">n</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>WS1S_Prelim.σ <span class="free">idx</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">∈</span> set <span class="main">(</span>Presburger_Formula.σ <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Presburger_Formula.σ_def set_n_lists image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> WS1S_Presb<span class="main">:</span> DAs
  <span class="quoted"><span class="quoted">"WS1S_Prelim.σ <span class="free">idx</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>RESTRICT <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>deriv lderiv0 <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>WS1S.final <span class="free">idx</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> ws1s_wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> ws1s_lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> Formula.lang WS1S_Prelim.nvars
     WS1S_Prelim.Extend WS1S_Prelim.CONS WS1S_Prelim.Length WS1S_Prelim.size_atom
     WS1S_Formula.satisfies0 <span class="free">idx</span> <span class="bound">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> ws1s_wf <span class="free">idx</span> <span class="bound">φ</span> <span class="main">∧</span> ws1s_lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> Formula.language WS1S_Prelim.assigns
     WS1S_Prelim.nvars WS1S_Prelim.Extend WS1S_Prelim.CONS
     WS1S_Prelim.Length WS1S_Prelim.size_atom restrict WS1S_Formula.FV0
     WS1S_Formula.satisfies0 <span class="free">idx</span> <span class="bound">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Presburger_Formula.σ <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> Presburger_Formula.norm <span class="main">(</span>Presburger_Formula.RESTRICT <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> Presburger_Formula.norm <span class="main">(</span>Presburger_Formula.deriv Presburger_Formula.lderiv0 <span class="bound">a</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Presburger_Formula.final <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> presb_wf <span class="free">n</span> <span class="bound">φ</span> <span class="main">∧</span> presb_lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> Formula.lang Presburger_Formula.nvars
            Presburger_Formula.Extend Presburger_Formula.CONS Presburger_Formula.Length
            Presburger_Formula.size_atom <span class="main">(⊨0)</span> <span class="free">n</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> presb_wf <span class="free">n</span> <span class="bound">φ</span> <span class="main">∧</span> presb_lformula <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> Formula.language Presburger_Formula.assigns
            Presburger_Formula.nvars Presburger_Formula.Extend Presburger_Formula.CONS
            Presburger_Formula.Length Presburger_Formula.size_atom <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>
            Presburger_Formula.FV0 <span class="main">(⊨0)</span>
            <span class="free">n</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"letter_eq <span class="free">idx</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> check_eqv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">idx</span> <span class="bound">n</span><span class="main">.</span> DAs.check_eqv
    <span class="main">(</span>σ <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>RESTRICT <span class="bound">φ</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span>ws1s<span class="main">,</span> order<span class="main">)</span> aformula<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> norm <span class="main">(</span>deriv <span class="main">(</span>lderiv0 <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> formula<span class="main">)</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> atom<span class="main">)</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>final <span class="bound">idx</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">::</span> formula<span class="main">.</span> ws1s_wf <span class="bound">idx</span> <span class="bound">φ</span> <span class="main">∧</span> ws1s_lformula <span class="bound">φ</span><span class="main">)</span>
    <span class="main">(</span>Presburger_Formula.σ <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> Presburger_Formula.norm <span class="main">(</span>Presburger_Formula.RESTRICT <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">φ</span><span class="main">.</span> Presburger_Formula.norm <span class="main">(</span>Presburger_Formula.deriv Presburger_Formula.lderiv0 <span class="bound">a</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Presburger_Formula.final <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> presb_wf <span class="bound">n</span> <span class="bound">φ</span> <span class="main">∧</span> presb_lformula <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>letter_eq <span class="bound">idx</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="comment1">(*Workaround for code generation*)</span>
<span class="keyword1"><span class="command">lemma</span></span> check_eqv_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">idx</span> <span class="free">n</span> <span class="free">r</span> <span class="free">s</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">(</span>ws1s_wf <span class="free">idx</span> <span class="free">r</span> <span class="main">∧</span> ws1s_lformula <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>presb_wf <span class="free">n</span> <span class="free">s</span> <span class="main">∧</span> presb_lformula <span class="free">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> final <span class="free">idx</span> <span class="bound">p</span> <span class="main">=</span> Presburger_Formula.final <span class="free">n</span> <span class="bound">q</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span>
    map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>norm <span class="main">(</span>deriv lderiv0 <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">,</span>
      Presburger_Formula.norm <span class="main">(</span>Presburger_Formula.deriv Presburger_Formula.lderiv0 <span class="bound">b</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">←</span>List.product <span class="main">(</span>σ <span class="free">idx</span><span class="main">)</span> <span class="main">(</span>Presburger_Formula.σ <span class="free">n</span><span class="main">)</span><span class="main">.</span> letter_eq <span class="free">idx</span> <span class="free">n</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>
    <span class="main">(</span>norm <span class="main">(</span>RESTRICT <span class="free">r</span><span class="main">)</span><span class="main">,</span> Presburger_Formula.norm <span class="main">(</span>Presburger_Formula.RESTRICT <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> True
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_eqv_def WS1S_Presb.check_eqv_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">method_setup</span></span> check_equiv <span class="main">=</span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">conv</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">computation_check</span> <span class="quasi_keyword">terms</span><span class="main">:</span> <span class="quoted">Trueprop</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> nat"</span> <span class="quoted">Suc</span>
          <span class="quoted">"plus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"minus <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"times <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"divide <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span> <span class="quoted">"modulo <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span>
          <span class="quoted">"<span class="main">0</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">1</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> int"</span> <span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">::</span> int"</span>
          <span class="quoted">check_eqv</span> <span class="quasi_keyword">datatypes</span><span class="main">:</span> <span class="quoted">idx</span> <span class="quoted">"<span class="main">(</span>presb<span class="main">,</span> unit<span class="main">)</span> aformula"</span> <span class="quoted">"<span class="main">(</span><span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> atomic<span class="main">,</span> WS1S_Prelim.order<span class="main">)</span> aformula"</span>
          <span class="quoted">"nat <span class="main">×</span> nat"</span> <span class="quoted">"nat option"</span> <span class="quoted">"bool option"</span> <span class="quoted">"int list"</span> <span class="quoted">integer</span><span class="antiquote">}</span></span></span></span></span> <span class="entity">ctxt</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        CONVERSION <span class="main">(</span>Conv.params_conv <span class="inner_numeral">~1</span> <span class="main">(</span>K <span class="main">(</span>Conv.concl_conv <span class="inner_numeral">~1</span> <span class="entity">conv</span><span class="main">)</span><span class="main">)</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">TrueI</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Scan.succeed <span class="main">(</span><span class="entity">SIMPLE_METHOD'</span> o <span class="entity">tac</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="WS1S_Nameful">
<div class="head">
<h1>Theory WS1S_Nameful</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nameful WS1S Formulas›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> WS1S_Nameful
<span class="keyword2"><span class="keyword">imports</span></span> <a href="WS1S_Formula.html">WS1S_Formula</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">coercion</span> <span class="quoted"><span class="quoted">"of_char <span class="main">::</span> char <span class="main">⇒</span> nat"</span></span><span class="main">,</span> <span class="operator">coercion_enabled</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_upper</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_upper</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">65</span><span class="main">..</span><span class="numeral">90</span> <span class="main">::</span> nat<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lower</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_lower</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">97</span><span class="main">..</span><span class="numeral">122</span> <span class="main">::</span> nat<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="comment1">(*nonempty string starting with lower case*)</span>
<span class="keyword1"><span class="command">typedef</span></span> fo <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> is_lower <span class="main">(</span>hd <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''x''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="comment1">(*nonempty string starting with upper case*)</span>
<span class="keyword1"><span class="command">typedef</span></span> so <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> is_upper <span class="main">(</span>hd <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="inner_quoted">''X''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">datatype</span></span> ws1s <span class="main">=</span>
    T <span class="main">|</span> F <span class="main">|</span> Or <span class="quoted">ws1s</span> <span class="quoted">ws1s</span> <span class="main">|</span> And <span class="quoted">ws1s</span> <span class="quoted">ws1s</span> <span class="main">|</span> Not <span class="quoted">ws1s</span>
  <span class="main">|</span> Ex1 <span class="quoted">fo</span> <span class="quoted">ws1s</span> <span class="main">|</span> Ex2 <span class="quoted">so</span> <span class="quoted">ws1s</span> <span class="main">|</span> All1 <span class="quoted">fo</span> <span class="quoted">ws1s</span> <span class="main">|</span> All2 <span class="quoted">so</span> <span class="quoted">ws1s</span>
  <span class="main">|</span> Lt <span class="quoted">fo</span> <span class="quoted">fo</span>
  <span class="main">|</span> In <span class="quoted">fo</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_Const <span class="quoted">fo</span> <span class="quoted">nat</span>
  <span class="main">|</span> Eq_Presb <span class="quoted">so</span> <span class="quoted">nat</span>
  <span class="main">|</span> Eq_FO <span class="quoted">fo</span> <span class="quoted">fo</span>
  <span class="main">|</span> Eq_FO_Offset <span class="quoted">fo</span> <span class="quoted">fo</span> <span class="quoted">nat</span>
  <span class="main">|</span> Eq_SO <span class="quoted">so</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_SO_Inc <span class="quoted">so</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_Max <span class="quoted">fo</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_Min <span class="quoted">fo</span> <span class="quoted">so</span>
  <span class="main">|</span> Empty <span class="quoted">so</span>
  <span class="main">|</span> Singleton <span class="quoted">so</span>
  <span class="main">|</span> Subset <span class="quoted">so</span> <span class="quoted">so</span>
  <span class="main">|</span> Disjoint <span class="quoted">so</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_Union <span class="quoted">so</span> <span class="quoted">so</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_Inter <span class="quoted">so</span> <span class="quoted">so</span> <span class="quoted">so</span>
  <span class="main">|</span> Eq_Diff <span class="quoted">so</span> <span class="quoted">so</span> <span class="quoted">so</span>

<span class="comment1">(*standard WS1S semantics, finiteness captured by the type fset*)</span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fo <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>so <span class="main">⇒</span> nat fset<span class="main">)</span> <span class="main">⇒</span> ws1s <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> T <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> F <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Ex1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">satisfies</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Ex2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">:=</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>All1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">satisfies</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>All2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">N</span><span class="main">.</span> <span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">:=</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|∈|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> fset <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_FO_Offset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_SO_Inc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> Suc <span class="main">|`|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Z</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">in</span> <span class="bound">Z</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fMax <span class="bound">Z</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Z</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">in</span> <span class="bound">Z</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fMin <span class="bound">Z</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{|</span><span class="bound">x</span><span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">|⊆|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">|∩|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">|∩|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">satisfies</span> <span class="free"><span class="bound"><span class="entity">I1</span></span></span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">|-|</span> <span class="free"><span class="bound"><span class="entity">I2</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fos</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fos</span> T <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> F <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Ex1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> List.remove1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Ex2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>All1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> List.remove1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>All2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_FO_Offset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_SO_Inc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fos</span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sos</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sos</span> T <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> F <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Ex1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Ex2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> List.remove1 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>All1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>All2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> List.remove1 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free">sos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_FO_Offset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_SO_Inc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sos</span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> remdups <span class="main">[</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_fos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>fos <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> distinct_sos<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>sos <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ε</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> T <span class="main">=</span> FBool True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> F <span class="main">=</span> FBool False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FOr <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> FAnd <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FNot <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Ex1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEx FO <span class="main">(</span><span class="free">ε</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Ex2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FEx SO <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>All1 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FAll FO <span class="main">(</span><span class="free">ε</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>All2 <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> FAll SO <span class="main">(</span><span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Lt <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>Less None <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>In <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.In False <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Const None <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Presb <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Presb None <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_FO <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_FO False <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_FO_Offset <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Plus_FO None <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_SO <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_SO <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_SO_Inc <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Suc_SO False False <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Max False <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Min False <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Empty <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Empty <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Singleton <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Singleton <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Subset <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Subset <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Disjoint <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Disjoint <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Union <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Union <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Inter <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Inter <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="free"><span class="bound"><span class="entity">bs1</span></span></span> <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="main">(</span>Eq_Diff <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">=</span> FBase <span class="main">(</span>WS1S_Formula.Eq_Diff<span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">)</span> <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">bs2</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> mk_I <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fo <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>so <span class="main">⇒</span> nat fset<span class="main">)</span> <span class="main">⇒</span> fo list <span class="main">⇒</span> so list <span class="main">⇒</span> interp"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I1</span> <span class="bound">I2</span> <span class="bound">fs</span> <span class="bound">ss</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">I1s</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">{|</span><span class="bound">I1</span> <span class="bound">x</span><span class="main">|}</span><span class="main">)</span> <span class="bound">fs</span><span class="main">;</span> <span class="bound">I2s</span> <span class="main">=</span> map <span class="bound">I2</span> <span class="bound">ss</span> <span class="keyword1">in</span> <span class="main">(</span>MSB <span class="main">(</span><span class="bound">I1s</span> <span class="main">@</span> <span class="bound">I2s</span><span class="main">)</span><span class="main">,</span> <span class="bound">I1s</span><span class="main">,</span> <span class="bound">I2s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_I1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> fo list <span class="main">⇒</span> fo <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_I1</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fMin <span class="main">(</span>index <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec_I2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"interp <span class="main">⇒</span> so list <span class="main">⇒</span> so <span class="main">⇒</span> nat fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dec_I2</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> index <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>SO"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nvars_mk_I<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">#<span class="hidden">⇩</span><sub>V</sub></span> <span class="main">(</span>mk_I <span class="free">I1</span> <span class="free">I2</span> <span class="free">fs</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> Abs_idx <span class="main">(</span>length <span class="free">fs</span><span class="main">,</span> length <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_mk_I_FO<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="hidden">⇗</span><sup>mk_I <span class="free">I1</span> <span class="free">I2</span> <span class="free">bs1</span> <span class="free">bs2</span></sup><span class="hidden">⇖</span>FO <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">bs1</span> <span class="keyword1">then</span> <span class="main">{|</span><span class="free">I1</span> <span class="main">(</span><span class="free">bs1</span> <span class="main">!</span> <span class="free">m</span><span class="main">)</span><span class="main">|}</span> <span class="keyword1">else</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> assigns_mk_I_SO<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="hidden">⇗</span><sup>mk_I <span class="free">I1</span> <span class="free">I2</span> <span class="free">bs1</span> <span class="free">bs2</span></sup><span class="hidden">⇖</span>SO <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">&lt;</span> length <span class="free">bs2</span> <span class="keyword1">then</span> <span class="free">I2</span> <span class="main">(</span><span class="free">bs2</span> <span class="main">!</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> satisfies_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>fos <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="free">I1</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">J1</span> <span class="bound">x</span><span class="main">;</span> <span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> set <span class="main">(</span>sos <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="free">I2</span> <span class="bound">X</span> <span class="main">=</span> <span class="free">J2</span> <span class="bound">X</span><span class="main">⟧</span> <span class="main">⟹</span>
  satisfies <span class="free">I1</span> <span class="free">I2</span> <span class="free">φ</span> <span class="main">⟷</span> satisfies <span class="free">J1</span> <span class="free">J2</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">I2</span></span> <span class="quoted"><span class="free">J1</span></span> <span class="quoted"><span class="free">J2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Or.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">J1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">J2</span></span></span></span><span class="main">]</span> Or.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> And.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">J1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">J2</span></span></span></span><span class="main">]</span> And.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Ex1.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">I2</span></span> <span class="quoted"><span class="skolem">J2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">y</span><span class="main">,</span> <span class="operator">cong</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ex2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Ex2.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I1</span></span> <span class="quoted"><span class="skolem">J1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span><span class="main">(</span><span class="skolem">X</span> <span class="main">:=</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J2</span><span class="main">(</span><span class="skolem">X</span> <span class="main">:=</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">Y</span><span class="main">,</span> <span class="operator">cong</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> All1.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J1</span><span class="main">(</span><span class="skolem">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">I2</span></span> <span class="quoted"><span class="skolem">J2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">y</span><span class="main">,</span> <span class="operator">cong</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>All2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> All2.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I1</span></span> <span class="quoted"><span class="skolem">J1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span><span class="main">(</span><span class="skolem">X</span> <span class="main">:=</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J2</span><span class="main">(</span><span class="skolem">X</span> <span class="main">:=</span> <span class="skolem">Y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">Y</span><span class="main">,</span> <span class="operator">cong</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> dec_I_mk_I_satisfies_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>set <span class="main">(</span>fos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">bs1</span><span class="main">;</span> set <span class="main">(</span>sos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">bs2</span><span class="main">;</span> <span class="free">𝔄</span> <span class="main">=</span> mk_I <span class="free">I1</span> <span class="free">I2</span> <span class="free">bs1</span> <span class="free">bs2</span><span class="main">⟧</span> <span class="main">⟹</span>
  satisfies <span class="main">(</span>dec_I1 <span class="free">𝔄</span> <span class="free">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="free">𝔄</span> <span class="free">bs2</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟷</span> satisfies <span class="free">I1</span> <span class="free">I2</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> satisfies_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_I1_def dec_I2_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ok_I</span> <span class="free"><span class="bound"><span class="entity">𝔄</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">.</span> index <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="bound">x</span><span class="hidden">⇗</span><sup><span class="free"><span class="bound"><span class="entity">𝔄</span></span></span></sup><span class="hidden">⇖</span>FO <span class="main">≠</span> <span class="main">{||}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok_I_mk_I<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok_I <span class="main">(</span>mk_I <span class="free">I1</span> <span class="free">I2</span> <span class="free">bs1</span> <span class="free">bs2</span><span class="main">)</span> <span class="free">bs1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ok_I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_FV_εD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">v</span> <span class="main">∈</span> FV <span class="main">(</span>ε <span class="free">bs1</span> <span class="free">bs2</span> <span class="free">φ</span><span class="main">)</span> FO<span class="main">;</span>
  set <span class="main">(</span>fos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">bs1</span><span class="main">;</span> set <span class="main">(</span>sos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">bs2</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">bs1</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> index <span class="free">bs1</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs1</span></span> <span class="quoted"><span class="free">bs2</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Ex1.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span>"</span></span> <span class="quoted"><span class="skolem">bs2</span></span><span class="main">]</span> Ex1.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_subset_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ex2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Ex2.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">bs1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span>"</span></span><span class="main">]</span> Ex2.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_subset_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> All1.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span>"</span></span> <span class="quoted"><span class="skolem">bs2</span></span><span class="main">]</span> All1.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_subset_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>All2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> All2.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">bs1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span>"</span></span><span class="main">]</span> All2.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Diff_subset_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dec_I1_Extend_FO<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">bs1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dec_I1 <span class="free">𝔄</span> <span class="free">bs1</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> fMin <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_I1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dec_I1_Extend_SO<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dec_I1 <span class="main">(</span>Extend SO <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="free">bs1</span> <span class="main">=</span> dec_I1 <span class="free">𝔄</span> <span class="free">bs1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_I1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dec_I2_Extend_FO<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dec_I2 <span class="main">(</span>Extend FO <span class="free">i</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="free">bs2</span> <span class="main">=</span> dec_I2 <span class="free">𝔄</span> <span class="free">bs2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_I2_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dec_I2_Extend_SO<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"dec_I2 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="free">𝔄</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="main">#</span> <span class="free">bs2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dec_I2 <span class="free">𝔄</span> <span class="free">bs2</span><span class="main">)</span><span class="main">(</span><span class="free">X</span> <span class="main">:=</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dec_I2_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>set <span class="main">(</span>fos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">bs1</span><span class="main">;</span> set <span class="main">(</span>sos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">bs2</span><span class="main">;</span> ok_I <span class="free">𝔄</span> <span class="free">bs1</span><span class="main">⟧</span> <span class="main">⟹</span>
  WS1S.sat <span class="free">𝔄</span> <span class="main">(</span>ε <span class="free">bs1</span> <span class="free">bs2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span>
  satisfies <span class="main">(</span>dec_I1 <span class="free">𝔄</span> <span class="free">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="free">𝔄</span> <span class="free">bs2</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">𝔄</span></span> <span class="quoted"><span class="free">bs1</span></span> <span class="quoted"><span class="free">bs2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Or.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">bs1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">bs2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">𝔄</span></span></span></span><span class="main">]</span> Or.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def ok_I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> And.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">bs1</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">bs2</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">𝔄</span></span></span></span><span class="main">]</span> And.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def ok_I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Not.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">bs1</span></span> <span class="quoted"><span class="skolem">bs2</span></span> <span class="quoted"><span class="skolem">𝔄</span></span><span class="main">]</span> Not.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def ok_I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fset"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Ex1.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="skolem">bs2</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span>
      satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ex1.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ok_I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="skolem">𝔄</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="skolem">bs2</span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="skolem">bs2</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="skolem">𝔄</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="skolem">𝔄</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="skolem">𝔄</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="skolem">𝔄</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="main">{|</span><span class="skolem">n</span><span class="main">|}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>dec_I2 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="main">{|</span><span class="skolem">n</span><span class="main">|}</span><span class="main">)</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="main">{|</span><span class="skolem">n</span><span class="main">|}</span><span class="main">)</span> <span class="main">(</span>ε <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="skolem">bs2</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="skolem">𝔄</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="skolem">bs2</span> <span class="main">(</span>Ex1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ex2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fset"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Ex2.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span>
      satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ex2.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ok_I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="skolem">𝔄</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="skolem">bs2</span> <span class="main">(</span>Ex2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> WS1S.sat <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span><span class="main">)</span> <span class="skolem">bs1</span><span class="main">)</span>
      <span class="main">(</span>dec_I2 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> satisfies <span class="main">(</span>dec_I1 <span class="skolem">𝔄</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="skolem">𝔄</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="main">(</span>Ex2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fset"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> All1.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="skolem">bs2</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span>
      satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> All1.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ok_I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="skolem">𝔄</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="skolem">bs2</span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
      <span class="keyword1"><span class="command">from</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="main">{|</span><span class="skolem">n</span><span class="main">|}</span><span class="main">)</span> <span class="main">(</span>ε <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="skolem">bs2</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="main">{|</span><span class="skolem">n</span><span class="main">|}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>dec_I2 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="main">{|</span><span class="skolem">n</span><span class="main">|}</span><span class="main">)</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="skolem">𝔄</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="skolem">𝔄</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="skolem">𝔄</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="skolem">𝔄</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fset"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{||}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>dec_I2 <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≠</span> <span class="main">{||}</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend FO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="skolem">bs2</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> All1.prems in_FV_εD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">bs1</span>"</span></span> <span class="quoted"><span class="skolem">bs2</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="skolem">𝔄</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="skolem">bs2</span> <span class="main">(</span>All1 <span class="skolem">x</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def ok_I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits order.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>All2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat fset"</span></span>
    <span class="keyword1"><span class="command">from</span></span> All2.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span>
      satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> All2.hyps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ok_I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"WS1S.sat <span class="skolem">𝔄</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="skolem">bs2</span> <span class="main">(</span>All2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> WS1S.sat <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span><span class="main">)</span> <span class="main">(</span>ε <span class="skolem">bs1</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> WS1S.sat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> satisfies <span class="main">(</span>dec_I1 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span><span class="main">)</span> <span class="skolem">bs1</span><span class="main">)</span>
      <span class="main">(</span>dec_I2 <span class="main">(</span>Extend SO <span class="main">0</span> <span class="skolem">𝔄</span> <span class="bound">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">#</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> satisfies <span class="main">(</span>dec_I1 <span class="skolem">𝔄</span> <span class="skolem">bs1</span><span class="main">)</span> <span class="main">(</span>dec_I2 <span class="skolem">𝔄</span> <span class="skolem">bs2</span><span class="main">)</span> <span class="main">(</span>All2 <span class="skolem">X</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> WS1S.sat_def Let_def dec_I1_def dec_I2_def ok_I_def
  restrict_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits order.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">eqv</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fs</span> <span class="main">=</span> List.union <span class="main">(</span>fos <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>fos <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">;</span> <span class="bound">ss</span> <span class="main">=</span> List.union <span class="main">(</span>sos <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>sos <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="keyword1">in</span> check_eqv <span class="main">(</span>Abs_idx <span class="main">(</span>length <span class="bound">fs</span><span class="main">,</span> length <span class="bound">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ε <span class="bound">fs</span> <span class="bound">ss</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>ε <span class="bound">fs</span> <span class="bound">ss</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eqv_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"eqv <span class="free">φ</span> <span class="free">ψ</span> <span class="main">⟹</span> satisfies <span class="free">I1</span> <span class="free">I2</span> <span class="free">φ</span> <span class="main">⟷</span> satisfies <span class="free">I1</span> <span class="free">I2</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eqv_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> check_eqv_sound<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>
    <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"mk_I <span class="free"><span class="free"><span class="free">I1</span></span></span> <span class="free"><span class="free"><span class="free">I2</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>List.union <span class="main"><span class="main"><span class="main">(</span></span></span>fos <span class="free"><span class="free"><span class="free">φ</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>fos <span class="free"><span class="free"><span class="free">ψ</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>List.union <span class="main"><span class="main"><span class="main">(</span></span></span>sos <span class="free"><span class="free"><span class="free">φ</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>sos <span class="free"><span class="free"><span class="free">ψ</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_ε dec_I_mk_I_satisfies_cong<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Thm</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> eqv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> T"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"Thm <span class="free">Φ</span> <span class="main">⟹</span> satisfies <span class="free">I1</span> <span class="free">I2</span> <span class="free">Φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Thm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> eqv_sound<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">I1</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">I2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_fo
<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_so

<span class="keyword1"><span class="command">instantiation</span></span> fo <span class="main">::</span> <span class="quoted">equal</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">equal_fo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"fo <span class="main">⇒</span> fo <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> so <span class="main">::</span> <span class="quoted">equal</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">equal_so</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"so <span class="main">⇒</span> so <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>