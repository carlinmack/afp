<div id="Weight_Balanced_Trees_log">
<div class="head">
<h1>Theory Weight_Balanced_Trees_log</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weight-Balanced Trees Have Logarithmic Height›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory is based on the original definition of weight-balanced trees
\cite{NievergeltR72,NievergeltR73}
where the size of the child of a node must be a minimum and a maximum fraction
of the size of the node.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Weight_Balanced_Trees_log
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* FIXME mod field_simps *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> neq0_if <span class="main">=</span> less_imp_neq dual_order.strict_implies_not_eq

<span class="keyword1"><span class="command">locale</span></span> WBT0 <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">assumes</span></span> alpha_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alpha_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wbt</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wbt</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">wbt</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">wbt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ratio</span> <span class="main">=</span> size1 <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">/</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> size1 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
  <span class="keyword1">in</span> <span class="free">α</span> <span class="main">≤</span> <span class="bound">ratio</span> <span class="main">∧</span> <span class="bound">ratio</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_size1_exp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wbt <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span>  <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> alpha_ub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size1 <span class="var">?t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">l</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"size1 <span class="skolem">r</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="dynamic"><span class="dynamic">field_simps</span></span> add_pos_pos neq0_if<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Leaf <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> Leaf"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> not_Leafs<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">≤</span> height <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> hlr<span class="main">:</span> True
      <span class="keyword1"><span class="command">hence</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hr<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leafs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ r<span class="main">]</span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2 0<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">r</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> eq_height_0<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hlr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> hlr<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hl<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leafs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ l<span class="main">]</span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1 0<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="skolem">l</span><span class="main">)</span> <span class="main">*</span> <span class="var">?s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> eq_height_0<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> hlr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_size1_log<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wbt <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> height_size1_exp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_ub <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_ub <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_nat_power<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_ub <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alpha_pos alpha_ub <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> log_divide<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Weight_Balanced_Trees">
<div class="head">
<h1>Theory Weight_Balanced_Trees</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow &amp; Stefan Dirix *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Weight Balanced Tree Implementation of Sets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory follows Hirai and Yamamoto but we do not prove their general
theorem. Instead we provide a short parameterized theory that, when
interpreted with valid parameters, will prove perservation of the invariant
for these parameters.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Weight_Balanced_Trees
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Isin2.html">HOL-Data_Structures.Isin2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> neq_Leaf2_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">l</span> <span class="bound">a</span> <span class="bound">n</span> <span class="bound">r</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Node <span class="bound">l</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> wbt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> nat<span class="main">)</span> tree"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_wbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_wbt</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_wbt</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Smart constructor:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> size_wbt <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> size_wbt <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">"Basic Rotations:"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rot1L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rot1L</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> N <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rot1R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rot1R</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> N <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rot2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rot2</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> N <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">B2</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"WB trees"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Parameters:
  <span class="antiquoted"><span class="antiquoted">➧</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span> determines when a tree needs to be rebalanced
  <span class="antiquoted"><span class="antiquoted">➧</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ›</span></span></span></span> determines whether it needs to be single or double rotation.

\noindent We represent rational numbers as pairs: <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ = Δ1/Δ2›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ = Γ1/Γ2›</span></span></span></span>.
\bigskip

Hirai and Yamamoto \cite{HiraiY11} proved that under the following constraints
insertion and deletion preserve the WB invariant, i.e.\
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ›</span></span></span></span> are \emph{valid}:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_params</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">valid_params</span> <span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">*</span> <span class="numeral">9</span>  <span class="comment1">― ‹right: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Δ &lt; 4.5›</span></span>›</span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="comment1">― ‹left: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ + 1 ≤ Δ›</span></span>›</span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">Δ2</span></span></span><span class="main">)</span>  <span class="comment1">― ‹lower: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ ≥ (Δ + 1) / Δ›</span></span>›</span> <span class="main">∧</span>
  <span class="comment1">― ‹upper:›</span>
  <span class="main">(</span><span class="numeral">5</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">∧</span> <span class="main">1</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">&lt;</span> <span class="numeral">3</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span><span class="main">*</span><span class="numeral">2</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span><span class="main">*</span><span class="numeral">3</span><span class="main">)</span>
     <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ ≤ 3/2›</span></span> if <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>2.5 ≤ Δ &lt; 3›</span></span>›</span> <span class="main">∧</span>
  <span class="main">(</span><span class="numeral">3</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">≤</span> <span class="main">1</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">&lt;</span> <span class="numeral">7</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span><span class="main">*</span><span class="numeral">2</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span><span class="main">*</span><span class="numeral">4</span><span class="main">)</span>
     <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ ≤ 4/2›</span></span> if <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>3 ≤ Δ &lt; 3.5›</span></span>›</span> <span class="main">∧</span>
  <span class="main">(</span><span class="numeral">7</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">∧</span> <span class="main">1</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">&lt;</span> <span class="numeral">4</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span><span class="main">*</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span><span class="main">*</span><span class="numeral">4</span><span class="main">)</span>
     <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ ≤ 4/3›</span></span> when <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>3.5 ≤ Δ &lt; 4›</span></span>›</span> <span class="main">∧</span>
  <span class="main">(</span><span class="numeral">4</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">≤</span> <span class="main">1</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">∧</span> <span class="numeral">2</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ1</span></span></span> <span class="main">&lt;</span> <span class="numeral">9</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">Δ2</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Γ1</span></span></span><span class="main">*</span><span class="numeral">3</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Γ2</span></span></span><span class="main">*</span><span class="numeral">5</span><span class="main">)</span>
     <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ ≤ 5/3›</span></span> when <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>4 ≤ Δ &lt; 4.5›</span></span>›</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We do not make use of these constraints and do not prove that they guarantee
preservation of the invariant. Instead, we provide generic proofs of invariant preservation
that work for many (all?) interpretations of locale <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>WBT›</span></span></span></span> (below) with valid parameters.
Further down we demonstrate this by interpreting <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>WBT›</span></span></span></span> with a selection of valid parameters.
[For some parameters, some <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>smt›</span></span></span></span> proofs fail because <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>smt›</span></span></span></span> on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nat›</span></span></span></span>s fails although
on non-negative <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>int›</span></span></span></span>s it succeeds, i.e.\ the goal should be provable.
This is a shortcoming of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>smt›</span></span></span></span> that is under investigation.]

Locale <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>WBT›</span></span></span></span> comes with some minimal assumptions (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Γ1 &gt; Γ2›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Δ1 &gt; Δ2›</span></span></span></span>) which follow
from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> valid_params<span class="antiquote"><span class="antiquote">}</span></span></span></span> and from which we conclude some simple lemmas.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> WBT <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Δ1</span> <span class="free">Δ2</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Γ1</span> <span class="free">Γ2</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">assumes</span></span> Delta_gr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Δ1</span> <span class="main">&gt;</span> <span class="free">Δ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Gamma_gr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ1</span> <span class="main">&gt;</span> <span class="free">Γ2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* How to prove the assumptions from valid_params:
lemma Gamma_gr1: "Γ1 &gt; Γ2"
proof -
  have "¬ (Δ1 + Δ2) * Γ2 ≤ Δ1 * Γ2" by (simp add: not0)
  thus ?thesis by (metis order.trans lower mult.commute mult_le_cancel2 not_le)
qed

lemma Delta_gr2: "Δ1 &gt; 2 * Δ2"
proof -
  from Gamma_gr1 have "Γ2 * Δ2 &lt; Γ1 * Δ2" by (simp add: not0)
  with left have "2 * Γ2 * Δ2 &lt; Γ2 * Δ1" by linarith
  thus ?thesis by(simp)
qed
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Balance Indicators"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balanced1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balanced1</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">Δ1</span> <span class="main">*</span> <span class="main">(</span>size_wbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="free">Δ2</span> <span class="main">*</span> <span class="main">(</span>size_wbt <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The global weight-balanced tree invariant:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wbt</span> Leaf <span class="main">=</span> True"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wbt</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> size <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> balanced1 <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> balanced1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">wbt</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">wbt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_wbt_eq_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wbt <span class="free">t</span> <span class="main">⟹</span> size_wbt <span class="free">t</span> <span class="main">=</span> size <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">single</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">single</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">Γ1</span> <span class="main">*</span> <span class="main">(</span>size_wbt <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">Γ2</span> <span class="main">*</span> <span class="main">(</span>size_wbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Code"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rotateL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rotateL</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> single <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">then</span> rot1L <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">else</span> rot2 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balanceL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balanceL</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> balanced1 <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> N <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> rotateL <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rotateR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rotateR</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> single <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> rot1R <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">else</span> rot2 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balanceR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balanceR</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> balanced1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> N <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> rotateR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> Node Leaf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span>
      LT <span class="main">⇒</span> balanceR <span class="main">(</span><span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
      GT <span class="main">⇒</span> balanceL <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">|</span>
      EQ <span class="main">⇒</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">split_min</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">split_min</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> balanceL <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del_max</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> <span class="free">del_max</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> balanceR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> Leaf Leaf <span class="main">=</span> Leaf"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> Leaf <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> Leaf <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span><span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> size <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&gt;</span> size <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">lMax</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> del_max <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span> balanceL <span class="bound">l'</span> <span class="bound">lMax</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">rMin</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> split_min <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span> balanceR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">rMin</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> wbt <span class="main">⇒</span> <span class="tfree">'a</span> wbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> balanceL <span class="main">(</span><span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
     GT <span class="main">⇒</span> balanceR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> combine <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proofs"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A WB tree must be of a certain structure if balanced1 and single are False.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_Leaf_if_not_balanced1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> balanced1 <span class="free">l</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Leaf"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">with</span></span> assms Delta_gr1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_Leaf_if_not_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> single <span class="free">l</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> Leaf"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">with</span></span> assms Gamma_gr1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Inorder Properties"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_rot2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> inorder<span class="main">(</span>rot2 <span class="free">A</span> <span class="free">a</span> <span class="free">B</span> <span class="free">b</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">A</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">B</span> <span class="main">@</span> <span class="free">b</span> <span class="main">#</span> inorder <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rot2.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_rotateL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> inorder<span class="main">(</span>rotateL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rotateL.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_rot2 not_Leaf_if_not_single<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_rotateR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> inorder<span class="main">(</span>rotateR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rotateR.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_rot2 not_Leaf_if_not_single<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins_list_simps inorder_rotateL inorder_rotateR not_Leaf_if_not_balanced1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_minD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> <span class="free">x</span> <span class="main">#</span> inorder <span class="free">t'</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_min.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems inorder_rotateL not_Leaf_if_not_balanced1
     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> del_maxD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"del_max <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> inorder <span class="free">t'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_max.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems inorder_rotateR not_Leaf_if_not_balanced1
     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_combine<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> combine.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_maxD split_minD inorder_rotateL inorder_rotateR not_Leaf_if_not_balanced1
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rotateL.simps rotateR.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_list_simps inorder_combine inorder_rotateL inorder_rotateR
     not_Leaf_if_not_balanced1 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rotateL.simps rotateR.simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Size Lemmas"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Insertion"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_rot2L<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> size<span class="main">(</span>rot2 <span class="free">A</span> <span class="free">a</span> <span class="free">B</span> <span class="free">b</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> size <span class="free">A</span> <span class="main">+</span> size <span class="free">B</span> <span class="main">+</span> size <span class="free">C</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rot2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_rotateR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> size<span class="main">(</span>rotateR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> size <span class="free">l</span> <span class="main">+</span> size <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rotateR.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_Leaf_if_not_single <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rot2.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_rotateL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> size<span class="main">(</span>rotateL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> size <span class="free">l</span> <span class="main">+</span> size <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rotateL.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_Leaf_if_not_single <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rot2.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_length<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">t</span> <span class="main">=</span> length <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inorder.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> isin <span class="free">t</span> <span class="free">x</span> <span class="keyword1">then</span> size <span class="free">t</span> <span class="keyword1">else</span> Suc <span class="main">(</span>size <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree2_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_Leaf_if_not_balanced1<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Deletion"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_delete_if_isin<span class="main">:</span> <span class="quoted"><span class="quoted">"isin <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">=</span> Suc <span class="main">(</span>size<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree2_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node _ <span class="skolem">a</span> _ _<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cmp <span class="free">x</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> LT <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Node.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_Leaf_if_not_balanced1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> EQ <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> size_length inorder_combine length_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> GT <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Node.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> not_Leaf_if_not_balanced1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_id_if_wbt_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"wbt <span class="free">t</span> <span class="main">⟹</span> <span class="main">¬</span> isin <span class="free">t</span> <span class="free">x</span> <span class="main">⟹</span> delete <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_split_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> size <span class="free">t</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="main">(</span>snd <span class="main">(</span>split_min <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_Leaf_if_not_balanced1 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_del_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> size <span class="free">t</span> <span class="main">=</span> Suc<span class="main">(</span>size<span class="main">(</span>snd<span class="main">(</span>del_max <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_Leaf_if_not_balanced1 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary Definitions"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balanced1_arith</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balanced1_arith</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">Δ1</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="free">Δ2</span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">balanced2_arith</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">balanced2_arith</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span>balanced1_arith <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> balanced1_arith <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">singly_balanced_arith</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">singly_balanced_arith</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span>balanced2_arith <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> balanced2_arith <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">doubly_balanced_arith</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">doubly_balanced_arith</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
  <span class="main">(</span>balanced2_arith <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> balanced2_arith <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> balanced2_arith <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Preservation of WB tree Invariant for Concrete Parameters"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A number of sample interpretations with valid parameters:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> WBT <span class="keyword2"><span class="keyword">where</span></span>
  Δ1 <span class="main">=</span> <span class="quoted"><span class="numeral">25</span></span> <span class="keyword2"><span class="keyword">and</span></span> Δ2 <span class="main">=</span> <span class="quoted"><span class="numeral">10</span></span> <span class="keyword2"><span class="keyword">and</span></span> Γ1 <span class="main">=</span> <span class="quoted"><span class="numeral">14</span></span> <span class="keyword2"><span class="keyword">and</span></span> Γ2 <span class="main">=</span> <span class="quoted"><span class="numeral">10</span></span>
<span class="comment1">(* Δ1 = 25 and Δ2 = 10 and Γ1 = 15 and Γ2 = 10*)</span>
<span class="comment1">(* Δ1 = 28 and Δ2 = 10 and Γ1 = 10 and Γ2 = 7*)</span>

<span class="comment1">(* Δ1 = 3 and Δ2 = "Suc 0" and Γ1 = 4 and Γ2 = 3*)</span>
  <span class="comment1">(* The only integer solution: *)</span>
<span class="comment1">(* Δ1 = 3 and Δ2 = "Suc 0" and Γ1 = 2 and Γ2 = "Suc 0"*)</span>
<span class="comment1">(* Δ1 = 31 and Δ2 = 10 and Γ1 = 18 and Γ2 = 10*)</span>

<span class="comment1">(* Δ1 = 35 and Δ2 = 10 and Γ1 = 45 and Γ2 = 35*)</span>
<span class="comment1">(* Δ1 = 35 and Δ2 = 10 and Γ1 = 4 and Γ2 = 3*)</span>
<span class="comment1">(* Δ1 = 37 and Δ2 = 10 and Γ1 = 13 and Γ2 = 10*)</span>

<span class="comment1">(* Δ1 = 4 and Δ2 = "Suc 0" and Γ1 = 5 and Γ2 = 4*)</span>
<span class="comment1">(* Δ1 = 4 and Δ2 = "Suc 0" and Γ1 = 5 and Γ2 = 3*)</span>
<span class="comment1">(* Δ1 = 17 and Δ2 = 4 and Γ1 = 5 and Γ2 = 3 *)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WBT_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wbt_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wbt <span class="free">t</span> <span class="main">⟹</span> wbt <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree2_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">a</span> _ <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cmp <span class="free">x</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> EQ <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> LT
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"balanced1 <span class="skolem">r</span> <span class="var">?l'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node size_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_balanced1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">ll'</span></span> <span class="skolem"><span class="skolem">al'</span></span> <span class="skolem"><span class="skolem">rl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">ll'</span> <span class="main">(</span><span class="skolem">al'</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">rl'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"single <span class="skolem">rl'</span> <span class="skolem">ll'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node size_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> isDouble<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">llr'</span></span> <span class="skolem"><span class="skolem">alr'</span></span> <span class="skolem"><span class="skolem">rlr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rl'</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">llr'</span> <span class="main">(</span><span class="skolem">alr'</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">rlr'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_single tree2_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> isDouble Node size_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> GT
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"balanced1 <span class="skolem">l</span> <span class="var">?r'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node size_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r'</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_balanced1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">lr'</span></span> <span class="skolem"><span class="skolem">ar'</span></span> <span class="skolem"><span class="skolem">rr'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r'</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">lr'</span> <span class="main">(</span><span class="skolem">ar'</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">rr'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"single <span class="skolem">lr'</span> <span class="skolem">rr'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node size_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> isDouble<span class="main">:</span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lr'</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Node isDouble size_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf2_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">smt_nat_as_int</span><span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Show that invariant is preserved by deletion in the left/right subtree:
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wbt_balanceL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>Node <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wbt <span class="free">l'</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="free">l</span> <span class="main">=</span> size <span class="free">l'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>balanceL <span class="free">l'</span> <span class="free">a'</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> rl'Balanced<span class="main">:</span> <span class="quoted"><span class="quoted">"balanced1 <span class="free">r</span> <span class="free">l'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rBalanced<span class="main">:</span> <span class="quoted"><span class="quoted">"wbt <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"balanced1 <span class="free">l'</span> <span class="free">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> rBalanced rl'Balanced <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> notBalanced<span class="main">:</span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_balanced1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">lr</span></span> <span class="skolem"><span class="skolem">ar</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> Node <span class="skolem">lr</span> <span class="main">(</span><span class="skolem">ar</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">rr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"single <span class="skolem">lr</span> <span class="skolem">rr</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> single<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"singly_balanced_arith <span class="main">(</span>size <span class="free">l'</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">lr</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">rr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> notBalanced rl'Balanced rBalanced single assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">smt</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> notBalanced single assms<span class="main">(</span>2<span class="main">)</span> rBalanced <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> isDouble<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lr</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="skolem"><span class="skolem">llr</span></span> <span class="skolem"><span class="skolem">alr</span></span> <span class="skolem"><span class="skolem">rlr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lr</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">llr</span> <span class="main">(</span><span class="skolem">alr</span><span class="main">,</span> <span class="skolem">k2</span><span class="main">)</span> <span class="skolem">rlr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"doubly_balanced_arith <span class="main">(</span>size <span class="free">l'</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">llr</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">rlr</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">rr</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> notBalanced rl'Balanced rBalanced isDouble assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted">"_ = _"</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">smt</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> notBalanced isDouble assms<span class="main">(</span>2<span class="main">)</span> rBalanced <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wbt_balanceR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>Node <span class="free">l</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wbt <span class="free">r'</span>"</span></span> <span class="quoted"><span class="quoted">"size <span class="free">r</span> <span class="main">=</span> size <span class="free">r'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>balanceR <span class="free">l</span> <span class="free">a'</span> <span class="free">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> lr'Balanced<span class="main">:</span> <span class="quoted"><span class="quoted">"balanced1 <span class="free">l</span> <span class="free">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lBalanced<span class="main">:</span> <span class="quoted"><span class="quoted">"wbt <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"balanced1 <span class="free">r'</span> <span class="free">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lBalanced lr'Balanced <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> notBalanced<span class="main">:</span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_balanced1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">ll</span></span> <span class="skolem"><span class="skolem">al</span></span> <span class="skolem"><span class="skolem">rl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="main">(</span><span class="skolem">al</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">rl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"single <span class="skolem">rl</span> <span class="skolem">ll</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> single<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"singly_balanced_arith <span class="main">(</span>size <span class="skolem">rl</span><span class="main">)</span> <span class="main">(</span>size <span class="free">r'</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">ll</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> notBalanced lr'Balanced lBalanced single assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span>"</span></span></span></span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">smt</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lBalanced notBalanced single <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> isDouble<span class="main">:</span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rl</span> <span class="main">≠</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> not_Leaf_if_not_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">lrl</span></span> <span class="skolem"><span class="skolem">arl</span></span> <span class="skolem"><span class="skolem">rrl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rl</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">lrl</span> <span class="main">(</span><span class="skolem">arl</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">rrl</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"doubly_balanced_arith <span class="main">(</span>size <span class="skolem">ll</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">lrl</span><span class="main">)</span> <span class="main">(</span>size <span class="skolem">rrl</span><span class="main">)</span> <span class="main">(</span>size <span class="free">r'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> notBalanced lr'Balanced lBalanced isDouble assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="main">(</span><span class="operator">thin_tac</span> <span class="quoted">"_ = _"</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">smt</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lBalanced notBalanced isDouble <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wbt_split_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> wbt <span class="free">t</span> <span class="main">⟹</span> wbt <span class="main">(</span>snd <span class="main">(</span>split_min <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_min.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">m</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree2_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="skolem">al</span> <span class="skolem">n</span> <span class="skolem">rl</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>split_min <span class="main">(</span>Node <span class="skolem">ll</span> <span class="main">(</span><span class="skolem">al</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">rl</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> delBalanceL<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>split_min <span class="main">(</span>Node <span class="skolem">l</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> balanceL <span class="var">?l'</span> <span class="skolem">a</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="var">?l'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> Node <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">l</span> <span class="main">=</span> size <span class="var">?l'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node size_split_min <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 neq_Leaf2_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>balanceL <span class="var">?l'</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wbt_balanceL<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delBalanceL <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wbt_del_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> wbt <span class="free">t</span> <span class="main">⟹</span> wbt <span class="main">(</span>snd <span class="main">(</span>del_max <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">m</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree2_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">lr</span> <span class="skolem">ar</span> <span class="skolem">n</span> <span class="skolem">rr</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> delMaxR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> snd <span class="main">(</span>del_max <span class="main">(</span>Node <span class="skolem">lr</span> <span class="main">(</span><span class="skolem">ar</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">rr</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> delBalanceR<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>del_max <span class="main">(</span>Node <span class="skolem">l</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> balanceR <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> Node delMaxR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">r</span> <span class="main">=</span> size <span class="skolem">r'</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> size_del_max Node delMaxR
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 tree.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>balanceR <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wbt_balanceR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delBalanceR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wbt_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"wbt <span class="free">t</span> <span class="main">⟹</span> wbt <span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tree2_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">n</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isin <span class="main">(</span>Node <span class="skolem">l</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems delete_id_if_wbt_notin <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> isin<span class="main">:</span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cmp <span class="free">x</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> LT
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">l</span> <span class="main">=</span> size <span class="var">?l'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LT isin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_delete_if_isin<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>balanceL <span class="var">?l'</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wbt_balanceL<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LT<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> GT
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">r</span> <span class="main">=</span> size <span class="var">?r'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> GT Node.prems isin size_delete_if_isin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="main">(</span>balanceR <span class="skolem">l</span> <span class="skolem">a</span> <span class="var">?r'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Node.prems wbt_balanceR<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> GT<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> EQ
      <span class="keyword1"><span class="command">hence</span></span> xCombine<span class="main">:</span> <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> combine <span class="skolem">l</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> Leaf"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Leaf"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> lrNotLeaf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> Leaf"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> Leaf"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kl</span></span> <span class="skolem"><span class="skolem">kr</span></span> <span class="skolem"><span class="skolem">ll</span></span> <span class="skolem"><span class="skolem">al</span></span> <span class="skolem"><span class="skolem">rl</span></span> <span class="skolem"><span class="skolem">lr</span></span> <span class="skolem"><span class="skolem">ar</span></span> <span class="skolem"><span class="skolem">rr</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">ll</span> <span class="main">(</span><span class="skolem">al</span><span class="main">,</span> <span class="skolem">kl</span><span class="main">)</span> <span class="skolem">rl</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span>Node <span class="skolem">lr</span> <span class="main">(</span><span class="skolem">ar</span><span class="main">,</span> <span class="skolem">kr</span><span class="main">)</span> <span class="skolem">rr</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> neq_Leaf2_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"size <span class="skolem">l</span> <span class="main">&gt;</span> size <span class="skolem">r</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lMax</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> letMax<span class="main">:</span> <span class="quoted"><span class="quoted">"del_max <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lMax</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> balanceLeft<span class="main">:</span> <span class="quoted"><span class="quoted">"combine <span class="skolem">l</span> <span class="skolem">r</span> <span class="main">=</span> balanceL <span class="skolem">l'</span> <span class="skolem">lMax</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹size <span class="skolem">l</span> <span class="main">&gt;</span> size <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="skolem">l'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Node.prems wbt_del_max<span class="main">[</span><span class="operator">OF</span> lrNotLeaf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> letMax
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wbt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">l</span> <span class="main">=</span> size <span class="skolem">l'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> size_del_max<span class="main">[</span><span class="operator">OF</span> lrNotLeaf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> letMax <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt<span class="main">(</span>balanceL <span class="skolem">l'</span> <span class="skolem">lMax</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wbt_balanceL <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Node.prems<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> balanceLeft <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rMin</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> letMin<span class="main">:</span> <span class="quoted"><span class="quoted">"split_min <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">rMin</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> balanceRight<span class="main">:</span> <span class="quoted"><span class="quoted">"combine <span class="skolem">l</span> <span class="skolem">r</span> <span class="main">=</span> balanceR <span class="skolem">l</span> <span class="skolem">rMin</span> <span class="skolem">r'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> size <span class="skolem">l</span> <span class="main">&gt;</span> size <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt <span class="skolem">r'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Node.prems wbt_split_min<span class="main">[</span><span class="operator">OF</span> lrNotLeaf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> letMin
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wbt.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">r</span> <span class="main">=</span> size <span class="skolem">r'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> size_split_min<span class="main">[</span><span class="operator">OF</span> lrNotLeaf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> letMin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wbt<span class="main">(</span>balanceR <span class="skolem">l</span> <span class="skolem">rMin</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wbt_balanceR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Node.prems<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> balanceRight <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The final correctness proof›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> S<span class="main">:</span> Set_by_Ordered
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">Leaf</span> <span class="keyword2"><span class="keyword">and</span></span> isin <span class="main">=</span> <span class="quoted">isin</span> <span class="keyword2"><span class="keyword">and</span></span> insert <span class="main">=</span> <span class="quoted">insert</span> <span class="keyword2"><span class="keyword">and</span></span> delete <span class="main">=</span> <span class="quoted">delete</span>
<span class="keyword2"><span class="keyword">and</span></span> inorder <span class="main">=</span> <span class="quoted">inorder</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted">wbt</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isin_set_inorder<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_insert<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_delete<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wbt_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wbt_delete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>