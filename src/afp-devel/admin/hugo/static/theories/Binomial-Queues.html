<div id="PQ">
<div class="head">
<h1>Theory PQ</h1>
</div>
<pre class="source"><span class="comment1">(* Authors:  Florian Haftmann and René Neumann, TU Muenchen *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract priority queues›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PQ
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generic Lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tl_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">q</span> <span class="main">⟹</span> set <span class="main">(</span>tl <span class="free">q</span><span class="main">)</span> <span class="main">=</span> set <span class="free">q</span> <span class="main">-</span> <span class="main">{</span>hd <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type of abstract priority queues›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span><span class="quoted">linorder</span><span class="main">)</span> pq <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list<span class="main">.</span> distinct <span class="main">(</span>map fst <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="main">(</span>map snd <span class="bound">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> alist_of Abs_pq
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> <span class="var">?pq</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_of_Abs_pq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map snd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alist_of <span class="main">(</span>Abs_pq <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Abs_pq_inverse<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstype</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_pq <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> alist_of_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_fst_alist_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alist_of <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_alist_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_fst_alist_of <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_snd_alist_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alist_of <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_of_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alist_of <span class="free">p</span> <span class="main">=</span> alist_of <span class="free">q</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"alist_of <span class="free">p</span> <span class="main">=</span> alist_of <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_pq <span class="main">(</span>alist_of <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Abs_pq <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_of_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted">"<span class="entity">values</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">|</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">values</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> map fst <span class="main">(</span>alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">priorities</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">∥</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">priorities</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> map snd <span class="main">(</span>alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> values_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> priorities_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">∥</span><span class="free">q</span><span class="main">∥</span> <span class="main">=</span> snd <span class="main">`</span> set <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priorities_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">priority</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">priority</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> map_of <span class="main">(</span>alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="main">(</span>alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> Abs_pq <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_empty_alist_of <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_empty <span class="free">q</span> <span class="main">⟹</span> alist_of <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_is_empty_alist_of <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span> <span class="main">⟹</span> alist_of <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_of_empty <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"alist_of empty <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def Abs_pq_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> values_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">|</span>empty<span class="main">|</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> priorities_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∥</span>empty<span class="main">∥</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priorities_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> values_empty_nothing <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∉</span> set <span class="main">|</span>empty<span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_empty_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_empty <span class="free">q</span> <span class="main">⟷</span> <span class="free">q</span> <span class="main">=</span> empty"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_empty <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"alist_of <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_empty_alist_of<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_pq <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Abs_pq <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def alist_of_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_empty_empty_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_empty empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_empty_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_snd_alist_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="main">(</span>the <span class="main">∘</span> priority <span class="free">q</span><span class="main">)</span> <span class="main">(</span>values <span class="free">q</span><span class="main">)</span> <span class="main">=</span> map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def priority_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> image_snd_alist_of<span class="main">:</span>
  <span class="quoted"><span class="quoted">"the <span class="main">`</span> priority <span class="free">q</span> <span class="main">`</span> set <span class="main">(</span>values <span class="free">q</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">`</span> set <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> map_snd_alist_of <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span>the <span class="main">∘</span> priority <span class="free">q</span><span class="main">)</span> <span class="main">(</span>values <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Min_snd_alist_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>snd <span class="main">`</span> set <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>hd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>set <span class="skolem">ps</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≥</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>set <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Min_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>set <span class="main">(</span>map snd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> priority_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xp</span> <span class="main">∈</span> set <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"priority <span class="free">q</span> <span class="main">(</span>fst <span class="free">xp</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="free">xp</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priority_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> priority_Min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"priority <span class="free">q</span> <span class="main">(</span>min <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Min <span class="main">(</span>the <span class="main">`</span> priority <span class="free">q</span> <span class="main">`</span> set <span class="main">(</span>values <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def image_snd_alist_of Min_snd_alist_of priority_fst<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> priority_Min_priorities<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"priority <span class="free">q</span> <span class="main">(</span>min <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Min <span class="main">(</span>set <span class="main">∥</span><span class="free">q</span><span class="main">∥</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priority_Min image_snd_alist_of priorities_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">push</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> pq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> pq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> Abs_pq <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∉</span> set <span class="main">(</span>values <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
           <span class="keyword1">then</span> insort_key snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
           <span class="keyword1">else</span> alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Min_snd_hd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> sorted <span class="main">(</span>map snd <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> Min <span class="main">(</span>snd <span class="main">`</span> set <span class="free">q</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="free">q</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ord_class.min_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_construct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>min <span class="free">q</span><span class="main">,</span> the <span class="main">(</span>priority <span class="free">q</span> <span class="main">(</span>min <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>priority <span class="free">q</span> <span class="main">(</span>min <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>hd <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_snd_hd <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"alist_of <span class="free">q</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priority_Min_priorities priorities_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_first_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_of_push <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"alist_of <span class="main">(</span>push <span class="free">k</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">∉</span> set <span class="main">(</span>values <span class="free">q</span><span class="main">)</span> <span class="keyword1">then</span> insort_key snd <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span> <span class="keyword1">else</span> alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_fst_alist_of <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map set_insort_key distinct_insort not_in_first_image
      push_def values_def sorted_insort_key <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alist_of_Abs_pq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> push_values <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>push <span class="free">k</span> <span class="free">p</span> <span class="free">q</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def set_insort_key<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> push_priorities <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∉</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">⟹</span> set <span class="main">∥</span>push <span class="free">k</span> <span class="free">p</span> <span class="free">q</span><span class="main">∥</span> <span class="main">=</span> set <span class="main">∥</span><span class="free">q</span><span class="main">∥</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">⟹</span> set <span class="main">∥</span>push <span class="free">k</span> <span class="free">p</span> <span class="free">q</span><span class="main">∥</span> <span class="main">=</span> set <span class="main">∥</span><span class="free">q</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priorities_def set_insort_key<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_is_empty_push <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="main">(</span>push <span class="free">k</span> <span class="free">p</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def is_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> push_commute<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"push <span class="free">w</span> <span class="free">b</span> <span class="main">(</span>push <span class="free">v</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>push <span class="free">w</span> <span class="free">b</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alist_of_eqI insort_key_left_comm<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_min</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">then</span> empty <span class="keyword1">else</span> Abs_pq <span class="main">(</span>tl <span class="main">(</span>alist_of <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alift_of_remove_min_if <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"alist_of <span class="main">(</span>remove_min <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free">q</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> tl <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_min_def map_tl sorted_tl distinct_tl alist_of_Abs_pq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_min_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_empty <span class="free">q</span> <span class="main">⟹</span> remove_min <span class="free">q</span> <span class="main">=</span> empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_of_remove_min <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span> <span class="main">⟹</span> alist_of <span class="main">(</span>remove_min <span class="free">q</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alift_of_remove_min_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> values_remove_min <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span> <span class="main">⟹</span> values <span class="main">(</span>remove_min <span class="free">q</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>values <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> values_def map_tl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_alist_of_remove_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span> <span class="main">⟹</span> set <span class="main">(</span>alist_of <span class="main">(</span>remove_min <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>alist_of <span class="free">q</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span>min <span class="free">q</span><span class="main">,</span> the <span class="main">(</span>priority <span class="free">q</span> <span class="main">(</span>min <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_set hd_construct<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> pq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> pq<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pop</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> remove_min <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pop_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_empty <span class="free">q</span> <span class="main">⟹</span> pop <span class="free">q</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">q</span> <span class="main">⟹</span> pop <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span>min <span class="free">q</span><span class="main">,</span> remove_min <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pop_def<span class="main">)</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Abs_pq alist_of <span class="quoted">"values"</span> priority empty is_empty push min pop

<span class="keyword1"><span class="command">no_notation</span></span>
  <span class="quoted">"PQ.values"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">|</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"PQ.priorities"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">∥</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Binomial_Queue">
<div class="head">
<h1>Theory Binomial_Queue</h1>
</div>
<pre class="source"><span class="comment1">(* Authors:  René Neumann and Florian Haftmann, TU Muenchen *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Functional Binomial Queues›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Binomial_Queue
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PQ.html">PQ</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type definition and projections›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">=</span> Node <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">priority</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">priority</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">children</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">children</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option list"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> binqueue_induct <span class="main">[</span><span class="operator">case_names</span> Empty None Some<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">type</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> binqueue<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>None <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Some <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  \noindent Terminology:

  \begin{itemize}

    \item values <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v, w›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>v1, v2›</span></span></span></span>

    \item priorities <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a, b›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a1, a2›</span></span></span></span>

    \item bintrees <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t, r›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t1, t2›</span></span></span></span>

    \item bintree lists <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ts, rs›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ts1, ts2›</span></span></span></span>

    \item binqueue element <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x, y›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x1, x2›</span></span></span></span>

    \item binqueues = binqueue element lists <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs, ys›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>xs1, xs2›</span></span></span></span>

    \item abstract priority queues <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q, p›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q1, q2›</span></span></span></span>

  \end{itemize}
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binomial queue properties›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Binomial tree property›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">is_bintree_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  is_bintree_list_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_bintree_list</span> <span class="main">0</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> is_bintree_list_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_bintree_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span> <span class="free">is_bintree_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>children <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="main">⟹</span> <span class="free">is_bintree_list</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">is_bintree</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> is_bintree_list <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>children <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_bintree_list_triv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_bintree_list <span class="main">0</span> <span class="free">ts</span> <span class="main">⟷</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_bintree_list <span class="free">l</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_bintree_list.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_bintree_list.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_bintree_list_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_bintree_list <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟷</span>
    is_bintree_list <span class="free">l</span> <span class="main">(</span>children <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> is_bintree_list <span class="free">l</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_bintree_list.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_bintree_list.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_bintree_list_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_bintree_list <span class="free">l</span> <span class="free">ts</span> <span class="main">⟹</span> length <span class="free">ts</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> is_bintree_list.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> is_bintree_list_children_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_bintree_list <span class="free">l</span> <span class="free">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"children <span class="main">(</span>last <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_bintree_children_length_desc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_bintree_list <span class="free">l</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>length <span class="main">∘</span> children<span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Heap property›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">is_heap_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  is_heap_list_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap_list</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> is_heap_list_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap_list</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟹</span> <span class="free">is_heap_list</span> <span class="main">(</span>priority <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>children <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="main">⟹</span> <span class="main">(</span>priority <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⟹</span> <span class="free">is_heap_list</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">is_heap</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> is_heap_list <span class="main">(</span>priority <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>children <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_heap_list_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap_list <span class="free">h</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"is_heap_list <span class="free">h</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟷</span>
    is_heap_list <span class="free">h</span> <span class="free">ts</span> <span class="main">∧</span> is_heap_list <span class="main">(</span>priority <span class="free">t</span><span class="main">)</span> <span class="main">(</span>children <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> priority <span class="free">t</span> <span class="main">≥</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_heap_list.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_heap_list.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_heap_list_append_dest <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap_list <span class="free">l</span> <span class="main">(</span><span class="free">ts</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> is_heap_list <span class="free">l</span> <span class="free">ts</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_heap_list <span class="free">l</span> <span class="main">(</span><span class="free">ts</span><span class="main">@</span><span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span> is_heap_list <span class="free">l</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_heap_list.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_heap_list.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_heap_list_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap_list <span class="free">l</span> <span class="free">ts</span> <span class="main">⟹</span> is_heap_list <span class="free">l</span> <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_heap_children_larger<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span> <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>children <span class="free">t</span><span class="main">)</span><span class="main">.</span> priority <span class="bound">x</span> <span class="main">≥</span> priority <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> is_heap_list.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> is_heap_Min_children_larger<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span> <span class="main">⟹</span> children <span class="free">t</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> 
   priority <span class="free">t</span> <span class="main">≤</span> Min <span class="main">(</span>priority <span class="main">`</span> set <span class="main">(</span>children <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_heap_children_larger<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Combination of both: binqueue property›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">is_binqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_binqueue</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_binqueue</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">is_binqueue</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is_binqueue</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> is_bintree <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
    <span class="main">⟹</span> is_heap <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">is_binqueue</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_simp <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span>
    is_bintree <span class="free">l</span> <span class="free">t</span> <span class="main">∧</span> is_heap <span class="free">t</span> <span class="main">∧</span> is_binqueue <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> is_binqueue <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_binqueue.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_binqueue.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> is_binqueue <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_head<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> is_binqueue <span class="free">l</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span> <span class="main">⟹</span> is_binqueue <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="free">ys</span> <span class="main">⟹</span> is_binqueue <span class="free">l</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_binqueue.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_binqueue.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_append_dest <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_binqueue.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_binqueue.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_children<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_bintree_list <span class="free">l</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_heap_list <span class="free">t</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="main">0</span> <span class="main">(</span>map Some <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_binqueue_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_select<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span> <span class="main">⟹</span> Some <span class="free">t</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> is_bintree <span class="bound">k</span> <span class="free">t</span> <span class="main">∧</span> is_heap <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_binqueue.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_binqueue.cases<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Normalized representation›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">normalized</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  normalized_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">normalized</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> normalized_single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">normalized</span> <span class="main">[</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> normalized_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">normalized</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">normalized</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_last_not_None<span class="main">:</span>
  <span class="comment1">― ‹\ sometimes the inductive definition might work better›</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> last <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> last <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> normalized.induct<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> last <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ys</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"last <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span>Some <span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">[]</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> normalized <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> normalized <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_last_not_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_map_Some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>map Some <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> normalized <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_last_not_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> normalized <span class="free">ys</span> <span class="main">⟹</span> normalized <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_last_not_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">≠</span> <span class="main">{</span>None<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_Cons <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset_singletonD<span class="main">)</span> 

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">normalize'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normalize'</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">normalize'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">normalize'</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normalize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normalize</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> rev <span class="main">(</span>normalize' <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_normalize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>normalize <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_last_not_None normalize_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_normalize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span> <span class="main">⟹</span> is_binqueue <span class="free">l</span> <span class="main">(</span>normalize <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normalize_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Adding data›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> priority <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">&lt;</span> priority <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
    <span class="keyword1">then</span> Node <span class="main">(</span>priority <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">#</span> children <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> 
    <span class="keyword1">else</span> Node <span class="main">(</span>priority <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span>val <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">#</span> children <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_bintree_list_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_bintree <span class="free">l</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"is_bintree <span class="free">l</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_bintree <span class="main">(</span>Suc <span class="free">l</span><span class="main">)</span> <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_heap_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> merge_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add</span> None <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> None <span class="main">#</span> <span class="free">add</span> <span class="main">(</span>Some <span class="main">(</span>merge <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_Some_not_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"add <span class="main">(</span>Some <span class="free">t</span><span class="main">)</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Some <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>add <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_add_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span>add None <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_add_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"is_bintree <span class="free">l</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span>add <span class="main">(</span>Some <span class="free">t</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bintree_list_merge is_heap_merge<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span>
  <span class="entity">meld</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meld</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meld</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meld</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">meld</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meld</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">meld</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meld</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
    None <span class="main">#</span> add <span class="main">(</span>Some <span class="main">(</span>merge <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">meld</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> meld_singleton_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"meld <span class="main">[</span>Some <span class="free">t</span><span class="main">]</span> <span class="free">xs</span> <span class="main">=</span> add <span class="main">(</span>Some <span class="free">t</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Some <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_meld <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> meld <span class="free">xs</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> meld <span class="free">xs</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_meld_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"meld <span class="free">xs</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> meld <span class="free">xs</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_meld<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="main">(</span>meld <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> is_binqueue <span class="bound">l</span> <span class="skolem">xs</span> <span class="main">⟹</span> is_binqueue <span class="bound">l</span> <span class="skolem">ys</span>
      <span class="main">⟹</span> is_binqueue <span class="bound">l</span> <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="skolem">l</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="skolem">l</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="skolem">l</span> <span class="main">(</span>meld <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> is_binqueue <span class="bound">l</span> <span class="skolem">xs</span> <span class="main">⟹</span> is_binqueue <span class="bound">l</span> <span class="skolem">ys</span>
      <span class="main">⟹</span> is_binqueue <span class="bound">l</span> <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="skolem">l</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="skolem">l</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="skolem">l</span> <span class="main">(</span>meld <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_bintree_list_merge is_heap_merge is_binqueue_add_Some<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_meld<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"normalized <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>meld <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"normalized <span class="skolem">xs</span> <span class="main">⟹</span> normalized <span class="skolem">ys</span> <span class="main">⟹</span> normalized <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>meld <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"normalized <span class="skolem">xs</span> <span class="main">⟹</span> normalized <span class="skolem">ys</span> <span class="main">⟹</span> normalized <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>None <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>meld <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_meld_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>meld <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"normalized <span class="skolem">xs</span> <span class="main">⟹</span> length <span class="skolem">ys</span> <span class="main">≤</span> length <span class="skolem">xs</span> <span class="main">⟹</span> normalized <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>meld <span class="main">(</span>None <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"normalized <span class="skolem">xs</span> <span class="main">⟹</span> length <span class="skolem">ys</span> <span class="main">≤</span> length <span class="skolem">xs</span> <span class="main">⟹</span> normalized <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span>None <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>meld <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_add<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">least</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">least</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
    <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
           None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>
         <span class="main">|</span> Some <span class="bound">y'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="bound">y'</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> least_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"least None <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"least <span class="free">x</span> None <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"least <span class="main">(</span>Some <span class="free">x'</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x'</span> <span class="main">≤</span> <span class="free">y'</span> <span class="keyword1">then</span> Some <span class="free">x'</span> <span class="keyword1">else</span> Some <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> least_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> least_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"least <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x'</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> least<span class="main">:</span> semilattice <span class="quoted">least</span> <span class="keyword1"><span class="command">proof</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> least_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> fold least <span class="main">(</span>map <span class="main">(</span>map_option priority<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="main">[]</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"min <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> min <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"min <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> least <span class="main">(</span>Some <span class="main">(</span>priority <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>min <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def fold_commute_apply <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    fun_eq_iff least.left_commute <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> least_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> least <span class="main">(</span>map_option priority <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def fold_map o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_single<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> priority <span class="main">(</span>the <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="quoted"><span class="quoted">"min <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_Some_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> min_None_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> min_Some_not_None<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_None_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> set <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span>None<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> splitQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">{</span>None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>None <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> min_None_trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> min_Some_not_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
 
  <span class="keyword1"><span class="command">with</span></span> splitQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> set <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span>None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> set <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">⟹</span> min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset_singletonD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_min_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> min <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_None_None normalized_not_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_is_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="free">a</span> <span class="main">≤</span> priority <span class="main">(</span>the <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> binqueue_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"normalized <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> normalized_Cons<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">ys</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_min_not_None<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> oa'<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="skolem">ys</span> <span class="main">=</span> Some <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Some N False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> None <span class="main">∨</span> <span class="skolem">a'</span> <span class="main">≤</span> priority <span class="main">(</span>the <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">with</span></span> Some oa' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">≤</span> priority <span class="skolem">t</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> least.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> min_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">∈</span> map_option priority <span class="main">`</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">∉</span> map_option priority <span class="main">`</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None <span class="main">∨</span> priority <span class="main">(</span>the <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">≠</span> Some <span class="free">a</span>"</span></span>  
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span> <span class="skolem">ys</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">t</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">ys</span> <span class="main">≠</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"least <span class="main">(</span>Some <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>min <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">a</span> <span class="main">∨</span> min <span class="skolem">ys</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> least_split<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹min <span class="skolem">ys</span> <span class="main">≠</span> Some <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹priority <span class="skolem">t</span> <span class="main">≠</span> <span class="skolem">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">find</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="keyword1">if</span> priority <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> Some <span class="bound">t</span> <span class="keyword1">else</span> <span class="free">find</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> find.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> find_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"find <span class="free">a</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"find <span class="free">a</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> find <span class="free">a</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"find <span class="free">a</span> <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> priority <span class="free">t</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">then</span> Some <span class="free">t</span> <span class="keyword1">else</span> find <span class="free">a</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_works<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>map_option priority<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> find <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> priority <span class="bound">t</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_works_not_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>map_option priority<span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> find <span class="free">a</span> <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> find_works<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟹</span> Some <span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>map <span class="main">(</span>map_option priority<span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_works_not_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_exist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟹</span> Some <span class="free">t</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_min</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> min <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> find <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_min_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"find_min <span class="main">[]</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"find_min <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> find_min <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_min_single<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find_min <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_eq_find_min_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟷</span> find_min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟹</span> find_min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_def min_exists find_works_not_None<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_eq_find_min_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> priority <span class="bound">t</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> min <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">a</span>
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> priority <span class="bound">t</span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_def find_works min_exists<span class="main">)</span>
  <span class="comment1">(* no 'next' here to keep D1 in scope as it is needed in the other part *)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">t</span><span class="main">.</span> find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> priority <span class="bound">t</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">≠</span> Some <span class="free">a</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> min_eq_find_min_None<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">b</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹min <span class="free">xs</span> <span class="main">≠</span> Some <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> * Some <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> D1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_min_exist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">t</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_eq_find_min_None<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_def find_exist<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_min_is_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span>priority <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> priority <span class="main">(</span>the <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_eq_find_min_Some min_is_min<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_find_min_exists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> normalized_min_not_None<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_eq_find_min_None<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> priority <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delete_min</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_min <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="keyword1">of</span> Some <span class="main">(</span>Node <span class="bound">a</span> <span class="bound">v</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span>
         normalize <span class="main">(</span>meld <span class="main">(</span>map Some <span class="main">(</span>rev <span class="bound">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>match <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> 
     <span class="main">|</span> None <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete_min_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"delete_min <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delete_min_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">t</span>
    <span class="main">⟹</span> delete_min <span class="free">xs</span> <span class="main">=</span> normalize
      <span class="main">(</span>meld <span class="main">(</span>map Some <span class="main">(</span>rev <span class="main">(</span>children <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>match <span class="main">(</span>priority <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> delete_min_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_delete_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="main">0</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="main">0</span> <span class="main">(</span>delete_min <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="main">0</span> <span class="main">(</span>map <span class="main">(</span>match <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">t</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_min_exist<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> is_bintree <span class="bound">l</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_binqueue_select<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="main">0</span> <span class="main">(</span>map Some <span class="main">(</span>rev <span class="main">(</span>children <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_binqueue_children<span class="main">)</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_binqueue_meld delete_min_def is_binqueue_normalize
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bintree.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_delete_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="main">(</span>delete_min <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_min_def normalized_normalize <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bintree.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Dedicated grand unified operation for generated program›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">meld'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree option <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meld'</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> add <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span>meld <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"add <span class="free">z</span> <span class="free">xs</span> <span class="main">=</span> meld' <span class="free">z</span> <span class="main">[]</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> meld' None <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meld'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"meld' <span class="free">z</span> <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">r</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">z</span> <span class="main">#</span> <span class="main">(</span>meld' <span class="main">(</span>Some <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' <span class="main">(</span>Some <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">r</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    None <span class="main">#</span> <span class="main">(</span>meld' <span class="main">(</span>Some <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' <span class="main">(</span>Some <span class="free">t</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">r</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    None <span class="main">#</span> <span class="main">(</span>meld' <span class="main">(</span>Some <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' None <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="main">(</span>meld' None <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' None <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="main">(</span>meld' None <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' <span class="free">z</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="main">#</span> <span class="main">(</span>meld' None <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' <span class="free">z</span> <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> meld' <span class="free">z</span> <span class="main">[]</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' <span class="free">z</span> <span class="main">[]</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> meld' None <span class="main">[</span><span class="free">z</span><span class="main">]</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' <span class="main">(</span>Some <span class="free">t</span><span class="main">)</span> <span class="main">[]</span> <span class="free">ys</span> <span class="main">=</span> meld' None <span class="main">[</span>Some <span class="free">t</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
  <span class="quoted"><span class="quoted">"meld' None <span class="main">[]</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meld'_def <span class="main"><span class="keyword3">|</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Interface operations›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">≡</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> add <span class="main">(</span>Some <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">v</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>Some <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">v</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"insert <span class="free">a</span> <span class="free">v</span> <span class="main">(</span>Some <span class="free">t</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> None <span class="main">#</span> add <span class="main">(</span>Some <span class="main">(</span>merge <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="main">[]</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_binqueue <span class="main">0</span> <span class="free">xs</span> <span class="main">⟹</span> is_binqueue <span class="main">0</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_binqueue_add_Some insert_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> normalized_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> normalized <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_add insert_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pop</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_min <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> 
    <span class="main">|</span> Some <span class="bound">t</span>  <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span>val <span class="bound">t</span><span class="main">,</span> priority <span class="bound">t</span><span class="main">)</span><span class="main">,</span> delete_min <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pop_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pop empty <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pop_def empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pop_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="free">t</span>
    <span class="main">⟹</span> pop <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">(</span>val <span class="free">t</span><span class="main">,</span> priority <span class="free">t</span><span class="main">)</span><span class="main">,</span> normalize
      <span class="main">(</span>meld <span class="main">(</span>map Some <span class="main">(</span>rev <span class="main">(</span>children <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>match <span class="main">(</span>priority <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pop_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pop_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pop <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_min <span class="free">xs</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> <span class="main">(</span>None<span class="main">,</span> <span class="free">xs</span><span class="main">)</span> 
    <span class="main">|</span> Some <span class="bound">t</span>  <span class="main">⇒</span> <span class="main">(</span>Some <span class="main">(</span>val <span class="bound">t</span><span class="main">,</span> priority <span class="bound">t</span><span class="main">)</span><span class="main">,</span> normalize
       <span class="main">(</span>meld <span class="main">(</span>map Some <span class="main">(</span>rev <span class="main">(</span>children <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>match <span class="main">(</span>priority <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pop_def delete_min_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> bintree.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PQ_Implementation">
<div class="head">
<h1>Theory PQ_Implementation</h1>
</div>
<pre class="source"><span class="comment1">(* Authors:  René Neumann and Florian Haftmann, TU Muenchen *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relating Functional Binomial Queues To The Abstract Priority Queues›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PQ_Implementation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PQ.html">PQ</a> <a href="Binomial_Queue.html">Binomial_Queue</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  <span class="quoted">"PQ.values"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">|</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"PQ.priorities"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">∥</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  \noindent Naming convention: prefix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bt_›</span></span></span></span> for bintrees, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bts_›</span></span></span></span> for bintree lists,
  no prefix for binqueues.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">bt_dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">bts_dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list  <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bt_dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free">bts_dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bts_dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bts_dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bt_dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="free">bts_dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bt_dfs_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bt_dfs <span class="free">f</span> <span class="free">t</span> <span class="main">=</span> <span class="free">f</span> <span class="free">t</span> <span class="main">#</span> bts_dfs <span class="free">f</span> <span class="main">(</span>children <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bts_dfs_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bts_dfs <span class="free">f</span> <span class="main">(</span><span class="free">ts</span> <span class="main">@</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> bts_dfs <span class="free">f</span> <span class="free">ts</span> <span class="main">@</span> bts_dfs <span class="free">f</span> <span class="free">rs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> set_bts_dfs_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs <span class="free">f</span> <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>bts_dfs <span class="free">f</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bts_dfs_rev_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>bts_dfs <span class="free">f</span> <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_bts_dfs_rev<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_dfs_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bt_dfs <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>bt_dfs <span class="free">g</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"bts_dfs <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>bts_dfs <span class="free">g</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_dfs.induct bts_dfs.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_dfs_comp_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>bt_dfs <span class="free">g</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>bts_dfs <span class="free">g</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_comp distinct_map <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_dfs_distinct_children<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>bts_dfs <span class="free">f</span> <span class="main">(</span>children <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="tfree">'c</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> bt_dfs <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="free">dfs</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfs <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>dfs <span class="free">f</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> set_dfs_rev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_dfs_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>rev <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_dfs_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_append set_dfs_rev<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfs <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>dfs <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_comp <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> o_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_comp_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>dfs <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_comp distinct_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_distinct_member<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> 
   Some <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> 
   distinct <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span> <span class="skolem">xs</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_map_Some_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfs <span class="free">f</span> <span class="main">(</span>map Some <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> bts_dfs <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">alist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">alist</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_split_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> alist<span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"priority <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">∘</span> alist<span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">=</span> fst <span class="main">∘</span> alist"</span></span>
  <span class="quoted"><span class="quoted">"priority <span class="main">=</span> snd <span class="main">∘</span> alist"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_split_pre<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_split_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs priority <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">`</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_comp alist_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_set_in_alist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">t</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="free">t</span><span class="main">,</span> priority <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Some <span class="free">t</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vals</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vals</span> <span class="main">≡</span> dfs val"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prios</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prios</span> <span class="main">≡</span> dfs priority"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">elements</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">elements</span> <span class="main">≡</span> dfs alist"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">bt_augment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> PQ.pq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> PQ.pq"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">bts_augment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> PQ.pq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> PQ.pq"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bt_augment</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> PQ.push <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">bts_augment</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bts_augment</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">bts_augment</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free">bts_augment</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span><span class="free">bt_augment</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bts_augment <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bts_augment <span class="main">=</span> fold bt_augment"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> bintree list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bts_augment <span class="skolem">ts</span> <span class="main">=</span> fold bt_augment <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_Node <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bt_augment <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="free">ts</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>fold bt_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bts_augment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bt_augment <span class="free">t</span> <span class="free">q</span> <span class="main">=</span> PQ.push <span class="main">(</span>val <span class="free">t</span><span class="main">)</span> <span class="main">(</span>priority <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fold bt_augment <span class="main">(</span>children <span class="free">t</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bts_augment<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> bt_augment.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> bts_augment.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pqueue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> binqueue <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> PQ.pq"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pqueue</span> <span class="main">[]</span> <span class="main">=</span> PQ.empty"</span></span>
<span class="main">|</span> None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pqueue</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pqueue</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pqueue</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> bt_augment <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="free">pqueue</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">⊆</span> set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">⊆</span> set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bt_augment_v_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
    set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
    set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">|</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil_bintree
    <span class="keyword1"><span class="command">from</span></span> bt_augment_v_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_val_augment<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs val <span class="free">ts</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">|</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_bintree <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="main">(</span>bt_augment <span class="skolem">r</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
    set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="skolem">r</span> <span class="free">q</span><span class="main">|</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bt_augment_v_union<span class="main">)</span>
  
  <span class="keyword1"><span class="command">with</span></span> bt_augment_v_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="main">(</span>bt_augment <span class="skolem">r</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
      set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="skolem">r</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons_bintree <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_pqueue<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">|</span>pqueue <span class="free">xs</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_val_augment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_push<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="main">(</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bt_val_augment<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"PQ.push <span class="free"><span class="free">v</span></span> <span class="free"><span class="free">a</span></span> <span class="free"><span class="free">q</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_val_augment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_push_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="main">(</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_augment_v_push <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bts_augment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bts_augment_v_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>bts_augment <span class="free">rs</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
    set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bts_augment <span class="free">rs</span> <span class="free">q</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="main">(</span>bts_augment <span class="free">rs</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
    set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bts_augment <span class="free">rs</span> <span class="free">q</span><span class="main">|</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil_bintree
  <span class="keyword1"><span class="command">from</span></span> bt_augment_v_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_bintree <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="skolem">xs</span> <span class="main">(</span>bt_augment <span class="skolem">x</span> <span class="main">(</span>bts_augment <span class="skolem">rs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">|</span>"</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> bt_augment_v_union
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> set <span class="main">|</span>bts_augment <span class="skolem">xs</span> <span class="main">(</span>bt_augment <span class="skolem">x</span> <span class="bound">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
      set <span class="main">|</span>bts_augment <span class="skolem">xs</span> <span class="bound">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="skolem">x</span> <span class="bound">q</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">with</span></span> Cons_bintree
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span>
      set <span class="main">|</span>bts_augment <span class="skolem">xs</span> <span class="skolem">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="skolem">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="skolem">x</span> <span class="skolem">q</span><span class="main">|</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bt_augment <span class="free">r</span> <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>bts_augment <span class="free">rs</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bts_augment <span class="free">rs</span> <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bts_augment <span class="free">ts</span> <span class="main">(</span>bts_augment <span class="free">rs</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span> <span class="main">=</span>
    set <span class="main">|</span>bts_augment <span class="free">rs</span> <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bts_augment_v_union bt_augment_v_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> bt_augment_v_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">|</span>bt_augment <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span> <span class="free">q</span><span class="main">|</span> <span class="main">=</span> set <span class="main">|</span>bt_augment <span class="free">t</span> <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_augment_simp <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bt_augment_v_push
    bt_augment_v_commute merge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bt_dfs val <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp merge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_merge_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>bt_dfs val <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   set <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
   distinct <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp merge_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_add_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="main">(</span>add <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>vals <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_add_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs val <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>dfs val <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>add <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_merge_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> Some
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    
<span class="keyword1"><span class="command">lemma</span></span> vals_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_def vals_add_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_v_push<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">|</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">|</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_pqueue<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_meld<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs val <span class="main">(</span>meld <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs val <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"meld <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"meld <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_add_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> vals_meld_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>dfs val <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span>
   set <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>dfs val <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   distinct <span class="main">(</span>dfs val <span class="main">(</span>meld <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"3"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"3"</span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Some <span class="quoted">"3"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Some <span class="quoted">"3"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_meld<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"3"</span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"4"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"4"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Some <span class="quoted">"4"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Some <span class="quoted">"4"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_meld<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"4"</span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_dfs_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"5"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"5"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">x</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"5"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_merge_distinct<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"5"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_meld<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_add_distinct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_alist_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>PQ.alist_of <span class="free">q</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>PQ.alist_of <span class="free">q</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_augment_simp set_insort_key<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_alist_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>PQ.alist_of <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>PQ.alist_of <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bt_augment_alist_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bt_augment_alist_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
   set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">t</span> <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="free">r</span> <span class="main">#</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
   set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil_bintree 
  <span class="keyword1"><span class="command">from</span></span> bt_augment_alist_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">rs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="skolem">rs</span> <span class="main">(</span>bt_augment <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="skolem">rs</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Node.prems <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="skolem">q</span><span class="main">|</span> <span class="main">∪</span> set <span class="main">|</span>bt_augment <span class="skolem">r</span> <span class="skolem">q</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bt_val_augment<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="main">(</span>bt_augment <span class="skolem">r</span> <span class="skolem">q</span><span class="main">)</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> bt_augment_v_union<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="skolem">q</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_insort_key<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_bintree <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="comment1">― ‹FIXME: ugly... and slow›</span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="skolem">r</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="main">[</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span>bt_augment <span class="skolem">r</span> <span class="skolem">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="skolem">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs val <span class="main">[</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="skolem">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs val <span class="main">(</span><span class="skolem">r</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="skolem">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bt_val_augment<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons_bintree.hyps <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bt_alist_augment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bt_dfs alist <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>PQ.alist_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="free">t</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="free">ts</span><span class="main">)</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bts_dfs val <span class="free">ts</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">|</span><span class="free">q</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bts_dfs alist <span class="free">ts</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>PQ.alist_of <span class="free">q</span><span class="main">)</span> <span class="main">=</span>
     set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="free">ts</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bt_augment.induct bts_augment.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil_bintree <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> set <span class="main">|</span>bts_augment <span class="skolem">rs</span> <span class="free">q</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bt_val_augment<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Node <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_insort_key<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_bintree <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="main">(</span><span class="skolem">r</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bts_augment <span class="skolem">rs</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>bt_augment <span class="skolem">r</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bt_augment_alist_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Cons_bintree bt_augment_alist_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_pqueue<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_pqueue bt_alist_augment<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_pqueue_priority<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>
    <span class="main">⟹</span> PQ.priority <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_pqueue PQ.priority_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prios_pqueue<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> set <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">∥</span>pqueue <span class="free">xs</span><span class="main">∥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_pqueue priorities_set alist_split_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_merge <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>bt_dfs val <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
   set <span class="main">(</span>bt_dfs val <span class="free">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> 
   set <span class="main">(</span>bt_dfs alist <span class="main">(</span>merge <span class="free">t</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>bt_dfs alist <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bt_dfs alist <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp merge_def alist_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_add_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>add <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs alist <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Empty <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> prem <span class="main">=</span> Some.prems Some
    
    <span class="keyword1"><span class="command">from</span></span> prem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp merge_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>Some <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prem Some.hyps
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>add <span class="main">(</span>Some <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>dfs alist <span class="main">(</span>Some <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> prem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prem
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs alist <span class="main">(</span>merge <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        set <span class="main">(</span>bt_dfs alist <span class="skolem">t</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bt_dfs alist <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> prem <span class="keyword2"><span class="keyword">and</span></span> Un_assoc
      
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> 
   <span class="free">v</span> <span class="main">∉</span> set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
   set <span class="main">(</span>dfs alist <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_def alist_add_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_push<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="free">v</span> <span class="main">∉</span> set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
   set <span class="main">(</span>dfs alist <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>PQ.alist_of <span class="main">(</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_pqueue vals_pqueue set_insort_key<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert_p_push<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>prios <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">∥</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">∥</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>insert <span class="free">a</span> <span class="free">v</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>PQ.alist_of <span class="main">(</span>PQ.push <span class="free">v</span> <span class="free">a</span> <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> insert_push<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_split_set priorities_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> empty <span class="main">⟷</span> PQ.is_empty <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"PQ.is_empty <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"PQ.is_empty <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp dfs_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span>pqueue <span class="free">xs</span><span class="main">|</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_pqueue<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">|</span>pqueue <span class="free">xs</span><span class="main">|</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_empty_empty<span class="main">)</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> bt_dfs_Min_priority<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_heap <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"priority <span class="free">t</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"priority <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"children <span class="free">t</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> is_heap_list_Nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>is_heap_list_Cons <span class="skolem">rs</span> <span class="skolem">r</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> cons <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Node <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>val <span class="skolem">t</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> children <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">t'</span> <span class="main">=</span> priority <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> is_heap_list_Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">t</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="skolem">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ot
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">t</span> <span class="main">=</span> Min <span class="main">(</span>Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">r</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"children <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bts_dfs priority <span class="main">(</span>children <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bt_dfs priority <span class="skolem">t</span> <span class="main">=</span>
    priority <span class="skolem">t</span> <span class="main">#</span> <span class="main">(</span>bt_dfs priority <span class="skolem">r</span> <span class="main">@</span> bts_dfs priority <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> Min
    <span class="main">(</span>Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span>
    <span class="main">∪</span> set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> Min
    <span class="main">(</span>Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">with</span></span> Min_Un
    <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span>
    ord_class.min <span class="main">(</span>Min <span class="main">(</span>Set.insert <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>bts_dfs priority <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Min <span class="main">(</span>set <span class="main">(</span>bt_dfs priority <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> ord_class.min <span class="main">(</span>priority <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>priority <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹priority <span class="skolem">t</span> <span class="main">≤</span> priority <span class="skolem">r</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ord_class.min_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_binqueue_min_Min_prios<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>Min <span class="main">(</span>set <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">l</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> bt_dfs_Min_priority<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_single<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> T <span class="main">=</span> this Some
    
    <span class="keyword1"><span class="command">from</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalized <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prios <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Min_Un<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs priority <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>prios <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> bt_dfs_Min_priority<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp ord_class.min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  
<span class="keyword1"><span class="command">lemma</span></span> min_p_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> PQ.priority <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹normalized <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PQ.is_empty <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_empty<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>Min <span class="main">(</span>set <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_binqueue_min_Min_prios<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>Min <span class="main">(</span>set <span class="main">∥</span>pqueue <span class="free">xs</span><span class="main">∥</span> <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prios_pqueue<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> priority_Min_priorities <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> q <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"pqueue <span class="free">xs</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_min_p_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"priority <span class="main">(</span>the <span class="main">(</span>find_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    the <span class="main">(</span>PQ.priority <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_min_not_None<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">=</span> PQ.priority <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_p_min<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹min <span class="free">xs</span> <span class="main">≠</span> None›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_eq_find_min_Some<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_min_v_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>the <span class="main">(</span>find_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">xs</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalized_min_not_None<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> oa<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="skolem">a</span> <span class="main">=</span> min <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> ot<span class="main">:</span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_eq_find_min_Some <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="skolem">t</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_exist in_set_in_alist<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> val <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>    
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> val <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ot'<span class="main">:</span><span class="quoted"><span class="quoted">"PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> NE<span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="skolem">t</span> <span class="main">≠</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">from</span></span> ot' oa assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_pqueue PQ.priority_def min_p_min<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> * NE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> alist_split<span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> dfs_comp 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="main"><span class="main">(</span></span><span class="quoted"><span class="quoted">"dfs alist <span class="free">xs</span>"</span></span><span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> ot <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_normalize_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dfs alist <span class="main">(</span>normalize <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> dfs alist <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> normalize_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_match_not_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">t</span><span class="main">.</span> Some <span class="bound">t</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟶</span> priority <span class="bound">t</span> <span class="main">≠</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span>
    set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_match_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_match_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dfs_match_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> dfs_match<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> 
   distinct <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
   Some <span class="free">t</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> 
   priority <span class="free">t</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> 
   set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">r</span> <span class="skolem">xs</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword1"><span class="command">from</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">r</span> <span class="main">∉</span> set <span class="main">(</span>prios <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Some True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> set <span class="main">(</span>prios <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> Some <span class="bound">s</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟶</span> priority <span class="bound">s</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_match_not_in<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Some.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹priority <span class="skolem">t</span> <span class="main">=</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>prios <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> False Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="skolem">r</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">from</span></span> Some False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Some.prems False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>bt_dfs <span class="free">f</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_meld<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>dfs val <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span>
   set <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>dfs val <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
   set <span class="main">(</span>dfs alist <span class="main">(</span>meld <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> meld.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> <span class="quoted">"3"</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>dfs alist <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">alist</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"meld <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">alist</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>dfs alist <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> <span class="comment1">(* this is the same as for 3 minus some renaming *)</span>
    <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> <span class="quoted">"4"</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>dfs alist <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">alist</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"meld <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> set_dfs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted">alist</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>add <span class="main">(</span>Some <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>bt_dfs alist <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span>
    <span class="main">∪</span> set <span class="main">(</span>bt_dfs alist <span class="skolem">y</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> <span class="quoted">"5"</span>
    
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> xyint<span class="main">:</span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="skolem">x</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>bt_dfs val <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_dfs_Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">[</span>Some <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>bt_dfs alist <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>bt_dfs alist <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs alist <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_dfs_Cons<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>Some <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms xyint <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_merge_distinct<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="skolem">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_dfs_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> vals_meld_distinct<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> assms
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bt_dfs val <span class="main">(</span>merge <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="main">(</span>meld <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vals_meld<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
   
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_add_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> alist_delete_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>delete_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dfs_comp_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="quoted">alist</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> alist_split<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> IN<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_exist<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs alist <span class="free">ts</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> d IN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>bts_dfs alist <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dfs_distinct_member<span class="main">[</span><span class="operator">of</span> <span class="quoted">alist</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"Node <span class="free">a</span> <span class="free">v</span> <span class="free">ts</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> sub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs alist <span class="free">ts</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> nu<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs alist <span class="free">ts</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_match_distinct<span class="main">)</span>
 
  <span class="keyword1"><span class="command">moreover</span></span>  
  <span class="keyword1"><span class="command">from</span></span> IN assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>bts_dfs val <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dfs_distinct_member<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"Node <span class="free">a</span> <span class="free">v</span> <span class="free">ts</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bt_dfs_distinct_children<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="main">(</span>map Some <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bts_dfs_rev_distinct dfs_map_Some_idem<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms IN <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs val <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>dfs val <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>bt_dfs val <span class="main">(</span>Node <span class="free">a</span> <span class="free">v</span> <span class="free">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_match<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vals <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>vals <span class="main">(</span>map Some <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dfs_map_Some_idem set_bts_dfs_rev<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>meld <span class="main">(</span>map Some <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>dfs alist <span class="main">(</span>map Some <span class="main">(</span>rev <span class="free">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>dfs alist <span class="main">(</span>map <span class="main">(</span>match <span class="free">a</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alist_meld <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">with</span></span> assms d IN nu <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_min_def alist_normalize_idem set_bts_dfs_rev dfs_map_Some_idem
     dfs_match Diff_insert2 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>bts_dfs alist <span class="free">ts</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> alist_remove_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_binqueue <span class="free">l</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>prios <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"normalized <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>delete_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  set <span class="main">(</span>PQ.alist_of <span class="main">(</span>PQ.remove_min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> ot<span class="main">:</span> <span class="quoted"><span class="quoted">"find_min <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normalized_find_min_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PQ.is_empty <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>PQ.alist_of <span class="main">(</span>PQ.remove_min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>PQ.alist_of <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span>PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">,</span>
        the <span class="main">(</span>PQ.priority <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_alist_of_remove_min<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pqueue <span class="free">xs</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alist_of_remove_min<span class="main">)</span>
    
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms ot Node
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dfs alist <span class="main">(</span>delete_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>dfs alist <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> alist_delete_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Node ot <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"priority <span class="main">(</span>the <span class="main">(</span>find_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> the <span class="main">(</span>PQ.priority <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_p_min<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Node ot <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>the <span class="main">(</span>find_min <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> PQ.min <span class="main">(</span>pqueue <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_min_v_min<span class="main">)</span>
    
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span>vals <span class="free">xs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alist_pqueue<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span>
  <span class="quoted">"PQ.values"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">|</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"PQ.priorities"</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">∥</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">∥</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>