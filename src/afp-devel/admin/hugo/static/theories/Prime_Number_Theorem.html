<div id="Prime_Number_Theorem_Library">
<div class="head">
<h1>Theory Prime_Number_Theorem_Library</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Prime_Number_Theorem_Library
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Zeta_Function/Zeta_Function.html">Zeta_Function.Zeta_Function</a>
  <span class="quoted">"<a href="../../HOL/HOL-Real_Asymp/Real_Asymp.html">HOL-Real_Asymp.Real_Asymp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> asymp_equivD_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∼[</span><span class="free">F</span><span class="main">]</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equivD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> frontier_real_Ici <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frontier <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frontier_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> interior_real_atLeast<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_upto_ln_conv_sum_upto_mangoldt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> mangoldt <span class="bound">n</span> <span class="main">*</span> nat <span class="main">⌊</span><span class="free">x</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">⌋</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
          sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">d</span></span> <span class="main">|</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">n</span><span class="main">.</span> mangoldt <span class="bound">d</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_upto_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mangoldt_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">/</span> real <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_upto_sum_divisors<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> mangoldt <span class="bound">n</span> <span class="main">*</span> nat <span class="main">⌊</span><span class="free">x</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">⌋</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ln_fact_conv_sum_upto_mangoldt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> mangoldt <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_upto_altdef nat_add_distrib ln_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> mangoldt <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_ln_conv_sum_upto_mangoldt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_upto_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> floor_divide_of_nat_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> powr_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">powr</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_def exp_sum sum_distrib_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_abs_converges_comparison_test<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> dirichlet_series"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> fds_nth <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">g</span> <span class="main">(</span><span class="free">s</span> <span class="main">∙</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fds_abs_converges_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> summable_comparison_test_ev<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">g</span> <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">s</span> <span class="main">∙</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                            fds_nth <span class="free">g</span> <span class="bound">n</span> <span class="main">/</span> real <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">s</span> <span class="main">∙</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_nat_power <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_converges_scaleR <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_converges <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_scaleR_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleR_conv_of_real<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_converges_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_abs_converges_scaleR <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_abs_converges <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> abs <span class="free">c</span> <span class="main">*</span> norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_abs_converges_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> abs <span class="free">c</span> <span class="main">*</span> norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> fds_nth <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_abs_converges_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_abscissa_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"conv_abscissa <span class="main">(</span>scaleR <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conv_abscissa_mono<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span>scaleR <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> abs_conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_conv_abscissa_mono<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_converges_mult_const_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> fds_converges <span class="main">(</span>fds_const <span class="free">c</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> summable_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_abs_converges_mult_const_left <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> fds_abs_converges <span class="main">(</span>fds_const <span class="free">c</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_abs_converges_def norm_mult norm_divide <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> summable_mult<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">c</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_abscissa_mult_const_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"conv_abscissa <span class="main">(</span>fds_const <span class="free">c</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conv_abscissa_mono<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_mult_const_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span>fds_const <span class="free">c</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> abs_conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_conv_abscissa_mono<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_converges_mult_const_right <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> fds_converges <span class="main">(</span><span class="free">f</span> <span class="main">*</span> fds_const <span class="free">c</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> summable_mult2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_abs_converges_mult_const_right <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> fds_abs_converges <span class="main">(</span><span class="free">f</span> <span class="main">*</span> fds_const <span class="free">c</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_abs_converges_def norm_mult norm_divide <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> summable_mult2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">c</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_abscissa_mult_const_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"conv_abscissa <span class="main">(</span><span class="free">f</span> <span class="main">*</span> fds_const <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conv_abscissa_mono<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_mult_const_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span><span class="free">f</span> <span class="main">*</span> fds_const <span class="free">c</span><span class="main">)</span> <span class="main">≤</span> abs_conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_conv_abscissa_mono<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> bounded_coeffs_imp_fds_abs_converges<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> dirichlet_series"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fds"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span>fds_nth <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bseq_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fds_abs_converges_comparison_test<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="main">(</span><span class="skolem">C</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> fds_zeta<span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">∙</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_abs_converges_imp_converges<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> fds_nth <span class="main">(</span><span class="skolem">C</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> fds_zeta<span class="main">)</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> always_eventually<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_zeta<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_coeffs_imp_fds_abs_converges'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> dirichlet_series"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fds"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> nat_power <span class="bound">n</span> <span class="free">s0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">-</span> <span class="free">s0</span> <span class="main">∙</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_nth <span class="main">(</span>fds_shift <span class="free">s0</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> nat_power <span class="bound">n</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span>fds_nth <span class="main">(</span>fds_shift <span class="free">s0</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_abs_converges <span class="main">(</span>fds_shift <span class="free">s0</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">+</span> <span class="free">s0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bounded_coeffs_imp_fds_abs_converges<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_coeffs_imp_abs_conv_abscissa_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> dirichlet_series"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fds"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">ereal</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">s</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="free">f</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> abs_conv_abscissa_leI_weak<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> ereal <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ereal <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">s</span> <span class="main">∙</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> ereal <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">s</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">&lt;</span> ereal <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="main">(</span>of_real <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bounded_coeffs_imp_fds_abs_converges'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_coeffs_imp_abs_conv_abscissa_le_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> dirichlet_series"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fds"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="free">f</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span> <span class="skolem">n</span> <span class="main">*</span> nat_power <span class="skolem">n</span> <span class="main">0</span> <span class="main">=</span> fds_nth <span class="free">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_coeffs_imp_abs_conv_abscissa_le<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: replace library version *)</span>
<span class="comment1">(* EXAMPLE: This might make a good example to illustrate real_asymp *)</span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> set_integrable_powr_at_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">absolutely_integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   set_lebesgue_integral_powr_at_top<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   powr_has_integral_at_top<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> limits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="var">?F</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">(</span>ereal <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">∞</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c ab <span class="keyword1"><span class="command">unfolding</span></span> ereal_tendsto_simps1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">real_asymp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="free">a</span> <span class="main">∞</span><span class="main">)</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab c limits
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> interval_integral_FTC_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="keyword1">absolutely_integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_integrable_def integrable_completion<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span>ereal <span class="free">a</span><span class="main">..</span><span class="main">∞</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?F</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab c limits
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> interval_integral_FTC_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interval_integral_to_infinity_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="keyword1">has_integral</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_borel_integral_eq_integral<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_converges_altdef2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟷</span> convergent <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> eval_fds <span class="main">(</span>fds_truncate <span class="bound">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fds_converges_def summable_iff_convergent' eval_fds_truncate
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> convergent_cong always_eventually sum.mono_neutral_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_eval_fds_truncate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> eval_fds <span class="main">(</span>fds_truncate <span class="bound">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> eval_fds <span class="free">f</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> eval_fds <span class="main">(</span>fds_truncate <span class="bound">N</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> eval_fds <span class="free">f</span> <span class="free">s</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="bound">N</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">i</span> <span class="main">/</span> nat_power <span class="bound">i</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> eval_fds <span class="free">f</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_fds_truncate
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_cong always_eventually allI sum.mono_neutral_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_converges_iff sums_def' atLeast0AtMost<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linepath_translate_left<span class="main">:</span> <span class="quoted"><span class="quoted">"linepath <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="main">∘</span> linepath <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff linepath_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linepath_translate_right<span class="main">:</span> <span class="quoted"><span class="quoted">"linepath <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">∘</span> linepath <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff linepath_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_on_affinity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">integrable_on</span> <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrable_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> has_integral_affinity<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrable_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_integral_cmul_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms has_integral_cmul<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
        has_integral_cmul<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"inverse <span class="free">c</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> has_integral_affinity'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="free">m</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">i</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span> <span class="main">^</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>cbox <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cbox <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cbox <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> box_eq_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">¦</span><span class="free">m</span><span class="main">¦</span> <span class="main">^</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">i</span><span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_affinity<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span>  <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> cbox <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> image_smult_cbox<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">…</span> <span class="main">=</span> cbox <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cbox_translation <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="dynamic"><span class="dynamic">vector_add_divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_integral_affinity_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> euclidean_space <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> real_normed_vector"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">I</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span> <span class="main">^</span> <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>cbox <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
           <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>cbox <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> has_integral_affinity'<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">c</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">vector_add_divide_simps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> has_integral_affinity'<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_contour_integral_linepath_Reals_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Reals"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Reals"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_real <span class="main">(</span>Re <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"of_real <span class="main">(</span>Re <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>cbox <span class="main">(</span>Re <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Re <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> of_real <span class="bound">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> of_real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>Re <span class="free">b</span> <span class="main">-</span> Re <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> has_integral_affinity_iff <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Re <span class="free">b</span> <span class="main">-</span> Re <span class="free">a</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> scaleR_conv_of_real<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> of_real <span class="bound">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> of_real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> of_real <span class="bound">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> of_real <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>Re <span class="free">b</span> <span class="main">-</span> Re <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> fun_eq_iff scaleR_conv_of_real<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="keyword1">has_integral</span> <span class="free">I</span> <span class="keyword1">/<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>Re <span class="free">b</span> <span class="main">-</span> Re <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟷</span>
               <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> has_integral_cmul_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linepath_def scaleR_conv_of_real <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> has_contour_integral_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vector_derivative_linepath_within<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integrable_linepath_Reals_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Reals"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Reals"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">contour_integrable_on</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_real <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_contour_integral_linepath_Reals_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contour_integrable_on_def integrable_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_linepath_Reals_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Reals"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> Reals"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"contour_integral <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> integral <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_real <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> linepath <span class="free">a</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> has_contour_integral_linepath_Reals_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> has_contour_integral_integral has_contour_integral_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> contour_integrable_linepath_Reals_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_integrable_contour_integral not_integrable_integral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_contour_integral_linepath_same_Im_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">=</span> Im <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_real <span class="bound">x</span> <span class="main">+</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"vector_derivative <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">∘</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> linepath_translate_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>linepath <span class="main">(</span><span class="free">a</span> <span class="main">-</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> linepath_translate_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> deriv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_contour_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> has_contour_integral_linepath_Reals_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_is_Real_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integrable_linepath_same_Im_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">=</span> Im <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">contour_integrable_on</span> linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>of_real <span class="bound">x</span> <span class="main">+</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_contour_integral_linepath_same_Im_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contour_integrable_on_def integrable_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_linepath_same_Im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">=</span> Im <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"contour_integral <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> integral <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> Im <span class="free">a</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> linepath <span class="free">a</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> has_contour_integral_linepath_same_Im_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> has_contour_integral_integral has_contour_integral_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> contour_integrable_linepath_same_Im_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_integrable_contour_integral not_integrable_integral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span> <span class="main">=</span> div_mult_self3 div_mult_self4 div_mult_self2 div_mult_self1

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_compact_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"compact <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> compact_continuous_image<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compact_imp_bounded <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">B</span> <span class="main">0</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> max <span class="skolem">B</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> cis<span class="main">:</span> periodic_fun_simple <span class="quoted">cis</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> open_contains_cbox<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"open <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cbox <span class="free">a</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> box <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"ball <span class="free">x</span> <span class="skolem">R</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> open_contains_ball<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> sqrt <span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="skolem">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> Topology_Euclidean_Space.One"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> cbox <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">x</span> <span class="skolem">y</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span>dist <span class="main">(</span><span class="free">x</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> euclidean_dist_l2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L2_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span>dist <span class="main">(</span><span class="free">x</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∙</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span>Basis<span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span><span class="main">.</span> <span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> real_sqrt_le_mono sum_mono power_mono<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm d_def cbox_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">DIM</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">R</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def power_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">…</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ball <span class="free">x</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="skolem">d</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> d_def box_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> open_contains_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> euclidean_space"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"open <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"box <span class="free">a</span> <span class="free">b</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> box <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> open_contains_cbox<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">guess</span></span></span></span> a b <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> box_subset_cbox<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> analytic_onE_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">&lt;</span> Im <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> box <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> box <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">holomorphic_on</span> ball <span class="free">s</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> analytic_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> open_contains_box<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ball <span class="free">s</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"box <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">⊆</span> ball <span class="free">s</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="skolem">a</span> <span class="main">∙</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">b</span> <span class="main">∙</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> ball <span class="free">s</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analytic_on_open<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> analytic_on_subset<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"ball <span class="free">s</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_complex_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inner_image_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> euclidean_space<span class="main">)</span> <span class="main">∈</span> Basis"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">∙</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> box <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span> <span class="main">∙</span> <span class="free">i</span><span class="main">&lt;..&lt;</span><span class="free">b</span> <span class="main">∙</span> <span class="free">i</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">∙</span> <span class="free">i</span><span class="main">&lt;..&lt;</span><span class="free">b</span> <span class="main">∙</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">j</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∙</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> box <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> box_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∙</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="bound">j</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">j</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_sum_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_not_same_Basis assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> box <span class="free">a</span> <span class="free">b</span>"</span></span>  <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> box_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Re_image_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">&lt;</span> Im <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Re <span class="main">`</span> box <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">&lt;..&lt;</span>Re <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_image_box<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>complex"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_complex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Im_image_box<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">&lt;</span> Re <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">&lt;</span> Im <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Im <span class="main">`</span> box <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span>Im <span class="free">a</span><span class="main">&lt;..&lt;</span>Im <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_image_box<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝗂</span><span class="main">::</span>complex"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_complex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inner_image_cbox<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> euclidean_space<span class="main">)</span> <span class="main">∈</span> Basis"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="free">a</span> <span class="main">∙</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∙</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span> <span class="main">∙</span> <span class="free">i</span><span class="main">..</span><span class="free">b</span> <span class="main">∙</span> <span class="free">i</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span> <span class="main">∙</span> <span class="free">i</span><span class="main">..</span><span class="free">b</span> <span class="main">∙</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="free">a</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∙</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> imageI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cbox_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∙</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="free">a</span> <span class="main">∙</span> <span class="bound">j</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">j</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_sum_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>Basis<span class="main">.</span> <span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="skolem">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inner_not_same_Basis assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∙</span> <span class="free">i</span><span class="main">)</span> <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span>"</span></span>  <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cbox_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Re_image_cbox<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">≤</span> Re <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">≤</span> Im <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Re <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span>Re <span class="free">a</span><span class="main">..</span>Re <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_image_cbox<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>complex"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_complex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Im_image_cbox<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">a</span> <span class="main">≤</span> Re <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="free">a</span> <span class="main">≤</span> Im <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Im <span class="main">`</span> cbox <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="main">{</span>Im <span class="free">a</span><span class="main">..</span>Im <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inner_image_cbox<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝗂</span><span class="main">::</span>complex"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_complex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analytic_onE_cball<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ub</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">R</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> cball <span class="free">s</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">holomorphic_on</span> ball <span class="free">s</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> analytic_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> ball <span class="free">s</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> analytic_on_open<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> cball <span class="free">s</span> <span class="main">(</span>min <span class="main">(</span><span class="free">ub</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> cball_subset_ball_iff<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">ub</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">ub</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ub</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">ub</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">corollary</span></span> analytic_pre_zeta' <span class="main">[</span><span class="operator">analytic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pre_zeta <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> analytic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> analytic_pre_zeta<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> analytic_hurwitz_zeta' <span class="main">[</span><span class="operator">analytic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> hurwitz_zeta <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> analytic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> analytic_hurwitz_zeta<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> analytic_zeta' <span class="main">[</span><span class="operator">analytic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> zeta <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> analytic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> analytic_zeta<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> logderiv_zeta_analytic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> deriv zeta <span class="bound">s</span> <span class="main">/</span> zeta <span class="bound">s</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zeta_Re_ge_1_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">analytic_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cis_pi_half <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝗂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_real_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">*</span> sqrt <span class="free">y</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_sqrt_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arcsin_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> arcsin <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arcsin_less_arcsin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> analytic_imp_holomorphic' <span class="main">=</span> holomorphic_on_subset<span class="main">[</span><span class="operator">OF</span> analytic_imp_holomorphic<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> residue_simple'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"open <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">holomorphic_on</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"residue <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="free">f</span> <span class="bound">w</span> <span class="main">/</span> <span class="bound">w</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> residue_simple<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> fds_converges_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> fds_nth <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟷</span> fds_converges <span class="free">g</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fds_converges_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_abs_converges_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> fds_nth <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟷</span> fds_abs_converges <span class="free">g</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fds_abs_converges_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_abscissa_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> fds_nth <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"conv_abscissa <span class="free">f</span> <span class="main">=</span> conv_abscissa <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="main">=</span> fds_converges <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext fds_converges_cong assms refl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conv_abscissa_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> fds_nth <span class="free">g</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="free">f</span> <span class="main">=</span> abs_conv_abscissa <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="main">=</span> fds_abs_converges <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext fds_abs_converges_cong assms refl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_conv_abscissa_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fds_remainder</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fds_remainder</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> fds_subseries <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_nth_remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_nth <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="free">m</span> <span class="keyword1">then</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_remainder_def fds_subseries_def fds_nth_fds'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_converges_remainder_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_converges <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> fds_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_converges_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_remainder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_abs_converges_remainder_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_abs_converges <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> fds_abs_converges <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_abs_converges_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_remainder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_converges_remainder <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
        <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> fds_converges <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fds_abs_converges_remainder <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
        <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">f</span> <span class="free">s</span> <span class="main">⟹</span> fds_abs_converges <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_abscissa_remainder <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"conv_abscissa <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conv_abscissa_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_remainder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_remainder <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> abs_conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_conv_abscissa_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_remainder<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_fds_remainder<span class="main">:</span>
   <span class="quoted"><span class="quoted">"eval_fds <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span> <span class="main">/</span> nat_power <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> suminf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">f</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>fds_converges <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_def summable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_fds_def suminf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fds_converges_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> summable_iff_shift<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> summable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suminf <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suminf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_converges <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval_fds_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span> <span class="main">/</span> nat_power <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> fds_converges_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> suminf_minus_initial_segment<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_remainder<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="main">(</span>fds_remainder <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_remainder<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_truncate_plus_remainder<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_truncate <span class="free">m</span> <span class="free">f</span> <span class="main">+</span> fds_remainder <span class="free">m</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_truncate_def fds_remainder_def fds_subseries_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> holomorphic_fds_eval' <span class="main">[</span><span class="operator">holomorphic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">holomorphic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> Re <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval_fds <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> holomorphic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> holomorphic_fds_eval<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order.refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analytic_fds_eval' <span class="main">[</span><span class="operator">analytic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> Re <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval_fds <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> analytic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> analytic_fds_eval<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order.refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homotopic_loopsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> real <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="free">h</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="bound">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="bound">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> pathfinish <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> Pair <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> pathstart <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> Pair <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"homotopic_loops <span class="free">s</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> homotopic_loops <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_linepath <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> linepath <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linepath_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_part_circlepath <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">b</span>"</span></span>
          <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> part_circlepath <span class="main">(</span><span class="free">c</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> part_circlepath_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homotopic_loops_part_circlepath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sphere <span class="free">c</span> <span class="free">r</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">b1</span> <span class="main">=</span> <span class="free">a1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> of_int <span class="free">k</span> <span class="main">*</span> pi"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b2</span> <span class="main">=</span> <span class="free">a2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> of_int <span class="free">k</span> <span class="main">*</span> pi"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"homotopic_loops <span class="free">A</span> <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a1</span> <span class="free">b1</span><span class="main">)</span> <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a2</span> <span class="free">b2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span>linepath <span class="free">a1</span> <span class="free">a2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>linepath <span class="free">b1</span> <span class="free">b2</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> homotopic_loopsI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def case_prod_unfold <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def part_circlepath_def dist_norm norm_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a1</span> <span class="free">b1</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a2</span> <span class="free">b2</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def linepath_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>pi <span class="main">*</span> <span class="main">(</span>real_of_int <span class="free">k</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cis.plus_of_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="main">(</span><span class="skolem">h</span> <span class="main">∘</span> Pair <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> pathstart <span class="main">(</span><span class="skolem">h</span> <span class="main">∘</span> Pair <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def o_def exp_eq_polar linepath_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span>
                    cis_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cis_divide <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> homotopic_pathsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">×</span> real <span class="main">⇒</span> <span class="main">_</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> pathstart <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> Pair <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> pathstart <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⟹</span> pathfinish <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> Pair <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> pathfinish <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"homotopic_paths <span class="free">s</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> homotopic_paths <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">h</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> part_circlepath_conv_subpath<span class="main">:</span>
  <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> subpath <span class="main">(</span><span class="free">a</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span><span class="main">)</span> <span class="main">(</span>circlepath <span class="free">c</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part_circlepath_def circlepath_def subpath_def linepath_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> exp_eq_polar<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> homotopic_paths_part_circlepath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">a</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"homotopic_paths <span class="free">A</span> <span class="main">(</span>part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">a</span> <span class="free">c</span><span class="main">)</span>
             <span class="main">(</span>part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">+++</span> part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">b</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"homotopic_paths <span class="main">_</span> <span class="var">?g</span> <span class="main">(</span><span class="var">?h1</span> <span class="main">+++</span> <span class="var">?h2</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">c</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">slope</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">slope</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> slope<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">slope</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> slope_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> linepath <span class="main">0</span> <span class="skolem">slope</span> <span class="main">+++</span> linepath <span class="skolem">slope</span> <span class="main">1</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> homotopic_paths_reparametrize<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?h1</span> <span class="main">+++</span> <span class="var">?h2</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cis <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> joinpaths_def part_circlepath_def exp_eq_polar linepath_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def slope_def linepath_def joinpaths_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> div_mult_self3 div_mult_self4 div_mult_self2 div_mult_self1<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cis <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?h1</span> <span class="main">+++</span> <span class="var">?h2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> joinpaths_def part_circlepath_def exp_eq_polar linepath_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cis <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> joinpaths_def part_circlepath_def exp_eq_polar linepath_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&lt;</span> <span class="free">c</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">f</span> <span class="skolem">t</span> <span class="main">*</span> <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def slope_def linepath_def joinpaths_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> div_mult_self3 div_mult_self4 div_mult_self2 div_mult_self1<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cis <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?h1</span> <span class="main">+++</span> <span class="var">?h2</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> joinpaths_def part_circlepath_def exp_eq_polar linepath_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> slope <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">f</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def path_image_join closed_segment_eq_real_ivl<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def joinpaths_def linepath_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">c</span> <span class="free">c</span> <span class="main">+++</span> part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">c</span> <span class="free">c</span> <span class="main">=</span> part_circlepath <span class="free">C</span> <span class="free">r</span> <span class="free">c</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff joinpaths_def part_circlepath_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_contour_integral_mirror_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">piecewise_differentiable_on</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_path_def piecewise_C1_imp_differentiable<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> piecewise_differentiable_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">differentiable</span> <span class="keyword1">at</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> interior <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> S<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> at_within_interior<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> vector_derivative <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_contour_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> vector_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_spike_finite_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">S</span>›</span></span> S'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def fun_Compl_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_contour_integral</span> <span class="free">I</span><span class="main">)</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_contour_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_on_mirror_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">contour_integrable_on</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contour_integrable_on_def has_contour_integral_mirror_iff assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_mirror<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"contour_integral <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> contour_integral <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contour_integrable_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> has_contour_integral_mirror_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_contour_integral</span> <span class="skolem">I</span><span class="main">)</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> contour_integral_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">contour_integrable_on</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> contour_integral_on_mirror_iff assms<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_integrable_contour_integral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integrable_neg_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">contour_integrable_on</span> <span class="free">g</span> <span class="main">⟷</span> <span class="free">f</span> <span class="keyword1">contour_integrable_on</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> contour_integrable_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> contour_integrable_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"contour_integral <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>contour_integral <span class="free">g</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> <span class="free">g</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contour_integral_neg<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">contour_integrable_on</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contour_integrable_neg_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_integrable_contour_integral<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> minus_cis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>cis <span class="free">x</span> <span class="main">=</span> cis <span class="main">(</span><span class="free">x</span> <span class="main">+</span> pi<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> path_image_part_circlepath_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">a'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">≤</span> <span class="free">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a'</span> <span class="free">b'</span><span class="main">)</span> <span class="main">⊆</span> path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> path_image_part_circlepath<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> part_circlepath_mirror<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> pi <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> pi <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> of_int <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="main">-</span><span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">-</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> part_circlepath <span class="free">c'</span> <span class="free">r</span> <span class="free">a'</span> <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c'</span> <span class="free">r</span> <span class="free">a'</span> <span class="free">b'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cis <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span> <span class="skolem">x</span> <span class="main">+</span> pi <span class="main">+</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part_circlepath_def exp_eq_polar assms linepath_translate_right mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span> <span class="skolem">x</span> <span class="main">+</span> pi <span class="main">+</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span> <span class="main">=</span> cis <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span> <span class="skolem">x</span> <span class="main">+</span> pi<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cis.plus_of_int<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span>cis <span class="main">(</span>linepath <span class="free">a</span> <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_cis<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="main">-</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part_circlepath_def assms exp_eq_polar<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> part_circlepath <span class="free">c'</span> <span class="free">r</span> <span class="free">a'</span> <span class="free">b'</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_mirror <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">g</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>topological_group_add<span class="main">)</span> <span class="main">⟹</span> path <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> path_mirror_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="main">-</span><span class="free">g</span> <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>topological_group_add<span class="main">)</span> <span class="main">⟷</span> path <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> path_mirror<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> path_mirror<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_Compl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_path_mirror <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_path <span class="free">g</span> <span class="main">⟹</span> valid_path <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_path_def fun_Compl_def piecewise_C1_differentiable_neg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_path_mirror_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_path <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> valid_path <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_path_mirror<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> valid_path_mirror<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_Compl_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pathstart_mirror <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pathstart <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>pathstart <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pathfinish_mirror <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pathfinish <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>pathfinish <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pathstart_def pathfinish_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> path_image_mirror<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span><span class="main">-</span><span class="free">g</span><span class="main">)</span> <span class="main">=</span> uminus <span class="main">`</span> path_image <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_bound_part_circlepath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span>contour_integral <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">*</span> <span class="free">r</span> <span class="main">*</span> <span class="main">¦</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> of_real <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
              exp <span class="main">(</span><span class="keyword1">𝗂</span> <span class="main">*</span> linepath <span class="free">a</span> <span class="free">b</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="var">?I</span> <span class="main">≤</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="free">B</span> <span class="main">*</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="main">¦</span><span class="free">b</span> <span class="main">-</span> <span class="free">a</span><span class="main">¦</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integral_norm_bound_integral<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contour_integrable_on vector_derivative_part_circlepath mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm_mult norm_of_real abs_mult
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> contour_integral <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contour_integral_integral vector_derivative_part_circlepath mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> contour_integral_spike_finite_simple_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"simple_path <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">g'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> path_image <span class="free">g</span> <span class="main">-</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"contour_integral <span class="free">g</span> <span class="free">f</span> <span class="main">=</span> contour_integral <span class="free">g'</span> <span class="free">f'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> contour_integral_integral
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integral_spike<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">g</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹simple_path <span class="free">g</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_vimage_IntI simple_path_inj_on<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="free">g</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="free">g</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> negligible_finite<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span> <span class="main">-</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="free">g</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span> <span class="main">∈</span> path_image <span class="free">g</span> <span class="main">-</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">(</span><span class="free">g'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> vector_derivative <span class="free">g'</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> vector_derivative <span class="free">g</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> contour_integral_bound_part_circlepath_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">contour_integrable_on</span> part_circlepath <span class="free">z</span> <span class="free">r</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> path_image<span class="main">(</span>part_circlepath <span class="free">z</span> <span class="free">r</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span> <span class="main">⟹</span> norm<span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span>contour_integral <span class="main">(</span>part_circlepath <span class="free">z</span> <span class="free">r</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">*</span> <span class="free">r</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_contour_integral</span> contour_integral <span class="main">(</span>part_circlepath <span class="free">z</span> <span class="free">r</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>
                  <span class="main">(</span>part_circlepath <span class="free">z</span> <span class="free">r</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_contour_integral_integral<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> has_contour_integral_bound_part_circlepath_strong<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cos_le_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"cos <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cos <span class="free">x</span> <span class="main">=</span> <span class="main">-</span>cos <span class="main">(</span><span class="free">x</span> <span class="main">-</span> pi<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cos_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cos <span class="main">(</span><span class="free">x</span> <span class="main">-</span> pi<span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cos_ge_zero<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cos_le_zero'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">⟹</span> cos <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cos_le_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cis_minus_pi_half <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="main">-</span> <span class="main">(</span>pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="keyword1">𝗂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> winding_number_join_pos_combined'<span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">⟦</span>valid_path <span class="free">γ1</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">∉</span> path_image <span class="free">γ1</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> Re <span class="main">(</span>winding_number <span class="free">γ1</span> <span class="free">z</span><span class="main">)</span><span class="main">;</span>
       valid_path <span class="free">γ2</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">∉</span> path_image <span class="free">γ2</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> Re <span class="main">(</span>winding_number <span class="free">γ2</span> <span class="free">z</span><span class="main">)</span><span class="main">;</span>
       pathfinish <span class="free">γ1</span> <span class="main">=</span> pathstart <span class="free">γ2</span><span class="main">⟧</span>
      <span class="main">⟹</span> valid_path<span class="main">(</span><span class="free">γ1</span> <span class="main">+++</span> <span class="free">γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">∉</span> path_image<span class="main">(</span><span class="free">γ1</span> <span class="main">+++</span> <span class="free">γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> Re<span class="main">(</span>winding_number<span class="main">(</span><span class="free">γ1</span> <span class="main">+++</span> <span class="free">γ2</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_path_join path_image_join winding_number_join valid_path_imp_path<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Union_atLeastAtMost_real_of_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">n</span><span class="main">..</span>real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..</span>real <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="free">a</span><span class="main">..</span>real <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">n</span><span class="main">..</span>real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> real <span class="free">b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> real <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> real <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> real <span class="main">(</span>Suc <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span> <span class="main">≥</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="bound">n</span><span class="main">..</span>real <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nat_sum_has_integral_floor<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span>real <span class="free">m</span><span class="main">..</span>real <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">i</span><span class="main">..</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="keyword1">division_of</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Union_atLeastAtMost_real_of_nat<span class="main">[</span><span class="operator">OF</span> mn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> division_of_def D_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">∑</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="bound">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>real <span class="free">m</span><span class="main">..</span>real <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_combine_division<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span> <span class="main">=</span> nat <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">-</span> <span class="main">{</span>Sup <span class="skolem">X</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_def nat_eq_iff floor_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">⟷</span>
           <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_spike_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Sup <span class="skolem">X</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_integral_const_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="skolem">X</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Inf <span class="bound">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def nat_add_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nat_sum_has_integral_ceiling<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">m</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span>real <span class="free">m</span><span class="main">..</span>real <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">i</span><span class="main">..</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="keyword1">division_of</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Union_atLeastAtMost_real_of_nat<span class="main">[</span><span class="operator">OF</span> mn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> division_of_def D_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">∑</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="bound">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>real <span class="free">m</span><span class="main">..</span>real <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_combine_division<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="skolem">x</span><span class="main">⌉</span> <span class="main">=</span> nat <span class="main">⌊</span>Sup <span class="skolem">X</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">-</span> <span class="main">{</span>Inf <span class="skolem">X</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_def nat_eq_iff ceiling_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">⟷</span>
           <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_spike_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Inf <span class="skolem">X</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> has_integral_const_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"Sup <span class="skolem">X</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="skolem">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">D</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span>Sup <span class="bound">X</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">m</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def nat_add_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">m</span><span class="main">&lt;..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted">Suc</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zeta_partial_sum_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> real <span class="bound">k</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">1</span> <span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> real <span class="bound">k</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> real <span class="bound">k</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> real <span class="bound">k</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_le<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">t</span><span class="main">⌉</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>real <span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nat_sum_has_integral_ceiling<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span>real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span> <span class="main">-</span> real <span class="main">1</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>
              <span class="main">{</span>real <span class="main">1</span><span class="main">..</span>real <span class="free">m</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span>
           <span class="main">(</span><span class="operator">insert</span> x m<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
                             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span>real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>real <span class="main">1</span><span class="main">..</span>real <span class="free">m</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> powr_mono2'<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">(</span>real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zeta_partial_sum_le'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> real <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> real <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> zeta_partial_sum_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="free">m</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_le<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">t</span><span class="main">⌋</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span><span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nat_sum_has_integral_floor<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span>real <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> has_integral_powr_from_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="free">m</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">t</span><span class="main">⌋</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> powr_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_diff <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> natfun_bigo_1E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≥</span> <span class="free">lb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">N</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> landau_o.bigE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_at_top_linorder<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">{</span><span class="skolem">C</span><span class="main">,</span> <span class="free">lb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>norm <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">N</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">N</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">subst</span> Max_ge_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="main">{</span><span class="skolem">C</span><span class="main">,</span> <span class="free">lb</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>norm <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">N</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="free">lb</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max.coboundedI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> natfun_bigo_iff_Bseq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> Bseq <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bseq_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> natfun_bigo_1E<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lb <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bseq_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> enn_decreasing_sum_le_set_nn_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> ennreal"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> set_nn_integral lborel <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_cmult_indicator<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="skolem">x</span><span class="main">⌉</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="skolem">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_eq_iff ceiling_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> suminf_cong nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">i</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">::</span>real<span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_disjoint_family<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> decreasing<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO replace version in library *)</span>
<span class="keyword1"><span class="command">lemma</span></span> nn_integral_has_integral_lebesgue<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>euclidean_space <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Ω</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="free">Ω</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> lebesgue <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_implies_lebesgue_measurable<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">∈</span> borel <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> lborel<span class="main">.</span> indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> completion_ex_borel_measurable_real<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span>indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">y</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span>indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> UNIV <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span><span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_AE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span><span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_has_integral_lborel<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span><span class="skolem">f'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span>indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong_AE<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> abs <span class="main">(</span>indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="free">Ω</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decreasing_sum_le_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> integral<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"suminf <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> integral<span class="main"><span class="main">]</span></span> nonneg<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_cmult_indicator<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌈</span><span class="skolem">x</span><span class="main">⌉</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="skolem">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_eq_iff ceiling_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="bound">n</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> suminf_cong nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span>real <span class="bound">i</span><span class="main">&lt;..</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">::</span>real<span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_disjoint_family<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disjoint_family_on_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> measurable_completion<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def nonneg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> decreasing<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>indicat_real <span class="main">{</span><span class="main">0</span><span class="main">..}</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_has_integral_lebesgue<span class="main">[</span><span class="operator">OF</span> nonneg integral<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ennreal <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> summable<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_suminf_not_top<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> top_unique <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> *
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> summable <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> ennreal <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> suminf_ennreal2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ennreal_le_iff<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decreasing_sum_le_integral'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">has_integral</span> <span class="free">I</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"suminf <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">0</span> <span class="main">+</span> <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decreasing_sum_le_integral<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> summable_Suc_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> decreasing_sum_le_integral assms<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"suminf <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>real <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">0</span> <span class="main">+</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> suminf_split_head<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> norm_suminf_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> banach<span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">n</span>"</span></span> <span class="quoted"><span class="quoted">"summable <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span>suminf <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> suminf <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_norm summable_comparison_test<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>suminf <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_norm<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> suminf <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> suminf_le * assms allI<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_powr_neq_1_complex <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"of_nat <span class="free">n</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>complex<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>of_nat <span class="free">n</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="keyword1">powr</span> Re <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_powr_real_powr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_summable_on_uminus_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">f</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> abs_summable_on_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> abs_summable_on_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_summable_on_cmult_right_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span> real_normed_field<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">f</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms abs_summable_on_cmult_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        abs_summable_on_cmult_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inverse <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_summable_on_cmult_left_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>banach<span class="main">,</span> real_normed_field<span class="main">,</span> second_countable_topology<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">f</span> <span class="keyword1">abs_summable_on</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms abs_summable_on_cmult_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        abs_summable_on_cmult_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inverse <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fds_logderiv_completely_multiplicative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>real_normed_field<span class="main">}</span> fds"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="main">(</span>fds_nth <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_deriv <span class="free">f</span> <span class="main">/</span> <span class="free">f</span> <span class="main">=</span> <span class="main">-</span> fds <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> mangoldt <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_deriv <span class="free">f</span> <span class="main">/</span> <span class="free">f</span> <span class="main">=</span> <span class="main">-</span> fds <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> mangoldt <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">/</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> completely_multiplicative_fds_deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> fds <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> mangoldt <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_fds_def fds_right_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_nth_logderiv_completely_multiplicative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>real_normed_field<span class="main">}</span> fds"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="main">(</span>fds_nth <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_nth <span class="main">(</span>fds_deriv <span class="free">f</span> <span class="main">/</span> <span class="free">f</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">-</span>fds_nth <span class="free">f</span> <span class="free">n</span> <span class="main">*</span> mangoldt <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fds_logderiv_completely_multiplicative<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_nth_fds'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_fds_logderiv_completely_multiplicative<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> dirichlet_series"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fds"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≡</span> fds_deriv <span class="free">f</span> <span class="main">/</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="main">(</span>fds_nth <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∙</span> <span class="main">1</span> <span class="main">&gt;</span> abs_conv_abscissa <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"eval_fds <span class="free">h</span> <span class="free">s</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                            <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> f<span class="main">:</span> completely_multiplicative_function <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_abs_converges <span class="free">h</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs_conv_abscissa_completely_multiplicative_log_deriv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_abs_converges<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">h</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def fds_abs_converges_altdef'<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> *
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">h</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> UNIV <span class="main">⟷</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>fds_nth <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> mangoldt <span class="bound">x</span> <span class="main">/</span> nat_power <span class="bound">x</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> Collect primepow"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">using</span></span> fds_nth_logderiv_completely_multiplicative<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_fds mangoldt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sum1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>fds_nth <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> mangoldt <span class="bound">x</span> <span class="main">/</span> nat_power <span class="bound">x</span> <span class="free">s</span><span class="main">)</span>
                      <span class="keyword1">abs_summable_on</span> Collect primepow"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_summable_on_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="main">-</span>fds_nth <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span>
                                nat_power <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">(</span><span class="var">?P</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_primepows <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_reindex_bij_betw <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span><span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span> <span class="main">*</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword1">abs_summable_on</span> <span class="main">(</span><span class="var">?P</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mangoldt_primepow<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f.mult f.power nat_power_mult_distrib nat_power_power_left power_divide
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sum2<span class="main">:</span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> sum4<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">¦</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span><span class="main">¦</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p abs_summable_on_Sigma_project2<span class="main">[</span><span class="operator">OF</span> sum2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> abs_summable_on_nat_iff'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_power norm_mult norm_divide mult_ac <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> summable_mult_D<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sums<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="keyword1">sums</span>
                <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> sum4<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> summable_Suc_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> summable_geometric_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> geometric_sums<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sums_Suc_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span> <span class="main">*</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">-</span><span class="main">(</span>of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span> <span class="main">*</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span><span class="main">-</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum4<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_cmult_left <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_summable_on_nat_iff' norm_power <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="skolem">p</span> <span class="main">/</span> nat_power <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum4<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> sums<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_nat'<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sums_iff abs_summable_on_nat_iff' norm_power <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> sum3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">x</span> <span class="main">/</span> nat_power <span class="bound">x</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">y</span> <span class="main">*</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                 <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_summable_on_Sigma_project1'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?th1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_summable_on_uminus_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="free">h</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">h</span> <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> eval_fds_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_nat'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> primepow <span class="bound">n</span><span class="main">}</span><span class="main">.</span> <span class="main">-</span>fds_nth <span class="free">f</span> <span class="bound">n</span> <span class="main">*</span> mangoldt <span class="bound">n</span> <span class="main">/</span> nat_power <span class="bound">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">using</span></span> fds_nth_logderiv_completely_multiplicative<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong_neutral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_fds mangoldt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?P</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">.</span> <span class="main">-</span>fds_nth <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> mangoldt <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">/</span>
                                            nat_power <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> bij_betw_primepows <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_reindex_bij_betw <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="var">?P</span> <span class="main">×</span> UNIV<span class="main">)</span><span class="main">.</span>
                     <span class="main">-</span><span class="main">(</span><span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f.mult f.power mangoldt_def aprimedivisor_prime_power ln_realpow prime_gt_0_nat
          nat_power_power_left <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">k</span><span class="main">.</span>
                    <span class="main">-</span> <span class="main">(</span><span class="main">(</span>fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">^</span> Suc <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Times<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                    <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth <span class="free">f</span> <span class="bound">p</span> <span class="main">/</span> nat_power <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> infsetsum_uminus<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_fds_logderiv_zeta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"deriv zeta <span class="free">s</span> <span class="main">/</span> zeta <span class="free">s</span> <span class="main">=</span>
            <span class="main">-</span><span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"completely_multiplicative_function <span class="main">(</span>fds_nth fds_zeta <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> complex<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> abscissa <span class="main">=</span> le_less_trans<span class="main">[</span><span class="operator">OF</span> abs_conv_abscissa_completely_multiplicative_log_deriv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth fds_zeta <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_fds_logderiv_completely_multiplicative<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_zeta <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> Re <span class="bound">z</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>nhds <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_nhds_in_open open_halfspace_Re_gt<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deriv zeta <span class="free">s</span> <span class="main">=</span> deriv <span class="main">(</span>eval_fds fds_zeta<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> deriv_cong_ev<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ev<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_fds_zeta<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deriv <span class="main">(</span>eval_fds fds_zeta<span class="main">)</span> <span class="free">s</span> <span class="main">/</span> zeta <span class="free">s</span> <span class="main">=</span> eval_fds <span class="main">(</span>fds_deriv fds_zeta <span class="main">/</span> fds_zeta<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms zeta_Re_gt_1_nonzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_log_deriv<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_fds_zeta eval_fds_deriv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> abscissa<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="main">(</span>fds_deriv fds_zeta <span class="main">/</span> fds_zeta<span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
               <span class="main">-</span><span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> fds_nth fds_zeta <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">-</span><span class="var">?S</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> eval_fds_logderiv_completely_multiplicative<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_zeta <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sums_logderiv_zeta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">sums</span>
             <span class="main">-</span><span class="main">(</span>deriv zeta <span class="free">s</span> <span class="main">/</span> zeta <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="keyword1">sums</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> eval_fds_logderiv_zeta<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> sums_infsetsum_nat<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_diff_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span><span class="free">f</span> <span class="main">-</span> <span class="free">g</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> dirichlet_series fds<span class="main">)</span> <span class="main">≤</span>
     max <span class="main">(</span>abs_conv_abscissa <span class="free">f</span><span class="main">)</span> <span class="main">(</span>abs_conv_abscissa <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> abs_conv_abscissa_add_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_diff_leI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> dirichlet_series fds<span class="main">)</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span> abs_conv_abscissa <span class="free">g</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span>
     abs_conv_abscissa <span class="main">(</span><span class="free">f</span> <span class="main">-</span> <span class="free">g</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> abs_conv_abscissa_diff_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_max_iff_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> range_add_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">c</span><span class="main">::</span>nat<span class="main">)</span><span class="main">..}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">c</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_summable_hurwitz_zeta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> real <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="free">b</span><span class="main">..}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> cmod <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> summable_hurwitz_zeta_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span> norm_powr_real_powr<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_summable_on_nat_iff' add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_summable_on_reindex_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> range_add_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hurwitz_zeta_nat_conv_infsetsum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"hurwitz_zeta <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"hurwitz_zeta <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hurwitz_zeta <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hurwitz_zeta_conv_suminf<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs_summable_hurwitz_zeta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_nat' <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hurwitz_zeta <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">.</span> of_nat <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infsetsum_reindex <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> range_add_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"hurwitz_zeta <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_on_pre_zeta <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous_on <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pre_zeta <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV <span class="main">(</span>pre_zeta <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> holomorphic_on_imp_continuous_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> holomorphic_pre_zeta<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_pre_zeta <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span> <span class="keyword1">within</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> pre_zeta <span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>pre_zeta <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_interior<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> continuous_within_compose3<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> pre_zeta_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Re <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pre_zeta <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> norm <span class="free">s</span> <span class="main">/</span> Re <span class="free">s</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">-</span>Re <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span>norm <span class="free">s</span> <span class="main">/</span> Re <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span>Re <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> EM_remainder <span class="main">1</span> <span class="var">?f</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span>Re <span class="free">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">-</span> Re <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>frac <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword1"><span class="command">unfolding</span></span> frac_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>pbernpoly <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pbernpoly_def bernpoly_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> cmod <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="bound">b</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span> Re <span class="free">s</span> <span class="main">/</span> Re <span class="free">s</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> real <span class="main">0</span> <span class="main">⟶</span> norm <span class="main">(</span>EM_remainder <span class="main">1</span> <span class="var">?f</span> <span class="main">(</span>int <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                           <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> fact <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="var">?g</span> <span class="main">(</span>real <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> norm_EM_remainder_le_strong_nat'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="var"><span class="quoted"><span class="var">?g'</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> norm_mult norm_powr_real_powr add_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">R</span> <span class="main">≤</span> norm <span class="free">s</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Re <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">using</span></span> spec<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_zeta <span class="free">a</span> <span class="free">s</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">s</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pre_zeta_def pre_zeta_aux_def R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="free">s</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> norm <span class="free">s</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Re <span class="free">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq<span class="main"><span class="main">]</span></span> add_mono R<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_powr_real_powr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> norm <span class="free">s</span> <span class="main">/</span> Re <span class="free">s</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pre_zeta_bound'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Re <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pre_zeta <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> norm <span class="free">s</span> <span class="main">/</span> <span class="main">(</span>Re <span class="free">s</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> Re <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pre_zeta <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> norm <span class="free">s</span> <span class="main">/</span> Re <span class="free">s</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pre_zeta_bound<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>Re <span class="free">s</span> <span class="main">+</span> norm <span class="free">s</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span>Re <span class="free">s</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> Re <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> powr_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">+</span> norm <span class="free">s</span> <span class="main">≤</span> norm <span class="free">s</span> <span class="main">+</span> norm <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_right_mono complex_Re_le_cmod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm <span class="free">s</span> <span class="main">+</span> norm <span class="free">s</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span> norm <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>pre_zeta <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> norm <span class="free">s</span> <span class="main">/</span> <span class="main">(</span>Re <span class="free">s</span> <span class="main">*</span> <span class="free">a</span> <span class="keyword1">powr</span> Re <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> summable_comparison_test_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"summable <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> landau_o.bigE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> summable_comparison_test_ev<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> summable_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deriv_zeta_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"deriv zeta <span class="free">s</span> <span class="main">=</span> deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>nhds <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> t1_space_nhds<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pre_zeta <span class="main">1</span> <span class="keyword1">has_field_derivative</span> deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> holomorphic_derivI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span>
          <span class="main">(</span>deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span>zeta <span class="keyword1">has_field_derivative</span> <span class="main">(</span>deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_field_derivative_cong_ev eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ev<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeta_def hurwitz_zeta_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_imp_deriv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zeta_remove_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pre_zeta <span class="main">1</span> <span class="free">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pre_zeta <span class="main">1</span> <span class="free">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> zeta <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeta_def hurwitz_zeta_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zeta_Re_ge_1_nonzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_fds_deriv_zeta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"eval_fds <span class="main">(</span>fds_deriv fds_zeta<span class="main">)</span> <span class="free">s</span> <span class="main">=</span> deriv zeta <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> Re <span class="bound">z</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>nhds <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_nhds_in_open open_halfspace_Re_gt<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="main">(</span>fds_deriv fds_zeta<span class="main">)</span> <span class="free">s</span> <span class="main">=</span> deriv <span class="main">(</span>eval_fds fds_zeta<span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_deriv<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> deriv zeta <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> deriv_cong_ev eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ev<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_fds_zeta<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_sorted_list_of_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> length <span class="main">(</span>sorted_list_of_set <span class="free">A</span><span class="main">)</span> <span class="main">=</span> card <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_remdups_card_conv length_sort set_sorted_list_of_set
            sorted_list_of_set_sort_remdups<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_nat_iff'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> nat <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∨</span> int <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_upto_plus1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum_upto <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>Suc <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_upto_altdef nat_add_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>Suc <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span>Suc <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">…</span> <span class="main">=</span> sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">+</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_upto_altdef add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_upto_minus1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum_upto <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_upto_plus1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> nat_diff_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> integral_smallo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="free">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">g</span> at_top at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span> <span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a'</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">a'</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.smallI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> continuous_on_subset<span class="main">[</span><span class="operator">OF</span> cont<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> c <span class="keyword1"><span class="command">have</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> landau_o.smallD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">b</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c'</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_top_linorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> max <span class="free">a</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c'</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_tendsto_pos_mult_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c'</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">D</span> <span class="main">-</span> <span class="skolem">c'</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_at_top<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> elim b' <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">g'</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span> <span class="free">f</span> <span class="main">+</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elim b' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Henstock_Kurzweil_Integration.integral_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">+</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_triangle_ineq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c'</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b' elim assms c' integrable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_norm_bound_integral b assms<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c'</span> <span class="main">*</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">g'</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">g'</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span> <span class="main">=</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">g'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms b' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g'</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' elim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> has_field_derivative_at_within<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">g'</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="skolem">c'</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> c'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> integral_bigo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">g'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">g</span> at_top at_top"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span> <span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">a'</span> <span class="main">⟹</span> <span class="bound">a'</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="bound">a'</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">has_field_derivative</span> <span class="free">g'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="bound">x</span> <span class="keyword1">within</span> <span class="main">{</span><span class="free">a</span><span class="main">..}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="free">a</span><span class="main">..}</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="bound">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> continuous_on_subset<span class="main">[</span><span class="operator">OF</span> cont<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> landau_o.bigE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">b</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eventually_at_top_linorder <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> max <span class="free">a</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> at_top at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_tendsto_pos_mult_at_top<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_const<span class="main"><span class="main">]</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">D</span> <span class="main">-</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_at_top<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> elim b' <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">g'</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span> integral <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="skolem">b'</span><span class="main">}</span> <span class="free">f</span> <span class="main">+</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elim b' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Henstock_Kurzweil_Integration.integral_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="skolem">D</span> <span class="main">+</span> norm <span class="main">(</span>integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_triangle_ineq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">f</span><span class="main">)</span> <span class="main">≤</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b' elim assms c integrable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_norm_bound_integral b assms<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">g'</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span><span class="free">g'</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span> <span class="main">=</span> integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">g'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms b' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g'</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b' elim
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> DERIV_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> deriv<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">b'</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="free">g'</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">b'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">g</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> c'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bigoI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primepows_le_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span>nat <span class="main">⌊</span>root <span class="free">l</span> <span class="free">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">p</span> <span class="main">^</span> <span class="free">l</span> <span class="main">≤</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi x l
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">l</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="free">l</span><span class="main">)</span> <span class="main">≤</span> root <span class="free">l</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x pi l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> real_root_le_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">l</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pi l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> real_root_pos2<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> nat <span class="main">⌊</span>root <span class="free">l</span> <span class="free">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi l x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_floor_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> pi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">≤</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_floor_iff le_log_iff powr_realpow<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mangoldt_non_primepow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>primepow <span class="free">n</span> <span class="main">⟹</span> mangoldt <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_imp_bigo_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="main">::</span> real<span class="main">)</span><span class="main">)</span> <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">F</span><span class="main">](</span><span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono assms<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: unneeded. But why does real_asymp not work? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ln_minus_ln_floor_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_bigo_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ln_diff_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frac_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ln <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cos_geD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cos <span class="free">x</span> <span class="main">≥</span> cos <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> pi"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>pi <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> pi"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="free">a</span><span class="main">..</span><span class="free">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> cos_mono_le_eq<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cos_mono_le_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: Could be generalised *)</span>
<span class="keyword1"><span class="command">lemma</span></span> path_image_part_circlepath_same_Re<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> pi"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">-</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> Re <span class="free">c</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cos <span class="free">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">c</span> <span class="main">+</span> of_real <span class="free">r</span> <span class="main">*</span> cis <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_image_part_circlepath exp_eq_polar<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm norm_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> t <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≥</span> Re <span class="free">c</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cos <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cos_monotone_0_pi_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> cos_monotone_minus_pi_0'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≥</span> Re <span class="free">c</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cos <span class="free">a</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> z <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">c</span> <span class="main">+</span> <span class="free">r</span> <span class="main">*</span> cis <span class="main">(</span>Arg <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Arg_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm exp_eq_polar norm_minus_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>2<span class="main">)</span> r assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cos <span class="free">b</span> <span class="main">≤</span> cos <span class="main">(</span>Arg <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> z_eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Arg <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="free">b</span><span class="main">..</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Arg_le_pi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span>"</span></span><span class="main">]</span> mpi_less_Arg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cos_geD<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> path_image_part_circlepath<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> exp_eq_polar<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms z<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_image_part_circlepath<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> part_circlepath_rotate_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part_circlepath_def exp_eq_polar fun_eq_iff
                linepath_translate_left linepath_translate_right cis_mult add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> part_circlepath_rotate_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> part_circlepath_def exp_eq_polar fun_eq_iff
                linepath_translate_left linepath_translate_right cis_mult add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> path_image_semicircle_Re_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> Re <span class="free">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> path_image_part_circlepath_same_Re<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sphere_rotate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">=</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">c</span> <span class="main">+</span> cis <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> cis <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">+</span> cis <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm norm_mult norm_minus_commute
                   cis_conv_exp exp_minus <span class="dynamic"><span class="dynamic">field_simps</span></span> norm_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> z <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm norm_minus_commute norm_mult<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> path_image_semicircle_Re_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≤</span> Re <span class="free">c</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis pi <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span> <span class="main">=</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span>pi <span class="main">+</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pi <span class="main">+</span> pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="var">?f</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * part_circlepath_rotate_left path_image_compose path_image_semicircle_Re_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">=</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sphere_rotate<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≥</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">c</span> <span class="main">-</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_image_semicircle_Im_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">0</span> pi<span class="main">)</span> <span class="main">=</span>
             sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Im <span class="bound">s</span> <span class="main">≥</span> Im <span class="free">c</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">0</span> pi <span class="main">=</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span>pi <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pi <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">0</span> pi<span class="main">)</span> <span class="main">=</span>
          <span class="var">?f</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * part_circlepath_rotate_left path_image_compose path_image_semicircle_Re_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">=</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sphere_rotate<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Im <span class="free">c</span> <span class="main">≤</span> Im <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">-</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> path_image_semicircle_Im_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> pi <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Im <span class="bound">s</span> <span class="main">≤</span> Im <span class="free">c</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">c</span> <span class="main">+</span> cis <span class="main">(</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"part_circlepath <span class="free">c</span> <span class="free">r</span> pi <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>pi<span class="main">)</span> <span class="main">=</span> part_circlepath <span class="free">c</span> <span class="free">r</span> <span class="main">(</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span> <span class="main">+</span> pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="main">(</span>part_circlepath <span class="free">c</span> <span class="free">r</span> pi <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="var">?f</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">∩</span> <span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> * part_circlepath_rotate_left path_image_compose path_image_semicircle_Re_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> sphere <span class="free">c</span> <span class="free">r</span> <span class="main">=</span> sphere <span class="free">c</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sphere_rotate<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="keyword1">𝗂</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cis_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted">pi</span> <span class="quoted"><span class="quoted">"pi <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="free">c</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Im <span class="free">c</span> <span class="main">≥</span> Im <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> powr_numeral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span>real<span class="main">)</span> <span class="keyword1">powr</span> numeral <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> numeral <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> powr_numeral<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_fds_logderiv_zeta_real<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"deriv zeta <span class="main">(</span>of_real <span class="free">x</span><span class="main">)</span> <span class="main">/</span> zeta <span class="main">(</span>of_real <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">-</span>of_real <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> Re <span class="main">(</span>of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="bound">p</span> <span class="keyword1">powr</span> of_real <span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_Re eval_fds_logderiv_zeta<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="var">?th1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_Reals_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_logderiv_zeta<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> infsetsum_of_real <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> powr_Reals_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≡</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span>ln <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> set_integrable_ln_powr_at_top<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">absolutely_integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span>   set_lebesgue_integral_ln_powr_at_top<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span>   ln_powr_has_integral_at_top<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">C</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th3</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">F</span> <span class="keyword1">has_field_derivative</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"isCont <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="free">d</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_strict_right_mono mult_strict_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">F</span> <span class="keyword1">has_field_derivative</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"isCont <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab c d gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F_def f_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> powr_add<span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> limits<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">F</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="skolem">F</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">(</span>ereal <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">F</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">∞</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c ab d <span class="keyword1"><span class="command">unfolding</span></span> ereal_tendsto_simps1 F_def  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">real_asymp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="free">a</span> <span class="main">∞</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab c limits
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> interval_integral_FTC_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> * AE_I2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">absolutely_integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_integrable_def integrable_completion<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LBINT</span> <span class="bound">x</span><span class="main">=</span>ereal <span class="free">a</span><span class="main">..</span><span class="main">∞</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">-</span> <span class="skolem">F</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ab c limits
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> interval_integral_FTC_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> 3<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interval_integral_to_infinity_eq F_def f_def C_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th3</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> set_borel_integral_eq_integral<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff f_def C_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ln_fact_conv_sum_upto<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">=</span> sum_upto ln <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_upto_plus1 add.commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> ln_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_upto_ln_conv_ln_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_upto ln <span class="free">x</span> <span class="main">=</span> ln <span class="main">(</span>fact <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_fact_conv_sum_upto sum_upto_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> real_of_nat_div<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">a</span> <span class="keyword1">div</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> real_of_int <span class="main">⌊</span>real <span class="free">a</span> <span class="main">/</span> real <span class="free">b</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> floor_divide_of_nat_eq<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> integral_subset_negligible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> euclidean_space <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> banach"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="free">T</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"integral <span class="free">S</span> <span class="free">f</span> <span class="main">=</span> integral <span class="free">T</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="free">T</span> <span class="free">f</span> <span class="main">=</span> integral <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> integral_spike<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">-</span> <span class="free">S</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> integral <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="free">T</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_restrict_Int<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_on_cong <span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">integrable_on</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">g</span> <span class="keyword1">integrable_on</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_integral_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> integrable_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_sum_upto <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> meas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> set_lebesgue_integral lborel <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">-</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span> <span class="bound">t</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">y</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_lebesgue_integral_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">t</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">-</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span> <span class="skolem">t</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_integral_at_point sum_upto_altdef<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">⌊</span><span class="free">x</span> <span class="skolem">t</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> sum <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nat_sum_has_integral_ceiling<span class="main">)</span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">absolutely_integrable_on</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> absolutely_integrable_absolutely_integrable_ubound<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">MAX</span> <span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="skolem">t</span> <span class="bound">n</span><span class="main">¦</span><span class="main">)</span> <span class="keyword1">absolutely_integrable_on</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> absolutely_integrable_on_iff_nonneg<span class="main">)</span>
                           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_ge_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">t</span> <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="skolem">y</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> <span class="main">¦</span><span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="skolem">y</span><span class="main">⌉</span><span class="main">)</span><span class="main">¦</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="skolem">t</span> <span class="bound">n</span><span class="main">¦</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Max.coboundedI<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="skolem">y</span><span class="main">⌉</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">¦</span><span class="free">f</span> <span class="skolem">t</span> <span class="bound">n</span><span class="main">¦</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span> <span class="main">∂</span>lebesgue<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> has_integral_set_lebesgue<span class="main">[</span><span class="operator">OF</span> **<span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="skolem">t</span> <span class="main">(</span>nat <span class="main">⌈</span><span class="bound">x</span><span class="main">⌉</span><span class="main">)</span> <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_lebesgue_integral_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_completion<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>real <span class="main">0</span><span class="main">..</span>real <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">-</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span> <span class="skolem">t</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="free">f</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_upto_altdef n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Newman_Ingham_Tauberian">
<div class="head">
<h1>Theory Newman_Ingham_Tauberian</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Newman_Ingham_Tauberian.thy
  Author:   Manuel Eberl (TU München)

  A proof of Newman's "analytic theorem", originally stated by Ingham
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Ingham's Tauberian Theorem›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Newman_Ingham_Tauberian
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Real_Asymp/Real_Asymp.html">HOL-Real_Asymp.Real_Asymp</a>"</span>
  <a href="Prime_Number_Theorem_Library.html">Prime_Number_Theorem_Library</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In his proof of the Prime Number Theorem, Newman~\cite{newman1998analytic} uses a Tauberian 
  theorem that was first proven by Ingham. Newman gives a nice and straightforward proof of this
  theorem based on contour integration. This section will be concerned with proving this theorem.
  
  This Tauberian theorem is probably the part of the Newman's proof of the Prime Number Theorem
  where most of the ``heavy lifting'' is done. Its purpose is to extend the summability of a 
  Dirichlet series with bounded coefficients from the region $\mathfrak{R}(s)&gt;1$ to 
  $\mathfrak{R}(s)\geq 1$.

  In order to show it, we first require a number of auxiliary bounding lemmas.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> newman_ingham_aux1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z <span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="free">z</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">z</span> <span class="main">+</span> <span class="free">z</span> <span class="main">/</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span>Re <span class="free">z</span><span class="main">¦</span> <span class="main">/</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> z <span class="keyword2"><span class="keyword">and</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">z</span> <span class="main">+</span> <span class="free">z</span> <span class="main">/</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="free">R</span> <span class="main">^</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_3_eq_3 z norm_divide norm_mult power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">z</span> <span class="main">*</span> <span class="main">(</span><span class="free">z</span> <span class="main">+</span> cnj <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complex_norm_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span>Re <span class="free">z</span><span class="main">¦</span> <span class="main">*</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> complex_add_cnj<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z norm_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="free">R</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">¦</span>Re <span class="free">z</span><span class="main">¦</span> <span class="main">/</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> numeral_3_eq_3 power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> newman_ingham_aux2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Re <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Re <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">C</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">powr</span> Re <span class="free">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> Re <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ f<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> <span class="free">C</span> <span class="main">/</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> Re <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_norm_le<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_powr_real_powr <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> frac_le assms powr_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">C</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="free">m</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span>Re <span class="free">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">C</span> <span class="main">*</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">powr</span> Re <span class="free">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> Re <span class="free">z</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zeta_partial_sum_le'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Re <span class="free">z</span>"</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac add_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hurwitz_zeta_real_bound_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> real <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> decreasing_sum_le_integral<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">-</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>interior <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> powr_has_integral_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> ax <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interior_real_atLeast<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="free">a</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ax <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> has_integral_interior<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> ax<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> powr_mono2'<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a function that is analytic on some vertical line segment, we can find a rectangle
  around that line segment on which the function is also analytic.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analytic_on_axis_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y1</span> <span class="free">y2</span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> Re <span class="bound">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> Im <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">y1</span><span class="main">..</span><span class="free">y2</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y1</span> <span class="main">≤</span> <span class="free">y2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x1</span> <span class="free">x2</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x2</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> cbox <span class="main">(</span>Complex <span class="free">x1</span> <span class="free">y1</span><span class="main">)</span> <span class="main">(</span>Complex <span class="free">x2</span> <span class="free">y2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span>box <span class="bound">a</span> <span class="bound">b</span> <span class="main">|</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="keyword1">analytic_on</span> box <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">∈</span> box <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> cbox <span class="main">(</span>Complex <span class="free">x</span> <span class="free">y1</span><span class="main">)</span> <span class="main">(</span>Complex <span class="free">x</span> <span class="free">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def in_cbox_complex_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"compact <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> analytic_onE_box<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">⋃</span><span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> compactE<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Inf <span class="main">(</span>Re <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">=</span> Min <span class="main">(</span>insert <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Sup <span class="main">(</span>Re <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Inf <span class="main">(</span>Re <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Sup <span class="main">(</span>Re <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword2"><span class="keyword">and</span></span> T <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">a</span> <span class="main">&lt;</span> Re <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="skolem">a</span> <span class="main">&lt;</span> Im <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_box_complex_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> le s
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> box <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> Re_image_box<span class="main">[</span><span class="operator">OF</span> le<span class="main">]</span> Im_image_box<span class="main">[</span><span class="operator">OF</span> le<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def in_box_complex_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> * T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_less_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Min_gr_iff<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="main">(</span><span class="main">⋃</span><span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> analytic_on_Union<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">⋃</span><span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> cbox <span class="main">(</span>Complex <span class="skolem">x1</span> <span class="free">y1</span><span class="main">)</span> <span class="main">(</span>Complex <span class="skolem">x2</span> <span class="free">y2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Complex <span class="free">x</span> <span class="main">(</span>Im <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_cbox_complex_iff S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"Complex <span class="free">x</span> <span class="main">(</span>Im <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> T <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> box <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">a</span> <span class="main">&lt;</span> Re <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="skolem">a</span> <span class="main">&lt;</span> Im <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_box_complex_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">x2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_cbox_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Sup <span class="main">(</span>Re <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Min.coboundedI<span class="main">)</span><span class="main">(</span><span class="operator">use</span> T X <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Re <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> box <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> Re_image_box<span class="main">[</span><span class="operator">OF</span> le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span>Re <span class="skolem">b</span> <span class="main">+</span> Re <span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_strict_right_mono add_strict_right_mono<span class="main">)</span>
                 <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_box_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Re <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&lt;</span> Re <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span>Re <span class="skolem">a</span> <span class="main">+</span> Re <span class="skolem">a</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Re <span class="skolem">a</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_strict_right_mono add_strict_right_mono<span class="main">)</span>
                 <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_box_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Inf <span class="main">(</span>Re <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> box <span class="skolem">a</span> <span class="skolem">b</span>›</span></span> Re_image_box<span class="main">[</span><span class="operator">OF</span> le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">x1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max.coboundedI<span class="main">)</span><span class="main">(</span><span class="operator">use</span> T X <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Re <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_cbox_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> Re <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_box_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> T X <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span>Complex <span class="skolem">x1</span> <span class="free">y1</span><span class="main">)</span> <span class="main">(</span>Complex <span class="skolem">x2</span> <span class="free">y2</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> cbox <span class="main">(</span>Complex <span class="skolem">x1</span> <span class="free">y1</span><span class="main">)</span> <span class="main">(</span>Complex <span class="skolem">x2</span> <span class="free">y2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_subset<span class="main">)</span>

  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x2</span> <span class="main">&gt;</span> <span class="free">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x1</span></span> <span class="quoted"><span class="skolem">x2</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will now prove the theorem. The precise setting is this:
  Consider a Dirichlet series $F(s) = \sum a_n n^{-s}$ with bounded coefficients. Clearly,
  this converges to an analytic function $f(s)$ on $\{s\mid \mathfrak R(s)&gt;1\}$.

  If $f(s)$ is analytic on the larger set $\{s\mid \mathfrak R(s)\geq 1\}$, $F$ converges
  to $f(s)$ for all $\mathfrak R(s) \geq 1$.

  The proof follows Newman's argument very closely, but some of the precise bounds we use
  are a bit different from his. Also, like Harrison, we choose a combination of a semicircle
  and a rectangle as our contour, whereas Newman uses a circle with a vertical cut-off. The result
  of the Residue theorem is the same in both cases, but the bounding of the contributions of the
  different parts is somewhat different.

  The reason why we picked Harrison's contour over Newman's is because we could not understand how
  his bounding of the different contributions fits to his contour, and it seems likely that this
  is also the reason why Harrison altered the contour in the first place.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Newman_Ingham_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex fds"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coeff_bound<span class="main">:</span>   <span class="quoted"><span class="quoted">"fds_nth <span class="free">F</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_analytic<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_conv_f<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> eval_fds <span class="free">F</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span>             <span class="quoted"><span class="quoted">"Re <span class="free">w</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_converges <span class="free">F</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="free">F</span> <span class="free">w</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹We get a bound on our coefficients and call it <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>C›</span></span>.›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>fds_nth <span class="free">F</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> natfun_bigo_1E<span class="main">[</span><span class="operator">OF</span> coeff_bound<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lb <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">write</span></span> contour_integral <span class="main">(</span><span class="quoted">"<span class="keyword1">∮[</span>_<span class="keyword1">]</span>"</span><span class="main">)</span>

  <span class="comment1">― ‹We show convergence directly by showing that the difference between the 
      partial sums and the limit vanishes.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> eval_fds <span class="main">(</span>fds_truncate <span class="bound">N</span> <span class="free">F</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tendsto_iff dist_norm norm_minus_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"eval_fds <span class="skolem">F</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">F</span> <span class="skolem">s</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ε</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="comment1">― ‹We choose an integration radius that is big enough for the error to be sufficiently small.›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> max <span class="main">1</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">ε</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≥</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>

    <span class="comment1">― ‹Next, we extend the analyticity of <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>f (w + z)›</span></span> to the left of the complex plane
        within a thin rectangle that is at least as high as the circle.›</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> Im <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">-</span><span class="skolem">l</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f_analytic'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_compose_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ f_analytic<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">insert</span> w<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">analytic_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> Im <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_subset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> analytic_on_axis_extend<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> x12<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> cbox <span class="main">(</span>Complex <span class="skolem">x1</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Complex <span class="skolem">x2</span> <span class="main">(</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">≥</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x1</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">∧</span> Im <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_subset<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> x12<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_cbox_complex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> f_analytic' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span>
                               <span class="main">(</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x1</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">∧</span> Im <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> analytic_on_Un<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> Im <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="skolem">x1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_subset<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x1</span> <span class="main">&lt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">x1</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">― ‹The function <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>f (w + z)›</span></span> is now analytic on the open box $(-l; R+1) + i(-R+1; R+1)$.
        We call this region <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>X›</span></span>.›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> box <span class="main">(</span>Complex <span class="main">(</span><span class="main">-</span><span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Complex <span class="main">(</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">R</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"open <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"convex <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X_def open_box<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> R l <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def in_box_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> analytic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> l<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def in_box_complex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> f_analytic' <span class="main">[</span><span class="operator">analytic_intros</span><span class="main">]</span> <span class="main">=</span> analytic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> _ analytic<span class="main">,</span> <span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> f_holo <span class="main">[</span><span class="operator">holomorphic_intros</span><span class="main">]</span> <span class="main">=</span>
      holomorphic_on_compose_gen<span class="main">[</span><span class="operator">OF</span> _ analytic_imp_holomorphic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> analytic<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> o_def<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> f_cont <span class="main">[</span><span class="operator">continuous_intros</span><span class="main">]</span> <span class="main">=</span> continuous_on_compose2<span class="main">[</span><span class="operator">OF</span> 
      holomorphic_on_imp_continuous_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> analytic_imp_holomorphic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> analytic<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>

    <span class="comment1">― ‹We now pick a smaller closed box <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>X'›</span></span> inside the big open box <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>X›</span></span>. This is because
        we need a compact set for the next step. our integration path still lies entirely
        within <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>X'›</span></span>, and since <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>X'›</span></span> is compact, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>f (w + z)›</span></span> is bounded on it,
        so we obtain such a bound and call it <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M›</span></span>.›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">=</span> min <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> l <span class="keyword1"><span class="command">have</span></span> δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> δ_def<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> cbox <span class="main">(</span>Complex <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Complex <span class="skolem">R</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X'_def X_def <span class="keyword1"><span class="command">using</span></span> l<span class="main">(</span>1<span class="main">)</span> R δ
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subset_box_imp<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Basis_complex_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"compact <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on <span class="skolem">X'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">⊆</span> <span class="skolem">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="skolem">X'</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> continuous_on_compact_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="comment1">― ‹Our objective is now to show that the difference between the <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>N›</span></span>-th partial sum
        and the limit is below a certain bound (depending on <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>N›</span></span>) which tends to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>0›</span></span> 
        for <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>N → ∞›</span></span>. We use the following bound:›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bound</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">bound</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">C</span><span class="main">/</span><span class="skolem">R</span> <span class="main">+</span> <span class="skolem">C</span><span class="main">/</span><span class="bound">N</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">*</span><span class="skolem">M</span> <span class="main">/</span> <span class="main">(</span>pi<span class="main">*</span><span class="skolem">R</span><span class="main">*</span>ln <span class="bound">N</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">*</span><span class="skolem">R</span><span class="main">*</span><span class="skolem">M</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">δ</span><span class="main">*</span>pi <span class="main">*</span> <span class="bound">N</span> <span class="keyword1">powr</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>1<span class="main">)</span> R C<span class="main">(</span>1<span class="main">)</span> δ<span class="main">(</span>1<span class="main">)</span> ε
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="comment1">― ‹Evidently this is below <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">ε</span></span><span class="antiquote">}</span></span> for sufficiently large <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>N›</span></span>.›</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">bound</span> <span class="bound">N</span> <span class="main">&lt;</span> <span class="skolem">ε</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M<span class="main">(</span>1<span class="main">)</span> R C<span class="main">(</span>1<span class="main">)</span> δ<span class="main">(</span>1<span class="main">)</span> ε <span class="keyword1"><span class="command">unfolding</span></span> bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>

    <span class="comment1">― ‹It now only remains to show that the difference is indeed less than the claimed bound.›</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> norm <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> eval_fds <span class="main">(</span>fds_truncate <span class="bound">N</span> <span class="free">F</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">N</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> N <span class="main">=</span> this

      <span class="comment1">― ‹Like Harrison (and unlike Newman), our integration path <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ›</span></span> consists of a semicircle <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>A›</span></span>
          of radius <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>R›</span></span> in the right-halfplane and a box of width <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>δ›</span></span> and height <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>2R›</span></span> on
          the left halfplane. The latter consists of three straight lines, which we call <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B1›</span></span>
          to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B3›</span></span>.›</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> part_circlepath <span class="main">0</span> <span class="skolem">R</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B2</span> <span class="main">=</span> linepath <span class="main">(</span>Complex <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span>Complex <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B1</span> <span class="main">=</span> linepath <span class="main">(</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span> <span class="main">(</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">-</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B3</span> <span class="main">=</span> linepath <span class="main">(</span><span class="main">-</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">-</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Γ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">+++</span> <span class="skolem">B1</span> <span class="main">+++</span> <span class="skolem">B2</span> <span class="main">+++</span> <span class="skolem">B3</span>"</span></span>

      <span class="comment1">― ‹We first need to show some basic facts about the geometry of our integration path.›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
        <span class="quoted"><span class="quoted">"path <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">B1</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">B3</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="skolem">B2</span>"</span></span>
        <span class="quoted"><span class="quoted">"valid_path <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="skolem">B1</span>"</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="skolem">B3</span>"</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="skolem">B2</span>"</span></span>
        <span class="quoted"><span class="quoted">"arc <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"arc <span class="skolem">B1</span>"</span></span> <span class="quoted"><span class="quoted">"arc <span class="skolem">B3</span>"</span></span> <span class="quoted"><span class="quoted">"arc <span class="skolem">B2</span>"</span></span>
        <span class="quoted"><span class="quoted">"pathstart <span class="skolem">A</span> <span class="main">=</span> <span class="main">-</span><span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">R</span>"</span></span>
        <span class="quoted"><span class="quoted">"pathstart <span class="skolem">B1</span> <span class="main">=</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">B1</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">-</span> <span class="skolem">δ</span>"</span></span>
        <span class="quoted"><span class="quoted">"pathstart <span class="skolem">B3</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">-</span> <span class="skolem">δ</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">B3</span> <span class="main">=</span> <span class="main">-</span><span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">R</span>"</span></span>
        <span class="quoted"><span class="quoted">"pathstart <span class="skolem">B2</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">-</span> <span class="skolem">δ</span>"</span></span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">B2</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">-</span> <span class="skolem">δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R δ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def B1_def B3_def exp_eq_polar B2_def Complex_eq arc_part_circlepath<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_path <span class="skolem">Γ</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Γ_def A_def B1_def B3_def B2_def exp_eq_polar Complex_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_path_imp_path <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pathfinish <span class="skolem">Γ</span> <span class="main">=</span> pathstart <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Γ_def exp_eq_polar<span class="main">)</span>
    
      <span class="keyword1"><span class="command">have</span></span> image_B2<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">B2</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">δ</span> <span class="main">∧</span> Im <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">..</span><span class="skolem">R</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_same_Re closed_segment_eq_real_ivl B2_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> image_B1<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">B1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">∧</span> Im <span class="bound">s</span> <span class="main">=</span> <span class="skolem">R</span><span class="main">}</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> image_B3<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">B3</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">∧</span> Im <span class="bound">s</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">R</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> δ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B1_def B3_def closed_segment_same_Im closed_segment_eq_real_ivl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> image_A<span class="main">:</span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> norm <span class="bound">s</span> <span class="main">=</span> <span class="skolem">R</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> path_image_semicircle_Re_ge<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">…</span> <span class="main">⟶</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X'</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
        <span class="keyword1"><span class="command">using</span></span> complex_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> abs_Im_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> δ R
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X'_def in_cbox_complex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> norm <span class="bound">s</span> <span class="main">=</span> <span class="skolem">R</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">X'</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">B2</span> <span class="main">⊆</span> <span class="skolem">X'</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">X'</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
           <span class="quoted"><span class="quoted">"path_image <span class="skolem">B1</span> <span class="main">⊆</span> <span class="skolem">X'</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">B3</span> <span class="main">⊆</span> <span class="skolem">X'</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">δ</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X'_def in_cbox_complex_iff image_B2 image_B1 image_B3<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> path_images <span class="main">=</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">X'</span> <span class="main">⊆</span> <span class="skolem">X</span>›</span></span>

      <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ›</span></span> is a simple path, which, combined with its simple geometric shape, makes
          reasoning about its winding numbers trivial.›</span>
      <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simple_path <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> simple_path_part_circlepath<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simple_path <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Γ_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> simple_path_join_loop subsetI arc_join<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> path_image <span class="skolem">A</span> <span class="main">∩</span> path_image <span class="main">(</span><span class="skolem">B1</span> <span class="main">+++</span> <span class="skolem">B2</span> <span class="main">+++</span> <span class="skolem">B3</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> image_A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> z R δ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span>pathstart <span class="skolem">A</span><span class="main">,</span> pathstart <span class="main">(</span><span class="skolem">B1</span> <span class="main">+++</span> <span class="skolem">B2</span> <span class="main">+++</span> <span class="skolem">B3</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_image_join image_B1 image_B2 image_B3 complex_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> R<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_B1 image_B3 path_image_join image_B2 complex_eq_iff<span class="main">)</span>
    
      <span class="comment1">― ‹We define the integrands in the same fashion as Newman:›</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">z</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> eval_fds <span class="main">(</span>fds_truncate <span class="skolem">N</span> <span class="free">F</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g_S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g_S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="skolem">S</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">z</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rem</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rem</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="free">f</span> <span class="bound">z</span> <span class="main">-</span> <span class="skolem">S</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g_rem</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g_rem</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="skolem">rem</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">z</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> g_holo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">holomorphic_on</span> <span class="skolem">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> analytic_imp_holomorphic'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> analytic<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> rem_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rem</span> <span class="skolem">z</span> <span class="main">=</span> eval_fds <span class="main">(</span>fds_remainder <span class="skolem">N</span> <span class="free">F</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> abscissa<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="free">F</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bounded_coeffs_imp_abs_conv_abscissa_le_1<span class="main">)</span>
                       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natfun_bigo_iff_Bseq<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">z</span> <span class="main">=</span> eval_fds <span class="free">F</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">=</span> fds_truncate <span class="skolem">N</span> <span class="free">F</span> <span class="main">+</span> fds_remainder <span class="skolem">N</span> <span class="free">F</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fds_truncate_plus_remainder <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="main">…</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">S</span> <span class="skolem">z</span> <span class="main">+</span> eval_fds <span class="main">(</span>fds_remainder <span class="skolem">N</span> <span class="free">F</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_add<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fds_abs_converges_imp_converges 
                                                fds_abs_converges<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_less_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> abscissa<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rem_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="comment1">― ‹We now come to the first application of the residue theorem along the path <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>Γ›</span></span>:›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span><span class="skolem">Γ</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> winding_number <span class="skolem">Γ</span> <span class="main">0</span> <span class="main">*</span> residue <span class="skolem">g</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Residue_theorem<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">holomorphic_on</span> <span class="skolem">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path_image <span class="skolem">Γ</span> <span class="main">⊆</span> <span class="skolem">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> path_images
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Γ_def path_image_join<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∉</span> <span class="skolem">X</span> <span class="main">⟶</span> winding_number <span class="skolem">Γ</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> simply_connected_imp_winding_number_zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span>
                           convex_imp_simply_connected<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> path_images<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> convex_connected<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"winding_number <span class="skolem">Γ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> simple_closed_path_winding_number_pos<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> R δ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B1</span><span class="main">,</span> <span class="skolem">B2</span><span class="main">,</span> <span class="skolem">B3</span><span class="main">}</span><span class="main">.</span> Re <span class="main">(</span>winding_number <span class="bound">g</span> <span class="main">0</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> A_def B1_def B2_def B3_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> winding_number_linepath_pos_lt winding_number_part_circlepath_pos_less<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"valid_path <span class="skolem">Γ</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> path_image <span class="skolem">Γ</span> <span class="main">∧</span> Re <span class="main">(</span>winding_number <span class="skolem">Γ</span> <span class="main">0</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Γ_def <span class="keyword1"><span class="command">using</span></span> path_images<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> winding_number_join_pos_combined'<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>winding_number <span class="skolem">Γ</span> <span class="main">0</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> path_images <span class="quoted"><span class="quoted">‹simple_path <span class="skolem">Γ</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Γ_def path_image_join<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"residue <span class="skolem">g</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> fun_eq_iff power2_eq_square
                   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> div_mult_self3 div_mult_self4 div_mult_self2 div_mult_self1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"residue <span class="main">…</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> residue_simple'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> analytic_imp_holomorphic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> analytic<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="free">f</span> <span class="free">w</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">Γ</span><span class="main">]</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B2</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B3</span><span class="main">]</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Γ_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> contour_integral_join<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">insert</span> path_images<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contour_integral_join contour_integrable_holomorphic_simple g_holo<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> integral1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="free">f</span> <span class="free">w</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B2</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B3</span><span class="main">]</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="comment1">― ‹Next, we apply the residue theorem along a circle of radius <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>R›</span></span> to another
          integrand that is related to the partial sum:›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span>circlepath <span class="main">0</span> <span class="skolem">R</span><span class="main">]</span> <span class="skolem">g_S</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> residue <span class="skolem">g_S</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Residue_theorem<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g_S</span> <span class="keyword1">holomorphic_on</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_S_def S_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> R<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> winding_number_circlepath_centre<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"residue <span class="skolem">g_S</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">S</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g_S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">::</span>complex<span class="main">.</span> <span class="skolem">S</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">z</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_S_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> fun_eq_iff power2_eq_square
                   <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> div_mult_self3 div_mult_self4 div_mult_self2 div_mult_self1<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"residue <span class="main">…</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">S</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> residue_simple'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">S</span> <span class="free">w</span> <span class="main">=</span> <span class="main">∮[</span>circlepath <span class="main">0</span> <span class="skolem">R</span><span class="main">]</span> <span class="skolem">g_S</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

      <span class="comment1">― ‹We split this integral into integrals along two semicircles in the left and right
          half-plane, respectively:›</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∮[</span>part_circlepath <span class="main">0</span> <span class="skolem">R</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="skolem">g_S</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cauchy_theorem_homotopic_loops<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"homotopic_loops <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>circlepath <span class="main">0</span> <span class="skolem">R</span><span class="main">)</span>
                <span class="main">(</span>part_circlepath <span class="main">0</span> <span class="skolem">R</span> <span class="main">(</span><span class="main">-</span> pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> circlepath_def <span class="keyword1"><span class="command">using</span></span> R
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> homotopic_loops_part_circlepath<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_S_def S_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span> <span class="main">+++</span> <span class="main">-</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cauchy_theorem_homotopic_paths<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">A</span> <span class="main">=</span> part_circlepath <span class="main">0</span> <span class="skolem">R</span> <span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> part_circlepath_mirror<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"homotopic_paths <span class="main">(</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>part_circlepath <span class="main">0</span> <span class="skolem">R</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="numeral">3</span><span class="main">*</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">+++</span> <span class="main">-</span><span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> A_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> homotopic_paths_part_circlepath<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_path_image_part_circlepath<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_S_def S_def A_def exp_eq_polar <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span> <span class="main">+</span> <span class="main">∮[</span><span class="main">-</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> contour_integral_join contour_integrable_holomorphic_simple<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def g_S_def S_def path_image_mirror <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_path_image_part_circlepath
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span><span class="main">-</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span> <span class="main">=</span> <span class="main">-</span><span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def contour_integral_mirror contour_integral_neg<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> integral2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">S</span> <span class="free">w</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span> <span class="main">-</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="comment1">― ‹Next, we show a small bounding lemma that we will need for the final estimate:›</span>
      <span class="keyword1"><span class="command">have</span></span> circle_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">complex</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">R</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq<span class="main"><span class="main">]</span></span> add_mono<span class="main">)</span>
             <span class="main">(</span><span class="operator">insert</span> R<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_divide norm_mult power2_eq_square<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="comment1">― ‹The next bound differs somewhat from Newman's, but it works just as well.
          Its purpose is to bound the contribution of the two short horizontal line segments.›</span>
      <span class="keyword1"><span class="command">have</span></span> B12_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="main">-</span> <span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="skolem">R'</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">/</span> ln <span class="skolem">N</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">R'</span><span class="main">¦</span> <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">R'</span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≤</span> integral <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integral_norm_bound_integral<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="skolem">R'</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> R that <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"Im <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> z_def complex_eq_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> x R that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> z_def X'_def in_cbox_complex_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> x R that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">δ</span> <span class="main">+</span> <span class="skolem">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cmod_le add_mono<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">δ</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">R</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> R that abs_Im_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq add_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_mult power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> δ R <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="skolem">R</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">M</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">/</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_def norm_mult <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X'</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono mult_nonneg_nonneg M<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_powr_real_powr<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">R'</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac z_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> N R l that δ<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span>
                                  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def X_def complex_eq_iff in_box_complex_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">*</span> integral <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">0</span> <span class="main">/</span> ln <span class="skolem">N</span> <span class="main">-</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">/</span> ln <span class="skolem">N</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> δ N
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> powr_def
                   <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="skolem">N</span><span class="main">)</span> <span class="main">-</span> real <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">-</span> <span class="skolem">δ</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="skolem">N</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> M R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono divide_right_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="comment1">― ‹We combine the two results from the residue theorem and obtain an integral
          representation of the difference between the partial sums and the limit:›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> <span class="skolem">S</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">-</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B3</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B2</span><span class="main">]</span> <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ring_distribs integral1 integral2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">-</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_S</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">x</span> <span class="main">-</span> <span class="skolem">g_S</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> path_images
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> contour_integral_diff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contour_integrable_holomorphic_simple<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span>
                 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_S_def g_holo S_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_rem</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_rem_def g_def g_S_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> rem_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> <span class="skolem">S</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span>
                      <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_rem</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B3</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">∮[</span><span class="skolem">B2</span><span class="main">]</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="comment1">― ‹We now bound each of these integrals individually:›</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">*</span> pi <span class="main">/</span> <span class="skolem">R</span>  <span class="main">+</span>  <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">*</span> pi <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">R</span><span class="main">)</span>  <span class="main">+</span>  <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">/</span> ln <span class="skolem">N</span>  <span class="main">+</span>
                             <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">/</span> ln <span class="skolem">N</span>  <span class="main">+</span>  <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">R</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">δ</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq<span class="main"><span class="main">]</span></span> add_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span><span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">=</span> <span class="main">-</span><span class="main">∮[</span>reversepath <span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> contour_integral_reversepath<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span>reversepath <span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> B1_def reversepath_linepath <span class="keyword1"><span class="command">using</span></span> δ
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> contour_integral_linepath_same_Im<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">-</span><span class="main">…</span><span class="main">)</span> <span class="main">=</span> norm <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">/</span> ln <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> B12_bound<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">B1</span><span class="main">]</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∮[</span><span class="skolem">B3</span><span class="main">]</span> <span class="skolem">g</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">-</span><span class="skolem">δ</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span><span class="main">)</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B3_def <span class="keyword1"><span class="command">using</span></span> δ
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> contour_integral_linepath_same_Im<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">/</span> <span class="skolem">R</span> <span class="main">/</span> ln <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> B12_bound<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">B3</span><span class="main">]</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">B2</span><span class="main">]</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">M</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">/</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span>
                norm <span class="main">(</span>Complex <span class="main">(</span><span class="main">-</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="skolem">R</span><span class="main">)</span> <span class="main">-</span> Complex <span class="main">(</span><span class="main">-</span> <span class="skolem">δ</span><span class="main">)</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B2_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> contour_integral_bound_linepath<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">fold</span> B2_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">z</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 3 δ R <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Re_z<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">δ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Im_z<span class="main">:</span> <span class="quoted"><span class="quoted">"Im <span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">R</span><span class="main">..</span><span class="skolem">R</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_segment_same_Re closed_segment_eq_real_ivl<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R δ path_images <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B2_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 3 δ R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≤</span> sqrt <span class="main">(</span><span class="skolem">δ</span><span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> <span class="skolem">R</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cmod_def <span class="keyword1"><span class="command">using</span></span> Re_z Im_z
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> real_sqrt_le_mono add_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_le_iff_abs_le<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> power_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> norm_sqr<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>norm <span class="skolem">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="skolem">δ</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> add_divide_distrib <span class="keyword1"><span class="command">using</span></span> δ R abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq<span class="main"><span class="main">]</span></span> add_mono<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_mult <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square Re_z<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> δ R <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X'</span>›</span></span> norm_sqr <span class="keyword1"><span class="command">unfolding</span></span> X'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono add_left_mono<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> in_cbox_complex_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> δ R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="skolem">δ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> δ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">M</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">/</span> <span class="skolem">δ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g_def norm_mult
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono mult_nonneg_nonneg M<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_powr_real_powr Re_z<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> path_images M δ<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contour_integrable_holomorphic_simple<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g_holo<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">B2</span><span class="main">]</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">R</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="skolem">δ</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">δ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> cmod_def real_sqrt_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">N</span> <span class="main">*</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> 
                                <span class="skolem">R</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> contour_integral_bound_part_circlepath_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">,</span> <span class="main">-</span><span class="skolem">R</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
               <span class="main">(</span><span class="operator">fold</span> A_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">z</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_path_image_part_circlepath<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cmod_def abs_if complex_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> image_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">..</span><span class="skolem">N</span><span class="main">.</span> fds_nth <span class="free">F</span> <span class="bound">k</span> <span class="main">/</span> of_nat <span class="bound">k</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def eval_fds_truncate<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> Re <span class="skolem">z</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> w N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> newman_ingham_aux2 C<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">S</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span><span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                   <span class="main">(</span><span class="skolem">C</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span>Re <span class="skolem">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> Re <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span>Re <span class="skolem">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Re <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_S_def norm_mult 
            <span class="keyword1"><span class="command">using</span></span> newman_ingham_aux1<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≥</span> <span class="main">1</span>›</span></span> R
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono mult_nonneg_nonneg circle_bound<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_powr_real_powr norm_uminus_minus<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">*</span> <span class="main">(</span>Re <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R N <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">*</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> add_divide_distrib ring_distribs
            <span class="keyword1"><span class="command">using</span></span> R N abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>›</span></span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≥</span> <span class="main">1</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span> mult_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> R N image_A C<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contour_integrable_holomorphic_simple<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span>
                                                <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_S_def S_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">*</span> pi <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R N
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">g_S</span> <span class="main">(</span><span class="main">-</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_rem</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="skolem">R</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> contour_integral_bound_part_circlepath_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">R</span> <span class="main">*</span> <span class="keyword1">𝗂</span><span class="main">,</span> <span class="main">-</span><span class="skolem">R</span><span class="main">*</span><span class="keyword1">𝗂</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
               <span class="main">(</span><span class="operator">fold</span> A_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">z</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_path_image_part_circlepath<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cmod_def abs_if complex_eq_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> image_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
          <span class="keyword1"><span class="command">have</span></span> summable<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span>Re <span class="free">w</span> <span class="main">+</span> Re <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> summable_hurwitz_zeta_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Re <span class="free">w</span> <span class="main">+</span> Re <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">N</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> w
            <span class="keyword1"><span class="command">unfolding</span></span> powr_minus <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rem</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">F</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rem_altdef eval_fds_remainder<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">/</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="keyword1">powr</span> Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> summable
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> norm_suminf_le<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_powr_real_powr <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_right_mono C<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">*</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> powr_minus <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> summable_hurwitz_zeta_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Re <span class="free">w</span> <span class="main">+</span> Re <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">N</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> w
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> suminf_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">n</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                       <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> w N hurwitz_zeta_real_bound_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">N</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">-</span>Re <span class="skolem">z</span> <span class="main">/</span> Re <span class="skolem">z</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> w N <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frac_le powr_mono<span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">rem</span> <span class="main">(</span><span class="free">w</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">/</span> <span class="main">(</span>Re <span class="skolem">z</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono mult_right_mono powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">g_rem</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">/</span> <span class="main">(</span>Re <span class="skolem">z</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">(</span>Re <span class="skolem">z</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Re <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> g_rem_def norm_mult
            <span class="keyword1"><span class="command">using</span></span> newman_ingham_aux1<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹norm <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">R</span>›</span></span><span class="main">]</span> R <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> C
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono mult_nonneg_nonneg circle_bound<span class="main">)</span>
               <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_powr_real_powr norm_uminus_minus<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R N <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g_rem</span> <span class="keyword1">contour_integrable_on</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> path_images
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_rem_def rem_def S_def
                     <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contour_integrable_holomorphic_simple<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">-</span><span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> R N C<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">R</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="skolem">R</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">*</span> pi <span class="main">/</span> <span class="skolem">R</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">∮[</span><span class="skolem">A</span><span class="main">]</span> <span class="skolem">g_rem</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="skolem">C</span><span class="main">*</span>pi<span class="main">/</span><span class="skolem">R</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">C</span><span class="main">*</span>pi<span class="main">/</span><span class="skolem">N</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="skolem">M</span><span class="main">/</span><span class="skolem">R</span> <span class="main">/</span> ln <span class="skolem">N</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="skolem">R</span><span class="main">*</span><span class="skolem">M</span><span class="main">*</span><span class="skolem">N</span> <span class="keyword1">powr</span> <span class="main">-</span> <span class="skolem">δ</span> <span class="main">/</span> <span class="skolem">δ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>pi <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">C</span><span class="main">/</span><span class="skolem">R</span> <span class="main">+</span> <span class="skolem">C</span><span class="main">/</span><span class="skolem">N</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">*</span><span class="skolem">M</span> <span class="main">/</span> <span class="main">(</span>pi<span class="main">*</span><span class="skolem">R</span><span class="main">*</span>ln <span class="skolem">N</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">*</span><span class="skolem">R</span><span class="main">*</span><span class="skolem">M</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">δ</span><span class="main">*</span>pi <span class="main">*</span> <span class="skolem">N</span> <span class="keyword1">powr</span> <span class="skolem">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> powr_minus <span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="keyword1">𝗂</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> <span class="skolem">S</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> norm <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> <span class="skolem">S</span> <span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> <span class="skolem">S</span> <span class="free">w</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">bound</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bound</span> <span class="skolem">N</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="free">w</span> <span class="main">-</span> <span class="skolem">S</span> <span class="free">w</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">F</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_altdef2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> convergentI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="free">F</span> <span class="free">w</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> eval_fds <span class="main">(</span>fds_truncate <span class="bound">N</span> <span class="free">F</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">⇢</span> <span class="free">f</span> <span class="free">w</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> tendsto_unique<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ tendsto_eval_fds_truncate<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The theorem generalises in a trivial way; we can replace the requirement that the
  coefficients of $f(s)$ be $O(1)$ by $O(n^{\sigma-1})$ for some $\sigma\in\mathbb{R}$, then
  $f(s)$ converges for $\mathfrak{R}(s)&gt;\sigma$. If it can be analytically continued to
  $\mathfrak{R}(s)\geq\sigma$, it is also convergent there.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> Newman_Ingham<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex fds"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coeff_bound<span class="main">:</span>   <span class="quoted"><span class="quoted">"fds_nth <span class="free">F</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_analytic<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="free">σ</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_conv_f<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="free">σ</span> <span class="main">⟹</span> eval_fds <span class="free">F</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> w<span class="main">:</span>             <span class="quoted"><span class="quoted">"Re <span class="free">w</span> <span class="main">≥</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fds_converges <span class="free">F</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="free">F</span> <span class="free">w</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F'</span> <span class="main">=</span> fds_shift <span class="main">(</span><span class="main">-</span>of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">+</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_nth <span class="skolem">F'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">F</span> <span class="bound">n</span> <span class="main">*</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">-</span>of_real<span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff F'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">-</span>of_real<span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big.mult_right assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">-</span>of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigthetaI_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_minus powr_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_nth <span class="skolem">F'</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> f_analytic <span class="keyword1"><span class="command">have</span></span> analytic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> analytic_on_compose_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ f_analytic<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">analytic_intros</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> F'_f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_fds <span class="skolem">F'</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F'_def f'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Re <span class="main">(</span><span class="free">w</span> <span class="main">-</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_converges <span class="skolem">F'</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo analytic F'_f w' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Newman_Ingham_1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="free">F</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_fds <span class="skolem">F'</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="main">(</span><span class="free">w</span> <span class="main">-</span> of_real <span class="main">(</span><span class="free">σ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo analytic F'_f w' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Newman_Ingham_1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="free">F</span> <span class="free">w</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F'_def f'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Prime_Counting_Functions">
<div class="head">
<h1>Theory Prime_Counting_Functions</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Prime_Counting_Functions.thy
  Author:   Manuel Eberl (TU München)

  Definitions and basic properties of prime-counting functions like pi, theta, and psi
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Prime-Counting Functions›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Prime_Counting_Functions
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Prime_Number_Theorem_Library.html">Prime_Number_Theorem_Library</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will now define the basic prime-counting functions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>π›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>θ›</span></span></span></span>, and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ψ›</span></span></span></span>. Additionally, we 
  shall define a function M that is related to Mertens' theorems and Newman's proof of the
  Prime Number Theorem. Most of the results in this file are not actually required to prove 
  the Prime Number Theorem, but are still nice to have.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prime_sum_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> real <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prime_sum_upto</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_altdef1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ind prime <span class="bound">p</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def prime_sum_upto_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_left finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Nats_le_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_altdef2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_altdef prime_sum_upto_altdef1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_altdef3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">←</span>primes_upto <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_primes_upto conj_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_sum_upto_altdef2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>nat <span class="main">⌊</span><span class="free">a</span><span class="main">⌋</span><span class="main">&lt;..</span>nat<span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">¬</span>prime <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> prime_sum_upto <span class="free">f</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">a</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> that assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">a</span><span class="main">⌋</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">a</span><span class="main">⌋</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">a</span><span class="main">⌋</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span><span class="main">.</span> <span class="free">f</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_sum_upto_altdef2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_eqI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a'</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">a</span><span class="main">⌋</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">b</span><span class="main">⌋</span> <span class="main">≤</span> <span class="free">b'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a'</span><span class="main">&lt;..</span><span class="free">b'</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">¬</span>prime <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> prime_sum_upto <span class="free">f</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_sum_upto_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> eval_prime_sum_upto <span class="main">=</span> prime_sum_upto_altdef3<span class="main">[</span><span class="operator">unfolded</span> primes_upto_sieve<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> of_nat_prime_sum_upto<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>prime_sum_upto <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_nat <span class="main">(</span><span class="free">f</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_sum_upto_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> prime_sum_upto <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prime_sum_upto_altdef1 sum_upto_altdef
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_floor_iff ind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_nonneg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prime_sum_upto_altdef1 sum_upto_altdef
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_sum_upto_eq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_prime_sum_upto<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_prime_sum_upto <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> prime_sum_upto <span class="main">(</span><span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prime_sum_upto_altdef1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorem breaks down a sum over all prime powers no greater than
  fixed bound into a nicer form.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_upto_primepows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_monoid_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¬</span>primepow <span class="bound">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">p</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted">aprimedivisor</span>
  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="var">?d</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>multiplicity <span class="main">(</span><span class="var">?d</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"primepow <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> that 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_decompose aprimedivisor_prime_power primepow_gt_Suc_0
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> aprimedivisor_nat multiplicity_aprimedivisor_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">n</span></span> <span class="main">|</span> primepow <span class="bound">n</span> <span class="main">∧</span> real <span class="bound">n</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primepow_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> sum <span class="main">_</span> <span class="var">?S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="var">?d</span> <span class="bound">n</span><span class="main">,</span> multiplicity <span class="main">(</span><span class="var">?d</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aprimedivisor_prime_power primepow_decompose primepow_gt_Suc_0 g
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_power <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> aprimedivisor_nat multiplicity_aprimedivisor_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primes_pi</span>    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">primes_pi</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primes_theta</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">primes_theta</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primes_psi</span>   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">primes_psi</span> <span class="main">=</span> sum_upto <span class="main">(</span>mangoldt <span class="main">::</span> nat <span class="main">⇒</span> real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primes_M</span>     <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">primes_M</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we define some nice optional notation for these functions.
›</span></span>

<span class="keyword1"><span class="command">bundle</span></span> prime_counting_notation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span> primes_pi    <span class="main">(</span><span class="quoted">"<span class="keyword1">π</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> primes_theta <span class="main">(</span><span class="quoted">"<span class="keyword1">θ</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> primes_psi   <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> primes_M     <span class="main">(</span><span class="quoted">"<span class="keyword1">𝔐</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">bundle</span></span> no_prime_counting_notation
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> primes_pi    <span class="main">(</span><span class="quoted">"<span class="keyword1">π</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> primes_theta <span class="main">(</span><span class="quoted">"<span class="keyword1">θ</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> primes_psi   <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> primes_M     <span class="main">(</span><span class="quoted">"<span class="keyword1">𝔐</span>"</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unbundle</span></span> prime_counting_notation
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">lemmas</span></span> π_def <span class="main">=</span> primes_pi_def
<span class="keyword1"><span class="command">lemmas</span></span> θ_def <span class="main">=</span> primes_theta_def
<span class="keyword1"><span class="command">lemmas</span></span> ψ_def <span class="main">=</span> primes_psi_def

<span class="keyword1"><span class="command">lemmas</span></span> eval_π <span class="main">=</span> primes_pi_def<span class="main">[</span><span class="operator">unfolded</span> eval_prime_sum_upto<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> eval_θ <span class="main">=</span> primes_theta_def<span class="main">[</span><span class="operator">unfolded</span> eval_prime_sum_upto<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> eval_𝔐 <span class="main">=</span> primes_M_def<span class="main">[</span><span class="operator">unfolded</span> eval_prime_sum_upto<span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The proofs in this section are mostly taken from Apostol~\cite{apostol1976analytic}.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_π <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∈</span> borel <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> measurable_θ <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∈</span> borel <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> measurable_ψ <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> borel <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> measurable_primes_M <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="main">∈</span> borel <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span> borel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def π_def θ_def ψ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1"><span class="command">lemma</span></span> π_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1">π</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> θ_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> primes_M_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primes_pi_def primes_theta_def primes_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_sum_upto_eq_0<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_nat_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>nat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> θ_nat_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">(</span>nat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">θ</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> primes_M_nat_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="main">(</span>nat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ψ_nat_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">(</span>nat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> π_floor_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>of_int <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> θ_floor_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">(</span>of_int <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">θ</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> primes_M_floor_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="main">(</span>of_int <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ψ_floor_cancel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">(</span>of_int <span class="main">⌊</span><span class="free">y</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def θ_def ψ_def primes_M_def prime_sum_upto_altdef2 sum_upto_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_nonneg <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> θ_nonneg <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> primes_M_nonneg <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primes_pi_def primes_theta_def primes_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_sum_upto_nonneg<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1">π</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">π</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> θ_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">θ</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> primes_M_mono <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">𝔐</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primes_pi_def primes_theta_def primes_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_sum_upto_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_pos_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_π<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="keyword1">π</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_pos_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_eq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mangoldt <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> primepow_gt_Suc_0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ψ_def sum_upto_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.neutral<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_nonneg <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ψ_def sum_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg mangoldt_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">ψ</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ψ_def sum_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2 mangoldt_nonneg<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The $n$-th prime number›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next we define the $n$-th prime number, where counting starts from 0. In traditional
  mathematics, it seems that counting usually starts from 1, but it is more natural to
  start from 0 in HOL and the asymptotics of the function are the same.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth_prime</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_prime</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">}</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_primes_less <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">q</span><span class="main">::</span>nat<span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_unique_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">p'</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>  <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p'</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p'</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">p'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_wlog<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>le <span class="skolem">p</span> <span class="skolem">p'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_primes_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">p</span> <span class="main">&lt;</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">p'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> π_smallest_prime_beyond<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="main">(</span>smallest_prime_beyond <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="main">(</span>real <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smallest_prime_beyond <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smallest_prime_beyond_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_π<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> smallest_prime_beyond <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smallest_prime_beyond_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> n'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">using</span></span> that smallest_prime_beyond_smallest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> n' <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">n'</span>›</span></span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n'</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smallest_prime_beyond_le<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n'</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">&lt;..</span><span class="skolem">n'</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">…</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> real <span class="main">(</span>card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">&lt;..</span><span class="skolem">n'</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Un_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">&lt;..</span><span class="skolem">n'</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">n'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_inverse_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">π</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> real <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="main">(</span>smallest_prime_beyond <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> π_smallest_prime_beyond<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> π_inverse_exists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="skolem">m</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> smallest_prime_beyond <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> smallest_prime_beyond_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&gt;</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">using</span></span> smallest_prime_beyond_smallest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span>"</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="skolem">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="skolem">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&lt;</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">q</span> <span class="main">&gt;</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> p<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_exists1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="bound">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ex_ex1I nth_prime_exists<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_prime_unique_aux<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prime_nth_prime <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>    <span class="quoted"><span class="quoted">"prime <span class="main">(</span>nth_prime <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> card_less_nth_prime <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> nth_prime <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> nth_prime_exists1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_prime_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> card_le_nth_prime <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> nth_prime <span class="free">n</span><span class="main">}</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> nth_prime <span class="free">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span>nth_prime <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> nth_prime <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_nth_prime <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="main">(</span>nth_prime <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nth_prime <span class="free">n</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nth_prime_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the1_equality<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nth_prime_exists1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_eqI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nth_prime <span class="free">n</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_prime_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> insert <span class="free">p</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_eqI''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>real <span class="free">p</span><span class="main">)</span> <span class="main">=</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nth_prime <span class="free">n</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_prime_eqI'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="main">(</span>real <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">≤</span> <span class="free">p</span><span class="main">}</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="main">0</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_prime_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> smallest_prime_beyond <span class="main">(</span>Suc <span class="main">(</span>nth_prime <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_prime_eqI''<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_smallest_prime_beyond<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> nth_prime_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> nth_prime_0 nth_prime_Suc

<span class="keyword1"><span class="command">lemma</span></span> strict_mono_nth_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono nth_prime"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> strict_monoI_Suc<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>nth_prime <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> smallest_prime_beyond <span class="main">(</span>Suc <span class="main">(</span>nth_prime <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_prime <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_prime_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_prime <span class="skolem">n</span> <span class="main">&lt;</span> nth_prime <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_le_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="free">m</span> <span class="main">≤</span> nth_prime <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_mono_less_eq<span class="main">[</span><span class="operator">OF</span> strict_mono_nth_prime<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_less_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="free">m</span> <span class="main">&lt;</span> nth_prime <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_mono_less<span class="main">[</span><span class="operator">OF</span> strict_mono_nth_prime<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="free">m</span> <span class="main">=</span> nth_prime <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_mono_eq<span class="main">[</span><span class="operator">OF</span> strict_mono_nth_prime<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_ge_2<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nth_prime_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nth_prime_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"nth_prime <span class="free">n</span> <span class="main">≥</span> Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">q</span><span class="main">.</span> prime <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">&lt;</span> nth_prime <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span>nth_prime <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nth_prime <span class="free">n</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_prime_ge_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_at_top<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim nth_prime at_top at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_at_top_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> at_top at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_prime_lower_bound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_at_top<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="keyword1">π</span> at_top at_top"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filterlim_at_top
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">=</span> real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌈</span>max <span class="main">0</span> <span class="skolem">C</span><span class="main">⌉</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">C</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">x0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≤</span> real <span class="main">(</span>nat <span class="main">⌈</span>max <span class="main">0</span> <span class="skolem">C</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>nat <span class="main">⌈</span>max <span class="main">0</span> <span class="skolem">C</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="skolem">x0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="keyword1">π</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> π_mono<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  An unbounded, strictly increasing sequence $a_n$ partitions $[a_0; \infty)$ into
  segments of the form $[a_n; a_{n+1})$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> strict_mono_sequence_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span><span class="free">f</span> <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linorder<span class="main">,</span> no_top<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filterlim <span class="free">f</span> at_top at_top"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span> <span class="bound">k</span><span class="main">..&lt;</span><span class="free">f</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_at_top eventually_at_top_linorder<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_mono_Suc_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">k'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Least_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>nth_prime <span class="bound">k</span><span class="main">..&lt;</span>nth_prime <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> strict_mono_sequence_partition<span class="main">[</span><span class="operator">OF</span> strict_mono_nth_prime<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms nth_prime_at_top
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_partition'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">(</span>nth_prime <span class="bound">k</span><span class="main">)</span><span class="main">..&lt;</span>real <span class="main">(</span>nth_prime <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_sequence_partition<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_mono_Suc_iff assms
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filterlim_real_sequentially filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ nth_prime_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> between_nth_primes_imp_nonprime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> nth_prime <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> nth_prime <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI not_le nth_prime_Suc smallest_prime_beyond_smallest<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_prime_partition''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="free">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span>real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>nth_prime <span class="skolem">n</span><span class="main">..&lt;</span>nth_prime <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nth_prime_partition' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">(</span>nth_prime <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">using</span></span> between_nth_primes_imp_nonprime n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_sum_upto_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff le_floor_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">n</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> n_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="free">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="free">x</span><span class="main">⌋</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relations between different prime-counting functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ψ›</span></span></span></span> function can be expressed as a sum of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>θ›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ψ_altdef<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> prime_sum_upto ln <span class="main">(</span>root <span class="bound">m</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span>nat <span class="main">⌊</span><span class="skolem">y</span><span class="main">⌋</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_floor_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">i</span><span class="main">:</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> root <span class="bound">i</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> ψ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_upto_primepows<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold mangoldt_non_primepow<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">i</span></span><span class="main">,</span> <span class="bound"><span class="bound">p</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">p</span> <span class="main">≤</span> root <span class="skolem">i</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> root <span class="skolem">i</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_power <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ip assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ip <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ip <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_log_iff powr_realpow<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="skolem">i</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> root <span class="skolem">i</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ip assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> real_root_le_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="skolem">i</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms ip <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> real_root_pos2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">p</span> <span class="main">≤</span> root <span class="skolem">i</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> ln <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> prime_sum_upto ln <span class="main">(</span>root <span class="bound">m</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def prime_sum_upto_def S_def <span class="keyword1"><span class="command">using</span></span> finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Sigma<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_conv_θ_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">m</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ψ_altdef θ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_minus_θ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_floor_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ψ_conv_θ_sum sum_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">1</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_log_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following theorems use summation by parts to relate different prime-counting functions to
  one another with an integral as a remainder term.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> θ_conv_π_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="keyword1">π</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> finite_vimage_real_of_nat_greaterThanAtMost
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sum_upto <span class="main">(</span>ind prime<span class="main">)</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span>
          sum_upto <span class="main">(</span>ind prime<span class="main">)</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> sum_upto <span class="main">(</span>ind prime<span class="main">)</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="keyword1">π</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span>
           <span class="main">(</span><span class="keyword1">π</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_altdef1 <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_π<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">θ</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> θ_def prime_sum_upto_def <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_integral_refl eval_π eval_θ<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> π_conv_θ_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="keyword1">π</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ind prime <span class="bound">p</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> finite_vimage_real_of_nat_greaterThanAtMost
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>sum_upto <span class="skolem">b</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span>
          <span class="main">-</span><span class="main">(</span>sum_upto <span class="skolem">b</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">x</span><span class="main">)</span> <span class="main">-</span> sum_upto <span class="skolem">b</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_neg partial_summation_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span>
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="skolem">b</span> <span class="main">=</span> <span class="keyword1">θ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> θ_def b_def prime_sum_upto_altdef1 fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> 
                   <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b_def eval_θ<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">unfolding</span></span> π_def prime_sum_upto_altdef1 sum_upto_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_left ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_integral_refl eval_π eval_θ<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_weighted_θ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> θ_def prime_sum_upto_altdef1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_integrable_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> has_integral_refl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> θ_conv_𝔐_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝔐</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ind prime <span class="bound">p</span> <span class="main">*</span> ln <span class="bound">p</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> finite_vimage_real_of_nat_greaterThanAtMost
  <span class="keyword1"><span class="command">have</span></span> prime_le_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sum_upto <span class="skolem">b</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_integral</span> sum_upto <span class="skolem">b</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> sum_upto <span class="skolem">b</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">-</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="skolem">b</span> <span class="main">=</span> <span class="keyword1">𝔐</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff primes_M_def b_def prime_sum_upto_altdef1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
               <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_𝔐 b_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">θ</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> θ_def prime_sum_upto_def <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b_def ind_def not_less prime_le_2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_θ eval_𝔐<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝔐_conv_θ_integral<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">t</span> <span class="main">/</span> <span class="bound">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ind prime <span class="bound">p</span> <span class="main">*</span> ln <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> finite_vimage_real_of_nat_greaterThanAtMost
  <span class="keyword1"><span class="command">have</span></span> prime_le_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sum_upto <span class="skolem">b</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">t</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span>
          sum_upto <span class="skolem">b</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> sum_upto <span class="skolem">b</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="skolem">b</span> <span class="main">=</span> <span class="keyword1">θ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff θ_def b_def prime_sum_upto_altdef1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">-</span><span class="main">(</span><span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_θ b_def sum_negf<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">b</span> <span class="bound">n</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def prime_sum_upto_def <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b_def ind_def not_less prime_le_2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_θ eval_𝔐<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_primes_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">x</span><span class="main">..</span><span class="free">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def prime_sum_upto_altdef1 <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_integrable_strong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that has_integral_refl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">𝔐</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bounds›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> θ_upper_bound_coarse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">≤</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ln <span class="free">x</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> θ_def prime_sum_upto_altdef1 sum_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ind_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real_of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">*</span> ln <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_upto_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> θ_le_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">ψ</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_θ<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ψ_minus_θ<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_upper_bound_coarse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">∧</span> odd <span class="bound">p</span> <span class="main">∧</span> <span class="main">¬</span><span class="numeral">3</span> <span class="keyword1">dvd</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primes_dvd_imp_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> nat"</span></span><span class="main">]</span> primes_dvd_imp_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">::</span> nat"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="numeral">6</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span>nat <span class="main">⌊</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="numeral">5</span><span class="main">)</span><span class="main">/</span><span class="numeral">6</span><span class="main">⌋</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="numeral">6</span><span class="main">*</span><span class="bound">k</span><span class="main">+</span><span class="numeral">5</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span>nat <span class="main">⌊</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">/</span><span class="numeral">6</span><span class="main">⌋</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∪</span> <span class="var">?lhs</span> <span class="main">⊆</span> <span class="main">_</span> <span class="main">∪</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> Un_mono subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="numeral">3</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> p <span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">+</span> <span class="numeral">5</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> nat <span class="main">⌊</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="numeral">5</span><span class="main">)</span><span class="main">/</span><span class="numeral">6</span><span class="main">⌋</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="numeral">5</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> nat <span class="main">⌊</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">/</span><span class="numeral">6</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> add_divide_distrib <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">…</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?A</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">=</span> real <span class="main">(</span>card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_altdef2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">≤</span> card <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="numeral">5</span><span class="main">)</span><span class="main">/</span><span class="numeral">6</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> nat <span class="main">⌊</span><span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">/</span><span class="numeral">6</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> card_Un_le<span class="main"><span class="main">]</span></span> add_mono order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> card_image_le<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> add_divide_distrib <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_numeral_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> numeral <span class="free">n</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> numeral <span class="free">n</span> <span class="main">∨</span> <span class="free">m</span> <span class="main">≤</span> pred_numeral <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> numeral_eq_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following nice proof for the upper bound $\theta(x) \leq \ln 4 \cdot x$ is taken
  from Otto Forster's lecture notes on Analytic Number Theory~\cite{forsteranalytic}.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prod_primes_upto_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">F</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">∨</span> even <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">4</span> <span class="main">∨</span> odd <span class="skolem">n</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"even <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> Suc <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def *<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_numeral_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def *<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span> <span class="main">::</span> nat<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_numeral_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def *<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less.IH<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">⟷</span> prime <span class="skolem">p</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> n prime_odd_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">F</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> F_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> prime_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> p k n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> pochhammer <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pochhammer_prod
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_dvd_prod_iff<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">-</span> <span class="skolem">k</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_eq numeral_2_eq_2 Suc_diff_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pochhammer <span class="main">(</span>real <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> real <span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_gbinomial gbinomial_pochhammer' k_eq <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pochhammer <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> fact <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pochhammer_of_nat of_nat_eq_iff <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_dvd_fact_iff prime_dvd_mult_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">}</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> multiplicity_le_imp_dvd<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_elem_multiplicity_prod_distrib<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_multiplicity_other<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
                 sum <span class="main">(</span>multiplicity <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> Suc <span class="skolem">k</span> <span class="main">&lt;</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_elem_multiplicity_prod_distrib<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span>multiplicity <span class="skolem">p</span><span class="main">)</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True 2
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_right ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> Suc <span class="skolem">k</span> <span class="main">&lt;</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_multiplicity_other<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> multiplicity <span class="skolem">p</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prime_dvd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> 2 True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> multiplicity_geI<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">}</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_imp_le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">,</span> Suc <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> central_binomial_odd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">,</span> Suc <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="skolem">k</span><span class="main">,</span> Suc <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> binomial<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> real <span class="main">(</span><span class="numeral">4</span> <span class="main">^</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_eq power_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_nat_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">&lt;..</span><span class="skolem">n</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> F_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">^</span> Suc <span class="skolem">k</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_mono less less.IH<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> less.prems<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> θ_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">&lt;</span> ln <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> ln <span class="numeral">4</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">.</span> <span class="numeral">4</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="numeral">4</span> <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> θ_def powr_sum prime_sum_upto_altdef2 sum_divide_distrib log_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">.</span> real <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">^</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_primes_upto_less<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">powr</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_realpow<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="keyword1">powr</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> powr_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> ln <span class="numeral">4</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="keyword1">powr</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">&lt;</span> ln <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> powr_less_cancel_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> θ_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_bigo_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ln <span class="numeral">4</span>"</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
            less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> θ_upper_bound<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_minus_θ_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">*</span> sqrt <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="main">(</span>root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ψ_minus_θ<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> ln <span class="numeral">4</span> <span class="main">*</span> root <span class="bound">i</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> θ_upper_bound<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">.</span> ln <span class="numeral">4</span> <span class="main">*</span> root <span class="numeral">2</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_log_iff powr_realpow <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> real_root_decreasing<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">}</span> <span class="main">*</span> ln <span class="numeral">4</span> <span class="main">*</span> sqrt <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="bound">i</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_floor_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_log_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">*</span> ln <span class="numeral">4</span> <span class="main">*</span> sqrt <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">*</span> sqrt <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_sqrt log_def power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_right_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_minus_θ_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bigoI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="keyword1">ψ</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> norm <span class="main">(</span>ln <span class="skolem">x</span> <span class="main">*</span> sqrt <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ψ_minus_θ_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> θ_le_ψ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ψ_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ψ_minus_θ_bigo<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">+</span> <span class="keyword1">θ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_bigo<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> θ_bigo<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We shall now attempt to get some more concrete bounds on the difference
  between $\pi(x)$ and $\theta(x)/\ln x$ These will be essential in showing the Prime
  Number Theorem later.

  We first need some bounds on the integral
  \[\int\nolimits_2^x \frac{1}{\ln^2 t}\,\mathrm{d}t\]
  in order to bound the contribution of the remainder term. This integral actually has an
  antiderivative in terms of the logarithmic integral $\textrm{li}(x)$, but since we do not have a
  formalisation of it in Isabelle, we will instead use the following ad-hoc bound given by Apostol:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> integral_one_over_log_squared_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="free">x</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> sqrt <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_sqrt_le_iff' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> real_le_rsqrt<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
          integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span>sqrt <span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> integral <span class="main">{</span>sqrt <span class="free">x</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I1</span> <span class="main">+</span> <span class="var">?I2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> x x'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Henstock_Kurzweil_Integration.integral_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> integrable_continuous_real<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I1</span> <span class="main">≤</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span>sqrt <span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_le integrable_continuous_real divide_left_mono
              power_mono <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sqrt <span class="free">x</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I2</span> <span class="main">≤</span> integral <span class="main">{</span>sqrt <span class="free">x</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span>sqrt <span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_le integrable_continuous_real divide_left_mono
              power_mono <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_sqrt <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> integral_one_over_log_squared_bigo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> sqrt <span class="bound">x</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¦</span>integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">ub</span> <span class="bound">x</span><span class="main">¦</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">4</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span> <span class="main">=</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_of_nonneg integral_nonneg integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">ub</span> <span class="skolem">x</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> integral_one_over_log_squared_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> elim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ub_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="skolem">ub</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.bigI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_θ_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ub</span> <span class="main">≡</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">x</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">ub</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> integrable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="free">x</span> <span class="main">≤</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> ln <span class="numeral">4</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def
    <span class="keyword1"><span class="command">using</span></span> integrable_weighted_θ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ln <span class="numeral">4</span>"</span></span><span class="main">]</span> assms less_imp_le<span class="main">[</span><span class="operator">OF</span> θ_upper_bound<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_le divide_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="numeral">4</span> <span class="main">*</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> integrable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="free">x</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono integral_one_over_log_squared_bound<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_realpow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">*</span> <span class="main">(</span>sqrt <span class="free">x</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square ub_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_nonneg integrable_weighted_θ divide_nonneg_pos<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">ub</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> π_conv_θ_integral<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def has_integral_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following statement already indicates that the asymptotics of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>π›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>θ›</span></span></span></span>
  are very closely related, since through it, $\pi(x) \sim x / \ln x$ and $\theta(x) \sim x$
  imply each other.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> π_θ_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="bound">x</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="skolem">ub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_bigo_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> π_θ_bound<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">ub</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ub_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As a foreshadowing of the Prime Number Theorem, we can already show
  the following upper bound on $\pi(x)$:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> π_upper_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">&lt;</span> ln <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span>  <span class="main">+</span>  <span class="numeral">8</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span>  <span class="main">+</span>  <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ub</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">x</span> <span class="main">+</span> <span class="numeral">8</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">+</span> <span class="skolem">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> π_θ_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> ub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span> <span class="main">&lt;</span> ln <span class="numeral">4</span> <span class="main">*</span> <span class="free">x</span> <span class="main">/</span> ln <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> θ_upper_bound divide_strict_right_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> ub_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> π_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> π_θ_bigo<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> θ_bigo <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big.divide_right<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">+</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_bigo<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalence of various forms of the Prime Number Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we show that the following forms of the Prime Number Theorem are
  all equivalent:
    <span class="antiquoted"><span class="antiquoted">▸</span></span> $\pi(x) \sim x / \ln x$
    <span class="antiquoted"><span class="antiquoted">▸</span></span> $\pi(x) \ln \pi(x) \sim x$
    <span class="antiquoted"><span class="antiquoted">▸</span></span> $p_n \sim n \ln n$
    <span class="antiquoted"><span class="antiquoted">▸</span></span> $\vartheta(x) \sim x$
    <span class="antiquoted"><span class="antiquoted">▸</span></span> $\psi(x) \sim x$

  We show the following implication chains:
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(1) → (2) → (3) → (2) → (1)›</span></span></span></span>
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(1) → (4) → (1)›</span></span></span></span>
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(4) → (5) → (4)›</span></span></span></span>

  All of these proofs are taken from Apostol's book.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT1_imp_PNT1'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> ln"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* TODO: Tedious Landau sum reasoning *)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equivD_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> ln <span class="main">1</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_ln<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">x</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> filterlim_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ln_div <span class="dynamic"><span class="dynamic">field_simps</span></span> ln_mult π_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">x</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> smalloI_tendsto<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>real<span class="main">.</span> <span class="main">1</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">x</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_smallo<span class="main">)</span> <span class="operator">real_asymp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> ln"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> asymp_equiv_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT1_imp_PNT2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span> assms PNT1_imp_PNT1'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> asymp_equiv_refl_ev eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT2_imp_PNT3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nth_prime <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> nth_prime <span class="bound">n</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">π</span> <span class="main">(</span>nth_prime <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="main">(</span>nth_prime <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_symI <span class="main"><span class="main">[</span></span><span class="operator">OF</span> asymp_equiv_compose'<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> filterlim_real_sequentially nth_prime_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nth_prime <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT3_imp_PNT2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nth_prime <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_symI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> asymp_equiv_sandwich_real<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..</span>real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
          at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_ge_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>elim <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nth_prime_partition''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_compose'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> asymp_equiv_compose'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_compose'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_compose'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> asymp_equiv_compose'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_compose'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="main">(</span>nth_prime <span class="main">(</span>nat <span class="main">⌊</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT2_imp_PNT1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
            <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
            <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span>ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_compose_filterlim<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">real_asymp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">x</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> ln <span class="main">1</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equivD_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> ln <span class="main">1</span><span class="main">)</span> at_top"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_ln<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> at_top<span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> ev
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> ln_mult ln_div<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> ln <span class="main">1</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">⤏</span> ln <span class="main">1</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Lim_transform_eventually<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span> <span class="main">+</span> <span class="main">0</span> <span class="main">-</span> ln <span class="main">1</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ π_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">real_asymp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_symI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> asymp_equivI'<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_refl_ev<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT4_imp_PNT5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> ψ_minus_θ_bigo<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT4_imp_PNT1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_smallo<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> π_θ_bigo<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eventually_elim</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.small.divide_right asymp_equiv_imp_diff_smallo assms<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_divide_distrib asymp_equiv_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT1_imp_PNT4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> smallo_imp_asymp_equiv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bigthetaI_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> landau_o.big.uminus_in_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.big.mult_right π_θ_bigo<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> asymp_equiv_imp_bigtheta <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span> asymp_equiv_symI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">asymp_equiv_intros</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PNT5_imp_PNT4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">θ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">ψ</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> ψ_minus_θ_bigo<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">θ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="bound">x</span> <span class="main">*</span> sqrt <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The asymptotic form of Mertens' First Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Mertens' first theorem states that $\mathfrak{M}(x) - \ln x$ is bounded, i.\,e.\ 
  $\mathfrak{M}(x) = \ln x + O(1)$.

  With some work, one can also show some absolute bounds for $|\mathfrak{M}(x) - \ln x|$, and we
  will, in fact, do this later. However, this asymptotic form is somewhat easier to obtain and it is
  (as we shall see) enough to prove the Prime Number Theorem, so we prove the weak form here first
  for the sake of a smoother presentation.

  First of all, we need a very weak version of Stirling's formula for the logarithm of
  the factorial, namely:
  \[\ln(\lfloor x\rfloor!) = \sum\limits_{n\leq x} \ln x = x \ln x + O(x)\]
  We show this using summation by parts.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> stirling_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum_upto ln <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>Suc <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_upto_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span>
          sum_upto <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">1</span> <span class="main">*</span> ln <span class="main">1</span> <span class="main">-</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">t</span><span class="main">⌋</span><span class="main">)</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span>
           real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_upto_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="main">1</span><span class="main">&lt;..</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_upto ln <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_left<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_vimage_real_of_nat_greaterThanAtMost<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">t</span><span class="main">⌋</span><span class="main">)</span> <span class="main">/</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> sum_upto ln <span class="free">x</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real_of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_nonneg<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> sum_upto ln <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono mult_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> upper<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_upto ln <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono mult_mono add_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_integral_const_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>real"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> sum_upto ln <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> has_integral_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> sum_upto ln <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto ln <span class="free">x</span> <span class="main">≥</span> <span class="free">x</span> <span class="main">*</span> ln <span class="free">x</span> <span class="main">-</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> upper <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stirling_weak_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> sum_upto ln <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_upto ln <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>sum_upto ln <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> landau_o.big.uminus<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">(</span>sum_upto ln <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> ln <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_bigo_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> stirling_weak<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> stirling_weak<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> ln <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> floor_floor_div_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⌊</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">/</span> real <span class="free">d</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">x</span> <span class="main">/</span> real <span class="free">d</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">/</span> real_of_int <span class="main">(</span>int <span class="free">d</span><span class="main">)</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">x</span> <span class="main">/</span> real_of_int <span class="main">(</span>int <span class="free">d</span><span class="main">)</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> floor_divide_real_eq_div<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The key to showing Mertens' first theorem is the function
  \[h(x) := \sum\limits_{n \leq x} \frac{\Lambda(d)}{d}\]
  where $\Lambda$ is the Mangoldt function, which is equal to $\ln p$ for any prime power
  $p^k$ and $0$ otherwise. As we shall see, $h(x)$ is a good approximation for $\mathfrak M(x)$,
  as the difference between them is bounded by a constant.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_upto_mangoldt_over_id_minus_phi_bounded<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> summable<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> ln <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> summable_comparison_test_bigo<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> norm <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> summable_real_powr_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">real_asymp</span>

  <span class="keyword1"><span class="command">have</span></span> diff_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_upto <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">C</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">p</span><span class="main">:</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>root <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="main">{..</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
      <span class="keyword1"><span class="command">using</span></span> x primepows_le_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> finite_subset<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">unfolded</span> S_def<span class="main">]</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_upto_primepows<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def mangoldt_non_primepow<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def not_less le_Suc_eq not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Suc_lessI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> of_nat <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                 <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?S1</span> <span class="main">+</span> <span class="var">?S2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin fin<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conj_commute case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cartesian_product <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primes_M_def prime_sum_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_upto <span class="skolem">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?S2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="skolem">S'</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> primepows_le_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold of_nat_power
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2 divide_nonneg_pos zero_less_power<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_nat_numeral Suc_le_eq S'_def subset_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">=</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>sqrt <span class="skolem">x</span><span class="main">⌋</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S'_def sum.Sigma case_prod_unfold
                    sum_distrib_left sqrt_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">=</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>sqrt <span class="skolem">x</span><span class="main">⌋</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_nat_iff' le_log_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="skolem">x</span><span class="main">⌋</span> <span class="main">/</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_gp<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prime_gt_1_nat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono diff_mono power_mono<span class="main">)</span>
                   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> power2_eq_square <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">=</span><span class="numeral">2</span><span class="main">..</span>nat <span class="main">⌊</span>sqrt <span class="skolem">x</span><span class="main">⌋</span><span class="main">.</span> ln <span class="main">(</span><span class="bound">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_le_suminf summable<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">≤</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> diff_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">4</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> diff_bound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_upto <span class="skolem">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_bigo_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">4</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that our $h(x)$ itself is close to $\ln x$, i.\,e.:
  \[\sum\limits_{n \leq x} \frac{\Lambda(d)}{d} = \ln x + O(1)\]
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_upto_mangoldt_over_id_asymptotics<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">::</span>real<span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="bound">n</span> <span class="main">/</span> <span class="bound">d</span> <span class="main">-</span> real_of_int <span class="main">⌊</span><span class="bound">n</span> <span class="main">/</span> <span class="bound">d</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="keyword1">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.bigI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span>nat <span class="main">⌊</span><span class="skolem">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def sum_upto_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg mult_nonneg_nonneg mangoldt_nonneg<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> floor_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">/</span> real <span class="skolem">d</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> real_of_int <span class="main">⌊</span><span class="skolem">x</span> <span class="main">/</span> real <span class="skolem">d</span><span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">d</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">x</span> <span class="main">≤</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_altdef eq r_def <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_mono mangoldt_nonneg<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> frac_lt_1<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">r</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> norm <span class="main">(</span><span class="keyword1">ψ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ψ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> ψ_bigo<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> sum_upto ln <span class="bound">x</span> <span class="main">-</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r'_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stirling_weak_bigo <span class="keyword1"><span class="command">unfolding</span></span> r'_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> ln_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">d</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">.</span> ln <span class="bound">d</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_upto ln <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">*</span> ln <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">r'</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r'_def sum_upto_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eventually <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span> <span class="main">+</span> <span class="skolem">r</span> <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually_gt_at_top
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">eventually_elim</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto ln <span class="skolem">x</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> mangoldt <span class="bound">n</span> <span class="main">*</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="skolem">x</span> <span class="main">/</span> <span class="bound">n</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_ln_conv_sum_upto_mangoldt <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">r</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sum_subtractf r_def sum_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> real <span class="bound">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">r</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> ln <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r' <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> ln <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="skolem">x</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">r</span> <span class="skolem">x</span> <span class="main">/</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">r'</span> <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">r</span> <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bigthetaI_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">r'</span> <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">r</span> <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_bigo<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> r r'_bigo<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">landau_divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Combining these two gives us Mertens' first theorem.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> mertens_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">d</span><span class="main">.</span> mangoldt <span class="bound">d</span> <span class="main">/</span> <span class="bound">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_upto_mangoldt_over_id_asymptotics
          sum_upto_mangoldt_over_id_minus_phi_bounded
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_bigo<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primes_M_bigo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mertens_bounded<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">::</span>real<span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span> <span class="main">+</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_bigo<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unbundle</span></span> no_prime_counting_notation
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Prime_Number_Theorem">
<div class="head">
<h1>Theory Prime_Number_Theorem</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:       Prime Number Theorem.thy
  Authors:    Manuel Eberl (TU München), Larry Paulson (University of Cambridge)

  A proof of the Prime Number Theorem and some related properties
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Prime Number Theorem›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Prime_Number_Theorem
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Newman_Ingham_Tauberian.html">Newman_Ingham_Tauberian</a>
  <a href="Prime_Counting_Functions.html">Prime_Counting_Functions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unbundle</span></span> prime_counting_notation
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Constructing Newman's function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Starting from Mertens' first theorem, i.\,e.\ $\mathfrak M(x) = \ln x + O(1)$, we now 
  want to derive that $\mathfrak M(x) = \ln x + c + o(1)$. This result is considerably stronger
  and it implies the Prime Number Theorem quite directly.

  In order to do this, we define the Dirichlet series
  \[f(s) = \sum_{n=1}^\infty \frac{\mathfrak{M}(n)}{n^s}\ .\]
  We will prove that this series extends meromorphically to $\mathfrak{R}(s)\geq 1$ and
  apply Ingham's theorem to it (after we subtracted its pole at $s = 1$).
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fds_newman</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fds_newman</span> <span class="main">=</span> fds <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> complex_of_real <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fds_nth_newman<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fds_nth fds_newman <span class="free">n</span> <span class="main">=</span> of_real <span class="main">(</span><span class="keyword1">𝔐</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_newman_def fds_nth_fds<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_fds_nth_newman<span class="main">:</span>
  <span class="quoted"><span class="quoted">"norm <span class="main">(</span>fds_nth fds_newman <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fds_nth_newman norm_of_real
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_of_nonneg sum_nonneg divide_nonneg_pos<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_ge_1_nat<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Dirichlet series $f(s) + \zeta'(s)$ has the coefficients $\mathfrak{M}(n) - \ln n$,
  so by Mertens' first theorem, $f(s) + \zeta'(s)$ has bounded coefficients.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> bounded_coeffs_newman_minus_deriv_zeta<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> fds_newman <span class="main">+</span> fds_deriv fds_zeta"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mertens_bounded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">from</span></span> natfun_bigo_1E<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¦</span><span class="keyword1">𝔐</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> BseqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="main">]</span></span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>fds_nth <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fds_nth <span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> of_real <span class="main">(</span><span class="keyword1">𝔐</span> <span class="skolem">n</span> <span class="main">-</span> ln <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def fds_nth_newman fds_nth_deriv fds_nth_zeta scaleR_conv_of_real<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_Reals_norm<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> c<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> c<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A Dirichlet series with bounded coefficients converges for all $s$ with
  $\mathfrak{R}(s)&gt;1$ and so does $\zeta'(s)$, so we can conclude that $f(s)$ does as well.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> abs_conv_abscissa_newman<span class="main">:</span> <span class="quoted"><span class="quoted">"abs_conv_abscissa fds_newman <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> conv_abscissa_newman<span class="main">:</span>     <span class="quoted"><span class="quoted">"conv_abscissa fds_newman <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> fds_newman <span class="main">+</span> fds_deriv fds_zeta"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="skolem">f</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounded_coeffs_newman_minus_deriv_zeta <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bounded_coeffs_imp_abs_conv_abscissa_le_1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs_conv_abscissa <span class="main">(</span><span class="skolem">f</span> <span class="main">-</span> fds_deriv fds_zeta<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_conv_abscissa_diff_leI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_conv_abscissa_deriv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">-</span> fds_deriv fds_zeta <span class="main">=</span> fds_newman"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs_conv_abscissa fds_newman <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> conv_le_abs_conv_abscissa <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"conv_abscissa fds_newman <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now change the order of summation to obtain an alternative form of $f(s)$ in terms of a 
  sum of Hurwitz $\zeta$ functions.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> eval_fds_newman_conv_infsetsum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"eval_fds fds_newman <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_abs_converges fds_newman <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_abs_converges le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> abs_conv_abscissa_newman<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span> <span class="main">/</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="skolem">p</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">*</span> hurwitz_zeta <span class="skolem">p</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="skolem">p</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">p</span><span class="main">..}</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">x</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">p</span><span class="main">..}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">x</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> abs_summable_hurwitz_zeta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> that s
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cmult_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">p</span><span class="main">..}</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">x</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> hurwitz_zeta <span class="skolem">p</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hurwitz_zeta_nat_conv_infsetsum<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
                      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> powr_minus<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> norm_f<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> ln <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">n</span> <span class="keyword1">powr</span> Re <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def norm_divide norm_mult norm_powr_real_powr<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>fds_nth fds_newman <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_normI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fds_abs_converges_altdef'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span>fds_nth fds_newman <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_fds_nth_newman sum_divide_distrib primes_M_def
                   prime_sum_upto_def norm_mult norm_f norm_powr_real_powr <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> summable1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">n</span><span class="main">:</span>UNIV<span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_summable_on_Sigma_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span>
                         <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">n</span><span class="main">:</span>UNIV<span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_summable_on_reindex_iff <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">n</span><span class="main">:</span>UNIV<span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">p</span><span class="main">:</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">..}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> summable2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> abs_summable_on_Sigma_project1'<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> abs_summable_on_cong eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds fds_newman <span class="free">s</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span> <span class="main">/</span> of_nat <span class="bound">n</span> <span class="keyword1">powr</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_fds_altdef fds_nth_newman sum_divide_distrib
                             primes_M_def prime_sum_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_finite<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">n</span><span class="main">:</span>UNIV<span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> summable1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Sigma<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">n</span><span class="main">:</span>UNIV<span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">n</span><span class="main">:</span>UNIV<span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">p</span><span class="main">:</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">..}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> summable2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_Sigma<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound">n</span><span class="main">∈</span><span class="main">{</span><span class="bound">p</span><span class="main">..}</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval_fds fds_newman <span class="free">s</span> <span class="main">=</span>
                  <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define a meromorphic continuation of $f(s)$ on $\mathfrak{R}(s) &gt; \frac{1}{2}$.

  To construct $f(s)$, we express it as
  \[f(s) = \frac{1}{z-1}\left(\bar f(s) - \frac{\zeta'(s)}{\zeta(s)}\right)\ ,\]
  where $\bar f(s)$ (which we shall call <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pre_newman›</span></span></span></span>) is a function that is analytic on
  $\Re(s) &gt; \frac{1}{2}$, which can be shown fairly easily using the Weierstra{\ss} M test.
  
  $\zeta'(s)/\zeta(s)$ is meromorphic except for a single pole at $s = 1$ and one $k$-th order
  pole for any $k$-th order zero of $\zeta$, but for the Prime Number Theorem, we are only
  concerned with the area $\mathfrak{R}(s) \geq 1$, where $\zeta$ does not have any zeros.

  Taken together, this means that $f(s)$ is analytic for $\mathfrak{R}(s)\geq 1$ except for a
  double pole at $s = 1$, which we will take care of later.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex <span class="main">⇒</span> complex"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pre_zeta <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="bound">s</span> <span class="main">-</span> 
                         of_nat <span class="bound">p</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="bound">p</span> <span class="keyword1">powr</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span>of_nat <span class="bound">p</span> <span class="keyword1">powr</span> <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> of_real <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="bound">p</span> <span class="main">*</span> <span class="free">A</span> <span class="bound">p</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pre_newman</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_newman</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">newman</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">newman</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>pre_newman <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">-</span> deriv zeta <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">/</span> zeta <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The sum used in the definition of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pre_newman›</span></span></span></span> converges uniformly on any disc within the
  half-space with $\mathfrak{R}(s) &gt; \frac{1}{2}$ by the Weierstra{\ss} M test.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> uniform_limit_pre_newman<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">-</span> <span class="free">r</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"uniform_limit <span class="main">(</span>cball <span class="free">s</span> <span class="free">r</span><span class="main">)</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">n</span> <span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">p</span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="bound">p</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> pre_newman at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> r <span class="keyword1"><span class="command">have</span></span> Re<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">s</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">-</span> <span class="skolem">z</span>"</span></span><span class="main">]</span> r that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm abs_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Re <span class="free">s</span> <span class="main">-</span> <span class="free">r</span>"</span></span> <span class="comment1">― ‹The lower bound for the real part in the disc›</span>
  <span class="keyword1"><span class="command">from</span></span> r Re <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def<span class="main">)</span>

  <span class="comment1">― ‹The following sequence <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>M›</span></span> bounds the summand, and it is obviously $O(n^{-1-\epsilon})$
      and therefore summable›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span>norm <span class="free">s</span> <span class="main">+</span> <span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>norm <span class="free">s</span> <span class="main">+</span> <span class="free">r</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">::</span>nat<span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">/</span> <span class="bound">p</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pre_newman_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> Weierstrass_m_test_ev<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"summable <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> summable_comparison_test_bigo<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ε</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">=</span> min <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">ε</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ε_def min_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">ε</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def distrib_left
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_bigo<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> ε <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">real_asymp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> ε <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> norm <span class="main">(</span><span class="bound">n</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">ε</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> summable_real_powr_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> cball <span class="free">s</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> z r Re<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≥</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">-</span> <span class="skolem">z</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> dist_norm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> norm_z<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">z</span> <span class="main">≤</span> norm <span class="free">s</span> <span class="main">+</span> <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z norm_triangle_ineq2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm norm_minus_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> x <span class="keyword2"><span class="keyword">and</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="skolem">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def M_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg add_nonneg_nonneg divide_nonneg_pos<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> pre_zeta <span class="skolem">p</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> 
                   norm <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>norm <span class="skolem">z</span> <span class="main">/</span> <span class="main">(</span>Re <span class="skolem">z</span> <span class="main">*</span> <span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_zeta_bound'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> p <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono pre_zeta_bound<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">B</span> <span class="skolem">p</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> ln <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">p</span> <span class="main">*</span> norm <span class="main">(</span><span class="free">A</span> <span class="skolem">p</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B_def norm_mult norm_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> norm <span class="skolem">z</span> <span class="main">/</span> Re <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">+</span> 
                                 <span class="skolem">p</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> bound
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq4 add_mono<span class="main"><span class="main">]</span></span> mult_left_mono<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_divide norm_mult norm_powr_real_powr
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> divide_left_mono order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ norm_triangle_ineq2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span>norm <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> norm <span class="skolem">z</span> <span class="main">/</span> Re <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">p</span> <span class="keyword1">powr</span> <span class="main">(</span>Re <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> 
                            <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> powr_add powr_minus<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> norm <span class="skolem">z</span> <span class="main">/</span> Re <span class="skolem">z</span> <span class="main">/</span> <span class="skolem">p</span> <span class="keyword1">powr</span> <span class="main">(</span>Re <span class="skolem">z</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="main">/</span> <span class="skolem">p</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> r <span class="quoted"><span class="quoted">‹Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span> norm_z p x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono frac_le powr_mono order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq4<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> Re <span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                 <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_left_mono mult_mono powr_mono diff_right_mono mult_pos_pos<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ge_one_powr_ge_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">B</span> <span class="skolem">p</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">M</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono M_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="skolem">p</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="keyword1">if</span> prime <span class="skolem">p</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="skolem">p</span> <span class="skolem">z</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">M</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sums_pre_newman<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">sums</span> pre_newman <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tendsto_uniform_limitI<span class="main">[</span><span class="operator">OF</span> uniform_limit_pre_newman<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sums_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> analytic_pre_newman <span class="main">[</span><span class="operator">THEN</span> analytic_on_subset<span class="main">,</span> <span class="operator">analytic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre_newman <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> holo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>complex<span class="main">.</span> <span class="keyword1">if</span> prime <span class="skolem">p</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="skolem">p</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">holomorphic_on</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def A_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> holo'<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_newman <span class="keyword1">holomorphic_on</span> ball <span class="skolem">s</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">s</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">r</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> r <span class="keyword1"><span class="command">have</span></span> Re<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">s</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> abs_Re_le_cmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">-</span> <span class="skolem">z</span>"</span></span><span class="main">]</span> r that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_norm abs_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> holomorphic_uniform_limit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ uniform_limit_pre_newman<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> that Re<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> always_eventually holomorphic_on_imp_continuous_on
                                       <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span> holo<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> analytic_on_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">r</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> pre_newman <span class="keyword1">holomorphic_on</span> ball <span class="skolem">s</span> <span class="bound">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Re <span class="skolem">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span> conjI holo'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> holomorphic_pre_newman <span class="main">[</span><span class="operator">holomorphic_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">⟹</span> pre_newman <span class="keyword1">holomorphic_on</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> analytic_pre_newman <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> analytic_imp_holomorphic<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_fds_newman<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="free">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"eval_fds fds_newman <span class="free">s</span> <span class="main">=</span> newman <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> hurwitz_zeta <span class="skolem">p</span> <span class="free">s</span> <span class="main">=</span>
              <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> hurwitz_zeta <span class="skolem">p</span> <span class="free">s</span> <span class="main">=</span>
            ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> pre_zeta <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hurwitz_zeta_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="skolem">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> powr_diff B_def<span class="main">)</span>
                   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eval_fds_newman_conv_infsetsum<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> abs_summable_on_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> summable<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span><span class="main">)</span> <span class="keyword1">abs_summable_on</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> abs_summable_on_cmult_right_iff<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds fds_newman <span class="free">s</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> hurwitz_zeta <span class="bound">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_fds_newman_conv_infsetsum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_cong eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">*</span> <span class="var">?S</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infsetsum_cmult_right<span class="main"><span class="main">[</span></span><span class="operator">OF</span> summable<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> 
                      ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> infsetsum_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> summable<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">p</span> <span class="keyword1">powr</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> 
                        <span class="main">(</span><span class="keyword1">if</span> prime <span class="bound">p</span> <span class="keyword1">then</span> <span class="free">B</span> <span class="bound">p</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> suminf_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pre_newman <span class="free">s</span> <span class="main">-</span> deriv zeta <span class="free">s</span> <span class="main">/</span> zeta <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sums_pre_newman<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> sums_logderiv_zeta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> s
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> suminf_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sums_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newman_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we shall attempt to get rid of the pole by subtracting suitable multiples of $\zeta(s)$
  and $\zeta'(s)$. To this end, we shall first prove the following alternative definition of 
  $\zeta'(s)$:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> deriv_zeta_eq'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Re <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"deriv zeta <span class="free">s</span> <span class="main">=</span> deriv <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span>
                          <span class="main">(</span>pre_zeta <span class="main">1</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_imp_deriv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">derivative_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>pre_zeta <span class="main">1</span> <span class="keyword1">has_field_derivative</span> deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> holomorphic_derivI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"deriv <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> pre_zeta <span class="main">1</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> deriv_mult<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> holomorphic_on_imp_differentiable_at<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">UNIV</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">holomorphic_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span>
           deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deriv <span class="main">(</span>pre_zeta <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> power2_eq_square<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="var">?rhs</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span>
               <span class="main">(</span>zeta <span class="keyword1">has_field_derivative</span> <span class="var">?rhs</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_field_derivative_cong_ev eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t1_space_nhds<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeta_def hurwitz_zeta_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  From this, it follows that $(s - 1) \zeta'(s) - \zeta'(s) / \zeta(s)$ is analytic 
  for $\mathfrak{R}(s) \geq 1$:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analytic_zeta_derivdiff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> deriv zeta <span class="bound">z</span> <span class="main">-</span> deriv zeta <span class="bound">z</span> <span class="main">/</span> zeta <span class="bound">z</span><span class="main">)</span>
          <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_zeta <span class="main">1</span> <span class="skolem">z</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">z</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> zeta_Re_ge_1_nonzero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zeta_def hurwitz_zeta_def <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> inverse <span class="main">(</span>pre_zeta <span class="main">1</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span>
                deriv <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">u</span> <span class="main">*</span> <span class="main">(</span><span class="bound">u</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span> <span class="main">-</span> <span class="main">(</span>pre_zeta <span class="main">1</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> deriv <span class="var">?g</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> deriv zeta <span class="bound">z</span> <span class="main">-</span> deriv zeta <span class="bound">z</span> <span class="main">/</span> zeta <span class="bound">z</span><span class="main">)</span>
          <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="keyword1">analytic_on</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pole_theorem_analytic_0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">analytic_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>ball <span class="skolem">z</span> <span class="bound">d</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"isCont <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> pre_zeta <span class="main">1</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> dist <span class="skolem">z</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">e</span> <span class="main">⟹</span> pre_zeta <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">(</span><span class="bound">y</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> continuous_at_avoid <span class="main">[</span><span class="operator">OF</span> * neq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI ballI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
        <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> ball <span class="skolem">z</span> <span class="main">(</span>min <span class="skolem">e</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">w</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> complex_Re_le_cmod <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">-</span><span class="skolem">w</span>"</span></span><span class="main">]</span> z <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_norm<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> w <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">w</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> deriv <span class="var">?g</span> <span class="main">1</span> <span class="keyword1">else</span>
                        <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> deriv zeta <span class="skolem">w</span> <span class="main">-</span> deriv zeta <span class="skolem">w</span> <span class="main">/</span> zeta <span class="skolem">w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> deriv_zeta_eq'<span class="main"><span class="keyword3">,</span></span> 
              <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeta_def hurwitz_zeta_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> e power2_eq_square<span class="main">)</span>
             <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Finally, $f(s) + \zeta'(s) + c\zeta(s)$ is analytic.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> analytic_newman_variant<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="keyword1">else</span> newman <span class="bound">z</span> <span class="main">+</span> deriv zeta <span class="bound">z</span> <span class="main">+</span> <span class="free">c</span> <span class="main">*</span> zeta <span class="bound">z</span><span class="main">)</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="comment1">(* -euler_mascheroni *)</span>
    c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="skolem">c</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> deriv zeta <span class="bound">z</span> <span class="main">-</span> deriv zeta <span class="bound">z</span> <span class="main">/</span> zeta <span class="bound">z</span><span class="main">)</span>
        <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> analytic_zeta_derivdiff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> pre_newman <span class="bound">z</span> <span class="main">+</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="skolem">c</span>
           <span class="keyword1">else</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> deriv zeta <span class="bound">z</span> <span class="main">-</span>
                deriv zeta <span class="bound">z</span> <span class="main">/</span> zeta <span class="bound">z</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">+</span> pre_newman <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>pre_zeta <span class="main">1</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">(</span><span class="bound">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> deriv <span class="var">?g</span> <span class="main">1</span> <span class="keyword1">else</span> newman <span class="bound">z</span> <span class="main">+</span> deriv zeta <span class="bound">z</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">c</span> <span class="main">+</span> pre_newman <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> zeta <span class="bound">z</span><span class="main">)</span>
        <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="keyword1">analytic_on</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> pole_theorem_analytic_0<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> c <span class="dynamic"><span class="dynamic">analytic_intros</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">d</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound">w</span><span class="main">∈</span>ball <span class="skolem">z</span> <span class="bound">d</span> <span class="main">-</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">w</span> <span class="main">=</span> <span class="main">(</span><span class="bound">w</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> Re <span class="bound">s</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newman_def <span class="dynamic"><span class="dynamic">divide_simps</span></span> zeta_def hurwitz_zeta_def<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The asymptotic expansion of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>𝔐›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Our next goal is to show the key result that $\mathfrak{M}(x) = \ln n + c + o(1)$.

  As a first step, we invoke Ingham's Tauberian theorem on the function we have
  just defined and obtain that the sum
  \[\sum\limits_{n=1}^\infty \frac{\mathfrak{M}(n) - \ln n + c}{n}\]
  exists.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mertens_summable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* c = euler_mascheroni - pre_newman 1 *)</span>
  <span class="keyword1"><span class="command">from</span></span> analytic_newman_variant <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    analytic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="skolem">a</span> <span class="keyword1">else</span> newman <span class="bound">z</span> <span class="main">+</span> deriv zeta <span class="bound">z</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> zeta <span class="bound">z</span><span class="main">)</span>
                 <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">z</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="skolem">a</span> <span class="keyword1">else</span> newman <span class="bound">z</span> <span class="main">+</span> deriv zeta <span class="bound">z</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> zeta <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> analytic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> analytic <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> fds_newman <span class="main">+</span> fds_deriv fds_zeta <span class="main">+</span> fds_const <span class="skolem">c</span> <span class="main">*</span> fds_zeta"</span></span>

  <span class="keyword1"><span class="command">note</span></span> le <span class="main">=</span> conv_abscissa_add_leI conv_abscissa_deriv_le conv_abscissa_newman conv_abscissa_mult_const_left
  <span class="keyword1"><span class="command">note</span></span> intros <span class="main">=</span> le le<span class="main">[</span><span class="operator">THEN</span> le_less_trans<span class="main">]</span> le<span class="main">[</span><span class="operator">THEN</span> order.trans<span class="main">]</span> fds_converges
  <span class="keyword1"><span class="command">have</span></span> eval_F<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_fds <span class="skolem">F</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="skolem">F</span> <span class="skolem">s</span> <span class="main">=</span> eval_fds <span class="main">(</span>fds_newman <span class="main">+</span> fds_deriv fds_zeta<span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span>
                           eval_fds <span class="main">(</span>fds_const <span class="skolem">c</span> <span class="main">*</span> fds_zeta<span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> F_def <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_add<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> intros<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">unfolding</span></span> f_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_add<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_fds_newman eval_fds_deriv_zeta eval_fds_mult eval_fds_zeta<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"fds_converges <span class="skolem">F</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">s</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Newman_Ingham_1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mertens_bounded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> landau_o.big.compose<span class="main">)</span> <span class="operator">real_asymp</span>
    <span class="keyword1"><span class="command">from</span></span> natfun_bigo_1E<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¦</span><span class="keyword1">𝔐</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Bseq <span class="main">(</span>fds_nth <span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> BseqI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>fds_nth <span class="skolem">F</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">c'</span> <span class="main">+</span> norm <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> F_def <span class="keyword1"><span class="command">using</span></span> c'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_nth_zeta fds_nth_deriv fds_nth_newman scaleR_conv_of_real in_Reals_norm
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm_triangle_ineq<span class="main"><span class="main">]</span></span> add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> c'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fds_nth <span class="skolem">F</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> natfun_bigo_iff_Bseq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="keyword1">analytic_on</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> Re <span class="bound">s</span> <span class="main">≥</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval_fds <span class="skolem">F</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval_F<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> that<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> fds_nth <span class="skolem">F</span> <span class="bound">n</span> <span class="main">/</span> of_nat <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fds_converges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> Ln <span class="bound">n</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F_def fds_nth_newman fds_nth_deriv fds_nth_zeta scaleR_conv_of_real
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> Re <span class="main">(</span>Ln <span class="main">(</span>of_nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> Re <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> summable_Re<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span> <span class="main">+</span> Re <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> summable_cong eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Re <span class="skolem">c</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we prove a lemma given by Newman stating that if the sum $\sum a_n / n$ exists and
  $a_n + \ln n$ is nondecreasing, then $a_n$ must tend to 0. Unfortunately, the proof is
  rather tedious, but so is the paper version by Newman.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> sum_goestozero_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">a</span> <span class="bound">n</span> <span class="main">+</span> ln <span class="bound">n</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">N</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real <span class="free">N</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">/</span> <span class="free">M</span> <span class="main">∧</span>
          <span class="main">-</span><span class="free">a</span> <span class="free">N</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">N</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real <span class="free">N</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">/</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> le_dN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> le_a_ln<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">m</span> <span class="main">+</span> ln <span class="skolem">m</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">n</span> <span class="main">+</span> ln <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transitive_stepwise_le<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> le that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">b</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> *<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span>real <span class="free">N</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>real <span class="free">N</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">/</span> <span class="free">M</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>›</span></span> ln_le_minus_one <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">/</span> <span class="free">M</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_dN<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">N</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">using</span></span> i <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_le_eq <span class="dynamic"><span class="dynamic">divide_simps</span></span> mult_left_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free">M</span> <span class="main">+</span> ln <span class="main">(</span>real <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">i</span> <span class="main">+</span> ln <span class="main">(</span>real <span class="free">N</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_a_ln<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> i assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> real <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ln_div <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="free">N</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> real <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">¦</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">M</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="free">M</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">a</span> <span class="free">N</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="free">N</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> le_dN<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">a</span> <span class="free">N</span> <span class="main">-</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">i</span> <span class="main">+</span> ln <span class="main">(</span>real <span class="free">M</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span>real <span class="free">N</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ le_a_ln<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">N</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> i assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> ln_div<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_left_mono_neg<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="main">(</span>real <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span><span class="main">)</span> <span class="main">≤</span> <span class="main">¦</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="free">M</span><span class="main">..</span><span class="free">N</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">¦</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">(</span><span class="main">(</span>real <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="main">-</span> real <span class="free">M</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="free">N</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">N</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> real <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&lt;</span> <span class="free">N</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="free">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span> <span class="free">N</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="free">N</span> <span class="main">/</span> real <span class="main">(</span><span class="free">N</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span><span class="free">N</span> <span class="main">/</span> <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> sum_goestozero_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> summ<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">a</span> <span class="bound">n</span> <span class="main">+</span> ln <span class="bound">n</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> ln <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lim_sequentially<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n0</span><span class="main">.</span> <span class="main">¦</span><span class="free">a</span> <span class="bound">n</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ε</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">ε</span>›</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N0</span></span> <span class="keyword2"><span class="keyword">where</span></span> N0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">N0</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">=</span><span class="bound">m</span><span class="main">..</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> summable_partial_sum_bound summ<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">N1</span> <span class="main">&gt;</span> <span class="numeral">4</span> <span class="main">/</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reals_Archimedean2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">/</span> <span class="skolem">ε</span>"</span></span><span class="main">]</span> ε <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> real <span class="skolem">N1</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ε
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> mult_ac <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">a</span> <span class="skolem">n</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">N0</span> <span class="main">+</span> <span class="skolem">N1</span> <span class="main">+</span> <span class="numeral">7</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span><span class="main">/</span><span class="numeral">4</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less_le_trans<span class="main">[</span><span class="operator">OF</span> N1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">/</span> <span class="skolem">N1</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">N1</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> ε n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"nat <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N0</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">-</span> nat <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n k <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> nat <span class="skolem">k</span> <span class="main">..</span> <span class="skolem">n</span><span class="main">.</span> <span class="free">a</span> <span class="bound">k</span> <span class="main">/</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> N0 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> nat <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">/</span> <span class="main">⌊</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">⌊</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">4</span><span class="main">⌋</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sum_goestozero_lemma <span class="main">[</span><span class="operator">OF</span> * le<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">]</span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff k_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span><span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">16</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">16</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ε mult_less_cancel_left_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ε</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k ε <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">ε</span> <span class="main">*</span> real <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N0</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n k <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">..</span> <span class="skolem">n</span> <span class="main">+</span> nat <span class="skolem">k</span><span class="main">.</span> <span class="free">a</span> <span class="bound">k</span> <span class="main">/</span> <span class="bound">k</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">ε</span><span class="main">/</span><span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> N0 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> nat <span class="skolem">k</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">ε</span><span class="main">/</span><span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> nat <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">/</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sum_goestozero_lemma <span class="main">[</span><span class="operator">OF</span> * le<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span><span class="main">&lt;</span> <span class="skolem">ε</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">≤</span> <span class="numeral">28</span> <span class="main">*</span> real_of_int <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span><span class="main">/</span><span class="numeral">16</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">/</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">*</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">32</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute k_def<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">8</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">*</span> real <span class="skolem">n</span> <span class="main">&lt;</span> <span class="numeral">8</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ε</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k ε <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k add_strict_mono <span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">8</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> real <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> nat <span class="skolem">k</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ε k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> mult_less_0_iff power2_eq_square<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">/</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">ε</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n0</span><span class="main">.</span> <span class="main">¦</span><span class="free">a</span> <span class="bound">n</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"min <span class="skolem">r</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">5</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This leads us to the main intermediate result:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> Mertens_convergent<span class="main">:</span> <span class="quoted"><span class="quoted">"convergent <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"summable <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mertens_summable<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> summable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_goestozero_theorem<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">-</span><span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tendsto_iff dist_norm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> convergentI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> 𝔐_minus_ln_limit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">c</span><span class="main">)</span> at_top"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Mertens_convergent <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">n</span> <span class="main">-</span> ln <span class="bound">n</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> convergent_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> <span class="keyword1">𝔐</span> <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">c</span><span class="main">)</span> at_top"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main">)</span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="main">(</span>nat <span class="main">⌊</span><span class="bound">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">c</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tendsto_add<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The asymptotics of the prime-counting functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will now use the above result to prove the asymptotics of the prime-counting functions
  $\vartheta(x) \sim x$, $\psi(x) \sim x$, and $\pi(x) \sim x / \ln x$. The last of these is 
  typically called the Prime Number Theorem, but since these functions can be expressed in terms 
  of one another quite easily, knowing the asymptotics of any of them immediately gives the 
  asymptotics of the other ones.

  In this sense, all of the above are equivalent formulations of the Prime Number Theorem.
  The one we shall tackle first, due to its strong connection to the $\mathfrak{M}$ function, is
  $\vartheta(x) \sim x$.

  We know that $\mathfrak{M}(x)$ has the asymptotic expansion
  $\mathfrak{M}(x) = \ln x + c + o(1)$. We also know that
  \[\vartheta(x) = x\mathfrak{M}(x) - \int\nolimits_2^x \mathfrak{M}(t) \,\mathrm{d}t\ .\]
  Substituting in the above asymptotic equation, we obtain:
  \begin{align*}
  \vartheta(x) &amp;= x\ln x + cx + o(x) - \int\nolimits_2^x \ln t + c + o(1) \,\mathrm{d}t\\
            &amp;= x\ln x + cx + o(x) - (x\ln x - x + cx + o(x))\\
            &amp;= x + o(x)
  \end{align*}
  In conclusion, $\vartheta(x) \sim x$.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> θ_asymptotics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> 𝔐_minus_ln_limit <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="skolem">c</span><span class="main">)</span> at_top"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 𝔐_expand<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">+</span> <span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def
    <span class="keyword1"><span class="command">using</span></span> tendsto_add<span class="main">[</span><span class="operator">OF</span> c tendsto_const<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">c</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> smalloI_tendsto<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="bound">x</span><span class="main">}</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> integrable_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..</span><span class="skolem">y</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> r_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integrable_diff integrable_primes_M<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> integral<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="keyword1">has_integral</span> <span class="skolem">r'</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_integral_iff r'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> integrable_r <span class="keyword1"><span class="command">unfolding</span></span> r'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_smallo<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_ident<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">+</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">-</span> <span class="skolem">r'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> asymp_equiv_refl_ev eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝔐</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> ln <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r'</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 𝔐_expand <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fundamental_theorem_of_calculus integral<span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> has_integral_unique<span class="main">[</span><span class="operator">OF</span> θ_conv_𝔐_integral this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">θ</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">r</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">-</span> <span class="skolem">r'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> 𝔐_expand C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">-</span> <span class="skolem">r'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_in_smallo r<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">real_asymp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> landau_o.small_big_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span> r'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">-</span> <span class="skolem">r'</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> asymp_equiv_add_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The various other forms of the Prime Number Theorem follow as simple corollaries.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> ψ_asymptotics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> θ_asymptotics PNT4_imp_PNT5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">corollary</span></span> prime_number_theorem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> θ_asymptotics PNT4_imp_PNT1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> ln_π_asymptotics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> ln"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_number_theorem PNT1_imp_PNT1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> π_ln_π_asymptotics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="main">(</span><span class="keyword1">π</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_number_theorem PNT1_imp_PNT2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> nth_prime_asymptotics<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="main">(</span>nth_prime <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> π_ln_π_asymptotics PNT2_imp_PNT3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following versions use a little less notation.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> prime_number_theorem'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">π</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> <span class="main">1</span><span class="main">)</span> at_top"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime_number_theorem
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equivD_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_gt_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> prime_number_theorem''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">π</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def prime_sum_upto_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prime_number_theorem <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> prime_number_theorem'''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> real <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> real <span class="bound">n</span> <span class="main">/</span> ln <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_number_theorem''
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_compose'<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filterlim_real_sequentially<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unbundle</span></span> no_prime_counting_notation
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Mertens_Theorems">
<div class="head">
<h1>Theory Mertens_Theorems</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Mertens_Theorems.thy
  Author:   Manuel Eberl (TU München)

*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mertens' Theorems›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Mertens_Theorems
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Prime_Counting_Functions.html">Prime_Counting_Functions</a>
  <span class="quoted">"<a href="../Stirling_Formula/Stirling_Formula.html">Stirling_Formula.Stirling_Formula</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unbundle</span></span> prime_counting_notation
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we will prove Mertens' First and Second Theorem. These are weaker results
  than the Prime Number Theorem, and we will derive them without using it.

  However, like Mertens himself, we will not only prove them <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹asymptotically›</span></span>, but <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹absolutely›</span></span>.
  This means that we will show that the remainder terms are not only ``Big-O'' of some bound, but
  we will give concrete (and reasonably tight) upper and lower bounds for them that hold on the 
  entire domain. This makes the proofs a bit more tedious.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Absolute Bounds for Mertens' First Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have already shown the asymptotic form of Mertens' first theorem, i.\,e.\ 
  $\mathfrak{M}(n) = \ln n + O(1)$. We now want to obtain some absolute bounds on the $O(1)$
  remainder term using a more careful derivation than before.

  The precise bounds we will show are
  $\mathfrak {M}(n) - \ln n \in (-1-\frac{9}{\pi^2}; \ln 4] \approx (-1.9119; 1.3863]$ for
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n ∈ ℕ›</span></span></span></span>.

  First, we need a simple lemma on the finiteness of exponents to consider in a sum
  of all prime powers up to a certain point:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> exponents_le_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> real <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> real <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="free">p</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="skolem">i</span> <span class="main">+</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we need the following bound on $\zeta'(2)$:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> deriv_zeta_2_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span>deriv zeta <span class="numeral">2</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">-</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">(</span>interior <span class="main">{</span><span class="main">0</span><span class="main">..}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_powr_has_integral_at_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">2</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interior_real_atLeast powr_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> has_integral_interior<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real<span class="main">.</span> ln <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> int<span class="main">:</span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> exp_double <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> exp_half<span class="main">:</span> <span class="quoted"><span class="quoted">"exp <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power2_le_imp_le<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="skolem">x</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> ln <span class="skolem">y</span> <span class="main">/</span> <span class="skolem">y</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> exp <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> DERIV_nonpos_imp_nonincreasing<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> t that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="skolem">t</span> <span class="main">≥</span> ln <span class="main">(</span>exp <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="skolem">t</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ln_exp<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> t <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">t</span> <span class="main">^</span> <span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_nat_numeral <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="skolem">t</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">t</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t that <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹ln <span class="skolem">t</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_nonpos_pos<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="bound">x</span> <span class="main">/</span> <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">has_field_derivative</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">f'</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fds_converges <span class="main">(</span>fds_deriv fds_zeta<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> complex<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fds_converges_deriv<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> of_real <span class="main">(</span><span class="main">-</span>ln <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">sums</span> deriv zeta <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fds_converges_altdef add_ac eval_fds_deriv_zeta fds_nth_deriv scaleR_conv_of_real 
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> sums_split_initial_segment<span class="main">[</span><span class="operator">OF</span> sums_minus<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sums_Re<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="numeral">4</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="numeral">4</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">sums</span> <span class="main">(</span><span class="main">-</span>Re <span class="main">(</span>deriv zeta <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">9</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>Re <span class="main">(</span>deriv zeta <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">9</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> int exp_half
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> decreasing_sum_le_integral divide_nonneg_pos mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>Re <span class="main">(</span>deriv zeta <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">16</span> <span class="main">*</span> ln <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">9</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">12</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">36</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">11</span> <span class="main">/</span> <span class="numeral">10</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_numeral_reduce numeral_2_eq_2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">16</span> <span class="main">*</span> ln <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">9</span> <span class="main">*</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">12</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">36</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">16</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">11</span> <span class="main">/</span> <span class="numeral">10</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">9</span> <span class="main">*</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">36</span> <span class="main">+</span> <span class="numeral">12</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">36</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln2_le_25_over_36 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_left_mono divide_right_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Using the logarithmic derivative of Euler's product formula for $\zeta(s)$ at $s = 2$
  and the bound on $\zeta'(2)$ we have just derived, we can obtain the bound
  \[\sum_{p^i \leq x, i \geq 2} \frac{\ln p}{p^i} &lt; \frac{9}{\pi^2}\ .\]
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mertens_remainder_aux_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">&lt;</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S''</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> finite_row<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{..</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S''</span> <span class="main">⊆</span> <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S''_def S'_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> S'_alt<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SIGMA</span> <span class="bound">p</span><span class="main">:</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S'_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="main">^</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">…</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">p</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Nats_le_real<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S'_alt <span class="keyword1"><span class="command">using</span></span> finite_row<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_SigmaI finite<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span> <span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">z</span></span> <span class="main">|</span> <span class="bound">z</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> snd <span class="bound">z</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="bound">y</span><span class="main">.</span> ln <span class="main">(</span>real <span class="main">(</span>fst <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span>fst <span class="bound">z</span> <span class="main">^</span> snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.group<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold R_def S'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                    <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> odd <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> even_iff_mod_2_eq_zero odd_iff_mod_2_eq_one <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> odd <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S''</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold S'_def S''_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S''</span> <span class="main">⊆</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono2 divide_nonneg_pos ln_ge_zero finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹finite <span class="skolem">S'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def S''_def case_prod_unfold <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> case_prod_unfold
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono divide_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span>
                   <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S'</span> <span class="main">∧</span> even <span class="bound">i</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> 
                 <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_left
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> sum.Sigma<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ballI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> even <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ exponents_le_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_Nats_le_real<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_alt power_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">/</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sum_divide_distrib
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> Suc <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_3_eq_3 power2_eq_square power_diff
                 <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evenE<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power_mult<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exponents_le_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_le_suminf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> summable_geometric_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> suminf_geometric<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span> ›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">i</span></span> <span class="main">|</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> even <span class="bound">i</span> <span class="main">∧</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="skolem">p</span><span class="main">)</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span>
                     <span class="main">1</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">*</span> <span class="var">?lhs</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="skolem">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> real <span class="bound">p</span> <span class="main">≤</span> <span class="free">x</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_finite <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">∑<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound"><span class="bound">p</span></span> <span class="main">|</span> prime <span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span>real <span class="bound">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_fds_logderiv_zeta_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span><span class="main">]</span> finite
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> infsetsum_mono_neutral_left divide_nonneg_pos<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_1_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span>Re <span class="main">(</span>deriv zeta <span class="main">(</span>of_real <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> zeta <span class="main">(</span>of_real <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eval_fds_logderiv_zeta_real<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span>Re <span class="main">(</span>deriv zeta <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zeta_even_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deriv_zeta_2_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_right_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now consider the equation
  \[\ln (n!) = \sum_{k\leq n} \Lambda(k) \left\lfloor\frac{n}{k}\right\rfloor\]
  and estimate both sides in different ways. The left-hand-side can be estimated
  using Stirling's formula, and we can simplify the right-hand side to
  \[\sum_{k\leq n} \Lambda(k) \left\lfloor\frac{n}{k}\right\rfloor =
      \sum_{p^i \leq x, i \geq 1} \ln p \left\lfloor\frac{n}{p^i}\right\rfloor\]
  and then split the sum into those $p^i$ with $i = 1$ and those with $i \geq 2$.
  Applying the bound we have just shown and some more routine estimates, we obtain the
  following reasonably strong version of Mertens' First Theorem on the naturals:
  $\mathfrak M(n) - \ln(n) \in (-1-\frac{9}{\pi^2}; \ln 4]$
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> mertens_bound_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">&lt;..</span>ln <span class="numeral">4</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_neg_neg divide_neg_pos<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">=</span> <span class="main">-</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_𝔐<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">/</span> pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">36</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pi_less_4 ln2_le_25_over_36
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono add_mono divide_left_mono divide_right_mono power_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_nonpos_pos<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>
            <span class="main">⊆</span> <span class="main">{..</span>nat <span class="main">⌊</span>root <span class="main">1</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">⌋</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..</span>nat <span class="main">⌊</span>log <span class="numeral">2</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span><span class="main">⌋</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> primepows_le_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"real <span class="free">n</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> frac <span class="main">(</span>real <span class="free">n</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">/</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_realpow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> pi_less_4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln pi <span class="main">≤</span> ln <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">25</span> <span class="main">/</span> <span class="numeral">36</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono ln2_le_25_over_36<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ln_pi<span class="main">:</span> <span class="quoted"><span class="quoted">"ln pi <span class="main">≤</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="numeral">3</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">4</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">25</span> <span class="main">/</span> <span class="numeral">36</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono ln2_le_25_over_36<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ln_3<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">/</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_def sum_divide_distrib <span class="dynamic"><span class="dynamic">field_simps</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R'_def case_prod_unfold <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> real_of_nat_div <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R'</span> <span class="main">&lt;</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R'_def <span class="keyword1"><span class="command">using</span></span> mertens_remainder_aux_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">/</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg mult_nonneg_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> R_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">/</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">12</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_fact_bounds<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">+</span> ln pi<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>ln <span class="free">n</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">12</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span> ln_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">+</span> ln pi<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">12</span> <span class="main">*</span> <span class="numeral">3</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exp_le n pi_gt3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono divide_right_mono divide_left_mono mult_mono
              mult_pos_pos ln_x_over_x_mono power_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">25</span> <span class="main">/</span> <span class="numeral">36</span> <span class="main">+</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">12</span> <span class="main">*</span> <span class="numeral">3</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_pi ln2_le_25_over_36 ln_3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono divide_left_mono divide_right_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">-</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span>ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">n</span> <span class="main">*</span> ln <span class="free">n</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_fact_bounds<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">+</span> <span class="main">…</span> <span class="main">/</span> <span class="free">n</span> <span class="main">=</span> <span class="main">-</span>ln <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ln <span class="free">n</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> ln_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">-</span> <span class="main">0</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pi_gt3 n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono diff_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> upper<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">-</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_right_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹ln <span class="free">n</span> <span class="main">-</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> fact_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">-</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="bound">p</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_imp_le<span class="main">[</span><span class="operator">OF</span> frac_lt_1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> r_def θ_def prime_sum_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mono mult_left_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">θ</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> θ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> ln <span class="numeral">4</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> θ_upper_bound<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">/</span> <span class="free">n</span> <span class="main">&lt;</span> ln <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def prime_sum_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_nonneg mult_nonneg_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> r_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">/</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>ln <span class="numeral">4</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span>fact <span class="free">n</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">=</span> sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> mangoldt <span class="bound">k</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>real <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_fact_conv_sum_upto_mangoldt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span><span class="main">.</span>
                       ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_upto_primepows<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mangoldt_non_primepow<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> real <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> real <span class="free">n</span><span class="main">}</span> <span class="main">=</span>
               <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span> <span class="main">∪</span>
               <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_nat_le_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less le_Suc_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound"><span class="bound">p</span></span><span class="main">,</span><span class="bound"><span class="bound">i</span></span><span class="main">)</span> <span class="main">|</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">≤</span> <span class="free">n</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="bound">p</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">R</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?S</span> <span class="main">+</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prime_sum_upto_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted">fst</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_def prime_sum_upto_def sum_subtractf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frac_def real_of_nat_div <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> ln <span class="main">(</span>real <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">/</span> real <span class="bound">p</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="keyword1">𝔐</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primes_M_def sum_distrib_left sum_distrib_right prime_sum_upto_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">=</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">+</span> <span class="skolem">r</span> <span class="main">/</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">R</span> <span class="main">/</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">n</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">n</span> <span class="main">=</span> ln <span class="free">n</span> <span class="main">-</span> ln <span class="main">(</span>fact <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">/</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">R</span> <span class="main">/</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> fact_bounds r_bounds R_bounds <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">n</span> <span class="main">-</span> ln <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">/</span> pi<span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">&lt;..</span>ln <span class="numeral">4</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As a simple corollary, we obtain a similar bound on the reals.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mertens_bound_real_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">/</span> pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;..</span> ln <span class="numeral">4</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">≤</span> <span class="keyword1">𝔐</span> <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ln <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mertens_bound_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_nonneg_pos<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms frac_lt_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> frac_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> ln <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ln <span class="main">(</span><span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_div<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> frac_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">&gt;</span> <span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="numeral">9</span><span class="main">/</span>pi<span class="main">^</span><span class="numeral">2</span><span class="main">-</span>ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mertens_bound_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span>"</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">4</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We weaken this estimate a bit to obtain nicer bounds:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mertens_bound_real'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="numeral">25</span><span class="main">/</span><span class="numeral">18</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mertens_bound_real_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_realpow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> ln2_le_25_over_36 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">≤</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> ln2<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span><span class="main">..</span><span class="numeral">25</span><span class="main">/</span><span class="numeral">36</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ln3<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">10</span><span class="main">/</span><span class="numeral">9</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ln5<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">5</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">4</span><span class="main">/</span><span class="numeral">3</span><span class="main">..</span><span class="numeral">76</span><span class="main">/</span><span class="numeral">45</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">5</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ln7<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">7</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">15</span><span class="main">/</span><span class="numeral">7</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">7</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ln11<span class="main">:</span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="numeral">11</span><span class="main">::</span>real<span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">5</span><span class="main">/</span><span class="numeral">3</span><span class="main">..</span><span class="numeral">290</span><span class="main">/</span><span class="numeral">99</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">11</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>

  <span class="comment1">― ‹Choosing the lower bound -2 is somewhat arbitrary here; it is a trade-off between getting
      a reasonably tight bound and having to make lots of case distinctions. To get -2 as a lower
      bound, we have to show the cases up to <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>x = 11›</span></span> by case distinction,›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">&gt;</span> <span class="main">-</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">11</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">}</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="numeral">3</span><span class="main">}</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">3</span><span class="main">..&lt;</span><span class="numeral">5</span><span class="main">}</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">5</span><span class="main">..&lt;</span><span class="numeral">7</span><span class="main">}</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">7</span><span class="main">..&lt;</span><span class="numeral">11</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">2</span> <span class="main">-</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln2_le_25_over_36 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="numeral">3</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> floor_unique<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">3</span> <span class="main">-</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_𝔐<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span><span class="numeral">9</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln_realpow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ln_div<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">9</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">3</span><span class="main">..&lt;</span><span class="numeral">5</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="numeral">3</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_sum_upto_eqI'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="numeral">3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="numeral">4</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_le_iff le_numeral_iff nat_eq_iff floor_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="numeral">3</span> <span class="main">=</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_𝔐 eval_nat_numeral mark_out_code<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">=</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">5</span> <span class="main">-</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln2 ln3 ln5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">5</span><span class="main">..&lt;</span><span class="numeral">7</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="numeral">5</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_sum_upto_eqI'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="numeral">5</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="numeral">6</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_le_iff le_numeral_iff nat_eq_iff floor_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="numeral">5</span> <span class="main">=</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> ln <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">5</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_𝔐 eval_nat_numeral mark_out_code<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">=</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> ln <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">5</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">7</span> <span class="main">-</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> ln <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">5</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln2 ln3 ln5 ln7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">7</span><span class="main">..&lt;</span><span class="numeral">11</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="numeral">7</span> <span class="main">=</span> <span class="keyword1">𝔐</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_sum_upto_eqI'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="numeral">7</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="numeral">10</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_le_iff le_numeral_iff nat_eq_iff floor_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="numeral">7</span> <span class="main">=</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> ln <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">5</span> <span class="main">+</span> ln <span class="numeral">7</span> <span class="main">/</span> <span class="numeral">7</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_𝔐 eval_nat_numeral mark_out_code<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">=</span> ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> ln <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">5</span> <span class="main">+</span> ln <span class="numeral">7</span> <span class="main">/</span> <span class="numeral">7</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> ln <span class="numeral">11</span> <span class="main">-</span> <span class="main">(</span>ln <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> ln <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">+</span> ln <span class="numeral">5</span> <span class="main">/</span> <span class="numeral">5</span> <span class="main">+</span> ln <span class="numeral">7</span> <span class="main">/</span> <span class="numeral">7</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> diff_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln2 ln3 ln5 ln7 ln11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ln <span class="free">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">9</span><span class="main">/</span>pi<span class="main">^</span><span class="numeral">2</span> <span class="main">+</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mertens_bound_real_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">11</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True frac_lt_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono frac_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> frac <span class="free">x</span> <span class="main">/</span> real <span class="main">(</span>nat <span class="main">⌊</span><span class="free">x</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> ln <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">11</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ln_le_cancel_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ln <span class="main">(</span><span class="numeral">12</span> <span class="main">/</span> <span class="numeral">11</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">1585</span> <span class="main">/</span> <span class="numeral">18216</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ln_approx_bounds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">12</span> <span class="main">/</span> <span class="numeral">11</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">9</span> <span class="main">/</span> pi <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">9</span> <span class="main">/</span> <span class="numeral">3.141592653588</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pi_approx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_left_mono power_mono mult_pos_pos<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">…</span> <span class="main">+</span> <span class="numeral">1585</span> <span class="main">/</span> <span class="numeral">18216</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span> <span class="main">≤</span> <span class="numeral">25</span> <span class="main">/</span> <span class="numeral">18</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> mertens_first_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="keyword1">𝔐</span> <span class="free">x</span> <span class="main">-</span> ln <span class="free">x</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mertens_bound_real'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> abs_if<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mertens' Second Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Mertens' Second Theorem concerns the asymptotics of the Prime Harmonic Series, namely
  \[\sum\limits_{p \leq x} \frac{1}{p} = \ln\ln x + M + O\left(\frac{1}{\ln x}\right)\]
  where $M \approx 0.261497$ is the Meissel--Mertens constant.

  We define the constant in the following way:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">meissel_mertens</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meissel_mertens</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> integral <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will require the value of the integral
  $\int_a^\infty \frac{t}{\ln^2 t} \textrm{d}t = \frac{1}{\ln a}$
  as an upper bound on the remainder term:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> integral_one_over_x_ln_x_squared<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_lebesgue_integral lborel <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> ln <span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">1</span> <span class="main">/</span> ln <span class="free">a</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?th3</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"isCont <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>at_right <span class="main">(</span>ereal <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ereal_tendsto_simps <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">real_asymp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lim2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span> <span class="main">∘</span> real_of_ereal<span class="main">)</span> <span class="main">⤏</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>at_left <span class="main">∞</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ereal_tendsto_simps <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">real_asymp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">(</span>einterval <span class="free">a</span> <span class="main">∞</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interval_integral_FTC_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ deriv cont _ lim1 lim2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> a <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?th1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interval_lebesgue_integral lborel <span class="main">(</span>ereal <span class="free">a</span><span class="main">)</span> <span class="main">∞</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interval_integral_FTC_nonneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ deriv cont _ lim1 lim2<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> a <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?th2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interval_integral_to_infinity_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span>
           set_lebesgue_integral lebesgue <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?th1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_set_lebesgue<span class="main">)</span>
                    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_integrable_def integrable_completion<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_lebesgue_integral lebesgue <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> ln <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?th2</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_lebesgue_integral_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_completion<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?th3</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We show that the integral in our definition of the Meissel--Mertens constant is
  well-defined and give an upper bound for its tails:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> integrable_meissel_mertens<span class="main">:</span>  <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> meissel_mertens_integral_le<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_mult_right integral_one_over_x_ln_x_squared<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_integrable_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ AE_I2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> indicator <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> integrable_mult_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">,</span> 
              <span class="operator">OF</span> integral_one_over_x_ln_x_squared<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> set_integrable_def<span class="main"><span class="main">]</span></span><span class="main">]</span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">::</span>real<span class="main">.</span> indicator <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="bound">t</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>indicat_real <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">r</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span>
            norm <span class="main">(</span>indicat_real <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="skolem">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> ln <span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="free">a</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_scaleR norm_mult r_def norm_divide <span class="keyword1"><span class="command">using</span></span> mertens_first_theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono frac_le divide_nonneg_pos<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_borel_integral_eq_integral<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> integral <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> integral_norm_bound_integral<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">r</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def norm_divide <span class="keyword1"><span class="command">using</span></span> mertens_first_theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono frac_le divide_nonneg_pos<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">r</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> ln <span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>integral <span class="main">{</span><span class="free">a</span><span class="main">&lt;..}</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> integrable_on_meissel_mertens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">..}</span>"</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets borel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">integrable_on</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Inf <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dense <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_below <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bdd_belowI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span>Inf <span class="free">A</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">x</span><span class="main">&lt;..}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">x</span><span class="main">&lt;..}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_integrable lborel <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_integrable_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> integrable_meissel_mertens<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> x * assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_borel_integral_eq_integral<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> meissel_mertens_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>meissel_mertens <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">-</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..}</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  integral <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">t</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> integral_subset_negligible<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> meissel_mertens_integral_le<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>meissel_mertens <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meissel_mertens_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Finally, obtaining Mertens' second theorem from the first one is nothing but a routine
  summation by parts, followed by a use of the above bound:
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> mertens_second_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="main">¦</span><span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">/</span> ln <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">-</span> ln <span class="bound">t</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">/</span> real <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> primes_M_def prime_sum_upto_altdef1 <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> partial_summation_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> 
                 <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">n</span><span class="main">∈</span>insert <span class="numeral">2</span> <span class="main">(</span>real <span class="main">-`</span> <span class="main">{</span><span class="numeral">2</span><span class="main">&lt;..</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> ind prime <span class="bound">n</span> <span class="main">*</span> <span class="main">(</span>ln <span class="bound">n</span> <span class="main">/</span> <span class="bound">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">-</span> <span class="var">?S</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primes_M_def finite_vimage_real_of_nat_greaterThanAtMost eval_prime_sum_upto<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def prime_sum_upto_altdef1 sum_upto_def <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less numeral_2_eq_2 le_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">-</span><span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> has_integral_neg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">t</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="bound">t</span> <span class="main">*</span> ln <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">has_integral</span>
             <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_diff fundamental_theorem_of_calculus<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative
               <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> <span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span>ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> has_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="main">…</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> integral <span class="main">=</span> this

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R<span class="hidden">⇩</span><sub>𝔐</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">𝔐</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 𝔐<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔐</span> <span class="skolem">x</span> <span class="main">=</span> ln <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">R<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R<span class="hidden">⇩</span><sub>𝔐</sub>_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> integral <span class="main">{</span><span class="bound">x</span><span class="main">..}</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">I</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> C_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> meissel_mertens"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def r_def C_def meissel_mertens_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">¦</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">/</span> ln <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def eval_prime_sum_upto <span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> meissel_mertens_bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ln2_le_25_over_36
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono divide_left_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="skolem">r</span> <span class="main">+</span> <span class="skolem">I</span> <span class="skolem">x</span> <span class="main">=</span> integral <span class="main">(</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..}</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def r_def <span class="keyword1"><span class="command">using</span></span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_Un <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> integrable_on_meissel_mertens<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def r_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..}</span> <span class="main">=</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">I</span> <span class="numeral">2</span> <span class="main">-</span> <span class="skolem">I</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">R<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span> <span class="main">-</span> <span class="skolem">I</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> integral<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def <span class="dynamic"><span class="dynamic">field_simps</span></span> 𝔐 has_integral_iff *<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">…</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">R<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span><span class="main">¦</span> <span class="main">+</span> norm <span class="main">(</span><span class="skolem">I</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> real_norm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq4<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">R<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="skolem">x</span> <span class="main">/</span> ln <span class="skolem">x</span><span class="main">¦</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> <span class="main">¦</span>ln <span class="skolem">x</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> R<span class="hidden">⇩</span><sub>𝔐</sub>_def abs_divide <span class="keyword1"><span class="command">using</span></span> mertens_first_theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">..}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">&lt;..}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">&lt;..}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">x</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="skolem">x</span> <span class="main">=</span> integral <span class="main">{</span><span class="skolem">x</span><span class="main">&lt;..}</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_subset_negligible <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">/</span> ln <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> meissel_mertens_integral_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">¦</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">/</span> ln <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> landau_o.bigI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">4</span></span><span class="main"><span class="main">]</span></span> eventually_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eventually_ge_at_top<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> bound<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">*</span> norm <span class="main">(</span><span class="main">1</span> <span class="main">/</span> ln <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> ln <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> prime_harmonic_asymp_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∼[</span>at_top<span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> meissel_mertens <span class="main">+</span> meissel_mertens<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_in_smallo<span class="main"><span class="main">[</span></span><span class="operator">OF</span> landau_o.big_small_trans<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">OF</span></span> mertens_second_theorem<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">real_asymp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">-</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">o(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> ln <span class="main">(</span>ln <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smallo_imp_asymp_equiv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As a corollary, we get the divergence of the prime harmonic series.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> prime_harmonic_diverges<span class="main">:</span> <span class="quoted"><span class="quoted">"filterlim <span class="main">(</span>prime_sum_upto <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> at_top at_top"</span></span>
  <span class="keyword1"><span class="command">using</span></span> asymp_equiv_symI<span class="main">[</span><span class="operator">OF</span> prime_harmonic_asymp_equiv<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asymp_equiv_at_top_transfer<span class="main">)</span> <span class="operator">real_asymp</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">unbundle</span></span> no_prime_counting_notation
<span class="comment1">(*&gt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>